var ColyseusClient=pc.createScript("colyseusClient");ColyseusClient.prototype.initialize=function(){this.client=new Colyseus.Client("ws://localhost:2567"),this.client.joinOrCreate("game_room").then((e=>{console.log("Joined game room:",e),e.onMessage("player_action",(e=>{console.log("Received player action:",e)}))})).catch((e=>{console.error("Failed to join game room:",e)}))};!function(L,k){"object"==typeof exports&&"undefined"!=typeof module?module.exports=k():"function"==typeof define&&define.amd?define(k):(L="undefined"!=typeof globalThis?globalThis:L||self).AgoraRTC=k()}(this,(function(){"use strict";var L="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function i(L){return L&&L.__esModule&&Object.prototype.hasOwnProperty.call(L,"default")?L.default:L}var n=function(L){try{return!!L()}catch(L){return!0}},k=!n((function(){var L=function(){}.bind();return"function"!=typeof L||L.hasOwnProperty("prototype")})),M=k,U=Function.prototype,x=U.call,V=M&&U.bind.bind(x,x),F=M?V:function(L){return function(){return x.apply(L,arguments)}},j=F({}.isPrototypeOf),u=function(L){return L&&L.Math==Math&&L},z=u("object"==typeof globalThis&&globalThis)||u("object"==typeof window&&window)||u("object"==typeof self&&self)||u("object"==typeof L&&L)||function(){return this}()||L||Function("return this")(),Q=k,$=Function.prototype,ee=$.apply,te=$.call,ie="object"==typeof Reflect&&Reflect.apply||(Q?te.bind(ee):function(){return te.apply(ee,arguments)}),ne=F,re=ne({}.toString),oe=ne("".slice),R=function(L){return oe(re(L),8,-1)},ce=R,de=F,v=function(L){if("Function"===ce(L))return de(L)},le="object"==typeof document&&document.all,ue={all:le,IS_HTMLDDA:void 0===le&&void 0!==le},he=ue.all,pe=ue.IS_HTMLDDA?function(L){return"function"==typeof L||L===he}:function(L){return"function"==typeof L},_e={},Ee=!n((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]})),fe=k,me=Function.prototype.call,ge=fe?me.bind(me):function(){return me.apply(me,arguments)},Te={},Se={}.propertyIsEnumerable,Re=Object.getOwnPropertyDescriptor,Ie=Re&&!Se.call({1:2},1);Te.f=Ie?function(L){var k=Re(this,L);return!!k&&k.enumerable}:Se;var ye,Ae,B=function(L,k){return{enumerable:!(1&L),configurable:!(2&L),writable:!(4&L),value:k}},Ce=n,ve=R,we=Object,Oe=F("".split),Ne=Ce((function(){return!we("z").propertyIsEnumerable(0)}))?function(L){return"String"==ve(L)?Oe(L,""):we(L)}:we,Y=function(L){return null==L},Pe=Y,Le=TypeError,J=function(L){if(Pe(L))throw Le("Can't call method on "+L);return L},Me=Ne,Ue=J,Z=function(L){return Me(Ue(L))},xe=pe,Ve=ue.all,Fe=ue.IS_HTMLDDA?function(L){return"object"==typeof L?null!==L:xe(L)||L===Ve}:function(L){return"object"==typeof L?null!==L:xe(L)},Be={},je=Be,Ge=z,We=pe,se=function(L){return We(L)?L:void 0},ae=function(L,k){return arguments.length<2?se(je[L])||se(Ge[L]):je[L]&&je[L][k]||Ge[L]&&Ge[L][k]},He="undefined"!=typeof navigator&&String(navigator.userAgent)||"",Ke=z,ze=He,Ye=Ke.process,qe=Ke.Deno,Xe=Ye&&Ye.versions||qe&&qe.version,Qe=Xe&&Xe.v8;Qe&&(Ae=(ye=Qe.split("."))[0]>0&&ye[0]<4?1:+(ye[0]+ye[1])),!Ae&&ze&&(!(ye=ze.match(/Edge\/(\d+)/))||ye[1]>=74)&&(ye=ze.match(/Chrome\/(\d+)/))&&(Ae=+ye[1]);var Ze=Ae,$e=Ze,et=n,tt=z.String,it=!!Object.getOwnPropertySymbols&&!et((function(){var L=Symbol();return!tt(L)||!(Object(L)instanceof Symbol)||!Symbol.sham&&$e&&$e<41})),rt=it&&!Symbol.sham&&"symbol"==typeof Symbol.iterator,ot=ae,st=pe,at=j,ct=Object,dt=rt?function(L){return"symbol"==typeof L}:function(L){var k=ot("Symbol");return st(k)&&at(k.prototype,ct(L))},lt=String,be=function(L){try{return lt(L)}catch(L){return"Object"}},ut=pe,pt=be,_t=TypeError,De=function(L){if(ut(L))return L;throw _t(pt(L)+" is not a function")},Et=De,ft=Y,ke=function(L,k){var M=L[k];return ft(M)?void 0:Et(M)},mt=ge,Tt=pe,St=Fe,Rt=TypeError,It={exports:{}},yt=z,vt=Object.defineProperty,bt="__core-js_shared__",wt=z[bt]||function(L,k){try{vt(yt,L,{value:k,configurable:!0,writable:!0})}catch(M){yt[L]=k}return k}(bt,{}),Ot=wt;(It.exports=function(L,k){return Ot[L]||(Ot[L]=void 0!==k?k:{})})("versions",[]).push({version:"3.31.1",mode:"pure",copyright:"Â© 2014-2023 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.31.1/LICENSE",source:"https://github.com/zloirock/core-js"});var Nt=It.exports,Dt=J,Pt=Object,Je=function(L){return Pt(Dt(L))},Lt=Je,kt=F({}.hasOwnProperty),Mt=Object.hasOwn||function(L,k){return kt(Lt(L),k)},Ut=F,xt=0,Vt=Math.random(),Ft=Ut(1..toString),nt=function(L){return"Symbol("+(void 0===L?"":L)+")_"+Ft(++xt+Vt,36)},Bt=Nt,Gt=Mt,Wt=nt,Ht=it,Kt=rt,zt=z.Symbol,Yt=Bt("wks"),qt=Kt?zt.for||zt:zt&&zt.withoutSetter||Wt,ht=function(L){return Gt(Yt,L)||(Yt[L]=Ht&&Gt(zt,L)?zt[L]:qt("Symbol."+L)),Yt[L]},Jt=ge,Qt=Fe,Zt=dt,$t=ke,ei=TypeError,ti=ht("toPrimitive"),gt=function(L,k){if(!Qt(L)||Zt(L))return L;var M,U=$t(L,ti);if(U){if(void 0===k&&(k="default"),M=Jt(U,L,k),!Qt(M)||Zt(M))return M;throw ei("Can't convert object to primitive value")}return void 0===k&&(k="number"),function(L,k){var M,U;if("string"===k&&Tt(M=L.toString)&&!St(U=mt(M,L)))return U;if(Tt(M=L.valueOf)&&!St(U=mt(M,L)))return U;if("string"!==k&&Tt(M=L.toString)&&!St(U=mt(M,L)))return U;throw Rt("Can't convert object to primitive value")}(L,k)},ni=dt,Ct=function(L){var k=gt(L,"string");return ni(k)?k:k+""},ri=Fe,oi=z.document,si=ri(oi)&&ri(oi.createElement),At=function(L){return si?oi.createElement(L):{}},ai=At,ci=!Ee&&!n((function(){return 7!=Object.defineProperty(ai("div"),"a",{get:function(){return 7}}).a})),di=Ee,li=ge,ui=Te,hi=B,pi=Z,_i=Ct,Ei=Mt,fi=ci,mi=Object.getOwnPropertyDescriptor;_e.f=di?mi:function(L,k){if(L=pi(L),k=_i(k),fi)try{return mi(L,k)}catch(L){}if(Ei(L,k))return hi(!li(ui.f,L,k),L[k])};var gi=n,Ti=pe,Si=/#|\.prototype\./,jt=function(L,k){var M=Ii[Ri(L)];return M==Ai||M!=yi&&(Ti(k)?gi(k):!!k)},Ri=jt.normalize=function(L){return String(L).replace(Si,".").toLowerCase()},Ii=jt.data={},yi=jt.NATIVE="N",Ai=jt.POLYFILL="P",Ci=jt,vi=De,Oi=k,Ni=v(v.bind),Xt=function(L,k){return vi(L),void 0===k?L:Oi?Ni(L,k):function(){return L.apply(k,arguments)}},Di={},Pi=Ee&&n((function(){return 42!=Object.defineProperty((function(){}),"prototype",{value:42,writable:!1}).prototype})),ki=Fe,Mi=String,Ui=TypeError,ii=function(L){if(ki(L))return L;throw Ui(Mi(L)+" is not an object")},Vi=Ee,Fi=ci,ji=Pi,Wi=ii,Hi=Ct,Ki=TypeError,zi=Object.defineProperty,qi=Object.getOwnPropertyDescriptor,Ji="enumerable",Qi="configurable",Zi="writable";Di.f=Vi?ji?function(L,k,M){if(Wi(L),k=Hi(k),Wi(M),"function"==typeof L&&"prototype"===k&&"value"in M&&Zi in M&&!M[Zi]){var U=qi(L,k);U&&U[Zi]&&(L[k]=M.value,M={configurable:Qi in M?M[Qi]:U[Qi],enumerable:Ji in M?M[Ji]:U[Ji],writable:!1})}return zi(L,k,M)}:zi:function(L,k,M){if(Wi(L),k=Hi(k),Wi(M),Fi)try{return zi(L,k,M)}catch(L){}if("get"in M||"set"in M)throw Ki("Accessors not supported");return"value"in M&&(L[k]=M.value),L};var $i=Di,en=B,nn=Ee?function(L,k,M){return $i.f(L,k,en(1,M))}:function(L,k,M){return L[k]=M,L},rn=z,on=ie,sn=v,an=pe,cn=_e.f,dn=Ci,ln=Be,un=Xt,hn=nn,pn=Mt,bi=function(L){var t=function(k,M,U){if(this instanceof t){switch(arguments.length){case 0:return new L;case 1:return new L(k);case 2:return new L(k,M)}return new L(k,M,U)}return on(L,this,arguments)};return t.prototype=L.prototype,t},wi=function(L,k){var M,U,x,V,F,j,z,Q,$,ee=L.target,te=L.global,ie=L.stat,ne=L.proto,re=te?rn:ie?rn[ee]:(rn[ee]||{}).prototype,oe=te?ln:ln[ee]||hn(ln,ee,{})[ee],ce=oe.prototype;for(V in k)U=!(M=dn(te?V:ee+(ie?".":"#")+V,L.forced))&&re&&pn(re,V),j=oe[V],U&&(z=L.dontCallGetSet?($=cn(re,V))&&$.value:re[V]),F=U&&z?z:k[V],U&&typeof j==typeof F||(Q=L.bind&&U?un(F,rn):L.wrap&&U?bi(F):ne&&an(F)?sn(F):F,(L.sham||F&&F.sham||j&&j.sham)&&hn(Q,"sham",!0),hn(oe,V,Q),ne&&(pn(ln,x=ee+"Prototype")||hn(ln,x,{}),hn(ln[x],V,F),L.real&&ce&&(M||!ce[V])&&hn(ce,V,F)))},_n=Math.ceil,En=Math.floor,mn=Math.trunc||function(L){var k=+L;return(k>0?En:_n)(k)},gn=mn,Li=function(L){var k=+L;return k!=k||0===k?0:gn(k)},Tn=Li,Rn=Math.max,In=Math.min,xi=function(L,k){var M=Tn(L);return M<0?Rn(M+k,0):In(M,k)},yn=Li,An=Math.min,Bi=function(L){return L>0?An(yn(L),9007199254740991):0},Cn=Bi,Gi=function(L){return Cn(L.length)},vn=Z,bn=xi,wn=Gi,Yi=function(L){return function(k,M,U){var x,V=vn(k),F=wn(V),j=bn(U,F);if(L&&M!=M){for(;F>j;)if((x=V[j++])!=x)return!0}else for(;F>j;j++)if((L||j in V)&&V[j]===M)return L||j||0;return!L&&-1}},On={includes:Yi(!0),indexOf:Yi(!1)},Nn=On.includes;wi({target:"Array",proto:!0,forced:n((function(){return!Array(1).includes()}))},{includes:function(L){return Nn(this,L,arguments.length>1?arguments[1]:void 0)}});var Dn=Be,Xi=function(L){return Dn[L+"Prototype"]},Pn=Xi("Array").includes,Ln=Fe,kn=R,Mn=ht("match"),tn=function(L){var k;return Ln(L)&&(void 0!==(k=L[Mn])?!!k:"RegExp"==kn(L))},Un=tn,Vn=TypeError,Fn={};Fn[ht("toStringTag")]="z";var jn="[object z]"===String(Fn),Gn=jn,Wn=pe,Hn=R,Kn=ht("toStringTag"),Yn=Object,qn="Arguments"==Hn(function(){return arguments}()),Xn=Gn?Hn:function(L){var k,M,U;return void 0===L?"Undefined":null===L?"Null":"string"==typeof(M=function(L,k){try{return L[k]}catch(L){}}(k=Yn(L),Kn))?M:qn?Hn(k):"Object"==(U=Hn(k))&&Wn(k.callee)?"Arguments":U},Jn=Xn,Qn=String,fn=function(L){if("Symbol"===Jn(L))throw TypeError("Cannot convert a Symbol value to a string");return Qn(L)},cr=ht("match"),dr=wi,Sn=function(L){if(Un(L))throw Vn("The method doesn't accept regular expressions");return L},ur=J,hr=fn,pr=F("".indexOf);dr({target:"String",proto:!0,forced:!function(L){var k=/./;try{"/./"[L](k)}catch(M){try{return k[cr]=!1,"/./"[L](k)}catch(L){}}return!1}("includes")},{includes:function(L){return!!~pr(hr(ur(this)),hr(Sn(L)),arguments.length>1?arguments[1]:void 0)}});var _r=Xi("String").includes,Er=j,fr=Pn,mr=_r,gr=Array.prototype,Tr=String.prototype,Sr=i((function(L){var k=L.includes;return L===gr||Er(gr,L)&&k===gr.includes?fr:"string"==typeof L||L===Tr||Er(Tr,L)&&k===Tr.includes?mr:k})),Rr=De,Ir=Je,yr=Ne,Ar=Gi,Cr=TypeError,xn=function(L){return function(k,M,U,x){Rr(M);var V=Ir(k),F=yr(V),j=Ar(V),z=L?j-1:0,Q=L?-1:1;if(U<2)for(;;){if(z in F){x=F[z],z+=Q;break}if(z+=Q,L?z<0:j<=z)throw Cr("Reduce of empty array with no initial value")}for(;L?z>=0:j>z;z+=Q)z in F&&(x=M(x,F[z],z,V));return x}},vr={left:xn(!1),right:xn(!0)},br=n,Bn=function(L,k){var M=[][L];return!!M&&br((function(){M.call(null,k||function(){return 1},1)}))},wr="undefined"!=typeof process&&"process"==R(process),Or=vr.left;wi({target:"Array",proto:!0,forced:!wr&&Ze>79&&Ze<83||!Bn("reduce")},{reduce:function(L){var k=arguments.length;return Or(this,L,k,k>1?arguments[1]:void 0)}});var Nr=Xi("Array").reduce,Dr=j,Pr=Nr,Lr=Array.prototype,zn=function(L){var k=L.reduce;return L===Lr||Dr(Lr,L)&&k===Lr.reduce?Pr:k},kr=i(zn);let Mr=!0,xr=!0;function Zn(L,k,M){const U=L.match(k);return U&&U.length>=M&&parseInt(U[M],10)}function $n(L,k,M){if(!L.RTCPeerConnection)return;const U=L.RTCPeerConnection.prototype,x=U.addEventListener;U.addEventListener=function(L,U){if(L!==k)return x.apply(this,arguments);const o=L=>{const k=M(L);k&&(U.handleEvent?U.handleEvent(k):U(k))};return this._eventMap=this._eventMap||{},this._eventMap[k]||(this._eventMap[k]=new Map),this._eventMap[k].set(U,o),x.apply(this,[L,o])};const V=U.removeEventListener;U.removeEventListener=function(L,M){if(L!==k||!this._eventMap||!this._eventMap[k])return V.apply(this,arguments);if(!this._eventMap[k].has(M))return V.apply(this,arguments);const U=this._eventMap[k].get(M);return this._eventMap[k].delete(M),0===this._eventMap[k].size&&delete this._eventMap[k],0===Object.keys(this._eventMap).length&&delete this._eventMap,V.apply(this,[L,U])},Object.defineProperty(U,"on"+k,{get(){return this["_on"+k]},set(L){this["_on"+k]&&(this.removeEventListener(k,this["_on"+k]),delete this["_on"+k]),L&&this.addEventListener(k,this["_on"+k]=L)},enumerable:!0,configurable:!0})}function er(L){return"boolean"!=typeof L?new Error("Argument type: "+typeof L+". Please use a boolean."):(Mr=L,L?"adapter.js logging disabled":"adapter.js logging enabled")}function tr(L){return"boolean"!=typeof L?new Error("Argument type: "+typeof L+". Please use a boolean."):(xr=!L,"adapter.js deprecation warnings "+(L?"disabled":"enabled"))}function ir(){if("object"==typeof window){if(Mr)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function nr(L,k){xr&&console.warn(L+" is deprecated, please use "+k+" instead.")}function rr(L){return"[object Object]"===Object.prototype.toString.call(L)}function or(L){var k;return rr(L)?kr(k=Object.keys(L)).call(k,(function(k,M){const U=rr(L[M]),x=U?or(L[M]):L[M],V=U&&!Object.keys(x).length;return void 0===x||V?k:Object.assign(k,{[M]:x})}),{}):L}function sr(L,k,M){k&&!M.has(k.id)&&(M.set(k.id,k),Object.keys(k).forEach((U=>{U.endsWith("Id")?sr(L,L.get(k[U]),M):U.endsWith("Ids")&&k[U].forEach((k=>{sr(L,L.get(k),M)}))})))}function ar(L,k,M){const U=M?"outbound-rtp":"inbound-rtp",x=new Map;if(null===k)return x;const V=[];return L.forEach((L=>{"track"===L.type&&L.trackIdentifier===k.id&&V.push(L)})),V.forEach((k=>{L.forEach((M=>{M.type===U&&M.trackId===k.id&&sr(L,M,x)}))})),x}var Vr=nt,Fr=Nt("keys"),lr=function(L){return Fr[L]||(Fr[L]=Vr(L))},Br=!n((function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype})),jr=Mt,Gr=pe,Wr=Je,Hr=Br,Kr=lr("IE_PROTO"),zr=Object,Yr=zr.prototype,qr=Hr?zr.getPrototypeOf:function(L){var k=Wr(L);if(jr(k,Kr))return k[Kr];var M=k.constructor;return Gr(M)&&k instanceof M?M.prototype:k instanceof zr?Yr:null},Xr=F,Jr=De,Qr=pe,Zr=String,$r=TypeError,eo=ii,to=Object.setPrototypeOf||("__proto__"in{}?function(){var L,k=!1,M={};try{(L=function(L,k,M){try{return Xr(Jr(Object.getOwnPropertyDescriptor(L,k)[M]))}catch(L){}}(Object.prototype,"__proto__","set"))(M,[]),k=M instanceof Array}catch(L){}return function(M,U){return eo(M),function(L){if("object"==typeof L||Qr(L))return L;throw $r("Can't set "+Zr(L)+" as a prototype")}(U),k?L(M,U):M.__proto__=U,M}}():void 0),io={},no={},ro=Mt,oo=Z,so=On.indexOf,ao=no,co=F([].push),Ur=function(L,k){var M,U=oo(L),x=0,V=[];for(M in U)!ro(ao,M)&&ro(U,M)&&co(V,M);for(;k.length>x;)ro(U,M=k[x++])&&(~so(V,M)||co(V,M));return V},lo=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],uo=Ur,ho=lo.concat("length","prototype");io.f=Object.getOwnPropertyNames||function(L){return uo(L,ho)};var po={};po.f=Object.getOwnPropertySymbols;var _o=ae,Eo=io,fo=po,mo=ii,To=F([].concat),Io=_o("Reflect","ownKeys")||function(L){var k=Eo.f(mo(L)),M=fo.f;return M?To(k,M(L)):k},yo=Mt,Ao=Io,vo=_e,bo=Di,wo={},Oo=Ur,No=lo,Do=Object.keys||function(L){return Oo(L,No)},Po=Ee,Lo=Pi,ko=Di,Mo=ii,Uo=Z,xo=Do;wo.f=Po&&!Lo?Object.defineProperties:function(L,k){Mo(L);for(var M,U=Uo(k),x=xo(k),V=x.length,F=0;V>F;)ko.f(L,M=x[F++],U[M]);return L};var Vo,Fo=ae("document","documentElement"),Bo=ii,Go=wo,Wo=lo,Ho=no,Ko=Fo,zo=At,Yo="prototype",Xo="script",Jo=lr("IE_PROTO"),So=function(){},go=function(L){return"<script>"+L+"</"+Xo+">"},Ro=function(L){L.write(go("")),L.close();var k=L.parentWindow.Object;return L=null,k},Co=function(){try{Vo=new ActiveXObject("htmlfile")}catch(L){}var L,k;Co="undefined"!=typeof document?document.domain&&Vo?Ro(Vo):("javascript:",(k=zo("iframe")).style.display="none",Ko.appendChild(k),k.src=String("javascript:"),(L=k.contentWindow.document).open(),L.write(go("document.F=Object")),L.close(),L.F):Ro(Vo);for(var M=Wo.length;M--;)delete Co[Yo][Wo[M]];return Co()};Ho[Jo]=!0;var Qo=Object.create||function(L,k){var M;return null!==L?(So[Yo]=Bo(L),M=new So,So[Yo]=null,M[Jo]=L):M=Co(),void 0===k?M:Go.f(M,k)},Zo=Fe,$o=nn,ts=Error,is=F("".replace),ns=String(ts("zxcasd").stack),os=/\n\s*at [^:]*:[^\n]*/,ss=os.test(ns),as=B,cs=!n((function(){var L=Error("a");return!("stack"in L)||(Object.defineProperty(L,"stack",as(1,7)),7!==L.stack)})),ds=nn,ls=cs,us=Error.captureStackTrace,hs={},ps=hs,_s=ht("iterator"),Es=Array.prototype,jo=function(L){return void 0!==L&&(ps.Array===L||Es[_s]===L)},ms=Xn,gs=ke,Ss=Y,Rs=hs,Is=ht("iterator"),qo=function(L){if(!Ss(L))return gs(L,Is)||gs(L,"@@iterator")||Rs[ms(L)]},ys=ge,As=De,Cs=ii,vs=be,bs=qo,Ns=TypeError,es=function(L,k){var M=arguments.length<2?bs(L):k;if(As(M))return Cs(ys(M,L));throw Ns(vs(L)+" is not iterable")},Ps=ge,Ls=ii,ks=ke,rs=function(L,k,M){var U,x;Ls(L);try{if(!(U=ks(L,"return"))){if("throw"===k)throw M;return M}U=Ps(U,L)}catch(L){x=!0,U=L}if("throw"===k)throw M;if(x)throw U;return Ls(U),M},Us=Xt,xs=ge,Vs=ii,Fs=be,Bs=jo,js=Gi,Gs=j,Ws=es,Hs=qo,Ks=rs,zs=TypeError,fs=function(L,k){this.stopped=L,this.result=k},Ys=fs.prototype,Ts=function(L,k,M){var U,x,V,F,j,z,Q,$=M&&M.that,ee=!(!M||!M.AS_ENTRIES),te=!(!M||!M.IS_RECORD),ie=!(!M||!M.IS_ITERATOR),ne=!(!M||!M.INTERRUPTED),re=Us(k,$),f=function(L){return U&&Ks(U,"normal",L),new fs(!0,L)},m=function(L){return ee?(Vs(L),ne?re(L[0],L[1],f):re(L[0],L[1])):ne?re(L,f):re(L)};if(te)U=L.iterator;else if(ie)U=L;else{if(!(x=Hs(L)))throw zs(Fs(L)+" is not iterable");if(Bs(x)){for(V=0,F=js(L);F>V;V++)if((j=m(L[V]))&&Gs(Ys,j))return j;return new fs(!1)}U=Ws(L,x)}for(z=te?L.next:U.next;!(Q=xs(z,U)).done;){try{j=m(Q.value)}catch(L){Ks(U,"throw",L)}if("object"==typeof j&&j&&Gs(Ys,j))return j}return new fs(!1)},qs=fn,Xs=wi,Js=j,Qs=qr,Zs=to,$s=Qo,ea=nn,ta=B,ws=function(L,k){Zo(k)&&"cause"in k&&$o(L,"cause",k.cause)},Os=function(L,k,M,U){ls&&(us?us(L,k):ds(L,"stack",function(L,k){if(ss&&"string"==typeof L&&!ts.prepareStackTrace)for(;k--;)L=is(L,os,"");return L}(M,U)))},ia=Ts,Ds=function(L,k){return void 0===L?arguments.length<2?"":k:qs(L)},na=ht("toStringTag"),ra=Error,oa=[].push,Ms=function(L,k){var M,U=Js(sa,this);Zs?M=Zs(ra(),U?Qs(this):sa):(M=U?this:$s(sa),ea(M,na,"Error")),void 0!==k&&ea(M,"message",Ds(k)),Os(M,Ms,M.stack,1),arguments.length>2&&ws(M,arguments[2]);var x=[];return ia(L,oa,{that:x}),ea(M,"errors",x),M};Zs?Zs(Ms,ra):function(L,k,M){for(var U=Ao(k),x=bo.f,V=vo.f,F=0;F<U.length;F++){var j=U[F];yo(L,j)||M&&yo(M,j)||x(L,j,V(k,j))}}(Ms,ra,{name:!0});var sa=Ms.prototype=$s(ra.prototype,{constructor:ta(1,Ms),message:ta(1,""),name:ta(1,"AggregateError")});Xs({global:!0,constructor:!0,arity:2},{AggregateError:Ms});var aa,ca,da,la=pe,ua=z.WeakMap,pa=la(ua)&&/native code/.test(String(ua)),_a=z,Ea=Fe,fa=nn,ma=Mt,ga=wt,Ta=lr,Sa=no,Ra="Object already initialized",Ia=_a.TypeError,ya=_a.WeakMap;if(pa||ga.state){var Aa=ga.state||(ga.state=new ya);Aa.get=Aa.get,Aa.has=Aa.has,Aa.set=Aa.set,aa=function(L,k){if(Aa.has(L))throw Ia(Ra);return k.facade=L,Aa.set(L,k),k},ca=function(L){return Aa.get(L)||{}},da=function(L){return Aa.has(L)}}else{var Ca=Ta("state");Sa[Ca]=!0,aa=function(L,k){if(ma(L,Ca))throw Ia(Ra);return k.facade=L,fa(L,Ca,k),k},ca=function(L){return ma(L,Ca)?L[Ca]:{}},da=function(L){return ma(L,Ca)}}var va,ba,wa,Oa={set:aa,get:ca,has:da,enforce:function(L){return da(L)?ca(L):aa(L,{})},getterFor:function(L){return function(k){var M;if(!Ea(k)||(M=ca(k)).type!==L)throw Ia("Incompatible receiver, "+L+" required");return M}}},Na=Ee,Pa=Mt,La=Function.prototype,ka=Na&&Object.getOwnPropertyDescriptor,Ma=Pa(La,"name"),Ua={EXISTS:Ma,PROPER:Ma&&"something"===function(){}.name,CONFIGURABLE:Ma&&(!Na||Na&&ka(La,"name").configurable)},Fa=nn,ha=function(L,k,M,U){return U&&U.enumerable?L[k]=M:Fa(L,k,M),L},Ba=n,ja=pe,Ga=Fe,Wa=Qo,Ha=qr,Ka=ha,za=ht("iterator"),Ya=!1;[].keys&&("next"in(wa=[].keys())?(ba=Ha(Ha(wa)))!==Object.prototype&&(va=ba):Ya=!0);var qa=!Ga(va)||Ba((function(){var L={};return va[za].call(L)!==L}));ja((va=qa?{}:Wa(va))[za])||Ka(va,za,(function(){return this}));var Xa={IteratorPrototype:va,BUGGY_SAFARI_ITERATORS:Ya},Ja=Xn,Qa=jn?{}.toString:function(){return"[object "+Ja(this)+"]"},Za=jn,$a=Di.f,nc=nn,rc=Mt,oc=Qa,sc=ht("toStringTag"),Da=function(L,k,M,U){if(L){var x=M?L:L.prototype;rc(x,sc)||$a(x,sc,{configurable:!0,value:k}),U&&!Za&&nc(x,"toString",oc)}},ac=Xa.IteratorPrototype,cc=Qo,dc=B,lc=Da,uc=hs,xa=function(){return this},Va=function(L,k,M,U){var x=k+" Iterator";return L.prototype=cc(ac,{next:dc(+!U,M)}),lc(L,x,!1,!0),uc[x]=xa,L},pc=wi,_c=ge,Ec=Va,fc=qr,mc=Da,gc=ha,Tc=hs,Rc=Ua.PROPER,Ic=Xa.BUGGY_SAFARI_ITERATORS,yc=ht("iterator"),Ac="keys",Cc="values",vc="entries",ec=function(){return this},tc=function(L,k,M,U,x,V,F){Ec(M,k,U);var j,z,Q,l=function(L){if(L===x&&ne)return ne;if(!Ic&&L in te)return te[L];switch(L){case Ac:case Cc:case vc:return function(){return new M(this,L)}}return function(){return new M(this)}},$=k+" Iterator",ee=!1,te=L.prototype,ie=te[yc]||te["@@iterator"]||x&&te[x],ne=!Ic&&ie||l(x),re="Array"==k&&te.entries||ie;if(re&&(j=fc(re.call(new L)))!==Object.prototype&&j.next&&(mc(j,$,!0,!0),Tc[$]=ec),Rc&&x==Cc&&ie&&ie.name!==Cc&&(ee=!0,ne=function(){return _c(ie,this)}),x)if(z={values:l(Cc),keys:V?ne:l(Ac),entries:l(vc)},F)for(Q in z)(Ic||ee||!(Q in te))&&gc(te,Q,z[Q]);else pc({target:k,proto:!0,forced:Ic||ee},z);return F&&te[yc]!==ne&&gc(te,yc,ne,{name:x}),Tc[k]=ne,z},ic=function(L,k){return{value:L,done:k}},bc=Z,wc=hs,Nc=Oa;Di.f;var Dc=tc,Pc=ic,Lc="Array Iterator",kc=Nc.set,xc=Nc.getterFor(Lc);Dc(Array,"Array",(function(L,k){kc(this,{type:Lc,target:bc(L),index:0,kind:k})}),(function(){var L=xc(this),k=L.target,M=L.kind,U=L.index++;return!k||U>=k.length?(L.target=void 0,Pc(void 0,!0)):Pc("keys"==M?U:"values"==M?k[U]:[U,k[U]],!1)}),"values"),wc.Arguments=wc.Array;var Vc=Di,hc=function(L,k,M){return Vc.f(L,k,M)},Fc=ae,Bc=hc,jc=Ee,Gc=ht("species"),Wc=j,Hc=TypeError,Sc=function(L,k){if(Wc(k,L))return L;throw Hc("Incorrect invocation")},Kc=pe,zc=wt,Yc=F(Function.toString);Kc(zc.inspectSource)||(zc.inspectSource=function(L){return Yc(L)});var qc=zc.inspectSource,Xc=F,Qc=n,$c=pe,ed=Xn,td=qc,Oc=function(){},id=[],nd=ae("Reflect","construct"),rd=/^\s*(?:class|function)\b/,od=Xc(rd.exec),sd=!rd.exec(Oc),Mc=function(L){if(!$c(L))return!1;try{return nd(Oc,id,L),!0}catch(L){return!1}},Uc=function(L){if(!$c(L))return!1;switch(ed(L)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return sd||!!od(rd,td(L))}catch(L){return!0}};Uc.sham=!0;var ad,cd,dd,ld,ud=!nd||Qc((function(){var L;return Mc(Mc.call)||!Mc(Object)||!Mc((function(){L=!0}))||L}))?Uc:Mc,hd=ud,pd=be,_d=TypeError,Ed=ii,fd=Y,md=ht("species"),Jc=function(L,k){var M,U=Ed(L).constructor;return void 0===U||fd(M=Ed(U)[md])?k:function(L){if(hd(L))return L;throw _d(pd(L)+" is not a constructor")}(M)},gd=F([].slice),Td=TypeError,Zc=function(L,k){if(L<k)throw Td("Not enough arguments");return L},Sd=/(?:ipad|iphone|ipod).*applewebkit/i.test(He),Rd=z,Ad=ie,wd=Xt,Od=pe,Nd=Mt,Dd=n,Pd=Fo,Ld=gd,kd=At,Md=Zc,Ud=Sd,xd=wr,Vd=Rd.setImmediate,Fd=Rd.clearImmediate,Bd=Rd.process,jd=Rd.Dispatch,Gd=Rd.Function,Wd=Rd.MessageChannel,Hd=Rd.String,Kd=0,zd={},Yd="onreadystatechange";Dd((function(){ad=Rd.location}));var Cd=function(L){if(Nd(zd,L)){var k=zd[L];delete zd[L],k()}},Id=function(L){return function(){Cd(L)}},vd=function(L){Cd(L.data)},yd=function(L){Rd.postMessage(Hd(L),ad.protocol+"//"+ad.host)};Vd&&Fd||(Vd=function(L){Md(arguments.length,1);var k=Od(L)?L:Gd(L),M=Ld(arguments,1);return zd[++Kd]=function(){Ad(k,void 0,M)},cd(Kd),Kd},Fd=function(L){delete zd[L]},xd?cd=function(L){Bd.nextTick(Id(L))}:jd&&jd.now?cd=function(L){jd.now(Id(L))}:Wd&&!Ud?(ld=(dd=new Wd).port2,dd.port1.onmessage=vd,cd=wd(ld.postMessage,ld)):Rd.addEventListener&&Od(Rd.postMessage)&&!Rd.importScripts&&ad&&"file:"!==ad.protocol&&!Dd(yd)?(cd=yd,Rd.addEventListener("message",vd,!1)):cd=Yd in kd("script")?function(L){Pd.appendChild(kd("script"))[Yd]=function(){Pd.removeChild(this),Cd(L)}}:function(L){setTimeout(Id(L),0)});var qd={set:Vd,clear:Fd},bd=function(){this.head=null,this.tail=null};bd.prototype={add:function(L){var k={item:L,next:null},M=this.tail;M?M.next=k:this.head=k,this.tail=k},get:function(){var L=this.head;if(L)return null===(this.head=L.next)&&(this.tail=null),L.item}};var Xd,Jd,Qd,$d,tl,il=bd,nl=/ipad|iphone|ipod/i.test(He)&&"undefined"!=typeof Pebble,rl=/web0s(?!.*chrome)/i.test(He),ol=z,sl=Xt,al=_e.f,cl=qd.set,dl=il,ll=Sd,ul=nl,hl=rl,pl=wr,_l=ol.MutationObserver||ol.WebKitMutationObserver,El=ol.document,fl=ol.process,ml=ol.Promise,gl=al(ol,"queueMicrotask"),Tl=gl&&gl.value;if(!Tl){var Sl=new dl,Zd=function(){var L,k;for(pl&&(L=fl.domain)&&L.exit();k=Sl.get();)try{k()}catch(L){throw Sl.head&&Xd(),L}L&&L.enter()};ll||pl||hl||!_l||!El?!ul&&ml&&ml.resolve?(($d=ml.resolve(void 0)).constructor=ml,tl=sl($d.then,$d),Xd=function(){tl(Zd)}):pl?Xd=function(){fl.nextTick(Zd)}:(cl=sl(cl,ol),Xd=function(){cl(Zd)}):(Jd=!0,Qd=El.createTextNode(""),new _l(Zd).observe(Qd,{characterData:!0}),Xd=function(){Qd.data=Jd=!Jd}),Tl=function(L){Sl.head||Xd(),Sl.add(L)}}var Rl=Tl,el=function(L){try{return{error:!1,value:L()}}catch(L){return{error:!0,value:L}}},Il=z.Promise,yl="object"==typeof Deno&&Deno&&"object"==typeof Deno.version,Al=!yl&&!wr&&"object"==typeof window&&"object"==typeof document,vl=z,bl=Il,wl=pe,Ol=Ci,Nl=qc,Dl=ht,Pl=Al,Ll=yl,kl=Ze,Ml=bl&&bl.prototype,Ul=Dl("species"),xl=!1,Vl=wl(vl.PromiseRejectionEvent),Fl=Ol("Promise",(function(){var L=Nl(bl),k=L!==String(bl);if(!k&&66===kl)return!0;if(!Ml.catch||!Ml.finally)return!0;if(!kl||kl<51||!/native code/.test(L)){var M=new bl((function(L){L(1)})),n=function(L){L((function(){}),(function(){}))};if((M.constructor={})[Ul]=n,!(xl=M.then((function(){}))instanceof n))return!0}return!k&&(Pl||Ll)&&!Vl})),Bl={CONSTRUCTOR:Fl,REJECTION_EVENT:Vl,SUBCLASSING:xl},jl={},Gl=De,Wl=TypeError,Cl=function(L){var k,M;this.promise=new L((function(L,U){if(void 0!==k||void 0!==M)throw Wl("Bad Promise constructor");k=L,M=U})),this.resolve=Gl(k),this.reject=Gl(M)};jl.f=function(L){return new Cl(L)};var Hl,Kl,zl=wi,Yl=wr,ql=z,Xl=ge,Jl=ha,Ql=Da,Zl=De,$l=pe,eu=Fe,tu=Sc,iu=Jc,nu=qd.set,ru=Rl,ou=el,su=il,mu=Oa,gu=Il,Tu=jl,Su="Promise",Ru=Bl.CONSTRUCTOR,Iu=Bl.REJECTION_EVENT,yu=mu.getterFor(Su),Au=mu.set,Cu=gu&&gu.prototype,vu=gu,bu=Cu,wu=ql.TypeError,Ou=ql.document,Nu=ql.process,Du=Tu.f,Pu=Du,Lu=!!(Ou&&Ou.createEvent&&ql.dispatchEvent),ku="unhandledrejection",au=function(L){var k;return!(!eu(L)||!$l(k=L.then))&&k},cu=function(L,k){var M,U,x,V=k.value,F=1==k.state,j=F?L.ok:L.fail,z=L.resolve,Q=L.reject,$=L.domain;try{j?(F||(2===k.rejection&&pu(k),k.rejection=1),!0===j?M=V:($&&$.enter(),M=j(V),$&&($.exit(),x=!0)),M===L.promise?Q(wu("Promise-chain cycle")):(U=au(M))?Xl(U,M,z,Q):z(M)):Q(V)}catch(L){$&&!x&&$.exit(),Q(L)}},du=function(L,k){L.notified||(L.notified=!0,ru((function(){for(var M,U=L.reactions;M=U.get();)cu(M,L);L.notified=!1,k&&!L.rejection&&uu(L)})))},lu=function(L,k,M){var U,x;Lu?((U=Ou.createEvent("Event")).promise=k,U.reason=M,U.initEvent(L,!1,!0),ql.dispatchEvent(U)):U={promise:k,reason:M},!Iu&&(x=ql["on"+L])?x(U):L===ku&&function(L,k){try{1==arguments.length?console.error(L):console.error(L,k)}catch(L){}}("Unhandled promise rejection",M)},uu=function(L){Xl(nu,ql,(function(){var k,M=L.facade,U=L.value;if(hu(L)&&(k=ou((function(){Yl?Nu.emit("unhandledRejection",U,M):lu(ku,M,U)})),L.rejection=Yl||hu(L)?2:1,k.error))throw k.value}))},hu=function(L){return 1!==L.rejection&&!L.parent},pu=function(L){Xl(nu,ql,(function(){var k=L.facade;Yl?Nu.emit("rejectionHandled",k):lu("rejectionhandled",k,L.value)}))},_u=function(L,k,M){return function(U){L(k,U,M)}},Eu=function(L,k,M){L.done||(L.done=!0,M&&(L=M),L.value=k,L.state=2,du(L,!0))},fu=function(L,k,M){if(!L.done){L.done=!0,M&&(L=M);try{if(L.facade===k)throw wu("Promise can't be resolved itself");var U=au(k);U?ru((function(){var M={done:!1};try{Xl(U,k,_u(fu,M,L),_u(Eu,M,L))}catch(k){Eu(M,k,L)}})):(L.value=k,L.state=1,du(L,!1))}catch(k){Eu({done:!1},k,L)}}};Ru&&(bu=(vu=function(L){tu(this,bu),Zl(L),Xl(Hl,this);var k=yu(this);try{L(_u(fu,k),_u(Eu,k))}catch(L){Eu(k,L)}}).prototype,(Hl=function(L){Au(this,{type:Su,done:!1,notified:!1,parent:!1,reactions:new su,rejection:!1,state:0,value:void 0})}).prototype=Jl(bu,"then",(function(L,k){var M=yu(this),U=Du(iu(this,vu));return M.parent=!0,U.ok=!$l(L)||L,U.fail=$l(k)&&k,U.domain=Yl?Nu.domain:void 0,0==M.state?M.reactions.add(U):ru((function(){cu(U,M)})),U.promise})),Kl=function(){var L=new Hl,k=yu(L);this.promise=L,this.resolve=_u(fu,k),this.reject=_u(Eu,k)},Tu.f=Du=function(L){return L===vu||void 0===L?new Kl(L):Pu(L)}),zl({global:!0,constructor:!0,wrap:!0,forced:Ru},{Promise:vu}),Ql(vu,Su,!1,!0),function(L){var k=Fc(L);jc&&k&&!k[Gc]&&Bc(k,Gc,{configurable:!0,get:function(){return this}})}(Su);var Mu=ht("iterator"),Uu=!1;try{var xu=0,Vu={next:function(){return{done:!!xu++}},return:function(){Uu=!0}};Vu[Mu]=function(){return this},Array.from(Vu,(function(){throw 2}))}catch(e){}var Fu=Il,Bu=Bl.CONSTRUCTOR||!function(L,k){if(!k&&!Uu)return!1;var M=!1;try{var U={};U[Mu]=function(){return{next:function(){return{done:M=!0}}}},L(U)}catch(L){}return M}((function(L){Fu.all(L).then(void 0,(function(){}))})),Gu=ge,Wu=De,Hu=jl,Ku=el,zu=Ts;wi({target:"Promise",stat:!0,forced:Bu},{all:function(L){var k=this,M=Hu.f(k),U=M.resolve,x=M.reject,V=Ku((function(){var M=Wu(k.resolve),V=[],F=0,j=1;zu(L,(function(L){var z=F++,Q=!1;j++,Gu(M,k,L).then((function(L){Q||(Q=!0,V[z]=L,--j||U(V))}),x)})),--j||U(V)}));return V.error&&x(V.value),M.promise}});var Yu=wi,qu=Bl.CONSTRUCTOR;Il&&Il.prototype,Yu({target:"Promise",proto:!0,forced:qu,real:!0},{catch:function(L){return this.then(void 0,L)}});var Xu=ge,Ju=De,Qu=jl,Zu=el,$u=Ts;wi({target:"Promise",stat:!0,forced:Bu},{race:function(L){var k=this,M=Qu.f(k),U=M.reject,x=Zu((function(){var x=Ju(k.resolve);$u(L,(function(L){Xu(x,k,L).then(M.resolve,U)}))}));return x.error&&U(x.value),M.promise}});var eh=ge,th=jl;wi({target:"Promise",stat:!0,forced:Bl.CONSTRUCTOR},{reject:function(L){var k=th.f(this);return eh(k.reject,void 0,L),k.promise}});var ih=ii,nh=Fe,rh=jl,ju=function(L,k){if(ih(L),nh(k)&&k.constructor===L)return k;var M=rh.f(L);return(0,M.resolve)(k),M.promise},oh=wi,sh=Il,ah=Bl.CONSTRUCTOR,ch=ju,dh=ae("Promise"),lh=!ah;oh({target:"Promise",stat:!0,forced:!0},{resolve:function(L){return ch(lh&&this===dh?sh:this,L)}});var uh=ge,hh=De,ph=jl,_h=el,Eh=Ts;wi({target:"Promise",stat:!0,forced:Bu},{allSettled:function(L){var k=this,M=ph.f(k),U=M.resolve,x=M.reject,V=_h((function(){var M=hh(k.resolve),x=[],V=0,F=1;Eh(L,(function(L){var j=V++,z=!1;F++,uh(M,k,L).then((function(L){z||(z=!0,x[j]={status:"fulfilled",value:L},--F||U(x))}),(function(L){z||(z=!0,x[j]={status:"rejected",reason:L},--F||U(x))}))})),--F||U(x)}));return V.error&&x(V.value),M.promise}});var fh=ge,mh=De,gh=ae,Th=jl,Sh=el,Ih=Ts,yh="No one promise resolved";wi({target:"Promise",stat:!0,forced:Bu},{any:function(L){var k=this,M=gh("AggregateError"),U=Th.f(k),x=U.resolve,V=U.reject,F=Sh((function(){var U=mh(k.resolve),F=[],j=0,z=1,Q=!1;Ih(L,(function(L){var $=j++,ee=!1;z++,fh(U,k,L).then((function(L){ee||Q||(Q=!0,x(L))}),(function(L){ee||Q||(ee=!0,F[$]=L,--z||V(new M(F,yh)))}))})),--z||V(new M(F,yh))}));return F.error&&V(F.value),U.promise}});var Ah=wi,Ch=Il,vh=n,bh=ae,wh=pe,Oh=Jc,Nh=ju,Dh=Ch&&Ch.prototype;Ah({target:"Promise",proto:!0,real:!0,forced:!!Ch&&vh((function(){Dh.finally.call({then:function(){}},(function(){}))}))},{finally:function(L){var k=Oh(this,bh("Promise")),M=wh(L);return this.then(M?function(M){return Nh(k,L()).then((function(){return M}))}:L,M?function(M){return Nh(k,L()).then((function(){throw M}))}:L)}});var Ph=F,Lh=Li,kh=fn,Mh=J,Uh=Ph("".charAt),xh=Ph("".charCodeAt),Vh=Ph("".slice),Rh=function(L){return function(k,M){var U,x,V=kh(Mh(k)),F=Lh(M),j=V.length;return F<0||F>=j?L?"":void 0:(U=xh(V,F))<55296||U>56319||F+1===j||(x=xh(V,F+1))<56320||x>57343?L?Uh(V,F):U:L?Vh(V,F,F+2):x-56320+(U-55296<<10)+65536}},Fh={codeAt:Rh(!1),charAt:Rh(!0)},Bh=Fh.charAt,jh=fn,Gh=Oa,Wh=tc,ep=ic,hp="String Iterator",Ip=Gh.set,yp=Gh.getterFor(hp);Wh(String,"String",(function(L){Ip(this,{type:hp,string:jh(L),index:0})}),(function(){var L,k=yp(this),M=k.string,U=k.index;return U>=M.length?ep(void 0,!0):(L=Bh(M,U),k.index+=L.length,ep(L,!1))}));var Ap=Be.Promise,Cp=z,vp=Xn,bp=nn,wp=hs,Op=ht("toStringTag");for(var Dp in{CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0}){var Pp=Cp[Dp],Lp=Pp&&Pp.prototype;Lp&&vp(Lp)!==Op&&bp(Lp,Op,Dp),wp[Dp]=wp.Array}var kp=Ap,Mp=i(kp);const Up=ir;function Hh(L,k){const M=L&&L.navigator;if(!M.mediaDevices)return;const n=function(L){if("object"!=typeof L||L.mandatory||L.optional)return L;const k={};return Object.keys(L).forEach((M=>{if("require"===M||"advanced"===M||"mediaSource"===M)return;const U="object"==typeof L[M]?L[M]:{ideal:L[M]};void 0!==U.exact&&"number"==typeof U.exact&&(U.min=U.max=U.exact);const r=function(L,k){return L?L+k.charAt(0).toUpperCase()+k.slice(1):"deviceId"===k?"sourceId":k};if(void 0!==U.ideal){k.optional=k.optional||[];let L={};"number"==typeof U.ideal?(L[r("min",M)]=U.ideal,k.optional.push(L),L={},L[r("max",M)]=U.ideal,k.optional.push(L)):(L[r("",M)]=U.ideal,k.optional.push(L))}void 0!==U.exact&&"number"!=typeof U.exact?(k.mandatory=k.mandatory||{},k.mandatory[r("",M)]=U.exact):["min","max"].forEach((L=>{void 0!==U[L]&&(k.mandatory=k.mandatory||{},k.mandatory[r(L,M)]=U[L])}))})),L.advanced&&(k.optional=(k.optional||[]).concat(L.advanced)),k},r=function(L,U){if(k.version>=61)return U(L);if((L=JSON.parse(JSON.stringify(L)))&&"object"==typeof L.audio){const t=function(L,k,M){k in L&&!(M in L)&&(L[M]=L[k],delete L[k])};t((L=JSON.parse(JSON.stringify(L))).audio,"autoGainControl","googAutoGainControl"),t(L.audio,"noiseSuppression","googNoiseSuppression"),L.audio=n(L.audio)}if(L&&"object"==typeof L.video){let x=L.video.facingMode;x=x&&("object"==typeof x?x:{ideal:x});const V=k.version<66;if(x&&("user"===x.exact||"environment"===x.exact||"user"===x.ideal||"environment"===x.ideal)&&(!M.mediaDevices.getSupportedConstraints||!M.mediaDevices.getSupportedConstraints().facingMode||V)){let k;if(delete L.video.facingMode,"environment"===x.exact||"environment"===x.ideal?k=["back","rear"]:"user"!==x.exact&&"user"!==x.ideal||(k=["front"]),k)return M.mediaDevices.enumerateDevices().then((M=>{let V=(M=M.filter((L=>"videoinput"===L.kind))).find((L=>k.some((k=>{var M;return Sr(M=L.label.toLowerCase()).call(M,k)}))));return!V&&M.length&&Sr(k).call(k,"back")&&(V=M[M.length-1]),V&&(L.video.deviceId=x.exact?{exact:V.deviceId}:{ideal:V.deviceId}),L.video=n(L.video),Up("chrome: "+JSON.stringify(L)),U(L)}))}L.video=n(L.video)}return Up("chrome: "+JSON.stringify(L)),U(L)},o=function(L){return k.version>=64?L:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[L.name]||L.name,message:L.message,constraint:L.constraint||L.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(M.getUserMedia=function(L,k,U){r(L,(L=>{M.webkitGetUserMedia(L,k,(L=>{U&&U(o(L))}))}))}.bind(M),M.mediaDevices.getUserMedia){const L=M.mediaDevices.getUserMedia.bind(M.mediaDevices);M.mediaDevices.getUserMedia=function(k){return r(k,(k=>L(k).then((L=>{if(k.audio&&!L.getAudioTracks().length||k.video&&!L.getVideoTracks().length)throw L.getTracks().forEach((L=>{L.stop()})),new DOMException("","NotFoundError");return L}),(L=>Mp.reject(o(L))))))}}}function Kh(L){L.MediaStream=L.MediaStream||L.webkitMediaStream}function Yh(L){if("object"==typeof L&&L.RTCPeerConnection&&!("ontrack"in L.RTCPeerConnection.prototype)){Object.defineProperty(L.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(L){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=L)},enumerable:!0,configurable:!0});const k=L.RTCPeerConnection.prototype.setRemoteDescription;L.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=k=>{k.stream.addEventListener("addtrack",(M=>{let U;U=L.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((L=>L.track&&L.track.id===M.track.id)):{track:M.track};const x=new Event("track");x.track=M.track,x.receiver=U,x.transceiver={receiver:U},x.streams=[k.stream],this.dispatchEvent(x)})),k.stream.getTracks().forEach((M=>{let U;U=L.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((L=>L.track&&L.track.id===M.id)):{track:M};const x=new Event("track");x.track=M,x.receiver=U,x.transceiver={receiver:U},x.streams=[k.stream],this.dispatchEvent(x)}))},this.addEventListener("addstream",this._ontrackpoly)),k.apply(this,arguments)}}else $n(L,"track",(L=>(L.transceiver||Object.defineProperty(L,"transceiver",{value:{receiver:L.receiver}}),L)))}function qh(L){if("object"==typeof L&&L.RTCPeerConnection&&!("getSenders"in L.RTCPeerConnection.prototype)&&"createDTMFSender"in L.RTCPeerConnection.prototype){const t=function(L,k){return{track:k,get dtmf(){return void 0===this._dtmf&&("audio"===k.kind?this._dtmf=L.createDTMFSender(k):this._dtmf=null),this._dtmf},_pc:L}};if(!L.RTCPeerConnection.prototype.getSenders){L.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const k=L.RTCPeerConnection.prototype.addTrack;L.RTCPeerConnection.prototype.addTrack=function(L,M){let U=k.apply(this,arguments);return U||(U=t(this,L),this._senders.push(U)),U};const M=L.RTCPeerConnection.prototype.removeTrack;L.RTCPeerConnection.prototype.removeTrack=function(L){M.apply(this,arguments);const k=this._senders.indexOf(L);-1!==k&&this._senders.splice(k,1)}}const k=L.RTCPeerConnection.prototype.addStream;L.RTCPeerConnection.prototype.addStream=function(L){this._senders=this._senders||[],k.apply(this,[L]),L.getTracks().forEach((L=>{this._senders.push(t(this,L))}))};const M=L.RTCPeerConnection.prototype.removeStream;L.RTCPeerConnection.prototype.removeStream=function(L){this._senders=this._senders||[],M.apply(this,[L]),L.getTracks().forEach((L=>{const k=this._senders.find((k=>k.track===L));k&&this._senders.splice(this._senders.indexOf(k),1)}))}}else if("object"==typeof L&&L.RTCPeerConnection&&"getSenders"in L.RTCPeerConnection.prototype&&"createDTMFSender"in L.RTCPeerConnection.prototype&&L.RTCRtpSender&&!("dtmf"in L.RTCRtpSender.prototype)){const k=L.RTCPeerConnection.prototype.getSenders;L.RTCPeerConnection.prototype.getSenders=function(){const L=k.apply(this,[]);return L.forEach((L=>L._pc=this)),L},Object.defineProperty(L.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function zh(L){if(!L.RTCPeerConnection)return;const k=L.RTCPeerConnection.prototype.getStats;L.RTCPeerConnection.prototype.getStats=function(){const[L,M,U]=arguments;if(arguments.length>0&&"function"==typeof L)return k.apply(this,arguments);if(0===k.length&&(0===arguments.length||"function"!=typeof L))return k.apply(this,[]);const r=function(L){const k={};return L.result().forEach((L=>{const M={id:L.id,timestamp:L.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[L.type]||L.type};L.names().forEach((k=>{M[k]=L.stat(k)})),k[M.id]=M})),k},o=function(L){return new Map(Object.keys(L).map((k=>[k,L[k]])))};if(arguments.length>=2){const n=function(L){M(o(r(L)))};return k.apply(this,[n,L])}return new Mp(((L,M)=>{k.apply(this,[function(k){L(o(r(k)))},M])})).then(M,U)}}function Jh(L){if(!("object"==typeof L&&L.RTCPeerConnection&&L.RTCRtpSender&&L.RTCRtpReceiver))return;if(!("getStats"in L.RTCRtpSender.prototype)){const k=L.RTCPeerConnection.prototype.getSenders;k&&(L.RTCPeerConnection.prototype.getSenders=function(){const L=k.apply(this,[]);return L.forEach((L=>L._pc=this)),L});const M=L.RTCPeerConnection.prototype.addTrack;M&&(L.RTCPeerConnection.prototype.addTrack=function(){const L=M.apply(this,arguments);return L._pc=this,L}),L.RTCRtpSender.prototype.getStats=function(){const L=this;return this._pc.getStats().then((k=>ar(k,L.track,!0)))}}if(!("getStats"in L.RTCRtpReceiver.prototype)){const k=L.RTCPeerConnection.prototype.getReceivers;k&&(L.RTCPeerConnection.prototype.getReceivers=function(){const L=k.apply(this,[]);return L.forEach((L=>L._pc=this)),L}),$n(L,"track",(L=>(L.receiver._pc=L.srcElement,L))),L.RTCRtpReceiver.prototype.getStats=function(){const L=this;return this._pc.getStats().then((k=>ar(k,L.track,!1)))}}if(!("getStats"in L.RTCRtpSender.prototype)||!("getStats"in L.RTCRtpReceiver.prototype))return;const k=L.RTCPeerConnection.prototype.getStats;L.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof L.MediaStreamTrack){const L=arguments[0];let k,M,U;return this.getSenders().forEach((M=>{M.track===L&&(k?U=!0:k=M)})),this.getReceivers().forEach((k=>(k.track===L&&(M?U=!0:M=k),k.track===L))),U||k&&M?Mp.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):k?k.getStats():M?M.getStats():Mp.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return k.apply(this,arguments)}}function Xh(L){L.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((L=>this._shimmedLocalStreams[L][0]))};const k=L.RTCPeerConnection.prototype.addTrack;L.RTCPeerConnection.prototype.addTrack=function(L,M){if(!M)return k.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const U=k.apply(this,arguments);return this._shimmedLocalStreams[M.id]?-1===this._shimmedLocalStreams[M.id].indexOf(U)&&this._shimmedLocalStreams[M.id].push(U):this._shimmedLocalStreams[M.id]=[M,U],U};const M=L.RTCPeerConnection.prototype.addStream;L.RTCPeerConnection.prototype.addStream=function(L){this._shimmedLocalStreams=this._shimmedLocalStreams||{},L.getTracks().forEach((L=>{if(this.getSenders().find((k=>k.track===L)))throw new DOMException("Track already exists.","InvalidAccessError")}));const k=this.getSenders();M.apply(this,arguments);const U=this.getSenders().filter((L=>-1===k.indexOf(L)));this._shimmedLocalStreams[L.id]=[L].concat(U)};const U=L.RTCPeerConnection.prototype.removeStream;L.RTCPeerConnection.prototype.removeStream=function(L){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[L.id],U.apply(this,arguments)};const x=L.RTCPeerConnection.prototype.removeTrack;L.RTCPeerConnection.prototype.removeTrack=function(L){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},L&&Object.keys(this._shimmedLocalStreams).forEach((k=>{const M=this._shimmedLocalStreams[k].indexOf(L);-1!==M&&this._shimmedLocalStreams[k].splice(M,1),1===this._shimmedLocalStreams[k].length&&delete this._shimmedLocalStreams[k]})),x.apply(this,arguments)}}function Qh(L,k){if(!L.RTCPeerConnection)return;if(L.RTCPeerConnection.prototype.addTrack&&k.version>=65)return Xh(L);const M=L.RTCPeerConnection.prototype.getLocalStreams;L.RTCPeerConnection.prototype.getLocalStreams=function(){const L=M.apply(this);return this._reverseStreams=this._reverseStreams||{},L.map((L=>this._reverseStreams[L.id]))};const U=L.RTCPeerConnection.prototype.addStream;L.RTCPeerConnection.prototype.addStream=function(k){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},k.getTracks().forEach((L=>{if(this.getSenders().find((k=>k.track===L)))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[k.id]){const M=new L.MediaStream(k.getTracks());this._streams[k.id]=M,this._reverseStreams[M.id]=k,k=M}U.apply(this,[k])};const x=L.RTCPeerConnection.prototype.removeStream;function o(L,k){let M=k.sdp;return Object.keys(L._reverseStreams||[]).forEach((k=>{const U=L._reverseStreams[k],x=L._streams[U.id];M=M.replace(new RegExp(x.id,"g"),U.id)})),new RTCSessionDescription({type:k.type,sdp:M})}L.RTCPeerConnection.prototype.removeStream=function(L){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},x.apply(this,[this._streams[L.id]||L]),delete this._reverseStreams[this._streams[L.id]?this._streams[L.id].id:L.id],delete this._streams[L.id]},L.RTCPeerConnection.prototype.addTrack=function(k,M){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const U=[].slice.call(arguments,1);if(1!==U.length||!U[0].getTracks().find((L=>L===k)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");const x=this.getSenders().find((L=>L.track===k));if(x)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const V=this._streams[M.id];if(V)V.addTrack(k),Mp.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}));else{const U=new L.MediaStream([k]);this._streams[M.id]=U,this._reverseStreams[U.id]=M,this.addStream(U)}return this.getSenders().find((L=>L.track===k))},["createOffer","createAnswer"].forEach((function(k){const M=L.RTCPeerConnection.prototype[k],U={[k](){const L=arguments;return arguments.length&&"function"==typeof arguments[0]?M.apply(this,[k=>{const M=o(this,k);L[0].apply(null,[M])},k=>{L[1]&&L[1].apply(null,k)},arguments[2]]):M.apply(this,arguments).then((L=>o(this,L)))}};L.RTCPeerConnection.prototype[k]=U[k]}));const V=L.RTCPeerConnection.prototype.setLocalDescription;L.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(L,k){let M=k.sdp;return Object.keys(L._reverseStreams||[]).forEach((k=>{const U=L._reverseStreams[k],x=L._streams[U.id];M=M.replace(new RegExp(U.id,"g"),x.id)})),new RTCSessionDescription({type:k.type,sdp:M})}(this,arguments[0]),V.apply(this,arguments)):V.apply(this,arguments)};const F=Object.getOwnPropertyDescriptor(L.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(L.RTCPeerConnection.prototype,"localDescription",{get(){const L=F.get.apply(this);return""===L.type?L:o(this,L)}}),L.RTCPeerConnection.prototype.removeTrack=function(L){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!L._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(L._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let k;this._streams=this._streams||{},Object.keys(this._streams).forEach((M=>{this._streams[M].getTracks().find((k=>L.track===k))&&(k=this._streams[M])})),k&&(1===k.getTracks().length?this.removeStream(this._reverseStreams[k.id]):k.removeTrack(L.track),this.dispatchEvent(new Event("negotiationneeded")))}}function Zh(L,k){!L.RTCPeerConnection&&L.webkitRTCPeerConnection&&(L.RTCPeerConnection=L.webkitRTCPeerConnection),L.RTCPeerConnection&&k.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(k){const M=L.RTCPeerConnection.prototype[k],U={[k](){return arguments[0]=new("addIceCandidate"===k?L.RTCIceCandidate:L.RTCSessionDescription)(arguments[0]),M.apply(this,arguments)}};L.RTCPeerConnection.prototype[k]=U[k]}))}function $h(L,k){$n(L,"negotiationneeded",(L=>{const M=L.target;if(!(k.version<72||M.getConfiguration&&"plan-b"===M.getConfiguration().sdpSemantics)||"stable"===M.signalingState)return L}))}var xp=Object.freeze({__proto__:null,fixNegotiationNeeded:$h,shimAddTrackRemoveTrack:Qh,shimAddTrackRemoveTrackWithNative:Xh,shimGetDisplayMedia:function(L,k){L.navigator.mediaDevices&&"getDisplayMedia"in L.navigator.mediaDevices||L.navigator.mediaDevices&&("function"==typeof k?L.navigator.mediaDevices.getDisplayMedia=function(M){return k(M).then((k=>{const U=M.video&&M.video.width,x=M.video&&M.video.height,V=M.video&&M.video.frameRate;return M.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:k,maxFrameRate:V||3}},U&&(M.video.mandatory.maxWidth=U),x&&(M.video.mandatory.maxHeight=x),L.navigator.mediaDevices.getUserMedia(M)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:qh,shimGetStats:zh,shimGetUserMedia:Hh,shimMediaStream:Kh,shimOnTrack:Yh,shimPeerConnection:Zh,shimSenderReceiverGetStats:Jh});function tp(L,k){const M=L&&L.navigator,U=L&&L.MediaStreamTrack;if(M.getUserMedia=function(L,k,U){nr("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),M.mediaDevices.getUserMedia(L).then(k,U)},!(k.version>55&&"autoGainControl"in M.mediaDevices.getSupportedConstraints())){const e=function(L,k,M){k in L&&!(M in L)&&(L[M]=L[k],delete L[k])},L=M.mediaDevices.getUserMedia.bind(M.mediaDevices);if(M.mediaDevices.getUserMedia=function(k){return"object"==typeof k&&"object"==typeof k.audio&&(k=JSON.parse(JSON.stringify(k)),e(k.audio,"autoGainControl","mozAutoGainControl"),e(k.audio,"noiseSuppression","mozNoiseSuppression")),L(k)},U&&U.prototype.getSettings){const L=U.prototype.getSettings;U.prototype.getSettings=function(){const k=L.apply(this,arguments);return e(k,"mozAutoGainControl","autoGainControl"),e(k,"mozNoiseSuppression","noiseSuppression"),k}}if(U&&U.prototype.applyConstraints){const L=U.prototype.applyConstraints;U.prototype.applyConstraints=function(k){return"audio"===this.kind&&"object"==typeof k&&(k=JSON.parse(JSON.stringify(k)),e(k,"autoGainControl","mozAutoGainControl"),e(k,"noiseSuppression","mozNoiseSuppression")),L.apply(this,[k])}}}}function ip(L){"object"==typeof L&&L.RTCTrackEvent&&"receiver"in L.RTCTrackEvent.prototype&&!("transceiver"in L.RTCTrackEvent.prototype)&&Object.defineProperty(L.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function np(L,k){if("object"!=typeof L||!L.RTCPeerConnection&&!L.mozRTCPeerConnection)return;!L.RTCPeerConnection&&L.mozRTCPeerConnection&&(L.RTCPeerConnection=L.mozRTCPeerConnection),k.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(k){const M=L.RTCPeerConnection.prototype[k],U={[k](){return arguments[0]=new("addIceCandidate"===k?L.RTCIceCandidate:L.RTCSessionDescription)(arguments[0]),M.apply(this,arguments)}};L.RTCPeerConnection.prototype[k]=U[k]}));const M={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},U=L.RTCPeerConnection.prototype.getStats;L.RTCPeerConnection.prototype.getStats=function(){const[L,x,V]=arguments;return U.apply(this,[L||null]).then((L=>{if(k.version<53&&!x)try{L.forEach((L=>{L.type=M[L.type]||L.type}))}catch(k){if("TypeError"!==k.name)throw k;L.forEach(((k,U)=>{L.set(U,Object.assign({},k,{type:M[k.type]||k.type}))}))}return L})).then(x,V)}}function rp(L){if("object"!=typeof L||!L.RTCPeerConnection||!L.RTCRtpSender)return;if(L.RTCRtpSender&&"getStats"in L.RTCRtpSender.prototype)return;const k=L.RTCPeerConnection.prototype.getSenders;k&&(L.RTCPeerConnection.prototype.getSenders=function(){const L=k.apply(this,[]);return L.forEach((L=>L._pc=this)),L});const M=L.RTCPeerConnection.prototype.addTrack;M&&(L.RTCPeerConnection.prototype.addTrack=function(){const L=M.apply(this,arguments);return L._pc=this,L}),L.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Mp.resolve(new Map)}}function op(L){if("object"!=typeof L||!L.RTCPeerConnection||!L.RTCRtpSender)return;if(L.RTCRtpSender&&"getStats"in L.RTCRtpReceiver.prototype)return;const k=L.RTCPeerConnection.prototype.getReceivers;k&&(L.RTCPeerConnection.prototype.getReceivers=function(){const L=k.apply(this,[]);return L.forEach((L=>L._pc=this)),L}),$n(L,"track",(L=>(L.receiver._pc=L.srcElement,L))),L.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function sp(L){L.RTCPeerConnection&&!("removeStream"in L.RTCPeerConnection.prototype)&&(L.RTCPeerConnection.prototype.removeStream=function(L){nr("removeStream","removeTrack"),this.getSenders().forEach((k=>{var M;k.track&&Sr(M=L.getTracks()).call(M,k.track)&&this.removeTrack(k)}))})}function ap(L){L.DataChannel&&!L.RTCDataChannel&&(L.RTCDataChannel=L.DataChannel)}function cp(L){if("object"!=typeof L||!L.RTCPeerConnection)return;const k=L.RTCPeerConnection.prototype.addTransceiver;k&&(L.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let L=arguments[1]&&arguments[1].sendEncodings;void 0===L&&(L=[]),L=[...L];const M=L.length>0;M&&L.forEach((L=>{if("rid"in L&&!/^[a-z0-9]{0,16}$/i.test(L.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in L&&!(parseFloat(L.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in L&&!(parseFloat(L.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const U=k.apply(this,arguments);if(M){const{sender:k}=U,M=k.getParameters();(!("encodings"in M)||1===M.encodings.length&&0===Object.keys(M.encodings[0]).length)&&(M.encodings=L,k.sendEncodings=L,this.setParametersPromises.push(k.setParameters(M).then((()=>{delete k.sendEncodings})).catch((()=>{delete k.sendEncodings}))))}return U})}function dp(L){if("object"!=typeof L||!L.RTCRtpSender)return;const k=L.RTCRtpSender.prototype.getParameters;k&&(L.RTCRtpSender.prototype.getParameters=function(){const L=k.apply(this,arguments);return"encodings"in L||(L.encodings=[].concat(this.sendEncodings||[{}])),L})}function lp(L){if("object"!=typeof L||!L.RTCPeerConnection)return;const k=L.RTCPeerConnection.prototype.createOffer;L.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Mp.all(this.setParametersPromises).then((()=>k.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):k.apply(this,arguments)}}function up(L){if("object"!=typeof L||!L.RTCPeerConnection)return;const k=L.RTCPeerConnection.prototype.createAnswer;L.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Mp.all(this.setParametersPromises).then((()=>k.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):k.apply(this,arguments)}}var Vp=Object.freeze({__proto__:null,shimAddTransceiver:cp,shimCreateAnswer:up,shimCreateOffer:lp,shimGetDisplayMedia:function(L,k){L.navigator.mediaDevices&&"getDisplayMedia"in L.navigator.mediaDevices||L.navigator.mediaDevices&&(L.navigator.mediaDevices.getDisplayMedia=function(M){if(!M||!M.video){const L=new DOMException("getDisplayMedia without video constraints is undefined");return L.name="NotFoundError",L.code=8,Mp.reject(L)}return!0===M.video?M.video={mediaSource:k}:M.video.mediaSource=k,L.navigator.mediaDevices.getUserMedia(M)})},shimGetParameters:dp,shimGetUserMedia:tp,shimOnTrack:ip,shimPeerConnection:np,shimRTCDataChannel:ap,shimReceiverGetStats:op,shimRemoveStream:sp,shimSenderGetStats:rp});function pp(L){if("object"==typeof L&&L.RTCPeerConnection){if("getLocalStreams"in L.RTCPeerConnection.prototype||(L.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in L.RTCPeerConnection.prototype)){const k=L.RTCPeerConnection.prototype.addTrack;L.RTCPeerConnection.prototype.addStream=function(L){var M;this._localStreams||(this._localStreams=[]),Sr(M=this._localStreams).call(M,L)||this._localStreams.push(L),L.getAudioTracks().forEach((M=>k.call(this,M,L))),L.getVideoTracks().forEach((M=>k.call(this,M,L)))},L.RTCPeerConnection.prototype.addTrack=function(L){for(var M=arguments.length,U=new Array(M>1?M-1:0),x=1;x<M;x++)U[x-1]=arguments[x];return U&&U.forEach((L=>{var k;this._localStreams?Sr(k=this._localStreams).call(k,L)||this._localStreams.push(L):this._localStreams=[L]})),k.apply(this,arguments)}}"removeStream"in L.RTCPeerConnection.prototype||(L.RTCPeerConnection.prototype.removeStream=function(L){this._localStreams||(this._localStreams=[]);const k=this._localStreams.indexOf(L);if(-1===k)return;this._localStreams.splice(k,1);const M=L.getTracks();this.getSenders().forEach((L=>{Sr(M).call(M,L.track)&&this.removeTrack(L)}))})}}function _p(L){if("object"==typeof L&&L.RTCPeerConnection&&("getRemoteStreams"in L.RTCPeerConnection.prototype||(L.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in L.RTCPeerConnection.prototype))){Object.defineProperty(L.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(L){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=L),this.addEventListener("track",this._onaddstreampoly=L=>{L.streams.forEach((L=>{var k;if(this._remoteStreams||(this._remoteStreams=[]),Sr(k=this._remoteStreams).call(k,L))return;this._remoteStreams.push(L);const M=new Event("addstream");M.stream=L,this.dispatchEvent(M)}))})}});const k=L.RTCPeerConnection.prototype.setRemoteDescription;L.RTCPeerConnection.prototype.setRemoteDescription=function(){const L=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(k){k.streams.forEach((k=>{if(L._remoteStreams||(L._remoteStreams=[]),L._remoteStreams.indexOf(k)>=0)return;L._remoteStreams.push(k);const M=new Event("addstream");M.stream=k,L.dispatchEvent(M)}))}),k.apply(L,arguments)}}}function Ep(L){if("object"!=typeof L||!L.RTCPeerConnection)return;const k=L.RTCPeerConnection.prototype,M=k.createOffer,U=k.createAnswer,x=k.setLocalDescription,V=k.setRemoteDescription,F=k.addIceCandidate;k.createOffer=function(L,k){const U=arguments.length>=2?arguments[2]:arguments[0],x=M.apply(this,[U]);return k?(x.then(L,k),Mp.resolve()):x},k.createAnswer=function(L,k){const M=arguments.length>=2?arguments[2]:arguments[0],x=U.apply(this,[M]);return k?(x.then(L,k),Mp.resolve()):x};let a=function(L,k,M){const U=x.apply(this,[L]);return M?(U.then(k,M),Mp.resolve()):U};k.setLocalDescription=a,a=function(L,k,M){const U=V.apply(this,[L]);return M?(U.then(k,M),Mp.resolve()):U},k.setRemoteDescription=a,a=function(L,k,M){const U=F.apply(this,[L]);return M?(U.then(k,M),Mp.resolve()):U},k.addIceCandidate=a}function fp(L){const k=L&&L.navigator;if(k.mediaDevices&&k.mediaDevices.getUserMedia){const L=k.mediaDevices,M=L.getUserMedia.bind(L);k.mediaDevices.getUserMedia=L=>M(mp(L))}!k.getUserMedia&&k.mediaDevices&&k.mediaDevices.getUserMedia&&(k.getUserMedia=function(L,M,U){k.mediaDevices.getUserMedia(L).then(M,U)}.bind(k))}function mp(L){return L&&void 0!==L.video?Object.assign({},L,{video:or(L.video)}):L}function Tp(L){if(!L.RTCPeerConnection)return;const k=L.RTCPeerConnection;L.RTCPeerConnection=function(L,M){if(L&&L.iceServers){const k=[];for(let M=0;M<L.iceServers.length;M++){let U=L.iceServers[M];!U.hasOwnProperty("urls")&&U.hasOwnProperty("url")?(nr("RTCIceServer.url","RTCIceServer.urls"),U=JSON.parse(JSON.stringify(U)),U.urls=U.url,delete U.url,k.push(U)):k.push(L.iceServers[M])}L.iceServers=k}return new k(L,M)},L.RTCPeerConnection.prototype=k.prototype,"generateCertificate"in k&&Object.defineProperty(L.RTCPeerConnection,"generateCertificate",{get:()=>k.generateCertificate})}function Sp(L){"object"==typeof L&&L.RTCTrackEvent&&"receiver"in L.RTCTrackEvent.prototype&&!("transceiver"in L.RTCTrackEvent.prototype)&&Object.defineProperty(L.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function gp(L){const k=L.RTCPeerConnection.prototype.createOffer;L.RTCPeerConnection.prototype.createOffer=function(L){if(L){void 0!==L.offerToReceiveAudio&&(L.offerToReceiveAudio=!!L.offerToReceiveAudio);const k=this.getTransceivers().find((L=>"audio"===L.receiver.track.kind));!1===L.offerToReceiveAudio&&k?"sendrecv"===k.direction?k.setDirection?k.setDirection("sendonly"):k.direction="sendonly":"recvonly"===k.direction&&(k.setDirection?k.setDirection("inactive"):k.direction="inactive"):!0!==L.offerToReceiveAudio||k||this.addTransceiver("audio",{direction:"recvonly"}),void 0!==L.offerToReceiveVideo&&(L.offerToReceiveVideo=!!L.offerToReceiveVideo);const M=this.getTransceivers().find((L=>"video"===L.receiver.track.kind));!1===L.offerToReceiveVideo&&M?"sendrecv"===M.direction?M.setDirection?M.setDirection("sendonly"):M.direction="sendonly":"recvonly"===M.direction&&(M.setDirection?M.setDirection("inactive"):M.direction="inactive"):!0!==L.offerToReceiveVideo||M||this.addTransceiver("video",{direction:"recvonly"})}return k.apply(this,arguments)}}function Rp(L){"object"!=typeof L||L.AudioContext||(L.AudioContext=L.webkitAudioContext)}var Fp=Object.freeze({__proto__:null,shimAudioContext:Rp,shimCallbacksAPI:Ep,shimConstraints:mp,shimCreateOfferLegacy:gp,shimGetUserMedia:fp,shimLocalStreamsAPI:pp,shimRTCIceServerUrls:Tp,shimRemoteStreamsAPI:_p,shimTrackEventTransceiver:Sp}),Bp="\t\n\v\f\r Â áââââââââââââ¯âã\u2028\u2029\ufeff",jp=J,Gp=fn,Wp=Bp,Hp=F("".replace),Kp=RegExp("^["+Wp+"]+"),e_=RegExp("(^|[^"+Wp+"])["+Wp+"]+$"),Np=function(L){return function(k){var M=Gp(jp(k));return 1&L&&(M=Hp(M,Kp,"")),2&L&&(M=Hp(M,e_,"$1")),M}},t_={start:Np(1),end:Np(2),trim:Np(3)},i_=Ua.PROPER,n_=n,r_=Bp,o_=t_.trim;wi({target:"String",proto:!0,forced:function(L){return n_((function(){return!!r_[L]()||"âÂá "!=="âÂá "[L]()||i_&&r_[L].name!==L}))}("trim")},{trim:function(){return o_(this)}});var s_=Xi("String").trim,a_=j,c_=s_,d_=String.prototype,l_=i((function(L){var k=L.trim;return"string"==typeof L||L===d_||a_(d_,L)&&k===d_.trim?c_:k})),u_={exports:{}};!function(L){const k={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};k.localCName=k.generateIdentifier(),k.splitLines=function(L){return L.trim().split("\n").map((L=>L.trim()))},k.splitSections=function(L){return L.split("\nm=").map(((L,k)=>(k>0?"m="+L:L).trim()+"\r\n"))},k.getDescription=function(L){const M=k.splitSections(L);return M&&M[0]},k.getMediaSections=function(L){const M=k.splitSections(L);return M.shift(),M},k.matchPrefix=function(L,M){return k.splitLines(L).filter((L=>0===L.indexOf(M)))},k.parseCandidate=function(L){let k;k=0===L.indexOf("a=candidate:")?L.substring(12).split(" "):L.substring(10).split(" ");const M={foundation:k[0],component:{1:"rtp",2:"rtcp"}[k[1]]||k[1],protocol:k[2].toLowerCase(),priority:parseInt(k[3],10),ip:k[4],address:k[4],port:parseInt(k[5],10),type:k[7]};for(let L=8;L<k.length;L+=2)switch(k[L]){case"raddr":M.relatedAddress=k[L+1];break;case"rport":M.relatedPort=parseInt(k[L+1],10);break;case"tcptype":M.tcpType=k[L+1];break;case"ufrag":M.ufrag=k[L+1],M.usernameFragment=k[L+1];break;default:void 0===M[k[L]]&&(M[k[L]]=k[L+1])}return M},k.writeCandidate=function(L){const k=[];k.push(L.foundation);const M=L.component;"rtp"===M?k.push(1):"rtcp"===M?k.push(2):k.push(M),k.push(L.protocol.toUpperCase()),k.push(L.priority),k.push(L.address||L.ip),k.push(L.port);const U=L.type;return k.push("typ"),k.push(U),"host"!==U&&L.relatedAddress&&L.relatedPort&&(k.push("raddr"),k.push(L.relatedAddress),k.push("rport"),k.push(L.relatedPort)),L.tcpType&&"tcp"===L.protocol.toLowerCase()&&(k.push("tcptype"),k.push(L.tcpType)),(L.usernameFragment||L.ufrag)&&(k.push("ufrag"),k.push(L.usernameFragment||L.ufrag)),"candidate:"+k.join(" ")},k.parseIceOptions=function(L){return L.substring(14).split(" ")},k.parseRtpMap=function(L){let k=L.substring(9).split(" ");const M={payloadType:parseInt(k.shift(),10)};return k=k[0].split("/"),M.name=k[0],M.clockRate=parseInt(k[1],10),M.channels=3===k.length?parseInt(k[2],10):1,M.numChannels=M.channels,M},k.writeRtpMap=function(L){let k=L.payloadType;void 0!==L.preferredPayloadType&&(k=L.preferredPayloadType);const M=L.channels||L.numChannels||1;return"a=rtpmap:"+k+" "+L.name+"/"+L.clockRate+(1!==M?"/"+M:"")+"\r\n"},k.parseExtmap=function(L){const k=L.substring(9).split(" ");return{id:parseInt(k[0],10),direction:k[0].indexOf("/")>0?k[0].split("/")[1]:"sendrecv",uri:k[1],attributes:k.slice(2).join(" ")}},k.writeExtmap=function(L){return"a=extmap:"+(L.id||L.preferredId)+(L.direction&&"sendrecv"!==L.direction?"/"+L.direction:"")+" "+L.uri+(L.attributes?" "+L.attributes:"")+"\r\n"},k.parseFmtp=function(L){const k={};let M;const U=L.substring(L.indexOf(" ")+1).split(";");for(let L=0;L<U.length;L++)M=U[L].trim().split("="),k[M[0].trim()]=M[1];return k},k.writeFmtp=function(L){let k="",M=L.payloadType;if(void 0!==L.preferredPayloadType&&(M=L.preferredPayloadType),L.parameters&&Object.keys(L.parameters).length){const U=[];Object.keys(L.parameters).forEach((k=>{void 0!==L.parameters[k]?U.push(k+"="+L.parameters[k]):U.push(k)})),k+="a=fmtp:"+M+" "+U.join(";")+"\r\n"}return k},k.parseRtcpFb=function(L){const k=L.substring(L.indexOf(" ")+1).split(" ");return{type:k.shift(),parameter:k.join(" ")}},k.writeRtcpFb=function(L){let k="",M=L.payloadType;return void 0!==L.preferredPayloadType&&(M=L.preferredPayloadType),L.rtcpFeedback&&L.rtcpFeedback.length&&L.rtcpFeedback.forEach((L=>{k+="a=rtcp-fb:"+M+" "+L.type+(L.parameter&&L.parameter.length?" "+L.parameter:"")+"\r\n"})),k},k.parseSsrcMedia=function(L){const k=L.indexOf(" "),M={ssrc:parseInt(L.substring(7,k),10)},U=L.indexOf(":",k);return U>-1?(M.attribute=L.substring(k+1,U),M.value=L.substring(U+1)):M.attribute=L.substring(k+1),M},k.parseSsrcGroup=function(L){const k=L.substring(13).split(" ");return{semantics:k.shift(),ssrcs:k.map((L=>parseInt(L,10)))}},k.getMid=function(L){const M=k.matchPrefix(L,"a=mid:")[0];if(M)return M.substring(6)},k.parseFingerprint=function(L){const k=L.substring(14).split(" ");return{algorithm:k[0].toLowerCase(),value:k[1].toUpperCase()}},k.getDtlsParameters=function(L,M){return{role:"auto",fingerprints:k.matchPrefix(L+M,"a=fingerprint:").map(k.parseFingerprint)}},k.writeDtlsParameters=function(L,k){let M="a=setup:"+k+"\r\n";return L.fingerprints.forEach((L=>{M+="a=fingerprint:"+L.algorithm+" "+L.value+"\r\n"})),M},k.parseCryptoLine=function(L){const k=L.substring(9).split(" ");return{tag:parseInt(k[0],10),cryptoSuite:k[1],keyParams:k[2],sessionParams:k.slice(3)}},k.writeCryptoLine=function(L){return"a=crypto:"+L.tag+" "+L.cryptoSuite+" "+("object"==typeof L.keyParams?k.writeCryptoKeyParams(L.keyParams):L.keyParams)+(L.sessionParams?" "+L.sessionParams.join(" "):"")+"\r\n"},k.parseCryptoKeyParams=function(L){if(0!==L.indexOf("inline:"))return null;const k=L.substring(7).split("|");return{keyMethod:"inline",keySalt:k[0],lifeTime:k[1],mkiValue:k[2]?k[2].split(":")[0]:void 0,mkiLength:k[2]?k[2].split(":")[1]:void 0}},k.writeCryptoKeyParams=function(L){return L.keyMethod+":"+L.keySalt+(L.lifeTime?"|"+L.lifeTime:"")+(L.mkiValue&&L.mkiLength?"|"+L.mkiValue+":"+L.mkiLength:"")},k.getCryptoParameters=function(L,M){return k.matchPrefix(L+M,"a=crypto:").map(k.parseCryptoLine)},k.getIceParameters=function(L,M){const U=k.matchPrefix(L+M,"a=ice-ufrag:")[0],x=k.matchPrefix(L+M,"a=ice-pwd:")[0];return U&&x?{usernameFragment:U.substring(12),password:x.substring(10)}:null},k.writeIceParameters=function(L){let k="a=ice-ufrag:"+L.usernameFragment+"\r\na=ice-pwd:"+L.password+"\r\n";return L.iceLite&&(k+="a=ice-lite\r\n"),k},k.parseRtpParameters=function(L){const M={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},U=k.splitLines(L)[0].split(" ");M.profile=U[2];for(let x=3;x<U.length;x++){const V=U[x],F=k.matchPrefix(L,"a=rtpmap:"+V+" ")[0];if(F){const U=k.parseRtpMap(F),x=k.matchPrefix(L,"a=fmtp:"+V+" ");switch(U.parameters=x.length?k.parseFmtp(x[0]):{},U.rtcpFeedback=k.matchPrefix(L,"a=rtcp-fb:"+V+" ").map(k.parseRtcpFb),M.codecs.push(U),U.name.toUpperCase()){case"RED":case"ULPFEC":M.fecMechanisms.push(U.name.toUpperCase())}}}k.matchPrefix(L,"a=extmap:").forEach((L=>{M.headerExtensions.push(k.parseExtmap(L))}));const x=k.matchPrefix(L,"a=rtcp-fb:* ").map(k.parseRtcpFb);return M.codecs.forEach((L=>{x.forEach((k=>{L.rtcpFeedback.find((L=>L.type===k.type&&L.parameter===k.parameter))||L.rtcpFeedback.push(k)}))})),M},k.writeRtpDescription=function(L,M){let U="";U+="m="+L+" ",U+=M.codecs.length>0?"9":"0",U+=" "+(M.profile||"UDP/TLS/RTP/SAVPF")+" ",U+=M.codecs.map((L=>void 0!==L.preferredPayloadType?L.preferredPayloadType:L.payloadType)).join(" ")+"\r\n",U+="c=IN IP4 0.0.0.0\r\n",U+="a=rtcp:9 IN IP4 0.0.0.0\r\n",M.codecs.forEach((L=>{U+=k.writeRtpMap(L),U+=k.writeFmtp(L),U+=k.writeRtcpFb(L)}));let x=0;return M.codecs.forEach((L=>{L.maxptime>x&&(x=L.maxptime)})),x>0&&(U+="a=maxptime:"+x+"\r\n"),M.headerExtensions&&M.headerExtensions.forEach((L=>{U+=k.writeExtmap(L)})),U},k.parseRtpEncodingParameters=function(L){const M=[],U=k.parseRtpParameters(L),x=-1!==U.fecMechanisms.indexOf("RED"),V=-1!==U.fecMechanisms.indexOf("ULPFEC"),F=k.matchPrefix(L,"a=ssrc:").map((L=>k.parseSsrcMedia(L))).filter((L=>"cname"===L.attribute)),j=F.length>0&&F[0].ssrc;let z;const Q=k.matchPrefix(L,"a=ssrc-group:FID").map((L=>L.substring(17).split(" ").map((L=>parseInt(L,10)))));Q.length>0&&Q[0].length>1&&Q[0][0]===j&&(z=Q[0][1]),U.codecs.forEach((L=>{if("RTX"===L.name.toUpperCase()&&L.parameters.apt){let k={ssrc:j,codecPayloadType:parseInt(L.parameters.apt,10)};j&&z&&(k.rtx={ssrc:z}),M.push(k),x&&(k=JSON.parse(JSON.stringify(k)),k.fec={ssrc:j,mechanism:V?"red+ulpfec":"red"},M.push(k))}})),0===M.length&&j&&M.push({ssrc:j});let $=k.matchPrefix(L,"b=");return $.length&&($=0===$[0].indexOf("b=TIAS:")?parseInt($[0].substring(7),10):0===$[0].indexOf("b=AS:")?1e3*parseInt($[0].substring(5),10)*.95-16e3:void 0,M.forEach((L=>{L.maxBitrate=$}))),M},k.parseRtcpParameters=function(L){const M={},U=k.matchPrefix(L,"a=ssrc:").map((L=>k.parseSsrcMedia(L))).filter((L=>"cname"===L.attribute))[0];U&&(M.cname=U.value,M.ssrc=U.ssrc);const x=k.matchPrefix(L,"a=rtcp-rsize");M.reducedSize=x.length>0,M.compound=0===x.length;const V=k.matchPrefix(L,"a=rtcp-mux");return M.mux=V.length>0,M},k.writeRtcpParameters=function(L){let k="";return L.reducedSize&&(k+="a=rtcp-rsize\r\n"),L.mux&&(k+="a=rtcp-mux\r\n"),void 0!==L.ssrc&&L.cname&&(k+="a=ssrc:"+L.ssrc+" cname:"+L.cname+"\r\n"),k},k.parseMsid=function(L){let M;const U=k.matchPrefix(L,"a=msid:");if(1===U.length)return M=U[0].substring(7).split(" "),{stream:M[0],track:M[1]};const x=k.matchPrefix(L,"a=ssrc:").map((L=>k.parseSsrcMedia(L))).filter((L=>"msid"===L.attribute));return x.length>0?(M=x[0].value.split(" "),{stream:M[0],track:M[1]}):void 0},k.parseSctpDescription=function(L){const M=k.parseMLine(L),U=k.matchPrefix(L,"a=max-message-size:");let x;U.length>0&&(x=parseInt(U[0].substring(19),10)),isNaN(x)&&(x=65536);const V=k.matchPrefix(L,"a=sctp-port:");if(V.length>0)return{port:parseInt(V[0].substring(12),10),protocol:M.fmt,maxMessageSize:x};const F=k.matchPrefix(L,"a=sctpmap:");if(F.length>0){const L=F[0].substring(10).split(" ");return{port:parseInt(L[0],10),protocol:L[1],maxMessageSize:x}}},k.writeSctpDescription=function(L,k){let M=[];return M="DTLS/SCTP"!==L.protocol?["m="+L.kind+" 9 "+L.protocol+" "+k.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+k.port+"\r\n"]:["m="+L.kind+" 9 "+L.protocol+" "+k.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+k.port+" "+k.protocol+" 65535\r\n"],void 0!==k.maxMessageSize&&M.push("a=max-message-size:"+k.maxMessageSize+"\r\n"),M.join("")},k.generateSessionId=function(){return Math.random().toString().substr(2,22)},k.writeSessionBoilerplate=function(L,M,U){let x;const V=void 0!==M?M:2;return x=L||k.generateSessionId(),"v=0\r\no="+(U||"thisisadapterortc")+" "+x+" "+V+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},k.getDirection=function(L,M){const U=k.splitLines(L);for(let L=0;L<U.length;L++)switch(U[L]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return U[L].substring(2)}return M?k.getDirection(M):"sendrecv"},k.getKind=function(L){return k.splitLines(L)[0].split(" ")[0].substring(2)},k.isRejected=function(L){return"0"===L.split(" ",2)[1]},k.parseMLine=function(L){const M=k.splitLines(L)[0].substring(2).split(" ");return{kind:M[0],port:parseInt(M[1],10),protocol:M[2],fmt:M.slice(3).join(" ")}},k.parseOLine=function(L){const M=k.matchPrefix(L,"o=")[0].substring(2).split(" ");return{username:M[0],sessionId:M[1],sessionVersion:parseInt(M[2],10),netType:M[3],addressType:M[4],address:M[5]}},k.isValidSDP=function(L){if("string"!=typeof L||0===L.length)return!1;const M=k.splitLines(L);for(let L=0;L<M.length;L++)if(M[L].length<2||"="!==M[L].charAt(1))return!1;return!0},L.exports=k}(u_);var h_=u_.exports,p_=i(h_),__=function e(L,k){return k.forEach((function(k){k&&"string"!=typeof k&&!Array.isArray(k)&&Object.keys(k).forEach((function(M){if("default"!==M&&!(M in L)){var U=Object.getOwnPropertyDescriptor(k,M);Object.defineProperty(L,M,U.get?U:{enumerable:!0,get:function(){return k[M]}})}}))})),Object.freeze(L)}({__proto__:null,default:p_},[h_]);function Yp(L){if(!L.RTCIceCandidate||L.RTCIceCandidate&&"foundation"in L.RTCIceCandidate.prototype)return;const k=L.RTCIceCandidate;L.RTCIceCandidate=function(L){if("object"==typeof L&&L.candidate&&0===L.candidate.indexOf("a=")&&((L=JSON.parse(JSON.stringify(L))).candidate=L.candidate.substr(2)),L.candidate&&L.candidate.length){const M=new k(L),U=p_.parseCandidate(L.candidate),x=Object.assign(M,U);return x.toJSON=function(){return{candidate:x.candidate,sdpMid:x.sdpMid,sdpMLineIndex:x.sdpMLineIndex,usernameFragment:x.usernameFragment}},x}return new k(L)},L.RTCIceCandidate.prototype=k.prototype,$n(L,"icecandidate",(k=>(k.candidate&&Object.defineProperty(k,"candidate",{value:new L.RTCIceCandidate(k.candidate),writable:"false"}),k)))}function qp(L){!L.RTCIceCandidate||L.RTCIceCandidate&&"relayProtocol"in L.RTCIceCandidate.prototype||$n(L,"icecandidate",(L=>{if(L.candidate){const k=p_.parseCandidate(L.candidate.candidate);"relay"===k.type&&(L.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[k.priority>>24])}return L}))}function zp(L,k){if(!L.RTCPeerConnection)return;"sctp"in L.RTCPeerConnection.prototype||Object.defineProperty(L.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const i=function(L){if(!L||!L.sdp)return!1;const k=p_.splitSections(L.sdp);return k.shift(),k.some((L=>{const k=p_.parseMLine(L);return k&&"application"===k.kind&&-1!==k.protocol.indexOf("SCTP")}))},n=function(L){const k=L.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===k||k.length<2)return-1;const M=parseInt(k[1],10);return M!=M?-1:M},r=function(L){let M=65536;return"firefox"===k.browser&&(M=k.version<57?-1===L?16384:2147483637:k.version<60?57===k.version?65535:65536:2147483637),M},o=function(L,M){let U=65536;"firefox"===k.browser&&57===k.version&&(U=65535);const x=p_.matchPrefix(L.sdp,"a=max-message-size:");return x.length>0?U=parseInt(x[0].substr(19),10):"firefox"===k.browser&&-1!==M&&(U=2147483637),U},M=L.RTCPeerConnection.prototype.setRemoteDescription;L.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===k.browser&&k.version>=76){const{sdpSemantics:L}=this.getConfiguration();"plan-b"===L&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(i(arguments[0])){const L=n(arguments[0]),k=r(L),M=o(arguments[0],L);let U;U=0===k&&0===M?Number.POSITIVE_INFINITY:0===k||0===M?Math.max(k,M):Math.min(k,M);const x={};Object.defineProperty(x,"maxMessageSize",{get:()=>U}),this._sctp=x}return M.apply(this,arguments)}}function Jp(L){if(!L.RTCPeerConnection||!("createDataChannel"in L.RTCPeerConnection.prototype))return;function t(L,k){const M=L.send;L.send=function(){const U=arguments[0],x=U.length||U.size||U.byteLength;if("open"===L.readyState&&k.sctp&&x>k.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+k.sctp.maxMessageSize+" bytes)");return M.apply(L,arguments)}}const k=L.RTCPeerConnection.prototype.createDataChannel;L.RTCPeerConnection.prototype.createDataChannel=function(){const L=k.apply(this,arguments);return t(L,this),L},$n(L,"datachannel",(L=>(t(L.channel,L.target),L)))}function Xp(L){if(!L.RTCPeerConnection||"connectionState"in L.RTCPeerConnection.prototype)return;const k=L.RTCPeerConnection.prototype;Object.defineProperty(k,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(k,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(L){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),L&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=L)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((L=>{const M=k[L];k[L]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=L=>{const k=L.target;if(k._lastConnectionState!==k.connectionState){k._lastConnectionState=k.connectionState;const M=new Event("connectionstatechange",L);k.dispatchEvent(M)}return L},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),M.apply(this,arguments)}}))}function Qp(L,k){if(!L.RTCPeerConnection)return;if("chrome"===k.browser&&k.version>=71)return;if("safari"===k.browser&&k.version>=605)return;const M=L.RTCPeerConnection.prototype.setRemoteDescription;L.RTCPeerConnection.prototype.setRemoteDescription=function(k){if(k&&k.sdp&&-1!==k.sdp.indexOf("\na=extmap-allow-mixed")){const M=k.sdp.split("\n").filter((L=>"a=extmap-allow-mixed"!==l_(L).call(L))).join("\n");L.RTCSessionDescription&&k instanceof L.RTCSessionDescription?arguments[0]=new L.RTCSessionDescription({type:k.type,sdp:M}):k.sdp=M}return M.apply(this,arguments)}}function Zp(L,k){if(!L.RTCPeerConnection||!L.RTCPeerConnection.prototype)return;const M=L.RTCPeerConnection.prototype.addIceCandidate;M&&0!==M.length&&(L.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===k.browser&&k.version<78||"firefox"===k.browser&&k.version<68||"safari"===k.browser)&&arguments[0]&&""===arguments[0].candidate?Mp.resolve():M.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Mp.resolve())})}function $p(L,k){if(!L.RTCPeerConnection||!L.RTCPeerConnection.prototype)return;const M=L.RTCPeerConnection.prototype.setLocalDescription;M&&0!==M.length&&(L.RTCPeerConnection.prototype.setLocalDescription=function(){let L=arguments[0]||{};if("object"!=typeof L||L.type&&L.sdp)return M.apply(this,arguments);if(L={type:L.type,sdp:L.sdp},!L.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":L.type="offer";break;default:L.type="answer"}return L.sdp||"offer"!==L.type&&"answer"!==L.type?M.apply(this,[L]):("offer"===L.type?this.createOffer:this.createAnswer).apply(this).then((L=>M.apply(this,[L])))})}var f_=Object.freeze({__proto__:null,removeExtmapAllowMixed:Qp,shimAddIceCandidateNullOrEmpty:Zp,shimConnectionState:Xp,shimMaxMessageSize:zp,shimParameterlessSetLocalDescription:$p,shimRTCIceCandidate:Yp,shimRTCIceCandidateRelayProtocol:qp,shimSendThrowTypeError:Jp});!function(){let{window:L}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const M=ir,U=function(L){const k={browser:null,version:null};if(void 0===L||!L.navigator)return k.browser="Not a browser.",k;const{navigator:M}=L;if(M.mozGetUserMedia)k.browser="firefox",k.version=Zn(M.userAgent,/Firefox\/(\d+)\./,1);else if(M.webkitGetUserMedia||!1===L.isSecureContext&&L.webkitRTCPeerConnection)k.browser="chrome",k.version=Zn(M.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!L.RTCPeerConnection||!M.userAgent.match(/AppleWebKit\/(\d+)\./))return k.browser="Not a supported browser.",k;k.browser="safari",k.version=Zn(M.userAgent,/AppleWebKit\/(\d+)\./,1),k.supportsUnifiedPlan=L.RTCRtpTransceiver&&"currentDirection"in L.RTCRtpTransceiver.prototype}return k}(L),x={browserDetails:U,commonShim:f_,extractVersion:Zn,disableLog:er,disableWarnings:tr,sdp:__};switch(U.browser){case"chrome":if(!xp||!Zh||!k.shimChrome)return M("Chrome shim is not included in this adapter release."),x;if(null===U.version)return M("Chrome shim can not determine version, not shimming."),x;M("adapter.js shimming chrome."),x.browserShim=xp,Zp(L,U),$p(L),Hh(L,U),Kh(L),Zh(L,U),Yh(L),Qh(L,U),qh(L),zh(L),Jh(L),$h(L,U),Yp(L),qp(L),Xp(L),zp(L,U),Jp(L),Qp(L,U);break;case"firefox":if(!Vp||!np||!k.shimFirefox)return M("Firefox shim is not included in this adapter release."),x;M("adapter.js shimming firefox."),x.browserShim=Vp,Zp(L,U),$p(L),tp(L,U),np(L,U),ip(L),sp(L),rp(L),op(L),ap(L),cp(L),dp(L),lp(L),up(L),Yp(L),Xp(L),zp(L,U),Jp(L);break;case"safari":if(!Fp||!k.shimSafari)return M("Safari shim is not included in this adapter release."),x;M("adapter.js shimming safari."),x.browserShim=Fp,Zp(L,U),$p(L),Tp(L),gp(L),Ep(L),pp(L),_p(L),Sp(L),fp(L),Rp(L),Yp(L),qp(L),zp(L,U),Jp(L),Qp(L,U);break;default:M("Unsupported browser!")}}({window:"undefined"==typeof window?void 0:window});var m_=Xi("Array").keys,g_=Xn,T_=Mt,S_=j,I_=m_,C_=Array.prototype,b_={DOMTokenList:!0,NodeList:!0},w_=i((function(L){var k=L.keys;return L===C_||S_(C_,L)&&k===C_.keys||T_(b_,g_(L))?I_:k})),O_=be,N_=TypeError,D_=Ct,P_=Di,L_=B,E_=function(L,k,M){var U=D_(k);U in L?P_.f(L,U,L_(0,M)):L[U]=M},k_=xi,M_=Gi,U_=E_,x_=Array,F_=Math.max,R_=function(L,k,M){for(var U=M_(L),x=k_(k,U),V=k_(void 0===M?U:M,U),F=x_(F_(V-x,0)),j=0;x<V;x++,j++)U_(F,j,L[x]);return F.length=j,F},B_=R_,j_=Math.floor,v_=function(L,k){var M=L.length,U=j_(M/2);return M<8?y_(L,k):A_(L,v_(B_(L,0,U),k),v_(B_(L,U),k),k)},y_=function(L,k){for(var M,U,x=L.length,V=1;V<x;){for(U=V,M=L[V];U&&k(L[U-1],M)>0;)L[U]=L[--U];U!==V++&&(L[U]=M)}return L},A_=function(L,k,M,U){for(var x=k.length,V=M.length,F=0,j=0;F<x||j<V;)L[F+j]=F<x&&j<V?U(k[F],M[j])<=0?k[F++]:M[j++]:F<x?k[F++]:M[j++];return L},G_=v_,W_=He.match(/firefox\/(\d+)/i),H_=!!W_&&+W_[1],K_=/MSIE|Trident/.test(He),z_=He.match(/AppleWebKit\/(\d+)\./),Y_=!!z_&&+z_[1],q_=wi,X_=F,J_=De,Q_=Je,Z_=Gi,V_=function(L,k){if(!delete L[k])throw N_("Cannot delete property "+O_(k)+" of "+O_(L))},$_=fn,eE=n,tE=G_,iE=Bn,nE=H_,rE=K_,oE=Ze,sE=Y_,aE=[],cE=X_(aE.sort),dE=X_(aE.push),lE=eE((function(){aE.sort(void 0)})),uE=eE((function(){aE.sort(null)})),hE=iE("sort"),pE=!eE((function(){if(oE)return oE<70;if(!(nE&&nE>3)){if(rE)return!0;if(sE)return sE<603;var L,k,M,U,x="";for(L=65;L<76;L++){switch(k=String.fromCharCode(L),L){case 66:case 69:case 70:case 72:M=3;break;case 68:case 71:M=4;break;default:M=2}for(U=0;U<47;U++)aE.push({k:k+U,v:M})}for(aE.sort((function(L,k){return k.v-L.v})),U=0;U<aE.length;U++)k=aE[U].k.charAt(0),x.charAt(x.length-1)!==k&&(x+=k);return"DGBEFHACIJK"!==x}}));q_({target:"Array",proto:!0,forced:lE||!uE||!hE||!pE},{sort:function(L){void 0!==L&&J_(L);var k=Q_(this);if(pE)return void 0===L?cE(k):cE(k,L);var M,U,x=[],V=Z_(k);for(U=0;U<V;U++)U in k&&dE(x,k[U]);for(tE(x,function(L){return function(k,M){return void 0===M?-1:void 0===k?1:void 0!==L?+L(k,M)||0:$_(k)>$_(M)?1:-1}}(L)),M=Z_(x),U=0;U<M;)k[U]=x[U++];for(;U<V;)V_(k,U++);return k}});var _E=Xi("Array").sort,EE=j,fE=_E,mE=Array.prototype,gE=i((function(L){var k=L.sort;return L===mE||EE(mE,L)&&k===mE.sort?fE:k})),TE={exports:{}};!function(k,M){!function(L,U){var x="function",V="undefined",F="object",j="string",z="major",Q="model",$="name",ee="type",te="vendor",ie="version",ne="architecture",re="console",oe="mobile",ce="tablet",de="smarttv",le="wearable",ue="embedded",he="Amazon",pe="Apple",_e="ASUS",Ee="BlackBerry",fe="Browser",me="Chrome",ge="Firefox",Te="Google",Se="Huawei",Re="LG",Ie="Microsoft",ye="Motorola",Ae="Opera",Ce="Samsung",ve="Sharp",we="Sony",Oe="Xiaomi",Ne="Zebra",Pe="Facebook",Le="Chromium OS",Me="Mac OS",G=function(L){for(var k={},M=0;M<L.length;M++)k[L[M].toUpperCase()]=L[M];return k},W=function(L,k){return typeof L===j&&-1!==H(k).indexOf(H(L))},H=function(L){return L.toLowerCase()},K=function(L,k){if(typeof L===j)return L=L.replace(/^\s\s*/,""),typeof k===V?L:L.substring(0,350)},Y=function(L,k){for(var M,V,j,z,Q,$,ee=0;ee<k.length&&!Q;){var te=k[ee],ie=k[ee+1];for(M=V=0;M<te.length&&!Q&&te[M];)if(Q=te[M++].exec(L))for(j=0;j<ie.length;j++)$=Q[++V],typeof(z=ie[j])===F&&z.length>0?2===z.length?typeof z[1]==x?this[z[0]]=z[1].call(this,$):this[z[0]]=z[1]:3===z.length?typeof z[1]!==x||z[1].exec&&z[1].test?this[z[0]]=$?$.replace(z[1],z[2]):U:this[z[0]]=$?z[1].call(this,$,z[2]):U:4===z.length&&(this[z[0]]=$?z[3].call(this,$.replace(z[1],z[2])):U):this[z]=$||U;ee+=2}},q=function(L,k){for(var M in k)if(typeof k[M]===F&&k[M].length>0){for(var x=0;x<k[M].length;x++)if(W(k[M][x],L))return"?"===M?U:M}else if(W(k[M],L))return"?"===M?U:M;return L},Ue={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},xe={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[ie,[$,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[ie,[$,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[$,ie],[/opios[\/ ]+([\w\.]+)/i],[ie,[$,Ae+" Mini"]],[/\bopr\/([\w\.]+)/i],[ie,[$,Ae]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[$,ie],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[ie,[$,"UC"+fe]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[ie,[$,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[ie,[$,"WeChat"]],[/konqueror\/([\w\.]+)/i],[ie,[$,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[ie,[$,"IE"]],[/yabrowser\/([\w\.]+)/i],[ie,[$,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[$,/(.+)/,"$1 Secure "+fe],ie],[/\bfocus\/([\w\.]+)/i],[ie,[$,ge+" Focus"]],[/\bopt\/([\w\.]+)/i],[ie,[$,Ae+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[ie,[$,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[ie,[$,"Dolphin"]],[/coast\/([\w\.]+)/i],[ie,[$,Ae+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[ie,[$,"MIUI "+fe]],[/fxios\/([-\w\.]+)/i],[ie,[$,ge]],[/\bqihu|(qi?ho?o?|360)browser/i],[[$,"360 "+fe]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[$,/(.+)/,"$1 "+fe],ie],[/(comodo_dragon)\/([\w\.]+)/i],[[$,/_/g," "],ie],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[$,ie],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[$],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[$,Pe],ie],[/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[$,ie],[/\bgsa\/([\w\.]+) .*safari\//i],[ie,[$,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[ie,[$,me+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[$,me+" WebView"],ie],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[ie,[$,"Android "+fe]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[$,ie],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[ie,[$,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[ie,$],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[$,[ie,q,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[$,ie],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[$,"Netscape"],ie],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[ie,[$,ge+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[$,ie],[/(cobalt)\/([\w\.]+)/i],[$,[ie,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[ne,"amd64"]],[/(ia32(?=;))/i],[[ne,H]],[/((?:i[346]|x)86)[;\)]/i],[[ne,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[ne,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[ne,"armhf"]],[/windows (ce|mobile); ppc;/i],[[ne,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[ne,/ower/,"",H]],[/(sun4\w)[;\)]/i],[[ne,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[ne,H]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[Q,[te,Ce],[ee,ce]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[Q,[te,Ce],[ee,oe]],[/\((ip(?:hone|od)[\w ]*);/i],[Q,[te,pe],[ee,oe]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[Q,[te,pe],[ee,ce]],[/(macintosh);/i],[Q,[te,pe]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[Q,[te,ve],[ee,oe]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[Q,[te,Se],[ee,ce]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[Q,[te,Se],[ee,oe]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[Q,/_/g," "],[te,Oe],[ee,oe]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[Q,/_/g," "],[te,Oe],[ee,ce]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[Q,[te,"OPPO"],[ee,oe]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[Q,[te,"Vivo"],[ee,oe]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[Q,[te,"Realme"],[ee,oe]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[Q,[te,ye],[ee,oe]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[Q,[te,ye],[ee,ce]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[Q,[te,Re],[ee,ce]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[Q,[te,Re],[ee,oe]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[Q,[te,"Lenovo"],[ee,ce]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[Q,/_/g," "],[te,"Nokia"],[ee,oe]],[/(pixel c)\b/i],[Q,[te,Te],[ee,ce]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[Q,[te,Te],[ee,oe]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[Q,[te,we],[ee,oe]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[Q,"Xperia Tablet"],[te,we],[ee,ce]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[Q,[te,"OnePlus"],[ee,oe]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[Q,[te,he],[ee,ce]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[Q,/(.+)/g,"Fire Phone $1"],[te,he],[ee,oe]],[/(playbook);[-\w\),; ]+(rim)/i],[Q,te,[ee,ce]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[Q,[te,Ee],[ee,oe]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[Q,[te,_e],[ee,ce]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[Q,[te,_e],[ee,oe]],[/(nexus 9)/i],[Q,[te,"HTC"],[ee,ce]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[te,[Q,/_/g," "],[ee,oe]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[Q,[te,"Acer"],[ee,ce]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[Q,[te,"Meizu"],[ee,oe]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[te,Q,[ee,oe]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[te,Q,[ee,ce]],[/(surface duo)/i],[Q,[te,Ie],[ee,ce]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[Q,[te,"Fairphone"],[ee,oe]],[/(u304aa)/i],[Q,[te,"AT&T"],[ee,oe]],[/\bsie-(\w*)/i],[Q,[te,"Siemens"],[ee,oe]],[/\b(rct\w+) b/i],[Q,[te,"RCA"],[ee,ce]],[/\b(venue[\d ]{2,7}) b/i],[Q,[te,"Dell"],[ee,ce]],[/\b(q(?:mv|ta)\w+) b/i],[Q,[te,"Verizon"],[ee,ce]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[Q,[te,"Barnes & Noble"],[ee,ce]],[/\b(tm\d{3}\w+) b/i],[Q,[te,"NuVision"],[ee,ce]],[/\b(k88) b/i],[Q,[te,"ZTE"],[ee,ce]],[/\b(nx\d{3}j) b/i],[Q,[te,"ZTE"],[ee,oe]],[/\b(gen\d{3}) b.+49h/i],[Q,[te,"Swiss"],[ee,oe]],[/\b(zur\d{3}) b/i],[Q,[te,"Swiss"],[ee,ce]],[/\b((zeki)?tb.*\b) b/i],[Q,[te,"Zeki"],[ee,ce]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[te,"Dragon Touch"],Q,[ee,ce]],[/\b(ns-?\w{0,9}) b/i],[Q,[te,"Insignia"],[ee,ce]],[/\b((nxa|next)-?\w{0,9}) b/i],[Q,[te,"NextBook"],[ee,ce]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[te,"Voice"],Q,[ee,oe]],[/\b(lvtel\-)?(v1[12]) b/i],[[te,"LvTel"],Q,[ee,oe]],[/\b(ph-1) /i],[Q,[te,"Essential"],[ee,oe]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[Q,[te,"Envizen"],[ee,ce]],[/\b(trio[-\w\. ]+) b/i],[Q,[te,"MachSpeed"],[ee,ce]],[/\btu_(1491) b/i],[Q,[te,"Rotor"],[ee,ce]],[/(shield[\w ]+) b/i],[Q,[te,"Nvidia"],[ee,ce]],[/(sprint) (\w+)/i],[te,Q,[ee,oe]],[/(kin\.[onetw]{3})/i],[[Q,/\./g," "],[te,Ie],[ee,oe]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[Q,[te,Ne],[ee,ce]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[Q,[te,Ne],[ee,oe]],[/smart-tv.+(samsung)/i],[te,[ee,de]],[/hbbtv.+maple;(\d+)/i],[[Q,/^/,"SmartTV"],[te,Ce],[ee,de]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[te,Re],[ee,de]],[/(apple) ?tv/i],[te,[Q,pe+" TV"],[ee,de]],[/crkey/i],[[Q,me+"cast"],[te,Te],[ee,de]],[/droid.+aft(\w)( bui|\))/i],[Q,[te,he],[ee,de]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[Q,[te,ve],[ee,de]],[/(bravia[\w ]+)( bui|\))/i],[Q,[te,we],[ee,de]],[/(mitv-\w{5}) bui/i],[Q,[te,Oe],[ee,de]],[/Hbbtv.*(technisat) (.*);/i],[te,Q,[ee,de]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[te,K],[Q,K],[ee,de]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[ee,de]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[te,Q,[ee,re]],[/droid.+; (shield) bui/i],[Q,[te,"Nvidia"],[ee,re]],[/(playstation [345portablevi]+)/i],[Q,[te,we],[ee,re]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[Q,[te,Ie],[ee,re]],[/((pebble))app/i],[te,Q,[ee,le]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[Q,[te,pe],[ee,le]],[/droid.+; (glass) \d/i],[Q,[te,Te],[ee,le]],[/droid.+; (wt63?0{2,3})\)/i],[Q,[te,Ne],[ee,le]],[/(quest( 2| pro)?)/i],[Q,[te,Pe],[ee,le]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[te,[ee,ue]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[Q,[ee,oe]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[Q,[ee,ce]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[ee,ce]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[ee,oe]],[/(android[-\w\. ]{0,9});.+buil/i],[Q,[te,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[ie,[$,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[ie,[$,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[$,ie],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[ie,$]],os:[[/microsoft (windows) (vista|xp)/i],[$,ie],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[$,[ie,q,Ue]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[$,"Windows"],[ie,q,Ue]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[ie,/_/g,"."],[$,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[$,Me],[ie,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[ie,$],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[$,ie],[/\(bb(10);/i],[ie,[$,Ee]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[ie,[$,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[ie,[$,ge+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[ie,[$,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[ie,[$,"watchOS"]],[/crkey\/([\d\.]+)/i],[ie,[$,me+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[$,Le],ie],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[$,ie],[/(sunos) ?([\w\.\d]*)/i],[[$,"Solaris"],ie],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[$,ie]]},X=function(k,M){if(typeof k===F&&(M=k,k=U),!(this instanceof X))return new X(k,M).getResult();var re=typeof L!==V&&L.navigator?L.navigator:U,de=k||(re&&re.userAgent?re.userAgent:""),le=re&&re.userAgentData?re.userAgentData:U,ue=M?function(L,k){var M={};for(var U in L)k[U]&&k[U].length%2==0?M[U]=k[U].concat(L[U]):M[U]=L[U];return M}(xe,M):xe;return this.getBrowser=function(){var L={};return L[$]=U,L[ie]=U,Y.call(L,de,ue.browser),L[z]=function(L){return typeof L===j?L.replace(/[^\d\.]/g,"").split(".")[0]:U}(L[ie]),re&&re.brave&&typeof re.brave.isBrave==x&&(L[$]="Brave"),L},this.getCPU=function(){var L={};return L[ne]=U,Y.call(L,de,ue.cpu),L},this.getDevice=function(){var L={};return L[te]=U,L[Q]=U,L[ee]=U,Y.call(L,de,ue.device),!L[ee]&&le&&le.mobile&&(L[ee]=oe),"Macintosh"==L[Q]&&re&&typeof re.standalone!==V&&re.maxTouchPoints&&re.maxTouchPoints>2&&(L[Q]="iPad",L[ee]=ce),L},this.getEngine=function(){var L={};return L[$]=U,L[ie]=U,Y.call(L,de,ue.engine),L},this.getOS=function(){var L={};return L[$]=U,L[ie]=U,Y.call(L,de,ue.os),!L[$]&&le&&"Unknown"!=le.platform&&(L[$]=le.platform.replace(/chrome os/i,Le).replace(/macos/i,Me)),L},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return de},this.setUA=function(L){return de=typeof L===j&&L.length>350?K(L,350):L,this},this.setUA(de),this};X.VERSION="0.7.34",X.BROWSER=G([$,ie,z]),X.CPU=G([ne]),X.DEVICE=G([Q,te,ee,re,oe,de,ce,le,ue]),X.ENGINE=X.OS=G([$,ie]),k.exports&&(M=k.exports=X),M.UAParser=X;var Ve=typeof L!==V&&(L.jQuery||L.Zepto);if(Ve&&!Ve.ua){var Fe=new X;Ve.ua=Fe.getResult(),Ve.ua.get=function(){return Fe.getUA()},Ve.ua.set=function(L){Fe.setUA(L);var k=Fe.getResult();for(var M in k)Ve.ua[M]=k[M]}}}("object"==typeof window?window:L)}(TE,TE.exports);var SE=i(TE.exports),RE=Xn,IE=Mt,yE=Y,AE=hs,CE=ht("iterator"),vE=Object,bE=i((function(L){if(yE(L))return!1;var k=vE(L);return void 0!==k[CE]||"@@iterator"in k||IE(AE,RE(k))})),wE=z;wi({global:!0,forced:wE.globalThis!==wE},{globalThis:wE});var OE=i(z),NE=qd.clear;wi({global:!0,bind:!0,enumerable:!0,forced:z.clearImmediate!==NE},{clearImmediate:NE});var DE="function"==typeof Bun&&Bun&&"string"==typeof Bun.version,PE=z,LE=ie,kE=pe,ME=DE,UE=He,xE=gd,VE=Zc,FE=PE.Function,BE=/MSIE .\./.test(UE)||ME&&function(){var L=PE.Bun.version.split(".");return L.length<3||0==L[0]&&(L[1]<3||3==L[1]&&0==L[2])}(),jE=wi,WE=z,HE=qd.set,KE=WE.setImmediate?function(L,k){var M=k?2:1;return BE?function(U,x){var V=VE(arguments.length,1)>M,F=kE(U)?U:FE(U),j=V?xE(arguments,M):[],z=V?function(){LE(F,this,j)}:F;return k?L(z,x):L(z)}:L}(HE,!1):HE;jE({global:!0,bind:!0,enumerable:!0,forced:WE.setImmediate!==KE},{setImmediate:KE});var YE=i(Be.setImmediate),XE=wi,JE=Rl,QE=De,ZE=Zc,$E=wr,ef=z.process;XE({global:!0,enumerable:!0,dontCallGetSet:!0},{queueMicrotask:function(L){ZE(arguments.length,1),QE(L);var k=$E&&ef.domain;JE(k?k.bind(L):L)}});var rf=i(Be.queueMicrotask);function GE(L,k){return function(){return L.apply(k,arguments)}}const{toString:of}=Object.prototype,{getPrototypeOf:sf}=Object,af=(cf=Object.create(null),L=>{const k=of.call(L);return cf[k]||(cf[k]=k.slice(8,-1).toLowerCase())});var cf;const qE=L=>(L=L.toLowerCase(),k=>af(k)===L),zE=L=>k=>typeof k===L,{isArray:df}=Array,lf=zE("undefined"),uf=qE("ArrayBuffer"),hf=zE("string"),Ef=zE("function"),mf=zE("number"),tf=L=>null!==L&&"object"==typeof L,nf=L=>{if("object"!==af(L))return!1;const k=sf(L);return!(null!==k&&k!==Object.prototype&&null!==Object.getPrototypeOf(k)||Symbol.toStringTag in L||bE(L))},gf=qE("Date"),Tf=qE("File"),Sf=qE("Blob"),Rf=qE("FileList"),If=qE("URLSearchParams"),[yf,Af,vf,bf]=["ReadableStream","Request","Response","Headers"].map(qE);function pf(L,k){let M,U,{allOwnKeys:x=!1}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(null!=L)if("object"!=typeof L&&(L=[L]),df(L))for(M=0,U=L.length;M<U;M++)k.call(null,L[M],M,L);else{const U=x?Object.getOwnPropertyNames(L):Object.keys(L),V=U.length;let F;for(M=0;M<V;M++)F=U[M],k.call(null,L[F],F,L)}}function _f(L,k){k=k.toLowerCase();const M=Object.keys(L);let U,x=M.length;for(;x-- >0;)if(U=M[x],k===U.toLowerCase())return U;return null}const wf=void 0!==OE?OE:"undefined"!=typeof self?self:"undefined"!=typeof window?window:global,ff=L=>!lf(L)&&L!==wf,Of=(Nf="undefined"!=typeof Uint8Array&&sf(Uint8Array),L=>Nf&&L instanceof Nf);var Nf;const Df=qE("HTMLFormElement"),Pf=(L=>{let{hasOwnProperty:k}=L;return(L,M)=>k.call(L,M)})(Object.prototype),Lf=qE("RegExp"),Cf=(L,k)=>{const M=Object.getOwnPropertyDescriptors(L),U={};pf(M,((M,x)=>{let V;!1!==(V=k(M,x,L))&&(U[x]=V||M)})),Object.defineProperties(L,U)},Mf="abcdefghijklmnopqrstuvwxyz",Uf="0123456789",Bf={DIGIT:Uf,ALPHA:Mf,ALPHA_DIGIT:Mf+Mf.toUpperCase()+Uf},Hf=qE("AsyncFunction"),zf=(qf="function"==typeof YE,Xf=Ef(wf.postMessage),qf?YE:Xf?(Jf="axios@".concat(Math.random()),Qf=[],wf.addEventListener("message",(L=>{let{source:k,data:M}=L;k===wf&&M===Jf&&Qf.length&&Qf.shift()()}),!1),L=>{Qf.push(L),wf.postMessage(Jf,"*")}):L=>setTimeout(L));var qf,Xf,Jf,Qf;const Zf=void 0!==rf?rf.bind(wf):"undefined"!=typeof process&&process.nextTick||zf;var $f={isArray:df,isArrayBuffer:uf,isBuffer:function(L){return null!==L&&!lf(L)&&null!==L.constructor&&!lf(L.constructor)&&Ef(L.constructor.isBuffer)&&L.constructor.isBuffer(L)},isFormData:L=>{let k;return L&&("function"==typeof FormData&&L instanceof FormData||Ef(L.append)&&("formdata"===(k=af(L))||"object"===k&&Ef(L.toString)&&"[object FormData]"===L.toString()))},isArrayBufferView:function(L){let k;return k="undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(L):L&&L.buffer&&uf(L.buffer),k},isString:hf,isNumber:mf,isBoolean:L=>!0===L||!1===L,isObject:tf,isPlainObject:nf,isReadableStream:yf,isRequest:Af,isResponse:vf,isHeaders:bf,isUndefined:lf,isDate:gf,isFile:Tf,isBlob:Sf,isRegExp:Lf,isFunction:Ef,isStream:L=>tf(L)&&Ef(L.pipe),isURLSearchParams:If,isTypedArray:Of,isFileList:Rf,forEach:pf,merge:function e(){const{caseless:L}=ff(this)&&this||{},k={},n=(M,U)=>{const x=L&&_f(k,U)||U;nf(k[x])&&nf(M)?k[x]=e(k[x],M):nf(M)?k[x]=e({},M):df(M)?k[x]=M.slice():k[x]=M};for(let L=0,k=arguments.length;L<k;L++)arguments[L]&&pf(arguments[L],n);return k},extend:function(L,k,M){let{allOwnKeys:U}=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return pf(k,((k,U)=>{M&&Ef(k)?L[U]=GE(k,M):L[U]=k}),{allOwnKeys:U}),L},trim:L=>l_(L)?l_(L).call(L):L.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),stripBOM:L=>(65279===L.charCodeAt(0)&&(L=L.slice(1)),L),inherits:(L,k,M,U)=>{L.prototype=Object.create(k.prototype,U),L.prototype.constructor=L,Object.defineProperty(L,"super",{value:k.prototype}),M&&Object.assign(L.prototype,M)},toFlatObject:(L,k,M,U)=>{let x,V,F;const j={};if(k=k||{},null==L)return k;do{for(x=Object.getOwnPropertyNames(L),V=x.length;V-- >0;)F=x[V],U&&!U(F,L,k)||j[F]||(k[F]=L[F],j[F]=!0);L=!1!==M&&sf(L)}while(L&&(!M||M(L,k))&&L!==Object.prototype);return k},kindOf:af,kindOfTest:qE,endsWith:(L,k,M)=>{L=String(L),(void 0===M||M>L.length)&&(M=L.length),M-=k.length;const U=L.indexOf(k,M);return-1!==U&&U===M},toArray:L=>{if(!L)return null;if(df(L))return L;let k=L.length;if(!mf(k))return null;const M=new Array(k);for(;k-- >0;)M[k]=L[k];return M},forEachEntry:(L,k)=>{const M=(L&&L[Symbol.iterator]).call(L);let U;for(;(U=M.next())&&!U.done;){const M=U.value;k.call(L,M[0],M[1])}},matchAll:(L,k)=>{let M;const U=[];for(;null!==(M=L.exec(k));)U.push(M);return U},isHTMLForm:Df,hasOwnProperty:Pf,hasOwnProp:Pf,reduceDescriptors:Cf,freezeMethods:L=>{Cf(L,((k,M)=>{if(Ef(L)&&-1!==["arguments","caller","callee"].indexOf(M))return!1;const U=L[M];Ef(U)&&(k.enumerable=!1,"writable"in k?k.writable=!1:k.set||(k.set=()=>{throw Error("Can not rewrite read-only method '"+M+"'")}))}))},toObjectSet:(L,k)=>{const M={},n=L=>{L.forEach((L=>{M[L]=!0}))};return df(L)?n(L):n(String(L).split(k)),M},toCamelCase:L=>L.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,(function(L,k,M){return k.toUpperCase()+M})),noop:()=>{},toFiniteNumber:(L,k)=>null!=L&&Number.isFinite(L=+L)?L:k,findKey:_f,global:wf,isContextDefined:ff,ALPHABET:Bf,generateString:function(){let L=arguments.length>0&&void 0!==arguments[0]?arguments[0]:16,k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Bf.ALPHA_DIGIT,M="";const{length:U}=k;for(;L--;)M+=k[Math.random()*U|0];return M},isSpecCompliantForm:function(L){return!!(L&&Ef(L.append)&&"FormData"===L[Symbol.toStringTag]&&L[Symbol.iterator])},toJSONObject:L=>{const k=new Array(10),i=(L,M)=>{if(tf(L)){if(k.indexOf(L)>=0)return;if(!("toJSON"in L)){k[M]=L;const U=df(L)?[]:{};return pf(L,((L,k)=>{const x=i(L,M+1);!lf(x)&&(U[k]=x)})),k[M]=void 0,U}}return L};return i(L,0)},isAsyncFn:Hf,isThenable:L=>L&&(tf(L)||Ef(L))&&Ef(L.then)&&Ef(L.catch),setImmediate:zf,asap:Zf};function kf(L,k,M,U,x){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=(new Error).stack,this.message=L,this.name="AxiosError",k&&(this.code=k),M&&(this.config=M),U&&(this.request=U),x&&(this.response=x,this.status=x.status?x.status:null)}$f.inherits(kf,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:$f.toJSONObject(this.config),code:this.code,status:this.status}}});const em=kf.prototype,tm={};function xf(L){return $f.isPlainObject(L)||$f.isArray(L)}function Vf(L){return $f.endsWith(L,"[]")?L.slice(0,-2):L}function Ff(L,k,M){return L?L.concat(k).map((function(L,k){return L=Vf(L),!M&&k?"["+L+"]":L})).join(M?".":""):k}["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach((L=>{tm[L]={value:L}})),Object.defineProperties(kf,tm),Object.defineProperty(em,"isAxiosError",{value:!0}),kf.from=(L,k,M,U,x,V)=>{const F=Object.create(em);return $f.toFlatObject(L,F,(function(L){return L!==Error.prototype}),(L=>"isAxiosError"!==L)),kf.call(F,L.message,k,M,U,x),F.cause=L,F.name=L.name,V&&Object.assign(F,V),F};const im=$f.toFlatObject($f,{},null,(function(L){return/^is[A-Z]/.test(L)}));function jf(L,k,M){if(!$f.isObject(L))throw new TypeError("target must be an object");k=k||new FormData;const U=(M=$f.toFlatObject(M,{metaTokens:!0,dots:!1,indexes:!1},!1,(function(L,k){return!$f.isUndefined(k[L])}))).metaTokens,x=M.visitor||d,V=M.dots,F=M.indexes,j=(M.Blob||"undefined"!=typeof Blob&&Blob)&&$f.isSpecCompliantForm(k);if(!$f.isFunction(x))throw new TypeError("visitor must be a function");function c(L){if(null===L)return"";if($f.isDate(L))return L.toISOString();if(!j&&$f.isBlob(L))throw new kf("Blob is not supported. Use a Buffer instead.");return $f.isArrayBuffer(L)||$f.isTypedArray(L)?j&&"function"==typeof Blob?new Blob([L]):Buffer.from(L):L}function d(L,M,x){let j=L;if(L&&!x&&"object"==typeof L)if($f.endsWith(M,"{}"))M=U?M:M.slice(0,-2),L=JSON.stringify(L);else if($f.isArray(L)&&function(L){return $f.isArray(L)&&!L.some(xf)}(L)||($f.isFileList(L)||$f.endsWith(M,"[]"))&&(j=$f.toArray(L)))return M=Vf(M),j.forEach((function(L,U){!$f.isUndefined(L)&&null!==L&&k.append(!0===F?Ff([M],U,V):null===F?M:M+"[]",c(L))})),!1;return!!xf(L)||(k.append(Ff(x,M,V),c(L)),!1)}const z=[],Q=Object.assign(im,{defaultVisitor:d,convertValue:c,isVisitable:xf});if(!$f.isObject(L))throw new TypeError("data must be an object");return function e(L,M){if(!$f.isUndefined(L)){if(-1!==z.indexOf(L))throw Error("Circular reference detected in "+M.join("."));z.push(L),$f.forEach(L,(function(L,U){!0===(!($f.isUndefined(L)||null===L)&&x.call(k,L,$f.isString(U)?l_(U).call(U):U,M,Q))&&e(L,M?M.concat(U):[U])})),z.pop()}}(L),k}function Gf(L){const k={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(L).replace(/[!'()~]|%20|%00/g,(function(L){return k[L]}))}function Wf(L,k){this._pairs=[],L&&jf(L,this,k)}const nm=Wf.prototype;function Kf(L){return encodeURIComponent(L).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function Yf(L,k,M){if(!k)return L;const U=M&&M.encode||Kf,x=M&&M.serialize;let V;if(V=x?x(k,M):$f.isURLSearchParams(k)?k.toString():new Wf(k,M).toString(U),V){const k=L.indexOf("#");-1!==k&&(L=L.slice(0,k)),L+=(-1===L.indexOf("?")?"?":"&")+V}return L}nm.append=function(L,k){this._pairs.push([L,k])},nm.toString=function(L){const k=L?function(k){return L.call(this,k,Gf)}:Gf;return this._pairs.map((function(L){return k(L[0])+"="+k(L[1])}),"").join("&")};var rm=class{constructor(){this.handlers=[]}use(L,k,M){return this.handlers.push({fulfilled:L,rejected:k,synchronous:!!M&&M.synchronous,runWhen:M?M.runWhen:null}),this.handlers.length-1}eject(L){this.handlers[L]&&(this.handlers[L]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(L){$f.forEach(this.handlers,(function(k){null!==k&&L(k)}))}},om={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},sm={exports:{}},am=wi,cm=Ee,dm=Di.f;am({target:"Object",stat:!0,forced:Object.defineProperty!==dm,sham:!cm},{defineProperty:dm});var lm=Be.Object,hm=sm.exports=function(L,k,M){return lm.defineProperty(L,k,M)};lm.defineProperty.sham&&(hm.sham=!0);var pm=i(sm.exports),_m=R,fm=Array.isArray||function(L){return"Array"==_m(L)},mm=TypeError,gm=fm,Tm=ud,Sm=Fe,Rm=ht("species"),Im=Array,um=function(L,k){return new(function(L){var k;return gm(L)&&(k=L.constructor,(Tm(k)&&(k===Im||gm(k.prototype))||Sm(k)&&null===(k=k[Rm]))&&(k=void 0)),void 0===k?Im:k}(L))(0===k?0:k)},ym=n,Am=Ze,vm=ht("species"),Em=function(L){return Am>=51||!ym((function(){var k=[];return(k.constructor={})[vm]=function(){return{foo:1}},1!==k[L](Boolean).foo}))},bm=wi,wm=n,Nm=fm,Dm=Fe,Pm=Je,Lm=Gi,Cm=function(L){if(L>9007199254740991)throw mm("Maximum allowed index exceeded");return L},km=E_,Mm=um,Um=Em,xm=Ze,Vm=ht("isConcatSpreadable"),Fm=xm>=51||!wm((function(){var L=[];return L[Vm]=!1,L.concat()[0]!==L})),Om=function(L){if(!Dm(L))return!1;var k=L[Vm];return void 0!==k?!!k:Nm(L)};bm({target:"Array",proto:!0,arity:1,forced:!Fm||!Um("concat")},{concat:function(L){var k,M,U,x,V,F=Pm(this),j=Mm(F,0),z=0;for(k=-1,U=arguments.length;k<U;k++)if(Om(V=-1===k?F:arguments[k]))for(x=Lm(V),Cm(z+x),M=0;M<x;M++,z++)M in V&&km(j,z,V[M]);else Cm(z+1),km(j,z++,V);return j.length=z,j}});var Bm={},jm=R,Wm=Z,Hm=io.f,Km=R_,zm="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];Bm.f=function(L){return zm&&"Window"==jm(L)?function(L){try{return Hm(L)}catch(L){return Km(zm)}}(L):Hm(Wm(L))};var Ym={},Xm=ht;Ym.f=Xm;var Jm=Be,Qm=Mt,Zm=Ym,$m=Di.f,Gm=function(L){var k=Jm.Symbol||(Jm.Symbol={});Qm(k,L)||$m(k,L,{value:Zm.f(L)})},tg=ge,ig=ae,ng=ht,rg=ha,qm=function(){var L=ig("Symbol"),k=L&&L.prototype,M=k&&k.valueOf,U=ng("toPrimitive");k&&!k[U]&&rg(k,U,(function(L){return tg(M,this)}),{arity:1})},og=Xt,sg=Ne,ag=Je,cg=Gi,dg=um,lg=F([].push),eT=function(L){var k=1==L,M=2==L,U=3==L,x=4==L,V=6==L,F=7==L,j=5==L||V;return function(z,Q,$,ee){for(var te,ie,ne=ag(z),re=sg(ne),oe=og(Q,$),ce=cg(re),de=0,le=ee||dg,ue=k?le(z,ce):M||F?le(z,0):void 0;ce>de;de++)if((j||de in re)&&(ie=oe(te=re[de],de,ne),L))if(k)ue[de]=ie;else if(ie)switch(L){case 3:return!0;case 5:return te;case 6:return de;case 2:lg(ue,te)}else switch(L){case 4:return!1;case 7:lg(ue,te)}return V?-1:U||x?x:ue}},ug={forEach:eT(0),map:eT(1),filter:eT(2),some:eT(3),every:eT(4),find:eT(5),findIndex:eT(6),filterReject:eT(7)},hg=wi,pg=z,_g=ge,Eg=F,fg=Ee,mg=it,gg=n,Tg=Mt,Sg=j,Rg=ii,Ig=Z,yg=Ct,Ag=fn,Cg=B,vg=Qo,bg=Do,wg=io,Og=Bm,Ng=po,Pg=_e,Lg=Di,Mg=wo,Vg=Te,Fg=ha,Bg=hc,jg=Nt,Gg=no,Wg=nt,Hg=ht,Kg=Ym,zg=Gm,Yg=qm,qg=Da,Xg=Oa,Jg=ug.forEach,Qg=lr("hidden"),Zg="Symbol",$g="prototype",tT=Xg.set,iT=Xg.getterFor(Zg),nT=Object[$g],rT=pg.Symbol,oT=rT&&rT[$g],sT=pg.TypeError,aT=pg.QObject,cT=Pg.f,dT=Lg.f,lT=Og.f,uT=Vg.f,hT=Eg([].push),pT=jg("symbols"),_T=jg("op-symbols"),ET=jg("wks"),fT=!aT||!aT[$g]||!aT[$g].findChild,mT=fg&&gg((function(){return 7!=vg(dT({},"a",{get:function(){return dT(this,"a",{value:7}).a}})).a}))?function(L,k,M){var U=cT(nT,k);U&&delete nT[k],dT(L,k,M),U&&L!==nT&&dT(nT,k,U)}:dT,nS=function(L,k){var M=pT[L]=vg(oT);return tT(M,{type:Zg,tag:L,description:k}),fg||(M.description=k),M},rS=function(L,k,M){L===nT&&rS(_T,k,M),Rg(L);var U=yg(k);return Rg(M),Tg(pT,U)?(M.enumerable?(Tg(L,Qg)&&L[Qg][U]&&(L[Qg][U]=!1),M=vg(M,{enumerable:Cg(0,!1)})):(Tg(L,Qg)||dT(L,Qg,Cg(1,{})),L[Qg][U]=!0),mT(L,U,M)):dT(L,U,M)},oS=function(L,k){Rg(L);var M=Ig(k),U=bg(M).concat(dS(M));return Jg(U,(function(k){fg&&!_g(sS,M,k)||rS(L,k,M[k])})),L},sS=function(L){var k=yg(L),M=_g(uT,this,k);return!(this===nT&&Tg(pT,k)&&!Tg(_T,k))&&(!(M||!Tg(this,k)||!Tg(pT,k)||Tg(this,Qg)&&this[Qg][k])||M)},aS=function(L,k){var M=Ig(L),U=yg(k);if(M!==nT||!Tg(pT,U)||Tg(_T,U)){var x=cT(M,U);return!x||!Tg(pT,U)||Tg(M,Qg)&&M[Qg][U]||(x.enumerable=!0),x}},cS=function(L){var k=lT(Ig(L)),M=[];return Jg(k,(function(L){Tg(pT,L)||Tg(Gg,L)||hT(M,L)})),M},dS=function(L){var k=L===nT,M=lT(k?_T:Ig(L)),U=[];return Jg(M,(function(L){!Tg(pT,L)||k&&!Tg(nT,L)||hT(U,pT[L])})),U};mg||(rT=function(){if(Sg(oT,this))throw sT("Symbol is not a constructor");var L=arguments.length&&void 0!==arguments[0]?Ag(arguments[0]):void 0,k=Wg(L),i=function(L){this===nT&&_g(i,_T,L),Tg(this,Qg)&&Tg(this[Qg],k)&&(this[Qg][k]=!1),mT(this,k,Cg(1,L))};return fg&&fT&&mT(nT,k,{configurable:!0,set:i}),nS(k,L)},Fg(oT=rT[$g],"toString",(function(){return iT(this).tag})),Fg(rT,"withoutSetter",(function(L){return nS(Wg(L),L)})),Vg.f=sS,Lg.f=rS,Mg.f=oS,Pg.f=aS,wg.f=Og.f=cS,Ng.f=dS,Kg.f=function(L){return nS(Hg(L),L)},fg&&Bg(oT,"description",{configurable:!0,get:function(){return iT(this).description}})),hg({global:!0,constructor:!0,wrap:!0,forced:!mg,sham:!mg},{Symbol:rT}),Jg(bg(ET),(function(L){zg(L)})),hg({target:Zg,stat:!0,forced:!mg},{useSetter:function(){fT=!0},useSimple:function(){fT=!1}}),hg({target:"Object",stat:!0,forced:!mg,sham:!fg},{create:function(L,k){return void 0===k?vg(L):oS(vg(L),k)},defineProperty:rS,defineProperties:oS,getOwnPropertyDescriptor:aS}),hg({target:"Object",stat:!0,forced:!mg},{getOwnPropertyNames:cS}),Yg(),qg(rT,Zg),Gg[Qg]=!0;var gT=it&&!!Symbol.for&&!!Symbol.keyFor,TT=wi,ST=ae,RT=Mt,IT=fn,yT=Nt,AT=gT,CT=yT("string-to-symbol-registry"),vT=yT("symbol-to-string-registry");TT({target:"Symbol",stat:!0,forced:!AT},{for:function(L){var k=IT(L);if(RT(CT,k))return CT[k];var M=ST("Symbol")(k);return CT[k]=M,vT[M]=k,M}});var bT=wi,wT=Mt,OT=dt,NT=be,DT=gT,PT=Nt("symbol-to-string-registry");bT({target:"Symbol",stat:!0,forced:!DT},{keyFor:function(L){if(!OT(L))throw TypeError(NT(L)+" is not a symbol");if(wT(PT,L))return PT[L]}});var LT=fm,kT=pe,MT=R,UT=fn,xT=F([].push),VT=wi,FT=ae,BT=ie,jT=ge,GT=F,WT=n,HT=pe,KT=dt,zT=gd,FS=function(L){if(kT(L))return L;if(LT(L)){for(var k=L.length,M=[],U=0;U<k;U++){var x=L[U];"string"==typeof x?xT(M,x):"number"!=typeof x&&"Number"!=MT(x)&&"String"!=MT(x)||xT(M,UT(x))}var V=M.length,F=!0;return function(L,k){if(F)return F=!1,k;if(LT(this))return k;for(var U=0;U<V;U++)if(M[U]===L)return k}}},YT=it,qT=String,XT=FT("JSON","stringify"),JT=GT(/./.exec),QT=GT("".charAt),ZT=GT("".charCodeAt),$T=GT("".replace),eS=GT(1..toString),tS=/[\uD800-\uDFFF]/g,iS=/^[\uD800-\uDBFF]$/,lS=/^[\uDC00-\uDFFF]$/,uS=!YT||WT((function(){var L=FT("Symbol")();return"[null]"!=XT([L])||"{}"!=XT({a:L})||"{}"!=XT(Object(L))})),hS=WT((function(){return'"\\udf06\\ud834"'!==XT("\udf06\ud834")||'"\\udead"'!==XT("\udead")})),$S=function(L,k){var M=zT(arguments),U=FS(k);if(HT(U)||void 0!==L&&!KT(L))return M[1]=function(L,k){if(HT(U)&&(k=jT(U,this,qT(L),k)),!KT(k))return k},BT(XT,null,M)},eg=function(L,k,M){var U=QT(M,k-1),x=QT(M,k+1);return JT(iS,L)&&!JT(lS,x)||JT(lS,L)&&!JT(iS,U)?"\\u"+eS(ZT(L,0),16):L};XT&&VT({target:"JSON",stat:!0,arity:3,forced:uS||hS},{stringify:function(L,k,M){var U=zT(arguments),x=BT(uS?$S:XT,null,U);return hS&&"string"==typeof x?$T(x,tS,eg):x}});var pS=po,_S=Je;wi({target:"Object",stat:!0,forced:!it||n((function(){pS.f(1)}))},{getOwnPropertySymbols:function(L){var k=pS.f;return k?k(_S(L)):[]}}),Gm("asyncIterator"),Gm("hasInstance"),Gm("isConcatSpreadable"),Gm("iterator"),Gm("match"),Gm("matchAll"),Gm("replace"),Gm("search"),Gm("species"),Gm("split");var ES=qm;Gm("toPrimitive"),ES();var fS=ae,mS=Da;Gm("toStringTag"),mS(fS("Symbol"),"Symbol"),Gm("unscopables"),Da(z.JSON,"JSON",!0);var gS=Be.Symbol,TS=ht,SS=Di.f,RS=TS("metadata"),IS=Function.prototype;void 0===IS[RS]&&SS(IS,RS,{value:null}),Gm("dispose"),Gm("metadata");var yS=gS;Gm("asyncDispose");var AS=F,CS=ae("Symbol"),vS=CS.keyFor,bS=AS(CS.prototype.valueOf),wS=CS.isRegisteredSymbol||function(L){try{return void 0!==vS(bS(L))}catch(L){return!1}};wi({target:"Symbol",stat:!0},{isRegisteredSymbol:wS});for(var OS=Nt,NS=ae,DS=F,PS=dt,LS=ht,kS=NS("Symbol"),MS=kS.isWellKnownSymbol,US=NS("Object","getOwnPropertyNames"),xS=DS(kS.prototype.valueOf),VS=OS("wks"),BS=0,jS=US(kS),GS=jS.length;BS<GS;BS++)try{var WS=jS[BS];PS(kS[WS])&&LS(WS)}catch(e){}var Dg=function(L){if(MS&&MS(L))return!0;try{for(var k=xS(L),M=0,U=US(VS),x=U.length;M<x;M++)if(VS[U[M]]==k)return!0}catch(L){}return!1};wi({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:Dg}),Gm("matcher"),Gm("observable"),wi({target:"Symbol",stat:!0,name:"isRegisteredSymbol"},{isRegistered:wS}),wi({target:"Symbol",stat:!0,name:"isWellKnownSymbol",forced:!0},{isWellKnown:Dg}),Gm("metadataKey"),Gm("patternMatch"),Gm("replaceAll");var HS=i(yS),KS=i(Ym.f("iterator"));function kg(L){return kg="function"==typeof HS&&"symbol"==typeof KS?function(L){return typeof L}:function(L){return L&&"function"==typeof HS&&L.constructor===HS&&L!==HS.prototype?"symbol":typeof L},kg(L)}var zS=i(Ym.f("toPrimitive"));function xg(L,k,M){return(k=function Ug(L){var k=function(L,k){if("object"!==kg(L)||null===L)return L;var M=L[zS];if(void 0!==M){var U=M.call(L,k);if("object"!==kg(U))return U;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(L)}(L,"string");return"symbol"===kg(k)?k:String(k)}(k))in L?pm(L,k,{value:M,enumerable:!0,configurable:!0,writable:!0}):L[k]=M,L}var YS=n,qS=ht("iterator"),XS=!YS((function(){var L=new URL("b?a=1&b=2&c=3","http://a"),k=L.searchParams,M=new URLSearchParams("a=1&a=2"),U="";return L.pathname="c%20d",k.forEach((function(L,M){k.delete("b"),U+=M+L})),M.delete("a",2),!L.toJSON||!M.has("a",1)||M.has("a",2)||!k.size&&!0||!k.sort||"http://a/c%20d?a=1&c=3"!==L.href||"3"!==k.get("c")||"a=1"!==String(new URLSearchParams("?a=1"))||!k[qS]||"a"!==new URL("https://a@b").username||"b"!==new URLSearchParams(new URLSearchParams("a=b")).get("a")||"xn--e1aybc"!==new URL("http://ÑÐµÑÑ").host||"#%D0%B1"!==new URL("http://a#Ð±").hash||"a1c3"!==U||"x"!==new URL("http://x",void 0).host})),JS=ha,QS=wi,ZS=z,eR=ge,tR=F,iR=Ee,nR=XS,rR=ha,oR=hc,sR=Da,aR=Va,cR=Oa,dR=Sc,lR=pe,uR=Mt,hR=Xt,pR=Xn,_R=ii,ER=Fe,fR=fn,mR=Qo,gR=B,TR=es,SR=qo,IR=Zc,yR=G_,AR=ht("iterator"),CR="URLSearchParams",vR=CR+"Iterator",bR=cR.set,wR=cR.getterFor(CR),OR=cR.getterFor(vR),NR=Object.getOwnPropertyDescriptor,RR=function(L){if(!iR)return ZS[L];var k=NR(ZS,L);return k&&k.value},DR=RR("fetch"),PR=RR("Request"),LR=RR("Headers"),kR=PR&&PR.prototype,MR=LR&&LR.prototype,UR=ZS.RegExp,xR=ZS.TypeError,VR=ZS.decodeURIComponent,FR=ZS.encodeURIComponent,BR=tR("".charAt),HR=tR([].join),KR=tR([].push),zR=tR("".replace),QR=tR([].shift),ZR=tR([].splice),$R=tR("".split),eI=tR("".slice),tI=/\+/g,nI=Array(4),jR=function(L){return nI[L-1]||(nI[L-1]=UR("((?:%[\\da-f]{2}){"+L+"})","gi"))},GR=function(L){try{return VR(L)}catch(k){return L}},WR=function(L){var k=zR(L,tI," "),M=4;try{return VR(k)}catch(L){for(;M;)k=zR(k,jR(M--),GR);return k}},rI=/[!'()~]|%20/g,oI={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},YR=function(L){return oI[L]},qR=function(L){return zR(FR(L),rI,YR)},sI=aR((function(L,k){bR(this,{type:vR,iterator:TR(wR(L).entries),kind:k})}),"Iterator",(function(){var L=OR(this),k=L.kind,M=L.iterator.next(),U=M.value;return M.done||(M.value="keys"===k?U.key:"values"===k?U.value:[U.key,U.value]),M}),!0),JR=function(L){this.entries=[],this.url=null,void 0!==L&&(ER(L)?this.parseObject(L):this.parseQuery("string"==typeof L?"?"===BR(L,0)?eI(L,1):L:fR(L)))};JR.prototype={type:CR,bindURL:function(L){this.url=L,this.update()},parseObject:function(L){var k,M,U,x,V,F,j,z=SR(L);if(z)for(M=(k=TR(L,z)).next;!(U=eR(M,k)).done;){if(V=(x=TR(_R(U.value))).next,(F=eR(V,x)).done||(j=eR(V,x)).done||!eR(V,x).done)throw xR("Expected sequence with length 2");KR(this.entries,{key:fR(F.value),value:fR(j.value)})}else for(var Q in L)uR(L,Q)&&KR(this.entries,{key:Q,value:fR(L[Q])})},parseQuery:function(L){if(L)for(var k,M,U=$R(L,"&"),x=0;x<U.length;)(k=U[x++]).length&&(M=$R(k,"="),KR(this.entries,{key:WR(QR(M)),value:WR(HR(M,"="))}))},serialize:function(){for(var L,k=this.entries,M=[],U=0;U<k.length;)L=k[U++],KR(M,qR(L.key)+"="+qR(L.value));return HR(M,"&")},update:function(){this.entries.length=0,this.parseQuery(this.url.query)},updateURL:function(){this.url&&this.url.update()}};var XR=function(){dR(this,aI);var L=bR(this,new JR(arguments.length>0?arguments[0]:void 0));iR||(this.size=L.entries.length)},aI=XR.prototype;if(function(L,k,M){for(var U in k)M&&M.unsafe&&L[U]?L[U]=k[U]:JS(L,U,k[U],M)}(aI,{append:function(L,k){var M=wR(this);IR(arguments.length,2),KR(M.entries,{key:fR(L),value:fR(k)}),iR||this.length++,M.updateURL()},delete:function(L){for(var k=wR(this),M=IR(arguments.length,1),U=k.entries,x=fR(L),V=M<2?void 0:arguments[1],F=void 0===V?V:fR(V),j=0;j<U.length;){var z=U[j];if(z.key!==x||void 0!==F&&z.value!==F)j++;else if(ZR(U,j,1),void 0!==F)break}iR||(this.size=U.length),k.updateURL()},get:function(L){var k=wR(this).entries;IR(arguments.length,1);for(var M=fR(L),U=0;U<k.length;U++)if(k[U].key===M)return k[U].value;return null},getAll:function(L){var k=wR(this).entries;IR(arguments.length,1);for(var M=fR(L),U=[],x=0;x<k.length;x++)k[x].key===M&&KR(U,k[x].value);return U},has:function(L){for(var k=wR(this).entries,M=IR(arguments.length,1),U=fR(L),x=M<2?void 0:arguments[1],V=void 0===x?x:fR(x),F=0;F<k.length;){var j=k[F++];if(j.key===U&&(void 0===V||j.value===V))return!0}return!1},set:function(L,k){var M=wR(this);IR(arguments.length,1);for(var U,x=M.entries,V=!1,F=fR(L),j=fR(k),z=0;z<x.length;z++)(U=x[z]).key===F&&(V?ZR(x,z--,1):(V=!0,U.value=j));V||KR(x,{key:F,value:j}),iR||(this.size=x.length),M.updateURL()},sort:function(){var L=wR(this);yR(L.entries,(function(L,k){return L.key>k.key?1:-1})),L.updateURL()},forEach:function(L){for(var k,M=wR(this).entries,U=hR(L,arguments.length>1?arguments[1]:void 0),x=0;x<M.length;)U((k=M[x++]).value,k.key,this)},keys:function(){return new sI(this,"keys")},values:function(){return new sI(this,"values")},entries:function(){return new sI(this,"entries")}},{enumerable:!0}),rR(aI,AR,aI.entries,{name:"entries"}),rR(aI,"toString",(function(){return wR(this).serialize()}),{enumerable:!0}),iR&&oR(aI,"size",{get:function(){return wR(this).entries.length},configurable:!0,enumerable:!0}),sR(XR,CR),QS({global:!0,constructor:!0,forced:!nR},{URLSearchParams:XR}),!nR&&lR(LR)){var cI=tR(MR.has),lI=tR(MR.set),eC=function(L){if(ER(L)){var k,M=L.body;if(pR(M)===CR)return k=L.headers?new LR(L.headers):new LR,cI(k,"content-type")||lI(k,"content-type","application/x-www-form-urlencoded;charset=UTF-8"),mR(L,{body:gR(0,fR(M)),headers:gR(0,k)})}return L};if(lR(DR)&&QS({global:!0,enumerable:!0,dontCallGetSet:!0,forced:!0},{fetch:function(L){return DR(L,arguments.length>1?eC(arguments[1]):{})}}),lR(PR)){var tC=function(L){return dR(this,kR),new PR(L,arguments.length>1?eC(arguments[1]):{})};kR.constructor=tC,tC.prototype=kR,QS({global:!0,constructor:!0,dontCallGetSet:!0,forced:!0},{Request:tC})}}var uI={URLSearchParams:XR,getState:wR},hI=i(Be.URLSearchParams),pI={isBrowser:!0,classes:{URLSearchParams:void 0!==hI?hI:Wf,FormData:"undefined"!=typeof FormData?FormData:null,Blob:"undefined"!=typeof Blob?Blob:null},protocols:["http","https","file","blob","url","data"]};const TI="undefined"!=typeof window&&"undefined"!=typeof document,AI="object"==typeof navigator&&navigator||void 0,bI=TI&&(!AI||["ReactNative","NativeScript","NS"].indexOf(AI.product)<0),LI="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope&&"function"==typeof self.importScripts,MI=TI&&window.location.href||"http://localhost";function lC(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function uC(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?lC(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):lC(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}var UI=uC(uC({},Object.freeze({__proto__:null,hasBrowserEnv:TI,hasStandardBrowserEnv:bI,hasStandardBrowserWebWorkerEnv:LI,navigator:AI,origin:MI})),pI),xI=ii,VI=ge,FI=Mt,BI=j,mC=function(){var L=xI(this),k="";return L.hasIndices&&(k+="d"),L.global&&(k+="g"),L.ignoreCase&&(k+="i"),L.multiline&&(k+="m"),L.dotAll&&(k+="s"),L.unicode&&(k+="u"),L.unicodeSets&&(k+="v"),L.sticky&&(k+="y"),k},jI=RegExp.prototype,SC=function(L){var k=L.flags;return void 0!==k||"flags"in jI||FI(L,"flags")||!BI(jI,L)?k:VI(mC,L)},qI=Fh.charAt,QI=ge,ZI=ii,gy=pe,Sy=R,Oy=/./.exec,Ny=TypeError,Dy=wi,Uy=ge,Vy=v,Fy=Va,jy=ic,Gy=J,zy=Bi,Yy=fn,qy=ii,Jy=Y,eA=R,sA=tn,gA=SC,SA=ke,AA=n,bA=Jc,wA=Oa,NA=ht("matchAll"),kA="RegExp String",MA=kA+" Iterator",UA=wA.set,BA=wA.getterFor(MA),jA=TypeError,GA=Vy("".indexOf),WA=Vy("".matchAll),HA=!!WA&&!AA((function(){WA("a",/./)})),KA=Fy((function(L,k,M,U){UA(this,{type:MA,regexp:L,string:k,global:M,unicode:U,done:!1})}),kA,(function(){var L=BA(this);if(L.done)return jy(void 0,!0);var k=L.regexp,M=L.string,U=function(L,k){var M=L.exec;if(gy(M)){var U=QI(M,L,k);return null!==U&&ZI(U),U}if("RegExp"===Sy(L))return QI(Oy,L,k);throw Ny("RegExp#exec called on incompatible receiver")}(k,M);return null===U?(L.done=!0,jy(void 0,!0)):L.global?(""===Yy(U[0])&&(k.lastIndex=function(L,k,M){return k+(M?qI(L,k).length:1)}(M,zy(k.lastIndex),L.unicode)),jy(U,!1)):(L.done=!0,jy(U,!1))})),iI=function(L){var k,M,U,x=qy(this),V=Yy(L),F=bA(x,RegExp),j=Yy(gA(x));return k=new F(F===RegExp?x.source:x,j),M=!!~GA(j,"g"),U=!!~GA(j,"u"),k.lastIndex=zy(x.lastIndex),new KA(k,V,M,U)};Dy({target:"String",proto:!0,forced:HA},{matchAll:function(L){var k,M,U,x,V=Gy(this);if(Jy(L)){if(HA)return WA(V,L)}else{if(sA(L)&&(k=Yy(Gy(gA(L))),!~GA(k,"g")))throw jA("`.matchAll` does not allow non-global regexes");if(HA)return WA(V,L);if(void 0===(U=SA(L,NA))&&"RegExp"==eA(L)&&(U=iI),U)return Uy(U,L,V)}return M=Yy(V),x=new RegExp(L,"g"),Uy(iI,x,M)}});var YA=Xi("String").matchAll,XA=j,JA=YA,ZA=String.prototype,$A=i((function(L){var k=L.matchAll;return"string"==typeof L||L===ZA||XA(ZA,L)&&k===ZA.matchAll?JA:k}));function dI(L){function t(L,k,M,U){let x=L[U++];if("__proto__"===x)return!0;const V=Number.isFinite(+x),F=U>=L.length;return x=!x&&$f.isArray(M)?M.length:x,F?($f.hasOwnProp(M,x)?M[x]=[M[x],k]:M[x]=k,!V):(M[x]&&$f.isObject(M[x])||(M[x]=[]),t(L,k,M[x],U)&&$f.isArray(M[x])&&(M[x]=function(L){const k={},M=Object.keys(L);let U;const x=M.length;let V;for(U=0;U<x;U++)V=M[U],k[V]=L[V];return k}(M[x])),!V)}if($f.isFormData(L)&&$f.isFunction(L.entries)){const k={};return $f.forEachEntry(L,((L,M)=>{t(function(L){return $A($f).call($f,/\w+|\[(\w*)]/g,L).map((L=>"[]"===L[0]?"":L[1]||L[0]))}(L),M,k,0)})),k}return null}const iC={transitional:om,adapter:["xhr","http","fetch"],transformRequest:[function(L,k){const M=k.getContentType()||"",U=M.indexOf("application/json")>-1,x=$f.isObject(L);if(x&&$f.isHTMLForm(L)&&(L=new FormData(L)),$f.isFormData(L))return U?JSON.stringify(dI(L)):L;if($f.isArrayBuffer(L)||$f.isBuffer(L)||$f.isStream(L)||$f.isFile(L)||$f.isBlob(L)||$f.isReadableStream(L))return L;if($f.isArrayBufferView(L))return L.buffer;if($f.isURLSearchParams(L))return k.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),L.toString();let V;if(x){if(M.indexOf("application/x-www-form-urlencoded")>-1)return function(L,k){return jf(L,new UI.classes.URLSearchParams,Object.assign({visitor:function(L,k,M,U){return UI.isNode&&$f.isBuffer(L)?(this.append(k,L.toString("base64")),!1):U.defaultVisitor.apply(this,arguments)}},k))}(L,this.formSerializer).toString();if((V=$f.isFileList(L))||M.indexOf("multipart/form-data")>-1){const k=this.env&&this.env.FormData;return jf(V?{"files[]":L}:L,k&&new k,this.formSerializer)}}return x||U?(k.setContentType("application/json",!1),function(L,k,M){if($f.isString(L))try{return(0,JSON.parse)(L),l_($f).call($f,L)}catch(L){if("SyntaxError"!==L.name)throw L}return(0,JSON.stringify)(L)}(L)):L}],transformResponse:[function(L){const k=this.transitional||iC.transitional,M=k&&k.forcedJSONParsing,U="json"===this.responseType;if($f.isResponse(L)||$f.isReadableStream(L))return L;if(L&&$f.isString(L)&&(M&&!this.responseType||U)){const M=!(k&&k.silentJSONParsing)&&U;try{return JSON.parse(L)}catch(L){if(M){if("SyntaxError"===L.name)throw kf.from(L,kf.ERR_BAD_RESPONSE,this,null,this.response);throw L}}}return L}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:UI.classes.FormData,Blob:UI.classes.Blob},validateStatus:function(L){return L>=200&&L<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};$f.forEach(["delete","get","head","post","put","patch"],(L=>{iC.headers[L]={}}));var nC=iC;const rC=$f.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),oC=Symbol("internals");function _I(L){var k;return L&&l_(k=String(L)).call(k).toLowerCase()}function EI(L){return!1===L||null==L?L:$f.isArray(L)?L.map(EI):String(L)}function fI(L,k,M,U,x){return $f.isFunction(U)?U.call(this,k,M):(x&&(k=M),$f.isString(k)?$f.isString(U)?-1!==k.indexOf(U):$f.isRegExp(U)?U.test(k):void 0:void 0)}class mI{constructor(L){L&&this.set(L)}set(L,k,M){const U=this;function r(L,k,M){const x=_I(k);if(!x)throw new Error("header name must be a non-empty string");const V=$f.findKey(U,x);(!V||void 0===U[V]||!0===M||void 0===M&&!1!==U[V])&&(U[V||k]=EI(L))}const o=(L,k)=>$f.forEach(L,((L,M)=>r(L,M,k)));if($f.isPlainObject(L)||L instanceof this.constructor)o(L,k);else if($f.isString(L)&&(L=l_(L).call(L))&&!/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(l_(x=L).call(x)))o((L=>{const k={};let M,U,x;return L&&L.split("\n").forEach((function(L){var V,F;x=L.indexOf(":"),M=l_(V=L.substring(0,x)).call(V).toLowerCase(),U=l_(F=L.substring(x+1)).call(F),!M||k[M]&&rC[M]||("set-cookie"===M?k[M]?k[M].push(U):k[M]=[U]:k[M]=k[M]?k[M]+", "+U:U)})),k})(L),k);else if($f.isHeaders(L))for(const[k,U]of L.entries())r(U,k,M);else null!=L&&r(k,L,M);var x;return this}get(L,k){if(L=_I(L)){const M=$f.findKey(this,L);if(M){const L=this[M];if(!k)return L;if(!0===k)return function(L){const k=Object.create(null),M=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let U;for(;U=M.exec(L);)k[U[1]]=U[2];return k}(L);if($f.isFunction(k))return k.call(this,L,M);if($f.isRegExp(k))return k.exec(L);throw new TypeError("parser must be boolean|regexp|function")}}}has(L,k){if(L=_I(L)){const M=$f.findKey(this,L);return!(!M||void 0===this[M]||k&&!fI(0,this[M],M,k))}return!1}delete(L,k){const M=this;let U=!1;function r(L){if(L=_I(L)){const x=$f.findKey(M,L);!x||k&&!fI(0,M[x],x,k)||(delete M[x],U=!0)}}return $f.isArray(L)?L.forEach(r):r(L),U}clear(L){const k=Object.keys(this);let M=k.length,U=!1;for(;M--;){const x=k[M];L&&!fI(0,this[x],x,L,!0)||(delete this[x],U=!0)}return U}normalize(L){const k=this,M={};return $f.forEach(this,((U,x)=>{var V;const F=$f.findKey(M,x);if(F)return k[F]=EI(U),void delete k[x];const j=L?function(L){return l_(L).call(L).toLowerCase().replace(/([a-z\d])(\w*)/g,((L,k,M)=>k.toUpperCase()+M))}(x):l_(V=String(x)).call(V);j!==x&&delete k[x],k[j]=EI(U),M[j]=!0})),this}concat(){for(var L=arguments.length,k=new Array(L),M=0;M<L;M++)k[M]=arguments[M];return this.constructor.concat(this,...k)}toJSON(L){const k=Object.create(null);return $f.forEach(this,((M,U)=>{null!=M&&!1!==M&&(k[U]=L&&$f.isArray(M)?M.join(", "):M)})),k}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map((L=>{let[k,M]=L;return k+": "+M})).join("\n")}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(L){return L instanceof this?L:new this(L)}static concat(L){const k=new this(L);for(var M=arguments.length,U=new Array(M>1?M-1:0),x=1;x<M;x++)U[x-1]=arguments[x];return U.forEach((L=>k.set(L))),k}static accessor(L){const k=(this[oC]=this[oC]={accessors:{}}).accessors,M=this.prototype;function n(L){const U=_I(L);k[U]||(function(L,k){const M=$f.toCamelCase(" "+k);["get","set","has"].forEach((U=>{Object.defineProperty(L,U+M,{value:function(L,M,x){return this[U].call(this,k,L,M,x)},configurable:!0})}))}(M,L),k[U]=!0)}return $f.isArray(L)?L.forEach(n):n(L),this}}mI.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),$f.reduceDescriptors(mI.prototype,((L,k)=>{let{value:M}=L,U=k[0].toUpperCase()+k.slice(1);return{get:()=>M,set(L){this[U]=L}}})),$f.freezeMethods(mI);var sC=mI;function SI(L,k){const M=this||nC,U=k||M,x=sC.from(U.headers);let V=U.data;return $f.forEach(L,(function(L){V=L.call(M,V,x.normalize(),k?k.status:void 0)})),x.normalize(),V}function gI(L){return!(!L||!L.__CANCEL__)}function RI(L,k,M){kf.call(this,null==L?"canceled":L,kf.ERR_CANCELED,k,M),this.name="CanceledError"}function CI(L,k,M){const U=M.config.validateStatus;M.status&&U&&!U(M.status)?k(new kf("Request failed with status code "+M.status,[kf.ERR_BAD_REQUEST,kf.ERR_BAD_RESPONSE][Math.floor(M.status/100)-4],M.config,M.request,M)):L(M)}$f.inherits(RI,kf,{__CANCEL__:!0});const II=function(L,k){let M=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3,U=0;const x=function(L,k){L=L||10;const M=new Array(L),U=new Array(L);let x,V=0,F=0;return k=void 0!==k?k:1e3,function(j){const z=Date.now(),Q=U[F];x||(x=z),M[V]=j,U[V]=z;let $=F,ee=0;for(;$!==V;)ee+=M[$++],$%=L;if(V=(V+1)%L,V===F&&(F=(F+1)%L),z-x<k)return;const te=Q&&z-Q;return te?Math.round(1e3*ee/te):void 0}}(50,250);return function(L,k){let M,U,x=0,V=1e3/k;const s=function(k){let V=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Date.now();x=V,M=null,U&&(clearTimeout(U),U=null),L.apply(null,k)};return[function(){const L=Date.now(),k=L-x;for(var F=arguments.length,j=new Array(F),z=0;z<F;z++)j[z]=arguments[z];k>=V?s(j,L):(M=j,U||(U=setTimeout((()=>{U=null,s(M)}),V-k)))},()=>M&&s(M)]}((M=>{const V=M.loaded,F=M.lengthComputable?M.total:void 0,j=V-U,z=x(j);U=V,L({loaded:V,total:F,progress:F?V/F:void 0,bytes:j,rate:z||void 0,estimated:z&&F&&V<=F?(F-V)/z:void 0,event:M,lengthComputable:null!=F,[k?"download":"upload"]:!0})}),M)},vI=(L,k)=>{const M=null!=L;return[U=>k[0]({lengthComputable:M,total:L,loaded:U}),k[1]]},yI=L=>function(){for(var k=arguments.length,M=new Array(k),U=0;U<k;U++)M[U]=arguments[U];return $f.asap((()=>L(...M)))};var aC=UI.hasStandardBrowserEnv?function(){const L=UI.navigator&&/(msie|trident)/i.test(UI.navigator.userAgent),k=document.createElement("a");let M;function n(M){let U=M;return L&&(k.setAttribute("href",U),U=k.href),k.setAttribute("href",U),{href:k.href,protocol:k.protocol?k.protocol.replace(/:$/,""):"",host:k.host,search:k.search?k.search.replace(/^\?/,""):"",hash:k.hash?k.hash.replace(/^#/,""):"",hostname:k.hostname,port:k.port,pathname:"/"===k.pathname.charAt(0)?k.pathname:"/"+k.pathname}}return M=n(window.location.href),function(L){const k=$f.isString(L)?n(L):L;return k.protocol===M.protocol&&k.host===M.host}}():function(){return!0},cC=UI.hasStandardBrowserEnv?{write(L,k,M,U,x,V){const F=[L+"="+encodeURIComponent(k)];$f.isNumber(M)&&F.push("expires="+new Date(M).toGMTString()),$f.isString(U)&&F.push("path="+U),$f.isString(x)&&F.push("domain="+x),!0===V&&F.push("secure"),document.cookie=F.join("; ")},read(L){const k=document.cookie.match(new RegExp("(^|;\\s*)("+L+")=([^;]*)"));return k?decodeURIComponent(k[3]):null},remove(L){this.write(L,"",Date.now()-864e5)}}:{write(){},read:()=>null,remove(){}};function wI(L,k){return L&&!function(L){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(L)}(k)?function(L,k){return k?L.replace(/\/?\/$/,"")+"/"+k.replace(/^\/+/,""):L}(L,k):k}function OI(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}const NI=L=>L instanceof sC?function(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?OI(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):OI(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}({},L):L;function DI(L,k){k=k||{};const M={};function n(L,k,M){return $f.isPlainObject(L)&&$f.isPlainObject(k)?$f.merge.call({caseless:M},L,k):$f.isPlainObject(k)?$f.merge({},k):$f.isArray(k)?k.slice():k}function r(L,k,M){return $f.isUndefined(k)?$f.isUndefined(L)?void 0:n(void 0,L,M):n(L,k,M)}function o(L,k){if(!$f.isUndefined(k))return n(void 0,k)}function s(L,k){return $f.isUndefined(k)?$f.isUndefined(L)?void 0:n(void 0,L):n(void 0,k)}function a(M,U,x){return x in k?n(M,U):x in L?n(void 0,M):void 0}const U={url:o,method:o,data:o,baseURL:s,transformRequest:s,transformResponse:s,paramsSerializer:s,timeout:s,timeoutMessage:s,withCredentials:s,withXSRFToken:s,adapter:s,responseType:s,xsrfCookieName:s,xsrfHeaderName:s,onUploadProgress:s,onDownloadProgress:s,decompress:s,maxContentLength:s,maxBodyLength:s,beforeRedirect:s,transport:s,httpAgent:s,httpsAgent:s,cancelToken:s,socketPath:s,responseEncoding:s,validateStatus:a,headers:(L,k)=>r(NI(L),NI(k),!0)};return $f.forEach(Object.keys(Object.assign({},L,k)),(function(x){const V=U[x]||r,F=V(L[x],k[x],x);$f.isUndefined(F)&&V!==a||(M[x]=F)})),M}var PI=L=>{const k=DI({},L);let M,{data:U,withXSRFToken:x,xsrfHeaderName:V,xsrfCookieName:F,headers:j,auth:z}=k;if(k.headers=j=sC.from(j),k.url=Yf(wI(k.baseURL,k.url),L.params,L.paramsSerializer),z&&j.set("Authorization","Basic "+btoa((z.username||"")+":"+(z.password?unescape(encodeURIComponent(z.password)):""))),$f.isFormData(U))if(UI.hasStandardBrowserEnv||UI.hasStandardBrowserWebWorkerEnv)j.setContentType(void 0);else if(!1!==(M=j.getContentType())){const[L,...k]=M?M.split(";").map((L=>l_(L).call(L))).filter(Boolean):[];j.setContentType([L||"multipart/form-data",...k].join("; "))}if(UI.hasStandardBrowserEnv&&(x&&$f.isFunction(x)&&(x=x(k)),x||!1!==x&&aC(k.url))){const L=V&&F&&cC.read(F);L&&j.set(V,L)}return k},dC="undefined"!=typeof XMLHttpRequest&&function(L){return new Mp((function(k,M){const U=PI(L);let x=U.data;const V=sC.from(U.headers).normalize();let F,j,z,Q,$,{responseType:ee,onUploadProgress:te,onDownloadProgress:ie}=U;function _(){Q&&Q(),$&&$(),U.cancelToken&&U.cancelToken.unsubscribe(F),U.signal&&U.signal.removeEventListener("abort",F)}let ne=new XMLHttpRequest;function f(){if(!ne)return;const U=sC.from("getAllResponseHeaders"in ne&&ne.getAllResponseHeaders());CI((function(L){k(L),_()}),(function(L){M(L),_()}),{data:ee&&"text"!==ee&&"json"!==ee?ne.response:ne.responseText,status:ne.status,statusText:ne.statusText,headers:U,config:L,request:ne}),ne=null}ne.open(U.method.toUpperCase(),U.url,!0),ne.timeout=U.timeout,"onloadend"in ne?ne.onloadend=f:ne.onreadystatechange=function(){ne&&4===ne.readyState&&(0!==ne.status||ne.responseURL&&0===ne.responseURL.indexOf("file:"))&&setTimeout(f)},ne.onabort=function(){ne&&(M(new kf("Request aborted",kf.ECONNABORTED,L,ne)),ne=null)},ne.onerror=function(){M(new kf("Network Error",kf.ERR_NETWORK,L,ne)),ne=null},ne.ontimeout=function(){let k=U.timeout?"timeout of "+U.timeout+"ms exceeded":"timeout exceeded";const x=U.transitional||om;U.timeoutErrorMessage&&(k=U.timeoutErrorMessage),M(new kf(k,x.clarifyTimeoutError?kf.ETIMEDOUT:kf.ECONNABORTED,L,ne)),ne=null},void 0===x&&V.setContentType(null),"setRequestHeader"in ne&&$f.forEach(V.toJSON(),(function(L,k){ne.setRequestHeader(k,L)})),$f.isUndefined(U.withCredentials)||(ne.withCredentials=!!U.withCredentials),ee&&"json"!==ee&&(ne.responseType=U.responseType),ie&&([z,$]=II(ie,!0),ne.addEventListener("progress",z)),te&&ne.upload&&([j,Q]=II(te),ne.upload.addEventListener("progress",j),ne.upload.addEventListener("loadend",Q)),(U.cancelToken||U.signal)&&(F=k=>{ne&&(M(!k||k.type?new RI(null,L,ne):k),ne.abort(),ne=null)},U.cancelToken&&U.cancelToken.subscribe(F),U.signal&&(U.signal.aborted?F():U.signal.addEventListener("abort",F)));const re=function(L){const k=/^([-+\w]{1,25})(:?\/\/|:)/.exec(L);return k&&k[1]||""}(U.url);re&&-1===UI.protocols.indexOf(re)?M(new kf("Unsupported protocol "+re+":",kf.ERR_BAD_REQUEST,L)):ne.send(x||null)}))},kI=(L,k)=>{const{length:M}=L=L?L.filter(Boolean):[];if(k||M){let M,U=new AbortController;const r=function(L){if(!M){M=!0,s();const k=L instanceof Error?L:this.reason;U.abort(k instanceof kf?k:new RI(k instanceof Error?k.message:k))}};let x=k&&setTimeout((()=>{x=null,r(new kf("timeout ".concat(k," of ms exceeded"),kf.ETIMEDOUT))}),k);const s=()=>{L&&(x&&clearTimeout(x),x=null,L.forEach((L=>{L.unsubscribe?L.unsubscribe(r):L.removeEventListener("abort",r)})),L=null)};L.forEach((L=>L.addEventListener("abort",r)));const{signal:V}=U;return V.unsubscribe=()=>$f.asap(s),V}},hC=kp,pC=jl;wi({target:"Promise",stat:!0,forced:!0},{withResolvers:function(){var L=pC.f(this);return{promise:L.promise,resolve:L.resolve,reject:L.reject}}});var _C=jl,EC=el;wi({target:"Promise",stat:!0,forced:!0},{try:function(L){var k=_C.f(this),M=EC(L);return(M.error?k.reject:k.resolve)(M.value),k.promise}});var fC=i(hC),gC=Ym.f("asyncIterator"),TC=i(gC);function GI(L,k){this.v=L,this.k=k}function WI(L){var k,M;function n(k,M){try{var U=L[k](M),x=U.value,V=x instanceof GI;fC.resolve(V?x.v:x).then((function(M){if(V){var F="return"===k?"return":"next";if(!x.k||M.done)return n(F,M);M=L[F](M).value}r(U.done?"return":"normal",M)}),(function(L){n("throw",L)}))}catch(L){r("throw",L)}}function r(L,U){switch(L){case"return":k.resolve({value:U,done:!0});break;case"throw":k.reject(U);break;default:k.resolve({value:U,done:!1})}(k=k.next)?n(k.key,k.arg):M=null}this._invoke=function(L,U){return new fC((function(x,V){var F={key:L,arg:U,resolve:x,reject:V,next:null};M?M=M.next=F:(k=M=F,n(L,U))}))},"function"!=typeof L.return&&(this.return=void 0)}function HI(L){return function(){return new WI(L.apply(this,arguments))}}function KI(L){return new GI(L,0)}function YI(L){var k={},M=!1;function n(k,U){return M=!0,{done:!1,value:new GI(U=new fC((function(M){M(L[k](U))})),1)}}return k[void 0!==HS&&KS||"@@iterator"]=function(){return this},k.next=function(L){return M?(M=!1,L):n("next",L)},"function"==typeof L.throw&&(k.throw=function(L){if(M)throw M=!1,L;return n("throw",L)}),"function"==typeof L.return&&(k.return=function(L){return M?(M=!1,L):n("return",L)}),k}WI.prototype["function"==typeof HS&&TC||"@@asyncIterator"]=function(){return this},WI.prototype.next=function(L){return this._invoke("next",L)},WI.prototype.throw=function(L){return this._invoke("throw",L)},WI.prototype.return=function(L){return this._invoke("return",L)};var RC=i(gC);function zI(L){var k,M,U,x=2;for("undefined"!=typeof Symbol&&(M=RC,U=Symbol.iterator);x--;){if(M&&null!=(k=L[M]))return k.call(L);if(U&&null!=(k=L[U]))return new JI(k.call(L));M="@@asyncIterator",U="@@iterator"}throw new TypeError("Object is not async iterable")}function JI(L){function t(L){if(Object(L)!==L)return Mp.reject(new TypeError(L+" is not an object."));var k=L.done;return Mp.resolve(L.value).then((function(L){return{value:L,done:k}}))}return JI=function(L){this.s=L,this.n=L.next},JI.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(L){var k=this.s.return;return void 0===k?Mp.resolve({value:L,done:!0}):t(k.apply(this.s,arguments))},throw:function(L){var k=this.s.return;return void 0===k?Mp.reject(L):t(k.apply(this.s,arguments))}},new JI(L)}const XI=function*(L,k){let M=L.byteLength;if(!k||M<k)return void(yield L);let U,x=0;for(;x<M;)U=x+k,yield L.slice(x,U),x=U},IC=function(){var L=HI((function*(L,k){var M,U=!1,x=!1;try{for(var V,F=zI(yC(L));U=!(V=yield KI(F.next())).done;U=!1){const L=V.value;yield*YI(zI(XI(L,k)))}}catch(L){x=!0,M=L}finally{try{U&&null!=F.return&&(yield KI(F.return()))}finally{if(x)throw M}}}));return function(k,M){return L.apply(this,arguments)}}(),yC=function(){var L=HI((function*(L){if(L[RC])return void(yield*YI(zI(L)));const k=L.getReader();try{for(;;){const{done:L,value:M}=yield KI(k.read());if(L)break;yield M}}finally{yield KI(k.cancel())}}));return function(k){return L.apply(this,arguments)}}(),$I=(L,k,M,U)=>{const x=IC(L,k);let V,F=0,a=L=>{V||(V=!0,U&&U(L))};return new ReadableStream({async pull(L){try{const{done:k,value:U}=await x.next();if(k)return a(),void L.close();let V=U.byteLength;if(M){let L=F+=V;M(L)}L.enqueue(new Uint8Array(U))}catch(L){throw a(L),L}},cancel:L=>(a(L),x.return())},{highWaterMark:2})};function ev(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function tv(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?ev(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):ev(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}const AC="function"==typeof fetch&&"function"==typeof Request&&"function"==typeof Response,CC=AC&&"function"==typeof ReadableStream,vC=AC&&("function"==typeof TextEncoder?(bC=new TextEncoder,L=>bC.encode(L)):async L=>new Uint8Array(await new Response(L).arrayBuffer()));var bC;const sv=function(L){try{for(var k=arguments.length,M=new Array(k>1?k-1:0),U=1;U<k;U++)M[U-1]=arguments[U];return!!L(...M)}catch(L){return!1}},wC=CC&&sv((()=>{let L=!1;const k=new Request(UI.origin,{body:new ReadableStream,method:"POST",get duplex(){return L=!0,"half"}}).headers.has("Content-Type");return L&&!k})),OC=CC&&sv((()=>$f.isReadableStream(new Response("").body))),NC={stream:OC&&(L=>L.body)};var DC;AC&&(DC=new Response,["text","arrayBuffer","blob","formData","stream"].forEach((L=>{!NC[L]&&(NC[L]=$f.isFunction(DC[L])?k=>k[L]():(k,M)=>{throw new kf("Response type '".concat(L,"' is not supported"),kf.ERR_NOT_SUPPORT,M)})})));var PC=AC&&(async L=>{let{url:k,method:M,data:U,signal:x,cancelToken:V,timeout:F,onDownloadProgress:j,onUploadProgress:z,responseType:Q,headers:$,withCredentials:ee="same-origin",fetchOptions:te}=PI(L);Q=Q?(Q+"").toLowerCase():"text";let ie,ne=kI([x,V&&V.toAbortSignal()],F);const re=ne&&ne.unsubscribe&&(()=>{ne.unsubscribe()});let oe;try{if(z&&wC&&"get"!==M&&"head"!==M&&0!==(oe=await(async(L,k)=>{const M=$f.toFiniteNumber(L.getContentLength());return null==M?(async L=>{if(null==L)return 0;if($f.isBlob(L))return L.size;if($f.isSpecCompliantForm(L)){const k=new Request(UI.origin,{method:"POST",body:L});return(await k.arrayBuffer()).byteLength}return $f.isArrayBufferView(L)||$f.isArrayBuffer(L)?L.byteLength:($f.isURLSearchParams(L)&&(L+=""),$f.isString(L)?(await vC(L)).byteLength:void 0)})(k):M})($,U))){let L,M=new Request(k,{method:"POST",body:U,duplex:"half"});if($f.isFormData(U)&&(L=M.headers.get("content-type"))&&$.setContentType(L),M.body){const[L,k]=vI(oe,II(yI(z)));U=$I(M.body,65536,L,k)}}$f.isString(ee)||(ee=ee?"include":"omit");const x="credentials"in Request.prototype;ie=new Request(k,tv(tv({},te),{},{signal:ne,method:M.toUpperCase(),headers:$.normalize().toJSON(),body:U,duplex:"half",credentials:x?ee:void 0}));let V=await fetch(ie);const F=OC&&("stream"===Q||"response"===Q);if(OC&&(j||F&&re)){const L={};["status","statusText","headers"].forEach((k=>{L[k]=V[k]}));const k=$f.toFiniteNumber(V.headers.get("content-length")),[M,U]=j&&vI(k,II(yI(j),!0))||[];V=new Response($I(V.body,65536,M,(()=>{U&&U(),re&&re()})),L)}Q=Q||"text";let ce=await NC[$f.findKey(NC,Q)||"text"](V,L);return!F&&re&&re(),await new Mp(((k,M)=>{CI(k,M,{data:ce,headers:sC.from(V.headers),status:V.status,statusText:V.statusText,config:L,request:ie})}))}catch(k){if(re&&re(),k&&"TypeError"===k.name&&/fetch/i.test(k.message))throw Object.assign(new kf("Network Error",kf.ERR_NETWORK,L,ie),{cause:k.cause||k});throw kf.from(k,k&&k.code,L,ie)}});const LC={http:null,xhr:dC,fetch:PC};$f.forEach(LC,((L,k)=>{if(L){try{Object.defineProperty(L,"name",{value:k})}catch(L){}Object.defineProperty(L,"adapterName",{value:k})}}));const _v=L=>"- ".concat(L),Ev=L=>$f.isFunction(L)||null===L||!1===L;var fv_getAdapter=L=>{L=$f.isArray(L)?L:[L];const{length:k}=L;let M,U;const x={};for(let V=0;V<k;V++){let k;if(M=L[V],U=M,!Ev(M)&&(U=LC[(k=String(M)).toLowerCase()],void 0===U))throw new kf("Unknown adapter '".concat(k,"'"));if(U)break;x[k||"#"+V]=U}if(!U){const L=Object.entries(x).map((L=>{let[k,M]=L;return"adapter ".concat(k," ")+(!1===M?"is not supported by the environment":"is not available in the build")}));throw new kf("There is no suitable adapter to dispatch the request "+(k?L.length>1?"since :\n"+L.map(_v).join("\n"):" "+_v(L[0]):"as no adapter specified"),"ERR_NOT_SUPPORT")}return U};function mv(L){if(L.cancelToken&&L.cancelToken.throwIfRequested(),L.signal&&L.signal.aborted)throw new RI(null,L)}function Tv(L){return mv(L),L.headers=sC.from(L.headers),L.data=SI.call(L,L.transformRequest),-1!==["post","put","patch"].indexOf(L.method)&&L.headers.setContentType("application/x-www-form-urlencoded",!1),fv_getAdapter(L.adapter||nC.adapter)(L).then((function(k){return mv(L),k.data=SI.call(L,L.transformResponse,k),k.headers=sC.from(k.headers),k}),(function(k){return gI(k)||(mv(L),k&&k.response&&(k.response.data=SI.call(L,L.transformResponse,k.response),k.response.headers=sC.from(k.response.headers))),Mp.reject(k)}))}const kC="1.7.7",MC={};["object","boolean","number","function","string","symbol"].forEach(((L,k)=>{MC[L]=function(M){return typeof M===L||"a"+(k<1?"n ":" ")+L}}));const UC={};MC.transitional=function(L,k,M){function n(L,k){return"[Axios v1.7.7] Transitional option '"+L+"'"+k+(M?". "+M:"")}return(M,U,x)=>{if(!1===L)throw new kf(n(U," has been removed"+(k?" in "+k:"")),kf.ERR_DEPRECATED);return k&&!UC[U]&&(UC[U]=!0,console.warn(n(U," has been deprecated since v"+k+" and will be removed in the near future"))),!L||L(M,U,x)}};var xC={assertOptions:function(L,k,M){if("object"!=typeof L)throw new kf("options must be an object",kf.ERR_BAD_OPTION_VALUE);const U=Object.keys(L);let x=U.length;for(;x-- >0;){const V=U[x],F=k[V];if(F){const k=L[V],M=void 0===k||F(k,V,L);if(!0!==M)throw new kf("option "+V+" must be "+M,kf.ERR_BAD_OPTION_VALUE)}else if(!0!==M)throw new kf("Unknown option "+V,kf.ERR_BAD_OPTION)}},validators:MC};const VC=xC.validators;let FC=class{constructor(L){this.defaults=L,this.interceptors={request:new rm,response:new rm}}async request(L,k){try{return await this._request(L,k)}catch(L){if(L instanceof Error){let k;Error.captureStackTrace?Error.captureStackTrace(k={}):k=new Error;const M=k.stack?k.stack.replace(/^.+\n/,""):"";try{L.stack?M&&!String(L.stack).endsWith(M.replace(/^.+\n.+\n/,""))&&(L.stack+="\n"+M):L.stack=M}catch(L){}}throw L}}_request(L,k){"string"==typeof L?(k=k||{}).url=L:k=L||{},k=DI(this.defaults,k);const{transitional:M,paramsSerializer:U,headers:x}=k;void 0!==M&&xC.assertOptions(M,{silentJSONParsing:VC.transitional(VC.boolean),forcedJSONParsing:VC.transitional(VC.boolean),clarifyTimeoutError:VC.transitional(VC.boolean)},!1),null!=U&&($f.isFunction(U)?k.paramsSerializer={serialize:U}:xC.assertOptions(U,{encode:VC.function,serialize:VC.function},!0)),k.method=(k.method||this.defaults.method||"get").toLowerCase();let V=x&&$f.merge(x.common,x[k.method]);x&&$f.forEach(["delete","get","head","post","put","patch","common"],(L=>{delete x[L]})),k.headers=sC.concat(V,x);const F=[];let j=!0;this.interceptors.request.forEach((function(L){"function"==typeof L.runWhen&&!1===L.runWhen(k)||(j=j&&L.synchronous,F.unshift(L.fulfilled,L.rejected))}));const z=[];let Q;this.interceptors.response.forEach((function(L){z.push(L.fulfilled,L.rejected)}));let $,ee=0;if(!j){const L=[Tv.bind(this),void 0];for(L.unshift.apply(L,F),L.push.apply(L,z),$=L.length,Q=Mp.resolve(k);ee<$;)Q=Q.then(L[ee++],L[ee++]);return Q}$=F.length;let te=k;for(ee=0;ee<$;){const k=F[ee++],M=F[ee++];try{te=k(te)}catch(L){M.call(this,L);break}}try{Q=Tv.call(this,te)}catch(L){return Mp.reject(L)}for(ee=0,$=z.length;ee<$;)Q=Q.then(z[ee++],z[ee++]);return Q}getUri(L){return Yf(wI((L=DI(this.defaults,L)).baseURL,L.url),L.params,L.paramsSerializer)}};$f.forEach(["delete","get","head","options"],(function(L){FC.prototype[L]=function(k,M){return this.request(DI(M||{},{method:L,url:k,data:(M||{}).data}))}})),$f.forEach(["post","put","patch"],(function(L){function t(k){return function(M,U,x){return this.request(DI(x||{},{method:L,headers:k?{"Content-Type":"multipart/form-data"}:{},url:M,data:U}))}}FC.prototype[L]=t(),FC.prototype[L+"Form"]=t(!0)}));var BC=FC;class Av{constructor(L){if("function"!=typeof L)throw new TypeError("executor must be a function.");let k;this.promise=new Mp((function(L){k=L}));const M=this;this.promise.then((L=>{if(!M._listeners)return;let k=M._listeners.length;for(;k-- >0;)M._listeners[k](L);M._listeners=null})),this.promise.then=L=>{let k;const U=new Mp((L=>{M.subscribe(L),k=L})).then(L);return U.cancel=function(){M.unsubscribe(k)},U},L((function(L,U,x){M.reason||(M.reason=new RI(L,U,x),k(M.reason))}))}throwIfRequested(){if(this.reason)throw this.reason}subscribe(L){this.reason?L(this.reason):this._listeners?this._listeners.push(L):this._listeners=[L]}unsubscribe(L){if(!this._listeners)return;const k=this._listeners.indexOf(L);-1!==k&&this._listeners.splice(k,1)}toAbortSignal(){const L=new AbortController,t=k=>{L.abort(k)};return this.subscribe(t),L.signal.unsubscribe=()=>this.unsubscribe(t),L.signal}static source(){let L;return{token:new Av((function(k){L=k})),cancel:L}}}var jC=Av;const GC={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(GC).forEach((L=>{let[k,M]=L;GC[M]=k}));var WC=GC;const HC=function e(L){const k=new BC(L),M=GE(BC.prototype.request,k);return $f.extend(M,BC.prototype,k,{allOwnKeys:!0}),$f.extend(M,k,null,{allOwnKeys:!0}),M.create=function(k){return e(DI(L,k))},M}(nC);HC.Axios=BC,HC.CanceledError=RI,HC.CancelToken=jC,HC.isCancel=gI,HC.VERSION=kC,HC.toFormData=jf,HC.AxiosError=kf,HC.Cancel=HC.CanceledError,HC.all=function(L){return Mp.all(L)},HC.spread=function(L){return function(k){return L.apply(null,k)}},HC.isAxiosError=function(L){return $f.isObject(L)&&!0===L.isAxiosError},HC.mergeConfig=DI,HC.AxiosHeaders=sC,HC.formToJSON=L=>dI($f.isHTMLForm(L)?new FormData(L):L),HC.getAdapter=fv_getAdapter,HC.HttpStatusCode=WC,HC.default=HC;var KC=HC;const Pv=()=>{};function Lv(){const L={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:Pv};return L.promise=new Mp(((k,M)=>{L.resolve=M=>{L.isFinished||(L.isResolved=!0,L.isFinished=!0,k(M),L.value=M)},L.reject=k=>{L.isFinished||(L.isRejected=!0,L.isFinished=!0,M(k))}})),L}const zC=new Map,YC=new Map,qC=new Map;let XC=function(L){return L.WIN_10="Windows 10",L.WIN_81="Windows 8.1",L.WIN_8="Windows 8",L.WIN_7="Windows 7",L.WIN_VISTA="Windows Vista",L.WIN_SERVER_2003="Windows Server 2003",L.WIN_XP="Windows XP",L.WIN_2000="Windows 2000",L.ANDROID="Android",L.HARMONY_OS="HarmonyOS",L.OPEN_BSD="Open BSD",L.SUN_OS="Sun OS",L.LINUX="Linux",L.IOS="iOS",L.MAC_OS="Mac OS",L.CHROMIUM_OS="Chromium OS",L.QNX="QNX",L.UNIX="UNIX",L.BEOS="BeOS",L.OS_2="OS/2",L.SEARCH_BOT="Search Bot",L}({}),JC=function(L){return L.CHROME="Chrome",L.SAFARI="Safari",L.EDGE="Edge",L.FIREFOX="Firefox",L.OPERA="OPR",L.QQ="QQBrowser",L.WECHAT="MicroMessenger",L}({});const QC=new SE;let ZC=QC.getResult(),$C=null;function Gv(L){if(!$C){L&&QC.setUA(L),ZC=QC.getResult();const k=function(L){if("Blink"===L.engine.name&&"WeChat"!==L.browser.name)return JC.CHROME;switch(L.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return JC.CHROME;case"Safari":case"Mobile Safari":return JC.SAFARI;case"Edge":return JC.EDGE;case"Firefox":return JC.FIREFOX;case"QQ":case"QQBrowser":return JC.QQ;case"Opera":return JC.OPERA;case"WeChat":return JC.WECHAT;default:return L.browser.name||""}}(ZC),M=Wv(ZC),U=function(L){return"Windows"===L.os.name?L.os.version?L.os.name+" "+L.os.version:L.os.name:L.os.name||""}(ZC),x=ZC.os.version,V=Wv(ZC,!1),F=ZC.device.type;if(!(k&&M&&U&&x))return{name:k,version:M,os:U,osVersion:x,browserVersion:V,deviceType:F};$C={name:k,version:M,os:U,osVersion:x,browserVersion:V,deviceType:F}}return $C}function Wv(L){let k,M=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return k="Blink"===L.engine.name?L.engine.version||"":L.browser.version||"",M?k.split(".")[0]:k}function Hv(){return Gv().os}function Kv(){const L=Gv();return"".concat(L.os," ").concat(L.osVersion)}function Yv(){const L=Gv();return!!("WebKit"===ZC.engine.name&&L.os===XC.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&L.name!==JC.SAFARI||Qv()&&L.name!==JC.SAFARI)}function qv(){return Gv().name===JC.CHROME}function zv(){return Gv().name===JC.SAFARI}function Jv(){return Gv().name===JC.EDGE}function Xv(){return Gv().name===JC.FIREFOX}function Qv(){return Gv().os===XC.IOS}function Zv(L){const k=Gv();return!(k.name!==JC.CHROME||!k.osVersion)&&Number(k.version)>=L}function $v(L){const k=Gv();return!(k.name!==JC.CHROME||!k.osVersion)&&Number(k.version)<L}function ey(L){const k=Gv();return!(k.name!==JC.EDGE||!k.osVersion)&&Number(k.version)>=L}function ty(L){const k=Gv();return!(k.name!==JC.SAFARI||!k.osVersion)&&Number(k.version)>=L}function iy(L,k,M){const U=Gv();if(U.os!==XC.IOS||!U.osVersion)return!1;const x=U.osVersion.split(".");return M?k&&Number(x[0])===L&&Number(x[1])<k||Number(x[0])<L:k?Number(x[0])===L&&Number(x[1])<=k||Number(x[0])<L:Number(x[0])<=L}function ny(L,k,M){const U=Gv();if(U.name!==JC.SAFARI||!U.osVersion||!U.browserVersion)return!1;const x=U.browserVersion.split(".");return M?k&&Number(x[0])===L&&Number(x[1])<k||Number(x[0])<L:k?Number(x[0])===L&&Number(x[1])<=k||Number(x[0])<L:Number(x[0])<=L}function ry(L){const k=Gv();return!(k.name!==JC.OPERA||!k.osVersion)&&Number(k.version)>=L}function oy(){const L=Gv();if(L.os!==XC.IOS||!L.osVersion)return!1;const k=L.osVersion.split(".");return Number(k[0])<14||14===Number(k[0])&&Number(k[1])<=6}function sy(){const L=Gv();if(L.os!==XC.IOS||!L.osVersion)return!1;const k=L.osVersion.split(".");return 15===Number(k[0])}function ay(){const L=Gv();if(L.os!==XC.IOS||!L.osVersion)return!1;const k=L.osVersion.split(".");return 16===Number(k[0])}function cy(){const L=Gv();if(L.os!==XC.IOS||!L.osVersion)return!1;const k=L.osVersion.split(".");return 15===Number(k[0])&&Number(k[1])>=1}function dy(){return zv()&&navigator.maxTouchPoints>0}function ly(){return Gv().name===JC.WECHAT}function uy(){return window.navigator.appVersion&&null!==window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function hy(){const L=Hv();return function(){const{deviceType:L}=Gv();return"mobile"===L||"tablet"===L}()||L===XC.ANDROID||L===XC.IOS||L===XC.HARMONY_OS}function py(){const L=Gv();return L.name!==JC.EDGE&&L.name!==JC.SAFARI&&!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function _y(){return Hv()===XC.ANDROID}function Ey(){const L=Gv();return _y()&&(L.name===JC.CHROME||L.name===JC.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}function fy(L,k,M){return(k=function(L){var k=function(L,k){if("object"!=typeof L||!L)return L;var M=L[Symbol.toPrimitive];if(void 0!==M){var U=M.call(L,"string");if("object"!=typeof U)return U;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(L)}(L);return"symbol"==typeof k?k:k+""}(k))in L?Object.defineProperty(L,k,{value:M,enumerable:!0,configurable:!0,writable:!0}):L[k]=M,L}function my(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function Ty(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?my(Object(M),!0).forEach((function(k){fy(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):my(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}let iv=function(L){return L.UNEXPECTED_ERROR="UNEXPECTED_ERROR",L.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",L.TIMEOUT="TIMEOUT",L.INVALID_PARAMS="INVALID_PARAMS",L.NOT_READABLE="NOT_READABLE",L.NOT_SUPPORTED="NOT_SUPPORTED",L.INVALID_OPERATION="INVALID_OPERATION",L.OPERATION_ABORTED="OPERATION_ABORTED",L.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",L.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",L.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",L.DATACHANNEL_FAILED="DATACHANNEL_FAILED",L.NETWORK_ERROR="NETWORK_ERROR",L.NETWORK_TIMEOUT="NETWORK_TIMEOUT",L.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",L.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",L.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",L.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",L.ELECTRON_IS_NULL="ELECTRON_IS_NULL",L.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",L.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",L.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",L.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",L.PERMISSION_DENIED="PERMISSION_DENIED",L.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",L.TRACK_IS_DISABLED="TRACK_IS_DISABLED",L.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",L.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",L.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",L.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",L.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",L.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",L.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",L.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",L.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",L.UID_CONFLICT="UID_CONFLICT",L.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",L.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",L.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",L.INVALID_TRACK="INVALID_TRACK",L.SENDER_NOT_FOUND="SENDER_NOT_FOUND",L.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",L.SET_ANSWER_FAILED="SET_ANSWER_FAILED",L.ICE_FAILED="ICE_FAILED",L.PC_CLOSED="PC_CLOSED",L.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",L.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",L.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",L.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",L.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",L.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",L.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",L.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",L.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",L.INVALID_REMOTE_USER="INVALID_REMOTE_USER",L.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",L.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",L.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",L.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",L.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",L.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",L.WS_ABORT="WS_ABORT",L.WS_DISCONNECT="WS_DISCONNECT",L.WS_ERR="WS_ERR",L.EXTERNAL_SIGNAL_ABORT="EXTERNAL_SIGNAL_ABORT",L.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",L.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",L.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",L.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",L.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",L.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",L.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",L.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",L.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",L.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",L.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",L.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",L.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",L.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",L.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",L.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",L.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",L.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",L.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",L.INVALID_PLUGIN="INVALID_PLUGIN",L.DISCONNECT_P2P="DISCONNECT_P2P",L.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",L.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",L.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",L.CREATE_DATACHANNEL_ERROR="CREATE_DATACHANNEL_ERROR",L.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",L.PROHIBITED_OPERATION="PROHIBITED_OPERATION",L.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED",L.P2P_MESSAGE_FAILED="P2P_MESSAGE_FAILED",L}({}),nv=class extends Error{constructor(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",M=arguments.length>2?arguments[2]:void 0;super(k),fy(this,"code",void 0),fy(this,"message",void 0),fy(this,"data",void 0),fy(this,"name","AgoraRTCException"),this.code=L,this.message="AgoraRTCError ".concat(this.code,": ").concat(k),this.data=M}toString(){return this.data?"data: ".concat(JSON.stringify(this.data),"\n").concat(this.stack):"".concat(this.stack)}print(){let L=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"error",k=arguments.length>1?arguments[1]:void 0;return"error"===L&&(k||console).error(this.toString()),"warning"===L&&(k||console).warn(this.toString()),this}throw(L){throw this.print("error",L),this}};function Ry(L,k){if("boolean"!=typeof L)throw new nv(iv.INVALID_PARAMS,"Invalid ".concat(k,": The value is of the boolean type."))}function Cy(L,k,M){if(!Sr(M).call(M,L))throw new nv(iv.INVALID_PARAMS,"".concat(k," can only be set as ").concat(JSON.stringify(M)))}function Iy(L,k){let M=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,U=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1e4;if(L<M||L>U||(!(arguments.length>4&&void 0!==arguments[4])||arguments[4])&&!function(L){return"number"==typeof L&&L%1==0}(L))throw new nv(iv.INVALID_PARAMS,"invalid ".concat(k,": the value range is [").concat(M,", ").concat(U,"]. integer only"))}function vy(L,k){if("number"!=typeof L){if(!(L.min||L.max||L.ideal||L.exact))throw new nv(iv.INVALID_PARAMS,"".concat(k," is not a valid ConstrainLong"));void 0!==L.min&&Iy(L.min,"".concat(k,".min"),0,1/0),void 0!==L.max&&Iy(L.max,"".concat(k,".max"),1,1/0),void 0!==L.exact&&Iy(L.exact,"".concat(k,".exact"),1,1/0),void 0!==L.ideal&&Iy(L.ideal,"".concat(k,".ideal"),1,1/0)}else Iy(L,k,1,1/0)}function yy(L,k){let M=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,U=arguments.length>3&&void 0!==arguments[3]?arguments[3]:255,x=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];if(null==L)throw new nv(iv.INVALID_PARAMS,"".concat(k||"param"," cannot be empty"));if(!wy(L,M,U,x))throw new nv(iv.INVALID_PARAMS,"Invalid ".concat(k||"string param",": Length of the string: [").concat(M,",").concat(U,"].").concat(x?" ASCII characters only.":""))}function Ay(L,k){if(!Array.isArray(L))throw new nv(iv.INVALID_PARAMS,"".concat(k," should be an array"))}function by(L){return null==L}function wy(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,M=arguments.length>2&&void 0!==arguments[2]?arguments[2]:255,U=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return"string"==typeof L&&L.length<=M&&L.length>=k&&(!U||function(L){if("string"!=typeof L)return!1;for(let k=0;k<L.length;k+=1){const M=L.charCodeAt(k);if(M<0||M>255)return!1}return!0}(L))}var rv=function(L){return L.COVERED="COVERED",L.POSITION="POSITION",L.SIZE="SIZE",L.STYLE="STYLE",L}(rv||{}),ov=function(L){return L.UNMOUNTED="UNMOUNTED",L.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT",L}(ov||{});const av=new class{constructor(){fy(this,"_clientSize",null),fy(this,"getClientWidth",(()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth)),fy(this,"getClientHeight",(()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight)),fy(this,"getStyle",(L=>window.getComputedStyle(L,null))),fy(this,"checkCssVisibleProperty",(L=>{var k;let M=!0;const U=this.getStyle(L),{display:x,visibility:V,opacity:F,filter:j}=U;return("none"===x||Sr(k=["hidden","collapse"]).call(k,V)||Number(F)<.1)&&(M=!1),!!M&&(j&&j.split(" ").filter((L=>{var k;const M=L.split("(")[0];return Sr(k=["brightness","blur","opacity"]).call(k,M)})).map((L=>{const[k,M]=L.split(/\(|\)/);return[k,Number(M.match(/^[0-9\.]+/))]})).forEach((L=>{const[k,U]=L;switch(k){case"brightness":(U<.1||U>3)&&(M=!1);break;case"blur":U>3&&(M=!1);break;case"opacity":U<.1&&(M=!1)}})),M)})),fy(this,"checkPropertyUpToAllParentNodes",((L,k)=>{let M=!0,U=!0;const r=L=>k(L);let x=L;for(;x&&U;)r(x)||(M=!1,U=!1),x=x.parentElement,x||(U=!1);return M})),fy(this,"checkActualCssVisibleIncludeInherit",(L=>this.checkPropertyUpToAllParentNodes(L,this.checkCssVisibleProperty))),fy(this,"getSizeAboutClient",(L=>{const{width:k,height:M,left:U,right:x,top:V,bottom:F}=L.getBoundingClientRect(),j=this.getClientWidth(),z=this.getClientHeight();return{width:k,height:M,left:U,right:x,top:V,bottom:F,clientWidth:j,clientHeight:z,clientMin:Math.min(j,z)}})),fy(this,"checkActualSize",(()=>{const{width:L,height:k,clientMin:M}=this._clientSize;return this.checkSizeIsVisible(L,k,M)})),fy(this,"elementFromPoint",((L,k)=>document.elementFromPoint?document.elementFromPoint(L,k):null)),fy(this,"checkCoverForAPoint",((L,k,M)=>{const U=this.elementFromPoint(L,k);return null!==U&&U!==M})),fy(this,"getPointPositionList",(()=>{const{width:L,height:k,left:M,top:U}=this._clientSize,x=L/6,V=k/6,F=[],j=10**6;for(let L=0;L<5;L++)for(let k=0;k<5;k++){const z=(M*j+(0===L?.1:4===L?(x*L*j-1e5)/j:x*L)*j)/j,Q=(U*j+(0===k?.1:4===k?(V*k*j-1e5)/j:V*k)*j)/j;F.push({x:z,y:Q})}return[...F]})),fy(this,"checkElementCover",(L=>this.getPointPositionList().map((k=>this.checkCoverForAPoint(k.x,k.y,L))).filter((L=>!!L)).length>6)),fy(this,"checkSizeIsVisible",((L,k,M)=>(L>50||M/L<=10)&&(k>50||M/k<=10))),fy(this,"checkSizeOfPartInClient",(()=>{const{left:L,right:k,top:M,bottom:U,clientHeight:x,clientWidth:V,clientMin:F}=this._clientSize;let j,z,Q,$;if(L<0)j=0;else{if(!(L<V))return!1;j=L}if(k<0)return!1;if(z=k<V?k:V,M<0)Q=0;else{if(!(M<x))return!1;Q=M}if(U<0)return!1;$=U<x?U:x;const ee=z-j,te=$-Q;return this.checkSizeIsVisible(ee,te,F)})),fy(this,"returnHiddenResult",(L=>(this._clientSize=null,{visible:!1,reason:L}))),fy(this,"checkOneElementVisible",(L=>{if(L instanceof HTMLElement){if(this.checkElementIsMountedOnDom(L)){if(this.checkActualCssVisibleIncludeInherit(L)){if(this._clientSize=this.getSizeAboutClient(L),this.checkElementCover(L))return this.returnHiddenResult(rv.COVERED);{const L=this.checkActualSize(),k=this.checkSizeOfPartInClient();return L&&!k?this.returnHiddenResult(rv.POSITION):L?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(rv.SIZE)}}return this.returnHiddenResult(rv.STYLE)}return this.returnHiddenResult(ov.UNMOUNTED)}return this.returnHiddenResult(ov.INVALID_HTML_ELEMENT)})),fy(this,"checkElementIsMountedOnDom",(L=>this.checkPropertyUpToAllParentNodes(L,(L=>"HTML"!==L.nodeName.toUpperCase()?null!==L.parentElement:!!document.documentElement))))}};function Py(L){return(new TextEncoder).encode(L)}const Ly=function(L,k){const M=new Uint8Array(L.byteLength+k.byteLength);return M.set(new Uint8Array(L),0),M.set(new Uint8Array(k),L.byteLength),M},ky=async L=>function(L,k){let M="";return new Uint8Array(L).forEach((L=>{M+=L.toString(16).padStart(2,"0")})),M}(await crypto.subtle.digest("SHA-256",Py(L)));class My{constructor(){fy(this,"_events",{}),fy(this,"addListener",this.on)}getListeners(L){return this._events[L]?this._events[L].map((L=>L.listener)):[]}on(L,k){this._events[L]||(this._events[L]=[]);const M=this._events[L];-1===this._indexOfListener(M,k)&&M.push({listener:k,once:!1})}once(L,k){this._events[L]||(this._events[L]=[]);const M=this._events[L];-1===this._indexOfListener(M,k)&&M.push({listener:k,once:!0})}off(L,k){if(!this._events[L])return;const M=this._events[L],U=this._indexOfListener(M,k);-1!==U&&M.splice(U,1),0===this._events[L].length&&delete this._events[L]}removeAllListeners(L){L?delete this._events[L]:this._events={}}emit(L){this._events[L]||(this._events[L]=[]);const k=this._events[L].map((L=>L));for(var M=arguments.length,U=new Array(M>1?M-1:0),x=1;x<M;x++)U[x-1]=arguments[x];for(let M=0;M<k.length;M+=1){const x=k[M];x.once&&this.off(L,x.listener),x.listener.apply(this,U||[])}}safeEmit(L){for(var k=arguments.length,M=new Array(k>1?k-1:0),U=1;U<k;U++)M[U-1]=arguments[U];[...this._events[L]||[]].forEach((k=>{k.once&&this.off(L,k.listener);try{k.listener.apply(this,M)}catch(k){console.error("safeEmit event:".concat(L," error ").concat(null==k?void 0:k.toString()))}}))}_indexOfListener(L,k){let M=L.length;for(;M--;)if(L[M].listener===k)return M;return-1}}let cv=null;function xy(){if(cv)return cv;if(window.electron)return cv=window.electron;if(!window.require)return null;try{return cv=window.require("electron"),cv}catch(L){return null}}let dv=function(L){return L.CREATE_CLIENT="createClient",L.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",L.SET_AREA="setArea",L.PRELOAD="PRELOAD",L.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",L.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",L.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",L.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",L.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",L.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",L.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",L.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",L.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",L.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",L.START_PROXY_SERVER="Client.startProxyServer",L.STOP_PROXY_SERVER="Client.stopProxyServer",L.SET_PROXY_SERVER="Client.setProxyServer",L.SET_TURN_SERVER="Client.setTurnServer",L.SET_CLIENT_ROLE="Client.setClientRole",L.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",L.ENABLE_DUAL_STREAM="Client.enableDualStream",L.DISABLE_DUAL_STREAM="Client.disableDualStream",L.JOIN="Client.join",L.LEAVE="Client.leave",L.PUBLISH="Client.publish",L.UNPUBLISH="Client.unpublish",L.SUBSCRIBE="Client.subscribe",L.MASS_SUBSCRIBE="Client.massSubscribe",L.MASS_UNSUBSCRIBE="Client.massUnsubscribe",L.UNSUBSCRIBE="Client.unsubscribe",L.RENEW_TOKEN="Client.renewToken",L.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",L.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",L.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",L.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",L.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",L.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",L.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",L.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",L.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",L.START_LIVE_STREAMING="Client.startLiveStreaming",L.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",L.STOP_LIVE_STREAMING="Client.stopLiveStreaming",L.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",L.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",L.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",L.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",L.SET_CONFIG_DISTRIBUTE="_configDistribute",L.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",L.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",L.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",L.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",L.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",L.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",L.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",L.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",L.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",L.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",L.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",L.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",L.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",L.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",L.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",L.LOCAL_VIDEO_SEND_SEI_DATA="LocalVideoTrack.sendSeiData",L.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",L.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",L.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",L.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",L.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",L.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",L.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",L.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",L.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",L.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",L.STREAM_TYPE_CHANGE="streamTypeChange",L.CONNECTION_STATE_CHANGE="connectionStateChange",L.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",L.IMAGE_MODERATION_UPLOAD="imageModerationUpload",L}({}),lv=function(L){return L.TRACER="tracer",L}({});function By(L){return Iy(L.timeout,"config.timeout",0,1e5),Iy(L.timeoutFactor,"config.timeoutFactor",0,100,!1),Iy(L.maxRetryCount,"config.maxRetryConfig",0,1/0),Iy(L.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}let uv=function(L){return L[L.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",L[L.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",L[L.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY",L}({}),hv=function(L){return L.LEAVE="LEAVE",L.NETWORK_ERROR="NETWORK_ERROR",L.SERVER_ERROR="SERVER_ERROR",L.UID_BANNED="UID_BANNED",L.FALLBACK="FALLBACK",L.IP_BANNED="IP_BANNED",L.CHANNEL_BANNED="CHANNEL_BANNED",L.LICENSE_MISSING="LICENSE_MISSING",L.LICENSE_EXPIRED="LICENSE_EXPIRED",L.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",L.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",L.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",L.LICENSE_ILLEGAL="LICENSE_ILLEGAL",L.TOKEN_EXPIRE="TOKEN_EXPIRE",L}({});function Wy(L){if(!Array.isArray(L)||L.length<1)return!1;try{L.forEach((L=>{if(!L.urls)throw Error()}))}catch(L){return!1}return!0}function Hy(L){return yy(L.turnServerURL,"turnServerURL"),yy(L.username,"username"),yy(L.password,"password"),L.udpport&&Iy(L.udpport,"udpport",1,99999,!0),L.forceturn&&Ry(L.forceturn,"forceturn"),L.security&&Ry(L.security,"security"),L.tcpport&&Iy(L.tcpport,"tcpport",1,99999,!0),!0}function Ky(L){return void 0!==L.level&&Cy(L.level,"level",[1,2,3]),void 0!==L.delay&&Iy(L.delay,"delay",0,3e3,!0),!0}let pv=function(L){return L.CONNECTION_STATE_CHANGE="connection-state-change",L.MEDIA_RECONNECT_START="media-reconnect-start",L.MEDIA_RECONNECT_END="media-reconnect-end",L.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",L.USER_JOINED="user-joined",L.USER_LEAVED="user-left",L.USER_PUBLISHED="user-published",L.USER_UNPUBLISHED="user-unpublished",L.USER_INFO_UPDATED="user-info-updated",L.CLIENT_BANNED="client-banned",L.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",L.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",L.VOLUME_INDICATOR="volume-indicator",L.CRYPT_ERROR="crypt-error",L.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",L.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",L.NETWORK_QUALITY="network-quality",L.STREAM_TYPE_CHANGED="stream-type-changed",L.STREAM_FALLBACK="stream-fallback",L.RECEIVE_METADATA="receive-metadata",L.STREAM_MESSAGE="stream-message",L.LIVE_STREAMING_ERROR="live-streaming-error",L.LIVE_STREAMING_WARNING="live-streaming-warning",L.EXCEPTION="exception",L.ERROR="error",L.P2P_LOST="p2p_lost",L.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",L.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",L.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",L.PUBLISHED_USER_LIST="published-user-list",L.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",L.CONTENT_INSPECT_ERROR="content-inspect-error",L.CONTENT_INSPECT_RESULT="content-inspect-result",L.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change",L}({}),fv=function(L){return L.NETWORK_ERROR="NETWORK_ERROR",L.SERVER_ERROR="SERVER_ERROR",L.MULTI_IP="MULTI_IP",L.TIMEOUT="TIMEOUT",L.OFFLINE="OFFLINE",L.LEAVE="LEAVE",L.P2P_FAILED="P2P_FAILED",L.FALLBACK="FALLBACK",L}({}),gv=function(L){return L.ONLINE="ONLINE",L.OFFLINE="OFFLINE",L}({}),Sv=function(L){return L.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",L.ONLINE="ONLINE",L.OFFLINE="OFFLINE",L}({});function Xy(L,k){for(var M=arguments.length,U=new Array(M>2?M-2:0),x=2;x<M;x++)U[x-2]=arguments[x];return 0===L.getListeners(k).length?Mp.reject(new nv(iv.UNEXPECTED_ERROR,"can not emit promise")):new Mp(((M,x)=>{L.emit(k,...U,M,x)}))}function Qy(L,k){if(0===L.getListeners(k).length)return Mp.resolve();for(var M=arguments.length,U=new Array(M>2?M-2:0),x=2;x<M;x++)U[x-2]=arguments[x];return Xy(L,k,...U)}function Zy(L,k){if(0===L.getListeners(k).length)return null;for(var M=arguments.length,U=new Array(M>2?M-2:0),x=2;x<M;x++)U[x-2]=arguments[x];return $y(L,k,...U)}function $y(L,k){let M=null,U=null;for(var x=arguments.length,V=new Array(x>2?x-2:0),F=2;F<x;F++)V[F-2]=arguments[F];if(L.emit(k,...V,(L=>{M=L}),(L=>{U=L})),null!==U)throw U;if(null===M)throw new nv(iv.UNEXPECTED_ERROR,"handler is not sync");return M}const Rv=new class extends My{set networkState(L){this.emit(Sv.NETWORK_STATE_CHANGE,L,this._networkState),L===gv.ONLINE?this.emit(Sv.ONLINE):L===gv.OFFLINE&&(this.onlineWaiter=new Mp((L=>{this.once(Sv.ONLINE,(()=>{this.onlineWaiter=void 0,L(gv.ONLINE)}))})),this.emit(Sv.OFFLINE)),this._networkState=L}get networkState(){return this._networkState}get isOnline(){return this._networkState===gv.ONLINE}constructor(){super(),fy(this,"_moduleName","network-indicator"),fy(this,"_networkState",gv.ONLINE),fy(this,"onlineWaiter",void 0),window.addEventListener("online",(()=>{this.networkState=gv.ONLINE})),window.addEventListener("offline",(()=>{this.networkState=gv.OFFLINE}))}};function tA(L,k){const M=L.indexOf(k);-1!==M&&L.splice(M,1)}function iA(L){const k=[];return L.forEach((L=>{-1===k.indexOf(L)&&k.push(L)})),k}function nA(L){void 0!==Mp?Mp.resolve().then(L):setTimeout(L,0)}function rA(L){return JSON.parse(JSON.stringify(L))}function oA(L){try{return rA(L)}catch(k){return L}}const Iv={};function aA(L,k){Iv[k]||(Iv[k]=!0,L())}function cA(L){const k=window.atob(L),M=new Uint8Array(new ArrayBuffer(k.length));for(let L=0;L<k.length;L+=1)M[L]=k.charCodeAt(L);return M}function dA(L){let k="";for(let M=0;M<L.length;M+=1)k+=String.fromCharCode(L[M]);return window.btoa(k)}function lA(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:16,M=(new TextEncoder).encode(L);if(M.length>k)M=M.slice(0,k);else if(M.length<k){const L=new Uint8Array(k);L.set(M),M=L}return M}function uA(){for(var L=arguments.length,k=new Array(L),M=0;M<L;M++)k[M]=arguments[M];const U=kr(k).call(k,((L,k)=>L+k.length),0),x=new Uint8Array(new ArrayBuffer(U));let V=0;return k.forEach((L=>{x.set(L,V),V+=L.length})),x}function hA(L){return window.TextEncoder?(new TextEncoder).encode(L).length:L.length}function pA(L){let k=0;return(/DingTalk/i.test(navigator.userAgent)||/AliApp/i.test(navigator.userAgent))&&L.realFormData&&(L=L.realFormData),L.forEach((L=>{k+="string"==typeof L?hA(L):L.size})),k+138}function _A(L){const k=new nv(iv.TIMEOUT,"timeout");return new Mp(((M,U)=>{window.setTimeout((()=>U(k)),L)}))}function EA(L){return new Mp((k=>{window.setTimeout(k,L)}))}function fA(){let L=arguments.length>0&&void 0!==arguments[0]?arguments[0]:7,k=arguments.length>1?arguments[1]:void 0;const M=Math.random().toString(16).substr(2,L).toLowerCase();return M.length===L?"".concat(k).concat(M):"".concat(k).concat(M)+fA(L-M.length,"")}function mA(){return fA(32,"").toUpperCase()}const TA=()=>{},yv=new class{constructor(){fy(this,"fnMap",new Map)}throttleByKey(L,k,M,U){for(var x=arguments.length,V=new Array(x>4?x-4:0),F=4;F<x;F++)V[F-4]=arguments[F];if(this.fnMap.has(k)){const x=this.fnMap.get(k);if(x.threshold!==M){x.fn(...x.args),clearTimeout(x.timer);const F=window.setTimeout((()=>{const L=this.fnMap.get(k);L&&L.fn(...L.args),this.fnMap.delete(k)}),M);this.fnMap.set(k,{fn:L,threshold:M,timer:F,args:V,skipFn:U})}else x.skipFn&&x.skipFn(...x.args),this.fnMap.set(k,Ty(Ty({},x),{},{fn:L,args:V,skipFn:U}))}else{const x=window.setTimeout((()=>{const L=this.fnMap.get(k);L&&L.fn(...L.args),this.fnMap.delete(k)}),M);this.fnMap.set(k,{fn:L,threshold:M,timer:x,args:V,skipFn:U})}}},Cv=yv.throttleByKey.bind(yv);function RA(L){return"object"==typeof L&&null!==L&&!(L instanceof RegExp)}function CA(L,k){if(!RA(L)||!RA(k))return k;if(Array.isArray(L)&&!Array.isArray(k)||!Array.isArray(L)&&Array.isArray(k))return k;if(Array.isArray(k)&&Array.isArray(L)){const M=[...L];for(let U=0;U<k.length;U++)M[U]=CA(L[U],k[U]);return M}{const M=Ty({},L);for(const U in k)Object.prototype.hasOwnProperty.call(k,U)&&(Object.prototype.hasOwnProperty.call(L,U)?M[U]=CA(L[U],k[U]):M[U]=k[U]);return M}}function IA(L,k){let M=[0];if(k&&(M=new Array(k).fill(0)),0===L)return M;let U=0;for(;L>0&&(M[U]=255&L,L>>=8,U++,!k||U!==k););return M}function vA(L){return"number"==typeof L?L:L.exact||L.ideal||L.max||L.min||0}function yA(L){const k="0123456789abcdef";function i(L){let M,U="";for(M=0;M<=3;M++)U+=k.charAt(L>>8*M+4&15)+k.charAt(L>>8*M&15);return U}function n(L,k){const M=(65535&L)+(65535&k);return(L>>16)+(k>>16)+(M>>16)<<16|65535&M}function r(L,k,M,U,x,V){return n(function(L,k){return L<<k|L>>>32-k}(n(n(k,L),n(U,V)),x),M)}function o(L,k,M,U,x,V,F){return r(k&M|~k&U,L,k,x,V,F)}function s(L,k,M,U,x,V,F){return r(k&U|M&~U,L,k,x,V,F)}function a(L,k,M,U,x,V,F){return r(k^M^U,L,k,x,V,F)}function c(L,k,M,U,x,V,F){return r(M^(k|~U),L,k,x,V,F)}const M=function(L){let k;const M=1+(L.length+8>>6),U=new Array(16*M);for(k=0;k<16*M;k++)U[k]=0;for(k=0;k<L.length;k++)U[k>>2]|=L.charCodeAt(k)<<k%4*8;return U[k>>2]|=128<<k%4*8,U[16*M-2]=8*L.length,U}(L);let U,x,V,F,j,z=1732584193,Q=-271733879,$=-1732584194,ee=271733878;for(U=0;U<M.length;U+=16)x=z,V=Q,F=$,j=ee,z=o(z,Q,$,ee,M[U+0],7,-680876936),ee=o(ee,z,Q,$,M[U+1],12,-389564586),$=o($,ee,z,Q,M[U+2],17,606105819),Q=o(Q,$,ee,z,M[U+3],22,-1044525330),z=o(z,Q,$,ee,M[U+4],7,-176418897),ee=o(ee,z,Q,$,M[U+5],12,1200080426),$=o($,ee,z,Q,M[U+6],17,-1473231341),Q=o(Q,$,ee,z,M[U+7],22,-45705983),z=o(z,Q,$,ee,M[U+8],7,1770035416),ee=o(ee,z,Q,$,M[U+9],12,-1958414417),$=o($,ee,z,Q,M[U+10],17,-42063),Q=o(Q,$,ee,z,M[U+11],22,-1990404162),z=o(z,Q,$,ee,M[U+12],7,1804603682),ee=o(ee,z,Q,$,M[U+13],12,-40341101),$=o($,ee,z,Q,M[U+14],17,-1502002290),Q=o(Q,$,ee,z,M[U+15],22,1236535329),z=s(z,Q,$,ee,M[U+1],5,-165796510),ee=s(ee,z,Q,$,M[U+6],9,-1069501632),$=s($,ee,z,Q,M[U+11],14,643717713),Q=s(Q,$,ee,z,M[U+0],20,-373897302),z=s(z,Q,$,ee,M[U+5],5,-701558691),ee=s(ee,z,Q,$,M[U+10],9,38016083),$=s($,ee,z,Q,M[U+15],14,-660478335),Q=s(Q,$,ee,z,M[U+4],20,-405537848),z=s(z,Q,$,ee,M[U+9],5,568446438),ee=s(ee,z,Q,$,M[U+14],9,-1019803690),$=s($,ee,z,Q,M[U+3],14,-187363961),Q=s(Q,$,ee,z,M[U+8],20,1163531501),z=s(z,Q,$,ee,M[U+13],5,-1444681467),ee=s(ee,z,Q,$,M[U+2],9,-51403784),$=s($,ee,z,Q,M[U+7],14,1735328473),Q=s(Q,$,ee,z,M[U+12],20,-1926607734),z=a(z,Q,$,ee,M[U+5],4,-378558),ee=a(ee,z,Q,$,M[U+8],11,-2022574463),$=a($,ee,z,Q,M[U+11],16,1839030562),Q=a(Q,$,ee,z,M[U+14],23,-35309556),z=a(z,Q,$,ee,M[U+1],4,-1530992060),ee=a(ee,z,Q,$,M[U+4],11,1272893353),$=a($,ee,z,Q,M[U+7],16,-155497632),Q=a(Q,$,ee,z,M[U+10],23,-1094730640),z=a(z,Q,$,ee,M[U+13],4,681279174),ee=a(ee,z,Q,$,M[U+0],11,-358537222),$=a($,ee,z,Q,M[U+3],16,-722521979),Q=a(Q,$,ee,z,M[U+6],23,76029189),z=a(z,Q,$,ee,M[U+9],4,-640364487),ee=a(ee,z,Q,$,M[U+12],11,-421815835),$=a($,ee,z,Q,M[U+15],16,530742520),Q=a(Q,$,ee,z,M[U+2],23,-995338651),z=c(z,Q,$,ee,M[U+0],6,-198630844),ee=c(ee,z,Q,$,M[U+7],10,1126891415),$=c($,ee,z,Q,M[U+14],15,-1416354905),Q=c(Q,$,ee,z,M[U+5],21,-57434055),z=c(z,Q,$,ee,M[U+12],6,1700485571),ee=c(ee,z,Q,$,M[U+3],10,-1894986606),$=c($,ee,z,Q,M[U+10],15,-1051523),Q=c(Q,$,ee,z,M[U+1],21,-2054922799),z=c(z,Q,$,ee,M[U+8],6,1873313359),ee=c(ee,z,Q,$,M[U+15],10,-30611744),$=c($,ee,z,Q,M[U+6],15,-1560198380),Q=c(Q,$,ee,z,M[U+13],21,1309151649),z=c(z,Q,$,ee,M[U+4],6,-145523070),ee=c(ee,z,Q,$,M[U+11],10,-1120210379),$=c($,ee,z,Q,M[U+2],15,718787259),Q=c(Q,$,ee,z,M[U+9],21,-343485551),z=n(z,x),Q=n(Q,V),$=n($,F),ee=n(ee,j);return i(z)+i(Q)+i($)+i(ee)}let vv=1,bv=console,wv=class{static setLogger(L){bv=L}constructor(L){fy(this,"lockingPromise",Mp.resolve()),fy(this,"locks",0),fy(this,"name",""),fy(this,"lockId",void 0),this.lockId=vv++,L&&(this.name=L),bv.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is created."))}get isLocked(){return this.locks>0}lock(L){let k;this.locks+=1,bv.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is locked, current queue ").concat(this.locks,". ").concat("string"==typeof L?L:""));const M=new Mp((M=>{k=()=>{this.locks-=1,bv.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is not locked, current queue ").concat(this.locks,". ").concat("string"==typeof L?L:"")),M()}})),U=this.lockingPromise.then((()=>k));return this.lockingPromise=this.lockingPromise.then((()=>M)),U}};function OA(L,k){return function(M,U,x){const V=x.value;if("function"!=typeof V)throw new Error("Cannot use mutex on object property.");return x.value=async function(){const M=this[k];if(!M)throw new Error("mutex property key ".concat(k," doesn't exist on ").concat(L));const x=await M.lock("From ".concat(L,".").concat(U));try{for(var F=arguments.length,j=new Array(F),z=0;z<F;z++)j[z]=arguments[z];return await V.apply(this,j)}finally{x()}},x}}const Ov={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function DA(L,k){const M=Math.floor(k.timeout*Math.pow(k.timeoutFactor,L));return Math.min(k.maxRetryTimeout,M)}function PA(L,k,M,U){const x=Object.assign({},Ov,U);let V=x.timeout;const s=async()=>{await function(L){return new Mp((k=>{window.setTimeout(k,L)}))}(V),V*=x.timeoutFactor,V=Math.min(x.maxRetryTimeout,V)};let F=!1;const j=new Mp((async(U,V)=>{k=k||(()=>!1),M=M||(()=>!0);for(let j=0;j<x.maxRetryCount;j+=1){if(F)return V(new nv(iv.OPERATION_ABORTED));try{const M=await L();if(!k(M,j))return U(M);if(j+1===x.maxRetryCount)return U(M);await s()}catch(L){if(!M(L,j))return V(L);if(j+1===x.maxRetryCount)return V(L);await s()}}}));return j.cancel=()=>F=!0,j}class LA{constructor(L){fy(this,"input",[]),fy(this,"size",void 0),this.size=L}add(L){this.input.push(L),this.input.length>this.size&&this.input.splice(0,1)}mean(){var L;return 0===this.input.length?0:kr(L=this.input).call(L,((L,k)=>L+k))/this.input.length}}let Nv,Dv=0,kv=0;function xA(L,k,M,U){return new Mp(((x,V)=>{k.responseType=k.responseType||"json",k.data&&!M?(k.data=JSON.stringify(k.data),Dv+=hA(k.data)):M&&(k.data.size?Dv+=k.data.size:k.data instanceof FormData?Dv+=pA(k.data):Dv+=hA(JSON.stringify(k.data))),k.headers=k.headers||{},k.headers["Content-Type"]=k.headers["Content-Type"]||"application/json",k.method="POST",k.url=L,KC.request(k).then((L=>{"string"==typeof L.data?kv+=hA(L.data):L.data instanceof ArrayBuffer||L.data instanceof Uint8Array?kv+=L.data.byteLength:kv+=hA(JSON.stringify(L.data)),U&&x({data:L.data,headers:L.headers}),x(L.data)})).catch((L=>{KC.isCancel(L)?V(new nv(iv.OPERATION_ABORTED,"cancel token canceled")):"ECONNABORTED"===L.code?V(new nv(iv.NETWORK_TIMEOUT,L.message)):L.response?V(new nv(iv.NETWORK_RESPONSE_ERROR,L.response.status)):V(new nv(iv.NETWORK_ERROR,L.message))}))}))}async function VA(L,k){const M=new Blob([k.data],{type:"buffer"});return await xA(L,Ty(Ty({},k),{},{data:M,headers:{"Content-Type":"application/octet-stream"}}),!0)}const FA=()=>void 0!==window.isSecureContext,Mv=function(L){if(L.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return L;const k=L.match(/([0-9]+\.[0-9]+\.[0-9]+)\-([0-9]+)/);if(k&&k[1]&&k[2]){const L=k[1],M=k[2];return"".concat(L,".").concat(M)}return"4.0.0.999"}("4.22.1"),Uv=function(){try{return!0===JSON.parse("true")}catch(L){return!0}}();let xv=function(L){return L.Default="default",L.Auto="auto",L.Relay="relay",L.SdRtn="sd-rtn",L}({});const Vv=function(){const L="us".concat("erna","me"),k="pa".concat("sswo","rd"),M=["t","s","t"];M.splice(1,0,"e");const U=M.join(""),x=[];for(let L=0;L<6;L++)x.push("1");const V=x.join(""),F={};return F[L]=U,F[k]=V,Object.assign(F,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=Vv;const Fv={MIN_FRAME_RATE:1,MAX_FRAME_RATE:30,MAX_THRESHOLD_FRAMERATE:30,BITRATE_MIN_THRESHOLD:100,BITRATE_MAX_THRESHOLD:100,MAX_SCALE:5,BWE_SCALE_UP_THRESHOLD:.6,BWE_SCALE_DOWN_THRESHOLD:.6,PERF_SCALE_UP_THRESHOLD:.7,PERF_SCALE_DOWN_THRESHOLD:.6,MOTION_RESOLUTION_FACTOR:.8,MOTION_BITRATE_FACTOR:.6,DETAIL_FRAMERATE_FACTOR:.8,DETAIL_BITRATE_FACTOR:.6,BALANCE_RESOLUTION_FACTOR:.9,BALANCE_FRAMERATE_FACTOR:.9,BALANCE_BITRATE_FACTOR:.6,OVERUSE_TIMES_THRESHOLD:10,UNDERUSE_TIMES_THRESHOLD:40},Bv="v4.22.1-0-g1c8e27e9(9/19/2024, 2:23:30 PM)",jv=Ty(Ty({PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:["CHINA","GLOBAL"],WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",ENABLE_EVENT_REPORT:!0,GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,UPLOAD_LOG:!1,NOT_REPORT_EVENT:[],PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],CONNECT_GATEWAY_WITHOUT_DOMAIN:!1,WORKER_DOMAIN:"edge.agora.io",TURN_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,PRELOAD_MEDIA_COUNT:0,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:250,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!1,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{excludedLinks:[]},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,ICE_RESTART_INTERVAL:1e4,NEW_ICE_RESTART:!1,TRANSMITTER_INITIAL_RTT:30,TRANSMITTER_INITIAL_RTO:30,TRANSMITTER_MAX_BATCH_ACK_COUNT:2,TRANSMITTER_MAX_RTO:500,DATACHANNEL_COMPRESS:!1,FINGERPRINT:null,DC_JOIN_WITH_FAILBACK:5e3,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,AP_AREA:!0,ENABLE_ENCODED_TRANSFORM:!1,ENABLE_VIDEO_SEI:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,DATASTREAM_MAX_RETRANSMITS:10,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:3e3,SHOW_P2P_LOG:!1,MAX_P2P_TIMEOUT:3e4,P2P_TOKEN_INTERVAL:1e3,SHOW_DATASTREAM2_LOG:!1,RESTRICTION_SET_PLAYBACK_DEVICE:!0,USE_PURE_ENCRYPTION_MASTER_KEY:!1,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[],USE_NEW_NETWORK_CONFIG:!1,AUTO_RESET_AUDIO_ROUTE:!1,PLUGIN_INFO:[],OVERUSE_DETECTOR_PARAMS:Fv,ENABLE_AG_ADAPTATION:!0,FORCE_AG_HIGH_FRAMERATE:!1,FORCE_SUPPORT_AG_ADAPTATION:!1,CUSTOM_ADAPTATION_DEFAULT_MODE:"",ENCODER_CONFIG_LIMIT:{},CAMERA_CAPTURE_CONFIG:void 0,HIDE_NO_POSTER:!1,AP_CACHE_NUM:10,AP_UPDATE_INTERVAL:12e4,AP_CACHE_LIFETIME:12e4,MAX_PRELOAD_ASYNC_LENGTH:3,ENABLE_PRELOAD:!0,DISABLE_SCREEN_SHARE_REMB:!1},{ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,ENABLE_USER_LICENSE_CHECK:!0,USE_PUB_RTX:!0,USE_SUB_RTX:!0,DISABLE_FEC:void 0,ENABLE_NTP_REPORT:!1,ENABLE_INSTANT_VIDEO:!1,ENABLE_DATASTREAM_2:!1,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,USE_XR:!0,ENABLE_LOSSBASED_BWE:!0,ENABLE_AUT_CC:!1,ENABLE_CC_FALLBACK:void 0,ENABLE_PREALLOC_PC:!1,SUBSCRIBE_TWCC:!0,PUBLISH_TWCC:!1,ENABLE_SVC:!1,ENABLE_SVC_DEFAULT_CODECS:["H264","VP8","VP9","AV1"],SVC:[],ENABLE_FULL_LINK_AV_SYNC:!1,SVC_MODE:null,PRE_SUB_NUM:2,ENABLE_PRE_SUB:!1,ENABLE_AUT_FEEDBACK:!1}),{},{USE_CANDIDATE_FROM_AP_DETAIL:!1,AP_REQUEST_DETAIL:void 0});function qA(L,k,M){var U,x,V;Sr(U=Object.keys(jv)).call(U,L)&&(!M&&Sr(x=Object.keys(eb)).call(x,L)||(jv[L]=k,"ENABLE_VIDEO_SEI"===L&&!0===k&&(jv.ENABLE_ENCODED_TRANSFORM=!0),"USE_NEW_NETWORK_CONFIG"===L&&k&&(V=!!k,jv.USE_NEW_NETWORK_CONFIG=V,V&&(jv.WEBCS_DOMAIN=["webrtc2-2.ap.sd-rtn.com"],jv.WEBCS_DOMAIN_BACKUP_LIST=["webrtc2-4.ap.sd-rtn.com"],jv.CDS_AP=["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],jv.ACCOUNT_REGISTER=["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],jv.EVENT_REPORT_DOMAIN="web-2.statscollector.sd-rtn.com",jv.EVENT_REPORT_BACKUP_DOMAIN="statscollector-1.agora.io",jv.GATEWAY_DOMAINS=["edge.sd-rtn.com"])),"ENABLE_PRE_SUB"===L&&k&&(jv.ENABLE_INSTANT_VIDEO=!0,jv.ENABLE_PREALLOC_PC=!0),"ENABLE_SVC"===L&&k&&(jv.ENABLE_AUT_CC=!0)))}function zA(L){return jv[L]}Uv||(jv.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],jv.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],jv.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],jv.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],jv.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],jv.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],jv.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",jv.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",jv.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",jv.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",jv.AREAS=["NORTH_AMERICA","OVERSEA"]);const eb={};var tb=function(L){return L.SET_SESSION_ID="SET_SESSION_ID",L.SET_P2P_ID="SET_P2P_id",L.SET_DC_ID="SET_DC_id",L.SET_UID="SET_UID",L.SET_INT_UID="SET_INT_UID",L.SET_PUB_ID="SET_PUB_ID",L.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",L.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",L.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",L.AVOID_JOIN_START="AVOID_JOIN_START",L.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",L.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",L.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",L.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",L.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",L.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",L.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",L.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",L.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",L.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",L.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",L.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",L.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",L.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",L.RESET_KEY_METRICS="RESET_KEY_METRICS",L.SET_USE_P2P="SET_USE_P2P",L.SET_TRANSPORT_TYPE="SET_TRANSPORT_TYPE",L}(tb||{});class QA{constructor(L,k,M,U){fy(this,"state",void 0),this.state={codec:L,audioCodec:k,mode:M,clientId:U,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,avoidJoinStart:0,keyMetrics:{publish:[],subscribe:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useP2P:!1,p2pTransport:xv.Default}}dispatch(L){this.state=function(L,k){switch(k.type){case tb.SET_SESSION_ID:return Ty(Ty({},L),{},{sessionId:k.sessionId});case tb.SET_P2P_ID:return Ty(Ty({},L),{},{p2pId:k.p2pId});case tb.SET_UID:return Ty(Ty({},L),{},{uid:k.uid});case tb.SET_INT_UID:return Ty(Ty({},L),{},{intUid:k.intUid});case tb.SET_PUB_ID:return Ty(Ty({},L),{},{pubId:k.pubId});case tb.KEY_METRIC_CLIENT_CREATED:return Ty(Ty({},L),{},{keyMetrics:Ty(Ty({},L.keyMetrics),{},{clientCreated:k.metric})});case tb.KEY_METRIC_JOIN_START:return Ty(Ty({},L),{},{keyMetrics:Ty(Ty({},L.keyMetrics),{},{joinStart:k.metric})});case tb.AVOID_JOIN_START:return Ty(Ty({},L),{},{avoidJoinStart:k.avoidJoinStart});case tb.KEY_METRIC_JOIN_END:return Ty(Ty({},L),{},{keyMetrics:Ty(Ty({},L.keyMetrics),{},{joinEnd:k.metric})});case tb.KEY_METRIC_REQUEST_AP_START:return Ty(Ty({},L),{},{keyMetrics:Ty(Ty({},L.keyMetrics),{},{requestAPStart:k.metric})});case tb.KEY_METRIC_REQUEST_AP_END:return Ty(Ty({},L),{},{keyMetrics:Ty(Ty({},L.keyMetrics),{},{requestAPEnd:k.metric})});case tb.KEY_METRIC_JOIN_GATEWAY_START:return Ty(Ty({},L),{},{keyMetrics:Ty(Ty({},L.keyMetrics),{},{joinGatewayStart:k.metric})});case tb.KEY_METRIC_JOIN_GATEWAY_END:return Ty(Ty({},L),{},{keyMetrics:Ty(Ty({},L.keyMetrics),{},{joinGatewayEnd:k.metric})});case tb.KEY_METRIC_PEER_CONNECTION_START:return Ty(Ty({},L),{},{keyMetrics:Ty(Ty({},L.keyMetrics),{},{peerConnectionStart:k.metric})});case tb.KEY_METRIC_PEER_CONNECTION_END:return Ty(Ty({},L),{},{keyMetrics:Ty(Ty({},L.keyMetrics),{},{peerConnectionEnd:k.metric})});case tb.KEY_METRIC_DESCRIPTION_START:return Ty(Ty({},L),{},{keyMetrics:Ty(Ty({},L.keyMetrics),{},{descriptionStart:k.metric})});case tb.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return Ty(Ty({},L),{},{keyMetrics:Ty(Ty({},L.keyMetrics),{},{signalChannelOpen:k.metric})});case tb.KEY_METRIC_ICE_CONNECTION_END:return Ty(Ty({},L),{},{keyMetrics:Ty(Ty({},L.keyMetrics),{},{iceConnectionEnd:k.metric})});case tb.KEY_METRIC_PUBLISH:{const M=L.keyMetrics.publish,U=M.findIndex((L=>L.trackId===k.metric.trackId));return-1!==U?(M[U]=Ty(Ty({},M[U]),k.metric),Ty(Ty({},L),{},{keyMetrics:Ty(Ty({},L.keyMetrics),{},{publish:[...M]})})):Ty(Ty({},L),{},{keyMetrics:Ty(Ty({},L.keyMetrics),{},{publish:[...L.keyMetrics.publish,k.metric]})})}case tb.KEY_METRIC_SUBSCRIBE:{const M=L.keyMetrics.subscribe,U=M.findIndex((L=>L.userId===k.metric.userId&&L.type===k.metric.type));return-1!==U?(M[U]=Ty(Ty({},M[U]),k.metric),Ty(Ty({},L),{},{keyMetrics:Ty(Ty({},L.keyMetrics),{},{subscribe:[...M]})})):Ty(Ty({},L),{},{keyMetrics:Ty(Ty({},L.keyMetrics),{},{subscribe:[...L.keyMetrics.subscribe,k.metric]})})}case tb.SET_CLOUD_PROXY_SERVER_MODE:return L.cloudProxyServerMode=k.mode,L;case tb.RECORD_JOIN_CHANNEL_SERVICE:return"number"!=typeof k.index?L.joinChannelServiceRecords=[...L.joinChannelServiceRecords,k.record]:(L.joinChannelServiceRecords[k.index]=Ty(Ty({},L.joinChannelServiceRecords[k.index]),k.record),L.joinChannelServiceRecords=[...L.joinChannelServiceRecords]),L;case tb.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return L.joinChannelServiceRecords=[],L;case tb.RESET_KEY_METRICS:return L.keyMetrics={publish:[],subscribe:[]},L;case tb.SET_USE_P2P:return Ty(Ty({},L),{},{useP2P:k.val});case tb.SET_TRANSPORT_TYPE:return Ty(Ty({},L),{},{p2pTransport:k.val});default:return L}}(this.state,L)}set sessionId(L){this.dispatch({type:tb.SET_SESSION_ID,sessionId:L})}get sessionId(){return this.state.sessionId}set codec(L){this.state.codec=L}get codec(){return this.state.codec}get mode(){return this.state.mode}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(L){this.dispatch({type:tb.SET_P2P_ID,p2pId:L})}get p2pId(){return this.state.p2pId}set dcId(L){this.dispatch({type:tb.SET_DC_ID,dcId:L})}get dcId(){return this.state.dcId}set uid(L){this.dispatch({type:tb.SET_UID,uid:L})}get uid(){return this.state.uid}set intUid(L){this.dispatch({type:tb.SET_INT_UID,intUid:L})}get intUid(){return this.state.intUid}set pubId(L){this.dispatch({type:tb.SET_PUB_ID,pubId:L})}get pubId(){return this.state.pubId}set cloudProxyServerMode(L){this.dispatch({type:tb.SET_CLOUD_PROXY_SERVER_MODE,mode:L})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useP2P(L){this.dispatch({type:tb.SET_USE_P2P,val:L})}get useP2P(){return this.state.useP2P}set p2pTransport(L){this.dispatch({type:tb.SET_TRANSPORT_TYPE,val:L})}get p2pTransport(){return this.state.p2pTransport}clientCreated(){this.dispatch({type:tb.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:tb.KEY_METRIC_JOIN_START,metric:Date.now()})}joinEnd(){this.dispatch({type:tb.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:tb.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:tb.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:tb.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:tb.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:tb.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:tb.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}descriptionStart(){this.dispatch({type:tb.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:tb.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:tb.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(L,k,M,U){this.dispatch({type:tb.KEY_METRIC_PUBLISH,metric:Ty(Ty({trackId:L,type:k},M&&{publishStart:M}),U&&{publishEnd:U})})}subscribe(L,k,M,U,x,V,F){this.dispatch({type:tb.KEY_METRIC_SUBSCRIBE,metric:Ty(Ty(Ty(Ty(Ty({userId:L,type:k},M&&{subscribeStart:M}),U&&{subscribeEnd:U}),x&&{firstFrame:x}),V&&{streamAdded:V}),F&&{firstDecoded:F})})}massSubscribe(L,k,M,U){L.forEach((L=>{this.dispatch({type:tb.KEY_METRIC_SUBSCRIBE,metric:Ty(Ty(Ty({userId:L.userId,type:L.type},k&&{subscribeStart:k}),M&&{subscribeEnd:M}),U&&{firstFrame:U})})}))}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(L,k){"gateway"===L.service&&Array.isArray(L.urls)&&(L.urls=L.urls.map((L=>L.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2"))));try{return"number"!=typeof k?(this.dispatch({type:tb.RECORD_JOIN_CHANNEL_SERVICE,record:Ty(Ty({},L),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(k<0||k>=this.state.joinChannelServiceRecords.length||this.dispatch({type:tb.RECORD_JOIN_CHANNEL_SERVICE,record:L,index:k}),k)}catch(L){return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:tb.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:tb.RESET_KEY_METRICS})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch(L){return[]}}get avoidJoinStart(){return this.state.avoidJoinStart}set avoidJoinStart(L){this.dispatch({type:tb.AVOID_JOIN_START,avoidJoinStart:L})}}let ib=function(L){return L.h264="h264",L.h265="h265",L.vp8="vp8",L.vp9="vp9",L.av1="av1",L}({});!function(L){L.opus="opus",L.pcma="pcma",L.pcmu="pcmu",L.g722="g722"}({});const nb=10;let ab=0;function rb(L,k,M){return(k=function(L){var k=function(L,k){if("object"!=typeof L||!L)return L;var M=L[Symbol.toPrimitive];if(void 0!==M){var U=M.call(L,"string");if("object"!=typeof U)return U;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(L)}(L);return"symbol"==typeof k?k:k+""}(k))in L?Object.defineProperty(L,k,{value:M,enumerable:!0,configurable:!0,writable:!0}):L[k]=M,L}function ob(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function sb(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?ob(Object(M),!0).forEach((function(k){rb(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):ob(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}const ub=new class extends My{constructor(){super(...arguments),rb(this,"currentUploadLogID",0)}reportLogUploadError(L){const{errorRange:k}=L;k[k.length-1]&&k[k.length-1]>this.currentUploadLogID&&(this.currentUploadLogID=k[k.length-1],this.emit("REPORT_LOG_UPLOAD",L))}};class cb{constructor(L){rb(this,"logger",void 0),rb(this,"prefixLists",[]),this.logger=L}debug(){for(var L=arguments.length,k=new Array(L),M=0;M<L;M++)k[M]=arguments[M];this.logger.debug(...this.prefixLists,...k)}info(){for(var L=arguments.length,k=new Array(L),M=0;M<L;M++)k[M]=arguments[M];this.logger.info(...this.prefixLists,...k)}warning(){for(var L=arguments.length,k=new Array(L),M=0;M<L;M++)k[M]=arguments[M];this.logger.warning(...this.prefixLists,...k)}error(){for(var L=arguments.length,k=new Array(L),M=0;M<L;M++)k[M]=arguments[M];this.logger.error(...this.prefixLists,...k)}prefix(L){return this.prefixLists.push(L),this}popPrefix(){return this.prefixLists.pop(),this}}function db(){const L=new Date;return L.toTimeString().split(" ")[0]+":"+L.getMilliseconds()}function lb(){const L=new Date,k=/((\d+:){2}\d+)/.exec((new Date).toUTCString());return k?(null==k?void 0:k[0])+":"+L.getUTCMilliseconds():L.toTimeString().split(" ")[0]+":"+L.getMilliseconds()}const hb={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},_b=Date.now(),pb=L=>{for(const k in hb)if(Object.prototype.hasOwnProperty.call(hb,k)&&hb[k]===L)return k;return"DEFAULT"},Eb=new class{constructor(){rb(this,"proxyServerURL",void 0),rb(this,"logLevel",hb.DEBUG),rb(this,"uploadState","collecting"),rb(this,"uploadLogWaitingList",[]),rb(this,"uploadLogUploadingList",[]),rb(this,"uploadErrorCount",0),rb(this,"currentLogID",0),rb(this,"url",void 0),rb(this,"extLog",((L,k)=>{this.appendLogToWaitingList(L,...k)}))}debug(){for(var L=arguments.length,k=new Array(L),M=0;M<L;M++)k[M]=arguments[M];const U=[hb.DEBUG].concat(k);this.log.apply(this,U)}info(){for(var L=arguments.length,k=new Array(L),M=0;M<L;M++)k[M]=arguments[M];const U=[hb.INFO].concat(k);this.log.apply(this,U)}warning(){for(var L=arguments.length,k=new Array(L),M=0;M<L;M++)k[M]=arguments[M];const U=[hb.WARNING].concat(k);this.log.apply(this,U)}warn(){this.warning(...arguments)}error(){for(var L=arguments.length,k=new Array(L),M=0;M<L;M++)k[M]=arguments[M];const U=[hb.ERROR].concat(k);this.log.apply(this,U)}upload(){for(var L=arguments.length,k=new Array(L),M=0;M<L;M++)k[M]=arguments[M];const U=[hb.DEBUG].concat(k);this.uploadLog.apply(this,U)}setLogLevel(L){L=Math.min(Math.max(0,L),4),this.logLevel=L}enableLogUpload(){qA("UPLOAD_LOG",!0)}disableLogUpload(){qA("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(L){this.proxyServerURL=L}prefix(L){return new cb(this).prefix(L)}log(){for(var L=arguments.length,k=new Array(L),M=0;M<L;M++)k[M]=arguments[M];if(Date.now()-_b<100)return void setTimeout((()=>{this.log(...k)}),Date.now()-_b);const U=Math.max(0,Math.min(4,k[0]));if(k[0]=db()+" Agora-SDK [".concat(pb(U),"]:"),this.appendLogToWaitingList(U,...k),U<this.logLevel)return;const x=db()+" %cAgora-SDK [".concat(pb(U),"]:");let V=[];if(!zA("USE_NEW_LOG"))switch(U){case hb.DEBUG:V=[x,"color: #64B5F6;"].concat(k.slice(1)),console.log.apply(console,V);break;case hb.INFO:V=[x,"color: #1E88E5; font-weight: bold;"].concat(k.slice(1)),console.log.apply(console,V);break;case hb.WARNING:V=[x,"color: #FB8C00; font-weight: bold;"].concat(k.slice(1)),console.warn.apply(console,V);break;case hb.ERROR:V=[x,"color: #B00020; font-weight: bold;"].concat(k.slice(1)),console.error.apply(console,V)}}uploadLog(){for(var L=arguments.length,k=new Array(L),M=0;M<L;M++)k[M]=arguments[M];if(Date.now()-_b<100)return void setTimeout((()=>{this.uploadLog(...k)}),Date.now()-_b);const U=Math.max(0,Math.min(4,k[0]));k[0]=db()+" Agora-SDK [".concat(pb(U),"]:"),this.appendLogToWaitingList(U,...k)}appendLogToWaitingList(L){if(!zA("UPLOAD_LOG"))return;for(var k=arguments.length,M=new Array(k>1?k-1:0),U=1;U<k;U++)M[U-1]=arguments[U];Array.isArray(M[0])?M[0][0]=lb()+" Agora-SDK [".concat(pb(L),"]:"):M[0]=lb()+" Agora-SDK [".concat(pb(L),"]:");let x="";M.forEach((L=>{"object"==typeof L&&(L=JSON.stringify(L)),x+="".concat(L," ")})),this.uploadLogWaitingList.push({payload_str:x,log_level:L,log_item_id:this.currentLogID++}),"uploading"===this.uploadState&&0===this.uploadLogUploadingList.length&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",0===this.uploadLogUploadingList.length&&this.uploadLogInterval()}async uploadLogs(){const L=this.uploadLogUploadingList,k={sdk_version:Mv,process_id:zA("PROCESS_ID"),payload:JSON.stringify(L)};return PA((async()=>{const L=await KC.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(zA("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(zA("LOG_UPLOAD_SERVER"),"/upload/v1")),k,{responseType:"text"});if("OK"!==L.data){const k=new Error("unexpected upload log response");throw k.response=L,k}}),(()=>(this.uploadLogUploadingList=[],!1)),(k=>{const M={status:-1,message:k.message,errorRange:L.map((L=>L.log_item_id))};return k.response?(M.status=k.response.status,M.data=k.response.data,M.headers=k.response.headers):k.request&&(M.status=k.request.status),ub.reportLogUploadError(M),!0}),{timeout:zA("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:zA("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){0===this.uploadLogUploadingList.length&&0===this.uploadLogWaitingList.length||(0===this.uploadLogUploadingList.length&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,zA("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then((()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout((()=>this.uploadLogInterval()),zA("UPLOAD_LOG_INTERVAL"))})).catch((L=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout((()=>this.uploadLogInterval()),zA("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout((()=>this.uploadLogInterval()),zA("UPLOAD_LOG_RETRY_INTERVAL_V1"))})))}};var mb;function fb(L){return yy(L.reportId,"params.reportId",0,100,!1),yy(L.category,"params.category",0,100,!1),yy(L.event,"params.event",0,100,!1),yy(L.label,"params.label",0,100,!1),Iy(L.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}(mb={}).FREE="free",mb.UPLOADING="uploading",function(L){L[L.MISC=0]="MISC",L[L.INTERNAL_EVENT=1]="INTERNAL_EVENT",L[L.PUBLIC_EVENT=2]="PUBLIC_EVENT",L[L.WEB_EVENT=3]="WEB_EVENT",L[L.INTERNAL_API=4]="INTERNAL_API",L[L.WEB_API=5]="WEB_API",L[L.PUBLIC_API=6]="PUBLIC_API"}({});const gb={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0};let Tb=function(L){return L.PUBLISH="publish",L.SUBSCRIBE="subscribe",L.WS_COMPRESSOR_INIT="ws_compressor_init",L.SESSION_INIT="session_init",L.JOIN_CHOOSE_SERVER="join_choose_server",L.REQ_USER_ACCOUNT="req_user_account",L.JOIN_GATEWAY="join_gateway",L.REJOIN_GATEWAY="rejoin_gateway",L.STREAM_SWITCH="stream_switch",L.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",L.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",L.FIRST_VIDEO_RECEIVED="first_video_received",L.FIRST_AUDIO_RECEIVED="first_audio_received",L.FIRST_VIDEO_DECODE="first_video_decode",L.FIRST_AUDIO_DECODE="first_audio_decode",L.ON_ADD_AUDIO_STREAM="on_add_audio_stream",L.ON_ADD_VIDEO_STREAM="on_add_video_stream",L.ON_UPDATE_STREAM="on_update_stream",L.ON_REMOVE_STREAM="on_remove_stream",L.USER_ANALYTICS="req_user_analytics",L.PC_STATS="pc_stats",L.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities",L}({}),Sb=function(L){return L.SESSION="io.agora.pb.Wrtc.Session",L.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",L.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",L.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",L.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",L.PUBLISH="io.agora.pb.Wrtc.Publish",L.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",L.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",L.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",L.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",L.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",L.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",L.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",L.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",L.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",L.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",L.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",L.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",L.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",L.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",L.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",L.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",L.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",L.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",L.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",L.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",L.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",L.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",L.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",L.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",L.PC_STATS="io.agora.pb.Wrtc.PCStats",L.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities",L}({});!function(L){L[L.WORKER_EVENT=156]="WORKER_EVENT",L[L.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"}({});let yb=function(L){return L[L.SESSION=26]="SESSION",L[L.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",L[L.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",L[L.JOIN_GATEWAY=28]="JOIN_GATEWAY",L[L.PUBLISH=30]="PUBLISH",L[L.SUBSCRIBE=29]="SUBSCRIBE",L[L.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",L[L.STREAM_SWITCH=32]="STREAM_SWITCH",L[L.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",L[L.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",L[L.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",L[L.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",L[L.API_INVOKE=41]="API_INVOKE",L[L.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",L[L.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",L[L.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",L[L.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",L[L.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",L[L.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",L[L.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",L[L.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",L[L.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",L[L.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",L[L.WORKER_EVENT=156]="WORKER_EVENT",L[L.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",L[L.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",L[L.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",L[L.USER_ANALYTICS=1e4]="USER_ANALYTICS",L[L.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED",L}({});function Rb(){let L=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(k,M,U){const x=U.value;if("function"==typeof x){const V=L.className||k.__className__||("AgoraRTCClient"===k.constructor.name?"Client":k.constructor.name);U.value=function(){for(var k=arguments.length,U=new Array(k),F=0;F<k;F++)U[F]=arguments[F];let j=U;if(L.argsMap)try{j=L.argsMap(this,...U)}catch(L){Eb.warning(L),j=[]}try{JSON.stringify(j)}catch(L){Eb.warning("arguments for method ".concat(V,".").concat(String(M)," not serializable for apiInvoke.")),j=[]}const z=(L.report||Ab).reportApiInvoke(this._sessionId||null,{name:"".concat(V,".").concat(String(M)),options:j,tag:lv.TRACER,reportResult:L.reportResult},L.throttleTime);try{const k=x.apply(this,U);return k instanceof Mp?k.then((k=>(z.onSuccess(L.reportResult&&k),k))).catch((L=>{throw z.onError(L),L})):(z.onSuccess(L.reportResult&&k),k)}catch(L){throw z.onError(L),L}}}return U}}const Ab=new class{constructor(){rb(this,"baseInfoMap",new Map),rb(this,"proxyServer",void 0),rb(this,"eventUploadTimer",void 0),rb(this,"setSessionIdTimer",void 0),rb(this,"url",void 0),rb(this,"sids",new Set),rb(this,"backupUrl",void 0),rb(this,"_appId",void 0),rb(this,"keyEventUploadPendingItems",[]),rb(this,"normalEventUploadPendingItems",[]),rb(this,"apiInvokeUploadPendingItems",[]),rb(this,"apiInvokeCount",0),rb(this,"ltsList",[]),rb(this,"lastSendNormalEventTime",Date.now()),rb(this,"customReportCounterTimer",void 0),rb(this,"customReportCount",0),rb(this,"extApiInvoke",(async L=>{for(const k of L){const L=sb(sb({},k),{},{sid:null,invokeId:++this.apiInvokeCount,tag:lv.TRACER});this.sendApiInvoke(L)}})),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),zA("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),zA("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(L){return this.baseInfoMap.get(L)}adjustSessionStartTime(L){if(!this.baseInfoMap.has(L)&&!this.baseInfoMap.get(L))return void Eb.error("adjust session ".concat(L," start time, sid is not exist or info is undefined"));const k=this.baseInfoMap.get(L),M=Date.now(),U=k.startTime;k.startTime=M,Eb.debug("rewrite session ".concat(L," startTime: ").concat(M," , ").concat(M-U,"ms")),this.baseInfoMap.set(L,k)}setAppId(L){this._appId=L}reportApiInvoke(L,k,M){k.timeout=k.timeout||6e4,k.reportResult=void 0===k.reportResult||k.reportResult;const U=Date.now();this.apiInvokeCount+=1;const x=this.apiInvokeCount,o=()=>({tag:k.tag,invokeId:x,sid:L,name:k.name,apiInvokeTime:U,options:k.options,states:k.states||null}),V=!!zA("SHOW_REPORT_INVOKER_LOG");V&&Eb.info("".concat(k.name," start"),k.options);let F=!1;EA(k.timeout).then((()=>{F||(this.sendApiInvoke(sb(sb({},o()),{},{error:iv.API_INVOKE_TIMEOUT,success:!1})),Eb.debug("".concat(k.name," timeout")))}));const j=new nv(iv.UNEXPECTED_ERROR,"".concat(k.name,": this api invoke is end"));return{onSuccess:L=>{const n=()=>{if(F)throw j;return F=!0,this.sendApiInvoke(sb(sb({},o()),{},{success:!0},k.reportResult&&{result:L})),V&&Eb.info("".concat(k.name," onSuccess")),L};return M?Cv(n,k.name+"Success",M,(()=>F=!0)):n()},onError:L=>{const n=()=>{if(F)throw L;F=!0,this.sendApiInvoke(sb(sb({},o()),{},{success:!1,error:L})),V&&Eb.info("".concat(k.name," onFailure"),L.toString())};return M?Cv(n,k.name+"Error",M,(()=>F=!0)):n()}}}sessionInit(L,k){if(this.baseInfoMap.has(L))return;const M=Date.now(),U=this.createBaseInfo(L,M);U.cname=k.cname;const x=Object.assign({},{willUploadConsoleLog:zA("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:Uv?"global":"oversea",areas:zA("AREAS")&&zA("AREAS").join(",")},k.extend),{stringUid:V,channelProfile:F,channelMode:j,isABTestSuccess:z,lsid:Q,clientRole:$}=k,ee=Date.now(),te=sb(sb({},U),{},{eventType:Tb.SESSION_INIT,appid:k.appid,browser:navigator.userAgent,buildFormat:k.buildFormat,build:Bv,lts:ee,elapse:ee-M,extend:JSON.stringify(x),mode:k.mode,process:zA("PROCESS_ID"),appType:zA("APP_TYPE"),success:!0,version:Mv,stringUid:V,channelProfile:F,channelMode:j,isABTestSuccess:z,lsid:Q,clientType:Sr(ie=window.navigator.userAgent).call(ie,"AgoraWebView")?42:20,clientRole:$,serviceId:zA("PROCESS_ID"),extensionID:zA("PLUGIN_INFO").join(",")||""});var ie;this.send({type:Sb.SESSION,data:te},!0)}joinChooseServer(L,k){const M=this.baseInfoMap.get(L);if(!M)return;const U=M.info,x=Date.now(),V=sb(sb({},U),{},{eventType:Tb.JOIN_CHOOSE_SERVER,lts:x,eventElapse:k.elapse||x-k.lts,chooseServerAddr:k.csAddr,errorCode:k.ec,elapse:x-M.startTime,success:k.succ,chooseServerAddrList:JSON.stringify(k.serverList),uid:k.uid?parseInt(k.uid):null,cid:k.cid?parseInt(k.cid):null,chooseServerIp:k.csIp||"",opid:k.opid,unilbsServerIds:k.unilbsServerIds,extend:k.extend||void 0,isHttp3:k.isHttp3,corssRegionTagReq:k.corssRegionTagReq||void 0,corssRegionTagRes:k.corssRegionTagRes||void 0});this.send({type:Sb.JOIN_CHOOSE_SERVER,data:V},!0)}reqUserAccount(L,k){const M=this.baseInfoMap.get(L);if(!M)return;const U=M.info,x=Date.now(),V=sb(sb({},U),{},{eventType:Tb.REQ_USER_ACCOUNT,lts:x,success:k.success,serverAddress:k.serverAddr,stringUid:k.stringUid,uid:k.uid,errorCode:k.errorCode,elapse:k.elapse||x-M.startTime,eventElapse:x-k.lts,extend:JSON.stringify(k.extend)});this.send({type:Sb.REQ_USER_ACCOUNT,data:V},!0)}joinGateway(L,k){const M=this.baseInfoMap.get(L);if(!M)return;const U=M.info;k.vid&&(U.vid=k.vid),U.uid=k.uid,U.cid=k.cid;const x=Date.now(),{firstSuccess:V,avoidJoinStartTime:F}=k,j=x-(V&&F?F:M.startTime),z=sb(sb({},U),{},{eventType:Tb.JOIN_GATEWAY,lts:x,gatewayAddr:k.addr,success:k.succ,errorCode:k.ec,errorMsg:k.errorMsg||"",elapse:j,eventElapse:x-k.lts,firstSuccess:V,signalChannel:k.signalChannel,preload:k.preload?1:0});k.succ&&(M.lastJoinSuccessTime=x),this.send({type:Sb.JOIN_GATEWAY,data:z},!0)}joinChannelTimeout(L,k){const M=this.baseInfoMap.get(L);if(!M)return;const U=Date.now(),x=sb(sb({},M.info),{},{lts:U,timeout:k,elapse:U-M.startTime});this.send({type:Sb.JOIN_CHANNEL_TIMEOUT,data:x},!0)}publish(L,k){const M=this.baseInfoMap.get(L);if(!M)return;const U=M.info,x=Date.now(),V=sb(sb({},U),{},{eventType:Tb.PUBLISH,lts:x,eventElapse:k.eventElapse,elapse:x-M.startTime,success:k.succ,errorCode:k.ec,videoName:k.videoName,audioName:k.audioName,screenName:k.screenName,screenshare:k.screenshare,audio:k.audio,video:k.video,p2pid:k.p2pid,publishRequestid:k.publishRequestid});this.send({type:Sb.PUBLISH,data:V},!0)}subscribe(L,k,M){const U=this.baseInfoMap.get(L);if(!U)return;const x=U.info,V=Date.now(),F=sb(sb({},x),{},{eventType:Tb.SUBSCRIBE,lts:V,eventElapse:k.eventElapse,elapse:V-U.startTime,success:k.succ,errorCode:k.ec,video:k.video,audio:k.audio,subscribeRequestid:k.subscribeRequestid,p2pid:k.p2pid,preSsrc:k.preSsrc?1:0},M&&{extend:JSON.stringify({isMassSubscribe:!0})});"string"==typeof k.peerid?F.peerSuid=k.peerid:F.peer=k.peerid,this.send({type:Sb.SUBSCRIBE,data:F},!0)}wsCompressorInit(L){var k;const M=[...w_(k=this.baseInfoMap).call(k)],U=M.length?M[0]:"UnableToGetSid",x=this.baseInfoMap.get(U);if(!x)return;const V=x.info,F=Date.now(),j=sb(sb({},V),{},{eventType:Tb.WS_COMPRESSOR_INIT,lts:F,eventElapse:L.eventElapse,elapse:F-x.startTime,status:L.status?1:2});this.send({type:Sb.WS_COMPRESSOR_INIT,data:j},!0)}firstRemoteVideoDecode(L,k,M,U){const x=this.baseInfoMap.get(L);if(!x)return;const V=x.info,F=Date.now(),j=sb(sb(sb({},V),U),{},{elapse:F-x.startTime,eventType:k,lts:F,firstDecodeFrame:Math.max((U.firstFrame||F)-x.startTime,0),apEnd:Math.max(U.apEnd-x.startTime,0),apStart:Math.max(U.apStart-x.startTime,0),joinGwEnd:Math.max(U.joinGwEnd-x.startTime,0),joinGwStart:Math.max(U.joinGwStart-x.startTime,0),pcEnd:Math.max(U.pcEnd-x.startTime,0),pcStart:Math.max(U.pcStart-x.startTime,0),subscriberEnd:Math.max(U.subscriberEnd-x.startTime,0),subscriberStart:Math.max(U.subscriberStart-x.startTime,0),videoAddNotify:Math.max(U.videoAddNotify-x.startTime,0)});this.send({type:M,data:j},!0)}firstRemoteFrame(L,k,M,U){const x=this.baseInfoMap.get(L);if(!x)return;const V=x.info,F=Date.now(),j=sb(sb(sb({},V),U),{},{elapse:F-x.startTime,eventType:k,lts:F});this.send({type:M,data:j},!0)}pcStats(L,k){const M=this.baseInfoMap.get(L);if(!M)return;const U=M.info,x=Date.now(),V=sb(sb(sb({},U),k),{},{vid:void 0===U.vid?0:Number(U.vid),elapse:x-M.startTime,eventType:Tb.PC_STATS,lts:x,preallocation:k.preallocation?1:0});this.send({type:Sb.PC_STATS,data:V},!0)}updateRemoteRTPCapabilities(L,k){if(L){const M=this.baseInfoMap.get(L);if(!M)return;const U=M.info,x=Date.now(),V=sb(sb(sb({},U),k),{},{vid:void 0===U.vid?0:Number(U.vid),eventType:Tb.UPDATE_REMOTE_RTPCAPABILITIES,lts:x});this.send({type:Sb.UPDATE_REMOTE_RTPCAPABILITIES,data:V},!0)}}onGatewayStream(L,k,M,U){const x=this.baseInfoMap.get(L);if(!x)return;const V=x.info,F=Date.now(),j=sb(sb(sb({},V),U),{},{eventType:k,lts:F});this.send({type:M,data:j},!0)}streamSwitch(L,k){const M=this.baseInfoMap.get(L);if(!M)return;const U=M.info,x=Date.now(),V=sb(sb({},U),{},{eventType:Tb.STREAM_SWITCH,lts:x,isDual:k.isdual,elapse:x-M.startTime,success:k.succ});this.send({type:Sb.STREAM_SWITCH,data:V},!0)}requestProxyAppCenter(L,k){const M=this.baseInfoMap.get(L);if(!M)return;const U=M.info,x=Date.now(),V=sb(sb({},U),{},{eventType:Tb.REQUEST_PROXY_APPCENTER,lts:x,eventElapse:x-k.lts,elapse:x-M.startTime,APAddr:k.APAddr,workerManagerList:k.workerManagerList,response:k.response,errorCode:k.ec,success:k.succ});this.send({type:Sb.REQUEST_PROXY_APPCENTER,data:V},!0)}requestProxyWorkerManager(L,k){const M=this.baseInfoMap.get(L);if(!M)return;const U=M.info,x=Date.now(),V=sb(sb({},U),{},{eventType:Tb.REQUEST_PROXY_WORKER_MANAGER,lts:x,eventElapse:x-k.lts,elapse:x-M.startTime,workerManagerAddr:k.workerManagerAddr,response:k.response,errorCode:k.ec,success:k.succ});this.send({type:Sb.REQUEST_PROXY_WORKER_MANAGER,data:V},!0)}setProxyServer(L){this.proxyServer=L,L?Eb.debug("reportProxyServerurl: ".concat(L)):Eb.debug("disable reportProxyServerurl: ".concat(L))}peerPublishStatus(L,k){const M=this.baseInfoMap.get(L);if(!M)return;const U=M.info,x=Date.now(),V=sb(sb({},U),{},{subscribeElapse:k.subscribeElapse,peer:k.peer,peerPublishDuration:Math.max(k.audioPublishDuration,k.videoPublishDuration),audiotag:k.audioPublishDuration>0?1:-1,videotag:k.videoPublishDuration>0?1:-1,lts:x,elapse:x-M.startTime,joinChannelSuccessElapse:x-(M.lastJoinSuccessTime||x),peerPublishDurationVideo:k.videoPublishDuration,peerPublishDurationAudio:k.audioPublishDuration});this.send({type:Sb.PEER_PUBLISH_STATUS,data:V},!0)}workerEvent(L,k){const M=this.baseInfoMap.get(L);if(!M)return;const U=M.info,x=Date.now();(function(L,k,M){const U=L[k];if(!U||"string"!=typeof U)return[L];L[k]="";const x=hA(JSON.stringify(L));let V=0;const F=[];let j=0;for(let M=0;M<U.length;M++)j+=U.charCodeAt(M)<=127?1:3,j<=1300-x||(F[F.length]=Ty(Ty({},L),{},{[k]:U.substring(V,M)}),V=M,j=U.charCodeAt(M)<=127?1:3);return V!==U.length-1&&(F[F.length]=Ty(Ty({},L),{},{[k]:U.substring(V)})),F})(sb(sb(sb({},U),k),{},{elapse:x-M.startTime,lts:x,productType:"WebRTC"}),"payload").forEach((L=>this.send({type:Sb.WORKER_EVENT,data:L},!0)))}apworkerEvent(L,k){const M=this.baseInfoMap.get(L);if(!M)return;const U=M.info,x=Date.now(),V=sb(sb(sb({},U),k),{},{elapse:x-M.startTime,lts:x});this.send({type:Sb.AP_WORKER_EVENT,data:V},!0)}joinWebProxyAP(L,k){const M=this.baseInfoMap.get(L);if(!M)return;const U=M.info,x=Date.now(),V=sb(sb(sb({},U),k),{},{elapse:x-M.startTime,lts:x,extend:k.extend||void 0});this.send({type:Sb.JOIN_WEB_PROXY_AP,data:V},!0)}WebSocketQuit(L,k){const M=this.baseInfoMap.get(L);if(!M)return;const U=M.info,x=Date.now(),V=sb(sb(sb({},U),k),{},{elapse:x-M.startTime,lts:x});this.send({type:Sb.WEBSOCKET_QUIT,data:V},!0)}async sendCustomReportMessage(L,k){if(this.customReportCount+=k.length,this.customReportCount>zA("CUSTOM_REPORT_LIMIT"))throw new nv(iv.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval((()=>{this.customReportCount=0}),5e3));const M=Date.now(),U=k.map((k=>({type:Sb.USER_ANALYTICS,data:sb(sb({sid:L},k),{},{lts:M})})));try{zA("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(U):await this.postDataToStatsCollector(U)}catch(L){throw Eb.error("send custom report message failed",L.toString()),new nv(iv.CUSTOM_REPORT_SEND_FAILED,L.message)}}sendApiInvoke(L){const k=zA("NOT_REPORT_EVENT");if(L.tag&&Sr(k)&&Sr(k).call(k,L.tag))return!1;if(null===L.sid)return this.apiInvokeUploadPendingItems.push(L),!1;const M=this.baseInfoMap.get(L.sid);if(!M)return this.apiInvokeUploadPendingItems.push(L),!1;const{cname:U,uid:x,cid:V}=M.info;let F;if(L.lts=L.lts||Date.now(),L.error)if(L.error instanceof nv){const{code:k,message:M}=L.error;F=k||M||L.error.toString()}else F=L.error.toString();const j={invokeId:L.invokeId,sid:L.sid,cname:U,cid:V,uid:x,lts:L.lts,success:L.success,elapse:L.lts-M.startTime,execElapse:L.lts-L.apiInvokeTime,apiName:L.name,options:L.options?JSON.stringify(L.options):void 0,execStates:L.states?JSON.stringify(L.states):void 0,execResult:L.result?JSON.stringify(L.result):void 0,errorCode:L.error?F:void 0,errorMsg:L.error?JSON.stringify(L.error):void 0};return this.send({type:Sb.API_INVOKE,data:j},!1),!0}addSid(L){this.sids.add(L)}removeSid(L){this.sids.delete(L)}appendSessionId(){const L=this.apiInvokeUploadPendingItems;if(0===L.length)return;const k=Array.from(this.sids).find((L=>null!==L));k&&L.forEach((L=>{L&&(L.sid=k,this.sendApiInvoke(Object.assign({},L)))})),L.length=0}send(L,k){if(k)return this.keyEventUploadPendingItems.push(L),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(L),this.normalEventUploadPendingItems.length>zA("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(L,k){const M=[],U=[];for(;L.length;){const k=L.shift();M.length<20?M.push(k):U.push(k)}L.push(...U);for(const L of[...M]){var x;-1!==this.ltsList.indexOf(L.data.lts)?(L.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(L.data.lts)):(this.ltsList.push(L.data.lts),gE(x=this.ltsList).call(x,((L,k)=>L-k)))}return k||(this.lastSendNormalEventTime=Date.now()),zA("ENABLE_EVENT_REPORT")?(M.length&&(zA("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(M):this.postDataToStatsCollector(M)).catch((L=>M=>{zA("EVENT_REPORT_RETRY")&&(k?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(L):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(L),this.normalEventUploadPendingItems.length>zA("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-zA("NORMAL_EVENT_QUEUE_CAPACITY")),Eb.warning("report: drop normal events"))))})(M)),L):L}async postDataToStatsCollector2(L){Rv.networkState===gv.OFFLINE&&await Mp.race([Rv.onlineWaiter,EA(2*Ov.maxRetryTimeout)]);const t=L=>{let k=new Uint8Array;return L.forEach((L=>{const M=Py(JSON.stringify(L.data)),U=new ArrayBuffer(5),x=(L=>{let k=0;return Object.entries(Sb).forEach((M=>{let[U,x]=M;x===L.type&&(k=yb[U])})),k})(L),V=new DataView(U);V.setUint16(0,M.byteLength,!0),V.setUint8(2,255&x),V.setUint8(3,x>>>8&255),V.setUint8(4,x>>>16&255),k=Ly(k,new Uint8Array(U)),k=Ly(k,M)})),k},k="event";let M=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(zA("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(k):"https://".concat(zA("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(k);for(let U=0;U<2;U+=1){1===U&&(M=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(zA("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(k):"https://".concat(zA("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(k));try{await xA(M,{timeout:1e4,data:t(L),headers:sb(sb({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(L){if(1===U)throw L;continue}return}}async postDataToStatsCollector(L){let k=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const M={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:L.map((L=>JSON.stringify(L))),vid:(L=>{const k=L&&L.data.sid&&this.baseInfoMap.get(L.data.sid);return k&&k.info.vid&&+k.info.vid||0})(L[0])};Rv.networkState===gv.OFFLINE&&await Mp.race([Rv.onlineWaiter,EA(2*Ov.maxRetryTimeout)]);const U=k?"/events/proto-raws":"/events/messages";let x=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(zA("EVENT_REPORT_DOMAIN"),"&p=").concat(zA("STATS_COLLECTOR_PORT"),"&d=").concat(U):"https://".concat(zA("EVENT_REPORT_DOMAIN"),":").concat(zA("STATS_COLLECTOR_PORT")).concat(U));for(let L=0;L<2;L+=1){1===L&&(x=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(zA("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(zA("STATS_COLLECTOR_PORT"),"&d=").concat(U):"https://".concat(zA("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(zA("STATS_COLLECTOR_PORT")).concat(U)));try{k?await VA(x,{timeout:1e4,data:M}):await xA(x,{timeout:1e4,data:M})}catch(k){if(1===L)throw k;continue}return}}createBaseInfo(L,k){const M=Object.assign({},gb);return M.sid=L,this.baseInfoMap.set(L,{info:M,startTime:k}),M}reportResourceTiming(L,k){const M=performance.getEntriesByName(L),U=M[M.length-1];U&&this.reportApiInvoke(k,{name:"Client.resourceTiming",options:U,tag:lv.TRACER}).onSuccess()}};ub.on("REPORT_LOG_UPLOAD",(L=>{L.networkState=Rv.networkState,Ab.reportApiInvoke(null,{name:"logUploadError",options:L,tag:lv.TRACER}).onSuccess("logUploadError")}));class Ib extends nv{constructor(L){super(L,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",arguments.length>2?arguments[2]:void 0),rb(this,"name","AgoraRTCException")}print(){let L=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"error";return super.print(L,Eb)}throw(){super.throw(Eb)}}const Cb=["CHINA","GLOBAL"],vb=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],wb=[];function bb(L,k){return!!k&&wb.some((M=>M.uid===L&&M.channelName===k))}var Ob=ug.forEach,Nb=Bn("forEach")?[].forEach:function(L){return Ob(this,L,arguments.length>1?arguments[1]:void 0)};wi({target:"Array",proto:!0,forced:[].forEach!=Nb},{forEach:Nb});var Db=Xi("Array").forEach,Pb=Xn,Lb=Mt,kb=j,Mb=Db,Ub=Array.prototype,xb={DOMTokenList:!0,NodeList:!0},Vb=i((function(L){var k=L.forEach;return L===Ub||kb(Ub,L)&&k===Ub.forEach||Lb(xb,Pb(L))?Mb:k})),Fb=Je,Bb=Do;wi({target:"Object",stat:!0,forced:n((function(){Bb(1)}))},{keys:function(L){return Bb(Fb(L))}});var jb=i(Be.Object.keys),Gb=i(zn),Wb=wi,Hb=fm,Kb=F([].reverse),zb=[1,2];Wb({target:"Array",proto:!0,forced:String(zb)===String(zb.reverse())},{reverse:function(){return Hb(this)&&(this.length=this.length),Kb(this)}});var Yb=Xi("Array").reverse,qb=j,Xb=Yb,Jb=Array.prototype,Zb=function(L){var k=L.reverse;return L===Jb||qb(Jb,L)&&k===Jb.reverse?Xb:k},Qb=i(Zb),$b=wi,ew=fm,tw=ud,iw=Fe,nw=xi,rw=Gi,ow=Z,sw=E_,aw=ht,cw=gd,dw=Em("slice"),lw=aw("species"),uw=Array,hw=Math.max;$b({target:"Array",proto:!0,forced:!dw},{slice:function(L,k){var M,U,x,V=ow(this),F=rw(V),j=nw(L,F),z=nw(void 0===k?F:k,F);if(ew(V)&&(M=V.constructor,(tw(M)&&(M===uw||ew(M.prototype))||iw(M)&&null===(M=M[lw]))&&(M=void 0),M===uw||void 0===M))return cw(V,j,z);for(U=new(void 0===M?uw:M)(hw(z-j,0)),x=0;j<z;j++,x++)j in V&&sw(U,x,V[j]);return U.length=x,U}});var pw=Xi("Array").slice,_w=j,Ew=pw,fw=Array.prototype,mw=i((function(L){var k=L.slice;return L===fw||_w(fw,L)&&k===fw.slice?Ew:k}));function gw(L,k,M,U,x){var V,F,j,z={};return Vb(V=jb(U)).call(V,(function(L){z[L]=U[L]})),z.enumerable=!!z.enumerable,z.configurable=!!z.configurable,("value"in z||z.initializer)&&(z.writable=!0),z=Gb(F=Qb(j=mw(M).call(M)).call(j)).call(F,(function(M,U){return U(L,k,M)||M}),z),x&&void 0!==z.initializer&&(z.value=z.initializer?z.initializer.call(x):void 0,z.initializer=void 0),void 0===z.initializer&&(pm(L,k,z),z=null),z}let Tw=function(L){return L.L1T1="L1T1",L.L1T2="L1T2",L.L1T3="L1T3",L.L1T3_KEY="L1T3_KEY",L.L2T1_KEY="L2T1_KEY",L.L2T2_KEY="L2T2_KEY",L.L2T3_KEY="L2T3_KEY",L.L3T1_KEY="L3T1_KEY",L.L3T2_KEY="L3T2_KEY",L.L3T3_KEY="L3T3_KEY",L}({}),Sw=function(L){return L.CERTIFICATE="certificate",L.CODEC="codec",L.CANDIDATE_PAIR="candidate-pair",L.LOCAL_CANDIDATE="local-candidate",L.REMOTE_CANDIDATE="remote-candidate",L.INBOUND="inbound-rtp",L.TRACK="track",L.OUTBOUND="outbound-rtp",L.PC="peer-connection",L.REMOTE_INBOUND="remote-inbound-rtp",L.REMOTE_OUTBOUND="remote-outbound-rtp",L.TRANSPORT="transport",L.CSRC="csrc",L.DATA_CHANNEL="data-channel",L.STREAM="stream",L.SENDER="sender",L.RECEIVER="receiver",L}({}),Rw=function(L){return L[L.ACCESS_POINT=101]="ACCESS_POINT",L[L.UNILBS=201]="UNILBS",L[L.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR",L}({}),Iw=function(L){return L[L.IIIEGAL_APPID=1]="IIIEGAL_APPID",L[L.IIIEGAL_UID=2]="IIIEGAL_UID",L[L.INTERNAL_ERROR=3]="INTERNAL_ERROR",L}({}),yw=function(L){return L[L.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",L[L.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",L[L.INTERNAL_ERROR=8]="INTERNAL_ERROR",L[L.NO_AUTHORIZED=9]="NO_AUTHORIZED",L[L.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",L[L.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",L[L.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",L[L.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",L[L.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",L[L.USER_OVERLOAD=16]="USER_OVERLOAD",L[L.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",L[L.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND",L}({}),Aw=function(L){return L[L.NO_FLAG_SET=100]="NO_FLAG_SET",L[L.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",L[L.INVALID_FALG_SET=102]="INVALID_FALG_SET",L[L.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",L[L.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",L[L.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",L[L.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",L[L.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",L[L.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",L[L.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",L[L.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",L[L.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",L[L.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",L[L.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",L[L.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",L[L.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",L[L.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",L[L.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",L[L.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV",L}({}),Cw=function(L){return L[L.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",L[L.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",L[L.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",L[L.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",L[L.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",L[L.K_TICKET_INVALID=7]="K_TICKET_INVALID",L[L.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",L[L.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",L[L.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",L[L.K_UID_BANNED=14]="K_UID_BANNED",L[L.K_IP_BANNED=15]="K_IP_BANNED",L[L.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",L[L.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",L[L.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",L[L.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",L[L.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",L[L.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",L[L.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",L[L.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",L[L.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",L[L.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",L[L.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",L[L.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",L[L.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",L[L.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",L[L.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",L[L.ERR_INVALID_UID=117]="ERR_INVALID_UID",L[L.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",L[L.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",L[L.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",L[L.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",L[L.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",L[L.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",L[L.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",L[L.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",L[L.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",L[L.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",L[L.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",L[L.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",L[L.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",L[L.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",L[L.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",L[L.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",L[L.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",L[L.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",L[L.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",L[L.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",L[L.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",L[L.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",L[L.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",L[L.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",L[L.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",L[L.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",L[L.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",L[L.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",L[L.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",L[L.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",L[L.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",L[L.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",L[L.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",L[L.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",L[L.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",L[L.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",L[L.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY",L}({}),vw=function(L){return L.CONNECTING="connecting",L.CONNECTED="connected",L.RECONNECTING="reconnecting",L.CLOSED="closed",L}({}),bw=function(L){return L.WS_CONNECTED="ws_connected",L.WS_RECONNECTING="ws_reconnecting",L.WS_CLOSED="ws_closed",L.WS_RECONNECT_WAITTING_FINISH="ws_reconnect_waitting_finish",L.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",L.ON_BINARY_DATA="on_binary_data",L.REQUEST_RECOVER="request_recover",L.REQUEST_JOIN_INFO="request_join_info",L.REQUEST_REJOIN_INFO="req_rejoin_info",L.IS_P2P_DISCONNECTED="is_p2p_dis",L.DISCONNECT_P2P="dis_p2p",L.ABORT_P2P_EXECUTION="abort_p2p_execution",L.NEED_RENEW_SESSION="need-sid",L.REPORT_JOIN_GATEWAY="report_join_gateway",L.REQUEST_TIMEOUT="request_timeout",L.REQUEST_SUCCESS="request_success",L.JOIN_RESPONSE="join_response",L.PRE_CONNECT_PC="pre_connect_pc",L.P2P_CONNECTION="p2p_connection",L.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",L.P2P_SUBSCRIBE="p2p_subscribe",L.P2P_UNSUBSCRIBE="p2p_unsubscribe",L.P2P_EXCHANGE_SDP="p2p_exchange_sdp",L.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",L.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream",L.RECOVER_NOTIFICATION="recover_notification",L}({}),ww=function(L){return L.PING="ping",L.PING_BACK="ping_back",L.JOIN="join_v3",L.REJOIN="rejoin_v3",L.LEAVE="leave",L.SET_CLIENT_ROLE="set_client_role",L.PUBLISH="publish",L.PUBLISH_DATASTREAM="publish_datastream",L.UNPUBLISH="unpublish",L.UNPUBLISH_DATASTREAM="unpublish_datastream",L.SUBSCRIBE="subscribe",L.PRE_SUBSCRIBE="pre_subscribe",L.SUBSCRIBE_DATASTREAM="subscribe_datastream",L.SUBSCRIBE_STREAMS="subscribe_streams",L.UNSUBSCRIBE="unsubscribe",L.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",L.UNSUBSCRIBE_STREAMS="unsubscribe_streams",L.SUBSCRIBE_CHANGE="subscribe_change",L.TRAFFIC_STATS="traffic_stats",L.RENEW_TOKEN="renew_token",L.SWITCH_VIDEO_STREAM="switch_video_stream",L.DEFAULT_VIDEO_STREAM="default_video_stream",L.SET_FALLBACK_OPTION="set_fallback_option",L.GATEWAY_INFO="gateway_info",L.CONTROL="control",L.SEND_METADATA="send_metadata",L.DATA_STREAM="data_stream",L.PICK_SVC_LAYER="pick_svc_layer",L.RESTART_ICE="restart_ice",L.CONNECT_PC="connect_pc",L.SET_VIDEO_PROFILE="set_video_profile",L.SET_PARAMETER="set_parameter",L.SET_RTM2_FLAG="set_rtm2_flag",L}({}),Ow=function(L){return L.WRTC_STATS="wrtc_stats",L.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",L.DENOISER_STATS="denoiser_stats",L.EXTENSION_USAGE_STATS="extension_usage_stats",L}({}),Nw=function(L){return L.ON_USER_ONLINE="on_user_online",L.ON_USER_OFFLINE="on_user_offline",L.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",L.ON_PUBLISH_STREAM="on_publish_stream",L.ON_UPLINK_STATS="on_uplink_stats",L.ON_P2P_LOST="on_p2p_lost",L.ON_REMOVE_STREAM="on_remove_stream",L.ON_ADD_AUDIO_STREAM="on_add_audio_stream",L.ON_ADD_VIDEO_STREAM="on_add_video_stream",L.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",L.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",L.ON_USER_BANNED="on_user_banned",L.ON_USER_LICENSE_BANNED="on_user_license_banned",L.ON_NOTIFICATION="on_notification",L.ON_CRYPT_ERROR="on_crypt_error",L.MUTE_AUDIO="mute_audio",L.MUTE_VIDEO="mute_video",L.UNMUTE_AUDIO="unmute_audio",L.UNMUTE_VIDEO="unmute_video",L.ON_P2P_OK="on_p2p_ok",L.RECEIVE_METADATA="receive_metadata",L.ON_DATA_STREAM="on_data_stream",L.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",L.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",L.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",L.ENABLE_LOCAL_VIDEO="enable_local_video",L.DISABLE_LOCAL_VIDEO="disable_local_video",L.ENABLE_LOCAL_AUDIO="enable_local_audio",L.DISABLE_LOCAL_AUDIO="disable_local_audio",L.ON_PUBLISHED_USER_LIST="on_published_user_list",L}({}),Dw=function(L){return L.SEND_ONLY="SEND_ONLY",L.RECEIVE_ONLY="RECEIVE_ONLY",L}({}),Pw=function(L){return L.CONNECTED="websocket:connected",L.RECONNECTING="websocket:reconnecting",L.WILL_RECONNECT="websocket:will_reconnect",L.CLOSED="websocket:closed",L.FAILED="websocket:failed",L.ON_MESSAGE="websocket:on_message",L.REQUEST_NEW_URLS="websocket:request_new_urls",L.RECONNECT_WAITTING_FINISH="websocket:reconnect_waitting_finish",L.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",L.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire",L}({});function Mw(L){if("string"!=typeof L||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(L))throw Eb.error("Invalid Channel Name ".concat(L)),new Ib(iv.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function Uw(L){if(!function(L){return"number"==typeof L&&Math.floor(L)===L&&0<=L&&L<=4294967295}(L)&&!wy(L,1,255))throw new Ib(iv.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");"string"==typeof L&&Eb.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}let Lw=function(L){return L.TRANSCODE="mix_streaming",L.RAW="raw_streaming",L}({});const kw={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},xw={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function Bw(L,k){yy(L.url,"".concat(k,".url"),1,1e3,!1),by(L.x)||Iy(L.x,"".concat(k,".x"),0,1e4),by(L.y)||Iy(L.y,"".concat(k,".y"),0,1e4),by(L.width)||Iy(L.width,"".concat(k,".width"),0,1e4),by(L.height)||Iy(L.height,"".concat(k,".height"),0,1e4),by(L.zOrder)||Iy(L.zOrder,"".concat(k,".zOrder"),0,255),by(L.alpha)||Iy(L.alpha,"".concat(k,".alpha"),0,1,!1)}const Vw={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""};let Fw=function(L){return L.WARNING="@live_uap-warning",L.ERROR="@line_uap-error",L.PUBLISH_STREAM_STATUS="@live_uap-publish-status",L.WORKER_STATUS="@live_uap-worker-status",L.REQUEST_NEW_ADDRESS="@live_uap-request-address",L}({}),jw=function(L){return L.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager",L}({}),Gw=function(L){return L[L.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",L[L.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",L[L.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",L[L.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",L[L.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",L[L.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",L[L.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",L[L.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",L[L.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",L[L.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",L[L.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",L[L.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",L[L.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",L[L.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",L[L.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",L[L.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",L[L.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",L[L.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",L[L.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",L[L.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",L[L.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN",L}({});function Kw(L){if(!L.channelName)throw new Ib(iv.INVALID_PARAMS,"invalid channelName in info");if("number"!=typeof L.uid)throw new Ib(iv.INVALID_PARAMS,"invalid uid in info, uid must be a number");return L.token&&yy(L.token,"info.token",1,2047),Uw(L.uid),Mw(L.channelName),!0}let Ww=function(L){return L[L.SetSdkProfile=0]="SetSdkProfile",L[L.SetSourceChannel=1]="SetSourceChannel",L[L.SetSourceUserId=2]="SetSourceUserId",L[L.SetDestChannel=3]="SetDestChannel",L[L.StartPacketTransfer=4]="StartPacketTransfer",L[L.StopPacketTransfer=5]="StopPacketTransfer",L[L.UpdateDestChannel=6]="UpdateDestChannel",L[L.Reconnect=7]="Reconnect",L[L.SetVideoProfile=8]="SetVideoProfile",L}({}),Hw=function(L){return L.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",L.NETWORK_CONNECTED="NETWORK_CONNECTED",L.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",L.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",L.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",L.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",L.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",L.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",L.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",L.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE",L}({}),zw=function(L){return L.RELAY_STATE_IDLE="RELAY_STATE_IDLE",L.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",L.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",L.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE",L}({}),Yw=function(L){return L.RELAY_OK="RELAY_OK",L.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",L.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",L.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED",L}({}),qw=function(L){return L.High="high",L.Low="low",L.Audio="audio",L.Screen="screen",L.ScreenLow="screen_low",L}({}),Xw=function(L){return L.DISCONNECT="disconnect",L.CONNECTION_STATE_CHANGE="connection-state-change",L.NETWORK_QUALITY="network-quality",L.STREAM_TYPE_CHANGE="stream-type-change",L.IS_P2P_DISCONNECTED="is-p2p-dis",L.DISCONNECT_P2P="dis-p2p",L.REQUEST_NEW_GATEWAY_LIST="req-gate-url",L.NEED_RENEW_SESSION="need-sid",L.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",L.JOIN_RESPONSE="join-response",L.RESET_CONNECTION_EVENTS="reset-connection-events",L.PRE_CONNECT_PC="pre-connect_pc",L}({}),Jw=function(L){return L.P2P_DISCONNECTED="P2P_DISCONNECTED",L.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",L.TIMEOUT="TIMEOUT",L.UNKNOWN_REASON="UNKNOWN_REASON",L}({}),Qw=function(L){return L[L.Nothing=0]="Nothing",L[L.Audio=1]="Audio",L[L.LwoVideo=2]="LwoVideo",L[L.Video=4]="Video",L[L.Data=8]="Data",L[L.DataStream0=256]="DataStream0",L[L.DataStream1=512]="DataStream1",L[L.DataStream2=1024]="DataStream2",L[L.DataStream3=2048]="DataStream3",L[L.DataStream4=4096]="DataStream4",L[L.DataStream5=8192]="DataStream5",L[L.DataStream6=16384]="DataStream6",L[L.DataStream7=32768]="DataStream7",L}({}),Zw=function(L){return L.CHINA="CHINA",L.ASIA="ASIA",L.NORTH_AMERICA="NORTH_AMERICA",L.EUROPE="EUROPE",L.JAPAN="JAPAN",L.INDIA="INDIA",L.KOREA="KOREA",L.HKMC="HKMC",L.US="US",L.OCEANIA="OCEANIA",L.SOUTH_AMERICA="SOUTH_AMERICA",L.AFRICA="AFRICA",L.OVERSEA="OVERSEA",L.GLOBAL="GLOBAL",L.EXTENSIONS="EXTENSIONS",L}({});const $w=[Zw.AFRICA,Zw.ASIA,Zw.CHINA,Zw.EUROPE,Zw.GLOBAL,Zw.INDIA,Zw.JAPAN,Zw.NORTH_AMERICA,Zw.OCEANIA,Zw.OVERSEA,Zw.SOUTH_AMERICA];let eO=function(L){return L.CHINA="CN",L.ASIA="AS",L.NORTH_AMERICA="NA",L.EUROPE="EU",L.JAPAN="JP",L.INDIA="IN",L.KOREA="KR",L.HKMC="HK",L.US="US",L.OCEANIA="OC",L.SOUTH_AMERICA="SA",L.AFRICA="AF",L.OVERSEA="OVERSEA",L.GLOBAL="GLOBAL",L.EXTENSIONS="GLOBAL",L}({});const tO={CHINA:{},ASIA:{CODE:eO.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:eO.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:eO.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:eO.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:eO.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:eO.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:eO.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:eO.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:eO.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:eO.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:eO.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:eO.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:eO.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};Uv&&(tO.CHINA={CODE:eO.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]});let iO=function(L){return L.UPDATE_BITRATE_LIMIT="update_bitrate_limit",L}({});class oO extends My{constructor(L,k){super(),xg(this,"onICEConnectionStateChange",void 0),xg(this,"onConnectionStateChange",void 0),xg(this,"onDTLSTransportStateChange",void 0),xg(this,"onDTLSTransportError",void 0),xg(this,"onICETransportStateChange",void 0),xg(this,"onFirstAudioReceived",void 0),xg(this,"onFirstVideoReceived",void 0),xg(this,"onFirstAudioDecoded",void 0),xg(this,"onFirstVideoDecoded",void 0),xg(this,"onFirstVideoDecodedTimeout",void 0),xg(this,"onSelectedLocalCandidateChanged",void 0),xg(this,"onSelectedRemoteCandidateChanged",void 0),xg(this,"getLocalVideoStats",void 0)}}class sO extends oO{constructor(L,k){super(L,k),xg(this,"establishPromise",void 0)}}let nO=function(L){return L.VIDEO="video",L.AUDIO="audio",L}({}),rO=function(L){return L[L.UDP=0]="UDP",L[L.TCP=1]="TCP",L[L.RELAY=2]="RELAY",L}({}),aO=function(L){return L[L.FIRST_CONNECTION=0]="FIRST_CONNECTION",L[L.TCP_RESTART=1]="TCP_RESTART",L[L.RELAY_RESTART=2]="RELAY_RESTART",L[L.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",L[L.OLD_RESTART=11]="OLD_RESTART",L[L.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED",L}({}),cO=function(L){return L.LocalVideoTrack="videoTrack",L.LocalAudioTrack="audioTrack",L.LocalVideoLowTrack="videoLowTrack",L}({}),dO=function(L){return L.New="new",L.Connected="connected",L.Reconnecting="reconnecting",L.Disconnected="disconnected",L}({}),lO=function(L){return L.StateChange="stateChange",L.IceConnectionStateChange="iceConnectionStateChange",L.RequestMuteLocal="requestMuteLocal",L.RequestUnmuteLocal="requestUnmuteLocal",L.RequestRePublish="requestRePublish",L.RequestRePublishDataChannel="requestRePublishDataChannel",L.RequestReSubscribe="requestReSubscribe",L.RequestUploadStats="requestUploadStats",L.RequestUpload="requestUpload",L.MediaReconnectStart="MediaReconnectStart",L.MediaReconnectEnd="MediaReconnectEnd",L.NeedSignalRTT="NeedSignalRTT",L.RequestRestartICE="RequestRestartIce",L.PeerConnectionStateChange="PeerConnectionStateChange",L.RequestReconnect="RequestReconnect",L.RequestReconnectPC="RequestReconnectPC",L.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",L.P2PLost="P2PLost",L.UpdateVideoEncoder="UpdateVideoEncoder",L.ConnectionTypeChange="ConnectionTypeChange",L.RequestLowStreamParameter="RequestLowStreamParameter",L.QueryClientConnectionState="QueryClientConnectionState",L.LocalCandidate="LocalCandidate",L.RequestP2PMuteLocal="requestP2PMuteLocal",L.RequestP2PUnPublish="RequestP2PUnPublish",L.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",L.RequestP2PMuteRemote="RequestP2PMuteRemote",L.RequestP2PRestartICE="RequestP2PRestartICE",L}({}),uO=function(L){return L.CONNECTING="CONNECTING",L.RECONNECTING="RECONNECTING",L.CONNECTED="CONNECTED",L.CLOSED="CLOSED",L}({}),hO=function(L){return L[L.CONNECT_AP=0]="CONNECT_AP",L[L.AP_CONNECTED=1]="AP_CONNECTED",L[L.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",L[L.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",L[L.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",L[L.CONNECT_WORKER=5]="CONNECT_WORKER",L[L.WORKER_CONNECTED=6]="WORKER_CONNECTED",L[L.CLOSED=7]="CLOSED",L}({}),pO=function(L){return L.CONNECTION_STATE_CHANGE="connection-state-change",L.STATE_CHANGE="state-change",L.INSPECT_RESULT="inspect-result",L.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",L.REQUEST_NEW_WORKER_URL="request-new-worker-url",L}({}),_O=function(L){return L.CONNECTED="transmitter:connected",L.RECONNECTING="transmitter:reconnecting",L.WILL_RECONNECT="transmitter:will_reconnect",L.CLOSED="transmitter:closed",L.FAILED="transmitter:failed",L.ON_MESSAGE="transmitter:on_message",L.REQUEST_NEW_URLS="transmitter:request_new_urls",L.RECONNECT_WAITTING_FINISH="transmitter:reconnect_waitting_finish",L.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",L.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",L.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",L.FAILBACK="transmitter:failback",L.PRE_CONNECT_PC="transmitter:pre_connect_pc",L}({}),EO=function(L){return L.CAMERA_CHANGED="camera-changed",L.MICROPHONE_CHANGED="microphone-changed",L.PLAYBACK_DEVICE_CHANGED="playback-device-changed",L.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",L.AUTOPLAY_FAILED="autoplay-failed",L.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",L.SECURITY_POLICY_VIOLATION="security-policy-violation",L}({}),fO=function(L){return L.CONNECTING="CONNECTING",L.RECONNECTING="RECONNECTING",L.CONNECTED="CONNECTED",L.CLOSED="CLOSED",L}({}),mO=function(L){return L.CONNECTION_STATE_CHANGE="connection-state-change",L.STATE_CHANGE="state-change",L.INSPECT_RESULT="inspect-result",L.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",L.REQUEST_NEW_WORKER_URL="request-new-worker-url",L}({}),gO=function(L){return L[L.CONNECT_AP=0]="CONNECT_AP",L[L.AP_CONNECTED=1]="AP_CONNECTED",L[L.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",L[L.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",L[L.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",L[L.CONNECT_WORKER=5]="CONNECT_WORKER",L[L.WORKER_CONNECTED=6]="WORKER_CONNECTED",L[L.CLOSED=7]="CLOSED",L}({}),TO=function(L){return L.CALL="call",L.CANDIDATE="candidate",L.PUBLISH="publish",L.UNPUBLISH="unpublish",L.CONTROL="control",L.RESTART_ICE="restart_ice",L.ACK="ack",L.RESPONSE="response",L.JOIN="join",L.CHECK="check",L}({}),SO=function(L){return L.ABORT="abort",L}({}),RO=function(L){return L.MUTE_LOCAL_AUDIO="mute_local_audio",L.MUTE_LOCAL_VIDEO="mute_local_video",L.UNMUTE_LOCAL_AUDIO="unmute_local_audio",L.UNMUTE_LOCAL_VIDEO="unmute_local_video",L}({}),IO=function(L){return L.P2P_TOKEN_TIMEOUT="p2p_token_timeout",L.P2P_TOKEN_CHANGED="p2p_token_changed",L}({});const yO={[Rw.ACCESS_POINT]:{[Aw.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[Aw.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[Aw.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[Aw.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[Aw.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[Aw.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[Aw.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[Aw.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[Aw.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[Aw.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[Aw.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[Aw.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[Aw.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[Aw.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[Aw.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[Aw.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[Aw.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[Aw.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[Rw.UNILBS]:{[yw.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[yw.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[yw.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[yw.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[yw.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[yw.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[yw.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[yw.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[yw.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[yw.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[yw.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[yw.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[Rw.STRING_UID_ALLOCATOR]:{[Iw.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[Iw.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[Iw.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function AO(L){const k=yO[Math.floor(L/1e4)];if(!k)return{desc:"unknown error",retry:!1};const M=k[L%1e4];if(!M){if(Math.floor(L/1e4)===Rw.ACCESS_POINT){const k=L%1e4;if("1"===k.toString()[0])return{desc:L.toString(),retry:!1};if("2"===k.toString()[0])return{desc:L.toString(),retry:!0}}return{desc:"unknown error",retry:!1}}return M}const CO={[Cw.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[Cw.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[Cw.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[Cw.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[Cw.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[Cw.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[Cw.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[Cw.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[Cw.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[Cw.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[Cw.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[Cw.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[Cw.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[Cw.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[Cw.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[Cw.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[Cw.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[Cw.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[Cw.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[Cw.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[Cw.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[Cw.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[Cw.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[Cw.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[Cw.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[Cw.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[Cw.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[Cw.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[Cw.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[Cw.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[Cw.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[Cw.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[Cw.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[Cw.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[Cw.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[Cw.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[Cw.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[Cw.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[Cw.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[Cw.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[Cw.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[Cw.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[Cw.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[Cw.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[Cw.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[Cw.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[Cw.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[Cw.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[Cw.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[Cw.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[Cw.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[Cw.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[Cw.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[Cw.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[Cw.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[Cw.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[Cw.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[Cw.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[Cw.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[Cw.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[Cw.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[Cw.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[Cw.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function wO(L){return CO[L]||{desc:"UNKNOWN_ERROR_".concat(L),action:"failed"}}function OO(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function NO(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?OO(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):OO(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}function DO(L){return L.every((L=>L.readyState===WebSocket.CLOSED||L.readyState===WebSocket.CLOSING))}function PO(L,k){if("string"==typeof L)return L;const{proxy:M,host:U,port:x}=L;if(k){const L=zA("JOIN_GATEWAY_FALLBACK_PORT")||443;return 443===L?"wss://".concat(U,"/ws/?p=").concat(Number(x)+150):"wss://".concat(U,":").concat(L,"/ws/?p=").concat(Number(x)+150)}return M?"wss://".concat(M,"/ws/?h=").concat(U,"&p=").concat(x):"wss://".concat(U,":").concat(x)}const vO=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,bO=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,LO=/wss:\/\/(.+):([0-9]+)\/?/,kO=/wss:\/\/(.[^\/]+)\/?/;let MO=0;class VO{constructor(L,k){xg(this,"id",0),xg(this,"store",void 0),xg(this,"recordIndex",void 0),xg(this,"websockets",[]),xg(this,"try443PortDuration",2e3),xg(this,"forceCloseWSDuration",5e3),xg(this,"try443PortTimeout",null),xg(this,"forceCloseTimeout",null),xg(this,"isTry443PortFailed",!1),xg(this,"isNormalPortFailed",!1),xg(this,"useDoubleDomain",!1),xg(this,"useProxy",!1),xg(this,"startTime",Date.now()),this.id=++MO,this.try443PortDuration=zA("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=L||5e3,this.store=k}closeAllWebsockets(){this.websockets.forEach((L=>{L.onopen=null,L.onclose=null,L.onmessage=null,L.close()})),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout)}logger(){var L;const k=Date.now()-this.startTime;for(var M=arguments.length,U=new Array(M),x=0;x<M;x++)U[x]=arguments[x];Eb.debug("[choose-best-ws ".concat(null===(L=this.store)||void 0===L?void 0:L.clientId," ").concat(this.id,"] ").concat(k,"ms:"),...U)}createWebSocket(L,k,M){this.logger("createWebSocket:",L,{isTry443Port:k,hasTimeoutDetection:M});const U=zA("GATEWAY_DOMAINS"),x=Date.now(),V=[],F=U.find((k=>{var M;return Sr(M=L.host).call(M,k)}));F||(this.useDoubleDomain=!1);const j=[];if(this.useDoubleDomain)U.forEach((M=>{j.push(PO(NO(NO({},L),{},{host:L.host.replace(F,M)}),k))}));else{const M=NO({},L);if(k&&F){const L=U.find((L=>L!==F));L&&(M.host=M.host.replace(F,L))}j.push(PO(M,k))}try{j.forEach((L=>{const k=new WebSocket(L);k.binaryType="arraybuffer",V.push(k),this.logger("ws is connecting:",k.url)}))}catch(U){if(this.logger("ws create failed"),V.forEach((L=>L.close())),V.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(L,k,M);if(!k&&443!==Number(L.port))return this.createWebSocket(L,!0,M);throw new Ib(iv.WS_ERR,"init websocket failed! Error: ".concat(U.toString()))}const z=Lv();return this.store&&this.store.recordJoinChannelService({urls:V.map((L=>L.url)),service:"gateway"},this.recordIndex),V.forEach((L=>{L.onopen=()=>{this.logger("onopen: ws ".concat(L.url," open cost ").concat(Date.now()-x,"ms")),this.websockets.forEach((k=>{k!==L&&(k.onopen=null,k.onclose=null,k.onmessage=null,k.close(),this.logger("close backup websocket: ".concat(k.url)))})),this.websockets.length=0,z.resolve(L)},L.onclose=M=>{this.logger("onclose: ws ".concat(L.url," closed cost ").concat(Date.now()-x,"ms state: ").concat(L.readyState)),k?this.isTry443PortFailed=DO(V):this.isNormalPortFailed=DO(V),this.logger("443: ".concat(this.useProxy?"not try":this.isTry443PortFailed?"failed":"trying"," 47xx: ").concat(this.isNormalPortFailed?"failed":"trying")),(k&&this.isTry443PortFailed||!k&&(this.isTry443PortFailed||this.useProxy)&&this.isNormalPortFailed)&&(this.logger("onclose: all websocket is closed, ".concat(M.reason)),z.reject({code:M.code,reason:Jw.A_ROUND_WS_FAILED}))},L.onmessage=k=>this.logger("".concat(L.url," onmessage: ").concat(k.data))})),this.websockets.push(...V),M||(()=>{const i=()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",z.isResolved),this.websockets.forEach((L=>L.readyState!==WebSocket.OPEN&&L.close()))};if(k||this.useProxy)return this.logger("add 5s timeout at ".concat(k?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(i,this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout((()=>{if(this.logger("2s timeout, isWebsocket created: ",z.isResolved),z.isResolved)return i();Gv().os===XC.MAC_OS&&Xv()&&i(),this.createWebSocket(L,!0,!0).then((L=>z.resolve(L))).catch((L=>{this.isNormalPortFailed&&z.reject(L),this.logger("try 443 port to create ws failed")})),this.forceCloseTimeout=window.setTimeout(i,this.forceCloseWSDuration)}),this.try443PortDuration)})(),z.promise}chooseBestWebsocket(L,k,M,U){return this.useDoubleDomain=!!k,"string"==typeof L&&(L=function(L){let k,M,U;return[,k,M,U]=L.match(vO)||[],k||([,M,U]=L.match(bO)||[]),M&&U||([,M,U]=L.match(LO)||[]),M&&U||([,M]=L.match(kO)||[]),M||Eb.warning("un-destructible url: ",L),{proxy:k,host:M,port:U||"443"}}(L)),this.recordIndex=U,this.useProxy=!!L.proxy,M&&this.useProxy&&(Eb.warn("cannot use 443 only when use proxy"),M=!1),this.createWebSocket(L,!!M,!1).finally((()=>this.clearTimeout()))}}function FO(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}class BO extends My{get url(){return this.websocket&&this.websocket.url||null}get reconnectMode(){return this._reconnectMode}set reconnectMode(L){var k;Sr(k=["tryNext","recover"]).call(k,L)&&this.resetReconnectCount(L),this._reconnectMode=L}get state(){return this._state}set state(L){L!==this._state&&(this._state=L,"reconnecting"===this._state?this.emit(Pw.RECONNECTING,this.reconnectReason):"connected"===this._state?this.emit(Pw.CONNECTED):"closed"===this._state?this.emit(Pw.CLOSED):"failed"===this._state&&this.emit(Pw.FAILED))}resetReconnectCount(L){Eb.debug("websocket reset reconnect count, reason: "+L),this.reconnectCount=0}constructor(L,k){let M=arguments.length>2&&void 0!==arguments[2]&&arguments[2],U=arguments.length>3&&void 0!==arguments[3]&&arguments[3],x=arguments.length>4&&void 0!==arguments[4]&&arguments[4],V=arguments.length>5?arguments[5]:void 0;super(),xg(this,"connectionID",0),xg(this,"currentURLIndex",0),xg(this,"urls",[]),xg(this,"_reconnectMode","tryNext"),xg(this,"reconnectReason",void 0),xg(this,"_initMutex",new wv("websocket")),xg(this,"name",void 0),xg(this,"_state","closed"),xg(this,"reconnectInterrupter",void 0),xg(this,"websocket",void 0),xg(this,"retryConfig",void 0),xg(this,"reconnectCount",0),xg(this,"forceCloseTimeout",5e3),xg(this,"onlineReconnectListener",void 0),xg(this,"useCompress",void 0),xg(this,"tryDoubleDomain",!1),xg(this,"use443PortOnly",!1),xg(this,"wsInflateLength",0),xg(this,"wsDeflateLength",0),xg(this,"closeEstablishingWs",(()=>{})),xg(this,"store",void 0),xg(this,"joinGatewayRecordIndex",void 0),this.store=V,this.name=L,this.retryConfig=function(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?FO(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):FO(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}({},k),this.useCompress=M,this.tryDoubleDomain=U,this.use443PortOnly=x;const{timeout:F,timeoutFactor:j}=k,z=Math.max(300,Math.floor(3*F/5)),Q=Math.max(1.2,Math.floor(8*j)/10);gv.ONLINE&&(this.retryConfig.timeout=z,this.retryConfig.timeoutFactor=Q),Rv.on(Sv.NETWORK_STATE_CHANGE,((L,k)=>{L!==k&&(this.resetReconnectCount("network state change: ".concat(k," -> ").concat(L)),L===gv.ONLINE?(this.retryConfig.timeout=z,this.retryConfig.timeoutFactor=Q):(this.retryConfig.timeout=F,this.retryConfig.timeoutFactor=j))}))}getConnection(){return this.websocket||void 0}async init(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const M=await this._initMutex.lock();this.forceCloseTimeout=k,this.urls=L,this.state="connecting";try{const L=Lv(),k=this.urls[this.currentURLIndex];zA("ENABLE_PREALLOC_PC")&&this.emit(_O.PRE_CONNECT_PC),this.createWebSocketConnection(k).then(L.resolve).catch(L.reject),this.once(Pw.CLOSED,(()=>{L.reject(new nv(iv.WS_DISCONNECT))})),this.once(Pw.CONNECTED,L.resolve),await L.promise}catch(L){}finally{M()}}close(L,k){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const L=this.websocket;k?setTimeout((()=>L.close()),500):L.close(),this.websocket=void 0}this.state=L?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(L,k){if(!this.websocket)return void Eb.warning("[".concat(this.name,"] can not reconnect, no websocket"));void 0!==L&&(this.reconnectMode=L),Eb.debug("[".concat(this.name,"] reconnect is triggered initiative")),"number"==typeof this.joinGatewayRecordIndex&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(k)]},this.joinGatewayRecordIndex);const M=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),M&&M.bind(this.websocket)({code:9999,reason:k})}sendMessage(L){let k=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new nv(iv.WS_ABORT,"websocket is not ready");try{k||(L=JSON.stringify(L)),this.websocket.send(L)}catch(L){throw new nv(iv.WS_ERR,"send websocket message error"+L.toString())}}setWsInflateData(L){this.wsDeflateLength=this.wsDeflateLength+L.originLength,this.wsInflateLength=this.wsInflateLength+L.compressedLength}getWsInflateData(){const L=this.wsInflateLength,k=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:L,wsDeflateLength:k}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(L){var k;const M=Lv();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;const n=L=>{var k;null===(k=this.store)||void 0===k||k.signalChannelOpen(),Eb.debug("[".concat(this.name,"] websocket opened:"),L),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),M.resolve()},r=async L=>{var k;if(Eb.debug("[".concat(this.name,"] websocket close ").concat(null===(k=this.websocket)||void 0===k?void 0:k.url,", code: ").concat(L.code,", reason: ").concat(L.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)M.reject(new nv(iv.WS_DISCONNECT,"websocket close: ".concat(L.code))),this.close();else{"connected"===this.state&&(this.reconnectReason=L.reason,this.state="reconnecting");const k=Zy(this,Pw.WILL_RECONNECT,this.reconnectMode,L.reason)||this.reconnectMode,U=await this.reconnectWithAction(k);if("closed"===this.state)return void Eb.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!U)return M.reject(new nv(iv.WS_DISCONNECT,"websocket reconnect failed: ".concat(L.code))),this.close(!0);M.resolve()}},o=L=>{this.emit(Pw.ON_MESSAGE,L)},s=L=>{Eb.warn("[".concat(this.connectionID,"] ws open error ").concat(L))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),zA("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(L=zA("GATEWAY_WSS_ADDRESS")),Eb.debug("[".concat(this.name,"] start connect, url:"),L);const U=null===(k=this.store)||void 0===k?void 0:k.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var x;const k=await this.chooseBestWebsocketConnection(L);this.websocket=k,n&&n(this.websocket.url),this.websocket.onclose=r,this.websocket.onmessage=o,this.websocket.onerror=s,null===(x=this.store)||void 0===x||x.recordJoinChannelService({endTs:Date.now(),status:"success"},U),this.joinGatewayRecordIndex=U}catch(L){const k="closed"===this.state,x=L instanceof nv,V=x&&L.code===iv.WS_ABORT,F=x&&L.code===iv.WS_ERR,j=x?L.message:L&&(L.reason||L.toString());Eb.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(j)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:V?"aborted":"error",errors:[L]},U),k||F?(M.reject(k?new nv(iv.WS_DISCONNECT,"websocket is closed: ".concat(j)):new nv(iv.WS_ERR,"init websocket failed: ".concat(j))),F&&Eb.error("[".concat(this.name,"] init websocket failed: ").concat(j))):r&&r(L)}return M.promise}async reconnectWithAction(L){let k=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount)return!1;if(0===this.urls.length)return!1;if("closed"===this.state)return!1;Eb.warning("[choose-best-ws] action: =>",L),this.onlineReconnectListener||Rv.isOnline||!Rv.onlineWaiter||(this.onlineReconnectListener=Rv.onlineWaiter.then((()=>{this.onlineReconnectListener=void 0})));let M=!0;if(this.reconnectInterrupter=()=>M=!1,k){const k=DA(this.reconnectCount,this.retryConfig);Eb.debug("[".concat(this.name,"] wait ").concat(k,"ms to reconnect websocket, mode: ").concat(L)),await Mp.race([EA(k),this.onlineReconnectListener||new Mp((()=>{}))])}if("closed"===this._state||!M)return!1;this.reconnectCount+=1;const n=async(L,k)=>{this.emit(Pw.RECONNECT_CREATE_CONNECTION,k),await this.createWebSocketConnection(L)};try{if("retry"===L)this.emit(Pw.RECONNECT_WAITTING_FINISH,L),await n(this.urls[this.currentURLIndex],L);else if("tryNext"===L){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);Eb.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),this.emit(Pw.RECONNECT_WAITTING_FINISH,L),await n(this.urls[this.currentURLIndex],L)}else"recover"===L&&(Eb.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.emit(Pw.RECONNECT_WAITTING_FINISH,L),this.urls=await Xy(this,Pw.REQUEST_NEW_URLS),this.currentURLIndex=0,await n(this.urls[this.currentURLIndex],L))}catch(M){var U;Eb.error("[".concat(this.name,"] reconnect failed ").concat(M&&M.toString()));const x=null==M||null===(U=M.data)||void 0===U?void 0:U.desc;return Array.isArray(x)&&Sr(x).call(x,"dynamic key expired")?(this.emit(Pw.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):this.reconnectWithAction(L,k)}return!0}}class jO extends BO{constructor(L,k){super(L,k,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(L,k){const M=Lv(),U=function(L,k){return new VO(L,k)}(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{Eb.debug("[choose-best-ws] close establishing websockets"),U.closeAllWebsockets(),M.reject(new nv(iv.WS_ABORT,"choose best websocket aborted"))};const x=zA("GATEWAY_DOMAINS");return Eb.debug("[choose-best-ws] currentDomain: ",L,", domains: ",x,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),U.chooseBestWebsocket(L,this.tryDoubleDomain,this.use443PortOnly,k).then(M.resolve).catch(M.reject),M.promise.finally((()=>{this.closeEstablishingWs=void 0}))}}class GO extends BO{constructor(L,k){super(L,k,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(L,k){return new Mp(((M,U)=>{let x=!1;const V=[];this.closeEstablishingWs=()=>{Eb.debug("[choose-best-ws] close establishing websockets"),V.forEach((L=>{L.onclose=null,L.onopen=null,L.onmessage=null,L.close()})),U(new nv(iv.WS_ABORT,"choose best websocket aborted"))};const F=zA("GATEWAY_DOMAINS");let j;const z=L.indexOf("?h="),Q=F.find((k=>-1!==z?Sr(L).call(L,k,z):Sr(L).call(L,k)));Eb.debug("[choose-best-ws] currentDomain: ",Q,", domains: ",F);let $=!this.tryDoubleDomain||!Q;if(!$&&Q){var ee;const te=Date.now();try{F.forEach((k=>{const M=-1===z?L.replace(Q,k):L.substr(0,z)+L.substr(z).replace(Q,k),U=new WebSocket(M);U.binaryType="arraybuffer",V.push(U),Eb.debug("[choose-best-ws] ws is connecting:",U.url)}))}catch(L){for(Eb.debug("[choose-best-ws] ws create failed, fallback to single url"),V.forEach((L=>L.close()));V.length;)V.pop();$=!0}null===(ee=this.store)||void 0===ee||ee.recordJoinChannelService({urls:V.map((L=>L.url)),service:"gateway"},k),V.forEach((L=>{L.onopen=()=>{if(x)return;const k=Date.now()-te;Eb.debug("[choose-best-ws] ws open cost ".concat(k,"ms")),V.filter((k=>k!==L)).forEach((L=>{Eb.debug("[choose-best-ws]close backup websocket: ".concat(L.url)),L.close()})),x=!0,M(L)},L.onclose=L=>{j=L,x||V.find((L=>!(L.readyState===WebSocket.CLOSED||L.readyState===WebSocket.CLOSING)))||(Eb.debug("[choose-best-ws] all websocket is closed"),x=!0,U(j))},L.onmessage=k=>{Eb.debug("[choose-best-ws]".concat(L.url," onmessage: ").concat(k.data))}})),EA(this.forceCloseTimeout).then((()=>{V.forEach((L=>{L.readyState!==WebSocket.OPEN&&L.close()}))}))}if($){var te;let x;Eb.debug("[choose-best-ws] use single url: ",L),null===(te=this.store)||void 0===te||te.recordJoinChannelService({urls:[L],service:"gateway"},k);try{x=new WebSocket(L),V.push(x),x.binaryType="arraybuffer"}catch(L){const k=new nv(iv.WS_ERR,"init websocket failed! Error: ".concat(L.toString()));return Eb.error("[".concat(this.name,"]").concat(k)),void U(k)}x.onopen=()=>{M(x)},x.onclose=L=>{U(L)},x.onmessage=L=>{Eb.debug("[choose-best-ws]".concat(x.url," onmessage: ").concat(L.data))},EA(this.forceCloseTimeout).then((()=>{x&&x.readyState!==WebSocket.OPEN&&x.close()}))}})).then((L=>(this.closeEstablishingWs=void 0,L))).catch((L=>{throw this.closeEstablishingWs=void 0,L}))}}class WO extends My{get connectionState(){return this._connectionState}set connectionState(L){L!==this._connectionState&&(this._connectionState=L,L===vw.CONNECTED?this.emit(bw.WS_CONNECTED):L===vw.RECONNECTING?this.emit(bw.WS_RECONNECTING,this._websocketReconnectReason):L===vw.CLOSED&&this.emit(bw.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(L,k){super(),xg(this,"_disconnectedReason",void 0),xg(this,"_websocketReconnectReason",void 0),xg(this,"_connectionState",vw.CLOSED),xg(this,"reconnectToken",void 0),xg(this,"websocket",void 0),xg(this,"openConnectionTime",void 0),xg(this,"clientId",void 0),xg(this,"lastMsgTime",Date.now()),xg(this,"uploadCache",[]),xg(this,"uploadCacheInterval",void 0),xg(this,"rttRolling",new LA(5)),xg(this,"pingpongTimer",void 0),xg(this,"wsInflateDataTimer",void 0),xg(this,"pingpongTimeoutCount",0),xg(this,"joinResponse",void 0),xg(this,"multiIpOption",void 0),xg(this,"initError",void 0),xg(this,"spec",void 0),xg(this,"store",void 0),xg(this,"onWebsocketMessage",(L=>{if(L.data instanceof ArrayBuffer)return void this.emit(bw.ON_BINARY_DATA,L.data);const k=JSON.parse(L.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(k,"_id")){const L="res-@".concat(k._id);this.emit(L,k._result,k._message)}else if(Object.prototype.hasOwnProperty.call(k,"_type")){if(this.emit(k._type,k._message),k._type===Nw.ON_NOTIFICATION&&this.handleNotification(k._message),k._type===Nw.ON_USER_BANNED)switch(k._message.error_code){case 14:this.close(hv.UID_BANNED);break;case 15:this.close(hv.IP_BANNED);break;case 16:this.close(hv.CHANNEL_BANNED)}if(k._type===Nw.ON_USER_LICENSE_BANNED)switch(k._message.error_code){case Cw.ERR_LICENSE_MISSING:this.close(hv.LICENSE_MISSING);break;case Cw.ERR_LICENSE_EXPIRED:this.close(hv.LICENSE_EXPIRED);break;case Cw.ERR_LICENSE_MINUTES_EXCEEDED:this.close(hv.LICENSE_MINUTES_EXCEEDED);break;case Cw.ERR_LICENSE_PERIOD_INVALID:this.close(hv.LICENSE_PERIOD_INVALID);break;case Cw.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(hv.LICENSE_MULTIPLE_SDK_SERVICE);break;case Cw.ERR_LICENSE_ILLEGAL:this.close(hv.LICENSE_ILLEGAL);break;default:this.close()}}})),this.clientId=L.clientId,this.spec=L,this.store=k,this.websocket=new jO("gateway-".concat(this.clientId),this.spec.retryConfig,!0,zA("JOIN_GATEWAY_USE_DUAL_DOMAIN"),zA("JOIN_GATEWAY_USE_443PORT_ONLY"),k),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===vw.CONNECTED&&this.reconnect("retry",fv.OFFLINE)}))}async request(L,k,M,U){const x=fA(6,""),V={_id:x,_type:L,_message:k},F=this.websocket.connectionID,a=()=>new Mp(((k,M)=>{if(this.connectionState===vw.CONNECTED)return k();const n=()=>{this.off(bw.WS_CLOSED,r),k()},r=()=>{this.off(bw.WS_CONNECTED,n),M(new Ib(iv.WS_ABORT))};this.once(bw.WS_CONNECTED,n),this.once(bw.WS_CLOSED,r),L!==ww.PUBLISH&&L!==ww.PUBLISH_DATASTREAM&&L!==ww.SUBSCRIBE&&L!==ww.SUBSCRIBE_DATASTREAM&&L!==ww.UNSUBSCRIBE&&L!==ww.UNSUBSCRIBE_DATASTREAM&&L!==ww.UNPUBLISH&&L!==ww.UNPUBLISH_DATASTREAM&&L!==ww.CONTROL&&L!==ww.RESTART_ICE||this.once(bw.DISCONNECT_P2P,(()=>{M(new Ib(iv.DISCONNECT_P2P))})),L!==ww.PUBLISH&&L!==ww.RESTART_ICE||this.once(bw.ABORT_P2P_EXECUTION,(()=>{M(new Ib(iv.DISCONNECT_P2P))}))}));if(this.connectionState!==vw.CONNECTING&&this.connectionState!==vw.RECONNECTING||L===ww.JOIN||L===ww.REJOIN||await a(),this.websocket.sendMessage(V,!0),U)return;const j=new Mp(((M,U)=>{let V=!1;const a=(U,x)=>{V=!0,M({isSuccess:"success"===U,message:x||{}}),this.off(bw.WS_CLOSED,c),this.off(bw.WS_RECONNECTING,c),this.emit(bw.REQUEST_SUCCESS,L,k)};this.once("res-@".concat(x),a);const c=()=>{U(new Ib(iv.WS_ABORT,"type: ".concat(L))),this.off(bw.WS_CLOSED,c),this.off(bw.WS_RECONNECTING,c),this.off("res-@".concat(x),a)};this.once(bw.WS_CLOSED,c),this.once(bw.WS_RECONNECTING,c),EA(zA("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==F||V||(Eb.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(L)),this.emit(bw.REQUEST_TIMEOUT,L,k))}))}));let z=null;try{z=await j}catch(U){if(this.connectionState===vw.CLOSED||L===ww.LEAVE)throw new Ib(iv.WS_ABORT);return!this.spec.forceWaitGatewayResponse||M?U.throw():L===ww.JOIN||L===ww.REJOIN?null:(await a(),await this.request(L,k))}if(z.isSuccess)return z.message;const Q=Number(z.message.error_code||z.message.code),$=wO(Q),ee=new Ib(iv.UNEXPECTED_RESPONSE,"".concat($.desc,": ").concat(z.message.error_str),{code:Q,data:z.message,desc:$.desc});return"success"===$.action?z.message:(Eb.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(L,", error_code: ").concat(Q,", message: ").concat($.desc,", action: ").concat($.action)),Q===Cw.ERR_TOO_MANY_BROADCASTERS?L===ww.JOIN||L===ww.REJOIN?(this.initError=ee,this.close(),ee.throw()):ee.throw():"failed"===$.action?ee.throw():"quit"===$.action?(this.initError=ee,this.close(),ee.throw()):(Q===Cw.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=z.message.option,Eb.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",fv.MULTI_IP)):this.reconnect($.action,fv.SERVER_ERROR),L===ww.JOIN||L===ww.REJOIN?null:await this.request(L,k)))}waitMessage(L,k){return new Mp((M=>{const n=U=>{(!k||k(U))&&(this.off(L,n),M(U))};this.on(L,n)}))}uploadWRTCStats(L){if(!this.store.sessionId)return void Eb.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const k={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:L};this.upload(Ow.WRTC_STATS,k)}upload(L,k){const M={_type:L,_message:k};try{this.websocket.sendMessage(M)}catch(L){const k=zA("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(M),this.uploadCache.length>k&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==vw.CONNECTED)return;const L=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(L._type,L._message)}),zA("UPLOAD_CACHE_INTERVAL")||2e3))}}send(L,k){const M={_type:L,_message:k};this.websocket.sendMessage(M)}init(L,k){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Mp(((k,M)=>{this.once(bw.WS_CONNECTED,(()=>k(this.joinResponse))),this.once(bw.WS_CLOSED,(()=>M(this.initError||new Ib(iv.WS_ABORT)))),this.connectionState=vw.CONNECTING,this.websocket.init(L).catch(M),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval((()=>{this.handleWsInflateData()}),2e4)}))}close(L){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=L||hv.LEAVE,this.connectionState=vw.CLOSED,Eb.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close()}async join(){if(!this.joinResponse){this.emit(bw.ABORT_P2P_EXECUTION);const L=await Xy(this,bw.REQUEST_JOIN_INFO),k=await this.request(ww.JOIN,L);if(!k)return this.emit(bw.REPORT_JOIN_GATEWAY,Jw.TIMEOUT,this.url||""),!1;this.joinResponse=k,this.emit(bw.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=vw.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new Ib(iv.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const L=$y(this,bw.REQUEST_REJOIN_INFO);L.token=this.reconnectToken;const k=await this.request(ww.REJOIN,L);return!!k&&(this.connectionState=vw.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),k.peers&&k.peers.forEach((L=>{this.emit(Nw.ON_USER_ONLINE,{uid:L.uid}),L.audio&&this.emit(Nw.ON_ADD_AUDIO_STREAM,{uid:L.uid,uint_id:L.uint_id,audio:!0,ssrcId:L.audio_ssrc}),L.video&&this.emit(Nw.ON_ADD_VIDEO_STREAM,{uid:L.uid,uint_id:L.uint_id,video:!0,ssrcId:L.video_ssrc}),L.audio_mute?this.emit(Nw.MUTE_AUDIO,{uid:L.uid}):this.emit(Nw.UNMUTE_AUDIO,{uid:L.uid}),L.video_mute?this.emit(Nw.MUTE_VIDEO,{uid:L.uid}):this.emit(Nw.UNMUTE_VIDEO,{uid:L.uid}),L.audio_enable_local?this.emit(Nw.ENABLE_LOCAL_AUDIO,{uid:L.uid}):this.emit(Nw.DISABLE_LOCAL_AUDIO,{uid:L.uid}),L.video_enable_local?this.emit(Nw.ENABLE_LOCAL_VIDEO,{uid:L.uid}):this.emit(Nw.DISABLE_LOCAL_VIDEO,{uid:L.uid}),L.audio||L.video||this.emit(Nw.ON_REMOVE_STREAM,{uid:L.uid,uint_id:L.uint_id})})),!0)}reconnect(L,k){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(L,k)}handleNotification(L){Eb.debug("[".concat(this.clientId,"] receive notification: "),L);const k=wO(L.code);if(28===L.code&&"detail"in L&&(Eb.info("[".concat(this.clientId,"] receive recover notification: "),L.detail),this.emit(bw.RECOVER_NOTIFICATION,L.detail)),"success"!==k.action){if("failed"!==k.action)return"quit"===k.action?("ERR_REPEAT_JOIN_CHANNEL"===k.desc&&this.close(hv.UID_BANNED),void this.close()):void this.reconnect(k.action,fv.SERVER_ERROR);Eb.error("[".concat(this.clientId,"] ignore error: "),k.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const L=zA("PING_PONG_TIME_OUT"),k=Date.now();this.pingpongTimeoutCount>=L&&(Eb.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(k-this.lastMsgTime,"ms")),k-this.lastMsgTime>zA("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",fv.TIMEOUT):this.request(ww.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const L=Date.now()-k;this.rttRolling.add(L),zA("REPORT_STATS")&&this.send(ww.PING_BACK,{pingpongElapse:L})})).catch((L=>{}))}handleWsInflateData(){const{wsInflateLength:L,wsDeflateLength:k}=this.websocket.getWsInflateData();0!==L&&0!==k&&this.upload(Ow.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:k,ws_inflate_length:L})}handleWebsocketEvents(){this.websocket.on(Pw.RECONNECT_WAITTING_FINISH,(L=>{this.emit(bw.WS_RECONNECT_WAITTING_FINISH,L)})),this.websocket.on(Pw.RECONNECT_CREATE_CONNECTION,(L=>{this.emit(bw.WS_RECONNECT_CREATE_CONNECTION,L)})),this.websocket.on(Pw.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Pw.CLOSED,(()=>{this.connectionState=vw.CLOSED})),this.websocket.on(Pw.FAILED,(()=>{this._disconnectedReason=hv.NETWORK_ERROR,this.connectionState=vw.CLOSED})),this.websocket.on(Pw.RECONNECTING,(L=>{this._websocketReconnectReason=L,this.joinResponse=void 0,this.connectionState===vw.CONNECTED?this.connectionState=vw.RECONNECTING:this.connectionState=vw.CONNECTING})),this.websocket.on(Pw.WILL_RECONNECT,((L,k,M)=>{const U=$y(this,bw.IS_P2P_DISCONNECTED),x=U||"retry"!==L;U&&"retry"===L&&(Eb.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),L="tryNext",k=Jw.P2P_DISCONNECTED),x&&(Eb.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(L)),this.emit(bw.REPORT_JOIN_GATEWAY,k||Jw.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(bw.DISCONNECT_P2P)),M(L)})),this.websocket.on(Pw.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((L=>{Eb.warning("[".concat(this.clientId,"] rejoin failed ").concat(L)),this.reconnect("tryNext",fv.SERVER_ERROR)})):this.join().catch((L=>{if(this.emit(bw.REPORT_JOIN_GATEWAY,L,this.url||""),L instanceof Ib){if(L.code===iv.UNEXPECTED_RESPONSE&&L.data.code===Cw.ERR_NO_AUTHORIZED)return this.initError=new Ib(iv.CAN_NOT_GET_GATEWAY_SERVER,"AgoraRTCError CAN_NOT_GET_GATEWAY_SERVER: dynamic key expired"),Eb.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",fv.SERVER_ERROR);Eb.error("[".concat(this.clientId,"] join gateway request failed"),L.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",fv.SERVER_ERROR):(this.initError=L,this.close())}}))})),this.websocket.on(Pw.REQUEST_NEW_URLS,((L,k)=>{Xy(this,bw.REQUEST_RECOVER,this.multiIpOption).then(L).catch(k)})),this.websocket.on(Pw.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(Nw.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})),this.websocket.on(_O.PRE_CONNECT_PC,(()=>{this.emit(bw.PRE_CONNECT_PC)}))}}let UO=function(L){return L[L.CHOOSE_SERVER=11]="CHOOSE_SERVER",L[L.CLOUD_PROXY=18]="CLOUD_PROXY",L[L.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",L[L.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK",L}({});function KO(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function YO(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?KO(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):KO(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}function qO(L){return L.match(/^[\.\:\d]+$/)?"".concat(L.replace(/[^\d]/g,"-"),".").concat(zA("TURN_DOMAIN")):(Eb.info("Unidentified as ip: ".concat(L,", use as host")),L)}function zO(L,k){L.addresses||(L.addresses=[]);const M=function(L,k){if(zA("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return L.map((L=>{let{ip:k,port:M}=L;return{address:"".concat(k,":").concat(M)}}));const M=zA("GATEWAY_DOMAINS");let U=M[1]&&Sr(k).call(k,M[1])?1:0;return L.map((L=>{let{domain_prefix:k,port:x,ip:V}=L;if(k)return{address:"".concat(k,".").concat(M[U++%M.length],":").concat(x)};const F=/^[\.\:\d]+$/.test(V),j=F?"".concat(V.replace(/[^\d]/g,"-"),".").concat(M[U++%M.length],":").concat(x):"".concat(V,":").concat(x);return F||Eb.info("Unidentified as ip: ".concat(V,", use as host")),{ip:V,port:x,address:j}}))}(L.addresses,k),U=Array.isArray(L.detail)&&L.detail[18];if(U&&"string"==typeof U){const L=U.split(";");for(let k=0;k<L.length;k++){var x;const U=l_(x=L[k]).call(x);M[k]&&U&&(M[k].ip6=U)}}const V=L.detail&&L.detail.candidate;let F;if(V){const[L,k]=V.split(":");L&&k&&(F={port:Number(k),ip:L,address:"".concat(L,":").concat(k)})}return{gatewayAddrs:M,apGatewayAddress:F,uid:L.uid,cid:L.cid,cert:L.cert,vid:L.detail&&L.detail[8],uni_lbs_ip:L.detail&&L.detail[1],res:L,csIp:L.detail&&L.detail[502]}}function JO(L){return"number"==typeof L?L:L.exact||L.ideal||L.max||L.min||0}function XO(L){const k=L._encoderConfig;if(!k)return{};const M={resolution:k.width&&k.height?"".concat(JO(k.width),"x").concat(JO(k.height)):void 0,maxVideoBW:k.bitrateMax,minVideoBW:k.bitrateMin};return"number"==typeof k.frameRate?(M.maxFrameRate=k.frameRate,M.minFrameRate=k.frameRate):k.frameRate&&(M.maxFrameRate=k.frameRate.max||k.frameRate.ideal||k.frameRate.exact||k.frameRate.min,M.minFrameRate=k.frameRate.min||k.frameRate.ideal||k.frameRate.exact||k.frameRate.max),M}function QO(L){return L>=0&&L<.17?1:L>=.17&&L<.36?2:L>=.36&&L<.59?3:L>=.59&&L<=1?4:L>1?5:0}function ZO(L,k){let M,U,x;switch(k){case UO.CHOOSE_SERVER:U=4096,x="choose server";break;case UO.CLOUD_PROXY:U=1048576,x="proxy";break;case UO.CLOUD_PROXY_5:U=4194304,x="proxy5";break;case UO.CLOUD_PROXY_FALLBACK:U=4194310,x="proxy fallback";break;default:throw new Ib(iv.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:L.detail&&L.detail[502],retry:!1})}if(L.response_body.forEach((k=>{k.buffer&&k.buffer.flag===U&&(M={code:k.buffer.code,addresses:(k.buffer.edges_services||[]).map((L=>YO(YO({},L),{},{ticket:k.buffer.cert}))),server_ts:L.enter_ts,uid:k.buffer.uid,cid:k.buffer.cid,cname:k.buffer.cname,detail:YO(YO({},k.buffer.detail),L.detail),flag:k.buffer.flag,opid:L.opid,cert:k.buffer.cert})})),!M)throw new Ib(iv.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(x," from multi unilbs response"),{csIp:L.detail&&L.detail[502]});return M}async function $O(L,k){return await Mp.all(L.addresses.map((async L=>({address:qO(L.ip),tcpport:L.port,udpport:L.port,username:k&&zA("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?k.toString():Vv.username,password:k&&zA("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await ky(k.toString()):Vv.password}))))}function eN(L,k){const M=k.getMediaStreamTrack(!0).getSettings(),U=k.videoHeight||M.height,x=k.videoWidth||M.width;return U&&x?Math.max(Math.min(U,x)/Math.min(JO(L.height),JO(L.width)),1):(Eb.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function tN(L){let{candidateType:k,relayProtocol:M,type:U,address:x,port:V,protocol:F}=L;return"local-candidate"===U?{candidateType:k,relayProtocol:M,protocol:F}:{candidateType:k,relayProtocol:M,address:x,port:V,protocol:F}}var xO,HO=i(Zb),iN=Xi("Array").values,nN=Xn,rN=Mt,oN=j,sN=iN,aN=Array.prototype,cN={DOMTokenList:!0,NodeList:!0},dN=i((function(L){var k=L.values;return L===aN||oN(aN,L)&&k===aN.values||rN(cN,nN(L))?sN:k})),lN=Ee,uN=F,hN=ge,pN=n,_N=Do,EN=po,fN=Te,mN=Je,gN=Ne,TN=Object.assign,SN=Object.defineProperty,RN=uN([].concat),IN=!TN||pN((function(){if(lN&&1!==TN({b:1},TN(SN({},"a",{enumerable:!0,get:function(){SN(this,"b",{value:3,enumerable:!1})}}),{b:2})).b)return!0;var L={},k={},M=Symbol(),U="abcdefghijklmnopqrst";return L[M]=7,U.split("").forEach((function(L){k[L]=L})),7!=TN({},L)[M]||_N(TN({},k)).join("")!=U}))?function(L,k){for(var M=mN(L),U=arguments.length,x=1,V=EN.f,F=fN.f;U>x;)for(var j,z=gN(arguments[x++]),Q=V?RN(_N(z),V(z)):_N(z),$=Q.length,ee=0;$>ee;)j=Q[ee++],lN&&!hN(F,z,j)||(M[j]=z[j]);return M}:TN,yN=ii,AN=rs,CN=Xt,vN=ge,bN=Je,DN=function(L,k,M,U){try{return U?k(yN(M)[0],M[1]):k(M)}catch(k){AN(L,"throw",k)}},wN=jo,ON=ud,NN=Gi,PN=E_,LN=es,kN=qo,MN=Array,UN=F,xN=2147483647,VN=/[^\0-\u007E]/,FN=/[.\u3002\uFF0E\uFF61]/g,BN="Overflow: input needs wider integers to process",jN=RangeError,GN=UN(FN.exec),WN=Math.floor,HN=String.fromCharCode,KN=UN("".charCodeAt),zN=UN([].join),YN=UN([].push),qN=UN("".replace),XN=UN("".split),JN=UN("".toLowerCase),eD=function(L){return L+22+75*(L<26)},tD=function(L,k,M){var U=0;for(L=M?WN(L/700):L>>1,L+=WN(L/k);L>455;)L=WN(L/35),U+=36;return WN(U+36*L/(L+38))},iD=function(L){var k=[];L=function(L){for(var k=[],M=0,U=L.length;M<U;){var x=KN(L,M++);if(x>=55296&&x<=56319&&M<U){var V=KN(L,M++);56320==(64512&V)?YN(k,((1023&x)<<10)+(1023&V)+65536):(YN(k,x),M--)}else YN(k,x)}return k}(L);var M,U,x=L.length,V=128,F=0,j=72;for(M=0;M<L.length;M++)(U=L[M])<128&&YN(k,HN(U));var z=k.length,Q=z;for(z&&YN(k,"-");Q<x;){var $=xN;for(M=0;M<L.length;M++)(U=L[M])>=V&&U<$&&($=U);var ee=Q+1;if($-V>WN((xN-F)/ee))throw jN(BN);for(F+=($-V)*ee,V=$,M=0;M<L.length;M++){if((U=L[M])<V&&++F>xN)throw jN(BN);if(U==V){for(var te=F,ie=36;;){var ne=ie<=j?1:ie>=j+26?26:ie-j;if(te<ne)break;var re=te-ne,oe=36-ne;YN(k,HN(eD(ne+re%oe))),te=WN(re/oe),ie+=36}YN(k,HN(eD(te))),j=tD(F,ee,Q==z),F=0,Q++}}F++,V++}return zN(k,"")},QN=wi,ZN=Ee,$N=XS,nD=z,rD=Xt,oD=F,sD=ha,aD=hc,cD=Sc,dD=Mt,lD=IN,_D=function(L){var k=bN(L),M=ON(this),U=arguments.length,x=U>1?arguments[1]:void 0,V=void 0!==x;V&&(x=CN(x,U>2?arguments[2]:void 0));var F,j,z,Q,$,ee,te=kN(k),ie=0;if(!te||this===MN&&wN(te))for(F=NN(k),j=M?new this(F):MN(F);F>ie;ie++)ee=V?x(k[ie],ie):k[ie],PN(j,ie,ee);else for($=(Q=LN(k,te)).next,j=M?new this:[];!(z=vN($,Q)).done;ie++)ee=V?DN(Q,x,[z.value,ie],!0):z.value,PN(j,ie,ee);return j.length=ie,j},uD=R_,hD=Fh.codeAt,pD=fn,ED=Da,fD=Zc,mD=uI,gD=Oa,TD=gD.set,SD=gD.getterFor("URL"),RD=mD.URLSearchParams,ID=mD.getState,yD=nD.URL,AD=nD.TypeError,CD=nD.parseInt,vD=Math.floor,bD=Math.pow,wD=oD("".charAt),OD=oD(/./.exec),ND=oD([].join),DD=oD(1..toString),PD=oD([].pop),LD=oD([].push),kD=oD("".replace),MD=oD([].shift),UD=oD("".split),xD=oD("".slice),VD=oD("".toLowerCase),FD=oD([].unshift),BD="Invalid scheme",jD="Invalid host",GD="Invalid port",WD=/[a-z]/i,HD=/[\d+-.a-z]/i,KD=/\d/,zD=/^0x/i,YD=/^[0-7]+$/,qD=/^\d+$/,XD=/^[\da-f]+$/i,JD=/[\0\t\n\r #%/:<>?@[\\\]^|]/,QD=/[\0\t\n\r #/:<>?@[\\\]^|]/,ZD=/^[\u0000-\u0020]+/,$D=/(^|[^\u0000-\u0020])[\u0000-\u0020]+$/,eP=/[\t\n\r]/g,oP=function(L){var k,M,U,x;if("number"==typeof L){for(k=[],M=0;M<4;M++)FD(k,L%256),L=vD(L/256);return ND(k,".")}if("object"==typeof L){for(k="",U=function(L){for(var k=null,M=1,U=null,x=0,V=0;V<8;V++)0!==L[V]?(x>M&&(k=U,M=x),U=null,x=0):(null===U&&(U=V),++x);return x>M&&(k=U,M=x),k}(L),M=0;M<8;M++)x&&0===L[M]||(x&&(x=!1),U===M?(k+=M?":":"::",x=!0):(k+=DD(L[M],16),M<7&&(k+=":")));return"["+k+"]"}return L},tP={},iP=lD({},tP,{" ":1,'"':1,"<":1,">":1,"`":1}),nP=lD({},iP,{"#":1,"?":1,"{":1,"}":1}),rP=lD({},nP,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),lP=function(L,k){var M=hD(L,0);return M>32&&M<127&&!dD(k,L)?L:encodeURIComponent(L)},sP={ftp:21,file:null,http:80,https:443,ws:80,wss:443},hP=function(L,k){var M;return 2==L.length&&OD(WD,wD(L,0))&&(":"==(M=wD(L,1))||!k&&"|"==M)},pP=function(L){var k;return L.length>1&&hP(xD(L,0,2))&&(2==L.length||"/"===(k=wD(L,2))||"\\"===k||"?"===k||"#"===k)},_P=function(L){return"."===L||"%2e"===VD(L)},aP={},cP={},dP={},uP={},EP={},fP={},mP={},gP={},TP={},SP={},RP={},IP={},yP={},AP={},CP={},vP={},bP={},wP={},OP={},NP={},DP={},UP=function(L,k,M){var U,x,V,F=pD(L);if(k){if(x=this.parse(F))throw AD(x);this.searchParams=null}else{if(void 0!==M&&(U=new UP(M,!0)),x=this.parse(F,null,U))throw AD(x);(V=ID(new RD)).bindURL(this),this.searchParams=V}};UP.prototype={type:"URL",parse:function(L,k,M){var U,x,V,F,j,z=this,Q=k||aP,$=0,ee="",te=!1,ie=!1,ne=!1;for(L=pD(L),k||(z.scheme="",z.username="",z.password="",z.host=null,z.port=null,z.path=[],z.query=null,z.fragment=null,z.cannotBeABaseURL=!1,L=kD(L,ZD,""),L=kD(L,$D,"$1")),L=kD(L,eP,""),U=_D(L);$<=U.length;){switch(x=U[$],Q){case aP:if(!x||!OD(WD,x)){if(k)return BD;Q=dP;continue}ee+=VD(x),Q=cP;break;case cP:if(x&&(OD(HD,x)||"+"==x||"-"==x||"."==x))ee+=VD(x);else{if(":"!=x){if(k)return BD;ee="",Q=dP,$=0;continue}if(k&&(z.isSpecial()!=dD(sP,ee)||"file"==ee&&(z.includesCredentials()||null!==z.port)||"file"==z.scheme&&!z.host))return;if(z.scheme=ee,k)return void(z.isSpecial()&&sP[z.scheme]==z.port&&(z.port=null));ee="","file"==z.scheme?Q=AP:z.isSpecial()&&M&&M.scheme==z.scheme?Q=uP:z.isSpecial()?Q=gP:"/"==U[$+1]?(Q=EP,$++):(z.cannotBeABaseURL=!0,LD(z.path,""),Q=OP)}break;case dP:if(!M||M.cannotBeABaseURL&&"#"!=x)return BD;if(M.cannotBeABaseURL&&"#"==x){z.scheme=M.scheme,z.path=uD(M.path),z.query=M.query,z.fragment="",z.cannotBeABaseURL=!0,Q=DP;break}Q="file"==M.scheme?AP:fP;continue;case uP:if("/"!=x||"/"!=U[$+1]){Q=fP;continue}Q=TP,$++;break;case EP:if("/"==x){Q=SP;break}Q=wP;continue;case fP:if(z.scheme=M.scheme,x==xO)z.username=M.username,z.password=M.password,z.host=M.host,z.port=M.port,z.path=uD(M.path),z.query=M.query;else if("/"==x||"\\"==x&&z.isSpecial())Q=mP;else if("?"==x)z.username=M.username,z.password=M.password,z.host=M.host,z.port=M.port,z.path=uD(M.path),z.query="",Q=NP;else{if("#"!=x){z.username=M.username,z.password=M.password,z.host=M.host,z.port=M.port,z.path=uD(M.path),z.path.length--,Q=wP;continue}z.username=M.username,z.password=M.password,z.host=M.host,z.port=M.port,z.path=uD(M.path),z.query=M.query,z.fragment="",Q=DP}break;case mP:if(!z.isSpecial()||"/"!=x&&"\\"!=x){if("/"!=x){z.username=M.username,z.password=M.password,z.host=M.host,z.port=M.port,Q=wP;continue}Q=SP}else Q=TP;break;case gP:if(Q=TP,"/"!=x||"/"!=wD(ee,$+1))continue;$++;break;case TP:if("/"!=x&&"\\"!=x){Q=SP;continue}break;case SP:if("@"==x){te&&(ee="%40"+ee),te=!0,V=_D(ee);for(var re=0;re<V.length;re++){var oe=V[re];if(":"!=oe||ne){var ce=lP(oe,rP);ne?z.password+=ce:z.username+=ce}else ne=!0}ee=""}else if(x==xO||"/"==x||"?"==x||"#"==x||"\\"==x&&z.isSpecial()){if(te&&""==ee)return"Invalid authority";$-=_D(ee).length+1,ee="",Q=RP}else ee+=x;break;case RP:case IP:if(k&&"file"==z.scheme){Q=vP;continue}if(":"!=x||ie){if(x==xO||"/"==x||"?"==x||"#"==x||"\\"==x&&z.isSpecial()){if(z.isSpecial()&&""==ee)return jD;if(k&&""==ee&&(z.includesCredentials()||null!==z.port))return;if(F=z.parseHost(ee))return F;if(ee="",Q=bP,k)return;continue}"["==x?ie=!0:"]"==x&&(ie=!1),ee+=x}else{if(""==ee)return jD;if(F=z.parseHost(ee))return F;if(ee="",Q=yP,k==IP)return}break;case yP:if(!OD(KD,x)){if(x==xO||"/"==x||"?"==x||"#"==x||"\\"==x&&z.isSpecial()||k){if(""!=ee){var de=CD(ee,10);if(de>65535)return GD;z.port=z.isSpecial()&&de===sP[z.scheme]?null:de,ee=""}if(k)return;Q=bP;continue}return GD}ee+=x;break;case AP:if(z.scheme="file","/"==x||"\\"==x)Q=CP;else{if(!M||"file"!=M.scheme){Q=wP;continue}if(x==xO)z.host=M.host,z.path=uD(M.path),z.query=M.query;else if("?"==x)z.host=M.host,z.path=uD(M.path),z.query="",Q=NP;else{if("#"!=x){pP(ND(uD(U,$),""))||(z.host=M.host,z.path=uD(M.path),z.shortenPath()),Q=wP;continue}z.host=M.host,z.path=uD(M.path),z.query=M.query,z.fragment="",Q=DP}}break;case CP:if("/"==x||"\\"==x){Q=vP;break}M&&"file"==M.scheme&&!pP(ND(uD(U,$),""))&&(hP(M.path[0],!0)?LD(z.path,M.path[0]):z.host=M.host),Q=wP;continue;case vP:if(x==xO||"/"==x||"\\"==x||"?"==x||"#"==x){if(!k&&hP(ee))Q=wP;else if(""==ee){if(z.host="",k)return;Q=bP}else{if(F=z.parseHost(ee))return F;if("localhost"==z.host&&(z.host=""),k)return;ee="",Q=bP}continue}ee+=x;break;case bP:if(z.isSpecial()){if(Q=wP,"/"!=x&&"\\"!=x)continue}else if(k||"?"!=x)if(k||"#"!=x){if(x!=xO&&(Q=wP,"/"!=x))continue}else z.fragment="",Q=DP;else z.query="",Q=NP;break;case wP:if(x==xO||"/"==x||"\\"==x&&z.isSpecial()||!k&&("?"==x||"#"==x)){if(".."===(j=VD(j=ee))||"%2e."===j||".%2e"===j||"%2e%2e"===j?(z.shortenPath(),"/"==x||"\\"==x&&z.isSpecial()||LD(z.path,"")):_P(ee)?"/"==x||"\\"==x&&z.isSpecial()||LD(z.path,""):("file"==z.scheme&&!z.path.length&&hP(ee)&&(z.host&&(z.host=""),ee=wD(ee,0)+":"),LD(z.path,ee)),ee="","file"==z.scheme&&(x==xO||"?"==x||"#"==x))for(;z.path.length>1&&""===z.path[0];)MD(z.path);"?"==x?(z.query="",Q=NP):"#"==x&&(z.fragment="",Q=DP)}else ee+=lP(x,nP);break;case OP:"?"==x?(z.query="",Q=NP):"#"==x?(z.fragment="",Q=DP):x!=xO&&(z.path[0]+=lP(x,tP));break;case NP:k||"#"!=x?x!=xO&&("'"==x&&z.isSpecial()?z.query+="%27":z.query+="#"==x?"%23":lP(x,tP)):(z.fragment="",Q=DP);break;case DP:x!=xO&&(z.fragment+=lP(x,iP))}$++}},parseHost:function(L){var k,M,U;if("["==wD(L,0)){if("]"!=wD(L,L.length-1))return jD;if(k=function(L){var k,M,U,x,V,F,j,z=[0,0,0,0,0,0,0,0],Q=0,$=null,ee=0,h=function(){return wD(L,ee)};if(":"==h()){if(":"!=wD(L,1))return;ee+=2,$=++Q}for(;h();){if(8==Q)return;if(":"!=h()){for(k=M=0;M<4&&OD(XD,h());)k=16*k+CD(h(),16),ee++,M++;if("."==h()){if(0==M)return;if(ee-=M,Q>6)return;for(U=0;h();){if(x=null,U>0){if(!("."==h()&&U<4))return;ee++}if(!OD(KD,h()))return;for(;OD(KD,h());){if(V=CD(h(),10),null===x)x=V;else{if(0==x)return;x=10*x+V}if(x>255)return;ee++}z[Q]=256*z[Q]+x,2!=++U&&4!=U||Q++}if(4!=U)return;break}if(":"==h()){if(ee++,!h())return}else if(h())return;z[Q++]=k}else{if(null!==$)return;ee++,$=++Q}}if(null!==$)for(F=Q-$,Q=7;0!=Q&&F>0;)j=z[Q],z[Q--]=z[$+F-1],z[$+--F]=j;else if(8!=Q)return;return z}(xD(L,1,-1)),!k)return jD;this.host=k}else if(this.isSpecial()){if(L=function(L){var k,M,U=[],x=XN(qN(JN(L),FN,"."),".");for(k=0;k<x.length;k++)M=x[k],YN(U,GN(VN,M)?"xn--"+iD(M):M);return zN(U,".")}(L),OD(JD,L))return jD;if(k=function(L){var k,M,U,x,V,F,j,z=UD(L,".");if(z.length&&""==z[z.length-1]&&z.length--,(k=z.length)>4)return L;for(M=[],U=0;U<k;U++){if(""==(x=z[U]))return L;if(V=10,x.length>1&&"0"==wD(x,0)&&(V=OD(zD,x)?16:8,x=xD(x,8==V?1:2)),""===x)F=0;else{if(!OD(10==V?qD:8==V?YD:XD,x))return L;F=CD(x,V)}LD(M,F)}for(U=0;U<k;U++)if(F=M[U],U==k-1){if(F>=bD(256,5-k))return null}else if(F>255)return null;for(j=PD(M),U=0;U<M.length;U++)j+=M[U]*bD(256,3-U);return j}(L),null===k)return jD;this.host=k}else{if(OD(QD,L))return jD;for(k="",M=_D(L),U=0;U<M.length;U++)k+=lP(M[U],tP);this.host=k}},cannotHaveUsernamePasswordPort:function(){return!this.host||this.cannotBeABaseURL||"file"==this.scheme},includesCredentials:function(){return""!=this.username||""!=this.password},isSpecial:function(){return dD(sP,this.scheme)},shortenPath:function(){var L=this.path,k=L.length;!k||"file"==this.scheme&&1==k&&hP(L[0],!0)||L.length--},serialize:function(){var L=this,k=L.scheme,M=L.username,U=L.password,x=L.host,V=L.port,F=L.path,j=L.query,z=L.fragment,Q=k+":";return null!==x?(Q+="//",L.includesCredentials()&&(Q+=M+(U?":"+U:"")+"@"),Q+=oP(x),null!==V&&(Q+=":"+V)):"file"==k&&(Q+="//"),Q+=L.cannotBeABaseURL?F[0]:F.length?"/"+ND(F,"/"):"",null!==j&&(Q+="?"+j),null!==z&&(Q+="#"+z),Q},setHref:function(L){var k=this.parse(L);if(k)throw AD(k);this.searchParams.update()},getOrigin:function(){var L=this.scheme,k=this.port;if("blob"==L)try{return new xP(L.path[0]).origin}catch(L){return"null"}return"file"!=L&&this.isSpecial()?L+"://"+oP(this.host)+(null!==k?":"+k:""):"null"},getProtocol:function(){return this.scheme+":"},setProtocol:function(L){this.parse(pD(L)+":",aP)},getUsername:function(){return this.username},setUsername:function(L){var k=_D(pD(L));if(!this.cannotHaveUsernamePasswordPort()){this.username="";for(var M=0;M<k.length;M++)this.username+=lP(k[M],rP)}},getPassword:function(){return this.password},setPassword:function(L){var k=_D(pD(L));if(!this.cannotHaveUsernamePasswordPort()){this.password="";for(var M=0;M<k.length;M++)this.password+=lP(k[M],rP)}},getHost:function(){var L=this.host,k=this.port;return null===L?"":null===k?oP(L):oP(L)+":"+k},setHost:function(L){this.cannotBeABaseURL||this.parse(L,RP)},getHostname:function(){var L=this.host;return null===L?"":oP(L)},setHostname:function(L){this.cannotBeABaseURL||this.parse(L,IP)},getPort:function(){var L=this.port;return null===L?"":pD(L)},setPort:function(L){this.cannotHaveUsernamePasswordPort()||(""==(L=pD(L))?this.port=null:this.parse(L,yP))},getPathname:function(){var L=this.path;return this.cannotBeABaseURL?L[0]:L.length?"/"+ND(L,"/"):""},setPathname:function(L){this.cannotBeABaseURL||(this.path=[],this.parse(L,bP))},getSearch:function(){var L=this.query;return L?"?"+L:""},setSearch:function(L){""==(L=pD(L))?this.query=null:("?"==wD(L,0)&&(L=xD(L,1)),this.query="",this.parse(L,NP)),this.searchParams.update()},getSearchParams:function(){return this.searchParams.facade},getHash:function(){var L=this.fragment;return L?"#"+L:""},setHash:function(L){""!=(L=pD(L))?("#"==wD(L,0)&&(L=xD(L,1)),this.fragment="",this.parse(L,DP)):this.fragment=null},update:function(){this.query=this.searchParams.serialize()||null}};var xP=function(L){var k=cD(this,PP),M=fD(arguments.length,1)>1?arguments[1]:void 0,U=TD(k,new UP(L,!1,M));ZN||(k.href=U.serialize(),k.origin=U.getOrigin(),k.protocol=U.getProtocol(),k.username=U.getUsername(),k.password=U.getPassword(),k.host=U.getHost(),k.hostname=U.getHostname(),k.port=U.getPort(),k.pathname=U.getPathname(),k.search=U.getSearch(),k.searchParams=U.getSearchParams(),k.hash=U.getHash())},PP=xP.prototype,FP=function(L,k){return{get:function(){return SD(this)[L]()},set:k&&function(L){return SD(this)[k](L)},configurable:!0,enumerable:!0}};if(ZN&&(aD(PP,"href",FP("serialize","setHref")),aD(PP,"origin",FP("getOrigin")),aD(PP,"protocol",FP("getProtocol","setProtocol")),aD(PP,"username",FP("getUsername","setUsername")),aD(PP,"password",FP("getPassword","setPassword")),aD(PP,"host",FP("getHost","setHost")),aD(PP,"hostname",FP("getHostname","setHostname")),aD(PP,"port",FP("getPort","setPort")),aD(PP,"pathname",FP("getPathname","setPathname")),aD(PP,"search",FP("getSearch","setSearch")),aD(PP,"searchParams",FP("getSearchParams")),aD(PP,"hash",FP("getHash","setHash"))),sD(PP,"toJSON",(function(){return SD(this).serialize()}),{enumerable:!0}),sD(PP,"toString",(function(){return SD(this).serialize()}),{enumerable:!0}),yD){var LP=yD.createObjectURL,kP=yD.revokeObjectURL;LP&&sD(xP,"createObjectURL",rD(LP,yD)),kP&&sD(xP,"revokeObjectURL",rD(kP,yD))}ED(xP,"URL"),QN({global:!0,constructor:!0,forced:!$N,sham:!ZN},{URL:xP});var MP=wi,VP=n,BP=Zc,jP=fn,GP=XS,WP=ae("URL");MP({target:"URL",stat:!0,forced:!(GP&&VP((function(){WP.canParse()})))},{canParse:function(L){var k=BP(arguments.length,1),M=jP(L),U=k<2||void 0===arguments[1]?void 0:jP(arguments[1]);try{return!!new WP(M,U)}catch(L){return!1}}});var HP=i(Be.URL);const KP={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1,supportRequestVideoFrameCallback:!1,supportWebCrypto:!1};function XP(){return KP}function QP(){return"setSinkId"in HTMLAudioElement.prototype&&(!zA("RESTRICTION_SET_PLAYBACK_DEVICE")||(qv()||Jv())&&!hy())}function ZP(){return!KP.supportUnifiedPlan||zA("CHROME_FORCE_PLAN_B")&&py()}let zP=function(L){return L.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",L.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",L.IOS_INTERRUPTION_START="ios-interruption-start",L.IOS_INTERRUPTION_END="ios-interruption-end",L.STATE_CHANGE="state-change",L}({});function eL(L,k,M){return{sampleRate:L,stereo:k,bitrate:M}}function tL(L,k,M,U,x){return{width:L,height:k,frameRate:M,bitrateMin:U,bitrateMax:x}}function iL(L,k,M,U,x){return{width:{max:L},height:{max:k},frameRate:M,bitrateMin:U,bitrateMax:x}}function nL(L,k){return{numSpatialLayers:L,numTemporalLayers:k}}const YP={"90p":tL(160,90),"90p_1":tL(160,90),"120p":tL(160,120,15,30,65),"120p_1":tL(160,120,15,30,65),"120p_3":tL(120,120,15,30,50),"120p_4":tL(212,120),"180p":tL(320,180,15,30,140),"180p_1":tL(320,180,15,30,140),"180p_3":tL(180,180,15,30,100),"180p_4":tL(240,180,15,30,120),"240p":tL(320,240,15,40,200),"240p_1":tL(320,240,15,40,200),"240p_3":tL(240,240,15,40,140),"240p_4":tL(424,240,15,40,220),"360p":tL(640,360,15,80,400),"360p_1":tL(640,360,15,80,400),"360p_3":tL(360,360,15,80,260),"360p_4":tL(640,360,30,80,600),"360p_6":tL(360,360,30,80,400),"360p_7":tL(480,360,15,80,320),"360p_8":tL(480,360,30,80,490),"360p_9":tL(640,360,15,80,800),"360p_10":tL(640,360,24,80,800),"360p_11":tL(640,360,24,80,1e3),"480p":tL(640,480,15,100,500),"480p_1":tL(640,480,15,100,500),"480p_2":tL(640,480,30,100,1e3),"480p_3":tL(480,480,15,100,400),"480p_4":tL(640,480,30,100,750),"480p_6":tL(480,480,30,100,600),"480p_8":tL(848,480,15,100,610),"480p_9":tL(848,480,30,100,930),"480p_10":tL(640,480,10,100,400),"720p":tL(1280,720,15,120,1130),"720p_auto":tL(1280,720,30,900,3e3),"720p_1":tL(1280,720,15,120,1130),"720p_2":tL(1280,720,30,120,2e3),"720p_3":tL(1280,720,30,120,1710),"720p_5":tL(960,720,15,120,910),"720p_6":tL(960,720,30,120,1380),"1080p":tL(1920,1080,15,120,2080),"1080p_1":tL(1920,1080,15,120,2080),"1080p_2":tL(1920,1080,30,120,3e3),"1080p_3":tL(1920,1080,30,120,3150),"1080p_5":tL(1920,1080,60,120,4780),"1440p":tL(2560,1440,30,120,4850),"1440p_1":tL(2560,1440,30,120,4850),"1440p_2":tL(2560,1440,60,120,7350),"4k":tL(3840,2160,30,120,8910),"4k_1":tL(3840,2160,30,120,8910),"4k_3":tL(3840,2160,60,120,13500)},qP={"480p":iL(640,480,5),"480p_1":iL(640,480,5),"480p_2":iL(640,480,30),"480p_3":iL(640,480,15),"720p":iL(1280,720,5),"720p_auto":tL(1280,720,30,900,3e3),"720p_1":iL(1280,720,5),"720p_2":iL(1280,720,30),"720p_3":iL(1280,720,15),"1080p":iL(1920,1080,5),"1080p_1":iL(1920,1080,5),"1080p_2":iL(1920,1080,30),"1080p_3":iL(1920,1080,15)},JP={"1SL1TL":nL(1,1),"3SL3TL":nL(3,3),"2SL3TL":nL(2,3)};function aL(L){return L||(L="480p_1"),"string"==typeof L?Object.assign({},YP[L]):L}function cL(L){return"string"==typeof L?Object.assign({},qP[L]):L}function dL(L){return"string"==typeof L?Object.assign({},JP[L]):L}const $P={speech_low_quality:eL(16e3,!1),speech_standard:eL(32e3,!1,18),music_standard:eL(48e3,!1),standard_stereo:eL(48e3,!0,56),high_quality:eL(48e3,!1,128),high_quality_stereo:eL(48e3,!0,192)};function uL(L){return"string"==typeof L?Object.assign({},$P[L]):L}const rL=[];function pL(L){return Cy(L,"mediaSource",["screen","window","application"]),!0}let oL=function(L){return L.NEED_RENEGOTIATE="@need_renegotiate",L.NEED_REPLACE_TRACK="@need_replace_track",L.NEED_REPLACE_MIXING_TRACK="@need_replace_mixing_track",L.NEED_CLOSE="@need_close",L.NEED_ENABLE_TRACK="@need_enable_track",L.NEED_DISABLE_TRACK="@need_disable_track",L.NEED_SESSION_ID="@need_sid",L.SET_OPTIMIZATION_MODE="@set_optimization_mode",L.GET_STATS="@get_stats",L.GET_RTC_STATS="@get_rtc_stats",L.GET_LOW_VIDEO_TRACK="@get_low_video_track",L.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",L.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",L.NEED_UPDATE_VIDEO_SEND_PARAMETERS="@need_update_video_send_parameters",L.NEED_MUTE_TRACK="@need_mute_track",L.NEED_UNMUTE_TRACK="@need_unmute_track",L}({}),sL=function(L){return L.SCREEN_TRACK="screen_track",L.CUSTOM_TRACK="custome_track",L.LOW_STREAM="low_stream",L.SCREEN_LOW_TRACK="screen_low_track",L}({}),lL=function(L){return L[L.HIGH_STREAM=0]="HIGH_STREAM",L[L.LOW_STREAM=1]="LOW_STREAM",L}({}),hL=function(L){return L[L.HIGH_STREAM=0]="HIGH_STREAM",L[L.LOW_STREAM=1]="LOW_STREAM",L[L.HIGH_STREAM_LAYER1=4]="HIGH_STREAM_LAYER1",L[L.HIGH_STREAM_LAYER2=5]="HIGH_STREAM_LAYER2",L[L.HIGH_STREAM_LAYER3=6]="HIGH_STREAM_LAYER3",L[L.HIGH_STREAM_LAYER4=7]="HIGH_STREAM_LAYER4",L[L.HIGH_STREAM_LAYER5=8]="HIGH_STREAM_LAYER5",L[L.HIGH_STREAM_LAYER6=9]="HIGH_STREAM_LAYER6",L}({}),_L=function(L){return L[L.DISABLE=0]="DISABLE",L[L.LOW_STREAM=1]="LOW_STREAM",L[L.AUDIO_ONLY=2]="AUDIO_ONLY",L[L.HIGH_STREAM_LAYER1=3]="HIGH_STREAM_LAYER1",L[L.HIGH_STREAM_LAYER2=4]="HIGH_STREAM_LAYER2",L[L.HIGH_STREAM_LAYER3=5]="HIGH_STREAM_LAYER3",L[L.HIGH_STREAM_LAYER4=6]="HIGH_STREAM_LAYER4",L[L.HIGH_STREAM_LAYER5=7]="HIGH_STREAM_LAYER5",L[L.HIGH_STREAM_LAYER6=8]="HIGH_STREAM_LAYER6",L}({}),EL=function(L){return L.TRANSCEIVER_UPDATED="transceiver-updated",L.SEI_TO_SEND="sei-to-send",L.SEI_RECEIVED="sei-received",L.TRACK_UPDATED="track-updated",L}({}),fL=function(L){return L.SOURCE_STATE_CHANGE="source-state-change",L.TRACK_ENDED="track-ended",L.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",L.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",L.CLOSED="closed",L}({}),mL=function(L){return L.FIRST_FRAME_DECODED="first-frame-decoded",L.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",L.VIDEO_STATE_CHANGED="video-state-changed",L}({}),gL=function(L){return L.AUDIO="audio",L.VIDEO="video",L.DATA="data",L}({}),TL=function(L){return L.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",L.RECEIVE_TRACK_BUFFER="receive_track_buffer",L.ON_AUDIO_BUFFER="on_audio_buffer",L.UPDATE_SOURCE="update_source",L}({});const SL={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},RL={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},IL={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receivePacketsDiscarded:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},yL={uplinkNetworkQuality:0,downlinkNetworkQuality:0},AL={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1};let CL=function(L){return L.ON_TRACK="on_track",L.ON_NODE="on_node",L}({}),vL=function(L){return L.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",L.REQUEST_CONSTRAINTS="request_constraints",L}({}),bL=function(L){return L.IDLE="IDLE",L.INITING="INITING",L.INITEND="INITEND",L}({}),wL=function(L){return L.STATE_CHANGE="state_change",L.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",L.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",L.CAMERA_DEVICE_CHANGED="cameraDeviceChanged",L}({}),OL=function(L){return L.NONE="none",L.INIT="init",L.CANPLAY="canplay",L.PLAYING="playing",L.PAUSED="paused",L.SUSPEND="suspend",L.STALLED="stalled",L.WAITING="waiting",L.ERROR="error",L.DESTROYED="destroyed",L.ABORT="abort",L.ENDED="ended",L.EMPTIED="emptied",L.LOADEDDATA="loadeddata",L}({}),NL=function(L){return L[L.VideoStateStopped=0]="VideoStateStopped",L[L.VideoStateStarting=1]="VideoStateStarting",L[L.VideoStateDecoding=2]="VideoStateDecoding",L[L.VideoStateFrozen=3]="VideoStateFrozen",L}({});const DL={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370};let PL=function(L){return L.OPEN="open",L.MESSAGE="message",L.CLOSE="close",L.CLOSING="closing",L.ERROR="error",L}({});function xL(L,k,M,U,x){var V,F,j={};return Object.keys(U).forEach((function(L){j[L]=U[L]})),j.enumerable=!!j.enumerable,j.configurable=!!j.configurable,("value"in j||j.initializer)&&(j.writable=!0),j=kr(V=HO(F=M.slice()).call(F)).call(V,(function(M,U){return U(L,k,M)||M}),j),x&&void 0!==j.initializer&&(j.value=j.initializer?j.initializer.call(x):void 0,j.initializer=void 0),void 0===j.initializer&&(Object.defineProperty(L,k,j),j=null),j}function VL(L,k,M){return(k=function(L){var k=function(L,k){if("object"!=typeof L||!L)return L;var M=L[Symbol.toPrimitive];if(void 0!==M){var U=M.call(L,"string");if("object"!=typeof U)return U;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(L)}(L);return"symbol"==typeof k?k:k+""}(k))in L?Object.defineProperty(L,k,{value:M,enumerable:!0,configurable:!0,writable:!0}):L[k]=M,L}function FL(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function BL(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?FL(Object(M),!0).forEach((function(k){VL(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):FL(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}class jL extends My{set _mediaStreamTrack(L){L!==this.mediaStreamTrack&&(this.safeEmit(EL.TRACK_UPDATED,L),this.mediaStreamTrack=L)}get _mediaStreamTrack(){return this.mediaStreamTrack}constructor(L,k){super(),VL(this,"trackMediaType",void 0),VL(this,"_ID",void 0),VL(this,"_rtpTransceiver",void 0),VL(this,"_lowRtpTransceiver",void 0),VL(this,"_hints",[]),VL(this,"_isClosed",!1),VL(this,"_originMediaStreamTrack",void 0),VL(this,"mediaStreamTrack",void 0),VL(this,"_external",{}),this._ID=k||fA(8,"track-"),this._originMediaStreamTrack=L,this.mediaStreamTrack=L,function(L){Sr(rL).call(rL,L)||rL.push(L)}(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(L){return L||aA((()=>{var L;Ab.reportApiInvoke(null,{name:dv.GET_MEDIA_STREAM_TRACK,options:[],tag:lv.TRACER}).onSuccess((null===(L=this._mediaStreamTrack)||void 0===L?void 0:L.label)||"")}),this.mediaStreamTrack.id||this.getTrackId()),this._mediaStreamTrack}getRTCRtpTransceiver(L){return L===lL.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,function(L){const k=rL.indexOf(L);-1!==k&&rL.splice(k,1)}(this),this.emit(fL.CLOSED),this.removeAllListeners(EL.SEI_RECEIVED)}_updateRtpTransceiver(L,k){if(k===lL.LOW_STREAM){if(this._lowRtpTransceiver===L)return;this._lowRtpTransceiver=L}else{if(this._rtpTransceiver===L)return;this._rtpTransceiver=L}this.emit(EL.TRANSCEIVER_UPDATED,L,k)}}class GL extends jL{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}constructor(L,k){super(L,k),VL(this,"_enabled",!0),VL(this,"_muted",!1),VL(this,"_isExternalTrack",!1),VL(this,"_isClosed",!1),VL(this,"_enabledMutex",void 0),VL(this,"processor",void 0),VL(this,"_processorContext",void 0),VL(this,"_handleTrackEnded",(()=>{this.onTrackEnded()})),this._enabledMutex=new wv("".concat(this.getTrackId())),L.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var L,k;return null!==(L=null===(k=this._originMediaStreamTrack)||void 0===k?void 0:k.label)&&void 0!==L?L:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,Eb.debug("[".concat(this.getTrackId(),"] close")),this.emit(oL.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(L,k){let M=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this._isExternalTrack=M,L!==this._originMediaStreamTrack&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),k&&this._originMediaStreamTrack.stop()),L.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=L,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Qy(this,oL.NEED_REPLACE_TRACK,this),this.processor&&this._processorContext&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this._processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){Eb.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(fL.TRACK_ENDED)}stateCheck(L,k){if(Eb.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(L,": ").concat(k,"]")),Ry(k,L),this._enabled&&this._muted&&"enabled"===L&&!1===k)throw new nv(iv.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",Eb);if(!this._enabled&&!this._muted&&"muted"===L&&!0===k)throw new nv(iv.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",Eb)}getProcessorStats(){return this._processorContext&&this._processorContext.gatherStats()||[]}getProcessorUsage(){return this._processorContext?this._processorContext.gatherUsage():Mp.resolve([])}}const LL=window.AudioContext||window.webkitAudioContext;let kL=null;const ML=new class extends My{constructor(){super(...arguments),VL(this,"prevState",void 0),VL(this,"curState",void 0),VL(this,"currentTime",void 0),VL(this,"currentTimeStuckAt",void 0),VL(this,"interruptDetectorTrack",void 0),VL(this,"onLocalAudioTrackMute",(()=>{Eb.info("ios15-interruption-start"),this.emit(zP.IOS_15_16_INTERRUPTION_START)})),VL(this,"onLocalAudioTrackUnmute",(async()=>{Eb.info("ios15-interruption-end"),"running"!==this.curState||this.duringInterruption?Eb.info("ios15-interruption-end-canceled"):(kL&&await kL.suspend(),this.emit(zP.IOS_15_16_INTERRUPTION_END))}))}get duringInterruption(){return"running"===this.prevState&&"interrupted"===this.curState}bindInterruptDetectorTrack(L){Eb.debug("webaudio bindInterruptDetectorTrack ".concat(L.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=L,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(L){Eb.debug("webaudio unbindInterruptDetectorTrack ".concat(L.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===L&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function YL(){if(!kL){if(function(){if(!LL)return void Eb.error("your browser is not support web audio");Eb.info("create audio context");const L=BL({},zA("WEBAUDIO_INIT_OPTIONS"));Eb.debug("audio context init option:",JSON.stringify(L)),kL=new LL(L),ML.curState=kL.state,kL.onstatechange=()=>{ML.prevState=ML.curState,ML.curState=kL?kL.state:void 0;const{prevState:L,curState:k}=ML,M="running"===k,U="interrupted"===k,x="running"===L,V="suspended"===L,F="interrupted"===L,j=Gv().osVersion;(Qv()||dy())&&x&&U&&(Eb.info("ios".concat(j,"-interruption-start")),ML.emit(zP.IOS_INTERRUPTION_START)),(Qv()||dy())&&(V||F)&&M&&(Eb.info("ios".concat(j,"-interruption-end")),ML.emit(zP.IOS_INTERRUPTION_END)),L!==k&&ML.emit(zP.STATE_CHANGE,k,L)},setInterval((()=>{var L;const k=null===(L=kL)||void 0===L?void 0:L.currentTime;ML.currentTime!==k?(ML.currentTimeStuckAt&&(Eb.debug("AudioContext current time resume at ".concat(k)),ML.currentTimeStuckAt=void 0),ML.currentTime=k):(k!==ML.currentTimeStuckAt&&(Ab.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:k},tag:lv.TRACER}).onSuccess(),Eb.warning("AudioContext current time stuck at ".concat(k))),ML.currentTimeStuckAt=k)}),5e3),async function(L){const k=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"];let M,U=!1,x=!1,V=!1;function s(k){"running"===L.state?a(!1):Qv()||dy()?"suspended"===L.state&&(a(!0),k&&L.resume().then(c,c)):"closed"!==L.state&&(a(!0),k&&L.resume().then(c,c))}function a(L){if(U!==L){U=L;for(let M=0,U=k;M<U.length;M+=1){const k=U[M];L?window.addEventListener(k,d,{capture:!0,passive:!0}):window.removeEventListener(k,d,{capture:!0,passive:!0})}}}function c(){s(!1)}function d(){s(!0)}function l(L){if(!V)if(M.paused)if(L){let k;u(!1),V=!0;try{k=M.play(),k?k.then(h,h):(M.addEventListener("playing",h),M.addEventListener("abort",h),M.addEventListener("error",h))}catch(L){h()}}else u(!0);else u(!1)}function u(L){if(x!==L){x=L;for(let M=0,U=k;M<U.length;M++){const k=U[M];L?window.addEventListener(k,p,{capture:!0,passive:!0}):window.removeEventListener(k,p,{capture:!0,passive:!0})}}}function h(){M.removeEventListener("playing",h),M.removeEventListener("abort",h),M.removeEventListener("error",h),V=!1,l(!1)}function p(){l(!0)}if(Qv()){const k=L.createMediaStreamDestination(),U=document.createElement("div");U.innerHTML="<audio x-webkit-airplay='deny'></audio>",M=U.children.item(0),M.controls=!1,M.disableRemotePlayback=!0,M.preload="auto",M.srcObject=k.stream,l(!0)}ML.on(zP.STATE_CHANGE,(function(){s(!0)})),s(!1)}(kL)}(),!kL)throw new nv(iv.NOT_SUPPORTED,"can not create audio context");return kL}return kL}function qL(L){if(function(){if(null!==UL)return UL;const L=YL(),k=L.createBufferSource(),M=L.createGain(),U=L.createGain();k.connect(M),k.connect(U),k.disconnect(M);let x=!1;try{k.disconnect(M)}catch(L){x=!0}return k.disconnect(),UL=x,x}())return;const k=L.connect,M=L.disconnect;L.connect=(M,U,x)=>{var V;return L._inputNodes||(L._inputNodes=[]),Sr(V=L._inputNodes).call(V,M)||(M instanceof AudioNode?(L._inputNodes.push(M),k.call(L,M,U,x)):k.call(L,M,U)),L},L.disconnect=(U,x,V)=>{M.call(L),U?tA(L._inputNodes,U):L._inputNodes=[];for(const M of L._inputNodes)k.call(L,M)}}let UL=null;function JL(L,k){let M=!1;const U=1/k;if(zA("DISABLE_WEBAUDIO")){const k=window.setInterval((()=>{M?window.clearInterval(k):L(performance.now()/1e3)}),1e3*U)}else{const k=YL();let x=k.createGain();x.gain.value=0,x.connect(k.destination);const o=()=>{if(M)return void(x=null);const V=k.createOscillator();V.onended=o,V.connect(x),V.start(0),V.stop(k.currentTime+U),L(k.currentTime)};o()}return()=>{M=!0}}class XL{constructor(){VL(this,"context",void 0),VL(this,"analyserNode",void 0),VL(this,"sourceNode",void 0),this.context=YL(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(L){if(L!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch(L){}this.sourceNode=L,null==L||L.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode)return 0;if(!this.context||Qv()||dy()||"running"!==this.context.state&&this.context.resume(),!this.analyserNode)return 0;const L=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(L);else{const k=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(k);for(let M=0;M<L.length;++M)L[M]=k[M]/128-1}const k=kr(L).call(L,((L,k)=>L+k*k),0)/L.length;return Math.max(10*Math.log10(k)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var L,k;null===(L=this.sourceNode)||void 0===L||L.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,null===(k=this.sourceNode)||void 0===k||k.connect(this.analyserNode)}catch(L){Eb.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class QL extends My{get processSourceNode(){return this.sourceNode}set processedNode(L){var k;if(!this.isDestroyed&&this._processedNode!==L){try{var M;null===(M=this.sourceNode)||void 0===M||M.disconnect(this.outputNode)}catch(L){}null===(k=this._processedNode)||void 0===k||k.disconnect(),this._processedNode=L,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),VL(this,"outputNode",void 0),VL(this,"outputTrack",void 0),VL(this,"isPlayed",!1),VL(this,"sourceNode",void 0),VL(this,"context",void 0),VL(this,"audioBufferNode",void 0),VL(this,"destNode",void 0),VL(this,"audioOutputLevel",0),VL(this,"volumeLevelAnalyser",void 0),VL(this,"_processedNode",void 0),VL(this,"playNode",void 0),VL(this,"isDestroyed",!1),VL(this,"onNoAudioInput",void 0),VL(this,"isNoAudioInput",!1),VL(this,"_noAudioInputCount",0),this.context=YL(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),qL(this.outputNode),this.volumeLevelAnalyser=new XL}startGetAudioBuffer(L){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(L),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=L=>{this.emit(TL.ON_AUDIO_BUFFER,function(L){for(let k=0;k<L.outputBuffer.numberOfChannels;k+=1){const M=L.outputBuffer.getChannelData(k);for(let L=0;L<M.length;L+=1)M[L]=0}return L.inputBuffer}(L))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!XP().webAudioMediaStreamDest)throw new nv(iv.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(L){"running"!==this.context.state&&nA((()=>{ML.emit("autoplay-failed")})),this.isPlayed=!0,this.playNode=L||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch(L){}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let L=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(L>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;Qv()||dy()?"suspended"===this.context.state&&this.context.resume():"running"!==this.context.state&&this.context.resume();const k=this.volumeLevelAnalyser.getAnalyserNode();let M;k.getFloatTimeDomainData?(M=new Float32Array(k.fftSize),k.getFloatTimeDomainData(M)):(M=new Uint8Array(k.fftSize),k.getByteTimeDomainData(M));let U=!1;for(let L=0;L<M.length;L++)0!==M[L]&&(U=!0);return U?(this.isNoAudioInput=!1,!0):(await EA(200),await this.checkHasAudioInput(L?L+1:1)&&U)}getAudioVolume(){return this.outputNode.gain.value}setVolume(L){this.outputNode.gain.setValueAtTime(L,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var L,k;null===(L=this.processedNode)||void 0===L||L.disconnect(),null===(k=this.sourceNode)||void 0===k||k.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var L;this.processedNode?null===(L=this.processedNode)||void 0===L||L.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class ZL extends QL{get isFreeze(){return!1}constructor(L,k,M){var U;if(super(),VL(this,"sourceNode",void 0),VL(this,"track",void 0),VL(this,"clonedTrack",void 0),VL(this,"audioElement",void 0),VL(this,"isCurrentTrackCloned",!1),VL(this,"isRemoteTrack",!1),VL(this,"originVolumeLevelAnalyser",void 0),VL(this,"rebuildWebAudio",(async()=>{if(Eb.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void Eb.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then((()=>Eb.info("resume success"))),Eb.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();const L=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?L.stop():this.isCurrentTrackCloned=!0;const k=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(k),qL(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();const M=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(M,this.context.currentTime),qL(this.outputNode),this.emit(TL.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=k,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()})),"audio"!==L.kind)throw new nv(iv.UNEXPECTED_ERROR);this.track=L;const x=new MediaStream([this.track]);if(this.isRemoteTrack=!!k,this.sourceNode=this.context.createMediaStreamSource(x),qL(this.sourceNode),M){const L=M.clone();L.enabled=!0,this.clonedTrack=L,Eb.debug("create an unmuted track ".concat(L.id," from the original track ").concat(M.id," to get the volume"));const k=this.context.createMediaStreamSource(new MediaStream([L]));qL(k),this.originVolumeLevelAnalyser=new XL,this.originVolumeLevelAnalyser.updateSource(k)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=x;const V=Gv();k&&V.os===XC.IOS&&Number(null===(U=V.osVersion)||void 0===U?void 0:U.split(".")[0])<15&&(ML.on(zP.STATE_CHANGE,(()=>{"suspended"===this.context.state?document.body.addEventListener("click",this.rebuildWebAudio,!0):"running"===this.context.state&&this.rebuildWebAudio()})),this.checkHasAudioInput().then((L=>{L||document.body.addEventListener("click",this.rebuildWebAudio,!0)})))}updateTrack(L){this.sourceNode.disconnect(),this.track=L,this.isCurrentTrackCloned=!1;const k=new MediaStream([L]);this.sourceNode=this.context.createMediaStreamSource(k),qL(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(TL.UPDATE_SOURCE),this.audioElement.srcObject=k}destroy(){var L;this.audioElement.srcObject=null,this.audioElement.remove(),ML.off("state-change",this.rebuildWebAudio),null===(L=this.originVolumeLevelAnalyser)||void 0===L||L.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(L){return this.context.createMediaStreamSource(new MediaStream([L]))}updateOriginTrack(L){const k=L.clone();k.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=k),Eb.debug("create an unmuted track ".concat(k.id," from the original track ").concat(L.id," to get the volume"));const M=this.context.createMediaStreamSource(new MediaStream([k]));qL(M),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(M)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}async function $L(L,k,M){const n=(L,k)=>L?"number"!=typeof L?L.max||L.exact||L.ideal||L.min||k:L:k,U={audio:!!M&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:L,maxHeight:n(k.height,1080),maxWidth:n(k.width,1920)}}};return k.frameRate&&"number"!=typeof k.frameRate?(U.video.mandatory.maxFrameRate=k.frameRate.max,U.video.mandatory.minFrameRate=k.frameRate.min):"number"==typeof k.frameRate&&(U.video.mandatory.maxFrameRate=k.frameRate),await navigator.mediaDevices.getUserMedia(U)}async function tk(L){let k=["window","screen"];"application"!==L&&"window"!==L||(k=["window"]),"screen"===L&&(k=["screen"]);const M=xy();if(!M)throw console.error("failed to fetch electron, please mount it to window"),new nv(iv.ELECTRON_IS_NULL);let U=null;try{var x;U=(null===(x=M.desktopCapturer)||void 0===x?void 0:x.getSources({types:k}))||M.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:k})}catch(L){U=null}U&&U.then||(U=new Mp(((L,U)=>{M.desktopCapturer.getSources({types:k},((k,M)=>{k?U(k):L(M)}))})));try{return await U}catch(L){throw new nv(iv.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,L.toString())}}const WL=new wv("safari");let HL=!1,KL=!1;async function ok(L,k){let M=0,U=null;for(;M<2;)try{U=await sk(L,k,M>0);break}catch(L){if(L instanceof nv)throw Eb.error("[".concat(k,"] ").concat(L.toString())),L;const U=ak(L.name||L.code||L,L.message);if(U.code===iv.MEDIA_OPTION_INVALID){Eb.debug("[".concat(k,"] detect media option invalid, retry")),M+=1,await EA(500);continue}throw Eb.error("[".concat(k,"] ").concat(U.toString())),U}if(!U)throw new nv(iv.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return U}async function sk(L,k,M){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new nv(iv.NOT_SUPPORTED,"can not find getUserMedia");M&&(L.video&&(delete L.video.width,delete L.video.height),L.screen&&(delete L.screen.width,delete L.screen.height));const U=XP(),x=new MediaStream;if(L.audioSource&&x.addTrack(L.audioSource),L.videoSource&&x.addTrack(L.videoSource),!L.audio&&!L.video&&!L.screen)return Eb.debug("Using Video Source/ Audio Source"),x;if(L.screen)if(xy())L.screen.sourceId?ck(x,await $L(L.screen.sourceId,L.screen,L.screenAudio)):ck(x,await async function ek(L,k){const M=await tk(L.mediaSource),{sourceId:U,audio:x}=await function(L){let k=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new Mp(((M,U)=>{const x=document.createElement("div");x.innerText="share screen",x.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");const V=document.createElement("div");V.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");const F=document.createElement("div");F.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",F.setAttribute("style","height: 12%;");const j=document.createElement("div");j.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");const z=document.createElement("div");z.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");const Q=document.createElement("button");Q.innerHTML="cancel",Q.setAttribute("style","width: 85px;"),Q.onclick=()=>{document.body.removeChild(te);const L=new Error("NotAllowedError");L.name="NotAllowedError",U(L)};let $=k;const ee=document.createElement("div");if(k){const L=document.createElement("input");L.setAttribute("type","checkbox");const k=document.createElement("span");L.setAttribute("style","margin-right: 6px;"),k.innerText="Share audio",L.checked=$,L.onchange=()=>{$=L.checked},ee.appendChild(L),ee.appendChild(k)}z.appendChild(ee),z.appendChild(Q),V.appendChild(F),V.appendChild(j),V.appendChild(z);const te=document.createElement("div");te.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),te.appendChild(x),te.appendChild(V),document.body.appendChild(te),L.map((L=>{if(L.id){const k=document.createElement("div");k.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let U=L.thumbnail;try{const{width:L}=U.getSize();L>1920&&(U=U.resize({width:1920}))}catch(L){throw L&&L.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),L}k.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+U.toDataURL()+' /></div><span style="\theight: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+L.name.replace(/[\u00A0-\u9999<>\&]/g,(function(L){return"&#"+L.charCodeAt(0)+";"}))+"</span>",k.onclick=()=>{document.body.removeChild(te),M({sourceId:L.id,audio:$})},j.appendChild(k)}}))}))}(M,k);return await $L(U,L,x)}(L.screen,L.screenAudio));else if(qv()&&L.screen.extensionId&&L.screen.mandatory){if(!U.getStreamFromExtension)throw new nv(iv.NOT_SUPPORTED,"This browser does not support screen sharing");Eb.debug("[".concat(k,'] Screen access on chrome stable, looking for extension"'));const M=await(F=L.screen.extensionId,j=k,new Mp(((L,k)=>{try{chrome.runtime.sendMessage(F,{getStream:!0},(M=>{if(!M||!M.streamId)return Eb.error("[".concat(j,"] No response from Chrome Plugin. Plugin not installed properly"),M),void k(new nv(iv.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));L(M.streamId)}))}catch(L){Eb.error("[".concat(j,"] AgoraRTC screensharing plugin is not accessible(").concat(F,")"),L.toString()),k(new nv(iv.CHROME_PLUGIN_NOT_INSTALL))}})));L.screen.mandatory.chromeMediaSourceId=M,ck(x,await navigator.mediaDevices.getUserMedia({video:{mandatory:L.screen.mandatory}}))}else if(U.getDisplayMedia){var V;L.screen.mediaSource&&pL(L.screen.mediaSource);const M={width:L.screen.width,height:L.screen.height,frameRate:L.screen.frameRate,displaySurface:null!==(V=L.screen.displaySurface)&&void 0!==V?V:"screen"===L.screen.mediaSource?"monitor":L.screen.mediaSource},{selfBrowserSurface:U,surfaceSwitching:F,systemAudio:j}=L.screen,z={selfBrowserSurface:U,surfaceSwitching:F,systemAudio:j};!U&&delete z.selfBrowserSurface,!F&&delete z.surfaceSwitching,!j&&delete z.systemAudio,Eb.debug("[".concat(k,"] getDisplayMedia:"),JSON.stringify({video:M,audio:!!L.screenAudio,controls:z})),ck(x,await navigator.mediaDevices.getDisplayMedia(BL({video:M,audio:!!L.screenAudio},z)))}else{if(!Xv())throw Eb.error("[".concat(k,"] This browser does not support screenSharing")),new nv(iv.NOT_SUPPORTED,"This browser does not support screen sharing");{L.screen.mediaSource&&pL(L.screen.mediaSource);const M={video:{mediaSource:L.screen.mediaSource,width:L.screen.width,height:L.screen.height,frameRate:L.screen.frameRate}};Eb.debug("[".concat(k,"] getUserMedia: ").concat(JSON.stringify(M))),ck(x,await navigator.mediaDevices.getUserMedia(M))}}var F,j;if(!L.video&&!L.audio)return x;let z={video:L.video,audio:L.audio},Q=zA("MEDIA_DEVICE_CONSTRAINTS");if(Q)try{"string"==typeof Q&&(Q=JSON.parse(Q)),z=CA(z,Q)}catch(L){}Eb.debug("[".concat(k,"] GetUserMedia"),JSON.stringify(z)),Gv();let $,ee=null;(zv()||Qv()||Yv())&&(ee=await WL.lock());try{$=await navigator.mediaDevices.getUserMedia(z)}catch(L){throw ee&&ee(),L}return z.audio&&(HL=!0),z.video&&(KL=!0),ck(x,$),ee&&ee(),x}function ak(L,k){switch(L){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new nv(iv.MEDIA_OPTION_INVALID,"".concat(L,": ").concat(k));case"NotFoundError":case"DevicesNotFoundError":return new nv(iv.DEVICE_NOT_FOUND,"".concat(L,": ").concat(k));case"NotSupportedError":return new nv(iv.NOT_SUPPORTED,"".concat(L,": ").concat(k));case"NotReadableError":return new nv(iv.NOT_READABLE,"".concat(L,": ").concat(k));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new nv(iv.PERMISSION_DENIED,"".concat(L,": ").concat(k));case"ConstraintNotSatisfiedError":return new nv(iv.CONSTRAINT_NOT_SATISFIED,"".concat(L,": ").concat(k));default:return Eb.error("getUserMedia unexpected error",L),new nv(iv.UNEXPECTED_ERROR,"".concat(L,": ").concat(k))}}function ck(L,k){const M=L.getVideoTracks()[0],U=L.getAudioTracks()[0],x=k.getVideoTracks()[0],V=k.getAudioTracks()[0];V&&(U&&L.removeTrack(U),L.addTrack(V)),x&&(M&&L.removeTrack(M),L.addTrack(x))}const zL=new class extends My{get state(){return this._state}set state(L){L!==this._state&&(this.emit(wL.STATE_CHANGE,L),this._state=L)}constructor(){super(),VL(this,"_state",bL.IDLE),VL(this,"isAccessMicrophonePermission",!1),VL(this,"isAccessCameraPermission",!1),VL(this,"lastAccessMicrophonePermission",!1),VL(this,"lastAccessCameraPermission",!1),VL(this,"checkdeviceMatched",!1),VL(this,"deviceInfoMap",new Map),this.init().then((()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval((()=>{(zA("ENUMERATE_DEVICES_INTERVAL")||(_y()||Hv()===XC.HARMONY_OS)&&py())&&this.updateDevicesInfo()}),zA("ENUMERATE_DEVICES_INTERVAL_TIME"))})).catch((L=>Eb.error(L.toString())))}async enumerateDevices(L,k){let M=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return new nv(iv.NOT_SUPPORTED,"enumerateDevices() not supported.").throw();const U=await navigator.mediaDevices.enumerateDevices(),x=this.checkMediaDeviceInfoIsOk(U);let V=!this.isAccessMicrophonePermission&&L,F=!this.isAccessCameraPermission&&k;x.audio&&(V=!1),x.video&&(F=!1);let j=null,z=null,Q=null;if(!M&&(V||F)){if(WL.isLocked&&(Eb.debug("[device manager] wait GUM lock"),(await WL.lock())(),Eb.debug("[device manager] GUM unlock")),HL&&(V=!1,this.isAccessMicrophonePermission=!0),KL&&(F=!1,this.isAccessCameraPermission=!0),Eb.debug("[device manager] check media device permissions",L,k,V,F),V&&F){try{Q=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(L){const k=ak(L.name||L.code||L,L.message);if(k.code===iv.PERMISSION_DENIED)throw k;Eb.warning("getUserMedia failed in getDevices",k)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(V){try{j=await navigator.mediaDevices.getUserMedia({audio:L})}catch(L){const k=ak(L.name||L.code||L,L.message);if(k.code===iv.PERMISSION_DENIED)throw k;Eb.warning("getUserMedia failed in getDevices",k)}this.isAccessMicrophonePermission=!0}else if(F){try{z=await navigator.mediaDevices.getUserMedia({video:k})}catch(L){const k=ak(L.name||L.code||L,L.message);if(k.code===iv.PERMISSION_DENIED)throw k;Eb.warning("getUserMedia failed in getDevices",k)}this.isAccessCameraPermission=!0}Eb.debug("[device manager] mic permission",L,"cam permission",k)}try{const L=await navigator.mediaDevices.enumerateDevices();return j&&j.getTracks().forEach((L=>L.stop())),z&&z.getTracks().forEach((L=>L.stop())),Q&&Q.getTracks().forEach((L=>L.stop())),j=null,z=null,Q=null,L}catch(L){return j&&j.getTracks().forEach((L=>L.stop())),z&&z.getTracks().forEach((L=>L.stop())),Q&&Q.getTracks().forEach((L=>L.stop())),j=null,z=null,Q=null,new nv(iv.ENUMERATE_DEVICES_FAILED,L.toString()).throw()}}async getRecordingDevices(){let L=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(await this.enumerateDevices(!0,!1,L)).filter((L=>"audioinput"===L.kind))}async getCamerasDevices(){let L=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(await this.enumerateDevices(!1,!0,L)).filter((L=>"videoinput"===L.kind))}async getSpeakers(){let L=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(await this.enumerateDevices(!0,!1,L)).filter((L=>"audiooutput"===L.kind))}searchDeviceIdByName(L){let k=null;return this.deviceInfoMap.forEach((M=>{M.device.label===L&&(k=M.device.deviceId)})),k}async getDeviceById(L){const k=(await this.enumerateDevices(!0,!0,!0)).find((k=>k.deviceId===L));if(!k)throw new nv(iv.DEVICE_NOT_FOUND,"deviceId: ".concat(L));return k}async init(){this.state=bL.INITING;try{await this.updateDevicesInfo(),this.state=bL.INITEND}catch(L){throw Eb.warning("Device Detection functionality cannot start properly.",L.toString()),this.state=bL.IDLE,("boolean"==typeof isSecureContext?isSecureContext:"https:"===location.protocol||"file:"===location.protocol||"localhost"===location.hostname||"127.0.0.1"===location.hostname||"::1"===location.hostname)||new nv(iv.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.").throw(),L}}async updateDevicesInfo(){const L=await this.enumerateDevices(!0,!0,!0),k=Date.now(),M=[];if(L[0]&&L[0].label&&!1===this.checkdeviceMatched){this.checkdeviceMatched=!0;const k=L.find((L=>"audioinput"===L.kind&&"default"===L.deviceId)),M=L.find((L=>"audiooutput"===L.kind&&"default"===L.deviceId));k&&M?M.groupId===k.groupId?Eb.debug("[device-check] default input ".concat(k.label," and output ").concat(M.label," is the same group")):Eb.warning("[device-check] default input ".concat(k.label," and output ").concat(M.label," is not the same group")):Eb.debug("[device-check] default input or output not found")}const U=this.checkMediaDeviceInfoIsOk(L);if(L.forEach((L=>{if(!L.deviceId)return;const U=this.deviceInfoMap.get("".concat(L.kind,"_").concat(L.deviceId));if("ACTIVE"!==(U?U.state:"INACTIVE")){const U={initAt:k,updateAt:k,device:L,state:"ACTIVE"};this.deviceInfoMap.set("".concat(L.kind,"_").concat(L.deviceId),U),M.push(U)}U&&(U.updateAt=k)})),this.deviceInfoMap.forEach(((L,U)=>{"ACTIVE"===L.state&&L.updateAt!==k&&(L.state="INACTIVE",M.push(L))})),this.state!==bL.INITEND)return U.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(U.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));M.forEach((L=>{switch(L.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(wL.RECORDING_DEVICE_CHANGED,L);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(wL.CAMERA_DEVICE_CHANGED,L);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(wL.PLAYOUT_DEVICE_CHANGED,L)}})),U.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),U.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(L){const k=L.filter((L=>"audioinput"===L.kind)),M=L.filter((L=>"videoinput"===L.kind)),U={audio:!1,video:!1};for(const L of k)if(L.label&&L.deviceId){U.audio=!0;break}for(const L of M)if(L.label&&L.deviceId){U.video=!0;break}return U}};let ik=!1;const nk=new class extends My{constructor(){super(...arguments),VL(this,"onAutoplayFailed",void 0),VL(this,"onAudioAutoplayFailed",void 0)}};function hk(){if(Gv(),!ik){const e=L=>{L.preventDefault(),ik=!1,Ey()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};ik=!0,Ey()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),Eb.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),nk.onAutoplayFailed?nk.onAutoplayFailed():nk.onAudioAutoplayFailed?Eb.warning("AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.\n\n  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web ."):Eb.warning("We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.\n\n  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.\n\n  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web ."),nk.emit("autoplay-failed")}}function pk(L,k,M,U){if(!L)return;const x=Ab.getBaseInfoBySessionId(L);if(!x)return;const V=x.info,F=Date.now(),j=BL(BL({},V),{},{vid:void 0===V.vid?0:Number(V.vid),lts:F,elapse:F-x.startTime,cbRegistered:nk.onAutoplayFailed||nk.onAudioAutoplayFailed?1:-1,errorMsg:M,mediaType:k,trackId:U,extend:void 0});Ab.send({type:Sb.AUTOPLAY_FAILED,data:j},!0)}const rk=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],dk=new class{constructor(){VL(this,"onAutoplayFailed",void 0),VL(this,"elementMap",new Map),VL(this,"elementStateMap",new Map),VL(this,"elementsNeedToResume",[]),VL(this,"sinkIdMap",new Map),VL(this,"autoResumeAfterInterruption",(L=>{Array.from(this.elementMap.entries()).forEach((k=>{let[M,U]=k;const x=this.elementStateMap.get(M),V=U.srcObject.getAudioTracks()[0],F=V&&V.readyState;if(Eb.debug("resume after interrupted, ele: ".concat(x," audio: ").concat(F," ").concat(L)),"live"===F){if(L)return U.pause(),void U.play();if("running"===ML.curState)return sy()?(U.pause(),void U.play()):void(x&&"paused"===x&&U.play())}}))})),VL(this,"autoResumeAfterInterruptionOnIOS15_16",(()=>{Array.from(this.elementMap.entries()).forEach((L=>{let[k,M]=L;const U=M.srcObject.getAudioTracks()[0];U&&"live"===U.readyState&&(Eb.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),M.pause(),M.play())}))})),this.autoResumeAudioElement(),ML.on(zP.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),ML.on(zP.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),ML.on(zP.STATE_CHANGE,(()=>{Qv()&&"suspended"===ML.prevState&&"running"===ML.curState&&this.autoResumeAfterInterruption()}))}async setSinkID(L,k){const M=this.elementMap.get(L);if(this.sinkIdMap.set(L,k),M)try{await M.setSinkId(k)}catch(L){throw new nv(iv.PERMISSION_DENIED,"can not set sink id: "+L.toString())}}play(L,k,M,U){if(this.elementMap.has(k))return;const x=document.createElement("audio");x.autoplay=!0,x.srcObject=new MediaStream([L]),this.bindAudioElementEvents(k,x),this.elementMap.set(k,x),this.elementStateMap.set(k,OL.INIT),this.setVolume(k,M);const V=this.sinkIdMap.get(k);if(V)try{x.setSinkId(V).catch((L=>{Eb.warning("[".concat(k,"] set sink id failed"),L.toString())}))}catch(L){Eb.warning("[".concat(k,"] set sink id failed"),L.toString())}const F=x.play();F&&F.then&&F.catch((L=>{U&&pk(U,"audio",L.message,k),Eb.warning("audio element play warning",L.toString()),this.elementMap.has(k)&&"NotAllowedError"===L.name&&(Eb.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(x),nA((()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),hk()})))}))}updateTrack(L,k){const M=this.elementMap.get(L);M&&(M.srcObject=new MediaStream([k]))}isPlaying(L){return this.elementMap.has(L)&&"playing"===this.elementStateMap.get(L)}setVolume(L,k){const M=this.elementMap.get(L);M&&(k=Math.max(0,Math.min(100,k)),M.volume=k/100)}stop(L){const k=this.elementMap.get(L);if(this.sinkIdMap.delete(L),!k)return;const M=this.elementsNeedToResume.indexOf(k);this.elementsNeedToResume.splice(M,1),k.srcObject=null,k.remove(),this.elementMap.delete(L),this.elementStateMap.delete(L)}bindAudioElementEvents(L,k){rk.forEach((M=>{k.addEventListener(M,(M=>{const U=this.elementStateMap.get(L),x="pause"===M.type?"paused":M.type;if(Eb.debug("[".concat(L,"] audio-element-status change ").concat(U," => ").concat(x)),"error"===M.type){const M=null==k?void 0:k.error;M&&Eb.error("[".concat(L,"] media error, code: ").concat(M.code,", message: ").concat(M.message))}this.elementStateMap.set(L,x)}))}))}getPlayerState(L){return this.elementStateMap.get(L)||"uninit"}autoResumeAudioElement(){const e=()=>{this.elementsNeedToResume.forEach((L=>{L.play().then((L=>{Eb.debug("Auto resume audio element success")})).catch((L=>{Eb.warning("Auto resume audio element failed!",L)}))})),this.elementsNeedToResume=[]};new Mp((L=>{document.body?L():window.addEventListener("load",(()=>L()))})).then((()=>{Ey()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0))}))}};function fk(){return function(L,k,M){const U=M.value;return"function"==typeof U&&(M.value=function(){this._isClosed&&new nv(iv.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",Eb);for(var L=arguments.length,k=new Array(L),M=0;M<L;M++)k[M]=arguments[M];const x=U.apply(this,k);return x instanceof Mp?new Mp(((L,k)=>{x.then(L).catch(k)})):x}),M}}class mk extends My{constructor(L){super(),VL(this,"name","VideoProcessorDestination"),VL(this,"ID","0"),VL(this,"_source",void 0),VL(this,"videoContext",void 0),VL(this,"inputTrack",void 0),this.videoContext=L}get kind(){return"video"}get enabled(){return!0}pipe(){throw new nv(iv.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new nv(iv.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(L){if(L.context!==this.videoContext)throw new Error("ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.\nProbably you are making pipeline like this:\nvideoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).");L.track&&L.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=L.track,this.emit(CL.ON_TRACK,L.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(CL.ON_TRACK,void 0)}}class Tk extends My{set chained(L){this._chained=L}get chained(){return this._chained}constructor(L,k){super(),VL(this,"constraintsMap",new Map),VL(this,"statsRegistry",[]),VL(this,"usageRegistry",[]),VL(this,"trackId",void 0),VL(this,"direction",void 0),VL(this,"_chained",!1),this.trackId=L,this.direction=k}async getConstraints(){return await Xy(this,vL.REQUEST_CONSTRAINTS)}async requestApplyConstraints(L,k){var M;return Eb.info("processor ".concat(k.name," requestApplyConstraints for ").concat(this.trackId)),L&&this.constraintsMap.set(k,L),Qy(this,vL.REQUEST_UPDATE_CONSTRAINTS,Array.from(dN(M=this.constraintsMap).call(M)))}async requestRevertConstraints(L){var k;if(this.constraintsMap.has(L))return Eb.info("processor ".concat(L.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(L),Qy(this,vL.REQUEST_UPDATE_CONSTRAINTS,Array.from(dN(k=this.constraintsMap).call(k)))}registerStats(L,k,M){this.statsRegistry.find((M=>M.processorID===L.ID&&M.processorName===L.name&&M.type===k))||this.statsRegistry.push({processorName:L.name,processorID:L.ID,type:k,cb:M})}unregisterStats(L,k){const M=this.statsRegistry.findIndex((M=>M.processorID===L.ID&&M.processorName===L.name&&M.type===k));-1!==M&&this.statsRegistry.splice(M,1)}gatherStats(){const L=[];for(const{processorID:k,processorName:M,type:U,cb:x}of this.statsRegistry)try{const V=x();L.push({processorID:k,processorName:M,type:U,stats:V})}catch(L){Eb.error(new nv(iv.UNEXPECTED_ERROR,L.message))}return L}registerUsage(L,k){this.usageRegistry.find((k=>k.processorID===L.ID&&k.processorName===L.name))||this.usageRegistry.push({processorID:L.ID,processorName:L.name,cb:k})}unregisterUsage(L){const k=this.usageRegistry.findIndex((k=>k.processorID===L.ID&&k.processorName===L.name));-1!==k&&this.usageRegistry.splice(k,1)}async gatherUsage(){const L=[];if(!this.chained)return[];for(const{cb:k}of this.usageRegistry)try{let M=k();M instanceof Mp&&(M=await M),L.push(BL(BL({},M),{},{direction:this.direction}))}catch(L){Eb.error("gather extension usage error",L)}return L}getDirection(){return this.direction}}class Sk extends My{constructor(L){super(),VL(this,"name","AudioProcessorDestination"),VL(this,"ID","0"),VL(this,"inputTrack",void 0),VL(this,"inputNode",void 0),VL(this,"audioProcessorContext",void 0),VL(this,"_source",void 0),this.audioProcessorContext=L}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new nv(iv.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new nv(iv.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(CL.ON_TRACK,void 0),this.emit(CL.ON_NODE,void 0)}updateInput(L){if(L.context!==this.audioProcessorContext)throw new Error("ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.\n        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).");L.track&&this.inputTrack!==L.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=L.track,this.emit(CL.ON_TRACK,this.inputTrack)),L.node&&this.inputNode!==L.node&&(this.audioProcessorContext.chained=!0,this.inputNode=L.node,this.emit(CL.ON_NODE,this.inputNode))}}class gk extends My{set chained(L){this._chained=L}get chained(){return this._chained}constructor(L,k,M){super(),VL(this,"constraintsMap",new Map),VL(this,"statsRegistry",[]),VL(this,"audioContext",void 0),VL(this,"trackId",void 0),VL(this,"direction",void 0),VL(this,"usageRegistry",[]),VL(this,"_chained",!1),this.audioContext=L,this.trackId=k,this.direction=M}async getConstraints(){return Xy(this,vL.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(L,k){var M;return Eb.info("processor ".concat(k.name," requestApplyConstraints for ").concat(this.trackId)),L&&this.constraintsMap.set(k,L),Qy(this,vL.REQUEST_UPDATE_CONSTRAINTS,Array.from(dN(M=this.constraintsMap).call(M)))}async requestRevertConstraints(L){var k;if(this.constraintsMap.has(L))return this.constraintsMap.delete(L),Qy(this,vL.REQUEST_UPDATE_CONSTRAINTS,Array.from(dN(k=this.constraintsMap).call(k)))}registerStats(L,k,M){this.statsRegistry.find((M=>M.processorID===L.ID&&M.processorName===L.name&&M.type===k))||this.statsRegistry.push({processorName:L.name,processorID:L.ID,type:k,cb:M})}unregisterStats(L,k){const M=this.statsRegistry.findIndex((M=>M.processorID===L.ID&&M.processorName===L.name&&M.type===k));-1!==M&&this.statsRegistry.splice(M,1)}gatherStats(){const L=[];for(const{processorID:k,processorName:M,type:U,cb:x}of this.statsRegistry)try{const V=x();L.push({processorID:k,processorName:M,type:U,stats:V})}catch(L){Eb.error(new nv(iv.UNEXPECTED_ERROR,L.message))}return L}registerUsage(L,k){this.usageRegistry.find((k=>k.processorID===L.ID&&k.processorName===L.name))||this.usageRegistry.push({processorID:L.ID,processorName:L.name,cb:k})}unregisterUsage(L){const k=this.usageRegistry.findIndex((k=>k.processorID===L.ID&&k.processorName===L.name));-1!==k&&this.usageRegistry.splice(k,1)}async gatherUsage(){const L=[];if(!this.chained)return[];for(const{cb:k}of this.usageRegistry)try{let M=k();M instanceof Mp&&(M=await M),L.push(BL(BL({},M),{},{direction:this.direction}))}catch(L){Eb.error("gather extension usage error",L)}return L}getDirection(){return this.direction}}class Rk extends My{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),VL(this,"context",void 0),VL(this,"processSourceNode",void 0),VL(this,"outputTrack",void 0),VL(this,"processedNode",void 0),VL(this,"clonedTrack",void 0),VL(this,"outputNode",void 0),this.outputNode=new Ck}setVolume(){}createOutputTrack(){throw new nv(iv.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class Ck{disconnect(){}connect(){}}function Ik(L){return new Mp(((k,M)=>{let U=!1;const x=document.createElement("video");x.setAttribute("autoplay",""),x.setAttribute("muted",""),x.muted=!0,x.autoplay=!0,x.setAttribute("playsinline",""),x.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(x);const V=Qv()?"canplay":"playing";x.addEventListener(V,(()=>{const L=x.videoWidth,M=x.videoHeight;!L&&Xv()||(U=!0,x.srcObject=null,x.remove(),k([L,M]))})),x.srcObject=new MediaStream([L]),x.play().catch(TA),setTimeout((()=>{U||(x.srcObject=null,x.remove(),k([x.videoWidth,x.videoHeight]))}),4e3)}))}function vk(L){const k={};L.facingMode&&(k.facingMode=L.facingMode),L.cameraId&&(k.deviceId={exact:L.cameraId});const M=aL(L.encoderConfig);return null!=M.width&&(k.width=M.width),null!=M.height&&(k.height=M.height),!uy()&&M.frameRate&&(k.frameRate=M.frameRate),Jv()&&"object"==typeof k.frameRate&&(k.frameRate.max=60),Xv()&&(k.frameRate={ideal:30,max:30}),k}function yk(L){const k={};if(uy()||(void 0!==L.AGC&&(k.autoGainControl=L.AGC),void 0!==L.AEC&&(k.echoCancellation=L.AEC),void 0!==L.ANS&&(k.noiseSuppression=L.ANS,qv()&&L.ANS&&(k.googHighpassFilter=L.ANS))),L.encoderConfig){const M=uL(L.encoderConfig);k.channelCount=M.stereo?2:1,k.sampleRate=M.sampleRate,k.sampleSize=M.sampleSize}return L.microphoneId&&(k.deviceId={exact:L.microphoneId}),_y()&&(k.sampleRate=void 0),k}const bk=async(L,k,M)=>await(async(L,k,M)=>{const U=function(L){const k=[];for(let M=0;M<L.length;M+=2)k.push(parseInt(L.slice(M,M+2),16));return Uint8Array.from(k)}(yA(""+k+M)).slice(0,16),x=U.slice(0,12),V=await window.crypto.subtle.importKey("raw",U,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:x},V,L))})(L.buffer,k,M),wk=L=>{const k=document.createElement("canvas");return k.width=2,k.height=2,new Mp(((M,U)=>{k.toBlob((async L=>{if(k.remove(),L){const U=await Ok(L);M({buffer:U,width:k.width,height:k.height})}else U(new nv(iv.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))}),L,1)}))},Ok=async L=>{const k=await L.arrayBuffer();return new Uint8Array(k)};var lk,uk,_k,Ek,Ak,Nk,Dk,Pk,Lk,kk,Mk,Uk,xk,Vk,Fk,Bk,jk,Gk,Wk,Hk,Kk,zk,Yk,qk,Xk,Jk,Qk,Zk,$k,eM,tM,iM,nM,rM,oM,sM,aM,cM,dM,lM;let uM=(lk=Rb({argsMap:(L,k)=>[L.getTrackId(),k],throttleTime:300}),uk=Rb({argsMap:(L,k)=>[L.getTrackId(),k]}),_k=fk(),Ek=OA("LocalAudioTrack","_enabledMutex"),Ak=Rb({argsMap:(L,k)=>[L.getTrackId(),k]}),Nk=fk(),Dk=OA("LocalAudioTrack","_enabledMutex"),Pk=Rb({argsMap:(L,k)=>[L.getTrackId(),k]}),Lk=fk(),kk=fk(),Mk=fk(),Uk=Rb({argsMap:L=>[L.getTrackId()]}),xk=fk(),Vk=Rb({argsMap:L=>[L.getTrackId()]}),Fk=fk(),Bk=Rb({argsMap:L=>[L.getTrackId()]}),jk=Rb({argsMap:(L,k)=>[L.getTrackId(),k.name]}),Gk=Rb({argsMap:L=>[L.getTrackId()]}),xL((Wk=class extends GL{get _source(){return this.initWebAudio()}set _source(L){this._trackSource=L}get processorContext(){return this._processorContext||(this._processorContext=this.initProcessor().processorContext),this._processorContext}get processorDestination(){return this._processorDestination||(this._processorDestination=this.initProcessor().processorDestination),this._processorDestination}get isPlaying(){return this._useAudioElement?dk.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(L,k,M,U){super(L,M),VL(this,"trackMediaType",gL.AUDIO),VL(this,"_encoderConfig",void 0),VL(this,"_trackSource",void 0),VL(this,"_enabled",!0),VL(this,"_volume",100),VL(this,"_useAudioElement",!0),VL(this,"_bypassWebAudio",!1),VL(this,"processor",void 0),VL(this,"_processorContext",void 0),VL(this,"_processorDestination",void 0),VL(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=k,this._getOriginVolumeLevel=!!U,this._trackSource=new Rk,zA("DISABLE_WEBAUDIO")&&(this._bypassWebAudio=!0),zA("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1),zv()&&!kL?setTimeout((()=>this.initWebAudio())):this.initWebAudio()}setVolume(L){Iy(L,"volume",0,1e3),this._volume=L,this._source.setVolume(L/100),this._useAudioElement&&dk.setVolume(this.getTrackId(),L);try{if(this._bypassWebAudio)return void Eb.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));const L=this._source.createOutputTrack();this._mediaStreamTrack!==L&&(this._mediaStreamTrack=L,Qy(this,oL.NEED_REPLACE_TRACK,this).then((()=>{Eb.debug("[".concat(this.getTrackId(),"] replace web audio track success"))})).catch((L=>{Eb.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),L)})))}catch(L){}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(L){if(!this._useAudioElement||!QP())throw new nv(iv.NOT_SUPPORTED,"your browser does not support setting the audio output device");await dk.setSinkID(this.getTrackId(),L)}async setEnabled(L,k,M){return this._setEnabled(L,k,M)}async _setEnabled(L,k,M){if(!M){if(L===this._enabled)return;this.stateCheck("enabled",L)}if(Eb.info("[".concat(this.getTrackId(),"] start setEnabled"),L),L){this._originMediaStreamTrack.enabled=!0;try{M||(this._enabled=!0),await Qy(this,oL.NEED_ENABLE_TRACK,this),Eb.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(L," success"))}catch(L){throw M||(this._enabled=!1),Eb.error("[".concat(this.getTrackId(),"] setEnabled to true error"),L.toString()),L}}else{this._originMediaStreamTrack.enabled=!1,M||(this._enabled=!1);try{await Qy(this,oL.NEED_DISABLE_TRACK,this)}catch(L){throw M||(this._enabled=!0),Eb.error("[".concat(this.getTrackId(),"] setEnabled to false error"),L.toString()),L}}}async setMuted(L){L!==this._muted&&(this.stateCheck("muted",L),this._muted=L,this._originMediaStreamTrack.enabled=!L,Eb.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(L)),L?await Qy(this,oL.NEED_MUTE_TRACK,this):await Qy(this,oL.NEED_UNMUTE_TRACK,this))}getStats(){return aA((()=>{Eb.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")}),"localAudioTrackGetStatsWarning"),Zy(this,oL.GET_STATS)||BL({},SL)}setAudioFrameCallback(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4096;if(!L)return this._source.removeAllListeners(TL.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(k),this._source.removeAllListeners(TL.ON_AUDIO_BUFFER),this._source.on(TL.ON_AUDIO_BUFFER,(k=>L(k)))}play(){Eb.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(Eb.debug("[".concat(this.getTrackId(),"] start audio playback in element")),dk.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){Eb.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?dk.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this._processorDestination&&this.unbindProcessorDestinationEvents(this._processorDestination),this._processorContext&&this.unbindProcessorContextEvents(this._processorContext),this.unpipe(),this._processorDestination&&this._processorDestination._source&&this._processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let L=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];Eb.debug("[".concat(this.getTrackId(),"] update player source track")),L&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&dk.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(L,k){this._originMediaStreamTrack!==L&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),k&&this._originMediaStreamTrack.stop()),L.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=L,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this._processorContext&&this.processor.updateInput({track:L,context:this._processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Qy(this,oL.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(L))}renewMediaStreamTrack(L){return Mp.resolve(void 0)}pipe(L){if(this._bypassWebAudio)throw new nv(iv.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===L)return L;if(L._source)throw new nv(iv.INVALID_OPERATION,"Processor ".concat(L.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=L,this.processor._source=this,L.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),L}unpipe(){var L;if(!this.processor)return;const k=this.processor;null===(L=this._source.processSourceNode)||void 0===L||L.disconnect(),this.processor._source=!1,this.processor=void 0,k.reset()}bindProcessorDestinationEvents(L){L.on(CL.ON_TRACK,(async L=>{L?L!==this._mediaStreamTrack&&(this._mediaStreamTrack=L,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(L),await Qy(this,oL.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Qy(this,oL.NEED_REPLACE_TRACK,this))})),L.on(CL.ON_NODE,(L=>{this._source.processedNode=L}))}unbindProcessorDestinationEvents(L){L.removeAllListeners(CL.ON_TRACK),L.removeAllListeners(CL.ON_NODE)}bindProcessorContextEvents(L){L.on(vL.REQUEST_CONSTRAINTS,(async L=>{L(this._originMediaStreamTrack.getSettings())}))}unbindProcessorContextEvents(L){L.removeAllListeners(vL.REQUEST_CONSTRAINTS)}initWebAudio(){return this._trackSource instanceof Rk&&(this._trackSource=new ZL(this._mediaStreamTrack,!1,this._getOriginVolumeLevel?this._mediaStreamTrack:void 0)),this._trackSource}initProcessor(){const L=new gk(this._source.context,this.getTrackId(),"local"),k=new Sk(L);return this._processorContext=L,this._processorDestination=k,this.bindProcessorContextEvents(L),this.bindProcessorDestinationEvents(k),this._source.on(TL.UPDATE_SOURCE,(()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:L})})),this._useAudioElement&&(this._useAudioElement=!1,this.isPlaying&&(dk.stop(this.getTrackId()),this._source.play()),Qy(this,oL.NEED_REPLACE_MIXING_TRACK,this).then((()=>{Eb.debug("[".concat(this.getTrackId(),"] replace from origin track to web audio track success"))})).catch((L=>{Eb.warning("[".concat(this.getTrackId(),"] replace from origin track to web audio track failed"),L)}))),{processorContext:L,processorDestination:k}}}).prototype,"setVolume",[lk],Object.getOwnPropertyDescriptor(Wk.prototype,"setVolume"),Wk.prototype),xL(Wk.prototype,"setPlaybackDevice",[uk,_k],Object.getOwnPropertyDescriptor(Wk.prototype,"setPlaybackDevice"),Wk.prototype),xL(Wk.prototype,"setEnabled",[Ek,Ak,Nk],Object.getOwnPropertyDescriptor(Wk.prototype,"setEnabled"),Wk.prototype),xL(Wk.prototype,"setMuted",[Dk,Pk,Lk],Object.getOwnPropertyDescriptor(Wk.prototype,"setMuted"),Wk.prototype),xL(Wk.prototype,"getStats",[kk],Object.getOwnPropertyDescriptor(Wk.prototype,"getStats"),Wk.prototype),xL(Wk.prototype,"setAudioFrameCallback",[Mk],Object.getOwnPropertyDescriptor(Wk.prototype,"setAudioFrameCallback"),Wk.prototype),xL(Wk.prototype,"play",[Uk,xk],Object.getOwnPropertyDescriptor(Wk.prototype,"play"),Wk.prototype),xL(Wk.prototype,"stop",[Vk,Fk],Object.getOwnPropertyDescriptor(Wk.prototype,"stop"),Wk.prototype),xL(Wk.prototype,"close",[Bk],Object.getOwnPropertyDescriptor(Wk.prototype,"close"),Wk.prototype),xL(Wk.prototype,"pipe",[jk],Object.getOwnPropertyDescriptor(Wk.prototype,"pipe"),Wk.prototype),xL(Wk.prototype,"unpipe",[Gk],Object.getOwnPropertyDescriptor(Wk.prototype,"unpipe"),Wk.prototype),Wk),hM=(Hk=Rb({argsMap:(L,k)=>[L.getTrackId(),k]}),Kk=fk(),zk=OA("MicrophoneAudioTrack","_enabledMutex"),Yk=Rb({argsMap:(L,k,M)=>[L.getTrackId(),k,M]}),qk=fk(),Xk=Rb({argsMap:L=>[L.getTrackId()]}),xL((Jk=class extends uM{get __className__(){return"MicrophoneAudioTrack"}constructor(L,k,M,U){super(L,k.encoderConfig?uL(k.encoderConfig):{},U,zA("GET_VOLUME_OF_MUTED_AUDIO_TRACK")),VL(this,"_config",void 0),VL(this,"_deviceName","default"),VL(this,"_constraints",void 0),VL(this,"_originalConstraints",void 0),VL(this,"_enabled",!0),this._config=k,this._constraints=M,this._originalConstraints=M,this._deviceName=L.label,"boolean"==typeof k.bypassWebAudio&&(this._bypassWebAudio=k.bypassWebAudio),(sy()||ay())&&ML.bindInterruptDetectorTrack(this)}async setDevice(L){if(Eb.info("[".concat(this.getTrackId(),"] start set device to ").concat(L)),this._enabled)try{const k=await zL.getDeviceById(L),M={};M.audio=BL({},this._constraints),M.audio.deviceId={exact:L},this._originMediaStreamTrack.stop();let U=null;try{U=await ok(M,this.getTrackId())}catch(L){throw Eb.error("[".concat(this.getTrackId(),"] setDevice failed"),L.toString()),U=await ok({audio:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(U.getAudioTracks()[0],!1),L}await this._updateOriginMediaStreamTrack(U.getAudioTracks()[0],!1),this._deviceName=k.label,this._config.microphoneId=L,this._constraints.deviceId={exact:L}}catch(L){throw Eb.error("[".concat(this.getTrackId(),"] setDevice error"),L.toString()),L}else try{const k=await zL.getDeviceById(L);this._deviceName=k.label,this._config.microphoneId=L,this._constraints.deviceId={exact:L}}catch(L){throw Eb.error("[".concat(this.getTrackId(),"] setDevice error"),L.toString()),L}Eb.info("[".concat(this.getTrackId(),"] set device to ").concat(L," success"))}async setEnabled(L,k,M){if(k)return Eb.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(L);if(!M){if(L===this._enabled)return;this.stateCheck("enabled",L)}if(Eb.info("[".concat(this.getTrackId(),"] start setEnabled"),L),zA("AUTO_RESET_AUDIO_ROUTE")&&(Qv()||dy())){const k=navigator.audioSession;k&&(L||(k.type="playback"),k.type="auto")}if(!L){var U;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),null===(U=this._source.clonedTrack)||void 0===U||U.stop(),M||(this._enabled=!1);try{await Qy(this,oL.NEED_DISABLE_TRACK,this)}catch(L){throw Eb.error("[".concat(this.getTrackId(),"] setEnabled false failed"),L.toString()),L}return}const x=BL({},this._constraints),V=zL.searchDeviceIdByName(this._deviceName);V&&!x.deviceId&&(x.deviceId=V);try{M||(this._enabled=!0);const L=await ok({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(L.getAudioTracks()[0],!1),await Qy(this,oL.NEED_ENABLE_TRACK,this)}catch(L){throw M||(this._enabled=!1),Eb.error("[".concat(this.getTrackId(),"] setEnabled true failed"),L.toString()),L}Eb.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),(sy()||ay())&&ML.unbindInterruptDetectorTrack(this)}onTrackEnded(){if((Qv()||dy())&&this._enabled&&!this._isClosed&&ML.duringInterruption){const e=async()=>{ML.off(zP.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(Eb.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};ML.on(zP.IOS_INTERRUPTION_END,e)}else Eb.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(fL.TRACK_ENDED)}async renewMediaStreamTrack(L){const k=L||this._constraints,M=zL.searchDeviceIdByName(this._deviceName);if(M&&!k.deviceId&&(k.deviceId=M),this._constraints=k,this._enabled){this._originMediaStreamTrack.stop();const L=await ok({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(L.getAudioTracks()[0],!0)}}bindProcessorContextEvents(L){super.bindProcessorContextEvents(L),L.on(vL.REQUEST_UPDATE_CONSTRAINTS,(async(L,k,M)=>{try{const M=Object.assign({},this._originalConstraints,...L);await this.renewMediaStreamTrack(M),k()}catch(L){M(L)}}))}unbindProcessorContextEvents(L){super.unbindProcessorContextEvents(L),L.removeAllListeners(vL.REQUEST_UPDATE_CONSTRAINTS)}}).prototype,"setDevice",[Hk,Kk],Object.getOwnPropertyDescriptor(Jk.prototype,"setDevice"),Jk.prototype),xL(Jk.prototype,"setEnabled",[zk,Yk,qk],Object.getOwnPropertyDescriptor(Jk.prototype,"setEnabled"),Jk.prototype),xL(Jk.prototype,"close",[Xk],Object.getOwnPropertyDescriptor(Jk.prototype,"close"),Jk.prototype),Jk),pM=(Qk=Rb({argsMap:(L,k)=>[L.getTrackId(),k,L.duration]}),Zk=fk(),$k=Rb({argsMap:L=>[L.getTrackId()]}),eM=fk(),tM=Rb({argsMap:L=>[L.getTrackId()]}),iM=fk(),nM=Rb({argsMap:L=>[L.getTrackId()]}),rM=fk(),oM=Rb({argsMap:L=>[L.getTrackId()]}),sM=fk(),aM=Rb({argsMap:L=>[L.getTrackId()]}),cM=Rb({argsMap:L=>[L.getTrackId()]}),dM=fk(),xL((lM=class extends uM{get __className__(){return"BufferSourceAudioTrack"}constructor(L,k,M,U){super(k.createOutputTrack(),M,U),VL(this,"source",void 0),VL(this,"_bufferSource",void 0),this._useAudioElement=!1,this.source=L,this._bufferSource=k,this._bufferSource.on(TL.AUDIO_SOURCE_STATE_CHANGE,(L=>{this.safeEmit(fL.SOURCE_STATE_CHANGE,L)}));try{this._mediaStreamTrack=this._source.createOutputTrack()}catch(L){}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(L){L&&this._bufferSource.updateOptions(L),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(L){this._bufferSource.seekAudioBuffer(L)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}close(){this.source=null,this._bufferSource.destroy(),super.close()}setAudioBufferPlaybackSpeed(L){Iy(L,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(L)}}).prototype,"startProcessAudioBuffer",[Qk,Zk],Object.getOwnPropertyDescriptor(lM.prototype,"startProcessAudioBuffer"),lM.prototype),xL(lM.prototype,"pauseProcessAudioBuffer",[$k,eM],Object.getOwnPropertyDescriptor(lM.prototype,"pauseProcessAudioBuffer"),lM.prototype),xL(lM.prototype,"seekAudioBuffer",[tM,iM],Object.getOwnPropertyDescriptor(lM.prototype,"seekAudioBuffer"),lM.prototype),xL(lM.prototype,"resumeProcessAudioBuffer",[nM,rM],Object.getOwnPropertyDescriptor(lM.prototype,"resumeProcessAudioBuffer"),lM.prototype),xL(lM.prototype,"stopProcessAudioBuffer",[oM,sM],Object.getOwnPropertyDescriptor(lM.prototype,"stopProcessAudioBuffer"),lM.prototype),xL(lM.prototype,"close",[aM],Object.getOwnPropertyDescriptor(lM.prototype,"close"),lM.prototype),xL(lM.prototype,"setAudioBufferPlaybackSpeed",[cM,dM],Object.getOwnPropertyDescriptor(lM.prototype,"setAudioBufferPlaybackSpeed"),lM.prototype),lM);class SM extends uM{get __className__(){return"MixingAudioTrack"}get isActive(){for(const L of this.trackList)if(L._enabled&&!L._isClosed&&!L.muted)return!0;return!1}constructor(){const L=YL().createMediaStreamDestination();super(L.stream.getAudioTracks()[0],void 0,fA(8,"track-mix-")),VL(this,"trackList",void 0),VL(this,"destNode",void 0),this._useAudioElement=!1;try{this._mediaStreamTrack=this._source.createOutputTrack()}catch(L){}this.destNode=L,this.trackList=[]}hasAudioTrack(L){return-1!==this.trackList.indexOf(L)}addAudioTrack(L){-1===this.trackList.indexOf(L)?(Eb.debug("add ".concat(L.getTrackId()," to mixing track")),L._source.outputNode.connect(this.destNode),this.trackList.push(L),this.updateEncoderConfig()):Eb.debug("track ".concat(L.getTrackId()," is already added"))}removeAudioTrack(L){if(-1!==this.trackList.indexOf(L)){Eb.debug("remove ".concat(L.getTrackId()," from mixing track"));try{L._source.outputNode.disconnect(this.destNode)}catch(L){}tA(this.trackList,L),this.updateEncoderConfig()}}updateEncoderConfig(){const L={};this.trackList.forEach((k=>{k._encoderConfig&&((k._encoderConfig.bitrate||0)>(L.bitrate||0)&&(L.bitrate=k._encoderConfig.bitrate),(k._encoderConfig.sampleRate||0)>(L.sampleRate||0)&&(L.sampleRate=k._encoderConfig.sampleRate),(k._encoderConfig.sampleSize||0)>(L.sampleSize||0)&&(L.sampleSize=k._encoderConfig.sampleSize),k._encoderConfig.stereo&&(L.stereo=!0))})),this._encoderConfig=L}_updateRtpTransceiver(L){this._rtpTransceiver!==L&&(this._rtpTransceiver=L,this.trackList.forEach((k=>{k instanceof SM?k.emit(EL.TRANSCEIVER_UPDATED,L):k._updateRtpTransceiver(L)})))}}class gM extends QL{set currentState(L){L!==this._currentState&&(this._currentState=L,this.safeEmit(TL.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(),VL(this,"audioBuffer",void 0),VL(this,"sourceNode",void 0),VL(this,"startPlayTime",0),VL(this,"startPlayOffset",0),VL(this,"pausePlayTime",0),VL(this,"options",void 0),VL(this,"currentLoopCount",0),VL(this,"currentPlaybackSpeed",100),VL(this,"_currentState","stopped"),this.audioBuffer=L,this.options=k,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}get playbackSpeed(){return this.currentPlaybackSpeed}get currentTime(){return this.audioBuffer?"stopped"===this.currentState?0:"paused"===this.currentState?this.pausePlayTime:((this.context.currentTime-this.startPlayTime)*(this.playbackSpeed/100)+this.startPlayOffset)%this.audioBuffer.duration:0}updateOptions(L){"stopped"===this.currentState?(this.options=L,this.startPlayOffset=this.options.startPlayTime||0):Eb.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&"playing"===this.currentState&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(L){this.sourceNode&&(this.sourceNode.onended=null,"playing"===this.currentState&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),"playing"===this.currentState?(this.startPlayOffset=L,this.startSourceNode()):"paused"===this.currentState&&(this.pausePlayTime=L))}resumeProcessAudioBuffer(){"paused"===this.currentState&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch(L){}this.reset()}}destroy(){this.audioBuffer=null,super.destroy()}setAudioBufferPlaybackSpeed(L){this.sourceNode&&("playing"===this.currentState&&(this.startPlayOffset=this.currentTime,this.startPlayTime=this.context.currentTime),this.sourceNode.playbackRate.value=L/100),this.currentPlaybackSpeed=L}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){const L=this.context.createBufferSource();return L.buffer=this.audioBuffer,L.loop=!!this.options.loop,L.connect(this.outputNode),L.playbackRate.value=this.currentPlaybackSpeed/100,L}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}}const _M=new Map;class CM{get rendFrameRate(){if(this.renderStats&&this.renderStats.curTs!==this.renderStats.lastTs){const L=this.renderStats.curTs-this.renderStats.lastTs,k=(this.renderStats.renderNum-this.renderStats.lastRenderNum)/L;return this.renderStats.lastRenderNum=this.renderStats.renderNum,this.renderStats.lastTs=this.renderStats.curTs,k}return 0}get videoElementStatus(){return this._videoElementStatus}set videoElementStatus(L){L!==this._videoElementStatus&&(Eb.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(L)),this._videoElementStatus=L)}get videoState(){return this._videoState}set videoState(L){var k;L!==this._videoState&&(this._videoState=L,null===(k=this.onVideoStateChanged)||void 0===k||k.call(this,this.videoState))}constructor(L){VL(this,"trackId",void 0),VL(this,"config",void 0),VL(this,"onFirstVideoFrameDecoded",void 0),VL(this,"onVideoStateChanged",void 0),VL(this,"freezeTimeCounterList",[]),VL(this,"renderFreezeAccTime",0),VL(this,"isKeepLastFrame",!1),VL(this,"timeUpdatedCount",0),VL(this,"freezeTime",0),VL(this,"playbackTime",0),VL(this,"lastTimeUpdatedTime",0),VL(this,"autoplayFailed",!1),VL(this,"videoTrack",void 0),VL(this,"videoElement",void 0),VL(this,"cacheVideoElement",void 0),VL(this,"renderStats",void 0),VL(this,"_videoState",NL.VideoStateStopped),VL(this,"videoElementCheckInterval",void 0),VL(this,"videoElementFreezeTimeout",void 0),VL(this,"_videoElementStatus",OL.NONE),VL(this,"isGettingVideoDimensions",!1),VL(this,"startGetVideoDimensions",(()=>{const e=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return Eb.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(e,500)};!this.isGettingVideoDimensions&&e()})),VL(this,"autoResumeAfterInterruption",(()=>{this.videoTrack&&"live"===this.videoTrack.readyState&&"running"===ML.curState&&(Eb.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(Kv())),cy()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))})),VL(this,"handleVideoEvents",(L=>{switch(L.type){case"play":case"playing":this.startGetVideoDimensions(),this.videoElementStatus=OL.PLAYING;break;case"loadeddata":if(this.videoState=NL.VideoStateStarting,this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch(L){}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=OL.CANPLAY;break;case"stalled":this.videoElementStatus=OL.STALLED;break;case"suspend":this.videoElementStatus=OL.SUSPEND;break;case"pause":this.videoElementStatus=OL.PAUSED,Qv()||dy()||zv()&&this.autoplayFailed||!this.videoTrack||"live"!==this.videoTrack.readyState||(Eb.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=OL.WAITING;break;case"abort":this.videoElementStatus=OL.ABORT;break;case"ended":this.videoElementStatus=OL.ENDED;break;case"emptied":this.videoElementStatus=OL.EMPTIED;break;case"error":{const L=this.videoElement.error,k=L?"".concat(L.message," (").concat(L.code,")"):"";L&&(this.videoElementStatus=OL.ERROR),Eb.error("[".concat(this.trackId,"] media error: ").concat(k," "));break}case"timeupdate":{const L=performance.now();if(this.timeUpdatedCount+=1,this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=L);const k=L-this.lastTimeUpdatedTime,M=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=L,mU.lastVisibleTime<mU.lastHiddenTime||M<mU.lastHiddenTime||M<mU.lastVisibleTime)return;for(k>zA("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=k),this.playbackTime+=k;this.playbackTime>=6e3;){this.playbackTime-=6e3;const L=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(L),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}})),VL(this,"autoResumeAfterInterruptionOnIOS15_16",(()=>{this.videoTrack&&"live"===this.videoTrack.readyState&&(Eb.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(Kv())),cy()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))})),this.trackId=L.trackId,this.config=L,L.element instanceof HTMLVideoElement?this.videoElement=L.element:this.videoElement=document.createElement("video"),ML.on(zP.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),ML.on(zP.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var L;return null!==(L=this.videoElement.parentElement)&&void 0!==L?L:void 0}updateConfig(L){this.config=L,this.trackId=L.trackId,L.element!==this.videoElement&&(this.destroy(),this.videoElement=L.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(L){this.videoTrack!==L&&(this.videoTrack=L,this.initVideoElement())}play(L){const k=this.videoElement.play();k&&k.catch&&k.catch((k=>{L&&pk(L,"video",k.message,this.trackId),"NotAllowedError"===k.name?(Eb.warning("detected video element autoplay failed",k),this.autoplayFailed=!0,this.handleAutoPlayFailed()):Eb.warning("[".concat(this.trackId,"] play warning: "),k)}));const M=Gv();if(("Safari"===M.name&&15===Number(M.version)||sy())&&k&&k.then){const e=()=>{this.config.mirror&&(this.videoElement.style.transform="rotateY(180deg)")};k.then(e).catch(e)}}getCurrentFrame(){const L=document.createElement("canvas");L.width=this.videoElement.videoWidth,L.height=this.videoElement.videoHeight;const k=L.getContext("2d");if(!k)return Eb.error("create canvas context failed!"),new ImageData(2,2);k.drawImage(this.videoElement,0,0,L.width,L.height);const M=k.getImageData(0,0,L.width,L.height);return L.remove(),M}async getCurrentFrameToUint8Array(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;const M=document.createElement("canvas");M.width=this.videoElement.videoWidth,M.height=this.videoElement.videoHeight;const U=M.getContext("2d");return U?(U.drawImage(this.videoElement,0,0,M.width,M.height),new Mp(((U,x)=>{M.toBlob((async L=>{if(M.remove(),L){const k=await Ok(L);U({buffer:k,width:M.width,height:M.height})}else x(new nv(iv.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))}),L,k<0?.1:k>1?1:k)}))):await wk(L)}destroy(){this.renderStats=void 0,ML.off(zP.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),ML.off(zP.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[],this.videoState=NL.VideoStateStopped}initVideoElement(){if(this.videoElementStatus=OL.INIT,!this.videoElementCheckInterval&&(EM.forEach((L=>{this.videoElement.addEventListener(L,this.handleVideoEvents)})),this.videoElementCheckInterval=window.setInterval((()=>{(function(L){return L!==document.body&&document.body.contains(L)})(this.videoElement)||(this.videoElementStatus=OL.DESTROYED)}),1e3),zA("ENABLE_VIDEO_FRAME_CALLBACK"))){var L,k;let M;const n=()=>{"visible"===document.visibilityState&&(document.removeEventListener("visibilitychange",n),this.videoElementFreezeTimeout=window.setTimeout(r,zA("VIDEO_FREEZE_DURATION")))},r=()=>{this.videoElementFreezeTimeout=void 0,this.videoState===NL.VideoStateDecoding&&("visible"===document.visibilityState?this.videoState=NL.VideoStateFrozen:document.addEventListener("visibilitychange",n))},o=(L,k)=>{if(this.videoElementStatus===OL.PLAYING){if(this.renderStats?(this.renderStats.renderNum++,this.renderStats.curTs=k.mediaTime):this.renderStats={lastTs:k.mediaTime,curTs:k.mediaTime,lastRenderNum:0,renderNum:0},M){const L=k.presentationTime-M.presentationTime;this.videoState===NL.VideoStateStarting&&(this.videoState=NL.VideoStateDecoding),this.videoState===NL.VideoStateDecoding&&this.onVideoStateChanged&&(this.videoElementFreezeTimeout&&window.clearTimeout(this.videoElementFreezeTimeout),this.videoElementFreezeTimeout=window.setTimeout(r,zA("VIDEO_FREEZE_DURATION"))),L<zA("VIDEO_FREEZE_DURATION")&&this.videoState===NL.VideoStateFrozen&&(this.videoState=NL.VideoStateDecoding),L>zA("VIDEO_FREEZE_DURATION")&&mU.lastVisibleTime>=mU.lastHiddenTime&&M.timestamp>mU.lastVisibleTime&&M.timestamp>mU.lastHiddenTime&&(this.renderFreezeAccTime+=L)}M=BL(BL({},k),{},{timestamp:L})}var U,x;zA("ENABLE_VIDEO_FRAME_CALLBACK")&&(null===(U=(x=this.videoElement).requestVideoFrameCallback)||void 0===U||U.call(x,o))};null===(L=(k=this.videoElement).requestVideoFrameCallback)||void 0===L||L.call(k,o)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),_y()&&!zA("HIDE_NO_POSTER")&&(this.videoElement.poster="noposter");const M=Gv();"Safari"===M.name&&15===Number(M.version)||sy()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,Xv()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,Xv()&&this.videoElement.load());const U=this.videoElement.play();void 0!==U&&U.catch((L=>{Eb.debug("[".concat(this.trackId,"] playback interrupted"),L.toString())}))}resetVideoElement(){EM.forEach((L=>{this.videoElement&&this.videoElement.removeEventListener(L,this.handleVideoEvents)})),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.videoElementStatus=OL.NONE}handleAutoPlayFailed(){const e=L=>{L.preventDefault(),this.videoElement.play().then((()=>{Eb.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))})).catch((L=>{Eb.error(L)})),this.autoplayFailed=!1,Ey()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};Ey()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),hk()}}const EM=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class vM extends CM{constructor(L){super(L),VL(this,"container",void 0),VL(this,"slot",void 0),this.slot=L.element,this.updateConfig(L)}updateConfig(L){this.config=L,this.trackId=L.trackId;const k=L.element;k!==this.slot&&(this.destroy(),this.slot=k),this.createElements()}updateVideoTrack(L){this.videoTrack!==L&&(this.videoTrack=L,this.createElements())}play(L){var k;null!==(k=this.container)&&void 0!==k&&k.contains(this.videoElement)&&super.play(L)}getCurrentFrame(){var L;return null!==(L=this.container)&&void 0!==L&&L.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(L){var k;let M=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return null!==(k=this.container)&&void 0!==k&&k.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(L,M):await wk(L)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{this.container.remove(),this.slot.removeChild(this.container)}catch(L){}this.container=void 0}}createElements(){this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",zA("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),this.slot.appendChild(this.container)}mountedVideoElement(){var L;!this.container||null!==(L=this.container)&&void 0!==L&&L.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var L;if(null!==(L=this.container)&&void 0!==L&&L.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch(L){}this.videoElement=document.createElement("video")}}resetVideoElement(){var L;null!==(L=this.container)&&void 0!==L&&L.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}}var fM,mM,TM,RM,IM,yM,AM,bM,wM,OM,NM,DM,PM,LM,kM,MM,UM,xM,VM,FM,BM,jM,GM,WM,HM,KM,zM,YM,qM,XM,JM,QM,ZM,$M;let eU=(fM=Rb({argsMap:(L,k,M)=>[L.getTrackId(),"string"==typeof k?k:k instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",M]}),mM=fk(),TM=Rb({argsMap:L=>[L.getTrackId()]}),RM=OA("LocalVideoTrack","_enabledMutex"),IM=Rb({argsMap:(L,k)=>[L.getTrackId(),k]}),yM=fk(),AM=OA("LocalVideoTrack","_enabledMutex"),bM=Rb({argsMap:(L,k)=>[L.getTrackId(),k]}),wM=fk(),OM=Rb({argsMap:(L,k)=>[L.getTrackId(),k]}),NM=fk(),DM=fk(),PM=Rb({argsMap:(L,k,M)=>[L.getTrackId(),k,M]}),LM=fk(),kM=fk(),MM=fk(),UM=fk(),xM=fk(),VM=fk(),FM=fk(),BM=Rb({argsMap:(L,k)=>[L.getTrackId(),k.name]}),jM=Rb({argsMap:L=>[L.getTrackId()]}),GM=Rb({argsMap:L=>[L.getTrackId()]}),WM=Rb({argsMap:(L,k,M)=>[L.getTrackId(),k.label,M]}),HM=class e extends GL{get videoHeight(){if(zv()){const{height:L}=this._mediaStreamTrack.getSettings();return this._videoHeight=L,this._videoHeight}return this._videoHeight}get videoWidth(){if(zv()){const{width:L}=this._mediaStreamTrack.getSettings();return this._videoWidth=L,this._videoWidth}return this._videoWidth}get isPlaying(){return!(!this._player||this._player.videoElementStatus!==OL.PLAYING)}get processorDestination(){return this._processorDestination}get processorContext(){return this._processorContext}set processorContext(L){this._processorContext=L}get __className__(){return"LocalVideoTrack"}constructor(L,k,M,U,x,V){if(super(L,x),VL(this,"trackMediaType",gL.VIDEO),VL(this,"_player",void 0),VL(this,"isUseScaleResolutionDownBy",!1),VL(this,"_videoVisibleTimer",null),VL(this,"_previousVideoVisibleStatus",void 0),VL(this,"_clearPreviousVideoVisibleStatus",(()=>this._previousVideoVisibleStatus=void 0)),VL(this,"_encoderConfig",void 0),VL(this,"_scalabilityMode",{numSpatialLayers:1,numTemporalLayers:1}),VL(this,"_optimizationMode",void 0),VL(this,"_videoHeight",void 0),VL(this,"_videoWidth",void 0),VL(this,"_forceBitrateLimit",void 0),VL(this,"_enabled",!0),VL(this,"_processorDestination",void 0),VL(this,"_processorContext",void 0),zv()){const{width:k,height:M}=L.getSettings();this._videoWidth=k,this._videoHeight=M}else this.updateMediaStreamTrackResolution();if(this._encoderConfig=k,this._scalabilityMode=M,this._optimizationMode=U,this._hints=V||[],-1===this._hints.indexOf(sL.SCREEN_TRACK))this.updateBitrateFromProfile();else if(function(L,k,M){const U=Gv();return!(U.name!==L||!U.osVersion)&&115===Number(U.version)}(JC.CHROME)&&-1!==Hv().indexOf("Windows")){const k=function(L,k){if("VideoFrame"in window&&"TransformStream"in window&&XP().supportWebRTCInsertableStream){const k=new MediaStreamTrackProcessor(L),M=new MediaStreamTrackGenerator({kind:"video"});let U,x,V=Date.now();const a=()=>{F&&(clearInterval(F),F=void 0),U&&(U.close(),U=void 0),L.stop(),x=void 0,M.removeEventListener("ended",a)};let F=window.setInterval((()=>{if(x&&U&&Date.now()-V>1e3)try{"live"===M.readyState?x.enqueue(U.clone()):a()}catch(L){a()}}),1e3);const j=new TransformStream({transform:(L,k)=>{"live"===M.readyState?(x=k,V=Date.now(),void 0===U?(U=L,k.enqueue(L.clone())):(k.enqueue(U),U=L)):L.close()}});return M.addEventListener("ended",a),k.readable.pipeThrough(j).pipeTo(M.writable),M}}(L);k&&(Eb.info("local screen video track begin to inject frame"),this._mediaStreamTrack=k)}k&&-1!==this._hints.indexOf(sL.CUSTOM_TRACK)&&this.setEncoderConfiguration(k),this._processorContext=new Tk(this.getTrackId(),"local"),this._processorDestination=new mk(this.processorContext),this.bindProcessorDestinationEvents()}play(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"==typeof L){const k=document.getElementById(L);k?L=k:(Eb.warning("[".concat(this.getTrackId(),'] can not find "#').concat(L,'" element, use document.body')),L=document.body)}Eb.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(L instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(k));const M=BL(BL(BL({},this._getDefaultPlayerConfig()),k),{},{trackId:this.getTrackId(),element:L});this._player?this._player.updateConfig(M):(L instanceof HTMLVideoElement?this._player=new CM(M):this._player=new vM(M),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval((()=>{try{const L=this.getVideoElementVisibleStatus();this.safeEmit(fL.VIDEO_ELEMENT_VISIBLE_STATUS,L)}catch(L){}}),zA("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,Eb.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(L,k){if(!k){if(L===this._enabled)return;this.stateCheck("enabled",L)}if(Eb.info("[".concat(this.getTrackId(),"] start setEnabled"),L),!L){this._originMediaStreamTrack.enabled=!1;try{await Qy(this,oL.NEED_DISABLE_TRACK,this)}catch(L){throw Eb.error("[".concat(this.getTrackId(),"] setEnabled to false error"),L.toString()),L}return k||(this._enabled=!1),void Eb.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await Qy(this,oL.NEED_ENABLE_TRACK,this)}catch(L){throw Eb.error("[".concat(this.getTrackId(),"] setEnabled to true error"),L.toString()),L}Eb.info("[".concat(this.getTrackId(),"] setEnabled to true success")),k||(this._enabled=!0)}async setMuted(L){L!==this._muted&&(this.stateCheck("muted",L),this._muted=L,this._originMediaStreamTrack.enabled=!L,Eb.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(L)),L?await Qy(this,oL.NEED_MUTE_TRACK,this):await Qy(this,oL.NEED_UNMUTE_TRACK,this))}async setEncoderConfiguration(L,k){if(!this._enabled)throw new nv(iv.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if(L=aL(L),this._forceBitrateLimit&&(L.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:L.bitrateMax,L.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:L.bitrateMin),L.width||L.height||L.frameRate){const k=vk({encoderConfig:L});(zv()||Qv()||dy())&&(k.deviceId=void 0),Eb.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(L),JSON.stringify(k));try{await this._originMediaStreamTrack.applyConstraints(k),this.updateMediaStreamTrackResolution()}catch(L){const k=new nv(iv.UNEXPECTED_ERROR,L.toString());throw Eb.error("[".concat(this.getTrackId(),"] applyConstraints error"),k.toString()),k}}this._encoderConfig=L,-1===this._hints.indexOf(sL.SCREEN_TRACK)&&this.updateBitrateFromProfile();try{await Qy(this,oL.NEED_UPDATE_VIDEO_ENCODER,this)}catch(L){return L.throw(Eb)}}getStats(){return aA((()=>{Eb.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")}),"localVideoTrackGetStatsWarning"),Zy(this,oL.GET_STATS)||BL({},RL)}async setBeautyEffect(L){Eb.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(L,k):await wk(L)}async setBitrateLimit(L){if(Eb.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(L))),L){this._forceBitrateLimit=L,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<L.max_bitrate?this._encoderConfig.bitrateMax:L.max_bitrate:this._encoderConfig.bitrateMax=L.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=L.min_bitrate);try{await Qy(this,oL.NEED_UPDATE_VIDEO_ENCODER,this)}catch(L){return L.throw(Eb)}}}async setOptimizationMode(L){if("motion"!==L&&"detail"!==L&&"balanced"!==L)return void Eb.error(iv.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");const k=this._optimizationMode;try{this._optimizationMode=L,await Qy(this,oL.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this)}catch(L){throw this._optimizationMode=k,Eb.error("[".concat(this.getTrackId(),"] set optimization mode failed"),L.toString()),L}Eb.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(L,")"))}setScalabiltyMode(L){if(1===L.numSpatialLayers&&1!==L.numTemporalLayers)return Eb.error(iv.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=L,Eb.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(L,")"))}updateMediaStreamTrackResolution(){Ik(this._originMediaStreamTrack).then((L=>{let[k,M]=L;this._videoHeight=M,this._videoWidth=k})).catch(TA)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}async setSenderConfiguration(L){if(!this._enabled)throw new nv(iv.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");Eb.debug("[".concat(this.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(L)),L=aL(L),this._forceBitrateLimit&&(L.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:L.bitrateMax,L.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:L.bitrateMin),this._encoderConfig=L,-1===this._hints.indexOf(sL.SCREEN_TRACK)&&this.updateBitrateFromProfile();try{await Qy(this,oL.NEED_UPDATE_VIDEO_ENCODER,this)}catch(L){return L.throw(Eb)}}updateBitrateFromProfile(){if(!this._encoderConfig)return;const{width:L,height:k,frameRate:M}=this.getMediaStreamTrackSettings();if(!L||!k||!M)return;const{bitrateMax:U,bitrateMin:x}=this._encoderConfig;if(null==x||null==U){const{max:V,min:F}=function(L,k,M,U,x){const V=zA("BITRATE_ADAPTER_TYPE");if("DEFAULT_BITRATE"===V)return{min:U,max:x};if(void 0===x){var F;const j=Math.floor(200*Math.pow(M/15,.6)*Math.pow(L*k/640/360,.75));x="STANDARD_BITRATE"===V?4*j:2*j,U=null!==(F=U)&&void 0!==F?F:j}else{var j;U=null!==(j=U)&&void 0!==j?j:Math.floor(x/10)}return{min:U,max:x}}(L,k,M,x,U);this._encoderConfig.bitrateMin=F,this._encoderConfig.bitrateMax=V,Eb.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(L,", h: ").concat(k,", fps: ").concat(M,"] => [brMax: ").concat(V,", brMin: ").concat(F,"]"))}}getVideoElementVisibleStatus(){try{var L,k;const M=null==this||null===(L=this._player)||void 0===L?void 0:L.getContainerElement(),U={track:this,element:null==this||null===(k=this._player)||void 0===k?void 0:k.getVideoElement(),slot:null==M?void 0:M.parentElement},{element:x,slot:V}=U;if(this.isPlaying&&x instanceof HTMLVideoElement&&V instanceof HTMLElement){const L=av.checkOneElementVisible(x),k=Object.assign({},L);if(k.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=k.visible;const L=Ab.reportApiInvoke(null,{tag:lv.TRACER,name:dv.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});k.visible?L.onSuccess("Video is visible"):L.onSuccess("Invisible because of ".concat(k.reason))}return k}return}catch(L){throw new nv(iv.GET_VIDEO_ELEMENT_VISIBLE_ERROR,L.message)}}async renewMediaStreamTrack(L){}pipe(L){if(this.processor===L)return L;if(L._source)throw new nv(iv.INVALID_OPERATION,"Processor ".concat(L.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=L,this.processor._source=this,L.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),L}unpipe(){if(!this.processor)return;const L=this.processor;this.processor._source=void 0,this.processor=void 0,L.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}clone(L){let k=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],M=this._encoderConfig;L&&(M=BL(BL({},M),aL(L))),M=oA(M);const U=fA(8,"track-video-cloned-"),x=new e(k?this._mediaStreamTrack.clone():this._mediaStreamTrack,M,oA(this._scalabilityMode),this._optimizationMode,U,oA(this._hints));return L&&M&&x.setEncoderConfiguration(M),Eb.debug("clone video track from ".concat(this.getTrackId()," to ").concat(U,", clone ").concat(k)),x}async replaceTrack(L,k){if(!(L instanceof MediaStreamTrack))throw new nv(iv.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if("video"!==L.kind)throw new nv(iv.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(L,k,!0),this.updateMediaStreamTrackResolution()}sendSeiData(L){if(aA((()=>{Ab.reportApiInvoke(null,{name:dv.LOCAL_VIDEO_SEND_SEI_DATA,options:[],tag:lv.TRACER}).onSuccess("")}),this._mediaStreamTrack.id||this.getTrackId()),!zA("ENABLE_VIDEO_SEI")||!zA("ENABLE_ENCODED_TRANSFORM"))return void Eb.warning('To send/receive SEI, please call AgoraRTC.setParameter("ENABLE_VIDEO_SEI", true) before instantiate IAgoraRtcClient');if(L instanceof Uint8Array==0)return new nv(iv.INVALID_PARAMS,"Invalid argument type, ILocalVideoTrack.sendSeiData() only accept Uint8Array argument.").throw();const k=this.getRTCRtpTransceiver();if(!k)return void Eb.warning("Video track is not published, SEI can not be send");const M=k.sender.getParameters();if(0===M.codecs.length)return;const U=M.codecs[0].mimeType.toLocaleLowerCase();"video/h264"===U?this.safeEmit("sei-to-send",L):Eb.warning("SEI is not supported by ".concat(U))}bindProcessorDestinationEvents(){this.processorDestination.on(CL.ON_TRACK,(async L=>{L?L!==this._mediaStreamTrack&&(this._mediaStreamTrack=L,this._updatePlayerSource(),await Qy(this,oL.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Qy(this,oL.NEED_REPLACE_TRACK,this))}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(CL.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(vL.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(vL.REQUEST_CONSTRAINTS)}},xL(HM.prototype,"play",[fM,mM],Object.getOwnPropertyDescriptor(HM.prototype,"play"),HM.prototype),xL(HM.prototype,"stop",[TM],Object.getOwnPropertyDescriptor(HM.prototype,"stop"),HM.prototype),xL(HM.prototype,"setEnabled",[RM,IM,yM],Object.getOwnPropertyDescriptor(HM.prototype,"setEnabled"),HM.prototype),xL(HM.prototype,"setMuted",[AM,bM,wM],Object.getOwnPropertyDescriptor(HM.prototype,"setMuted"),HM.prototype),xL(HM.prototype,"setEncoderConfiguration",[OM,NM],Object.getOwnPropertyDescriptor(HM.prototype,"setEncoderConfiguration"),HM.prototype),xL(HM.prototype,"getStats",[DM],Object.getOwnPropertyDescriptor(HM.prototype,"getStats"),HM.prototype),xL(HM.prototype,"setBeautyEffect",[PM,LM],Object.getOwnPropertyDescriptor(HM.prototype,"setBeautyEffect"),HM.prototype),xL(HM.prototype,"getCurrentFrameData",[kM],Object.getOwnPropertyDescriptor(HM.prototype,"getCurrentFrameData"),HM.prototype),xL(HM.prototype,"getCurrentFrameImage",[MM],Object.getOwnPropertyDescriptor(HM.prototype,"getCurrentFrameImage"),HM.prototype),xL(HM.prototype,"setBitrateLimit",[UM],Object.getOwnPropertyDescriptor(HM.prototype,"setBitrateLimit"),HM.prototype),xL(HM.prototype,"setOptimizationMode",[xM],Object.getOwnPropertyDescriptor(HM.prototype,"setOptimizationMode"),HM.prototype),xL(HM.prototype,"setScalabiltyMode",[VM],Object.getOwnPropertyDescriptor(HM.prototype,"setScalabiltyMode"),HM.prototype),xL(HM.prototype,"updateMediaStreamTrackResolution",[FM],Object.getOwnPropertyDescriptor(HM.prototype,"updateMediaStreamTrackResolution"),HM.prototype),xL(HM.prototype,"pipe",[BM],Object.getOwnPropertyDescriptor(HM.prototype,"pipe"),HM.prototype),xL(HM.prototype,"unpipe",[jM],Object.getOwnPropertyDescriptor(HM.prototype,"unpipe"),HM.prototype),xL(HM.prototype,"close",[GM],Object.getOwnPropertyDescriptor(HM.prototype,"close"),HM.prototype),xL(HM.prototype,"replaceTrack",[WM],Object.getOwnPropertyDescriptor(HM.prototype,"replaceTrack"),HM.prototype),HM),tU=(KM=Rb({argsMap:(L,k)=>[L.getTrackId(),k]}),zM=fk(),YM=OA("CameraVideoTrack","_enabledMutex"),qM=Rb({argsMap:(L,k)=>[L.getTrackId(),k]}),XM=fk(),JM=Rb({argsMap:(L,k)=>[L.getTrackId(),k]}),QM=fk(),ZM=Rb({argsMap:L=>[L.getTrackId()]}),$M=class e extends eU{get __className__(){return"CameraVideoTrack"}constructor(L,k,M,U,x,V){super(L,aL(k.encoderConfig),U,x,V),VL(this,"_config",void 0),VL(this,"_originalConstraints",void 0),VL(this,"_constraints",void 0),VL(this,"_enabled",!0),VL(this,"_deviceName","default"),VL(this,"tryResumeVideoForIOS15_16WeChat",(async()=>{(sy()||ay())&&!function(){const L=Gv();if(L.os!==XC.IOS||!L.osVersion)return!1;const k=L.osVersion.split(".");return 15===Number(k[0])&&Number(k[1])>=2}()&&ly()&&this._enabled&&!this._isClosed&&(Eb.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())})),this._config=k,this._originalConstraints=M,this._constraints=M,this._deviceName=L.label,this._encoderConfig=aL(this._config.encoderConfig),ML.on(zP.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),ML.on(zP.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}async setDevice(L){return"string"==typeof L?this._setDeviceById(L):L.deviceId?this._setDeviceById(L.deviceId):L.facingMode?this._setDeviceByFacingModel(L.facingMode):void 0}async _setDeviceById(L){if(Eb.info("[".concat(this.getTrackId(),"] set device to ").concat(L)),this._enabled)try{const k=await zL.getDeviceById(L),M={};M.video=BL({},this._constraints),M.video.deviceId={exact:L},M.video.facingMode=void 0,this._originMediaStreamTrack.stop();let U=null;try{U=await ok(M,this.getTrackId())}catch(L){throw Eb.error("[".concat(this.getTrackId(),"] setDevice failed"),L.toString()),U=await ok({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(U.getVideoTracks()[0],!1),L}await this._updateOriginMediaStreamTrack(U.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=k.label,this._config.cameraId=L,this._constraints.deviceId={exact:L}}catch(L){throw Eb.error("[".concat(this.getTrackId(),"] setDevice error"),L.toString()),L}else try{const k=await zL.getDeviceById(L);this._deviceName=k.label,this._config.cameraId=L,this._constraints.deviceId={exact:L}}catch(L){throw Eb.error("[".concat(this.getTrackId(),"] setDevice error"),L.toString()),L}Eb.info("[".concat(this.getTrackId(),"] setDevice success"))}async _setDeviceByFacingModel(L){Eb.info("[".concat(this.getTrackId(),"] set facingMode ").concat(L));const k={video:BL(BL({},this._constraints),{},{deviceId:void 0,facingMode:{exact:L}})};if(this._enabled){this._originMediaStreamTrack.stop();let L=null;try{L=await ok(k,this.getTrackId())}catch(k){throw Eb.error("[".concat(this.getTrackId(),"] setDeviceByFacingModel failed"),k.toString()),L=await ok({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(L.getVideoTracks()[0],!1),k}await this._updateOriginMediaStreamTrack(L.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution()}this._deviceName="",this._config.facingMode=L,this._config.cameraId=void 0,this._constraints=BL({},k.video),Eb.info("[".concat(this.getTrackId(),"] setDeviceByFacingModel success"))}async setEnabled(L,k){if(!k){if(L===this._enabled)return;this.stateCheck("enabled",L)}if(Eb.info("[".concat(this.getTrackId(),"] start setEnabled"),L),L){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{const L=await ok({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(L.getVideoTracks()[0],!1)}await Qy(this,oL.NEED_ENABLE_TRACK,this)}catch(L){throw Eb.error("[".concat(this.getTrackId(),"] setEnabled true error"),L.toString()),L}this.updateMediaStreamTrackResolution(),Eb.info("[".concat(this.getTrackId(),"] setEnabled to true success")),k||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),k||(this._enabled=!1);try{await Qy(this,oL.NEED_DISABLE_TRACK,this)}catch(L){throw Eb.error("[".concat(this.getTrackId(),"] setEnabled to false error"),L.toString()),L}Eb.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(L,k){if(!this._enabled)throw new nv(iv.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");L=aL(L),this._forceBitrateLimit&&(L.bitrateMax=this._forceBitrateLimit.max_bitrate||L.bitrateMax,L.bitrateMin=this._forceBitrateLimit.min_bitrate||L.bitrateMin);const M=rA(this._config);M.encoderConfig=L;const U=vk(M);(zv()||Qv()||dy())&&(U.deviceId=void 0),Eb.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(L),JSON.stringify(U));try{await this._originMediaStreamTrack.applyConstraints(U),this.updateMediaStreamTrackResolution()}catch(L){const k=new nv(iv.UNEXPECTED_ERROR,L.toString());throw Eb.error("[".concat(this.getTrackId(),"] applyConstraints error"),k.toString()),k}this._config=M,this._constraints=U,this._originalConstraints=U,this._encoderConfig=L,-1===this._hints.indexOf(sL.SCREEN_TRACK)&&this.updateBitrateFromProfile();try{await Qy(this,oL.NEED_UPDATE_VIDEO_ENCODER,this)}catch(L){return L.throw(Eb)}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((Qv()||dy())&&this._enabled&&!this._isClosed&&ML.duringInterruption){const e=async()=>{ML.off(zP.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(Eb.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};ML.on(zP.IOS_INTERRUPTION_END,e)}else Eb.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(fL.TRACK_ENDED)}async renewMediaStreamTrack(L){const k=L||this._constraints,M=zL.searchDeviceIdByName(this._deviceName);if(M&&!k.deviceId&&(k.deviceId={exact:M}),this._enabled){const L=await ok({video:k},this.getTrackId());this._constraints=k,await this._updateOriginMediaStreamTrack(L.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),ML.off(zP.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),ML.off(zP.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}clone(L){let k=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],M=this._encoderConfig;L&&(M=BL(BL({},M),aL(L))),M=oA(M);const U=fA(8,"track-cam-cloned-"),x=new e(k?this._mediaStreamTrack.clone():this._mediaStreamTrack,oA(BL(BL({},this._config),{},{encoderConfig:M})),oA(this._constraints),oA(this._scalabilityMode),this._optimizationMode,U);return L&&M&&x.setEncoderConfiguration(M),Eb.debug("clone track from ".concat(this.getTrackId()," to ").concat(U,", clone ").concat(k)),x}bindProcessorContextEvents(){this.processorContext.on(vL.REQUEST_UPDATE_CONSTRAINTS,(async(L,k,M)=>{try{const M=Object.assign({},this._originalConstraints,...L);await this.renewMediaStreamTrack(M),k()}catch(L){M(L)}})),this.processorContext.on(vL.REQUEST_CONSTRAINTS,(async L=>{L(this._originMediaStreamTrack.getSettings())}))}},xL($M.prototype,"setDevice",[KM,zM],Object.getOwnPropertyDescriptor($M.prototype,"setDevice"),$M.prototype),xL($M.prototype,"setEnabled",[YM,qM,XM],Object.getOwnPropertyDescriptor($M.prototype,"setEnabled"),$M.prototype),xL($M.prototype,"setEncoderConfiguration",[JM,QM],Object.getOwnPropertyDescriptor($M.prototype,"setEncoderConfiguration"),$M.prototype),xL($M.prototype,"close",[ZM],Object.getOwnPropertyDescriptor($M.prototype,"close"),$M.prototype),$M);function aU(L,k,M,U){M.optimizationMode&&(U&&U.width&&U.height?(M.encoderConfig=BL(BL({},U),{},{bitrateMin:U.bitrateMin,bitrateMax:U.bitrateMax}),"motion"!==M.optimizationMode&&"detail"!==M.optimizationMode||(k.contentHint=M.optimizationMode,k.contentHint===M.optimizationMode?Eb.debug("[".concat(L,"] set content hint to"),M.optimizationMode):Eb.debug("[".concat(L,"] set content hint failed")))):Eb.warning("[".concat(L,"] can not apply optimization mode bitrate config, no encoderConfig")))}var iU,nU,rU,oU,sU,cU,dU,lU,uU,hU,pU,_U;class gU extends jL{getUserId(){return this._userId}constructor(L,k,M,U){super(L,"track-".concat(L.kind,"-").concat(k,"-").concat(U.clientId,"_").concat(fA(5,""))),VL(this,"_userId",void 0),VL(this,"_uintId",void 0),VL(this,"_isDestroyed",!1),VL(this,"store",void 0),VL(this,"processor",void 0),VL(this,"processorContext",void 0),this._userId=k,this._uintId=M,this.store=U}_updateOriginMediaStreamTrack(L){this._originMediaStreamTrack=L,this._mediaStreamTrack=L,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,Eb.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}let EU=(iU=Rb({argsMap:(L,k,M)=>[L.getTrackId(),"string"==typeof k?k:k instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",M]}),nU=Rb({argsMap:L=>[L.getTrackId()]}),rU=Rb({argsMap:(L,k)=>[L.getTrackId(),k.name]}),oU=Rb({argsMap:L=>[L.getTrackId()]}),xL((sU=class extends gU{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==OL.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(L,k,M,U){super(L,k,M,U),VL(this,"_videoVisibleTimer",null),VL(this,"_previousVideoVisibleStatus",void 0),VL(this,"_clearPreviousVideoVisibleStatus",(()=>this._previousVideoVisibleStatus=void 0)),VL(this,"trackMediaType",gL.VIDEO),VL(this,"_videoWidth",void 0),VL(this,"_videoHeight",void 0),VL(this,"_player",void 0),VL(this,"processorDestination",void 0),VL(this,"processorContext",void 0),this.updateMediaStreamTrackResolution(),this.processorContext=new Tk(this.getTrackId(),"remote"),this.processorDestination=new mk(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return aA((()=>{Eb.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")}),"remoteVideoTrackGetStatsWarning"),Zy(this,oL.GET_STATS)||BL({},AL)}play(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"==typeof L){const k=document.getElementById(L);k?L=k:(Eb.warning("[".concat(this.getTrackId(),'] can not find "#').concat(L,'" element, use document.body')),L=document.body)}Eb.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(L instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(k));const M=BL(BL({fit:"cover"},k),{},{trackId:this.getTrackId(),element:L});this._player?this._player.updateConfig(M):(L instanceof HTMLVideoElement?this._player=new CM(M):this._player=new vM(M),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(mL.FIRST_FRAME_DECODED)},this._player.onVideoStateChanged=L=>{this.safeEmit(mL.VIDEO_STATE_CHANGED,L)}),this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval((()=>{try{const L=this.getVideoElementVisibleStatus();this.safeEmit(mL.VIDEO_ELEMENT_VISIBLE_STATUS,L)}catch(L){}}),zA("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,Eb.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){Ik(this._originMediaStreamTrack).then((L=>{let[k,M]=L;this._videoHeight=M,this._videoWidth=k})).catch(TA)}_updatePlayerSource(){Eb.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var L,k;const M=null==this||null===(L=this._player)||void 0===L?void 0:L.getContainerElement(),U={track:this,element:null==this||null===(k=this._player)||void 0===k?void 0:k.getVideoElement(),slot:null==M?void 0:M.parentElement},{element:x,slot:V}=U;if(this.isPlaying&&x instanceof HTMLVideoElement&&V instanceof HTMLElement){const L=av.checkOneElementVisible(x),k=Object.assign({},L);if(k.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=k.visible;const L=Ab.reportApiInvoke(null,{tag:lv.TRACER,name:dv.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});k.visible?L.onSuccess("Video is visible"):L.onSuccess("Invisible because of ".concat(k.reason))}return k}return}catch(L){throw new nv(iv.GET_VIDEO_ELEMENT_VISIBLE_ERROR,L.message)}}pipe(L){if(this.processor===L)return L;if(L._source)throw new nv(iv.INVALID_OPERATION,"Processor ".concat(L.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=L,this.processor._source=this,L.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),L}unpipe(){if(!this.processor)return;const L=this.processor;this.processor._source=void 0,this.processor=void 0,L.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(CL.ON_TRACK,(async L=>{L?L!==this._mediaStreamTrack&&(this._mediaStreamTrack=L,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(CL.ON_TRACK)}_destroy(){super._destroy(),this.unbindProcessorDestinationEvents()}_onSei(L){this.emit(EL.SEI_RECEIVED,L)}}).prototype,"play",[iU],Object.getOwnPropertyDescriptor(sU.prototype,"play"),sU.prototype),xL(sU.prototype,"stop",[nU],Object.getOwnPropertyDescriptor(sU.prototype,"stop"),sU.prototype),xL(sU.prototype,"pipe",[rU],Object.getOwnPropertyDescriptor(sU.prototype,"pipe"),sU.prototype),xL(sU.prototype,"unpipe",[oU],Object.getOwnPropertyDescriptor(sU.prototype,"unpipe"),sU.prototype),sU),fU=(cU=Rb({argsMap:(L,k)=>[L.getTrackId(),k],throttleTime:300}),dU=Rb({argsMap:(L,k)=>[L.getTrackId(),k]}),lU=Rb({argsMap:L=>[L.getTrackId()]}),uU=Rb({argsMap:L=>[L.getTrackId()]}),hU=Rb({argsMap:(L,k)=>[L.getTrackId(),k.name]}),pU=Rb({argsMap:L=>[L.getTrackId()]}),xL((_U=class extends gU{get isPlaying(){return this._useAudioElement?dk.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(L,k,M,U){super(L,k,M,U),VL(this,"trackMediaType",gL.AUDIO),VL(this,"_source",void 0),VL(this,"_useAudioElement",!0),VL(this,"_volume",100),VL(this,"processorContext",void 0),VL(this,"processorDestination",void 0),VL(this,"_played",!1),VL(this,"_bypassWebAudio",!1),zA("DISABLE_WEBAUDIO")?(this._source=new Rk,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new ZL(L,!0),zA("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(TL.RECEIVE_TRACK_BUFFER,(()=>{this.safeEmit(mL.FIRST_FRAME_DECODED)})),this.processorContext=new gk(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new Sk(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(TL.UPDATE_SOURCE,(()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})}))}setAudioFrameCallback(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4096;if(!L)return this._source.removeAllListeners(TL.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(k),this._source.removeAllListeners(TL.ON_AUDIO_BUFFER),this._source.on(TL.ON_AUDIO_BUFFER,(k=>L(k)))}setVolume(L){this._volume=L,this._useAudioElement?dk.setVolume(this.getTrackId(),L):this._source.setVolume(L/100)}async setPlaybackDevice(L){if(!this._useAudioElement||!QP())throw new nv(iv.NOT_SUPPORTED,"your browser does not support setting the audio output device");await dk.setSinkID(this.getTrackId(),L)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getStats(){return aA((()=>{Eb.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")}),"remoteAudioTrackGetStatsWarning"),Zy(this,oL.GET_STATS)||BL({},IL)}play(){Eb.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(Eb.debug("[".concat(this.getTrackId(),"] use audio element to play")),dk.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):this._source.play()}stop(){Eb.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?dk.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let L=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];Eb.debug("[".concat(this.getTrackId(),"] update player source track")),L&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&dk.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(L){if(this._bypassWebAudio)throw new nv(iv.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===L)return L;if(L._source)throw new nv(iv.INVALID_OPERATION,"Processor ".concat(L.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=L,this.processor._source=this,L.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),L}unpipe(){var L;if(this._bypassWebAudio)throw new nv(iv.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;const k=this.processor;null===(L=this._source.processSourceNode)||void 0===L||L.disconnect(),this.processor._source=!1,this.processor=void 0,k.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(CL.ON_TRACK,(async L=>{L?L!==this._mediaStreamTrack&&(this._mediaStreamTrack=L,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(L)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})),this.processorDestination.on(CL.ON_NODE,(L=>{this._source.processedNode=L;const k=!L;this._useAudioElement!==k&&(this._played?(this.stop(),this._useAudioElement=k,this.play()):this._useAudioElement=k)}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(CL.ON_TRACK),this.processorDestination.removeAllListeners(CL.ON_NODE)}}).prototype,"setVolume",[cU],Object.getOwnPropertyDescriptor(_U.prototype,"setVolume"),_U.prototype),xL(_U.prototype,"setPlaybackDevice",[dU],Object.getOwnPropertyDescriptor(_U.prototype,"setPlaybackDevice"),_U.prototype),xL(_U.prototype,"play",[lU],Object.getOwnPropertyDescriptor(_U.prototype,"play"),_U.prototype),xL(_U.prototype,"stop",[uU],Object.getOwnPropertyDescriptor(_U.prototype,"stop"),_U.prototype),xL(_U.prototype,"pipe",[hU],Object.getOwnPropertyDescriptor(_U.prototype,"pipe"),_U.prototype),xL(_U.prototype,"unpipe",[pU],Object.getOwnPropertyDescriptor(_U.prototype,"unpipe"),_U.prototype),_U);const mU=new class extends My{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),VL(this,"_lastHiddenTime",0),VL(this,"_lastVisibleTime",0),document.addEventListener("visibilitychange",(()=>{"hidden"===document.visibilityState?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),Eb.debug("document visibility went ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)}))}};class vU extends My{constructor(L,k){super(),VL(this,"trackMediaType",gL.DATA),VL(this,"_version",1),VL(this,"_type",3),VL(this,"_config",void 0),VL(this,"_originDataChannel",void 0),VL(this,"_dataStreamPacketHeader",new ArrayBuffer(4)),VL(this,"_dataStreamPacketHandler",{serialize:L=>L,deserialize:L=>L}),VL(this,"_datachannelEventMap",new Map),this._config=L,k&&(this._originDataChannel=k,this._bandDataChannelEvents(k)),this._initPacketHeader()}useDataStream(L){this._dataStreamPacketHandler=L}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return zA("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var L,k;return null!==(L=null===(k=this._originDataChannel)||void 0===k?void 0:k.readyState)&&void 0!==L?L:"connecting"}get _originDataChannelId(){var L,k;return null!==(L=null===(k=this._originDataChannel)||void 0===k?void 0:k.id)&&void 0!==L?L:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0)}async _waitTillOpen(){return new Mp(((L,k)=>{if(this._originDataChannel){"open"===this._originDataChannel.readyState&&L();const M=setTimeout((()=>{var L;k(new nv(iv.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat(null===(L=this._originDataChannel)||void 0===L?void 0:L.id)))}),1e4);this._originDataChannel.onopen=()=>{clearTimeout(M),this._originDataChannel&&this._bandDataChannelEvents(this._originDataChannel),L()},this._originDataChannel.onerror=()=>{throw clearTimeout(M),new nv(iv.DATACHANNEL_CONNECTION_TIMEOUT)}}else k(new nv(iv.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"))}))}_updateOriginDataChannel(L){this._originDataChannel=L,this._bandDataChannelEvents(L)}_initPacketHeader(){const L=new DataView(this._dataStreamPacketHeader);L.setUint16(0,this._version),L.setUint8(2,this._type),L.setUint8(3,this._config.id)}_bandDataChannelEvents(L){this._unbindDataChannelEvents(L),[PL.OPEN,PL.CLOSE,PL.ERROR].forEach((k=>{const i=()=>{this.emit(k)};this._datachannelEventMap.set(k,i),L.addEventListener(k,i)}))}_unbindDataChannelEvents(L){Array.from(this._datachannelEventMap.entries()).forEach((k=>{let[M,U]=k;L.removeEventListener(M,U)})),this._datachannelEventMap.clear()}}class yU extends vU{constructor(L){super(L),VL(this,"_messageListener",void 0),this._messageListener=L=>{if(L.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);const k=L.data.slice(0,this._dataStreamPacketHeader.byteLength),M=new DataView(k).getUint8(3);if(M!==this.id)return void(zA("SHOW_DATASTREAM2_LOG")&&Eb.debug("invalid datachannel id: ".concat(M," !== ").concat(this.id)));let U=L.data.slice(this._dataStreamPacketHeader.byteLength);U=this._dataStreamPacketHandler.deserialize(U),this.emit(PL.MESSAGE,U)}}_updateOriginDataChannel(L){super._updateOriginDataChannel(L),this._bandRemoteDataChannelEvents()}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close())}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener)}}class AU extends vU{send(L){if(this._originDataChannel){let k=L;k=this._dataStreamPacketHandler.serialize(L);const M=new Uint8Array(this._dataStreamPacketHeader.byteLength+k.byteLength);M.set(new Uint8Array(this._dataStreamPacketHeader),0),M.set(new Uint8Array(k),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(M.buffer)}}}function bU(){const L=new Blob([atob("ZnVuY3Rpb24gZShlLHQsbil7bGV0IHI9bmV3IFVpbnQ4QXJyYXkoZSx0LG4pLGE9W10sbz0wO2Zvcig7YS5sZW5ndGg8bjspbyszPG4mJjA9PT1yW29dJiYwPT09cltvKzFdJiYzPT09cltvKzJdJiYoMD09PXJbbyszXXx8MT09PXJbbyszXXx8Mj09PXJbbyszXXx8Mz09PXJbbyszXSk/KGEucHVzaChyW29dLHJbbysxXSxyW28rM10pLG8rPTQpOihhLnB1c2gocltvXSksbysrKTtyZXR1cm4gbmV3IFVpbnQ4QXJyYXkoYSl9ZnVuY3Rpb24gdChlLHQpe2NvbnN0IG49ZnVuY3Rpb24oZSl7Y29uc3QgdD1lLmxlbmd0aDtsZXQgbj1bXSxyPTA7Zm9yKDtyPHQ7KXIrMjx0JiYwPT09ZVtyXSYmMD09PWVbcisxXSYmKDA9PT1lW3IrMl18fDE9PT1lW3IrMl18fDI9PT1lW3IrMl18fDM9PT1lW3IrMl0pPyhuLnB1c2goZVtyXSxlW3IrMV0sMyxlW3IrMl0pLHIrPTMpOihuLnB1c2goZVtyXSkscisrKTtyZXR1cm4gbmV3IFVpbnQ4QXJyYXkobil9KHQpLHI9bi5sZW5ndGgsYT1NYXRoLmZsb29yKHIvMjU1KSxvPXIlMjU1LHM9bmV3IFVpbnQ4QXJyYXkoNithKzErcitlLmJ5dGVMZW5ndGgpO3NbMF09MCxzWzFdPTAsc1syXT0wLHNbM109MSxzWzRdPTYsc1s1XT0xMDE7bGV0IGk9MDtmb3IoO2k8YTspc1s2K2ldPTI1NSxpKys7cmV0dXJuIHNbNitpXT1vLGkrKyxzLnNldChuLDYraSkscy5zZXQobmV3IFVpbnQ4QXJyYXkoZSksNitpK3IpLHMuYnVmZmVyfW5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZigiU2FmYXJpIik+LTEmJi0xPT09bmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCJDaHJvbWUiKSYmKHNlbGYub25ydGN0cmFuc2Zvcm09bj0+e2NvbnN0IHI9bi50cmFuc2Zvcm1lcjtsZXQgYT1bXTtyLm9wdGlvbnMucG9ydC5vbm1lc3NhZ2U9ZT0+e2UuZGF0YS5zZWkmJmEucHVzaChlLmRhdGEuc2VpKX0sc2VsZi5wb3N0TWVzc2FnZSgic3RhcnRlZCIpO2NvbnN0IG89ci5yZWFkYWJsZS5nZXRSZWFkZXIoKSxzPXIud3JpdGFibGUuZ2V0V3JpdGVyKCk7InJ4Ij09PXIub3B0aW9ucy5uYW1lP2Z1bmN0aW9uIHQobil7by5yZWFkKCkudGhlbigocj0+e2lmKCFyLmRvbmUpe2lmKHIudmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgdD1mdW5jdGlvbih0KXtjb25zdCBuPW5ldyBEYXRhVmlldyh0LmRhdGEpO2xldCByPTA7Zm9yKDtyKzQ8dC5kYXRhLmJ5dGVMZW5ndGg7KXtpZigwPT09bi5nZXRVaW50OChyKzApJiYwPT09bi5nZXRVaW50OChyKzEpJiYwPT09bi5nZXRVaW50OChyKzIpJiYxPT09bi5nZXRVaW50OChyKzMpJiY2PT09bi5nZXRVaW50OChyKzQpKXtsZXQgYT1yKzYsbz0wLHM9MDtmb3IoOzI1NT09PShzPW4uZ2V0VWludDgoYSsrKSk7KW8rPTI1NTtvKz1zO2NvbnN0IGk9ZSh0LmRhdGEsYSxvKTtyZXR1cm4gbmV3IFVpbnQ4QXJyYXkoaSl9cisrfXJldHVybiBudWxsfShyLnZhbHVlKTt0JiZuLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7c2VpOnR9KX1zLndyaXRlKHIudmFsdWUpLG4ub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQobil9fSkpfShyKToidHgiPT09ci5vcHRpb25zLm5hbWUmJmZ1bmN0aW9uIGUobil7by5yZWFkKCkudGhlbigocj0+e2lmKCFyLmRvbmUpe2lmKHIudmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgZT1hLnNoaWZ0KCk7ZSYmKHIudmFsdWUuZGF0YT10KHIudmFsdWUuZGF0YSxlKSl9cy53cml0ZShyLnZhbHVlKSxuLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7dHJhbnNmb3JtZWQ6ITB9KSxlKG4pfX0pKX0ocil9LHNlbGYucG9zdE1lc3NhZ2UoInJlZ2lzdGVyZWQiKSk7Cg==")],{type:"text/javascript"});return setTimeout((()=>HP.revokeObjectURL(L)),0),new Worker(HP.createObjectURL(L))}const TU=new Map,SU=new Map;function NU(L,k,M){let U=new Uint8Array(L,k,M),x=[],V=0;for(;x.length<M;)V+3<M&&0===U[V]&&0===U[V+1]&&3===U[V+2]&&(0===U[V+3]||1===U[V+3]||2===U[V+3]||3===U[V+3])?(x.push(U[V],U[V+1],U[V+3]),V+=4):(x.push(U[V]),V++);return new Uint8Array(x)}const RU=new Map;const IU=new Map;!function(){const L=Gv();KP.getDisplayMedia=!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia),KP.getStreamFromExtension=L.name===JC.CHROME&&Number(L.version)>34,KP.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver)return!1;if(!("currentDirection"in RTCRtpTransceiver.prototype))return!1;const L=new RTCPeerConnection;let k=!1;try{L.addTransceiver("audio"),k=!0}catch(L){}return L.close(),k}(),KP.supportMinBitrate=L.name===JC.CHROME||L.name===JC.EDGE,KP.supportSetRtpSenderParameters=function(){const L=Gv();return!!(window.RTCRtpSender&&window.RTCRtpSender.prototype.setParameters&&window.RTCRtpSender.prototype.getParameters)&&(!!py()||!(!zv()&&!Yv())||L.name===JC.FIREFOX&&Number(L.version)>=64)}(),L.name===JC.SAFARI&&(Number(L.version)>=14?KP.supportDualStream=!0:KP.supportDualStream=!1),KP.webAudioMediaStreamDest=function(){const L=Gv();return!(L.name===JC.SAFARI&&Number(L.version)<12)}(),KP.supportReplaceTrack=!!window.RTCRtpSender&&"function"==typeof RTCRtpSender.prototype.replaceTrack,KP.supportWebGL="undefined"!=typeof WebGLRenderingContext,KP.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,py()||(KP.webAudioWithAEC=!0),KP.supportShareAudio=function(){const L=Gv();return(L.os===XC.WIN_10||L.os===XC.WIN_81||L.os===XC.WIN_7||L.os===XC.LINUX||L.os===XC.MAC_OS||L.os===XC.CHROMIUM_OS)&&L.name===JC.CHROME&&Number(L.version)>=74}(),KP.supportDataChannel=!!(Zv(76)||function(L){const k=Gv();return!(k.name!==JC.FIREFOX||!k.osVersion)&&Number(k.version)>=68}()||ty(14)),KP.supportPCSetConfiguration=function(){const L=window.RTCPeerConnection;return!Xv()&&!!L&&L.prototype.setConfiguration instanceof Function}(),KP.supportWebRTCEncodedTransform=function(){const L=Gv();return"Chrome"===L.name&&Number(L.version)>=86||"Safari"===L.name&&Number(L.version)>=15}(),KP.supportWebRTCInsertableStream=function(){const L=Gv();return(L.name===JC.CHROME||L.name===JC.EDGE)&&Number(L.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window}(),KP.supportRequestVideoFrameCallback="requestVideoFrameCallback"in HTMLVideoElement.prototype,KP.supportWebCrypto="undefined"!=typeof window&&void 0!==window.crypto&&void 0!==window.crypto.subtle,nA((()=>{KP.supportDualStreamEncoding=function(){const L=Gv();return!!zA("DISABLE_WEBAUDIO")||"Safari"===L.name&&Number(L.version)>=14||!!("Chrome"===L.name&&/Windows/i.test(L.os||"")&&Number(L.version)>=100&&zA("CHROME_DUAL_STREAM_USE_ENCODING"))}(),Eb.info("browser compatibility",JSON.stringify(KP),JSON.stringify(L))}))}();class kU extends My{constructor(L,k){super(),xg(this,"signal",void 0),xg(this,"token",void 0),xg(this,"tokenTimeout",void 0),xg(this,"tokenInterval",void 0),xg(this,"_sequence",0),xg(this,"userMap",new Map),xg(this,"encoder",new TextEncoder),this.signal=L,this.token=k;const i=()=>{this.signal.connectionState===vw.CONNECTED&&this.check(),0===this.userMap.size?this.tokenInterval=window.setTimeout(i,1e3):this.tokenInterval=window.setTimeout(i,3*zA("P2P_TOKEN_INTERVAL"))};i()}async send(L,k,M,U,x){var V,F,j;if(0===this.userMap.size)return;const z=Array.from(dN(V=this.userMap).call(V))[0].token;"string"!=typeof k&&(k=JSON.stringify(k)),U=null!==(F=U)&&void 0!==F?F:fA(6,""),x=null!==(j=x)&&void 0!==j?j:this._sequence++;const Q={_id:U,_type:L,_seq:x,_message:k,token:"".concat(this.token,"_").concat(z)};zA("SHOW_P2P_LOG")&&Eb.debug("send message",Q,"noNeedResponse : ".concat(M)),this.splitMessage(JSON.stringify(Q)).forEach((L=>{this.signal.request(ww.DATA_STREAM,{payload:dA(this.encoder.encode(L))})}));const $=new Mp(((k,x)=>{const V=window.setTimeout((()=>{this.off("res-@".concat(U,"_ack"),s),this.off("res-@".concat(U),c),this.off(SO.ABORT,a),Eb.debug("[external-signal] request timeout, type: ".concat(L,", requestId: ").concat(U)),0===this.userMap.size?x(new nv(iv.INVALID_REMOTE_USER)):x(new nv(iv.TIMEOUT))}),zA("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),s=()=>{V&&window.clearTimeout(V),this.off(SO.ABORT,a),M&&k()},a=()=>{V&&window.clearTimeout(V),this.off("res-@".concat(U,"_ack"),s),this.off("res-@".concat(U),c),x(new nv(iv.EXTERNAL_SIGNAL_ABORT,"type: ".concat(L,", requestId: ").concat(U)))};this.once(SO.ABORT,a),this.once("res-@".concat(U,"_ack"),s);const c=(M,j)=>{F=!0,V&&window.clearTimeout(V),this.off("res-@".concat(U,"_ack"),s),this.off(SO.ABORT,a),"success"===M?k(j):x(new nv(iv.P2P_MESSAGE_FAILED,"request ".concat(L," failed, requestId: ").concat(U)))};let F=!1;M||(this.once("res-@".concat(U),c),EA(zA("SIGNAL_REQUEST_TIMEOUT")).then((()=>{F||Eb.warning("external_signal request timeout, type: ".concat(L,", requestId: ").concat(U,", ").concat(Q))})))}));try{return await $}catch(V){if(V.code===iv.TIMEOUT)return await this.send(L,k,M,U,x);throw V}}onMessage(L){var k;const{_uid:M}=L;let U,x=this.userMap.get(M);if(x)U=x.splitMessageMap;else{if(this.userMap.size>0||!("_type"in L)||L._type!==TO.CHECK)return;const{token:k}=L;U=new Map,x={uid:M,isStart:!0,token:k,splitMessageMap:U,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(M,x),this.signal.emit(Nw.ON_USER_ONLINE,{uid:M}),this.handleUserOnline()}if("id"in L&&"total"in L){var V;const{id:k,total:x}=L,F=null!==(V=U.get(k))&&void 0!==V?V:[];if(F.push(L),U.has(k)||U.set(k,F),F.length!==x)return;{const x=gE(F).call(F,((L,k)=>L.index-k.index)).map((L=>L.payload)).join("");U.delete(k),(L=JSON.parse(x))._uid=M}}const{_type:F,token:j}=L;if(Sr(k=[TO.ACK,TO.CHECK]).call(k,F))return F===TO.CHECK&&this.handleCheckToken(x,j),void this.receiveMessage(L);j==="".concat(x.token,"_").concat(this.token)?this.handleReceivedMessage(L):Eb.debug('Receive unexpected message", '.concat(j,", cur_token: ").concat(x.token,"_").concat(this.token),L)}check(){const L={_id:fA(6,""),token:this.token,_type:TO.CHECK};zA("SHOW_P2P_LOG")&&Eb.debug("send message",L),this.signal.request(ww.DATA_STREAM,{payload:dA(this.encoder.encode(JSON.stringify(L)))})}ack(L){const k={_id:L,_type:TO.ACK,token:this.token};zA("SHOW_P2P_LOG")&&Eb.debug("send message",k),this.signal.request(ww.DATA_STREAM,{payload:dA(this.encoder.encode(JSON.stringify(k)))})}response(L,k,M){this.send(TO.RESPONSE,JSON.stringify({success:!M,message:k}),!0,L)}handleReceivedMessage(L){const t=()=>{this.userMap.forEach((L=>{const{receivedMessagesMap:k,nextExpectedSequenceNumber:M}=L;for(;k.has(M);){const U=k.get(M);k.delete(M),this.receiveMessage(U),L.nextExpectedSequenceNumber++}}))};if(!L)return void t();const{_uid:k,_seq:M}=L,U=this.userMap.get(k),{receivedMessagesMap:x,isStart:V,nextExpectedSequenceNumber:F}=U;if(M<F)return this.ack(L._id),void Eb.debug("[external-signal] receive old message, seq: ".concat(M,", ").concat(L._message));x.set(M,L),V&&M===F&&(this.receiveMessage(L),x.delete(F),U.nextExpectedSequenceNumber++,t())}receiveMessage(L){const{_id:k,_type:M,_message:U,_uid:x}=L;if(zA("SHOW_P2P_LOG")&&Eb.debug("receive message",L),k){let V;switch(L._type!==TO.ACK&&(U&&(V=JSON.parse(U)),this.ack(L._id)),L._type){case TO.CANDIDATE:case TO.CONTROL:this.signal.emit(M,V,x);break;case TO.PUBLISH:case TO.UNPUBLISH:case TO.RESTART_ICE:case TO.CALL:V.uid=x,Xy(this.signal,M,V).then((k=>{this.response(L._id,k)})).catch((()=>{this.response(L._id,void 0,!0)}));break;case TO.ACK:this.getListeners("res-@".concat(k,"_ack")).length>0&&this.emit("res-@".concat(k,"_ack"));break;case TO.RESPONSE:{const{success:L,message:M}=V;this.emit("res-@".concat(k),L?"success":"failed",M);break}}}}splitMessage(L){if(L.length<kU.MAX_MESSAGE_SIZE)return[L];const k=[],{remoteToken:M}=JSON.parse(L),U=fA(6,"");let x=0,V=800;const F=Math.ceil(L.length/V);for(;L.length>0;){x++;const j={id:U,index:x,total:F,payload:L.slice(0,V),token:"".concat(this.token,"_").concat(M)};JSON.stringify(j).length>kU.MAX_MESSAGE_SIZE?V-=50:(k.push(j),L=L.slice(V))}return k.map((L=>JSON.stringify(L)))}handleCheckToken(L,k){return L.token!==k?(Eb.debug("token changed, from ".concat(L.token," to ").concat(k)),this.reset(L.uid,k),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout((()=>{Eb.debug("token timeout, ".concat(k)),this.reset(L.uid)}),zA("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){const L=await Xy(this.signal,TO.CALL,void 0),k=await this.send(TO.CALL,L);this.signal.emit(bw.P2P_CONNECTION,k,!0)}async reset(L,k){const M=this.userMap.get(L);M&&(this.emit(SO.ABORT),this.signal.emit(Nw.ON_USER_OFFLINE,{uid:M.uid,reason:IO.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),k||(Eb.debug("change local token from ".concat(k," to ").concat(k)),this.token=fA(6,"")))}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(SO.ABORT)}}xg(kU,"MAX_SIZE",1),xg(kU,"MAX_MESSAGE_SIZE",1024);class MU extends My{get connectionState(){return this._connectionState}set connectionState(L){L!==this._connectionState&&(this._connectionState=L,L===vw.CONNECTED?this.emit(bw.WS_CONNECTED):L===vw.RECONNECTING?this.emit(bw.WS_RECONNECTING,this._websocketReconnectReason):L===vw.CLOSED&&this.emit(bw.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(L,k){super(),xg(this,"_disconnectedReason",void 0),xg(this,"_websocketReconnectReason",void 0),xg(this,"_connectionState",vw.CLOSED),xg(this,"reconnectToken",void 0),xg(this,"p2pToken",void 0),xg(this,"websocket",void 0),xg(this,"openConnectionTime",void 0),xg(this,"clientId",void 0),xg(this,"lastMsgTime",Date.now()),xg(this,"uploadCache",[]),xg(this,"uploadCacheInterval",void 0),xg(this,"rttRolling",new LA(5)),xg(this,"pingpongTimer",void 0),xg(this,"pingpongTimeoutCount",0),xg(this,"joinResponse",void 0),xg(this,"multiIpOption",void 0),xg(this,"initError",void 0),xg(this,"spec",void 0),xg(this,"store",void 0),xg(this,"_external_signal",void 0),xg(this,"onWebsocketMessage",(L=>{if(L.data instanceof ArrayBuffer)return void this.emit(bw.ON_BINARY_DATA,L.data);const k=JSON.parse(L.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(k,"_id")){const L="res-@".concat(k._id);this.emit(L,k._result,k._message)}else if(Object.prototype.hasOwnProperty.call(k,"_type")){switch(k._type){case Nw.ON_DATA_STREAM:return void this.handleDataStream(k._message);case Nw.MUTE_AUDIO:case Nw.MUTE_VIDEO:case Nw.ON_P2P_LOST:case Nw.ON_USER_ONLINE:return;case Nw.ON_USER_OFFLINE:const{uid:L}=k._message;return Eb.debug("[".concat(this.clientId,"] user-offline uid: ").concat(L)),void this._external_signal.reset(L)}if(this.emit(k._type,k._message),k._type===Nw.ON_NOTIFICATION&&this.handleNotification(k._message),k._type===Nw.ON_USER_BANNED)switch(k._message.error_code){case 14:this.close(hv.UID_BANNED);break;case 15:this.close(hv.IP_BANNED);break;case 16:this.close(hv.CHANNEL_BANNED)}if(k._type===Nw.ON_USER_LICENSE_BANNED)switch(k._message.error_code){case Cw.ERR_LICENSE_MISSING:this.close(hv.LICENSE_MISSING);break;case Cw.ERR_LICENSE_EXPIRED:this.close(hv.LICENSE_EXPIRED);break;case Cw.ERR_LICENSE_MINUTES_EXCEEDED:this.close(hv.LICENSE_MINUTES_EXCEEDED);break;case Cw.ERR_LICENSE_PERIOD_INVALID:this.close(hv.LICENSE_PERIOD_INVALID);break;case Cw.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(hv.LICENSE_MULTIPLE_SDK_SERVICE);break;case Cw.ERR_LICENSE_ILLEGAL:this.close(hv.LICENSE_ILLEGAL);break;default:this.close()}}})),this.clientId=L.clientId,this.spec=L,this.store=k,this.websocket=new jO("gateway-".concat(this.clientId),this.spec.retryConfig,!0,zA("JOIN_GATEWAY_USE_DUAL_DOMAIN"),zA("JOIN_GATEWAY_USE_443PORT_ONLY"),k),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===vw.CONNECTED&&this.reconnect("retry",fv.OFFLINE)})),this.p2pToken=fA(6,""),this._external_signal=new kU(this,this.p2pToken)}async request(L,k,M,U){const x=fA(6,""),V={_id:x,_type:L,_message:k},F=this.websocket.connectionID,a=()=>new Mp(((L,k)=>{if(this.connectionState===vw.CONNECTED)return L();const i=()=>{this.off(bw.WS_CLOSED,n),L()},n=()=>{this.off(bw.WS_CONNECTED,i),k(new nv(iv.WS_ABORT))};this.once(bw.WS_CONNECTED,i),this.once(bw.WS_CLOSED,n)}));if(this.connectionState!==vw.CONNECTING&&this.connectionState!==vw.RECONNECTING||L===ww.JOIN||L===ww.REJOIN||await a(),this.websocket.sendMessage(V,!0),U)return;const j=new Mp(((M,U)=>{let V=!1;const a=(U,x)=>{V=!0,M({isSuccess:"success"===U,message:x||{}}),this.off(bw.WS_CLOSED,c),this.off(bw.WS_RECONNECTING,c),this.emit(bw.REQUEST_SUCCESS,L,k)};this.once("res-@".concat(x),a);const c=()=>{U(new nv(iv.WS_ABORT,"type: ".concat(L))),this.off(bw.WS_CLOSED,c),this.off(bw.WS_RECONNECTING,c),this.off("res-@".concat(x),a)};this.once(bw.WS_CLOSED,c),this.once(bw.WS_RECONNECTING,c),EA(zA("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==F||V||(Eb.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(L)),this.emit(bw.REQUEST_TIMEOUT,L,k))}))}));let z=null;try{z=await j}catch(U){if(this.connectionState===vw.CLOSED||L===ww.LEAVE)throw new nv(iv.WS_ABORT);return!this.spec.forceWaitGatewayResponse||M?U.throw():L===ww.JOIN||L===ww.REJOIN?null:(await a(),await this.request(L,k))}if(z.isSuccess)return z.message;const Q=Number(z.message.error_code||z.message.code),$=wO(Q),ee=new nv(iv.UNEXPECTED_RESPONSE,"".concat($.desc,": ").concat(z.message.error_str),{code:Q,data:z.message,desc:$.desc});return"success"===$.action?z.message:(Eb.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(L,", error_code: ").concat(Q,", message: ").concat($.desc,", action: ").concat($.action)),Q===Cw.ERR_TOO_MANY_BROADCASTERS?L===ww.JOIN||L===ww.REJOIN?(this.initError=ee,this.close(),ee.throw()):ee.throw():"failed"===$.action?ee.throw():"quit"===$.action?(this.initError=ee,this.close(),ee.throw()):(Q===Cw.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=z.message.option,Eb.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",fv.MULTI_IP)):this.reconnect($.action,fv.SERVER_ERROR),L===ww.JOIN||L===ww.REJOIN?null:await this.request(L,k)))}waitMessage(L,k){return new Mp((M=>{const n=U=>{(!k||k(U))&&(this.off(L,n),M(U))};this.on(L,n)}))}uploadWRTCStats(L){if(!this.store.sessionId)return void Eb.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const k={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:L};this.upload(Ow.WRTC_STATS,k)}upload(L,k){const M={_type:L,_message:k};try{this.websocket.sendMessage(M)}catch(L){const k=zA("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(M),this.uploadCache.length>k&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==vw.CONNECTED)return;const L=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(L._type,L._message)}),zA("UPLOAD_CACHE_INTERVAL")||2e3))}}send(L,k){const M={_type:L,_message:k};this.websocket.sendMessage(M)}async sendExtensionMessage(L,k,M){return await this._external_signal.send(L,k,M)}init(L){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Mp(((k,M)=>{this.once(bw.WS_CONNECTED,(()=>k(this.joinResponse))),this.once(bw.WS_CLOSED,(()=>M(this.initError||new nv(iv.WS_ABORT)))),this.connectionState=vw.CONNECTING,this.websocket.init(L).catch(M)}))}close(L){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=L||hv.LEAVE,this.connectionState=vw.CLOSED,Eb.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),this.p2pToken=fA(6,""),this._external_signal.clear(),this._external_signal=new kU(this,this.p2pToken)}async join(){if(!this.joinResponse){this.emit(bw.ABORT_P2P_EXECUTION);const L=await Xy(this,bw.REQUEST_JOIN_INFO),k=await this.request(ww.JOIN,L);if(!k)return this.emit(bw.REPORT_JOIN_GATEWAY,iv.TIMEOUT,this.url||""),!1;this.joinResponse=k,this.emit(bw.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=vw.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(L,k){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(L,k)}handleDataStream(L){try{var k;const M=cA(L.payload),U=(new TextDecoder).decode(M),x=JSON.parse(U);"total"in x&&"id"in x||Sr(k=Object.values(TO)).call(k,x._type)?(x._uid=L.uid,this._external_signal.onMessage(x)):this.emit(Nw.ON_DATA_STREAM,L)}catch(k){this.emit(Nw.ON_DATA_STREAM,L)}}handleNotification(L){Eb.debug("[".concat(this.clientId,"] receive notification: "),L);const k=wO(L.code);if("success"!==k.action){if("failed"!==k.action)return"quit"===k.action?("ERR_REPEAT_JOIN_CHANNEL"===k.desc&&this.close(hv.UID_BANNED),void this.close()):void this.reconnect(k.action,fv.SERVER_ERROR);Eb.error("[".concat(this.clientId,"] ignore error: "),k.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const L=zA("PING_PONG_TIME_OUT"),k=Date.now();this.pingpongTimeoutCount>=L&&(Eb.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(k-this.lastMsgTime,"ms")),k-this.lastMsgTime>zA("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",fv.TIMEOUT):this.request(ww.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const L=Date.now()-k;this.rttRolling.add(L),zA("REPORT_STATS")&&this.send(ww.PING_BACK,{pingpongElapse:L})})).catch((L=>{}))}handleWebsocketEvents(){this.websocket.on(Pw.RECONNECT_WAITTING_FINISH,(L=>{this.emit(bw.WS_RECONNECT_WAITTING_FINISH,L)})),this.websocket.on(Pw.RECONNECT_CREATE_CONNECTION,(L=>{this.emit(bw.WS_RECONNECT_CREATE_CONNECTION,L)})),this.websocket.on(Pw.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Pw.CLOSED,(()=>{this.connectionState=vw.CLOSED})),this.websocket.on(Pw.FAILED,(()=>{this._disconnectedReason=hv.NETWORK_ERROR,this.connectionState=vw.CLOSED})),this.websocket.on(Pw.RECONNECTING,(L=>{this._websocketReconnectReason=L,this.joinResponse=void 0,this.connectionState===vw.CONNECTED?this.connectionState=vw.RECONNECTING:this.connectionState=vw.CONNECTING})),this.websocket.on(Pw.WILL_RECONNECT,((L,k,M)=>{"retry"!==L?(Eb.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(L)),this.reconnectToken=void 0):Eb.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),M(L)})),this.websocket.on(Pw.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.join().catch((L=>{if(this.emit(bw.REPORT_JOIN_GATEWAY,L,this.url||""),L instanceof nv&&L.code===iv.UNEXPECTED_RESPONSE&&L.data.code===Cw.ERR_NO_AUTHORIZED)return Eb.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",fv.SERVER_ERROR);Eb.error("[".concat(this.clientId,"] join gateway request failed"),L.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",fv.SERVER_ERROR):(this.initError=L,this.close())}))})),this.websocket.on(Pw.REQUEST_NEW_URLS,((L,k)=>{Xy(this,bw.REQUEST_RECOVER,this.multiIpOption).then(L).catch(k)})),this.websocket.on(Pw.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(Nw.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}))}}var CU={exports:{}};!function(L,k){L.exports=(()=>{var L={8:(L,k,M)=>{M.r(k),M.d(k,{Parser:()=>C,Printer:()=>b,parse:()=>D,print:()=>P});const U="\n",x="".concat("\r").concat(U),V=" ";let F;function a(L){return L>="0"&&L<="9"}function c(L){return L>="!"&&L<="~"}function d(L){return c(L)||L>="Â"&&L<="Ã¿"}function l(L){return"!"===L||L>="#"&&L<="'"||L>="*"&&L<="+"||L>="-"&&L<="."||L>="0"&&L<="9"||L>="A"&&L<="Z"||L>="^"&&L<="~"}function u(L){return L>="1"&&L<="9"}function h(L){return L>="A"&&L<="Z"||L>="a"&&L<="z"}function p(L){return"d"===L||"h"===L||"m"===L||"s"===L}function _(L){return L>""&&L<"\t"||L>"\v"&&L<"\f"||L>""&&L<"Ã¿"}function E(L){return h(L)||a(L)||"+"===L||"/"===L}function f(L){return a(L)||h(L)||"+"===L||"/"===L||"-"===L||"_"===L}function m(L){return h(L)||a(L)||"+"===L||"/"===L}function T(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function S(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?T(Object(M),!0).forEach((function(k){g(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):T(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}function g(L,k,M){return k in L?Object.defineProperty(L,k,{value:M,enumerable:!0,configurable:!0,writable:!0}):L[k]=M,L}!function(L){L.VERSION="v",L.ORIGIN="o",L.SESSION_NAME="s",L.INFORMATION="i",L.URI="u",L.EMAIL="e",L.PHONE="p",L.CONNECTION="c",L.BANDWIDTH="b",L.TIME="t",L.REPEAT="r",L.ZONE_ADJUSTMENTS="z",L.KEY="k",L.ATTRIBUTE="a",L.MEDIA="m"}(F||(F={}));class R{consumeText(L,k){let M=k;for(;M<L.length;){const k=L[M];if("\0"===k||"\r"===k||k===U)break;M+=1}if(M-k==0)throw new Error("Invalid text, at ".concat(L));return M}consumeUnicastAddress(L,k,M){return this.consumeTill(L,k,V)}consumeOneOrMore(L,k,M){let U=k;for(;M(L[U]);)U++;if(U-k==0)throw new Error("Invalid rule at ".concat(k,"."));return U}consumeSpace(L,k){if(L[k]===V)return k+1;throw new Error("Invalid space at ".concat(k,"."))}consumeIP4Address(L,k){let M=k;for(let k=0;k<4;k++)if(M=this.consumeDecimalUChar(L,M),3!==k){if("."!==L[M])throw new Error("Invalid IP4 address.");M++}return M}consumeDecimalUChar(L,k){let M=k;for(let k=0;k<3&&a(L[M]);k++,M++);if(M-k==0)throw new Error("Invalid decimal uchar.");const U=parseInt(L.slice(k,M));if(U>=0&&U<=255)return M;throw new Error("Invalid decimal uchar")}consumeIP6Address(L,k){let M=this.consumeHexpart(L,k);return":"===L[M]?(M+=1,M=this.consumeIP4Address(L,M),M):M}consumeHexpart(L,k){let M=k;if(":"===L[M]&&":"===L[M+1]){M+=2;try{M=this.consumeHexseq(L,M)}catch(L){}return M}if(M=this.consumeHexseq(L,M),":"===L[M]&&":"===L[M+1]){M+=2;try{M=this.consumeHexseq(L,M)}catch(L){}return M}return M}consumeHexseq(L,k){let M=k;for(;M=this.consumeHex4(L,M),":"===L[M]&&":"!==L[M+1];)M+=1;return M}consumeHex4(L,k){let M=0;for(;M<4;M++)if(!((U=L[k+M])>="0"&&U<="9"||U>="a"&&U<="f"||U>="A"&&U<="F")){if(0===M)throw new Error("Invalid hex 4");break}var U;return k+M}consumeFQDN(L,k){let M=k;for(;a(L[M])||h(L[M])||"-"===L[M]||"."===L[M];)M+=1;if(M-k<4)throw new Error("Invalid FQDN");return M}consumeExtnAddr(L,k){return this.consumeOneOrMore(L,k,d)}consumeMulticastAddress(L,k,M){switch(M){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(L,k);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(L,k);default:try{return this.consumeFQDN(L,k)}catch(M){return this.consumeExtnAddr(L,k)}}}consumeIP6MulticastAddress(L,k){const M=this.consumeHexpart(L,k);return"/"===L[M]?this.consumeInteger(L,M+1):M}consumeIP4MulticastAddress(L,k){let M=k+3;const U=L.slice(k,M),x=parseInt(U);if(x<224||x>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let k=0;k<3;k++){if("."!==L[M])throw new Error("Invalid IP4 multicast address.");M+=1,M=this.consumeDecimalUChar(L,M)}return"/"===L[M]&&(M+=1),M=this.consumeTTL(L,M),"/"===L[M]&&(M=this.consumeInteger(L,M)),M}consumeInteger(L,k){if(!u(L[k]))throw new Error("Invalid integer.");for(k+=1;a(L[k]);)k+=1;return k}consumeTTL(L,k){if("0"===L[k])return k+1;if(!u(L[k]))throw new Error("Invalid TTL.");k+=1;for(let M=0;M<2&&a(L[k]);M++)k+=1;return k}consumeToken(L,k){return this.consumeOneOrMore(L,k,l)}consumeTime(L,k){let M=k;if("0"===L[M])return M+1;for(u(L[M])&&(M+=1);a(L[M]);)M++;if(M-k<10)throw new Error("Invalid time");return M}consumeAddress(L,k){return this.consumeTill(L,k,V)}consumeTypedTime(L,k){let M=k;return M=this.consumeOneOrMore(L,M,a),p(L[M])?M+1:M}consumeRepeatInterval(L,k){if(!u(L[k]))throw new Error("Invalid repeat interval");for(k+=1;a(L[k]);)k+=1;return p(L[k])&&(k+=1),k}consumePort(L,k){return this.consumeOneOrMore(L,k,a)}consume(L,k,M){for(let U=0;U<M.length;U++){if(k+U>=L.length)throw new Error("consume exceeding value length");if(L[k+U]!==M[U])throw new Error("consume ".concat(M," failed at ").concat(U))}return k+M.length}consumeTill(L,k,M){let U=k;for(;U<L.length&&("string"!=typeof M||L[U]!==M)&&("function"!=typeof M||!M(L[U]));)U++;return U}}class C extends R{constructor(){super(),g(this,"records",[]),g(this,"currentLine",0)}parse(L){const k=this.probeEOL(L);this.records=L.split(k).filter((L=>!!l_(L).call(L))).map(this.parseLine),this.currentLine=0;const M=this.parseVersion(),U=this.parseOrigin(),x=this.parseSessionName(),V=this.parseInformation(),F=this.parseUri(),j=this.parseEmail(),z=this.parsePhone(),Q=this.parseConnection(),$=this.parseBandWidth(),ee=this.parseTimeFields(),te=this.parseKey(),ie=this.parseSessionAttribute(),ne=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:M,origin:U,sessionName:x,information:V,uri:F,emails:j,phones:z,connection:Q,bandwidths:$,timeFields:ee,key:te,attributes:ie,mediaDescriptions:ne}}getCurrentRecord(){const L=this.records[this.currentLine];if(!L)throw new Error("Record doesn't exit.");return L}probeEOL(L){for(let k=0;k<L.length;k++)if(L[k]===U)return"\r"===L[k-1]?x:U;throw new Error("Invalid newline character.")}parseLine(L,k){if(L.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const M=L[0];if("="!==L[1])throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:M,value:L.slice(2),line:k,cur:0}}parseSessionAttribute(){const L=new v;for(;this.currentLine<this.records.length;){const k=this.getCurrentRecord();if(k.type!==F.ATTRIBUTE)break;const M={attField:this.extractOneOrMore(k,(L=>l(L)&&":"!==L)),_cur:0};":"===k.value[k.cur]&&(k.cur+=1,M.attValue=this.extractOneOrMore(k,_)),L.parse(M),this.currentLine++}return L.digest()}parseMediaAttributes(L){const k=new y(L);for(;this.currentLine<this.records.length;){const L=this.getCurrentRecord();if(L.type!==F.ATTRIBUTE)break;const M={attField:this.extractOneOrMore(L,(L=>l(L)&&":"!==L)),_cur:0};":"===L.value[L.cur]&&(L.cur+=1,M.attValue=this.extractOneOrMore(L,_)),k.parse(M),this.currentLine++}return k.digest()}parseKey(){const L=this.getCurrentRecord();if(L.type===F.KEY){if("prompt"===L.value||"clear:"===L.value||"base64:"===L.value||"uri:"===L.value)return L.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const L=this.getCurrentRecord();if(L.type===F.ZONE_ADJUSTMENTS){const k=[];for(;;)try{const M=this.extract(L,this.consumeTime);this.consumeSpaceForRecord(L);let U=!1;"-"===L.value[L.cur]&&(U=!0,L.cur+=1);const x=this.extract(L,this.consumeTypedTime);k.push({time:M,typedTime:x,back:U})}catch(L){break}if(0===k.length)throw new Error("Invalid zone adjustments");return this.currentLine++,k}return[]}parseRepeat(){const L=[];for(;;){const k=this.getCurrentRecord();if(k.type!==F.REPEAT)break;{const M=this.extract(k,this.consumeRepeatInterval),U=this.parseTypedTime(k);L.push({repeatInterval:M,typedTimes:U}),this.currentLine++}}return L}parseTypedTime(L){const k=[];for(;;)try{this.consumeSpaceForRecord(L),k.push(this.extract(L,this.consumeTypedTime))}catch(L){break}if(0===k.length)throw new Error("Invalid typed time.");return k}parseTime(){const L=this.getCurrentRecord(),k=this.extract(L,this.consumeTime);this.consumeSpaceForRecord(L);const M=this.extract(L,this.consumeTime);return this.currentLine++,{startTime:k,stopTime:M}}parseBandWidth(){const L=[];for(;this.currentLine<this.records.length;){const k=this.getCurrentRecord();if(k.type!==F.BANDWIDTH)break;{const M=this.extractOneOrMore(k,l);if(":"!==k.value[k.cur])throw new Error("Invalid bandwidth field.");k.cur++;const U=this.extractOneOrMore(k,a);L.push({bwtype:M,bandwidth:U}),this.currentLine++}}return L}parseVersion(){const L=this.getCurrentRecord();if(L.type!==F.VERSION)throw new Error("first sdp record must be version");const k=L.value.slice(0,this.consumeOneOrMore(L.value,0,a));if(k.length!==L.value.length)throw new Error('invalid proto version, "v='.concat(L.value,'"'));return this.currentLine++,k}parseOrigin(){const L=this.getCurrentRecord();if(L.type!==F.ORIGIN)throw new Error("second line of sdp must be origin");const k=this.extractOneOrMore(L,d);this.consumeSpaceForRecord(L);const M=this.extractOneOrMore(L,a);this.consumeSpaceForRecord(L);const U=this.extractOneOrMore(L,a);this.consumeSpaceForRecord(L);const x=this.extractOneOrMore(L,l);this.consumeSpaceForRecord(L);const V=this.extractOneOrMore(L,l);this.consumeSpaceForRecord(L);const j=this.extract(L,this.consumeUnicastAddress);return this.currentLine++,{username:k,sessId:M,sessVersion:U,nettype:x,addrtype:V,unicastAddress:j}}parseSessionName(){const L=this.getCurrentRecord();if(L.type===F.SESSION_NAME){const k=this.extract(L,this.consumeText);return this.currentLine++,k}}parseInformation(){const L=this.getCurrentRecord();if(L.type!==F.INFORMATION)return;const k=this.extract(L,this.consumeText);return this.currentLine++,k}parseUri(){const L=this.getCurrentRecord();if(L.type===F.URI)return this.currentLine++,L.value}parseEmail(){const L=[];for(;;){const k=this.getCurrentRecord();if(k.type!==F.EMAIL)break;L.push(k.value),this.currentLine++}return L}parsePhone(){const L=[];for(;;){const k=this.getCurrentRecord();if(k.type!==F.PHONE)break;L.push(k.value),this.currentLine++}return L}parseConnection(){const L=this.getCurrentRecord();if(L.type===F.CONNECTION){const k=this.extractOneOrMore(L,l);this.consumeSpaceForRecord(L);const M=this.extractOneOrMore(L,l);this.consumeSpaceForRecord(L);const U=this.extract(L,this.consumeAddress);return this.currentLine++,{nettype:k,addrtype:M,address:U}}}parseMedia(){const L=this.getCurrentRecord(),k=this.extract(L,this.consumeToken);this.consumeSpaceForRecord(L);let M=this.extract(L,this.consumePort);"/"===L.value[L.cur]&&(L.cur+=1,M+=this.extract(L,this.consumeInteger)),this.consumeSpaceForRecord(L);const U=[];for(U.push(this.extract(L,this.consumeToken));"/"===L.value[L.cur];)L.cur+=1,U.push(this.extract(L,this.consumeToken));if(0===U.length)throw new Error("Invalid proto");const x=this.parseFmt(L);return this.currentLine++,{mediaType:k,port:M,protos:U,fmts:x}}parseTimeFields(){const L=[];for(;this.getCurrentRecord().type===F.TIME;){const k=this.parseTime(),M=this.parseRepeat(),U=this.parseZone();L.push({time:k,repeats:M,zones:U})}return L}parseMediaDescription(){const L=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===F.MEDIA;){const k=this.parseMedia(),M=this.parseInformation(),U=this.parseConnections(),x=this.parseBandWidth(),V=this.parseKey(),F=this.parseMediaAttributes(k);L.push({media:k,information:M,connections:U,bandwidths:x,key:V,attributes:F})}return L}parseConnections(){const L=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===F.CONNECTION;)L.push(this.parseConnection());return L}parseFmt(L){const k=[];for(;;)try{this.consumeSpaceForRecord(L),k.push(this.extract(L,this.consumeToken))}catch(L){break}if(0===k.length)throw new Error("Invalid fmts");return k}extract(L,k){for(var M=arguments.length,U=new Array(M>2?M-2:0),x=2;x<M;x++)U[x-2]=arguments[x];const V=k.call(this,L.value,L.cur,...U),F=L.value.slice(L.cur,V);return L.cur=V,F}extractOneOrMore(L,k){const M=this.consumeOneOrMore(L.value,L.cur,k),U=L.value.slice(L.cur,M);return L.cur=M,U}consumeSpaceForRecord(L){if(L.value[L.cur]!==V)throw new Error("Invalid space at ".concat(L.cur,"."));L.cur+=1}}class I extends R{constructor(){super(...arguments),g(this,"attributes",void 0),g(this,"digested",!1)}extractOneOrMore(L,k,M){const U=this.consumeOneOrMore(L.attValue,L._cur,k),x=L.attValue.slice(L._cur,U),[V,F]=M||[];if("number"==typeof V&&x.length<V)throw new Error("error in length, should be more or equal than ".concat(V," characters."));if("number"==typeof F&&x.length>F)throw new Error("error in length, should be less or equal than ".concat(F," characters."));return L._cur=U,x}consumeAttributeSpace(L){if(L.attValue[L._cur]!==V)throw new Error("Invalid space at ".concat(L._cur,"."));L._cur+=1}extract(L,k){if(!L.attValue)throw new Error("Nothing to extract from attValue.");for(var M=arguments.length,U=new Array(M>2?M-2:0),x=2;x<M;x++)U[x-2]=arguments[x];const V=k.call(this,L.attValue,L._cur,...U),F=L.attValue.slice(L._cur,V);return L._cur=V,F}atEnd(L){if(!L.attValue)throw new Error;return L._cur>=L.attValue.length}peekChar(L){if(!L.attValue)throw new Error;return L.attValue[L._cur]}peek(L,k){if(!L.attValue)throw new Error;for(let M=0;M<k.length;M++)if(k[M]!==L.attValue[L._cur+M])return!1;return!0}parseIceUfrag(L){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(L,E,[4,256])}parseIcePwd(L){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(L,E,[22,256])}parseIceOptions(L){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const k=[];for(;!this.atEnd(L);){k.push(this.extractOneOrMore(L,E));try{this.consumeAttributeSpace(L)}catch(k){if(this.atEnd(L))break;throw k}}this.attributes.iceOptions=k}parseFingerprint(L){const k=this.extract(L,this.consumeToken);this.consumeAttributeSpace(L);const M=this.extract(L,this.consumeTill);this.attributes.fingerprints.push({hashFunction:k,fingerprint:M})}parseExtmap(L){const k=this.extractOneOrMore(L,a);let M;"/"===this.peekChar(L)&&(this.extract(L,this.consume,"/"),M=this.extract(L,this.consumeToken)),this.consumeAttributeSpace(L);const U=this.extract(L,this.consumeTill,V),x=S(S({entry:parseInt(k,10)},M&&{direction:M}),{},{extensionName:U});this.peekChar(L)===V&&(this.consumeAttributeSpace(L),x.extensionAttributes=this.extract(L,this.consumeTill)),this.attributes.extmaps.push(x)}parseSetup(L){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const k=this.extract(L,this.consumeTill);if("active"!==k&&"passive"!==k&&"actpass"!==k&&"holdconn"!==k)throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=k}}class v extends I{constructor(){super(...arguments),g(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(L){if(this.digested)throw new Error("already digested");try{switch(L.attField){case"group":this.parseGroup(L);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(L);break;case"ice-pwd":this.parseIcePwd(L);break;case"ice-options":this.parseIceOptions(L);break;case"fingerprint":this.parseFingerprint(L);break;case"setup":this.parseSetup(L);break;case"tls-id":this.parseTlsId(L);break;case"identity":this.parseIdentity(L);break;case"extmap":this.parseExtmap(L);break;case"msid-semantic":this.parseMsidSemantic(L);break;default:L.ignored=!0,this.attributes.unrecognized.push(L)}}catch(k){throw console.error("parsing session attribute ".concat(L.attField,' error, "a=').concat(L.attField,":").concat(L.attValue,'"')),k}if(!L.ignored&&L.attValue&&!this.atEnd(L))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(L){const k=this.extract(L,this.consumeToken),M=[];for(;!this.atEnd(L)&&this.peekChar(L)===V;)this.consumeAttributeSpace(L),M.push(this.extract(L,this.consumeToken));this.attributes.groups.push({semantic:k,identificationTag:M})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(L){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(L,f)}parseIdentity(L){const k=this.extractOneOrMore(L,m),M=[];for(;!this.atEnd(L)&&this.peekChar(L)===V;){this.consumeAttributeSpace(L);const k=this.extract(L,this.consumeToken);this.extract(L,this.consume,"=");const U=this.extractOneOrMore(L,(L=>L!==V&&_(L)));M.push({name:k,value:U})}this.attributes.identities.push({assertionValue:k,extensions:M})}parseMsidSemantic(L){this.peekChar(L)===V&&this.consumeAttributeSpace(L);const k={semantic:this.extract(L,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(L)}catch(L){break}if("*"===this.peekChar(L)){this.extract(L,this.consume,"*"),k.applyForAll=!0;break}{const M=this.extract(L,this.consumeTill,V);k.identifierList.push(M)}}this.attributes.msidSemantic=k}}class y extends I{constructor(L){super(),g(this,"attributes",void 0),-1!==L.protos.indexOf("RTP")||L.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(L){if(this.digested)throw new Error("already digested");try{switch(L.attField){case"extmap":this.parseExtmap(L);break;case"setup":this.parseSetup(L);break;case"ice-ufrag":this.parseIceUfrag(L);break;case"ice-pwd":this.parseIcePwd(L);break;case"ice-options":this.parseIceOptions(L);break;case"candidate":this.parseCandidate(L);break;case"remote-candidate":this.parseRemoteCandidate(L);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(L);break;case"rtpmap":this.parseRtpmap(L);break;case"ptime":this.parsePtime(L);break;case"maxptime":this.parseMaxPtime(L);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(L);break;case"ssrc":this.parseSSRC(L);break;case"fmtp":this.parseFmtp(L);break;case"rtcp-fb":this.parseRtcpFb(L);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(L);break;case"mid":this.parseMid(L);break;case"msid":this.parseMsid(L);break;case"imageattr":this.parseImageAttr(L);break;case"rid":this.parseRid(L);break;case"simulcast":this.parseSimulcast(L);break;case"sctp-port":this.parseSctpPort(L);break;case"max-message-size":this.parseMaxMessageSize(L);break;case"ssrc-group":this.parseSSRCGroup(L);break;default:L.ignored=!0,this.attributes.unrecognized.push(L)}}catch(k){throw console.error("parsing media attribute ".concat(L.attField,' error, "a=').concat(L.attField,":").concat(L.attValue,'"')),k}if(!L.ignored&&L.attValue&&!this.atEnd(L))throw new Error("attribute parsing error")}parseCandidate(L){const k=this.extractOneOrMore(L,E,[1,32]);this.consumeAttributeSpace(L);const M=this.extractOneOrMore(L,a,[1,5]);this.consumeAttributeSpace(L);const U=this.extract(L,this.consumeToken);this.consumeAttributeSpace(L);const x=this.extractOneOrMore(L,a,[1,10]);this.consumeAttributeSpace(L);const F=this.extract(L,this.consumeAddress);this.consumeAttributeSpace(L);const j=this.extract(L,this.consumePort);this.consumeAttributeSpace(L),this.extract(L,this.consume,"typ"),this.consumeAttributeSpace(L);const z={foundation:k,componentId:M,transport:U,priority:x,connectionAddress:F,port:j,type:this.extract(L,this.consumeToken),extension:{}};for(this.peek(L," raddr")&&(this.extract(L,this.consume," raddr"),this.consumeAttributeSpace(L),z.relAddr=this.extract(L,this.consumeAddress)),this.peek(L," rport")&&(this.extract(L,this.consume," rport"),this.consumeAttributeSpace(L),z.relPort=this.extract(L,this.consumePort));this.peekChar(L)===V;){this.consumeAttributeSpace(L);const k=this.extract(L,this.consumeToken);this.consumeAttributeSpace(L),z.extension[k]=this.extractOneOrMore(L,c)}this.attributes.candidates.push(z)}parseRemoteCandidate(L){const k=[];for(;;){const M=this.extractOneOrMore(L,a,[1,5]);this.consumeAttributeSpace(L);const U=this.extract(L,this.consumeAddress);this.consumeAttributeSpace(L);const x=this.extract(L,this.consumePort);k.push({componentId:M,connectionAddress:U,port:x});try{this.consumeAttributeSpace(L)}catch(L){break}}this.attributes.remoteCandidatesList.push(k)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(L){const k=this.extract(L,this.consumeToken);this.consumeAttributeSpace(L);const M=this.extract(L,this.consumeTill,"/");this.extract(L,this.consume,"/");const U={encodingName:M,clockRate:this.extractOneOrMore(L,a)};this.atEnd(L)||"/"!==this.peekChar(L)||(this.extract(L,this.consume,"/"),U.encodingParameters=parseInt(this.extract(L,this.consumeTill),10));const x=this.attributes.payloads.find((L=>L.payloadType===parseInt(k,10)));x?x.rtpMap=U:this.attributes.payloads.push({payloadType:parseInt(k,10),rtpMap:U,rtcpFeedbacks:[]})}parsePtime(L){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(L,this.consumeTill)}parseMaxPtime(L){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(L,this.consumeTill)}parseDirection(L){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=L.attField}parseSSRC(L){const k=this.extractOneOrMore(L,a);this.consumeAttributeSpace(L);const M=this.extract(L,this.consumeTill,":");let U;":"===this.peekChar(L)&&(this.extract(L,this.consume,":"),U=this.extract(L,this.consumeTill));const x=this.attributes.ssrcs.find((L=>L.ssrcId===parseInt(k,10)));x?x.attributes[M]=U:this.attributes.ssrcs.push({ssrcId:parseInt(k,10),attributes:{[M]:U}})}parseFmtp(L){const k=this.extract(L,this.consumeTill,V);this.consumeAttributeSpace(L);const M=this.extract(L,this.consumeTill),U={};M.split(";").forEach((L=>{let[k,M]=L.split("=");k=l_(k).call(k);const x="string"==typeof M?l_(M).call(M):null;"string"==typeof k&&k.length>0&&(U[k]=x)}));const x=this.attributes.payloads.find((L=>L.payloadType===parseInt(k,10)));x?x.fmtp={parameters:U}:this.attributes.payloads.push({payloadType:parseInt(k,10),rtcpFeedbacks:[],fmtp:{parameters:U}})}parseFmtParameters(L){const k={},M=this.extract(L,this.consumeTill,"=");L._cur++;const U=this.extract(L,this.consumeTill,";");for(k[M]=U;";"===L.attValue[L._cur];){const M=this.extract(L,this.consumeTill,"=");L._cur++;const U=this.extract(L,this.consumeTill,";");k[M]=U}return k}parseRtcpFb(L){let k="";k="*"===this.peekChar(L)?this.extract(L,this.consume,"*"):this.extract(L,this.consumeTill,V),this.consumeAttributeSpace(L);const M=this.extract(L,this.consumeTill,V);let U;if("trr-int"===M)U={type:M,interval:this.extract(L,this.consumeTill)};else{const k={type:M};this.peekChar(L)===V&&(this.consumeAttributeSpace(L),k.parameter=this.extract(L,this.consumeToken),this.peekChar(L)===V&&(k.additional=this.extract(L,this.consumeTill))),U=k}if("*"===k)this.attributes.rtcpFeedbackWildcards.push(U);else{const L=this.attributes.payloads.find((L=>L.payloadType===parseInt(k,10)));L?L.rtcpFeedbacks.push(U):this.attributes.payloads.push({payloadType:parseInt(k,10),rtcpFeedbacks:[U]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(L){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const k={port:this.extract(L,this.consumePort)};this.peekChar(L)===V&&(this.consumeAttributeSpace(L),k.netType=this.extractOneOrMore(L,l),this.consumeAttributeSpace(L),k.addressType=this.extractOneOrMore(L,l),this.consumeAttributeSpace(L),k.address=this.extract(L,this.consumeAddress)),this.attributes.rtcp=k}parseMsid(L){const k={id:this.extractOneOrMore(L,l,[1,64])};this.peekChar(L)===V&&(this.consumeAttributeSpace(L),k.appdata=this.extractOneOrMore(L,l,[1,64])),this.attributes.msids.push(k)}parseImageAttr(L){this.attributes.imageattr.push(L.attValue)}parseRid(L){const k=this.extractOneOrMore(L,(L=>h(L)||a(L)||"_"===L||"-"===L));this.consumeAttributeSpace(L);const M={id:k,direction:this.extract(L,this.consumeToken),params:[]};if(this.peekChar(L)===V){if(this.consumeAttributeSpace(L),this.peek(L,"pt=")){this.extract(L,this.consume,"pt=");const k=[];for(;;){const M=this.extract(L,this.consumeToken);k.push(M);try{this.extract(L,this.consume,",")}catch(L){break}}M.payloads=k,this.peekChar(L)===V&&this.extract(L,this.consume,V)}for(;;){const k=this.extract(L,this.consumeToken);switch(k){case"depend":{const U={type:k,rids:this.extract(L,this.consume,"=").split(",")};M.params.push(U);break}default:{const U={type:k};"="===this.peekChar(L)&&(this.extract(L,this.consume,"="),U.val=this.extract(L,this.consumeTill,";")),M.params.push(U)}}try{this.extract(L,this.consume,";")}catch(L){break}}}this.attributes.rids.push(M)}parseSimulcast(L){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=L.attValue,this.extract(L,this.consumeTill)}parseSctpPort(L){this.attributes.sctpPort=this.extractOneOrMore(L,a,[1,5])}parseMaxMessageSize(L){this.attributes.maxMessageSize=this.extractOneOrMore(L,a,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(L){this.attributes.mid=this.extract(L,this.consumeToken)}parseSSRCGroup(L){const k=this.extract(L,this.consumeToken),M=[];for(;;)try{this.consumeAttributeSpace(L);const k=this.extract(L,this.consumeInteger);M.push(parseInt(k,10))}catch(L){break}this.attributes.ssrcGroups.push({semantic:k,ssrcIds:M})}}function A(L,k,M){return k in L?Object.defineProperty(L,k,{value:M,enumerable:!0,configurable:!0,writable:!0}):L[k]=M,L}class b{constructor(){A(this,"eol",x)}print(L,k){let M="";return k&&(this.eol=k),M+=this.printVersion(L.version),M+=this.printOrigin(L.origin),M+=this.printSessionName(L.sessionName),M+=this.printInformation(L.information),M+=this.printUri(L.uri),M+=this.printEmail(L.emails),M+=this.printPhone(L.phones),M+=this.printConnection(L.connection),M+=this.printBandwidth(L.bandwidths),M+=this.printTimeFields(L.timeFields),M+=this.printKey(L.key),M+=this.printSessionAttributes(L.attributes),M+=this.printMediaDescription(L.mediaDescriptions),M}printVersion(L){return"v=".concat(L).concat(this.eol)}printOrigin(L){return"o=".concat(L.username," ").concat(L.sessId," ").concat(L.sessVersion," ").concat(L.nettype," ").concat(L.addrtype," ").concat(L.unicastAddress).concat(this.eol)}printSessionName(L){return L?"s=".concat(L).concat(this.eol):""}printInformation(L){return L?"i=".concat(L).concat(this.eol):""}printUri(L){return L?"u=".concat(L).concat(this.eol):""}printEmail(L){let k="";for(const M of L)k+="e=".concat(M).concat(this.eol);return k}printPhone(L){let k="";for(const M of L)k+="e=".concat(M).concat(this.eol);return k}printConnection(L){return L?"c=".concat(L.nettype," ").concat(L.addrtype," ").concat(L.address).concat(this.eol):""}printBandwidth(L){let k="";for(const M of L)k+="b=".concat(M.bwtype,":").concat(M.bandwidth).concat(this.eol);return k}printTimeFields(L){let k="";for(const M of L){k+="t=".concat(M.time.startTime," ").concat(M.time.startTime).concat(this.eol);for(const L of M.repeats)k+="r=".concat(L.repeatInterval," ").concat(L.typedTimes.join(" ")).concat(this.eol);M.zoneAdjustments&&(k+="z=",k+="z=".concat(M.zoneAdjustments.map((L=>"".concat(L.time," ").concat(L.back?"-":""," ").concat(L.typedTime))).join(" ")).concat(this.eol),k+=this.eol)}return k}printKey(L){return L?"k=".concat(L).concat(this.eol):""}printAttributes(L){let k="";for(const M of L)k+="a=".concat(M.attField).concat(M.attValue?":".concat(M.attValue):"").concat(this.eol);return k}printMediaDescription(L){let k="";for(const M of L)k+=this.printMedia(M.media),k+=this.printInformation(M.information),k+=this.printConnections(M.connections),k+=this.printBandwidth(M.bandwidths),k+=this.printKey(M.key),k+=this.printMediaAttributes(M);return k}printConnections(L){let k="";for(const M of L)k+=this.printConnection(M);return k}printMedia(L){return"m=".concat(L.mediaType," ").concat(L.port," ").concat(L.protos.join("/")," ").concat(L.fmts.join(" ")).concat(this.eol)}printSessionAttributes(L){return new O(this.eol).print(L)}printMediaAttributes(L){return new N(this.eol).print(L)}}class w{constructor(L){A(this,"eol",void 0),this.eol=L}printIceUfrag(L){return void 0===L?"":"a=ice-ufrag:".concat(L).concat(this.eol)}printIcePwd(L){return void 0===L?"":"a=ice-pwd:".concat(L).concat(this.eol)}printIceOptions(L){return void 0===L?"":"a=ice-options:".concat(L.join(V)).concat(this.eol)}printFingerprints(L){return L.length>0?L.map((L=>"a=fingerprint:".concat(L.hashFunction).concat(V).concat(L.fingerprint))).join(this.eol)+this.eol:""}printExtmap(L){return L.map((L=>"a=extmap:".concat(L.entry).concat(L.direction?"/".concat(L.direction):"").concat(V).concat(L.extensionName).concat(L.extensionAttributes?"".concat(V).concat(L.extensionAttributes):"").concat(this.eol))).join("")}printSetup(L){return void 0===L?"":"a=setup:".concat(L).concat(this.eol)}printUnrecognized(L){return L.map((L=>"a=".concat(L.attField).concat(L.attValue?":".concat(L.attValue):"").concat(this.eol))).join("")}}class O extends w{print(L){let k="";return k+=this.printGroups(L.groups),k+=this.printMsidSemantic(L.msidSemantic),k+=this.printIceLite(L.iceLite),k+=this.printIceUfrag(L.iceUfrag),k+=this.printIcePwd(L.icePwd),k+=this.printIceOptions(L.iceOptions),k+=this.printFingerprints(L.fingerprints),k+=this.printSetup(L.setup),k+=this.printTlsId(L.tlsId),k+=this.printIdentity(L.identities),k+=this.printExtmap(L.extmaps),k+=this.printUnrecognized(L.unrecognized),k}printGroups(L){let k="";return L.length>0&&(k+=L.map((L=>"a=group:".concat(L.semantic).concat(L.identificationTag.map((L=>"".concat(V).concat(L))).join("")).concat(this.eol))).join("")),k}printIceLite(L){return void 0===L?"":"a=ice-lite"+this.eol}printTlsId(L){return L?"a=tls-id:".concat(L).concat(this.eol):""}printIdentity(L){return 0===L.length?"":L.map((L=>"a=identity:".concat(L.assertionValue).concat(L.extensions.map((L=>"".concat(V).concat(L.name).concat(L.value?"=".concat(L.value):"")))))).join(this.eol)+this.eol}printMsidSemantic(L){if(!L)return"";let k="a=msid-semantic:".concat(L.semantic);return L.applyForAll?k+="".concat(V,"*"):L.identifierList.length>0&&(k+=L.identifierList.map((L=>"".concat(V).concat(L)))),k+this.eol}}class N extends w{print(L){const k=L.attributes;let M="";return M+=this.printRTCP(k.rtcp),M+=this.printIceUfrag(k.iceUfrag),M+=this.printIcePwd(k.icePwd),M+=this.printIceOptions(k.iceOptions),M+=this.printCandidates(k.candidates),M+=this.printRemoteCandidatesList(k.remoteCandidatesList),M+=this.printEndOfCandidates(k.endOfCandidates),M+=this.printFingerprints(k.fingerprints),M+=this.printSetup(k.setup),M+=this.printMid(k.mid),M+=this.printExtmap(k.extmaps),M+=this.printRTPRelated(k),M+=this.printPtime(k.ptime),M+=this.printMaxPtime(k.maxPtime),M+=this.printDirection(k.direction),M+=this.printSSRCGroups(k.ssrcGroups),M+=this.printSSRC(k.ssrcs),M+=this.printRTCPMux(k.rtcpMux),M+=this.printRTCPMuxOnly(k.rtcpMuxOnly),M+=this.printRTCPRsize(k.rtcpRsize),M+=this.printMSId(k.msids),M+=this.printImageattr(k.imageattr),M+=this.printRid(k.rids),M+=this.printSimulcast(k.simulcast),M+=this.printSCTPPort(k.sctpPort),M+=this.printMaxMessageSize(k.maxMessageSize),M+=this.printUnrecognized(k.unrecognized),M}printCandidates(L){return L.map((L=>"a=candidate:".concat(L.foundation).concat(V).concat(L.componentId).concat(V).concat(L.transport).concat(V).concat(L.priority).concat(V).concat(L.connectionAddress).concat(V).concat(L.port).concat(V,"typ").concat(V).concat(L.type).concat(L.relAddr?"".concat(V,"raddr").concat(V).concat(L.relAddr):"").concat(L.relPort?"".concat(V,"rport").concat(V).concat(L.relPort):"").concat(Object.keys(L.extension).map((k=>"".concat(V).concat(k).concat(V).concat(L.extension[k]))).join("")).concat(this.eol))).join("")}printRemoteCandidatesList(L){return L.map((L=>"a=remote-candidates:".concat(L.join(V)).concat(this.eol))).join("")}printEndOfCandidates(L){return void 0===L?"":"a=end-of-candidates"+this.eol}printRTPRelated(L){if(!L.payloads)return"";const k=L.payloads;let M="";M+=L.rtcpFeedbackWildcards.map((L=>this.printRTCPFeedback("*",L))).join("");for(const L of k)M+=this.printRtpMap(L.payloadType,L.rtpMap),M+=this.printFmtp(L.payloadType,L.fmtp),M+=L.rtcpFeedbacks.map((k=>this.printRTCPFeedback(L.payloadType,k))).join("");return M}printFmtp(L,k){if(!k)return"";const M=Object.keys(k.parameters);return 1===M.length&&null===k.parameters[M[0]]?"a=fmtp:".concat(L).concat(V).concat(M[0]).concat(this.eol):"a=fmtp:".concat(L).concat(V).concat(Object.keys(k.parameters).map((L=>"".concat(L,"=").concat(k.parameters[L]))).join(";")).concat(this.eol)}printRtpMap(L,k){return k?"a=rtpmap:".concat(L).concat(V).concat(k.encodingName,"/").concat(k.clockRate).concat(k.encodingParameters?"/".concat(k.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(L,k){let M="a=rtcp-fb:".concat(L).concat(V),U=k;return"trr-int"===U.type?M+="ttr-int".concat(V).concat(U.interval):(M+="".concat(U.type),U.parameter&&(M+="".concat(V).concat(U.parameter),U.additional&&(M+="".concat(V).concat(U.additional)))),M+this.eol}printPtime(L){return void 0===L?"":"a=ptime:".concat(L).concat(this.eol)}printMaxPtime(L){return void 0===L?"":"a=maxptime:".concat(L).concat(this.eol)}printDirection(L){return void 0===L?"":"a=".concat(L).concat(this.eol)}printSSRC(L){return L.map((L=>Object.keys(L.attributes).map((k=>"a=ssrc:".concat(L.ssrcId.toString(10)).concat(V).concat(k).concat(L.attributes[k]?":".concat(L.attributes[k]):"").concat(this.eol))).join(""))).join("")}printRTCPMux(L){return void 0===L?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(L){return void 0===L?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(L){return void 0===L?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(L){if(void 0===L)return"";let k="a=rtcp:".concat(L.port);return L.netType&&(k+="".concat(V).concat(L.netType)),L.addressType&&(k+="".concat(V).concat(L.addressType)),L.address&&(k+="".concat(V).concat(L.address)),k+this.eol}printMSId(L){return L.map((L=>"a=msid:".concat(L.id).concat(L.appdata?"".concat(V).concat(L.appdata):"").concat(this.eol))).join("")}printImageattr(L){return L.map((L=>"a=imageattr:".concat(L).concat(this.eol))).join("")}printRid(L){return L.map((L=>{let k="a=rid:".concat(L.id).concat(V).concat(L.direction);return L.payloads&&(k+="".concat(V,"pt=").concat(L.payloads.join(","))),L.params.length>0&&(k+="".concat(V).concat(L.params.map((L=>"depend"===L.type?"depend=".concat(L.rids.join(",")):"".concat(L.type,"=").concat(L.val))).join(";"))),k+this.eol})).join("")}printSimulcast(L){return void 0===L?"":"a=simulcast:".concat(L).concat(this.eol)}printSCTPPort(L){return void 0===L?"":"a=sctp-port:".concat(L).concat(this.eol)}printMaxMessageSize(L){return void 0===L?"":"a=max-message-size:".concat(L).concat(this.eol)}printMid(L){return void 0===L?"":"a=mid:".concat(L).concat(this.eol)}printSSRCGroups(L){return L.map((L=>"a=ssrc-group:".concat(L.semantic).concat(L.ssrcIds.map((L=>"".concat(V).concat(L.toString(10)))).join("")).concat(this.eol))).join("")}}function D(L){return(new C).parse(L)}function P(L,k){return(new b).print(L,k)}}},k={};function i(M){if(k[M])return k[M].exports;var U=k[M]={exports:{}};return L[M](U,U.exports,i),U.exports}return i.d=(L,k)=>{for(var M in k)i.o(k,M)&&!i.o(L,M)&&Object.defineProperty(L,M,{enumerable:!0,get:k[M]})},i.o=(L,k)=>Object.prototype.hasOwnProperty.call(L,k),i.r=L=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(L,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(L,"__esModule",{value:!0})},i(8)})()}(CU);var wU=CU.exports;function VU(){let L=arguments.length>0&&void 0!==arguments[0]?arguments[0]:zA("SVC_MODE");if(zA("ENABLE_SVC"))return function(L){return L in Tw}(L)?L:Tw.L1T3}function FU(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function BU(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?FU(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):FU(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}function jU(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},M=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},U=arguments.length>3?arguments[3]:void 0;const{filterRTX:x,filterVideoFec:V,filterAudioFec:F,filterAudioCodec:j,filterVideoCodec:z}=k,{useXR:Q}=M;let $=[],ee=[],te=[],ie=[],ne=!1,re=!1;if(wU.parse(L).mediaDescriptions.forEach((L=>{U&&U!==L.attributes.direction||("video"!==L.media.mediaType||ne||(ee=L.attributes.payloads,ie=L.attributes.extmaps,ne=!0),"audio"!==L.media.mediaType||re||($=L.attributes.payloads,te=L.attributes.extmaps,re=!0))})),!ie||0===ee.length)throw new Error("Cannot get video capabilities from SDP.");if(!te||0===$.length)throw new Error("Cannot get audio capabilities from SDP.");if(ee.forEach((L=>{var k;null!==(k=L.rtpMap)&&void 0!==k&&k.clockRate&&(L.rtpMap.clockRate=parseInt(L.rtpMap.clockRate)),Q&&L.rtcpFeedbacks.push({type:"rrtr"})})),$.forEach((L=>{var k;null!==(k=L.rtpMap)&&void 0!==k&&k.clockRate&&(L.rtpMap.clockRate=parseInt(L.rtpMap.clockRate)),Q&&L.rtcpFeedbacks.push({type:"rrtr"})})),x&&($=$.filter((L=>{var k;return"rtx"!==(null===(k=L.rtpMap)||void 0===k?void 0:k.encodingName.toLowerCase())})),ee=ee.filter((L=>{var k;return"rtx"!==(null===(k=L.rtpMap)||void 0===k?void 0:k.encodingName.toLowerCase())}))),V&&(ee=ee.filter((L=>{var k;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(k=L.rtpMap)||void 0===k?void 0:k.encodingName)||"")}))),F&&($=$.filter((L=>{var k;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(k=L.rtpMap)||void 0===k?void 0:k.encodingName)||"")}))),j&&(null==j?void 0:j.length)>0&&($=$.filter((L=>{var k;return Sr(j).call(j,(null===(k=L.rtpMap)||void 0===k?void 0:k.encodingName.toLowerCase())||"")}))),z&&(null==z?void 0:z.length)>0){const L=ee.filter((L=>{var k;return Sr(z).call(z,(null===(k=L.rtpMap)||void 0===k?void 0:k.encodingName.toLowerCase())||"")}));ee=L.concat(x?[]:ox(L,ee))}const oe=zA("UNSUPPORTED_VIDEO_CODEC");return oe&&oe.length>0&&(ee=ee.filter((L=>!(L.rtpMap&&Sr(oe).call(oe,L.rtpMap.encodingName.toLowerCase()))))),{audioCodecs:$,videoCodecs:ee,audioExtensions:te,videoExtensions:ie}}function GU(L){const k=wU.parse(L);let M,U;for(const L of k.mediaDescriptions){if(!M){const k=L.attributes.iceUfrag,U=L.attributes.icePwd;if(!k||!U)throw new Error("Cannot get iceUfrag or icePwd from SDP.");M={iceUfrag:k,icePwd:U}}if(!U){const k=L.attributes.fingerprints;k.length>0&&(U={fingerprints:k})}}if(!U&&k.attributes.fingerprints.length>0&&(U={fingerprints:k.attributes.fingerprints}),!U||!M)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:M,dtlsParameters:U}}function WU(L,k){const M=[],U=L.attributes.ssrcGroups.filter((L=>"FID"===L.semantic)),x=L.attributes.ssrcGroups.find((L=>"SIM"===L.semantic)),V=L.attributes.ssrcs;if(x)x.ssrcIds.forEach((L=>{var x;const V=null===(x=U.find((k=>k.ssrcIds[0]===L)))||void 0===x?void 0:x.ssrcIds[1];M.push({ssrcId:L,rtx:k?V:void 0})}));else if(U.length>0){const L=U[0].ssrcIds[0],x=U[0].ssrcIds[1];M.push({ssrcId:L,rtx:k?x:void 0})}else{if(0===V.length)throw new Error("No ssrcs found on local media description.");M.push({ssrcId:V[0].ssrcId})}return M}function HU(L,k,M){const{cname:U}=L;let x=[];k&&(x=KU(k)),0===x.length&&(x=L.iceParameters.candidates.map((L=>({foundation:L.foundation,componentId:"1",transport:L.protocol,priority:L.priority.toString(),connectionAddress:L.ip,port:L.port.toString(),type:L.type,extension:{}}))),Eb.debug("Using candidates from gateway."));const V={fingerprints:L.dtlsParameters.fingerprints.map((L=>({hashFunction:L.algorithm,fingerprint:L.fingerprint})))},F={iceUfrag:L.iceParameters.iceUfrag,icePwd:L.iceParameters.icePwd};let j;switch(L.dtlsParameters.role){case"server":j="passive";break;case"client":j="active";break;case"auto":j="actpass"}const z=ix(L.rtpCapabilities),Q=[];return Array.isArray(M)&&M.length>0&&M.forEach((L=>{Q.push({kind:nO.VIDEO,ssrcId:L.v,rtx:L.v_rtx,mslabel:"".concat(L.v,"_").concat(L.a)},{kind:nO.AUDIO,ssrcId:L.a,mslabel:"".concat(L.v,"_").concat(L.a)})})),{dtlsParameters:V,iceParameters:F,candidates:x,rtpCapabilities:z,setup:j,cname:U,preSSRCs:Q}}function KU(L){let k=[];return L.ip&&"number"==typeof L.port&&(k=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:L.ip,port:L.port.toString(),type:"host",extension:{}}],Eb.debug("Using remote candidate from AP ".concat(L.ip,":").concat(L.port)),L.ip6&&(k.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:L.ip6,port:L.port.toString(),type:"host",extension:{}}),Eb.debug("Using IPV6 remote candidate from AP ".concat(L.ip6,":").concat(L.port)))),k}function YU(L,k,M){const U=[],x=[];return L.forEach((L=>{let{ssrcId:V,rtx:F}=L;const j=fA(8,"track-"),z={ssrcId:V,attributes:BU({label:j,mslabel:M=M||fA(10,""),msid:"".concat(M," ").concat(j)},k&&{cname:k})};if(U.push(z),void 0!==F){const L={ssrcId:F,attributes:BU({label:j,mslabel:M,msid:"".concat(M," ").concat(j)},k&&{cname:k})};U.push(L),x.push({semantic:"FID",ssrcIds:[V,F]})}})),L.length>1&&x.push({semantic:"SIM",ssrcIds:L.map((L=>{let{ssrcId:k}=L;return k}))}),{ssrcs:U,ssrcGroups:x}}function qU(L,k){k instanceof uM&&L.attributes.payloads.forEach((L=>{var M;const U=null===(M=L.rtpMap)||void 0===M?void 0:M.encodingName.toLowerCase();if(!U||-1===["opus","pcmu","pcma","g722"].indexOf(U))return;L.fmtp||(L.fmtp={parameters:{}}),L.fmtp.parameters.minptime="10",L.fmtp.parameters.useinbandfec="1";const x=k._encoderConfig;x&&"pcmu"!==U&&"pcma"!==U&&"g722"!==U&&(x.bitrate&&!Xv()&&(L.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*x.bitrate))),x.sampleRate&&(L.fmtp.parameters.maxplaybackrate="".concat(x.sampleRate),L.fmtp.parameters["sprop-maxcapturerate"]="".concat(x.sampleRate)),x.stereo&&(L.fmtp.parameters.stereo="1",L.fmtp.parameters["sprop-stereo"]="1"))}))}function zU(L){const k=L.attributes.unrecognized.findIndex((L=>"x-google-flag"===L.attField&&"conference"===L.attValue));-1!==k&&L.attributes.unrecognized.splice(k,1)}function JU(L,k){var M;if(!(k instanceof eU&&k._encoderConfig&&-1===k._hints.indexOf(sL.SCREEN_TRACK)))return;const U=k._encoderConfig;XP().supportMinBitrate&&U.bitrateMin&&L.attributes.payloads.forEach((L=>{var k,M;Sr(k=["h264","h265","vp8","vp9","av1"]).call(k,(null===(M=L.rtpMap)||void 0===M?void 0:M.encodingName.toLowerCase())||"")&&(L.fmtp||(L.fmtp={parameters:{}}),L.fmtp.parameters["x-google-min-bitrate"]="".concat(U.bitrateMin))})),XP().supportMinBitrate&&!Sr(M=k._hints).call(M,sL.LOW_STREAM)&&U.bitrateMax&&L.attributes.payloads.forEach((L=>{var k,M;Sr(k=["h264","h265","vp8","vp9","av1"]).call(k,(null===(M=L.rtpMap)||void 0===M?void 0:M.encodingName.toLowerCase())||"")&&(L.fmtp||(L.fmtp={parameters:{}}),L.fmtp.parameters["x-google-start-bitrate"]="".concat(zA("X_GOOGLE_START_BITRATE")||Math.floor(U.bitrateMax)))}))}function XU(L){if("video"!==L.media.mediaType)return;const k=Gv();if(k.name!==JC.SAFARI&&k.os!==XC.IOS)return;const M=L.attributes.extmaps.findIndex((L=>/video-orientation/g.test(L.extensionName)));-1!==M&&L.attributes.extmaps.splice(M,1)}function QU(L,k,M){if(!k)return;let U,x;if("video"===L.media.mediaType?(U=M.videoExtensions,x=M.videoCodecs):(U=M.audioExtensions,x=M.audioCodecs),!0===k.twcc){const k=U.find((L=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===L.extensionName));if(k){L.attributes.extmaps.find((L=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===L.extensionName))||L.attributes.extmaps.push({entry:k.entry,extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"});const M=function(L,k){return k.filter((k=>!!L.find((L=>L.payloadType===k.payloadType&&!!L.rtcpFeedbacks.find((L=>"transport-cc"===L.type))))))}(x,L.attributes.payloads);M.forEach((L=>{L.rtcpFeedbacks.find((L=>"transport-cc"===L.type))||L.rtcpFeedbacks.push({type:"transport-cc"})}))}}else if(!1===k.twcc){const k=L.attributes.extmaps.findIndex((L=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===L.extensionName));-1!==k&&L.attributes.extmaps.splice(k,1),L.attributes.payloads.forEach((L=>{const k=L.rtcpFeedbacks.findIndex((L=>"transport-cc"===L.type));-1!==k&&L.rtcpFeedbacks.splice(k,1)}))}if(!0===k.remb){const k=U.find((L=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===L.extensionName));if(k){L.attributes.extmaps.find((L=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===L.extensionName))||L.attributes.extmaps.push({entry:k.entry,extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"});const M=function(L,k){return k.filter((k=>!!L.find((L=>L.payloadType===k.payloadType&&!!L.rtcpFeedbacks.find((L=>"goog-remb"===L.type))))))}(x,L.attributes.payloads);M.forEach((L=>{L.rtcpFeedbacks.find((L=>"goog-remb"===L.type))||L.rtcpFeedbacks.push({type:"goog-remb"})}))}}else if(!1===k.remb){const k=L.attributes.extmaps.findIndex((L=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===L.extensionName));-1!==k&&L.attributes.extmaps.splice(k,1),L.attributes.payloads.forEach((L=>{const k=L.rtcpFeedbacks.findIndex((L=>"goog-remb"===L.type));-1!==k&&L.rtcpFeedbacks.splice(k,1)}))}}function ZU(L,k,M){if(Xv())return;if("video"!==L.media.mediaType)return;if(!(k instanceof eU))return;if("vp9"!==M&&"vp8"!==M)return;if("vp8"===M&&!zA("SIMULCAST"))return;if("vp9"===M&&zA("ENABLE_SVC"))return;if(void 0===k._scalabilityMode||k._scalabilityMode.numSpatialLayers<=1)return;const U="vp8"===M?2:k._scalabilityMode.numSpatialLayers,x=L.attributes.ssrcs[0],V=L.attributes.ssrcGroups.find((L=>"FID"===L.semantic&&L.ssrcIds[0]===x.ssrcId)),F={semantic:"SIM",ssrcIds:[x.ssrcId]};for(let k=1;k<U;k++)L.attributes.ssrcs.push({ssrcId:x.ssrcId+k,attributes:rA(x.attributes)}),F.ssrcIds.push(x.ssrcId+k),V&&(L.attributes.ssrcs.push({ssrcId:V.ssrcIds[1]+k,attributes:rA(x.attributes)}),L.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[x.ssrcId+k,V.ssrcIds[1]+k]}));L.attributes.ssrcGroups.unshift(F)}async function $U(){let L=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const M=new RTCPeerConnection;M.addTransceiver("video",{direction:"sendonly"}),M.addTransceiver("audio",{direction:"sendonly"}),M.addTransceiver("video",{direction:"recvonly"}),M.addTransceiver("audio",{direction:"recvonly"});const U=(await M.createOffer()).sdp,{send:x,recv:V,sendrecv:F}=function(){let L=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},M=arguments.length>2?arguments[2]:void 0;const U=jU(M,L,k,"sendonly"),x=jU(M,L,k,"recvonly"),V={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},F={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},j={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(tx(U,x,"videoExtensions",V,F,j),tx(U,x,"videoCodecs",V,F,j),tx(U,x,"audioExtensions",V,F,j),tx(U,x,"audioCodecs",V,F,j),zA("RAISE_H264_BASELINE_PRIORITY")){const L=j.videoCodecs.findIndex((L=>{var k,M;return"h264"===(null===(k=L.rtpMap)||void 0===k?void 0:k.encodingName.toLocaleLowerCase())&&"42001f"===(null===(M=L.fmtp)||void 0===M?void 0:M.parameters["profile-level-id"])}));if(-1!==L){const k=j.videoCodecs.findIndex((L=>{var k;return"h264"===(null===(k=L.rtpMap)||void 0===k?void 0:k.encodingName.toLocaleLowerCase())}));if(k<L){Eb.debug("raising H264 baseline profile priority");const M=j.videoCodecs[L];j.videoCodecs.splice(L,1),j.videoCodecs.splice(k,0,M)}-1!==k&&(F.videoCodecs=F.videoCodecs.filter((L=>{var k,M;return!("h264"===(null===(k=L.rtpMap)||void 0===k?void 0:k.encodingName.toLocaleLowerCase())&&"42001f"!==(null===(M=L.fmtp)||void 0===M?void 0:M.parameters["profile-level-id"]))}))),-1!==k&&zA("FILTER_SEND_H264_BASELINE")&&(V.videoCodecs=V.videoCodecs.filter((L=>{var k,M;return!("h264"===(null===(k=L.rtpMap)||void 0===k?void 0:k.encodingName.toLocaleLowerCase())&&"42001f"!==(null===(M=L.fmtp)||void 0===M?void 0:M.parameters["profile-level-id"]))})))}}return{send:V,recv:F,sendrecv:j}}(L,k,U);try{M.close()}catch(L){}return{send:x,recv:V,sendrecv:F}}function ex(){const L={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},k=jU(arguments.length>2?arguments[2]:void 0,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},"recvonly"),M={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},U={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},x={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(tx(L,k,"videoExtensions",M,U,x),tx(L,k,"videoCodecs",M,U,x),tx(L,k,"audioExtensions",M,U,x),tx(L,k,"audioCodecs",M,U,x),zA("RAISE_H264_BASELINE_PRIORITY")){const L=x.videoCodecs.findIndex((L=>L.rtpMap&&"h264"===L.rtpMap.encodingName.toLocaleLowerCase()&&L.fmtp&&"42001f"===L.fmtp.parameters["profile-level-id"]));if(-1!==L){const k=x.videoCodecs.findIndex((L=>L.rtpMap&&"h264"===L.rtpMap.encodingName.toLocaleLowerCase()));if(k<L){Eb.debug("raising H264 baseline profile priority");const M=x.videoCodecs[L];x.videoCodecs.splice(L,1),x.videoCodecs.splice(k,0,M)}-1!==k&&(U.videoCodecs=U.videoCodecs.filter((L=>!(L.rtpMap&&"h264"===L.rtpMap.encodingName.toLocaleLowerCase()&&L.fmtp&&"42001f"!==L.fmtp.parameters["profile-level-id"]))))}}return{send:M,recv:U,sendrecv:x}}function tx(L,k,M,U,x,V){if("videoExtensions"===M||"audioExtensions"===M){const F=[];return L[M].forEach((L=>{k[M].some(((k,M)=>{if(L.entry===k.entry&&L.extensionName===k.extensionName)return F.push(M),!0}))?V[M].push(L):U[M].push(L)})),void k[M].forEach(((L,k)=>{-1===F.indexOf(k)&&x[M].push(L)}))}if("videoCodecs"===M||"audioCodecs"===M){const F=[];return L[M].forEach((L=>{k[M].some(((k,M)=>{if(L.payloadType===k.payloadType&&JSON.stringify(L)===JSON.stringify(k))return F.push(M),!0}))?V[M].push(L):U[M].push(L)})),void k[M].forEach(((L,k)=>{-1===F.indexOf(k)&&x[M].push(L)}))}}function ix(L){const{send:k,recv:M,sendrecv:U}=L;if(!U){if(!k||!M)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:k,recv:M}}let x,V;return k?(x={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},x.audioCodecs=[...k.audioCodecs,...U.audioCodecs],x.videoCodecs=[...k.videoCodecs,...U.videoCodecs],x.audioExtensions=[...k.audioExtensions,...U.audioExtensions],x.videoExtensions=[...k.videoExtensions,...U.videoExtensions]):x=U,M?(V={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},V.audioCodecs=[...M.audioCodecs,...U.audioCodecs],V.videoCodecs=[...M.videoCodecs,...U.videoCodecs],V.audioExtensions=[...M.audioExtensions,...U.audioExtensions],V.videoExtensions=[...M.videoExtensions,...U.videoExtensions]):V=U,{send:x,recv:V}}function nx(L){"audio"===L.media.mediaType&&L.attributes.payloads.filter((L=>{var k;return"opus"===(null===(k=L.rtpMap)||void 0===k?void 0:k.encodingName.toLowerCase())})).forEach((L=>{L.fmtp||(L.fmtp={parameters:{}}),L.fmtp.parameters.stereo="1",L.fmtp.parameters["sprop-stereo"]="1"}))}function rx(L,k,M,U){let x=[];if(L===nO.VIDEO){if(zA("H264_PROFILE_LEVEL_ID")&&"h264"===U&&(x=k.videoCodecs.filter((L=>{var k;return Sr(k=L.rtpMap&&L.rtpMap.encodingName.toLowerCase()||"").call(k,U)&&L&&L.fmtp&&L.fmtp.parameters["profile-level-id"]===zA("H264_PROFILE_LEVEL_ID")}))),!Array.isArray(x)||0===x.length){let L=[];const V=[],F=[],j=[];if(M.videoCodecs.forEach((k=>{const M=k.rtpMap&&k.rtpMap.encodingName.toLowerCase()||"";Sr(M).call(M,U)?L.push(k):Sr(M).call(M,"vp9")?V.push(k):Sr(M).call(M,"vp8")?F.push(k):Sr(M).call(M,"h264")&&j.push(k)})),0===L.length){let k="";0!==V.length?(L=V,k="vp9"):0!==F.length?(L=F,k="vp8"):0!==j.length&&(L=j,k="h264"),Eb.warning("codec ".concat(U," not included in rtpCapabilities, fallback to default payloads: ").concat(k))}0!==L.length&&(x=k.videoCodecs.filter((k=>L.some((L=>L.payloadType===k.payloadType)))))}if(0===x.length&&(Eb.warning("codec ".concat(U," not included in rtpCapabilities, fallback to default payloads: ").concat(k.videoCodecs[0].rtpMap&&k.videoCodecs[0].rtpMap.encodingName)),x=k.videoCodecs),zA("USE_PUB_RTX")||zA("USE_SUB_RTX")){const L=ox(x,k.videoCodecs);x=[...x,...L]}}else x=k.audioCodecs.filter((L=>{var k;return Sr(k=L.rtpMap&&L.rtpMap.encodingName.toLowerCase()||"").call(k,U)})),0===x.length&&(Eb.warning("codec ".concat(U," not included in rtpCapabilities, fallback to opus")),x=k.audioCodecs.filter((L=>{var k;return Sr(k=L.rtpMap&&L.rtpMap.encodingName.toLowerCase()||"").call(k,"opus")})));return x}function ox(L,k){const M=L.map((L=>L.payloadType.toString()));return k.filter((L=>L.rtpMap&&"rtx"===L.rtpMap.encodingName&&L.fmtp&&L.fmtp.parameters.apt&&Sr(M).call(M,L.fmtp&&L.fmtp.parameters.apt)))}async function sx(L,k,M){const U=k.toString(),x=cx(U,"offer","remote","exchangeSDP");await L.setRemoteDescription({type:"offer",sdp:U});const V=await L.createAnswer();if(!V.sdp)throw new Error("cannot get answer sdp");let F=V.sdp;F=ax(F,M||{}),null==x||x(F||""),await L.setLocalDescription({type:"answer",sdp:F})}function ax(L,k,M){const U=wU.parse(L),{useXR:x}=k;return U.mediaDescriptions.forEach((L=>{var k;L.attributes.mid&&(Array.isArray(M)&&!Sr(M).call(M,L.attributes.mid)||("audio"===L.media.mediaType&&nx(L),x&&Sr(k=["audio","video"]).call(k,L.media.mediaType)&&L.attributes.payloads.forEach((L=>{-1===L.rtcpFeedbacks.findIndex((L=>"rrtr"===L.type))&&L.rtcpFeedbacks.push({type:"rrtr"})}))))})),wU.print(U)}function cx(L,k,M,U){if(zA("SDP_LOGGING"))return Eb.upload("exchanging ".concat(M," ").concat(k," SDP during P2PConnection.").concat(U,"\n"),L),"offer"===k?L=>{cx(L,"answer","local"===M?"remote":"local",U)}:void 0}function dx(L,k){return typeof zA(L)===k?zA(L):void 0}function lx(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function ux(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?lx(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):lx(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}const OU=new Map;class px extends My{get state(){return this._state}set state(L){if(L===this._state)return;const k=this._state;this._state=L,"DISCONNECTED"===L&&this._disconnectedReason?this.emit(Xw.CONNECTION_STATE_CHANGE,L,k,this._disconnectedReason):this.emit(Xw.CONNECTION_STATE_CHANGE,L,k)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(L){Eb.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(L)),this._joinGatewayStartTime=L}constructor(L,k){super(),xg(this,"store",void 0),xg(this,"joinInfo",void 0),xg(this,"key",void 0),xg(this,"ntpOffset",0),xg(this,"signal",void 0),xg(this,"role",void 0),xg(this,"inChannelInfo",{joinAt:null,duration:0}),xg(this,"spec",void 0),xg(this,"_state","DISCONNECTED"),xg(this,"_statsCollector",void 0),xg(this,"_disconnectedReason",void 0),xg(this,"isSignalRecover",!1),xg(this,"hasChangeBGPAddress",!1),xg(this,"trafficStatsInterval",void 0),xg(this,"networkQualityInterval",void 0),xg(this,"_joinGatewayStartTime",0),xg(this,"_signalTimeout",!1),xg(this,"_clientRoleOptions",void 0),xg(this,"_isProactiveJoin",!1),this.store=L,this.spec=k,this.signal=this.store.useP2P?new MU(ux(ux({},k),{},{retryConfig:k.websocketRetryConfig}),L):new WO(ux(ux({},k),{},{retryConfig:k.websocketRetryConfig}),L),this._statsCollector=k.statsCollector,this.role=k.role||"audience",this._clientRoleOptions=k.clientRoleOptions,this.handleSignalEvents()}async join(L,k,M){this.store.joinGatewayStart(),"disabled"!==L.cloudProxyServer&&(this.hasChangeBGPAddress=!0);const U=Date.now();let x=OU.get(L.cname);if(x||(x=new Map,OU.set(L.cname,x)),this._isProactiveJoin=!0,x.has(L.uid)){const k=new Ib(iv.UID_CONFLICT);throw Ab.joinGateway(L.sid,{lts:U,succ:!1,ec:k.code,addr:null,uid:L.uid,cid:L.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!L.proxyServer,signalChannel:"0",preload:L.preload}),this._isProactiveJoin=!1,k}x.set(L.uid,!0),this.joinInfo=L,this.key=k;let V=0;this.joinGatewayStartTime=U;const F=L.proxyServer;try{Eb.debug("[".concat(this.store.clientId,"] use websocket join uid ").concat(V));const k=L.gatewayAddrs.map((k=>{let{address:M}=k;const[U,x]=M.split(":"),V={host:U,port:x};return L.proxyServer&&(V.proxy=L.proxyServer),V}));V=(await this.signal.init(k,M)).uid,Eb.debug("[".concat(this.store.clientId,"] websocket join uid ").concat(V," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(k){var j;throw Eb.error("[".concat(this.store.clientId,"] User join failed"),k.toString()),Ab.joinGateway(L.sid,{lts:U,succ:!1,ec:(null===(j=k.data)||void 0===j?void 0:j.desc)||k.code,errorMsg:k.message,addr:this.signal.url,uid:L.uid,cid:L.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!F,signalChannel:"0",preload:L.preload}),this._isProactiveJoin=!1,x.delete(L.uid),this.signal.close(),k}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),Eb.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval((()=>{this.updateTrafficStats().catch((L=>{Eb.warning("[".concat(this.store.clientId,"] get traffic stats error"),L.toString())}))}),3e3),this.networkQualityInterval=window.setInterval((()=>{navigator&&void 0!==navigator.onLine&&!navigator.onLine?this.emit(Xw.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(Xw.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):"CONNECTED"===this.state&&this._statsCollector.trafficStats?this.emit(Xw.NETWORK_QUALITY,{uplinkNetworkQuality:QO(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:QO(this._statsCollector.trafficStats.B_dnq)}):this.emit(Xw.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})}),2e3),this.store.joinGatewayEnd(),V}async leave(){let L=arguments.length>0&&void 0!==arguments[0]&&arguments[0],k=arguments.length>1?arguments[1]:void 0;if("DISCONNECTED"!==this.state){k!==hv.FALLBACK&&(this.state="DISCONNECTING");try{L||this.signal.connectionState!==vw.CONNECTED||await function(L,k){return Mp.race([L,_A(3e3)])}(this.signal.request(ww.LEAVE,void 0,!0))}catch(L){Eb.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),L)}this.signal.close(k),k!==hv.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(L,k,M){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Ib(iv.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const U={state:"offer",p2p_id:this.store.p2pId,ortc:k,mode:this.spec.mode,extend:zA("PUB_EXTEND"),twcc:!!zA("PUBLISH_TWCC"),rtx:!!zA("USE_PUB_RTX")};try{return(await this.signal.request(ww.PUBLISH,U,!0))._message}catch(U){if(M&&U.data&&U.data.code===Cw.ERR_PUBLISH_REQUEST_INVALID)return Eb.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),U.toString()),await this.tryUnpubBeforeRepub(L,k),this.publish(L,k,!1);throw U}}async publishDataChannel(L,k,M){var U;if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Ib(iv.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const x={stream_id:k.streamId,ordered:k.ordered?1:0,max_retrans_times:null!==(U=k.maxRetransmits)&&void 0!==U?U:10,channel_id:k.channelId,metadata:k.metadata};try{await this.signal.request(ww.PUBLISH_DATASTREAM,x,!0)}catch(U){if(M&&U.data&&U.data.code===Cw.ERR_PUBLISH_REQUEST_INVALID)return Eb.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),U.toString()),await this.tryUnpubDataChannelBeforeRepub(L,k),this.publishDataChannel(L,k,!1);throw U}}async unpublish(L,k){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Ib(iv.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(ww.UNPUBLISH,{stream_id:k,ortc:L},!0)}catch(L){Eb.warning("[".concat(this.store.clientId,"] unpublish warning: "),L)}}async unpublishDataChannel(L){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Ib(iv.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await Mp.all(L.map((L=>this.signal.request(ww.UNPUBLISH_DATASTREAM,{channel_id:L},!0))))}catch(L){Eb.warning("unpublish datachannels warning: ",L)}}async presubscribe(L,k,M){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Ib(iv.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));const U={stream_id:L,stream_type:k,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!zA("SUBSCRIBE_TWCC"),rtx:!!zA("USE_SUB_RTX")||void 0,extend:zA("SUB_EXTEND"),svc:Array.isArray(zA("SVC"))&&0!==zA("SVC").length?zA("SVC"):void 0};try{return await this.signal.request(ww.PRE_SUBSCRIBE,U,!0)}catch(U){if(M&&U.data&&U.data.code===Cw.ERR_SUBSCRIBE_REQUEST_INVALID)return Eb.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),U.toString()),this.presubscribe(L,k,!1);throw U}}async subscribe(L,k,M){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Ib(iv.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));const U={stream_id:L,stream_type:k.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!zA("SUBSCRIBE_TWCC"),rtx:!!zA("USE_SUB_RTX"),extend:zA("SUB_EXTEND"),ssrcId:k.ssrcId,svc:Array.isArray(zA("SVC"))&&0!==zA("SVC").length?zA("SVC"):void 0};try{return(await this.signal.request(ww.SUBSCRIBE,U,!0))._message}catch(U){if(M&&U.data&&U.data.code===Cw.ERR_SUBSCRIBE_REQUEST_INVALID)return Eb.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),U.toString()),await this.tryUnsubBeforeResub(L,k),await this.subscribe(L,k,!1);throw U}}async subscribeDataChannel(L,k,M){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Ib(iv.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));const U={uid:L,stream_id:k.id,channel_id:k.datachannelId};try{return void await this.signal.request(ww.SUBSCRIBE_DATASTREAM,U,!0)}catch(U){if(M&&U.data&&U.data.code===Cw.ERR_SUBSCRIBE_REQUEST_INVALID)return Eb.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),U.toString()),await this.tryUnsubDataChannelBeforeResub(L,k),await this.subscribeDataChannel(L,k,!1);throw U}}async subscribeAll(L,k){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Ib(iv.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));const M={p2p_id:this.store.p2pId,users:L,dtx:!1,rtx:!!zA("USE_SUB_RTX"),twcc:!!zA("SUBSCRIBE_TWCC"),svc:Array.isArray(zA("SVC"))&&0!==zA("SVC").length?zA("SVC"):void 0};try{return await this.signal.request(ww.SUBSCRIBE_STREAMS,M,!0)}catch(M){if(k&&M.data&&M.data.code===Cw.ERR_SUBSCRIBE_REQUEST_INVALID)return Eb.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),M.toString()),await this.tryMassUnsubBeforeResub(L),await this.subscribeAll(L,!1);throw M}}async setVideoProfile(L){const k=function(L){if(!(L.bitrateMax&&L.bitrateMin&&L.frameRate&&L.height&&L.width))return;let k=L.frameRate,M=L.width,U=L.height,x=!0;return"number"!=typeof k&&(k=k.exact||k.ideal||k.max||k.min||0,k||(x=!1)),"number"!=typeof M&&(M=M.exact||M.ideal||M.max||M.min||0,M||(x=!1)),"number"!=typeof U&&(U=U.exact||U.ideal||U.max||U.min||0,k||(x=!1)),x?{stream_type:0,width:M,height:U,fps:k,start_bps:1e3*L.bitrateMax,min_bps:1e3*L.bitrateMin,target_bps:1e3*L.bitrateMax}:void 0}(L);if(k)return this.signal.request(ww.SET_VIDEO_PROFILE,k);Eb.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(L,k){try{await this.signal.request(ww.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:L,stream_id:k},!0)}catch(L){Eb.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),L)}}async unsubscribeDataChannel(L,k){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Ib(iv.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await Mp.all(L.map((L=>this.signal.request(ww.UNSUBSCRIBE_DATASTREAM,{stream_id:L,uid:k},!0))))}catch(L){Eb.warning("unsubscribeDataChannel warning: ",L)}}async massUnsubscribe(L){try{await this.signal.request(ww.UNSUBSCRIBE_STREAMS,L,!0)}catch(L){Eb.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),L)}}async reconnectPC(L){const{iceParameters:k,dtlsParameters:M,rtpCapabilities:U}=L;return{gatewayEstablishParams:await this.signal.request(ww.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:k,dtlsParameters:M,rtpCapabilities:U}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(ww.GATEWAY_INFO)}async renewToken(L){await this.signal.request(ww.RENEW_TOKEN,L),this.key=L.token}async setClientRole(L,k){if(k&&(this._clientRoleOptions=Object.assign({},k)),"CONNECTED"!==this.state)return void(this.role=L);let M,U=0;"audience"===L?this._clientRoleOptions&&this._clientRoleOptions.delay?(M=this._clientRoleOptions.delay,U=1):U=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:U=0,await this.signal.request(ww.SET_CLIENT_ROLE,{role:L,level:U,delay:M,client_ts:Date.now()}),this.role=L}async setRemoteVideoStreamType(L,k){await this.signal.request(ww.SWITCH_VIDEO_STREAM,{stream_id:L,stream_type:k})}async setDefaultRemoteVideoStreamType(L){await this.signal.request(ww.DEFAULT_VIDEO_STREAM,{stream_type:L})}async setStreamFallbackOption(L,k){await this.signal.request(ww.SET_FALLBACK_OPTION,{stream_id:L,fallback_type:k})}async pickSVCLayer(L,k){await this.signal.request(ww.PICK_SVC_LAYER,{stream_id:L,spatial_layer:k.spatialLayer,temporal_layer:k.temporalLayer})}async setRTM2Flag(L){await this.signal.request(ww.SET_RTM2_FLAG,{rtm2_flag:L})}async sendExtensionMessage(L,k,M){if(this.signal instanceof MU)return this.signal.sendExtensionMessage(L,k,M)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),ux({},this.inChannelInfo)}async getGatewayVersion(){return(await this.signal.request(ww.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const L=OU.get(this.joinInfo.cname);L&&L.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0)}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const L=function(L){let k;return k=L.startsWith("dc")?L.match(/(dc\:\/\/)?([^:]+):(\d+)/):L.match(/(wss\:\/\/)?([^:]+):(\d+)/),k?{username:Vv.username,password:Vv.password,turnServerURL:k[2],tcpport:parseInt(k[3])+30,udpport:parseInt(k[3])+30,forceturn:!1}:null}(("disabled"===this.joinInfo.cloudProxyServer?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],L&&"off"!==this.joinInfo.turnServer.mode&&"disabled"===this.joinInfo.cloudProxyServer&&this.joinInfo.turnServer.serversFromGateway.push(ux(ux({},Vv),{},{turnServerURL:L.turnServerURL,tcpport:L.tcpport,udpport:L.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if("CONNECTED"!==this.state)return;const L=await this.signal.request(ww.TRAFFIC_STATS,void 0,!0);L.timestamp=Date.now(),null!=L.ntp_offset&&(this.ntpOffset=L.ntp_offset),L.peer_delay.forEach((L=>{const k=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find((k=>k.peer_uid===L.peer_uid));k&&k.B_st!==L.B_st&&nA((()=>{this.emit(Xw.STREAM_TYPE_CHANGE,L.peer_uid,L.B_st)}))})),this._statsCollector.updateTrafficStats(L)}getJoinMessage(L){if(!this.joinInfo||!this.key)throw new Ib(iv.UNEXPECTED_ERROR,"can not generate join message, no join info");const k=Object.assign({},this.joinInfo.apResponse);let M=zA("REPORT_APP_SCENARIO");if("string"!=typeof M)try{M=JSON.stringify(M)}catch(L){M=void 0}M&&M.length>128&&(M=void 0);const U=!(Xv()||$v(87)||ZP())&&"boolean"==typeof zA("ENABLE_PRE_SUB")&&zA("ENABLE_PRE_SUB"),x=!ZP()&&dx("ENABLE_PREALLOC_PC","boolean"),V=ux({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:Mv,browser:navigator.userAgent,process_id:zA("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:k,extend:zA("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:"proxy3"===this.joinInfo.cloudProxyServer?"1":"proxy5"===this.joinInfo.cloudProxyServer?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:M,attributes:{userAttributes:{enablePublishedUserList:zA("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:zA("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:"number"==typeof zA("SUBSCRIBE_AUDIO_FILTER_TOPN")?zA("SUBSCRIBE_AUDIO_FILTER_TOPN"):void 0,enablePublishAudioFilter:"boolean"==typeof zA("ENABLE_PUBLISH_AUDIO_FILTER")?zA("ENABLE_PUBLISH_AUDIO_FILTER"):void 0,enableUserLicenseCheck:"boolean"==typeof zA("ENABLE_USER_LICENSE_CHECK")?zA("ENABLE_USER_LICENSE_CHECK"):void 0,enableRTX:!0===zA("USE_PUB_RTX")||!0===zA("USE_SUB_RTX")||void 0,disableFEC:zA("DISABLE_FEC"),enableNTPReport:!!zA("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:!!zA("ENABLE_INSTANT_VIDEO")||void 0,enableFulllinkAvSync:!!zA("ENABLE_FULL_LINK_AV_SYNC")||void 0,enableDataStream2:dx("ENABLE_DATASTREAM_2","boolean"),enableAutFeedback:!!zA("ENABLE_AUT_FEEDBACK")||void 0,rtm2Flag:"number"==typeof this.joinInfo.rtmFlag?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!zA("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:dx("USE_XR","boolean"),enableLossbasedBwe:dx("ENABLE_LOSSBASED_BWE","boolean"),enableAutCC:!!zA("ENABLE_AUT_CC")||void 0,enableCCFallback:dx("ENABLE_CC_FALLBACK","boolean"),enablePreallocPC:x,preSubNum:U?dx("PRE_SUB_NUM","number"):void 0,enablePubTWCC:dx("PUBLISH_TWCC","boolean"),enableSubTWCC:dx("SUBSCRIBE_TWCC","boolean"),enablePubRTX:dx("USE_PUB_RTX","boolean"),enableSubRTX:dx("USE_SUB_RTX","boolean"),enableSubSVC:zA("ENABLE_SVC")?zA("ENABLE_SVC_DEFAULT_CODECS"):Array.isArray(zA("SVC"))&&0!==zA("SVC").length?zA("SVC"):void 0}},join_ts:this.joinGatewayStartTime},L);return this.joinInfo.stringUid&&(V.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(V.aes_mode=this.joinInfo.aesmode,zA("ENCRYPT_AES")?(V.aes_secret=this.joinInfo.aespassword,V.aes_encrypt=!0):V.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(V.aes_salt=this.joinInfo.aessalt)),k.addresses[this.signal.websocket.currentURLIndex]&&(V.ap_response.ticket=k.addresses[this.signal.websocket.currentURLIndex].ticket,delete k.addresses),void 0!==this.joinInfo.defaultVideoStream&&(V.default_video_stream=this.joinInfo.defaultVideoStream),V}getRejoinMessage(){if(!this.joinInfo)throw new Ib(iv.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(bw.WS_RECONNECT_WAITTING_FINISH,(L=>{var k;Sr(k=["tryNext","recover"]).call(k,L)&&this.joinInfo&&Ab.adjustSessionStartTime(this.joinInfo.sid)})),this.signal.on(bw.WS_RECONNECT_CREATE_CONNECTION,(L=>{this.joinGatewayStartTime=Date.now()})),this.signal.on(bw.WS_RECONNECTING,(L=>{this.joinInfo&&Ab.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:L||fv.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",Ab.sessionInit(this.joinInfo.sid,{lts:(new Date).getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:"live"===this.spec.mode?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:"audience"===this.role?2:1,buildFormat:1}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())})),this.signal.on(bw.WS_CLOSED,(L=>{let k;switch(L){case hv.LEAVE:k=fv.LEAVE;break;case hv.UID_BANNED:case hv.IP_BANNED:case hv.CHANNEL_BANNED:case hv.SERVER_ERROR:k=fv.SERVER_ERROR;break;case hv.FALLBACK:k=fv.FALLBACK;break;case hv.LICENSE_MISSING:case hv.LICENSE_EXPIRED:case hv.LICENSE_MINUTES_EXCEEDED:case hv.LICENSE_PERIOD_INVALID:case hv.LICENSE_MULTIPLE_SDK_SERVICE:case hv.LICENSE_ILLEGAL:case hv.TOKEN_EXPIRE:k=L;break;default:k=fv.NETWORK_ERROR}Eb.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(k||"undefined -> "+fv.NETWORK_ERROR)),this.joinInfo&&Ab.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:L===hv.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:k}),this._disconnectedReason=L,L!==hv.FALLBACK&&(this.state="DISCONNECTED"),this.reset()})),this.signal.on(bw.WS_CONNECTED,(()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo&&("audience"===this.role&&this._clientRoleOptions&&(this._clientRoleOptions.level||this._clientRoleOptions.delay)&&(Eb.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(this._clientRoleOptions.level,", delay: ").concat(this._clientRoleOptions.delay)),this.setClientRole(this.role,this._clientRoleOptions)),Ab.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:"0",preload:this.joinInfo.preload}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&1===this.joinInfo.setLocalAPVersion)){const L=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!L)return void Eb.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(L));qA("EVENT_REPORT_DOMAIN",L[1]),qA("EVENT_REPORT_BACKUP_DOMAIN",L[1]),qA("LOG_UPLOAD_SERVER","".concat(L[1],":6444"))}})),this.signal.on(Nw.ON_UPLINK_STATS,(L=>{this._statsCollector.updateUplinkStats(L)})),this.signal.on(bw.REQUEST_RECOVER,((L,k,M)=>{if(!this.joinInfo)return M(new Ib(iv.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));L&&(this.joinInfo.multiIP=L,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,Xy(this,Xw.REQUEST_NEW_GATEWAY_LIST).then(k).catch(M)})),this.signal.on(bw.REQUEST_JOIN_INFO,(async L=>{var k;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void L(this.getJoinMessage({ortc:{}}));const{iceParameters:M,dtlsParameters:U,rtpCapabilities:x}=await Xy(this,Xw.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:null===(k=this.joinInfo)||void 0===k?void 0:k.turnServer});L(this.getJoinMessage({ortc:{iceParameters:M,dtlsParameters:U,rtpCapabilities:x,version:"2"}}))})),this.signal.on(bw.REQUEST_REJOIN_INFO,(L=>{L(this.getRejoinMessage())})),this.signal.on(bw.REPORT_JOIN_GATEWAY,((L,k)=>{if(!this.joinInfo)return;let M,U="";var x;L instanceof Ib?(M=(null===(x=L.data)||void 0===x?void 0:x.desc)||L.code,U=L.message):M=L,Ab.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:M,errorMsg:U,addr:k,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:"0",preload:this.joinInfo.preload}),this._isProactiveJoin=!1})),this.signal.on(bw.IS_P2P_DISCONNECTED,(L=>{L($y(this,Xw.IS_P2P_DISCONNECTED))})),this.signal.on(bw.DISCONNECT_P2P,(()=>{this.emit(Xw.DISCONNECT_P2P)})),this.signal.on(bw.REQUEST_SUCCESS,(()=>{this._signalTimeout=!1})),this.signal.on(bw.REQUEST_TIMEOUT,(()=>{this._signalTimeout=!0})),this.signal.on(bw.JOIN_RESPONSE,(L=>{const k=this.getCurrentGatewayAddress();this.emit(Xw.JOIN_RESPONSE,L,k)})),this.signal.on(bw.PRE_CONNECT_PC,(async()=>{if(this.joinInfo){this.updateTurnConfigFromSignal();const L=this.getCurrentGatewayAddress(),k=zA("FINGERPRINT")||this.joinInfo.apResponse.addresses[this.signal.currentURLIndex].fingerprint;if(L&&k){const M=KU(L);this.emit(Xw.PRE_CONNECT_PC,{candidates:M,fingerprint:k})}}})),this.signal.on(bw.RECOVER_NOTIFICATION,(L=>{this.joinInfo&&"string"==typeof zA("AP_REQUEST_DETAIL")&&(this.joinInfo.apRequestDetail="".concat(zA("AP_REQUEST_DETAIL"),";").concat(L))}))}async tryUnsubBeforeResub(L,k){try{await this.signal.request(ww.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:L,ortc:[k]},!0)}catch(L){throw Eb.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),L),L}}async tryUnsubDataChannelBeforeResub(L,k){try{await this.signal.request(ww.UNSUBSCRIBE,{stream_id:k.id},!0)}catch(L){throw Eb.warning("unsubscribe datachannel warning",L),L}}async tryUnpubBeforeRepub(L,k){try{await this.signal.request(ww.UNPUBLISH,{stream_id:L,ortc:k},!0)}catch(L){throw Eb.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),L),L}}async tryUnpubDataChannelBeforeRepub(L,k){try{await this.signal.request(ww.UNPUBLISH_DATASTREAM,{channnel_id:k.channelId},!0)}catch(L){throw Eb.warning("unpublish datastream warning: ",L),L}}async tryMassUnsubBeforeResub(L){const k={users:L.map((L=>({stream_id:L.stream_id,stream_type:L.stream_type})))};try{await this.signal.request(ww.UNSUBSCRIBE_STREAMS,k,!0)}catch(L){throw Eb.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),L),L}}async muteLocal(L,k){const M={action:L.find((L=>L.stream_type===qw.Audio))?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:L,stream_id:k};try{await this.signal.request(ww.CONTROL,M,!0,!0)}catch(L){throw Eb.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),L),L}}async unmuteLocal(L,k){const M={action:L.find((L=>L.stream_type===qw.Audio))?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:L,stream_id:k};try{await this.signal.request(ww.CONTROL,M,!0,!0)}catch(L){throw Eb.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),L),L}}async muteRemote(L,k){const M={action:L===nO.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:k};try{await this.signal.request(ww.CONTROL,M,!0,!0)}catch(L){throw Eb.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),L),L}}async unmuteRemote(L,k){const M={action:L===nO.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:k};try{await this.signal.request(ww.CONTROL,M,!0,!0)}catch(L){throw Eb.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),L),L}}uploadWRTCStats(L){this.signal.uploadWRTCStats(L)}upload(L,k){this.signal.upload(L,k)}getSignalRTT(){return this.signal.rtt}async restartICE(L){const k={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:L};try{return await this.signal.request(ww.RESTART_ICE,k,!0)}catch(L){throw Eb.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),L),L}}reconnect(){"CONNECTED"===this.state&&this.signal.reconnect(void 0,fv.P2P_FAILED)}getCurrentGatewayAddress(){var L,k;if(!zA("GATEWAY_WSS_ADDRESS"))return zA("USE_CANDIDATE_FROM_AP_DETAIL")&&null!==(L=this.joinInfo)&&void 0!==L&&L.apGatewayAddress?(Eb.debug("[".concat(this.store.clientId,"] use candidate from ap detail, ").concat(JSON.stringify(this.joinInfo.apGatewayAddress))),this.joinInfo.apGatewayAddress):null!==(k=this.joinInfo)&&void 0!==k&&k.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(L){await this.signal.request(ww.SET_PARAMETER,{enablePublishAudioFilter:L})}}let DU=0,LU=0;function fx(L,k,M,U){return new Mp(((x,V)=>{k.timeout=k.timeout||zA("HTTP_CONNECT_TIMEOUT"),k.responseType=k.responseType||"json",k.data&&!M?(k.data=JSON.stringify(k.data),DU+=hA(k.data)):M&&(k.data.size?DU+=k.data.size:k.data instanceof FormData?DU+=pA(k.data):DU+=hA(JSON.stringify(k.data))),k.headers=k.headers||{},k.headers["Content-Type"]=k.headers["Content-Type"]||"application/json",k.method="POST",k.url=L,KC.request(k).then((L=>{"string"==typeof L.data?LU+=hA(L.data):L.data instanceof ArrayBuffer||L.data instanceof Uint8Array?LU+=L.data.byteLength:LU+=hA(JSON.stringify(L.data)),U&&x({data:L.data,headers:L.headers}),x(L.data)})).catch((L=>{KC.isCancel(L)?V(new Ib(iv.OPERATION_ABORTED,"cancel token canceled")):"ECONNABORTED"===L.code?V(new Ib(iv.NETWORK_TIMEOUT,L.message)):L.response?V(new Ib(iv.NETWORK_RESPONSE_ERROR,L.response.status)):V(new Ib(iv.NETWORK_ERROR,L.message))}))}))}
/*! formdata-polyfill. MIT License. Jimmy W?rting <https://jimmy.warting.se/opensource> */!function(){var k;function i(L){var k=0;return function(){return k<L.length?{done:!1,value:L[k++]}:{done:!0}}}var M,U="function"==typeof Object.defineProperties?Object.defineProperty:function(L,k,M){return L==Array.prototype||L==Object.prototype||(L[k]=M.value),L},x=function(k){k=["object"==typeof globalThis&&globalThis,k,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof L&&L];for(var M=0;M<k.length;++M){var U=k[M];if(U&&U.Math==Math)return U}throw Error("Cannot find global object")}(this);function s(L,k){if(k)e:{var M=x;L=L.split(".");for(var V=0;V<L.length-1;V++){var F=L[V];if(!(F in M))break e;M=M[F]}(k=k(V=M[L=L[L.length-1]]))!=V&&null!=k&&U(M,L,{configurable:!0,writable:!0,value:k})}}function a(L){return(L={next:L})[Symbol.iterator]=function(){return this},L}function c(L){var k="undefined"!=typeof Symbol&&Symbol.iterator&&L[Symbol.iterator];return k?k.call(L):{next:i(L)}}if(s("Symbol",(function(L){function t(L,k){this.A=L,U(this,"description",{configurable:!0,writable:!0,value:k})}if(L)return L;t.prototype.toString=function(){return this.A};var k="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",M=0;return function e(L){if(this instanceof e)throw new TypeError("Symbol is not a constructor");return new t(k+(L||"")+"_"+M++,L)}})),s("Symbol.iterator",(function(L){if(L)return L;L=Symbol("Symbol.iterator");for(var k="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),M=0;M<k.length;M++){var V=x[k[M]];"function"==typeof V&&"function"!=typeof V.prototype[L]&&U(V.prototype,L,{configurable:!0,writable:!0,value:function(){return a(i(this))}})}return L})),"function"==typeof Object.setPrototypeOf)M=Object.setPrototypeOf;else{var V;e:{var F={};try{F.__proto__={a:!0},V=F.a;break e}catch(k){}V=!1}M=V?function(L,k){if(L.__proto__=k,L.__proto__!==k)throw new TypeError(L+" is not extensible");return L}:null}var j=M;function h(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function p(L){if(L.m)throw new TypeError("Generator is already running");L.m=!0}function _(L,k){return L.h=3,{value:k}}function E(L){this.g=new h,this.G=L}function f(L,k,M,U){try{var x=k.call(L.g.j,M);if(!(x instanceof Object))throw new TypeError("Iterator result "+x+" is not an object");if(!x.done)return L.g.m=!1,x;var V=x.value}catch(k){return L.g.j=null,L.g.s(k),m(L)}return L.g.j=null,U.call(L.g,V),m(L)}function m(L){for(;L.g.h;)try{var k=L.G(L.g);if(k)return L.g.m=!1,{value:k.value,done:!1}}catch(k){L.g.v=void 0,L.g.s(k)}if(L.g.m=!1,L.g.l){if(k=L.g.l,L.g.l=null,k.F)throw k.D;return{value:k.return,done:!0}}return{value:void 0,done:!0}}function T(L){this.next=function(k){return L.o(k)},this.throw=function(k){return L.s(k)},this.return=function(k){return function(L,k){p(L.g);var M=L.g.j;return M?f(L,"return"in M?M.return:function(L){return{value:L,done:!0}},k,L.g.return):(L.g.return(k),m(L))}(L,k)},this[Symbol.iterator]=function(){return this}}function S(L,k){return k=new T(new E(k)),j&&L.prototype&&j(k,L.prototype),k}if(h.prototype.o=function(L){this.v=L},h.prototype.s=function(L){this.l={D:L,F:!0},this.h=this.C||this.u},h.prototype.return=function(L){this.l={return:L},this.h=this.u},E.prototype.o=function(L){return p(this.g),this.g.j?f(this,this.g.j.next,L,this.g.o):(this.g.o(L),m(this))},E.prototype.s=function(L){return p(this.g),this.g.j?f(this,this.g.j.throw,L,this.g.o):(this.g.s(L),m(this))},s("Array.prototype.entries",(function(L){return L||function(){return function(L,k){L instanceof String&&(L+="");var M=0,U=!1,x={next:function(){if(!U&&M<L.length){var x=M++;return{value:k(x,L[x]),done:!1}}return U=!0,{done:!0,value:void 0}}};return x[Symbol.iterator]=function(){return x},x}(this,(function(L,k){return[L,k]}))}})),"undefined"!=typeof Blob&&("undefined"==typeof FormData||!FormData.prototype.keys)){var g=function(L,k){for(var M=0;M<L.length;M++)k(L[M])},R=function(L){return L.replace(/\r?\n|\r/g,"\r\n")},C=function(L,k,M){return k instanceof Blob?(M=void 0!==M?String(M+""):"string"==typeof k.name?k.name:"blob",k.name===M&&"[object Blob]"!==Object.prototype.toString.call(k)||(k=new File([k],M)),[String(L),k]):[String(L),String(k)]},I=function(L,k){if(L.length<k)throw new TypeError(k+" argument required, but only "+L.length+" present.")},z="object"==typeof globalThis?globalThis:"object"==typeof window?window:"object"==typeof self?self:this,Q=z.FormData,$=z.XMLHttpRequest&&z.XMLHttpRequest.prototype.send,ee=z.Request&&z.fetch,te=z.navigator&&z.navigator.sendBeacon,ie=z.Element&&z.Element.prototype,ne=z.Symbol&&Symbol.toStringTag;ne&&(Blob.prototype[ne]||(Blob.prototype[ne]="Blob"),"File"in z&&!File.prototype[ne]&&(File.prototype[ne]="File"));try{new File([],"")}catch(k){z.File=function(L,k,M){return L=new Blob(L,M||{}),Object.defineProperties(L,{name:{value:k},lastModified:{value:+(M&&void 0!==M.lastModified?new Date(M.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),ne&&Object.defineProperty(L,ne,{value:"File"}),L}}var D=function(L){return L.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},P=function(L){this.i=[];var k=this;L&&g(L.elements,(function(L){if(L.name&&!L.disabled&&"submit"!==L.type&&"button"!==L.type&&!L.matches("form fieldset[disabled] *"))if("file"===L.type){var M=L.files&&L.files.length?L.files:[new File([],"",{type:"application/octet-stream"})];g(M,(function(M){k.append(L.name,M)}))}else"select-multiple"===L.type||"select-one"===L.type?g(L.options,(function(M){!M.disabled&&M.selected&&k.append(L.name,M.value)})):"checkbox"===L.type||"radio"===L.type?L.checked&&k.append(L.name,L.value):(M="textarea"===L.type?R(L.value):L.value,k.append(L.name,M))}))};if((k=P.prototype).append=function(L,k,M){I(arguments,2),this.i.push(C(L,k,M))},k.delete=function(L){I(arguments,1);var k=[];L=String(L),g(this.i,(function(M){M[0]!==L&&k.push(M)})),this.i=k},k.entries=function e(){var L,k=this;return S(e,(function(M){if(1==M.h&&(L=0),3!=M.h)return L<k.i.length?M=_(M,k.i[L]):(M.h=0,M=void 0),M;L++,M.h=2}))},k.forEach=function(L,k){I(arguments,1);for(var M=c(this),U=M.next();!U.done;U=M.next()){var x=c(U.value);U=x.next().value,x=x.next().value,L.call(k,x,U,this)}},k.get=function(L){I(arguments,1);var k=this.i;L=String(L);for(var M=0;M<k.length;M++)if(k[M][0]===L)return k[M][1];return null},k.getAll=function(L){I(arguments,1);var k=[];return L=String(L),g(this.i,(function(M){M[0]===L&&k.push(M[1])})),k},k.has=function(L){I(arguments,1),L=String(L);for(var k=0;k<this.i.length;k++)if(this.i[k][0]===L)return!0;return!1},k.keys=function e(){var L,k,M,U=this;return S(e,(function(x){if(1==x.h&&(L=c(U),k=L.next()),3!=x.h)return k.done?void(x.h=0):(M=k.value,_(x,c(M).next().value));k=L.next(),x.h=2}))},k.set=function(L,k,M){I(arguments,2),L=String(L);var U=[],x=C(L,k,M),V=!0;g(this.i,(function(k){k[0]===L?V&&(V=!U.push(x)):U.push(k)})),V&&U.push(x),this.i=U},k.values=function e(){var L,k,M,U,x=this;return S(e,(function(V){if(1==V.h&&(L=c(x),k=L.next()),3!=V.h)return k.done?void(V.h=0):(M=k.value,(U=c(M)).next(),_(V,U.next().value));k=L.next(),V.h=2}))},P.prototype._asNative=function(){for(var L=new Q,k=c(this),M=k.next();!M.done;M=k.next()){var U=c(M.value);M=U.next().value,U=U.next().value,L.append(M,U)}return L},P.prototype._blob=function(){var L="----formdata-polyfill-"+Math.random(),k=[],M="--"+L+'\r\nContent-Disposition: form-data; name="';return this.forEach((function(L,U){return"string"==typeof L?k.push(M+D(R(U))+'"\r\n\r\n'+R(L)+"\r\n"):k.push(M+D(R(U))+'"; filename="'+D(L.name)+'"\r\nContent-Type: '+(L.type||"application/octet-stream")+"\r\n\r\n",L,"\r\n")})),k.push("--"+L+"--"),new Blob(k,{type:"multipart/form-data; boundary="+L})},P.prototype[Symbol.iterator]=function(){return this.entries()},P.prototype.toString=function(){return"[object FormData]"},ie&&!ie.matches&&(ie.matches=ie.matchesSelector||ie.mozMatchesSelector||ie.msMatchesSelector||ie.oMatchesSelector||ie.webkitMatchesSelector||function(L){for(var k=(L=(this.document||this.ownerDocument).querySelectorAll(L)).length;0<=--k&&L.item(k)!==this;);return-1<k}),ne&&(P.prototype[ne]="FormData"),$){var re=z.XMLHttpRequest.prototype.setRequestHeader;z.XMLHttpRequest.prototype.setRequestHeader=function(L,k){re.call(this,L,k),"content-type"===L.toLowerCase()&&(this.B=!0)},z.XMLHttpRequest.prototype.send=function(L){L instanceof P?(L=L._blob(),this.B||this.setRequestHeader("Content-Type",L.type),$.call(this,L)):$.call(this,L)}}ee&&(z.fetch=function(L,k){return k&&k.body&&k.body instanceof P&&(k.body=k.body._blob()),ee.call(this,L,k)}),te&&(z.navigator.sendBeacon=function(L,k){return k instanceof P&&(k=k._asNative()),te.call(this,L,k)}),z.FormData=P}}();const mx=()=>{const L=zA("AREAS");return 0===L.length&&L.push(Zw.GLOBAL),kr(L).call(L,((L,k,M)=>{const U=Tx(k);return U?0===M?U:"".concat(L,",").concat(U):L}),"")},Tx=L=>L===Zw.OVERSEA?"".concat(eO.ASIA,",").concat(eO.EUROPE,",").concat(eO.AFRICA,",").concat(eO.NORTH_AMERICA,",").concat(eO.SOUTH_AMERICA,",").concat(eO.OCEANIA):eO[L],Sx=L=>{const k={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return L.map((L=>{const M=tO[L],U=Object.keys(M);U&&U.map((L=>{"CODE"!==L&&(k[L]=k[L].concat(M[L]))}))})),k},UU={GLOBAL:{ASIA:[Zw.CHINA,Zw.JAPAN,Zw.INDIA,Zw.KOREA,Zw.HKMC],EUROPE:[],NORTH_AMERICA:[Zw.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},xU=Object.keys(UU[Zw.GLOBAL]),hx=[Zw.CHINA,Zw.NORTH_AMERICA,Zw.EUROPE,Zw.ASIA,Zw.JAPAN,Zw.INDIA,Zw.OCEANIA,Zw.SOUTH_AMERICA,Zw.AFRICA,Zw.KOREA,Zw.HKMC,Zw.US],Ix=function(L,k){let M=[];if(Sr(L).call(L,Zw.GLOBAL)){const V=[Zw.GLOBAL,Zw.OVERSEA],F=Object.keys(tO);if(k===Zw.GLOBAL)throw new Ib(iv.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(k===Zw.CHINA)M=[Zw.OVERSEA];else if(x=k,Sr(xU).call(xU,x)){const L=(U=k,UU[Zw.GLOBAL][U]||[]),x=[...V,k,...L];M=F.filter((L=>!Sr(x).call(x,L)))}else if(function(L){let k=!1;return xU.forEach((M=>{var U;Sr(U=UU[Zw.GLOBAL][M]).call(U,L)&&(k=!0)})),k}(k)){const L=function(L){let k;return xU.forEach((M=>{var U;Sr(U=UU[Zw.GLOBAL][M]).call(U,L)&&(k=M)})),k}(k),U=[...V,L,k];M=F.filter((L=>!Sr(U).call(U,L)))}else M=L;M=function(L){const k=[];return hx.forEach((M=>{Sr(L).call(L,M)&&k.push(M)})),k.concat(L.filter((L=>!Sr(hx).call(hx,L))))}(M)}else M=L;var U,x;return M};function vx(L){var k,M;if(!L&&Sr(k=zA("AREAS")).call(k,Zw.EXTENSIONS))return Eb.debug("update area from ap : reset"),void yx(Cb,!0);if(!Sr(M=zA("AREAS")).call(M,Zw.GLOBAL)||!L)return;let U=tO.EXTENSIONS;U&&(U={CODE:Tx(Zw.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(L,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(L,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(L,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(L,".agora.io"),"cds-ap-web-2-".concat(L,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(L,".agora.io"),"sua-ap-web-2-".concat(L,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(L,".agora.io"),"uap-ap-web-2-".concat(L,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(L,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(L,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(L,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(L,".agora.io")]},Eb.debug("update area from ap success: ".concat(L,",config is "),U),qA("AREAS",[Zw.EXTENSIONS],!0),Object.keys(U).map((L=>{qA(L,"LOG_UPLOAD_SERVER"===L||"EVENT_REPORT_DOMAIN"===L||"EVENT_REPORT_BACKUP_DOMAIN"===L||"PROXY_SERVER_TYPE3"===L?U[L][0]:U[L])})))}function yx(L){let k=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const M=Ab.reportApiInvoke(null,{name:dv.SET_AREA,options:L,tag:lv.TRACER});try{let U=[];if("string"==typeof L&&(U=[L]),Array.isArray(L)&&(L.forEach((L=>{if(!Sr($w).call($w,L))throw new Ib(iv.INVALID_PARAMS,"invalid area code")})),U=L),"[object Object]"===Object.prototype.toString.call(L)){const{areaCode:k,excludedArea:M}=L;if(!k)throw new Ib(iv.INVALID_PARAMS,"area code is needed");let x=k;"string"==typeof k&&(x=[k]),U=M?Ix(x,M):x}if(!k){if(eb.AREAS){const L=new Ib(iv.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return M.onError(L),void Eb.warning("setArea is prohibited because of config-distribute")}if(Sr(U).call(U,Zw.GLOBAL)&&zA("AREAS")===Zw.EXTENSIONS){const L=new Ib(iv.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return M.onError(L),void Eb.warning("setArea is prohibited because of ap extensions")}}qA("AREAS",U,k);const x=Sx(U);Object.keys(x).map((L=>{qA(L,"LOG_UPLOAD_SERVER"===L||"EVENT_REPORT_DOMAIN"===L||"EVENT_REPORT_BACKUP_DOMAIN"===L||"PROXY_SERVER_TYPE3"===L?x[L][0]:x[L])})),Eb.debug("set area success:",U.join(","))}catch(L){throw M.onError(L),L}M.onSuccess()}function Ax(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function bx(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?Ax(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):Ax(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}let _x=1;let Ex=1;function Dx(L,k,M,U){let{url:x,areaCode:V}=L;const{clientId:F,sid:j}=k,z=Date.now();let Q;const[$,ee]=Ux(k,V,[UO.CHOOSE_SERVER]);let te=Rv.networkState;return PA((async()=>{te&&Rv.networkState===gv.OFFLINE&&Rv.onlineWaiter&&await Mp.race([Rv.onlineWaiter,EA(U&&U.maxRetryTimeout||Ov.maxRetryTimeout)]),te=Rv.networkState;const{data:L,headers:V}=await fx(x,{data:$,cancelToken:M,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);Q="1"===V.http3?1:-1,Ab.reportResourceTiming(x,j),Lx(L,x,k,z,[UO.CHOOSE_SERVER],Q);const F=ZO(L,UO.CHOOSE_SERVER);return kx(F),zO(F,x)}),(L=>(L&&Ab.joinChooseServer(j,{lts:z,succ:!0,csAddr:x,opid:ee,serverList:L.gatewayAddrs.map((L=>L.address)),ec:null,cid:L.cid.toString(),uid:L.uid.toString(),csIp:L.csIp,unilbsServerIds:[UO.CHOOSE_SERVER].toString(),isHttp3:Q,corssRegionTagReq:k.apRequestDetail,corssRegionTagRes:L.res.detail&&L.res.detail[38]}),!1)),(L=>L.code!==iv.OPERATION_ABORTED&&(L.code===iv.CAN_NOT_GET_GATEWAY_SERVER?L.data.retry:(Ab.joinChooseServer(j,{lts:z,succ:!1,csAddr:x,serverList:null,opid:ee,ec:L.code,csIp:L.data&&L.data.csIp,unilbsServerIds:[UO.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:te}),isHttp3:Q,corssRegionTagReq:k.apRequestDetail}),Eb.warning("[".concat(F||"sid-".concat(j.slice(0,6)),"] Choose server network error, retry"),L),!0))),U)}function Px(L,k,M,U){let x,{url:V,areaCode:F,serviceIds:j}=L;const z=Date.now(),[Q,$]=Ux(k,F,j);let ee;return PA((async()=>{ee&&Rv.networkState===gv.OFFLINE&&Rv.onlineWaiter&&await Mp.race([Rv.onlineWaiter,EA(U&&U.maxRetryTimeout||Ov.maxRetryTimeout)]),ee=Rv.networkState;const{data:L,headers:F}=await fx(V,{data:Q,cancelToken:M,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);x="1"===F.http3?1:-1,Ab.reportResourceTiming(V,k.sid),Lx(L,V,k,z,j,x);const $=ZO(L,UO.CHOOSE_SERVER),te=ZO(L,"proxy5"===k.cloudProxyServer?UO.CLOUD_PROXY_5:"proxy3"===k.cloudProxyServer||"proxy4"===k.cloudProxyServer?UO.CLOUD_PROXY:UO.CLOUD_PROXY_FALLBACK);return kx($),{gatewayInfo:zO($,V),proxyInfo:te,url:V}}),(L=>(L.gatewayInfo&&Ab.joinChooseServer(k.sid,{lts:z,succ:!0,csAddr:V,serverList:L.gatewayInfo.gatewayAddrs.map((L=>L.address)),ec:null,opid:$,cid:L.gatewayInfo.cid.toString(),uid:L.gatewayInfo.uid.toString(),csIp:L.gatewayInfo.csIp,unilbsServerIds:j.toString(),isHttp3:x,corssRegionTagReq:k.apRequestDetail,corssRegionTagRes:L.gatewayInfo.res.detail&&L.gatewayInfo.res.detail[38]}),L.proxyInfo&&Ab.joinWebProxyAP(k.sid,{lts:z,sucess:1,apServerAddr:V,turnServerAddrList:L.proxyInfo.addresses.map((L=>L.ip)).join(","),errorCode:null,eventType:k.cloudProxyServer,unilbsServerIds:j.toString()}),!1)),(L=>L.code!==iv.OPERATION_ABORTED&&(L.code===iv.CAN_NOT_GET_GATEWAY_SERVER?L.data.retry:(Ab.joinWebProxyAP(k.sid,{lts:z,sucess:0,apServerAddr:V,turnServerAddrList:null,errorCode:L.code,eventType:k.cloudProxyServer,unilbsServerIds:j.toString(),extend:JSON.stringify({networkState:ee})}),Eb.warning("[".concat(k.clientId,"] multi unilbs network error, retry"),L),!0))),U)}const Lx=(L,k,M,U,x,V)=>{const{sid:F,clientId:j,cloudProxyServer:z}=M,Q=[],l=j=>{4096===j.flag?Ab.joinChooseServer(F,{lts:U,succ:!1,csAddr:k,opid:L.opid,serverList:null,ec:j.error.message,csIp:j.error.data&&j.error.data.csIp,unilbsServerIds:x.toString(),isHttp3:V,corssRegionTagReq:M.apRequestDetail}):1048576!==j.flag&&4194304!==j.flag&&4194310!==j.flag||Ab.joinWebProxyAP(F,{lts:U,sucess:0,apServerAddr:k,turnServerAddrList:null,errorCode:j.error.code,eventType:z,unilbsServerIds:x.toString()})};if(L.response_body.forEach((k=>{const M=k.buffer.code;if(23===k.uri&&0===M&&!k.buffer.edges_services)if(4194310===k.buffer.flag)Eb.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),k.buffer.edges_services=[];else{const M={error:new Ib(iv.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:L.detail[502]}),flag:k.buffer.flag};Q.push(M),l(M)}if(0!==M){const U=AO(M),x={error:new Ib(iv.CAN_NOT_GET_GATEWAY_SERVER,U.desc,{desc:U.desc,retry:U.retry,csIp:L.detail[502]}),flag:k.buffer.flag};4194310===k.buffer.flag?Eb.warning(x.error.toString()):Q.push(x),l(x)}})),Q.length)throw Eb.warning("[".concat(j||"sid-".concat(F.slice(0,6)),"] multi unilbs ").concat(k," failed, ").concat(Q.map((L=>"flag: ".concat(L.flag,", message: ").concat(L.error.message,", retry: ").concat(L.error.data.retry))).join(" | "))),new Ib(iv.CAN_NOT_GET_GATEWAY_SERVER,Q.map((L=>"flag: ".concat(L.flag,", message: ").concat(L.error.message))).join(" | "),{retry:!!Q.find((L=>L.error.data.retry)),csIp:L.detail[502],desc:[...new Set(Q.map((L=>{var k;return null==L||null===(k=L.error)||void 0===k||null===(k=k.data)||void 0===k?void 0:k.desc})).filter((L=>!!L)))]})},kx=L=>{var k,M,U,x;if(L.addresses&&0===L.addresses.length&&0===L.code)throw new Ib(iv.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:L.detail&&L.detail[502]});if(zA("AP_AREA")&&(null!==(U=L.detail)&&void 0!==U&&U[23]&&"string"==typeof(null===(x=L.detail)||void 0===x?void 0:x[23])?vx(L.detail[23].toLowerCase()):vx()),null!==(k=L.detail)&&void 0!==k&&k[19]&&"string"==typeof(null===(M=L.detail)||void 0===M?void 0:M[19])){const k=L.detail[19],M=null==k?void 0:k.split(";");for(let k=0;k<M.length;k++){var V;const U=l_(V=M[k]).call(V);L.addresses[k]&&M&&(L.addresses[k].fingerprint=U)}}if(zA("GATEWAY_ADDRESS")&&zA("GATEWAY_ADDRESS").length>0){Eb.debug("assign gateway address to",zA("GATEWAY_ADDRESS"));const k=zA("GATEWAY_ADDRESS").map((k=>{var M,U;const x=null!==(M=null===(U=L.addresses.find((L=>L.ip===k.ip&&L.port===k.port)))||void 0===U?void 0:U.fingerprint)&&void 0!==M?M:"";return{ip:k.ip,port:k.port,ticket:L.addresses[0]&&L.addresses[0].ticket,fingerprint:x}}));L.addresses=k}},Ux=(L,k,M)=>{const U=Math.floor(Math.random()*10**12),x={appid:L.appId,client_ts:Date.now(),opid:U,sid:L.sid,request_bodies:[{uri:22,buffer:{cname:L.cname,detail:bx(bx({6:L.stringUid,11:k,12:zA("USE_NEW_TOKEN")?"1":void 0,22:k},L.apRequestDetail?{33:L.apRequestDetail}:{}),L.apRTM?{26:"RTM2"}:{}),key:L.token,service_ids:M,uid:L.uid||0}}]};x.request_bodies.forEach((k=>{L.multiIP&&L.multiIP.gateway_ip&&(k.buffer.detail[5]=JSON.stringify({vocs_ip:[L.multiIP.uni_lbs_ip],vos_ip:[L.multiIP.gateway_ip]}))}));const V=new FormData;return V.append("request",JSON.stringify(x)),[V,U]};let gx=0;function Fx(L){return Mp.all(L.map((L=>L.then((L=>{throw L}),(L=>L))))).then((L=>{throw L}),(L=>L))}const Bx=async L=>{let{fragementLength:k,referenceList:M,asyncMapHandler:U,allFailedhandler:x,promisesCollector:V}=L,F=0;const j=k;let z,Q=0;const l=async()=>{const L=(()=>{const L=F*j,k=L+j;return M.slice(L,k).map(U)})();V&&V.push(...L);try{z=await Fx(L)}catch(L){if(Q+=j,F++,!(Q>=M.length))return void await l();x(L)}L.forEach((L=>L.cancel()))};return await l(),z},jx=async L=>{let{referenceList:k,asyncMapHandler:M,closeFn:U}=L;const x=k.length;let V=0;const s=async()=>{const L=M(k.shift());try{return await L}catch(L){if(V++,V>=x||null!=U&&U(L))throw L;return s()}};return s()};async function Gx(L,k,M,U){const x=async function(L,k,M,U){let x=null;const V=[],s=async()=>{const x=zA("WEBCS_DOMAIN").slice(0,zA("AJAX_REQUEST_CONCURRENT")).map((k=>({url:L.proxyServer?"https://".concat(L.proxyServer,"/ap/?url=").concat(k+"/api/v2/transpond/webrtc?v=2"):"https://".concat(k,"/api/v2/transpond/webrtc?v=2"),areaCode:mx()}))),F=U.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:x.map((L=>L.url))}),j=await Bx({fragementLength:zA("FRAGEMENT_LENGTH"),referenceList:x,asyncMapHandler:U=>(Eb.debug("[".concat(L.clientId,"] Connect to choose_server:"),U.url),Dx(U,L,k,M)),allFailedhandler:L=>{throw U.recordJoinChannelService({endTs:Date.now(),status:"error",errors:L},F),L[0]},promisesCollector:V});return U.recordJoinChannelService({endTs:Date.now(),status:"success"},F),j},a=async()=>{if(await EA(1e3),null!==x)return x;const F=zA("WEBCS_DOMAIN_BACKUP_LIST").map((k=>({url:L.proxyServer?"https://".concat(L.proxyServer,"/ap/?url=").concat(k+"/api/v2/transpond/webrtc?v=2"):"https://".concat(k,"/api/v2/transpond/webrtc?v=2"),areaCode:mx()}))),j=U.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:F.map((L=>L.url))}),z=await Bx({fragementLength:zA("FRAGEMENT_LENGTH"),referenceList:F,asyncMapHandler:U=>(Eb.debug("[".concat(L.clientId,"] Connect to backup choose_server:"),U.url),Dx(U,L,k,M)),allFailedhandler:L=>{throw U.recordJoinChannelService({endTs:Date.now(),status:"error",errors:L},j),L[0]},promisesCollector:V});return U.recordJoinChannelService({endTs:Date.now(),status:"success"},j),z};try{return x=await Fx([s(),a()]),V.length&&V.forEach((L=>L.cancel&&"function"==typeof L.cancel&&L.cancel())),x}catch(L){throw L[0]}}(L,k,M,U);return{gatewayInfo:await x}}async function Wx(L,k,M,U,x){const V=L.cloudProxyServer;if("disabled"===V){if(!U)return;if(L.useLocalAccessPoint)return await Gx(L,k,M,x);if(zA("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:U,proxyInfo:V}=await zx(L,k,M,x);if(L.turnServer&&"auto"!==L.turnServer.mode)return{gatewayInfo:U};const j=V.map((L=>({turnServerURL:L.address,tcpport:L.tcpport||Vv.tcpport,udpport:L.udpport||Vv.udpport,username:L.username||Vv.username,password:L.password||Vv.password,forceturn:!1,security:!0})));if(x.useP2P){var F;const k=null!==(F=L.uid)&&void 0!==F?F:U.uid,M="glb:".concat(k.toString()),x=await ky(M),z=V.map((L=>({turnServerURL:L.address,tcpport:L.tcpport||Vv.tcpport,udpport:L.udpport||Vv.udpport,username:M,password:x,forceturn:!1,security:!0})));j.push(...z)}return L.turnServer={mode:"manual",servers:j},{gatewayInfo:U}}return await Gx(L,k,M,x)}const{proxyInfo:j,gatewayInfo:z}=await zx(L,k,M,x),Q={gatewayInfo:z},$=j.map((L=>({turnServerURL:L.address,tcpport:"proxy3"===V?void 0:L.tcpport?L.tcpport:Vv.tcpport,udpport:"proxy4"===V?void 0:L.udpport?L.udpport:Vv.udpport,username:L.username||Vv.username,password:L.password||Vv.password,forceturn:"proxy4"!==V,security:"proxy5"===V})));if(x.useP2P){var ee;const k=null!==(ee=L.uid)&&void 0!==ee?ee:z.uid,M="glb:".concat(k.toString()),U=await ky(M),x=j.map((L=>({turnServerURL:L.address,tcpport:"proxy3"===V?void 0:L.tcpport||Vv.tcpport,udpport:"proxy4"===V?void 0:L.udpport||Vv.udpport,username:M,password:U,forceturn:"proxy4"!==V,security:"proxy5"===V})));$.push(...x)}return L.turnServer={mode:"manual",servers:$},Eb.debug("[".concat(L.clientId,"] set proxy server: ").concat(L.proxyServer,", mode: ").concat(V)),Q}async function Hx(L,k,M,U,x){const V=zA("ACCOUNT_REGISTER").slice(0,zA("AJAX_REQUEST_CONCURRENT"));let F=[];F=k.proxyServer?V.map((L=>"https://".concat(k.proxyServer,"/ap/?url=").concat(L+"/api/v1"))):V.map((L=>"https://".concat(L,"/api/v1")));const j=null==x?void 0:x.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:F});try{const V=await async function(L,k,M,U,x){const V=Date.now(),F={sid:M.sid,opid:10,appid:M.appId,string_uid:k};let j=L[0];const z=await PA((()=>fx(j+"".concat(-1===j.indexOf("?")?"?":"&","action=stringuid"),{data:F,cancelToken:U,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}})),((M,U)=>{if(0===M.code){if(M.uid<=0||M.uid>=Math.pow(2,32))throw Eb.error("Invalid Uint Uid ".concat(k," => ").concat(M.uid),M),Ab.reqUserAccount(F.sid,{lts:V,success:!1,serverAddr:j,stringUid:F.string_uid,uid:M.uid,errorCode:iv.INVALID_UINT_UID_FROM_STRING_UID,extend:F}),new Ib(iv.INVALID_UINT_UID_FROM_STRING_UID);return Ab.reqUserAccount(F.sid,{lts:V,success:!0,serverAddr:j,stringUid:F.string_uid,uid:M.uid,errorCode:null,extend:F}),!1}const x=AO(M.code);return x.retry&&(j=L[(U+1)%L.length]),Ab.reqUserAccount(F.sid,{lts:V,success:!1,serverAddr:j,stringUid:F.string_uid,uid:M.uid,errorCode:x.desc,extend:F}),x.retry}),((k,M)=>k.code!==iv.OPERATION_ABORTED&&(Ab.reqUserAccount(F.sid,{lts:V,success:!1,serverAddr:j,stringUid:F.string_uid,uid:null,errorCode:k.code,extend:F}),j=L[(M+1)%L.length],!0)),x);if(0!==z.code){const L=AO(z.code);throw new Ib(iv.UNEXPECTED_RESPONSE,L.desc)}return z}(F,L,k,M,U);return null==x||x.recordJoinChannelService({status:"success",endTs:Date.now()},j),V.uid}catch(L){throw null==x||x.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[L]},j),L}}async function Kx(L,k,M){const U=zA("ACCOUNT_REGISTER");let x=[];x=k.proxyServer?U.map((L=>"https://".concat(k.proxyServer,"/ap/?url=").concat(L+"/api/v1"))):U.map((L=>"https://".concat(L,"/api/v1")));try{const U=await jx({referenceList:x,asyncMapHandler:U=>async function(L,k,M,U){const x=Date.now(),V={sid:M.sid,opid:10,appid:M.appId,string_uid:k};try{const k=await fx(L+"".concat(-1===L.indexOf("?")?"?":"&","action=stringuid"),{data:V,cancelToken:U,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}});if(0!==k.code){const L=AO(k.code);throw new Ib(iv.UNEXPECTED_RESPONSE,"preload sua error:".concat(L.desc),L)}if(k.uid<=0||k.uid>=Math.pow(2,32))throw new Ib(iv.INVALID_UINT_UID_FROM_STRING_UID);return{requestTime:x,url:L,req:V,uid:k.uid,elapse:Date.now()-x}}catch(L){throw L}}(U,L,k,M),closeFn:L=>L.code===iv.OPERATION_ABORTED||L.code===iv.UNEXPECTED_RESPONSE&&!L.data.retry});return U}catch(L){throw L}}async function qx(L,k){const M=zA("WEBCS_DOMAIN").concat(zA("WEBCS_DOMAIN_BACKUP_LIST")).map((L=>({url:"https://".concat(L,"/api/v2/transpond/webrtc?v=2"),areaCode:mx(),serviceIds:[UO.CHOOSE_SERVER,UO.CLOUD_PROXY_FALLBACK]})));try{const U=await jx({referenceList:M,asyncMapHandler:M=>async function(L,k,M){let U,{url:x,areaCode:V,serviceIds:F}=L;const j=Date.now(),[z,Q]=Ux(k,V,F);let $=Rv.networkState;try{$&&Rv.networkState===gv.OFFLINE&&Rv.onlineWaiter&&await Mp.race([Rv.onlineWaiter,EA(Ov.maxRetryTimeout)]),$=Rv.networkState;const{data:L,headers:k}=await fx(x,{data:z,cancelToken:M,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);U="1"===k.http3?1:-1;const o=L=>{const k=[];if(L.response_body.forEach((M=>{const U=M.buffer.code;if(23===M.uri&&0===U&&!M.buffer.edges_services)if(4194310===M.buffer.flag)M.buffer.edges_services=[];else{const U={error:new Ib(iv.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:L.detail[502]}),flag:M.buffer.flag};k.push(U)}if(0!==U){const x=AO(U),V={error:new Ib(iv.CAN_NOT_GET_GATEWAY_SERVER,x.desc,{desc:x.desc,retry:x.retry,csIp:L.detail[502]}),flag:M.buffer.flag};4194310===M.buffer.flag?Eb.warning(V.error.toString()):k.push(V)}})),k.length)throw new Ib(iv.CAN_NOT_GET_GATEWAY_SERVER,k.map((L=>"flag: ".concat(L.flag,", message: ").concat(L.error.message))).join(" | "),{retry:!!k.find((L=>L.error.data.retry)),csIp:L.detail[502],desc:[...new Set(k.map((L=>{var k;return null==L||null===(k=L.error)||void 0===k||null===(k=k.data)||void 0===k?void 0:k.desc})).filter((L=>!!L)))]})};o(L);const V=ZO(L,UO.CHOOSE_SERVER),F=ZO(L,UO.CLOUD_PROXY_FALLBACK);return kx(V),{gatewayInfo:zO(V,x),proxyInfo:F,opid:Q,requestTime:j,url:x,isHttp3:U,elapse:Date.now()-j}}catch(L){throw L}}(M,L,k),closeFn:L=>L.code===iv.OPERATION_ABORTED||L.code===iv.CAN_NOT_GET_GATEWAY_SERVER&&!L.data.retry});return U}catch(L){throw L}}async function zx(L,k,M,U){const x=zA("PROXY_SERVER_TYPE3"),o=(L,k,M)=>{let U=M||x;return Array.isArray(U)&&(U=k%2==0?x[1]:x[0]),"https://".concat(U,"/ap/?url=").concat(L)};let V=null;const F=[],c=async()=>{const x=zA("WEBCS_DOMAIN").slice(0,zA("AJAX_REQUEST_CONCURRENT")).map(((k,M)=>{let U;return U="disabled"===L.cloudProxyServer&&L.proxyServer?o("".concat(k,"/api/v2/transpond/webrtc?v=2"),M,L.proxyServer):"disabled"===L.cloudProxyServer||"fallback"===L.cloudProxyServer?"https://".concat(k,"/api/v2/transpond/webrtc?v=2"):o("".concat(k,"/api/v2/transpond/webrtc?v=2"),M),{url:U,areaCode:mx(),serviceIds:[UO.CHOOSE_SERVER,"proxy5"===L.cloudProxyServer?UO.CLOUD_PROXY_5:"proxy3"===L.cloudProxyServer||"proxy4"===L.cloudProxyServer?UO.CLOUD_PROXY:UO.CLOUD_PROXY_FALLBACK]}})),V=U.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:x.map((L=>L.url))}),j=await Bx({fragementLength:zA("FRAGEMENT_LENGTH"),referenceList:x,asyncMapHandler:U=>(Eb.debug("[".concat(L.clientId,"] Connect to choose_server:"),U.url),Px(U,L,k,M)),allFailedhandler:L=>{throw U.recordJoinChannelService({endTs:Date.now(),status:"error",errors:L},V),L[0]},promisesCollector:F});return U.recordJoinChannelService({endTs:Date.now(),status:"success"},V),j},d=async()=>{if(await EA(1e3),null!==V)return V;const x=zA("WEBCS_DOMAIN_BACKUP_LIST").map(((k,M)=>{let U;return U="disabled"===L.cloudProxyServer&&L.proxyServer?o("".concat(k,"/api/v2/transpond/webrtc?v=2"),M,L.proxyServer):"disabled"===L.cloudProxyServer||"fallback"===L.cloudProxyServer?"https://".concat(k,"/api/v2/transpond/webrtc?v=2"):o("".concat(k,"/api/v2/transpond/webrtc?v=2"),M),{url:U,areaCode:mx(),serviceIds:[UO.CHOOSE_SERVER,"proxy5"===L.cloudProxyServer?UO.CLOUD_PROXY_5:"proxy3"===L.cloudProxyServer||"proxy4"===L.cloudProxyServer?UO.CLOUD_PROXY:UO.CLOUD_PROXY_FALLBACK]}})),j=U.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:x.map((L=>L.url))}),z=await Bx({fragementLength:zA("FRAGEMENT_LENGTH"),referenceList:x,asyncMapHandler:U=>(Eb.debug("[".concat(L.clientId,"] Connect to backup choose_server:"),U.url),Px(U,L,k,M)),allFailedhandler:L=>{throw U.recordJoinChannelService({endTs:Date.now(),status:"error",errors:L},j),L[0]},promisesCollector:F});return U.recordJoinChannelService({endTs:Date.now(),status:"success"},j),z};let j,z,Q;try{({gatewayInfo:j,proxyInfo:z,url:Q}=await Fx([c(),d()]))}catch(L){throw L[0]}if(F.length&&F.forEach((L=>L.cancel&&"function"==typeof L.cancel&&L.cancel())),!j||!z)throw new Ib(iv.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(L.apUrl=Q,"disabled"!==L.cloudProxyServer&&Array.isArray(x)&&Q){const k=/^https?:\/\/(.+?)(\/.*)?$/.exec(Q)[1];Sr(x).call(x,k)&&(L.proxyServer=k,Eb.setProxyServer(k),Ab.setProxyServer(k))}return V={gatewayInfo:j,proxyInfo:await $O(z,j.uid)},V}async function Xx(L,k,M){let U=null;const x=[],o=async V=>{const F=zA(V?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map((k=>L.proxyServer?"https://".concat(L.proxyServer,"/ap/?url=").concat(k+"/api/v2/transpond/webrtc?v=2"):"https://".concat(k,"/api/v2/transpond/webrtc?v=2")));return V&&(await EA(1e3),null!==U)?U:await Bx({fragementLength:zA("FRAGEMENT_LENGTH"),referenceList:F,asyncMapHandler:U=>(Eb.debug("[".concat(L.clientId,"] update ticket, Connect to ").concat(V?"backup":""," choose_server:"),U),function(L,k,M,U){const[x]=((L,k)=>{const M=Math.floor(Math.random()*10**12),U={appid:L.appId,client_ts:Date.now(),opid:M,sid:L.sid,request_bodies:[{uri:28,buffer:{cname:L.cname,detail:{1:"",6:L.stringUid,12:"1"},token:L.token,service_ids:k,uid:L.uid||0,edges_services:L.apResponse.addresses.map((L=>({ip:L.ip,port:L.port})))}}]},x=new FormData;return x.append("request",JSON.stringify(U)),[x,M]})(k,[UO.CHOOSE_SERVER]);let V=Rv.networkState;return PA((async()=>{V&&Rv.networkState===gv.OFFLINE&&Rv.onlineWaiter&&await Mp.race([Rv.onlineWaiter,EA(U&&U.maxRetryTimeout||Ov.maxRetryTimeout)]),V=Rv.networkState;return((L,k)=>{if(L.response_body&&L.response_body.length){const k=L.response_body[0];if(0!==k.buffer.code){const L=AO(k.buffer.code);throw new Ib(iv.UPDATE_TICKET_FAILED,"[".concat(k.buffer.code,"]: ").concat(L.desc),{retry:L.retry})}return k.buffer.ticket}throw Eb.debug("update ticket request received ap response without response body:",k),new Ib(iv.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})})(await fx(L,{data:x,cancelToken:M,headers:{"Content-Type":"multipart/form-data;"}},!0),L)}),(()=>!1),(L=>L.code!==iv.OPERATION_ABORTED&&(L.code===iv.UPDATE_TICKET_FAILED?L.data.retry:(Eb.warning("[".concat(k.clientId,"] update ticket network error, retry"),L),!0))),U)}(U,L,k,M)),allFailedhandler:L=>{throw L[0]},promisesCollector:x})};try{return U=await Fx([o(!1),o(!0)]),x.length&&x.forEach((L=>L.cancel&&"function"==typeof L.cancel&&L.cancel())),U}catch(L){throw L[0]}}function Qx(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function Zx(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?Qx(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):Qx(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}class $x extends My{get isSuccess(){return!!this.configs}constructor(){super(),xg(this,"configs",void 0),xg(this,"joinInfo",void 0),xg(this,"cancelToken",void 0),xg(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),xg(this,"interval",void 0),xg(this,"mutex",new wv("config-distribute")),xg(this,"mutableParamsRead",!1)}startGetConfigDistribute(L,k){this.joinInfo=L,this.cancelToken=k,this.interval&&this.stopGetConfigDistribute(),zA("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval((()=>{this.updateConfigDistribute()}),zA("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())()}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,Ab.reportApiInvoke(null,{options:void 0,name:dv.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:lv.TRACER}).onSuccess(JSON.stringify(eb))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void Eb.debug("[config-distribute] get config distribute interrupted have no joininfo");let L;const k=await this.mutex.lock();try{L=await async function Yx(L,k,M){const U=zA("CDS_AP").slice(0,zA("AJAX_REQUEST_CONCURRENT")).map((k=>L.proxyServer?"https://".concat(L.proxyServer,"/ap/?url=").concat(k+"/api/v1"):"https://".concat(k,"/api/v1?action=config"))),x=U.map((U=>function(L,k,M,U){const x=Gv(),V={flag:64,cipher_method:0,features:{device:x.name,system:x.os,system_general:navigator.userAgent,vendor:k.appId,version:Mv,cname:k.cname,sid:k.sid,session_id:k.sid,detail:"",proxyServer:k.proxyServer}};return PA((()=>fx(L,{data:V,timeout:1e3,cancelToken:M,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}})),void 0,(L=>L.code!==iv.OPERATION_ABORTED),U)}(U,L,k,M)));let V=null,F=null,j={};try{V=await Fx(x)}catch(L){if(L.code===iv.OPERATION_ABORTED)throw L;F=L}if(x.forEach((L=>L.cancel())),Ab.reportApiInvoke(L.sid,{name:dv.REQUEST_CONFIG_DISTRIBUTE,options:{error:F,res:V}}).onSuccess(),V&&V.test_tags)try{j=function(L){if(!L.test_tags)return{};const k=L.test_tags,M=Object.keys(k),U={};return M.forEach((L=>{var M;const x=l_(M=L.slice(4)).call(M),V=JSON.parse(k[L])[1];U[x]=V})),U}(V)}catch(L){}return j}(this.joinInfo,this.cancelToken,this.retryConfig),Eb.debug("[config-distribute] get config distribute",JSON.stringify(L)),L.limit_bitrate&&this.handleBitrateLimit(L.limit_bitrate),this.cacheGlobalParameterConfig(L),this.configs=L}catch(L){const k=new Ib(iv.NETWORK_RESPONSE_ERROR,L);Eb.warning("[config-distribute] ".concat(k.toString()))}finally{k()}}getBitrateLimit(){return this.configs?this.configs.limit_bitrate:void 0}handleBitrateLimit(L){var k;(k=L)&&k.uplink&&k.id&&void 0!==k.uplink.max_bitrate&&void 0!==k.uplink.min_bitrate&&(this.configs&&this.configs.limit_bitrate?this.configs&&this.configs.limit_bitrate&&this.configs.limit_bitrate.id!==L.id&&this.emit(iO.UPDATE_BITRATE_LIMIT,L):this.emit(iO.UPDATE_BITRATE_LIMIT,L))}getLowStreamConfigDistribute(){return this.configs&&this.configs.limit_bitrate&&Zx({},this.configs.limit_bitrate.low_stream_uplink)}cacheGlobalParameterConfig(L){var k;const M=gE(k=Object.keys(L).filter((L=>/^webrtc_ng_global_parameter/.test(L)))).call(k);for(let k=0;k<M.length;k++)for(let U=M.length-1;U>k;U--){const k=M[U];if("number"==typeof L[k].__priority){const x=L[k].__priority,V=M[U-1];if("number"==typeof L[V].__priority){if(!(x>L[V].__priority))continue;{const L=k;M[U]=M[U-1],M[U-1]=L}}else{const L=k;M[U]=M[U-1],M[U-1]=L}}}const U={};M.forEach((k=>{const M=L[k],x=M.__expires;Object.keys(M).forEach((L=>{"__priority"===L||"__expires"===L||Object.prototype.hasOwnProperty.call(U,L)||(U[L]=Zx({value:M[L]},x&&{expires:x}))}))}));try{!function(L){try{const k=Date.now();Object.keys(L).forEach((M=>{switch(M){case"ENABLE_EVENT_REPORT":case"UPLOAD_LOG":case"ENABLE_AG_ADAPTATION":case"FORCE_AG_HIGH_FRAMERATE":case"FORCE_SUPPORT_AG_ADAPTATION":case"ENCODER_CONFIG_LIMIT":case"CAMERA_CAPTURE_CONFIG":case"ENABLE_PRELOAD":if(Object.prototype.hasOwnProperty.call(jv,M)){const{value:U,expires:x}=L[M];if(x&&x<=k)return;eb[M]=U,jv[M]=U,Eb.debug("Update global parameters from config distribute",M,U)}}}))}catch(k){Eb.error("Error update config immediately: ".concat(L),k.message)}}(U);const L=JSON.stringify(U),k=window.btoa(L);window.localStorage.setItem("websdk_ng_global_parameter",k),Eb.debug("Caching global parameters ".concat(L))}catch(L){Eb.error("Error caching global parameters:",L.message)}}}class eV extends My{constructor(){super(...arguments),xg(this,"resultStorage",new Map)}setLocalAudioStats(L,k,M){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",L,this.checkAudioInputLevel(M,k)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",L,this.checkSendAudioBitrate(M,k))}setLocalVideoStats(L,k,M){this.record("SEND_VIDEO_BITRATE_TOO_LOW",L,this.checkSendVideoBitrate(M,k)),this.record("FRAMERATE_INPUT_TOO_LOW",L,this.checkFramerateInput(M,k)),this.record("FRAMERATE_SENT_TOO_LOW",L,this.checkFramerateSent(M))}setRemoteAudioStats(L,k){const M=L.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",M,this.checkAudioOutputLevel(k))}setRemoteVideoStats(L,k){const M=L.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",M,this.checkVideoDecode(k))}record(L,k,M){if(zA("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(L)||this.resultStorage.set(L,{result:[],isPrevNormal:!0});const U=this.resultStorage.get(L);if(U&&(U.result.push(M),U.result.length>=5)){var x;const M=Sr(x=U.result).call(x,!0);U.isPrevNormal&&!M&&this.emit("exception",Rx[L],L,k),!U.isPrevNormal&&M&&this.emit("exception",Rx[L]+2e3,L+"_RECOVER",k),U.isPrevNormal=M,U.result=[]}}checkAudioOutputLevel(L){return!(L.receiveBitrate>0&&0===L.receiveLevel)}checkAudioInputLevel(L,k){return k instanceof SM&&!k.isActive||!!k.muted||0!==L.sendVolumeLevel}checkFramerateInput(L,k){let M=null;k._encoderConfig&&k._encoderConfig.frameRate&&(M=JO(k._encoderConfig.frameRate));const U=L.captureFrameRate;return!M||!U||!(M>10&&U<5||M<10&&M>=5&&U<=1)}checkFramerateSent(L){return!(L.captureFrameRate&&L.sendFrameRate&&L.captureFrameRate>5&&L.sendFrameRate<=1)}checkSendVideoBitrate(L,k){return!!k.muted||0!==L.sendBitrate}checkSendAudioBitrate(L,k){return k instanceof SM&&!k.isActive||!!k.muted||0!==L.sendBitrate}checkVideoDecode(L){return 0===L.receiveBitrate||0!==L.decodeFrameRate}}const Rx={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003},Cx=new class{markSubscribeStart(L,k){performance.mark("agora-web-sdk/".concat(L,"/subscribe-").concat(k))}markPublishStart(L,k){performance.mark("agora-web-sdk/".concat(L,"/publish-").concat(k))}measureFromSubscribeStart(L,k){const M=performance.getEntriesByName("agora-web-sdk/".concat(L,"/subscribe-").concat(k));if(M.length>0){const L=M[M.length-1];return Math.round(performance.now()-L.startTime)}return 0}measureFromPublishStart(L,k){const M=performance.getEntriesByName("agora-web-sdk/".concat(L,"/publish-").concat(k));if(M.length>0){const L=M[M.length-1];return Math.round(performance.now()-L.startTime)}return 0}};var wx=i(Be.Object.getOwnPropertySymbols),Nx=wi,Mx=On.indexOf,xx=Bn,Vx=v([].indexOf),tV=!!Vx&&1/Vx([1],1,-0)<0;Nx({target:"Array",proto:!0,forced:tV||!xx("indexOf")},{indexOf:function(L){var k=arguments.length>1?arguments[1]:void 0;return tV?Vx(this,L,k)||0:Mx(this,L,k)}});var iV=Xi("Array").indexOf,nV=j,rV=iV,oV=Array.prototype,sV=i((function(L){var k=L.indexOf;return L===oV||nV(oV,L)&&k===oV.indexOf?rV:k}));function fV(L){if(Array.isArray(L))return L.map((L=>L));if(!mV(L))return L;const k={};for(const M in L){const U=L[M];mV(U)||Array.isArray(U)?k[M]=fV(U):k[M]=U}return k}function mV(L){return!("object"!=typeof L||Array.isArray(L)||!L)}class TV{constructor(L){xg(this,"input",[]),xg(this,"size",void 0),this.size=L}add(L){this.input.push(L),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return 0===this.input.length?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}}const aV={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},cV={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:aV,remoteCandidate:aV}},dV={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0,framesDroppedCount:0,outputFrameRate:0},lV={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},uV={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},hV={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packetsDiscarded:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0};function yV(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function AV(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?yV(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):yV(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}class bV{constructor(L,k){xg(this,"onFirstVideoReceived",void 0),xg(this,"onFirstVideoDecoded",void 0),xg(this,"onFirstAudioReceived",void 0),xg(this,"onFirstVideoDecodedTimeout",void 0),xg(this,"onFirstAudioDecoded",void 0),xg(this,"onSelectedLocalCandidateChanged",void 0),xg(this,"onSelectedRemoteCandidateChanged",void 0),xg(this,"videoIsReady",!1),xg(this,"videoIsReady2",{}),xg(this,"pc",void 0),xg(this,"options",void 0),xg(this,"intervalTimer",void 0),xg(this,"stats",fV(cV)),xg(this,"isFirstVideoReceived",{}),xg(this,"isFirstVideoDecoded",{}),xg(this,"isFirstAudioReceived",{}),xg(this,"isFirstAudioDecoded",{}),xg(this,"isFirstVideoDecodedTimeout",{}),xg(this,"lossRateWindowStats",[]),this.pc=L,this.options=k,this.intervalTimer=window.setInterval((async()=>{this.updateStats()}),this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new Mp((L=>{L({local:AV({},aV),remote:AV({},aV)})}))}setVideoIsReady(L){this.videoIsReady=L}setVideoIsReady2(L,k){this.videoIsReady2[L]=k}getVideoIsReady(L){return this.videoIsReady2[L]||!1}setIsFirstAudioDecoded(L){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(L){this.lossRateWindowStats.push(L),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const k=this.lossRateWindowStats.length,M=["videoSend","audioSend","videoRecv","audioRecv"];let U=0,x=0,V=0,F=0;for(const j of M)L[j].forEach(((L,M)=>{if(!this.lossRateWindowStats[k-1][j][M]||!this.lossRateWindowStats[0][j][M])return;const z=this.lossRateWindowStats[k-1][j][M].packets-this.lossRateWindowStats[0][j][M].packets,Q=this.lossRateWindowStats[k-1][j][M].packetsLost-this.lossRateWindowStats[0][j][M].packetsLost;"videoSend"===j||"audioSend"===j?(U+=z,V+=Q):(x+=z,F+=Q),Number.isNaN(z)||Number.isNaN(z)?L.packetLostRate=0:L.packetLostRate=z<=0||Q<=0?0:Q/(z+Q)}));L.sendPacketLossRate=U<=0||V<=0?0:V/(U+V),L.recvPacketLossRate=x<=0||F<=0?0:F/(x+F)}}function wV(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function OV(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?wV(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):wV(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}class NV extends bV{constructor(){super(...arguments),xg(this,"_stats",cV),xg(this,"lastDecodeVideoReceiverStats",new Map)}async updateStats(){const L=await this._getStats(),k=this.statsResponsesToObjects(L);this._stats=fV(cV);const M=k.filter((L=>"ssrc"===L.type));this.processSSRCStats(M);const U=k.find((L=>"VideoBwe"===L.type));U&&this.processBandwidthStats(U),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(L){this._stats.bitrate={actualEncoded:Number(L.googActualEncBitrate),targetEncoded:Number(L.googTargetEncBitrate),retransmit:Number(L.googRetransmitBitrate),transmit:Number(L.googTransmitBitrate)},this._stats.sendBandwidth=Number(L.googAvailableSendBandwidth)}processSSRCStats(L){L.forEach((L=>{var k;const M=Sr(k=L.id).call(k,"send");switch("".concat(L.mediaType,"_").concat(M?"send":"recv")){case"video_send":{const k=fV(lV);k.codec=L.googCodecName,k.adaptionChangeReason="none",L.googCpuLimitedResolution&&(k.adaptionChangeReason="cpu"),L.googBandwidthLimitedResolution&&(k.adaptionChangeReason="bandwidth"),k.avgEncodeMs=Number(L.googAvgEncodeMs),k.inputFrame={width:Number(L.googFrameWidthInput)||Number(L.googFrameWidthSent),height:Number(L.googFrameHeightInput)||Number(L.googFrameHeightSent),frameRate:Number(L.googFrameRateInput)},k.sentFrame={width:Number(L.googFrameWidthSent),height:Number(L.googFrameHeightSent),frameRate:Number(L.googFrameRateInput)},k.firsCount=Number(L.googFirReceived),k.nacksCount=Number(L.googNacksReceived),k.plisCount=Number(L.googPlisReceived),k.frameCount=Number(L.framesEncoded),k.bytes=Number(L.bytesSent),k.packets=Number(L.packetsSent),k.packetsLost=Number(L.packetsLost),k.ssrc=Number(L.ssrc),k.rttMs=Number(L.googRtt||0),this._stats.videoSend.push(k),this._stats.rtt=k.rttMs;break}case"video_recv":{const k=fV(dV),M=this.lastDecodeVideoReceiverStats.get(Number(L.ssrc));if(k.codec=L.googCodecName,k.targetDelayMs=Number(L.googTargetDelayMs),k.renderDelayMs=Number(L.googRenderDelayMs),k.currentDelayMs=Number(L.googCurrentDelayMs),k.minPlayoutDelayMs=Number(L.googMinPlayoutDelayMs),k.decodeMs=Number(L.googDecodeMs),k.maxDecodeMs=Number(L.googMaxDecodeMs),k.receivedFrame={width:Number(L.googFrameWidthReceived),height:Number(L.googFrameHeightReceived),frameRate:Number(L.googFrameRateReceived)},k.decodedFrame={width:Number(L.googFrameWidthReceived),height:Number(L.googFrameHeightReceived),frameRate:Number(L.googFrameRateDecoded)},k.decodeFrameRate=Number(L.googFrameRateDecoded),k.outputFrame={width:Number(L.googFrameWidthReceived),height:Number(L.googFrameHeightReceived),frameRate:Number(L.googFrameRateOutput)},k.jitterBufferMs=Number(L.googJitterBufferMs),k.firsCount=Number(L.googFirsSent),k.nacksCount=Number(L.googNacksSent),k.plisCount=Number(L.googPlisSent),k.framesDecodeCount=Number(L.framesDecoded),k.bytes=Number(L.bytesReceived),k.packets=Number(L.packetsReceived),k.packetsLost=Number(L.packetsLost),k.ssrc=Number(L.ssrc),k.packets>0&&!this.isFirstVideoReceived[k.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(k.ssrc),this.isFirstVideoReceived[k.ssrc]=!0),k.framesDecodeCount>0&&!this.isFirstVideoDecoded[k.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(k.ssrc,k.decodedFrame.width,k.decodedFrame.height),this.isFirstVideoDecoded[k.ssrc]=!0),M){const U=M.stats,x=Date.now()-M.lts;k.framesDecodeFreezeTime=U.framesDecodeFreezeTime,k.framesDecodeInterval=U.framesDecodeInterval,k.framesDecodeCount>U.framesDecodeCount&&this.isFirstVideoDecoded[k.ssrc]?(M.lts=Date.now(),k.framesDecodeInterval=x,k.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(L.ssrc,10))?k.framesDecodeFreezeTime+=k.framesDecodeInterval:this.setVideoIsReady2(parseInt(L.ssrc,10),!0))):k.framesDecodeCount<M.stats.framesDecodeCount&&(k.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(k.ssrc,{stats:OV({},k),lts:Date.now()}),this._stats.videoRecv.push(k);break}case"audio_recv":{const k=fV(hV);k.codec=L.googCodecName,k.outputLevel=Math.abs(Number(L.audioOutputLevel))/32767,k.decodingCNG=Number(L.googDecodingCNG),k.decodingCTN=Number(L.googDecodingCTN),k.decodingCTSG=Number(L.googDecodingCTSG),k.decodingNormal=Number(L.googDecodingNormal),k.decodingPLC=Number(L.googDecodingPLC),k.decodingPLCCNG=Number(L.googDecodingPLCCNG),k.expandRate=Number(L.googExpandRate),k.accelerateRate=Number(L.googAccelerateRate),k.preemptiveExpandRate=Number(L.googPreemptiveExpandRate),k.secondaryDecodedRate=Number(L.googSecondaryDecodedRate),k.speechExpandRate=Number(L.googSpeechExpandRate),k.preferredJitterBufferMs=Number(L.googPreferredJitterBufferMs),k.jitterBufferMs=Number(L.googJitterBufferMs),k.jitterMs=Number(L.googJitterReceived),k.bytes=Number(L.bytesReceived),k.packets=Number(L.packetsReceived),k.packetsLost=Number(L.packetsLost),k.ssrc=Number(L.ssrc),k.receivedFrames=Number(L.googDecodingCTN)||Number(L.packetsReceived),k.droppedFrames=Number(L.googDecodingPLC)+Number(L.googDecodingPLCCNG)||Number(L.packetsLost),k.receivedFrames>0&&!this.isFirstAudioReceived[k.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(k.ssrc),this.isFirstAudioReceived[k.ssrc]=!0),k.decodingNormal>0&&!this.isFirstAudioDecoded[k.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(k.ssrc),this.isFirstAudioDecoded[k.ssrc]=!0),this._stats.audioRecv.push(k);break}case"audio_send":{const k=fV(uV);k.codec=L.googCodecName,k.inputLevel=Math.abs(Number(L.audioInputLevel))/32767,k.aecReturnLoss=Number(L.googEchoCancellationReturnLoss||0),k.aecReturnLossEnhancement=Number(L.googEchoCancellationReturnLossEnhancement||0),k.residualEchoLikelihood=Number(L.googResidualEchoLikelihood||0),k.residualEchoLikelihoodRecentMax=Number(L.googResidualEchoLikelihoodRecentMax||0),k.bytes=Number(L.bytesSent),k.packets=Number(L.packetsSent),k.packetsLost=Number(L.packetsLost),k.ssrc=Number(L.ssrc),k.rttMs=Number(L.googRtt||0),this._stats.rtt=k.rttMs,this._stats.audioSend.push(k);break}}}))}_getStats(){return new Mp(((L,k)=>{this.pc.getStats(L,k)}))}statsResponsesToObjects(L){const k=[];return L.result().forEach((L=>{const M={id:L.id,timestamp:L.timestamp.valueOf().toString(),type:L.type};L.names().forEach((k=>{M[k]=L.stat(k)})),k.push(M)})),k}}function DV(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function PV(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?DV(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):DV(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}class LV extends bV{constructor(){super(...arguments),xg(this,"_stats",cV),xg(this,"report",void 0),xg(this,"lastDecodeVideoReceiverStats",new Map),xg(this,"lastVideoFramesRecv",new Map),xg(this,"lastVideoFramesSent",new Map),xg(this,"lastVideoFramesDecode",new Map),xg(this,"lastVideoFramesOutput",new Map),xg(this,"lastVideoJBDelay",new Map),xg(this,"lastAudioJBDelay",new Map),xg(this,"mediaBytesSent",new Map),xg(this,"mediaBytesRetransmit",new Map),xg(this,"mediaBytesTargetEncode",new Map),xg(this,"lastEncoderMs",new Map)}async updateStats(){this.report=await this.pc.getStats(),this._stats=fV(cV),this.report.forEach((L=>{switch(L.type){case Sw.OUTBOUND:case Sw.INBOUND:{const k=L.mediaType||L.kind,M=!k&&"frameWidth"in L,U=!k&&!("frameWidth"in L);L.type===Sw.OUTBOUND?"audio"===k||U?this.processAudioOutboundStats(L):("video"===k||M)&&this.processVideoOutboundStats(L):L.type===Sw.INBOUND&&("audio"===k||U?this.processAudioInboundStats(L):("video"===k||M)&&this.processVideoInboundStats(L));break}case Sw.TRANSPORT:{const k=this.report.get(L.selectedCandidatePairId);k&&this.processCandidatePairStats(k);break}case Sw.CANDIDATE_PAIR:L.selected&&this.processCandidatePairStats(L)}})),this.updateSendBitrate(),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){const L=await this.pc.getStats(),k={local:PV({},aV),remote:PV({},aV)};return L.forEach((M=>{let U;if(M.type===Sw.TRANSPORT&&(U=L.get(M.selectedCandidatePairId)),M.type===Sw.CANDIDATE_PAIR&&M.selected&&(U=M),U){const i=(L,k)=>{L.type=k.type,L.id=k.id,k.address&&(L.address=k.address),k.candidateType&&(L.candidateType=k.candidateType),k.port&&(L.port=k.port),k.priority&&(L.priority=k.priority),k.protocol&&(L.protocol=k.protocol),k.relayProtocol&&(L.relayProtocol=k.relayProtocol)};if(U.localCandidateId){const M=L.get(U.localCandidateId);M&&i(k.local,M)}if(U.remoteCandidateId){const M=L.get(U.remoteCandidateId);M&&i(k.remote,M)}}})),k}processCandidatePairStats(L){if(this._stats.sendBandwidth=L.availableOutgoingBitrate||0,L.currentRoundTripTime&&(this._stats.rtt=1e3*L.currentRoundTripTime),this._stats.videoSend.forEach((k=>{L.currentRoundTripTime&&(k.rttMs=1e3*L.currentRoundTripTime)})),this._stats.audioSend.forEach((k=>{L.currentRoundTripTime&&(k.rttMs=1e3*L.currentRoundTripTime)})),this._stats.selectedCandidatePair.id=L.id,L.localCandidateId){const k=this.report.get(L.localCandidateId);k&&this.processCandidateStats(k)}if(L.remoteCandidateId){const k=this.report.get(L.remoteCandidateId);k&&this.processCandidateStats(k)}}processCandidateStats(L){let k;L.type===Sw.LOCAL_CANDIDATE&&(k=this._stats.selectedCandidatePair.localCandidate),L.type===Sw.REMOTE_CANDIDATE&&(k=this._stats.selectedCandidatePair.remoteCandidate),k&&(k.type=L.type,k.id=L.id,L.address&&(k.address=L.address),L.candidateType&&(k.candidateType=L.candidateType),L.port&&(k.port=L.port),L.priority&&(k.priority=L.priority),L.protocol&&(k.protocol=L.protocol),L.relayProtocol&&(k.relayProtocol=L.relayProtocol),L.type===Sw.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==k.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(PV({},k),PV({},this.stats.selectedCandidatePair.localCandidate)),L.type===Sw.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==k.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(PV({},k),PV({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(L){let k=this._stats.audioRecv.find((k=>k.ssrc===L.ssrc));k||(k=fV(hV),this._stats.audioRecv.push(k)),k.ssrc=L.ssrc,k.packets=L.packetsReceived,k.packetsLost=L.packetsLost,k.packetsDiscarded=L.packetsDiscarded,k.bytes=L.bytesReceived,k.jitterMs=1e3*L.jitter,this.processAudioTrackReceiverStats(L,L.trackId,k),L.codecId&&(k.codec=this.getCodecFromCodecStats(L.codecId)),k.receivedFrames||(k.receivedFrames=L.packetsReceived),k.droppedFrames||(k.droppedFrames=L.packetsLost),k.receivedFrames>0&&!this.isFirstAudioReceived[k.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(k.ssrc),this.isFirstAudioReceived[k.ssrc]=!0),k.outputLevel&&k.outputLevel>0&&!this.isFirstAudioDecoded[k.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(k.ssrc),this.isFirstAudioDecoded[k.ssrc]=!0),"number"==typeof L.concealedSamples&&(k.concealedSamples=L.concealedSamples)}processVideoInboundStats(L){let k=this._stats.videoRecv.find((k=>k.ssrc===L.ssrc));k||(k=fV(dV),this._stats.videoRecv.push(k)),k.ssrc=L.ssrc,k.packets=L.packetsReceived,k.packetsLost=L.packetsLost,k.bytes=L.bytesReceived,k.firsCount=L.firCount,k.nacksCount=L.nackCount,k.plisCount=L.pliCount,k.framesDecodeCount=L.framesDecoded,k.framesDroppedCount=L.framesDropped,k.totalInterFrameDelay=L.totalInterFrameDelay,k.totalSquaredInterFrameDelay=L.totalSquaredInterFrameDelay,k.totalFreezesDuration=L.totalFreezesDuration;const M=this.lastDecodeVideoReceiverStats.get(k.ssrc),U=this.lastVideoFramesDecode.get(k.ssrc),x=this.lastVideoFramesOutput.get(k.ssrc),V=Date.now();if(k.framesDecodeCount>0&&!this.isFirstVideoDecoded[k.ssrc]){const L=k.decodedFrame?k.decodedFrame.width:0,M=k.decodedFrame?k.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(k.ssrc,L,M),this.isFirstVideoDecoded[k.ssrc]=!0}if(M){const U=M.stats,x=V-M.lts;k.framesDecodeFreezeTime=U.framesDecodeFreezeTime,k.framesDecodeInterval=U.framesDecodeInterval,!this.isFirstVideoDecoded[k.ssrc]&&x>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[k.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(k.ssrc),this.isFirstVideoDecodedTimeout[k.ssrc]=!0),k.framesDecodeCount>U.framesDecodeCount&&this.isFirstVideoDecoded[k.ssrc]?(M.lts=Date.now(),k.framesDecodeInterval=x,k.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(L.ssrc))?k.framesDecodeFreezeTime+=k.framesDecodeInterval:this.setVideoIsReady2(parseInt(L.ssrc,10),!0))):k.framesDecodeCount<U.framesDecodeCount&&(k.framesDecodeInterval=0),L.framesDecoded&&L.qpSum&&(M.stats.framesDecodeCount>L.framesDecoded?k.qpSumPerFrame=L.qpSum/L.framesDecoded:k.qpSumPerFrame=(L.qpSum-M.qpSum)/(L.framesDecoded-M.stats.framesDecodeCount))}U&&V-U.lts>=800?(k.decodeFrameRate=Math.round((k.framesDecodeCount-U.count)/((V-U.lts)/1e3)),this.lastVideoFramesDecode.set(k.ssrc,{count:k.framesDecodeCount,lts:V,rate:k.decodeFrameRate})):U?k.decodeFrameRate=U.rate:this.lastVideoFramesDecode.set(k.ssrc,{count:k.framesDecodeCount,lts:V,rate:0}),k.framesDroppedCount&&L.framesReceived&&(x&&V-x.lts>=800?(k.outputFrameRate=Math.round((L.framesReceived-k.framesDroppedCount-x.count)/((V-x.lts)/1e3)),this.lastVideoFramesOutput.set(k.ssrc,{count:L.framesReceived-k.framesDroppedCount,lts:V,rate:Math.max(k.outputFrameRate,0)})):x?k.outputFrameRate=x.rate:this.lastVideoFramesOutput.set(k.ssrc,{count:L.framesReceived-k.framesDroppedCount,lts:V,rate:0})),L.totalDecodeTime&&(k.decodeMs=1e3*L.totalDecodeTime),this.processVideoTrackReceiverStats(L,L.trackId,k),L.codecId&&(k.codec=this.getCodecFromCodecStats(L.codecId)),L.framerateMean&&(k.framesRateFirefox=L.framerateMean),k.packets>0&&!this.isFirstVideoReceived[k.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(k.ssrc),this.isFirstVideoReceived[k.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(k.ssrc,{stats:PV({},k),lts:M?M.lts:Date.now(),qpSum:L.qpSum})}processVideoOutboundStats(L){let k=this._stats.videoSend.find((k=>k.ssrc===L.ssrc));k||(k=fV(lV),this._stats.videoSend.push(k));const M=this.mediaBytesSent.get(L.ssrc);if(M)M.add(L.bytesSent);else{const k=new TV(10);k.add(L.bytesSent),this.mediaBytesSent.set(L.ssrc,k)}if(void 0!==L.retransmittedBytesSent){const k=this.mediaBytesRetransmit.get(L.ssrc);if(k)k.add(L.retransmittedBytesSent);else{const k=new TV(10);k.add(L.retransmittedBytesSent),this.mediaBytesRetransmit.set(L.ssrc,k)}}if(L.totalEncodedBytesTarget){const k=this.mediaBytesTargetEncode.get(L.ssrc);if(k)k.add(L.totalEncodedBytesTarget);else{const k=new TV(10);k.add(L.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(L.ssrc,k)}}if(k.ssrc=L.ssrc,k.bytes=L.bytesSent,k.packets=L.packetsSent,k.firsCount=L.firCount,k.nacksCount=L.nackCount,k.plisCount=L.pliCount,k.frameCount=L.framesEncoded,k.adaptionChangeReason=L.qualityLimitationReason,k.scalabilityMode=L.scalabilityMode,L.totalEncodeTime&&L.framesEncoded){const M=this.lastEncoderMs.get(L.ssrc);if(!M||M.lastFrameCount>L.framesEncoded)k.avgEncodeMs=1e3*L.totalEncodeTime/L.framesEncoded;else{const U=L.framesEncoded-M.lastFrameCount,x=L.totalEncodeTime-M.lastEncoderTime;k.avgEncodeMs=1e3*x/U}}if(L.framesEncoded&&L.qpSum){const M=this.lastEncoderMs.get(L.ssrc);!M||M.lastFrameCount>L.framesEncoded?k.qpSumPerFrame=L.qpSum/L.framesEncoded:k.qpSumPerFrame=(L.qpSum-M.lastQpSum)/(L.framesEncoded-M.lastFrameCount)}if(this.lastEncoderMs.set(L.ssrc,{lastFrameCount:L.framesEncoded,lastEncoderTime:L.totalEncodeTime,lastQpSum:L.qpSum,lts:Date.now()}),L.codecId&&(k.codec=this.getCodecFromCodecStats(L.codecId)),L.mediaSourceId&&this.processVideoMediaSource(L.mediaSourceId,k),this.processVideoTrackSenderStats(L,L.trackId,k),L.remoteId)this.processRemoteInboundStats(L.remoteId,k);else{const M=this.findRemoteStatsId(L.ssrc,Sw.REMOTE_INBOUND);M&&this.processRemoteInboundStats(M,k)}}processAudioOutboundStats(L){let k=this._stats.audioSend.find((k=>k.ssrc===L.ssrc));if(k||(k=fV(uV),this._stats.audioSend.push(k)),k.ssrc=L.ssrc,k.packets=L.packetsSent,k.bytes=L.bytesSent,L.mediaSourceId&&this.processAudioMediaSource(L.mediaSourceId,k),L.codecId&&(k.codec=this.getCodecFromCodecStats(L.codecId)),this.processAudioTrackSenderStats(L,L.trackId,k),L.remoteId)this.processRemoteInboundStats(L.remoteId,k);else{const M=this.findRemoteStatsId(L.ssrc,Sw.REMOTE_INBOUND);M&&this.processRemoteInboundStats(M,k)}}findRemoteStatsId(L,k){var M;const U=Array.from(dN(M=this.report).call(M)).find((M=>M.type===k&&M.ssrc===L));return U?U.id:null}processVideoMediaSource(L,k){const M=this.report.get(L);M&&M.width&&M.height&&M.framesPerSecond&&(k.inputFrame={width:M.width,height:M.height,frameRate:M.framesPerSecond})}processAudioMediaSource(L,k){const M=this.report.get(L);M&&(k.inputLevel=M.audioLevel)}processVideoTrackSenderStats(L,k,M){var U,x,V,F;const j=k?this.report.get(k):void 0,z=null!==(U=null==j?void 0:j.framesSent)&&void 0!==U?U:L.framesSent;if("number"!=typeof z)return;let Q=null!==(x=null==j?void 0:j.frameWidth)&&void 0!==x?x:L.frameWidth,$=null!==(V=null==j?void 0:j.frameHeight)&&void 0!==V?V:L.frameHeight,ee=null!==(F=null==j?void 0:j.framesPerSecond)&&void 0!==F?F:L.framesPerSecond;if("number"==typeof Q&&"number"==typeof $||(Q=0,$=0),null==ee){const L=Date.now(),k=this.lastVideoFramesSent.get(M.ssrc);k&&L-k.lts>=800?(ee=Math.round((z-k.count)/((L-k.lts)/1e3)),this.lastVideoFramesSent.set(M.ssrc,{count:z,lts:L,rate:ee})):k?ee=k.rate:this.lastVideoFramesSent.set(M.ssrc,{count:z,lts:L,rate:0})}M.sentFrame={width:Q,height:$,frameRate:Math.max(0,ee)}}processVideoTrackReceiverStats(L,k,M){var U,x,V,F,j;const z=k?this.report.get(k):void 0,Q=null!==(U=null==z?void 0:z.framesReceived)&&void 0!==U?U:L.framesReceived,$=null!==(x=null==z?void 0:z.frameWidth)&&void 0!==x?x:L.frameWidth,ee=null!==(V=null==z?void 0:z.frameHeight)&&void 0!==V?V:L.frameHeight,te=null!==(F=null==z?void 0:z.jitterBufferDelay)&&void 0!==F?F:L.jitterBufferDelay,ie=null!==(j=null==z?void 0:z.jitterBufferEmittedCount)&&void 0!==j?j:L.jitterBufferEmittedCount;if("number"==typeof Q){const L=this.lastVideoFramesRecv.get(M.ssrc),k=Date.now();M.framesReceivedCount=Q;let U=0;L&&k-L.lts>=800?(U=Math.round((Q-L.count)/((k-L.lts)/1e3)),this.lastVideoFramesRecv.set(M.ssrc,{count:Q,lts:k,rate:U})):L?U=L.rate:this.lastVideoFramesRecv.set(M.ssrc,{count:Q,lts:k,rate:0}),M.receivedFrame={width:$||0,height:ee||0,frameRate:U||0},M.decodedFrame={width:$||0,height:ee||0,frameRate:M.decodeFrameRate||0},M.outputFrame={width:$||0,height:ee||0,frameRate:M.outputFrameRate||M.decodeFrameRate||0}}if(te&&ie){const L=this.lastVideoJBDelay.get(M.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let k=L.jitterBufferMs;const U=ie-L.jitterBufferEmittedCount;U>0&&(k=1e3*(te-L.jitterBufferDelay)/U),M.jitterBufferMs=k,M.currentDelayMs=Math.round(k),this.lastVideoJBDelay.set(M.ssrc,{jitterBufferDelay:te,jitterBufferEmittedCount:ie,jitterBufferMs:M.currentDelayMs})}}processAudioTrackSenderStats(L,k,M){var U,x,V,F;const j=k?this.report.get(k):void 0,z=null!==(U=null!==(x=null==j?void 0:j.echoReturnLoss)&&void 0!==x?x:L.echoReturnLoss)&&void 0!==U?U:0,Q=null!==(V=null!==(F=null==j?void 0:j.echoReturnLossEnhancement)&&void 0!==F?F:L.echoReturnLossEnhancement)&&void 0!==V?V:0;M.aecReturnLoss=z,M.aecReturnLossEnhancement=Q}processAudioTrackReceiverStats(L,k,M){var U,x,V,F,j,z,Q;const $=k?this.report.get(k):void 0,ee=null!==(U=null==$?void 0:$.removedSamplesForAcceleration)&&void 0!==U?U:L.removedSamplesForAcceleration,te=null!==(x=null==$?void 0:$.totalSamplesReceived)&&void 0!==x?x:L.totalSamplesReceived,ie=null!==(V=null==$?void 0:$.jitterBufferDelay)&&void 0!==V?V:L.jitterBufferDelay,ne=null!==(F=null==$?void 0:$.jitterBufferEmittedCount)&&void 0!==F?F:L.jitterBufferEmittedCount,re=null!==(j=null==$?void 0:$.audioLevel)&&void 0!==j?j:null==L?void 0:L.audioLevel,oe=null!==(z=null==$?void 0:$.totalSamplesDuration)&&void 0!==z?z:null==L?void 0:L.totalSamplesDuration,ce=null!==(Q=null==$?void 0:$.concealedSamples)&&void 0!==Q?Q:L.concealedSamples;if(ee&&te&&(M.accelerateRate=ee/te),ie&&ne){const L=this.lastAudioJBDelay.get(M.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let k=L.jitterBufferMs;const U=ne-L.jitterBufferEmittedCount;U>0&&(k=1e3*(ie-L.jitterBufferDelay)/U),M.jitterBufferMs=Math.round(k),this.lastAudioJBDelay.set(M.ssrc,{jitterBufferDelay:ie,jitterBufferEmittedCount:ne,jitterBufferMs:M.jitterBufferMs})}M.outputLevel=re;let de=1920;oe&&te&&(de=te/oe/50,M.receivedFrames=Math.round(te/de)),ce&&(M.droppedFrames=Math.round(ce/de))}processRemoteInboundStats(L,k){const M=this.report.get(L);M&&(k.packetsLost=M.packetsLost,M.roundTripTime&&(k.rttMs=1e3*M.roundTripTime),M.jitter&&(k.jitterMs=1e3*M.jitter),M.timestamp&&(k.timestamp=M.timestamp))}getCodecFromCodecStats(L){const k=this.report.get(L);if(!k)return"";const M=k.mimeType.match(/\/(.*)$/);return M&&M[1]?M[1]:""}updateSendBitrate(){let L=0,k=null,M=null;this.mediaBytesSent.forEach((k=>{L+=k.diffMean()})),this.mediaBytesRetransmit.forEach((L=>{k=null===k?L.diffMean():k+L.diffMean()})),this.mediaBytesTargetEncode.forEach((L=>{M=null===M?L.diffMean():M+L.diffMean()}));const U=null!==k?L-k:L;this._stats.bitrate={actualEncoded:8*U/(this.options.updateInterval/1e3),transmit:8*L/(this.options.updateInterval/1e3)},null!==k&&(this._stats.bitrate.retransmit=8*k/(this.options.updateInterval/1e3)),null!==M&&(this._stats.bitrate.targetEncoded=8*M/(this.options.updateInterval/1e3))}}class kV extends bV{updateStats(){return Mp.resolve()}}function MV(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:250,M=arguments.length>2&&void 0!==arguments[2]?arguments[2]:8,U=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,x=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1e4;const V=function(){const L=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return L&&L[0]?Number(L[0].split("/")[1]):null}();return V?V<76?new NV(L,{updateInterval:k,lossRateInterval:M,freezeRateLimit:U,firstVideoDecodedTimeout:x}):new LV(L,{updateInterval:k,lossRateInterval:M,freezeRateLimit:U,firstVideoDecodedTimeout:x}):function(L){if(!window.RTCStatsReport)return!1;const k=L.getStats();return!!(k instanceof Mp||function(L){return!!L&&("object"==typeof L||"function"==typeof L)&&"function"==typeof L.then}(k))}(L)?new LV(L,{updateInterval:k,lossRateInterval:M,freezeRateLimit:U,firstVideoDecodedTimeout:x}):new kV(L,{updateInterval:k,lossRateInterval:M,freezeRateLimit:U,firstVideoDecodedTimeout:x})}let pV=class{get localCapabilities(){return rA(this._localCapabilities)}get rtpCapabilities(){return rA(this._rtpCapabilities)}get candidates(){return rA(this._candidates)}get iceParameters(){return rA(this._iceParameters)}get dtlsParameters(){return rA(this._dtlsParameters)}constructor(L){xg(this,"sessionDesc",void 0),xg(this,"_localCapabilities",void 0),xg(this,"_rtpCapabilities",void 0),xg(this,"_candidates",void 0),xg(this,"_iceParameters",void 0),xg(this,"_dtlsParameters",void 0),xg(this,"setup",void 0),xg(this,"currentMidIndex",void 0),xg(this,"cname","o/i14u9pJrxRKAsu"),xg(this,"firefoxSsrcMidMap",new Map),L=rA(L);const{remoteIceParameters:k,remoteDtlsParameters:M,candidates:U,remoteRTPCapabilities:x,localCapabilities:V,direction:F,setup:j,videoCodec:z,audioCodec:Q}=L;let $;this.setup=j,$=F===Dw.RECEIVE_ONLY?wU.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=extmap-allow-mixed\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n"):wU.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=extmap-allow-mixed\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=recvonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=recvonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n"),this._rtpCapabilities=x,this._candidates=U,this._iceParameters=k,this._dtlsParameters=M,this._localCapabilities=V;const ee=F===Dw.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,te=F===Dw.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,ie=F===Dw.RECEIVE_ONLY?x.send.videoCodecs:rx(nO.VIDEO,ee,te,z),ne=F===Dw.RECEIVE_ONLY?x.send.audioCodecs:rx(nO.AUDIO,ee,te,Q);for(const L of $.mediaDescriptions)L.attributes.iceUfrag=k.iceUfrag,L.attributes.icePwd=k.icePwd,L.attributes.fingerprints=M.fingerprints,L.attributes.candidates=U,L.attributes.setup=this.setup,"application"===L.media.mediaType&&(L.attributes.sctpPort="5000"),"video"===L.media.mediaType&&(L.media.fmts=ie.map((L=>L.payloadType.toString(10))),L.attributes.payloads=ie,L.attributes.extmaps=ee.videoExtensions),"audio"===L.media.mediaType&&(L.media.fmts=ne.map((L=>L.payloadType.toString(10))),L.attributes.payloads=ne,L.attributes.extmaps=ee.audioExtensions,nx(L));this.sessionDesc=$,this.currentMidIndex=$.mediaDescriptions.length-1}toString(){return wU.print(this.sessionDesc)}hasMid(L){return Array.isArray(L)?L.every((L=>this.hasMid(L))):this.sessionDesc.mediaDescriptions.some((k=>k.attributes.mid===L))}send(L,k,M,U,x){M=M.replace(/ /g,"-");const{ssrcs:V,ssrcGroups:F}=YU(k,this.cname,zA("SYNC_GROUP")?M:void 0),j=this.findPreloadMediaDesc(V);if(j){if(Xv()&&this.firefoxSsrcMidMap.set(V[0].ssrcId,j.attributes.mid),x&&(x.twcc||x.remb)){const L=this.sessionDesc.mediaDescriptions.indexOf(j);return this.sessionDesc.mediaDescriptions[L]=this.mungSendMediaDesc(j,x),{mid:j.attributes.mid,needExchangeSDP:!0}}return{mid:j.attributes.mid,needExchangeSDP:!1}}{const k=this.findAvailableMediaIndex(L,V,U);let M;return-1===k?(M=this.createOrRecycleSendMedia(L,V,F,"sendonly",U,x),this.updateBundleMids()):(M=rA(this.sessionDesc.mediaDescriptions[k]),M.attributes.direction="sendonly",M.attributes.ssrcs=V,M.attributes.ssrcGroups=F,this.sessionDesc.mediaDescriptions[k]=this.mungSendMediaDesc(M,x)),Xv()&&this.firefoxSsrcMidMap.set(V[0].ssrcId,M.attributes.mid),{needExchangeSDP:!0,mid:M.attributes.mid}}}stopSending(L){const k=this.sessionDesc.mediaDescriptions.filter((k=>k.attributes.mid&&-1!==L.indexOf(k.attributes.mid)));if(k.length!==L.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");k.forEach((L=>{L.attributes.ssrcs=[]})),this.updateBundleMids()}receive(L,k,M){const U=[];return L.forEach((L=>{const x=L._mediaStreamTrack.kind,V=this.findAvailableRecvMediaIndex(x);let F,j=!1;-1===V?(j=!0,F=this.createOrRecycleRecvMedia(L,[],"recvonly",k,M),this.updateBundleMids()):(F=rA(this.sessionDesc.mediaDescriptions[V]),F.attributes.direction="recvonly"),U.push({mid:F.attributes.mid,needCreateTransceiver:j})})),U}stopReceiving(L){const k=this.sessionDesc.mediaDescriptions.filter((k=>-1!==L.indexOf(k.attributes.mid)));if(k.length!==L.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");k.forEach((L=>{L.media.port="0",L.attributes.direction="inactive"})),this.updateBundleMids()}addRemoteCandidate(L){const{foundation:k,protocol:M,address:U,port:x,type:V,relatedAddress:F,relatedPort:j,priority:z}=new RTCIceCandidate(L),Q={foundation:null!=k?k:"",componentId:"1",transport:null!=M?M:"",priority:z?z+"":"",connectionAddress:null!=U?U:"",port:x?x+"":"",type:V?V+"":"",relAddr:null!=F?F:"",relPort:j?j+"":"",extension:{}};this.candidates.some((L=>L.priority===Q.priority&&L.connectionAddress===Q.connectionAddress&&L.port===Q.port))||(this._candidates.push(Q),this.sessionDesc.mediaDescriptions.forEach((L=>{L.attributes.candidates=this.candidates})))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(L,k,M,U,x){const V=L._mediaStreamTrack.kind,F=this.rtpCapabilities.recv,j=rx(V,F,this.localCapabilities.send,V===nO.AUDIO?x:U),z=V===nO.VIDEO?F.videoExtensions:F.audioExtensions,Q="".concat(++this.currentMidIndex);let $={media:{mediaType:V,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:j.map((L=>L.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:z,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:k,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:j,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:M,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(Q)}};$=this.mungRecvMediaDsec($,L);const ee=this.findFirstClosedMedia(V);if(ee){const L=this.sessionDesc.mediaDescriptions.indexOf(ee);this.sessionDesc.mediaDescriptions[L]=$}else this.sessionDesc.mediaDescriptions.push($);return $}muteRemote(L){const k=this.sessionDesc.mediaDescriptions.filter((k=>Sr(L).call(L,k.attributes.mid||"")));if(k.length!==L.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");k.forEach((L=>{L.attributes.direction="inactive"}))}unmuteRemote(L){const k=this.sessionDesc.mediaDescriptions.filter((k=>Sr(L).call(L,k.attributes.mid||"")));if(k.length!==L.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");k.forEach((L=>{L.attributes.direction="recvonly"}))}findAvailableMediaIndex(L,k,M){return this.sessionDesc.mediaDescriptions.findIndex((U=>{const x=U.media.mediaType===L&&"0"!==U.media.port&&("sendonly"===U.attributes.direction||"sendrecv"===U.attributes.direction)&&0===U.attributes.ssrcs.length;if(Xv()){if(x){const L=this.firefoxSsrcMidMap.get(k[0].ssrcId);return!(L||"0"!==U.attributes.mid&&"1"!==U.attributes.mid)||!(!L||L!==U.attributes.mid)}return!1}return x&&U.attributes.mid===M}))}findAvailableRecvMediaIndex(L){return this.sessionDesc.mediaDescriptions.findIndex((k=>{const M=k.media.mediaType===L&&"0"!==k.media.port&&("recvonly"===k.attributes.direction||"sendrecv"===k.attributes.direction);return"0"!==k.attributes.mid&&"1"!==k.attributes.mid&&M}))}predictReceivingMids(L){const k=[];for(let M=0;M<L;M++)k.push((this.currentMidIndex+M+1).toString(10));return k}restartICE(L){L=rA(L),this._iceParameters=L,this.sessionDesc.mediaDescriptions.forEach((k=>{k.attributes.iceUfrag=L.iceUfrag,k.attributes.icePwd=L.icePwd}))}createOrRecycleSendMedia(L,k,M,U,x,V){const F=this.rtpCapabilities.send,j=L===nO.VIDEO?F.videoCodecs:F.audioCodecs,z=L===nO.VIDEO?F.videoExtensions:F.audioExtensions;Xv()&&(x="".concat(++this.currentMidIndex));let Q={media:{mediaType:L,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:j.map((L=>L.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:z,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:k,ssrcGroups:M,rtcpFeedbackWildcards:[],payloads:j,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:U,rtcpMux:!0,rtcpRsize:!0,mid:x}};Q=this.mungSendMediaDesc(Q,V);const $=this.findFirstClosedMedia(L);if($){const L=this.sessionDesc.mediaDescriptions.indexOf($);this.sessionDesc.mediaDescriptions[L]=Q}else this.sessionDesc.mediaDescriptions.push(Q);return Q}mungRecvMediaDsec(L,k,M){const U=rA(L);return zU(U),qU(U,k),JU(U,k),XU(U),QU(U,M,this.localCapabilities.send),U}mungSendMediaDesc(L,k){const M=rA(L);return QU(M,k,this.localCapabilities.recv),nx(M),M}updateRecvMedia(L,k){const M=this.sessionDesc.mediaDescriptions.findIndex((k=>k.attributes.mid===L));if(-1!==M){const L=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[M],k);this.sessionDesc.mediaDescriptions[M]=L}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((L=>"0"!==L.media.port)).map((L=>L.attributes.mid))}findPreloadMediaDesc(L){return this.sessionDesc.mediaDescriptions.find((k=>{var M;return(null===(M=k.attributes)||void 0===M||null===(M=M.ssrcs[0])||void 0===M?void 0:M.ssrcId)===L[0].ssrcId}))}findFirstClosedMedia(L){return this.sessionDesc.mediaDescriptions.find((k=>Xv()?"0"===k.media.port&&k.media.mediaType===L:"0"===k.media.port))}};const _V=["sdp"];var gV;function FV(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function BV(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?FV(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):FV(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}let SV=(gV=class e extends oO{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var L,k;return null!==(L=null===(k=this.peerConnection.getReceivers()[0])||void 0===k||null===(k=k.transport)||void 0===k?void 0:k.state)&&void 0!==L?L:null}get localCodecs(){return[]}set isInRestartIce(L){this._isInRestartIce=L}get isInRestartIce(){return this._isInRestartIce}constructor(L,k,M){super(L,k),xg(this,"direction",void 0),xg(this,"name",void 0),xg(this,"store",void 0),xg(this,"spec",void 0),xg(this,"peerConnection",void 0),xg(this,"initialOffer",void 0),xg(this,"transport",void 0),xg(this,"statsFilter",void 0),xg(this,"localCandidateCount",0),xg(this,"_isInRestartIce",!1),xg(this,"mutex",new wv("P2PConnection-mutex")),xg(this,"onLocalCandidate",void 0),xg(this,"remoteSDP",void 0),xg(this,"pendingCandidates",[]),xg(this,"localCapabilities",void 0),xg(this,"isReady",!1),xg(this,"restartCnt",0),xg(this,"curTurnServerIndex",0),this.store=k,this.spec=L,this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(L,k.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=null!=M?M:Dw.SEND_ONLY,this.name=this.direction===Dw.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=MV(this.peerConnection,zA("STATS_UPDATE_INTERVAL"),void 0,Xv()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(L){try{const k=await $U();if(this.localCapabilities=ix(k),L){const{sdp:k}=L,M=function EV(L,k){if(null==L)return{};var M,U,x=function(L,k){if(null==L)return{};var M,U,x={},V=jb(L);for(U=0;U<V.length;U++)M=V[U],sV(k).call(k,M)>=0||(x[M]=L[M]);return x}(L,k);if(wx){var V=wx(L);for(U=0;U<V.length;U++)M=V[U],sV(k).call(k,M)>=0||Object.prototype.propertyIsEnumerable.call(L,M)&&(x[M]=L[M])}return x}(L,_V),U=function(){const L={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},k=jU(arguments.length>2?arguments[2]:void 0,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},"sendonly"),M={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},U={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},x={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(tx(k,L,"videoExtensions",M,U,x),tx(k,L,"videoCodecs",M,U,x),tx(k,L,"audioExtensions",M,U,x),tx(k,L,"audioCodecs",M,U,x),zA("RAISE_H264_BASELINE_PRIORITY")){const L=x.videoCodecs.findIndex((L=>L.rtpMap&&"h264"===L.rtpMap.encodingName.toLocaleLowerCase()&&L.fmtp&&"42001f"===L.fmtp.parameters["profile-level-id"]));if(-1!==L){const k=x.videoCodecs.findIndex((L=>L.rtpMap&&"h264"===L.rtpMap.encodingName.toLocaleLowerCase()));if(k<L){Eb.debug("raising H264 baseline profile priority");const M=x.videoCodecs[L];x.videoCodecs.splice(L,1),x.videoCodecs.splice(k,0,M)}-1!==k&&zA("FILTER_SEND_H264_BASELINE")&&(M.videoCodecs=M.videoCodecs.filter((L=>!(L.rtpMap&&"h264"===L.rtpMap.encodingName.toLocaleLowerCase()&&L.fmtp&&"42001f"!==L.fmtp.parameters["profile-level-id"]))))}}return{send:M,recv:U,sendrecv:x}}({},{},k);this.remoteSDP=new pV({remoteIceParameters:M.iceParameters,remoteDtlsParameters:M.dtlsParameters,candidates:[],remoteRTPCapabilities:U,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;const x=await this.peerConnection.createAnswer();if(!x.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");const V=GU(x.sdp);await this.peerConnection.setLocalDescription(x);const F=await ex({},{},x.sdp);this.localCapabilities=ix(F);const j=this.peerConnection.getTransceivers()[0];return null!=j&&j.receiver&&j.receiver.transport&&this.tryBindTransportEvents(j.receiver.transport),BV(BV({},V),{},{sdp:x.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});const L=await this.peerConnection.createOffer();if(!L.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const k=GU(L.sdp);return this.initialOffer=L,BV(BV({},k),{},{sdp:L.sdp})}}catch(L){throw new nv(iv.GET_LOCAL_CONNECTION_PARAMS_FAILED,L.toString())}}async connect(L){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);const{sdp:k,iceParameters:M,dtlsParameters:U}=L,x=await ex({},{},k);this.remoteSDP=new pV({remoteIceParameters:M,remoteDtlsParameters:U,candidates:[],remoteRTPCapabilities:x,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});const V=this.peerConnection.getTransceivers()[0];null!=V&&V.sender&&V.sender.transport&&this.tryBindTransportEvents(V.sender.transport)}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(L.toString()))}}async addRemoteCandidate(L){try{L&&this.pendingCandidates.push(L),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach((L=>{this.peerConnection.addIceCandidate(L)})),this.pendingCandidates=[])}catch(L){throw new nv(iv.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(L.toString()))}}send(L,k,M){var U=this;return HI((function*(){const x=yield KI(U.mutex.lock("From P2PConnection.send"));try{if(!U.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const V=[],F=U.remoteSDP.receive(L,k,M);L.forEach(((L,k)=>{if(F[k].needCreateTransceiver){const k=U.peerConnection.addTransceiver(L._mediaStreamTrack,{direction:"sendonly"});V.push(k),L._updateRtpTransceiver(k)}else{const M=U.peerConnection.getTransceivers().find((L=>L.mid===F[k].mid));if(!M)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(F[k].mid));V.push(M),L._updateRtpTransceiver(M)}})),Xv()&&!0===zA("SIMULCAST")&&(yield KI(U.applySimulcastForFirefox(V,L)));const j=F.map((L=>L.mid)),z=yield KI(U.peerConnection.createOffer()),Q=U.mungSendOfferSDP(z.sdp,L,j),$=wU.parse(Q),ee=j.map((L=>{const k=$.mediaDescriptions.find((k=>k.attributes.mid===L));if(!k)throw new Error("Cannot extract ssrc from mediaDescription.");return WU(k,zA("USE_PUB_RTX"))})),te=V.map(((L,k)=>{const M=j[k];return{localSSRC:ee[k],id:M}}));yield KI(U.peerConnection.setLocalDescription({type:"offer",sdp:Q}));try{yield te}catch(L){const k=U.remoteSDP.toString();throw yield KI(U.peerConnection.setLocalDescription({type:"offer",sdp:Q})),yield KI(U.peerConnection.setRemoteDescription({type:"answer",sdp:k})),yield KI(U.stopSending(j,!0)),L}yield KI(U.applySimulcastEncodings(V,L)),yield KI(U.applySendEncodings(V,L));const ie=U.remoteSDP.toString(),ne=U.logSDPExchange(Q,"offer","local","send");return null==ne||ne(ie),yield KI(U.setRemoteDescription({type:"answer",sdp:ie})),V.map(((L,k)=>{const M=j[k];return{localSSRC:ee[k],id:M}}))}catch(L){throw L instanceof nv?L:new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(L.toString()))}finally{x()}}))()}async stopSending(L,k){const M=k?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const k=this.peerConnection.getTransceivers().filter((k=>-1!==L.indexOf(k.mid)));if(k.length!==L.length)throw new Error("Transceivers' length (".concat(k.length,") doesn't match mids' length (").concat(L.length,") when trying to call P2PConnection.stopSending."));k.map((L=>{var k;L.direction="inactive",null===(k=L.stop)||void 0===k||k.call(L)}));const U=await this.peerConnection.createOffer(),x=this.logSDPExchange(U.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(U),this.remoteSDP.stopReceiving(L);const V=this.remoteSDP.toString();null==x||x(V),await this.setRemoteDescription({type:"answer",sdp:V})}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(L.toString()))}finally{M&&M()}}async receive(L,k,M,U){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(L," before remoteSDP created."));const{mid:x,needExchangeSDP:V}=this.remoteSDP.send(L,k,M,U);if(V){const k=this.remoteSDP.toString(),M=this.logSDPExchange(k,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:k});const U=await this.peerConnection.createAnswer(),V=this.mungReceiveAnswerSDP(U.sdp,x,L);null==M||M(V||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:V}),Eb.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(L," by exchanging SDP."))}else Eb.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(L," no need to exchange SDP."));const F=this.peerConnection.getTransceivers().find((L=>L.mid===x));if(!F||null===F.mid)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:F.receiver.track,mid:F.mid,transceiver:F}}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(L.toString()))}}async mockReceive(L,k,M,U){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(L," before remoteSDP created."));const{mid:x,needExchangeSDP:V}=this.remoteSDP.send(L,k,M,U);if(V){const k=this.remoteSDP.toString(),M=this.logSDPExchange(k,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:k});const U=await this.peerConnection.createAnswer(),V=this.mungReceiveAnswerSDP(U.sdp,x,L);null==M||M(V||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:V}),Eb.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(L," by exchanging SDP."))}else Eb.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(L," no need to exchange SDP."))}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(L.toString()))}}async stopReceiving(L){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(L);const k=this.remoteSDP.toString(),M=this.logSDPExchange(k,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:k});const U=await this.peerConnection.createAnswer();null==M||M(U.sdp||""),await this.peerConnection.setLocalDescription(U)}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(L.toString()))}}async restartICE(L){try{if(this.store.p2pTransport===xv.Auto&&(this.store.p2pTransport=xv.SdRtn,XP().supportPCSetConfiguration&&this.peerConnection.setConfiguration(e.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,XP().supportPCSetConfiguration&&this.peerConnection.setConfiguration(e.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!L){this.restartCnt++,this.isReady=!1;const L=await this.peerConnection.createOffer({iceRestart:!0});if(!L.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const{iceParameters:k}=GU(L.sdp);return this.store.descriptionStart(),this.direction===Dw.SEND_ONLY&&await this.peerConnection.setLocalDescription(L),k}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(L),this.store.descriptionStart(),this.direction===Dw.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});const L=await this.peerConnection.createAnswer();if(!L.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");const{iceParameters:k}=GU(L.sdp);return await this.peerConnection.setLocalDescription(L),k}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(L.toString()))}}close(){var L;this.peerConnection.close(),this.peerConnection.onicecandidate=null,null===(L=this.onConnectionStateChange)||void 0===L||L.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(L){return this.statsFilter.getVideoIsReady(L)}async updateEncoderConfig(L,k){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const M=await this.peerConnection.createOffer(),U=this.mungSendOfferSDP(M.sdp,[k],[L]);this.remoteSDP.updateRecvMedia(L,k);const x=this.remoteSDP.toString(),V=this.logSDPExchange(U,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:U}),null==V||V(x),await this.peerConnection.setRemoteDescription({type:"answer",sdp:x})}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,L.toString())}}async updateSendParameters(L,k){const M=this.peerConnection.getTransceivers().filter((k=>k.mid===L));1===M.length&&(this.isVP8Simulcast(k)?Xv()||await this.applySimulcastEncodings(M,[k]):await this.applySendEncodings(M,[k]))}setStatsRemoteVideoIsReady(L,k){this.statsFilter.setVideoIsReady2(L,k)}async replaceTrack(L,k){const M=this.peerConnection.getTransceivers().find((L=>L.mid===k));M&&await M.sender.replaceTrack(L._mediaStreamTrack)}async getSelectedCandidatePair(){const L=this.peerConnection.getReceivers();if(L.length>0&&L[0].transport&&L[0].transport.iceTransport&&L[0].transport.iceTransport.getSelectedCandidatePair&&L[0].transport.iceTransport.getSelectedCandidatePair()){const k=L[0].transport.iceTransport,{local:M,remote:U}=k.getSelectedCandidatePair();return{local:BV(BV({},aV),{},{candidateType:M.type,protocol:M.protocol,address:M.address,port:M.port}),remote:BV(BV({},aV),{},{candidateType:U.type,protocol:U.protocol,address:U.address,port:U.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var L,k;Sr(L=["connected","completed"]).call(L,this.peerConnection.iceConnectionState)&&(this.isReady=!1),null===(k=this.onICEConnectionStateChange)||void 0===k||k.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var L;"connected"===this.peerConnection.connectionState&&(this.restartCnt=0),null===(L=this.onConnectionStateChange)||void 0===L||L.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=L=>{var k;L.candidate?(L.candidate.candidate&&(null===(k=this.onLocalCandidate)||void 0===k||k.call(this,L.candidate.toJSON())),this.localCandidateCount+=1):Eb.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount)})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(L,k){let M=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const U={iceServers:[]};var x;return L.iceServers?U.iceServers=L.iceServers:L.turnServer&&"off"!==L.turnServer.mode&&(Wy(L.turnServer.servers)?U.iceServers=L.turnServer.servers:(U.iceServers&&U.iceServers.push(...e.turnServerConfigToIceServers(L.turnServer.servers,k,M)),zA("USE_TURN_SERVER_OF_GATEWAY")&&U.iceServers&&L.turnServer.serversFromGateway&&U.iceServers.push(...e.turnServerConfigToIceServers(L.turnServer.serversFromGateway,k,M)),Sr(x=[xv.Relay,xv.SdRtn]).call(x,k)&&(U.iceTransportPolicy="relay"),zA("FORCE_TURN_TCP")?U.iceTransportPolicy="relay":L.turnServer.servers.concat(L.turnServer.serversFromGateway||[]).forEach((L=>{L.forceturn&&(U.iceTransportPolicy="relay")})))),zA("ENABLE_ENCODED_TRANSFORM")&&XP().supportWebRTCEncodedTransform&&(U.encodedInsertableStreams=!0),Eb.debug("P2PConnection p2pTransport is ".concat(k)),U}static turnServerConfigToIceServers(L,k){let M=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const U=[],x=L.filter((L=>L.tcpport));Eb.debug("P2PConnection turnServers is ".concat(x,", current index is ").concat(M));const V=x.length>M?x[M]:x[0];switch(k){case xv.SdRtn:const k=L.filter((L=>{var k;return Sr(k=L.username).call(k,"glb:")&&L.turnServerURL==L.turnServerURL})),x=k.length>M?k[M]:k[0];x&&(U.push({username:x.username,credential:x.password,credentialType:"password",urls:"turn:".concat(qO(x.turnServerURL),":").concat(x.tcpport,"?transport=udp")}),U.push({username:x.username,credential:x.password,credentialType:"password",urls:"turns:".concat(qO(x.turnServerURL),":").concat(x.tcpport,"?transport=tcp")}));break;case xv.Relay:V&&(U.push({username:V.username,credential:V.password,credentialType:"password",urls:"turn:".concat(V.turnServerURL,":").concat(V.tcpport,"?transport=udp")}),U.push({username:V.username,credential:V.password,credentialType:"password",urls:"turns:".concat(qO(V.turnServerURL),":").concat(V.tcpport,"?transport=tcp")}));break;default:V&&(U.push({username:V.username,credential:V.password,credentialType:"password",urls:"turn:".concat(V.turnServerURL,":").concat(V.tcpport,"?transport=udp")}),U.push({username:V.username,credential:V.password,credentialType:"password",urls:"turns:".concat(qO(V.turnServerURL),":").concat(V.tcpport,"?transport=tcp")}),U.push({username:V.username,credential:V.password,credentialType:"password",urls:"stun:".concat(V.turnServerURL,":").concat(V.tcpport)}))}return U}tryBindTransportEvents(L){if(L){this.transport=L,L.onstatechange=()=>{var k;null!=L&&L.state&&(null===(k=this.onDTLSTransportStateChange)||void 0===k||k.call(this,L.state))},L.onerror=L=>{var k;null===(k=this.onDTLSTransportError)||void 0===k||k.call(this,"error"in L?L.error:L)};const k=L.iceTransport;k&&(k.onstatechange=()=>{const k=null==L?void 0:L.iceTransport.state;var M;k&&(null===(M=this.onICETransportStateChange)||void 0===M||M.call(this,k))},k.getSelectedCandidatePair&&(k.onselectedcandidatepairchange=()=>{if(k.getSelectedCandidatePair()){const{local:L,remote:M}=k.getSelectedCandidatePair();Eb.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:L.type,protocol:L.protocol}),", remote ").concat(JSON.stringify({candidateType:M.type,protocol:M.protocol,address:M.address,port:M.port})," )"))}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(L,k){var M;if(k||(k=this.peerConnection.getSenders().find((k=>k.track===L._mediaStreamTrack))),!k)return Eb.warn("[".concat(L.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(L))return Eb.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!XP().supportSetRtpSenderParameters)return Eb.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const U={},x={};switch(L._optimizationMode){case"motion":U.degradationPreference="maintain-framerate";break;case"detail":U.degradationPreference="maintain-resolution";break;default:U.degradationPreference="balanced"}if(L._encoderConfig){var V;const{bitrateMax:k,frameRate:M,scaleResolutionDownBy:U}=L._encoderConfig;k&&(x.maxBitrate=1e3*k),Sr(V=L._hints).call(V,sL.LOW_STREAM)&&(M&&(x.maxFramerate=JO(M)),U&&U>=1&&(x.scaleResolutionDownBy=U))}if(zA("DSCP_TYPE")&&py()){var F;const L=zA("DSCP_TYPE");Sr(F=["very-low","low","medium","high"]).call(F,L)&&(x.networkPriority=L)}const j=k.getParameters(),z=null===(M=j.encodings)||void 0===M?void 0:M[0];Xv()&&!z&&(U.encodings=[x]),z&&Object.assign(z,x),Object.assign(j,U),Eb.debug("[".concat(L.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(j.encodings))),await k.setParameters(j)}async applySendEncodings(L,k){try{if(!XP().supportSetRtpSenderParameters)return;if(L.length!==k.length)return;for(let M=0;M<L.length;M++){const U=L[M],x=k[M];x instanceof eU&&!this.isVP8Simulcast(x)&&await this.updateRtpSenderEncodings(x,U.sender)}}catch(L){Eb.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(L,k,M){const U=wU.parse(L);return k.forEach(((L,k)=>{const x=M[k],V=U.mediaDescriptions.find((L=>L.attributes.mid===x));V&&(qU(V,L),ZU(V,L,this.store.codec))})),wU.print(U)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=L=>{var k;null===(k=this.onFirstAudioReceived)||void 0===k||k.call(this,L)},this.statsFilter.onFirstVideoReceived=L=>{var k;null===(k=this.onFirstVideoReceived)||void 0===k||k.call(this,L)},this.statsFilter.onFirstAudioDecoded=L=>{var k;null===(k=this.onFirstAudioDecoded)||void 0===k||k.call(this,L)},this.statsFilter.onFirstVideoDecoded=(L,k,M)=>{var U;null===(U=this.onFirstVideoDecoded)||void 0===U||U.call(this,L,k,M)},this.statsFilter.onSelectedLocalCandidateChanged=(L,k)=>{var M;null===(M=this.onSelectedLocalCandidateChanged)||void 0===M||M.call(this,L,k)},this.statsFilter.onSelectedRemoteCandidateChanged=(L,k)=>{var M;null===(M=this.onSelectedRemoteCandidateChanged)||void 0===M||M.call(this,L,k)},this.statsFilter.onFirstVideoDecodedTimeout=L=>{var k;null===(k=this.onFirstVideoDecodedTimeout)||void 0===k||k.call(this,L)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(L,k){if(L.length===k.length)for(let j=0;j<L.length;j++){var M,U,x,V,F;const z=L[j],Q=k[j];if(Q instanceof eU&&!Sr(M=Q._hints).call(M,sL.LOW_STREAM)&&null!==(U=Q._encoderConfig)&&void 0!==U&&U.bitrateMax&&(null===(x=Q._encoderConfig)||void 0===x?void 0:x.bitrateMax)>200&&null!==(V=Q._scalabilityMode)&&void 0!==V&&V.numSpatialLayers&&(null===(F=Q._scalabilityMode)||void 0===F?void 0:F.numSpatialLayers)>1&&"vp8"===this.store.codec){const L={},k={high:1e3*(Q._encoderConfig.bitrateMax-50),medium:5e4};L.encodings=[{rid:"m",active:!0,maxBitrate:k.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:k.high}];const M=z.sender.getParameters();await z.sender.setParameters(Object.assign(M,L))}}}async applySimulcastEncodings(L,k){if(!Xv()&&L.length===k.length)for(let M=0;M<L.length;M++){const U=k[M];if(U instanceof eU&&this.isVP8Simulcast(U)){const k=L[M],x={},V={high:1e3*(U._encoderConfig.bitrateMax-50),medium:5e4};x.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:V.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:V.medium,scaleResolutionDownBy:4}];const F=k.sender.getParameters();await k.sender.setParameters(Object.assign(F,x))}}}isVP8Simulcast(L){var k,M,U,x,V;return!!(L instanceof eU&&zA("SIMULCAST")&&"vp8"===this.store.codec&&!Sr(k=L._hints).call(k,sL.LOW_STREAM)&&null!==(M=L._encoderConfig)&&void 0!==M&&M.bitrateMax&&(null===(U=L._encoderConfig)||void 0===U?void 0:U.bitrateMax)>200&&null!==(x=L._scalabilityMode)&&void 0!==x&&x.numSpatialLayers&&(null===(V=L._scalabilityMode)||void 0===V?void 0:V.numSpatialLayers)>1)}logSDPExchange(L,k,M,U){if(zA("SDP_LOGGING"))return Eb.upload("[".concat(this.store.clientId,"] exchanging ").concat(M," ").concat(k," SDP during P2PConnection.").concat(U,"\n"),L),"offer"===k?L=>{this.logSDPExchange(L,"answer","local"===M?"remote":"local",U)}:void 0}async muteLocal(L){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const k=this.peerConnection.getTransceivers().filter((k=>k.mid&&-1!==L.indexOf(k.mid)));if(k.length!==L.length)throw new Error("Transceivers' length doesn't match mids' length.");k.map((L=>{L.direction="inactive"}));const M=await this.peerConnection.createOffer(),U=this.logSDPExchange(M.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(M),this.remoteSDP.muteRemote(L);const x=this.remoteSDP.toString();null==U||U(x),await this.setRemoteDescription({type:"answer",sdp:x})}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(L.toString()))}}async unmuteLocal(L){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const k=this.peerConnection.getTransceivers().filter((k=>k.mid&&-1!==L.indexOf(k.mid)));if(k.length!==L.length)throw new Error("Transceivers' length doesn't match mids' length.");k.map((async L=>{L.direction="sendonly"}));const M=await this.peerConnection.createOffer(),U=this.logSDPExchange(M.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(M),this.remoteSDP.unmuteRemote(L);const x=this.remoteSDP.toString();null==U||U(x),await this.setRemoteDescription({type:"answer",sdp:x})}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(L.toString()))}}async getRemoteSSRC(L,k){var M,U;if(k=null!==(M=k)&&void 0!==M?M:null===(U=this.currentRemoteDescription)||void 0===U?void 0:U.sdp){var x;const M=null===(x=wU.parse(k).mediaDescriptions.find((k=>k.attributes.mid===L)))||void 0===x?void 0:x.attributes.ssrcs;return null==M?void 0:M[0].ssrcId}}async setRemoteDescription(L){var k;await this.peerConnection.setRemoteDescription(L),Sr(k=["connected","completed"]).call(k,this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())}mungReceiveAnswerSDP(L,k,M){const U=wU.parse(L),x=U.mediaDescriptions.find((L=>L.attributes.mid===k));return x&&M===nO.AUDIO&&"audio"===x.media.mediaType&&nx(x),wU.print(U)}},gw(gV.prototype,"establish",[GV],Object.getOwnPropertyDescriptor(gV.prototype,"establish"),gV.prototype),gw(gV.prototype,"connect",[GV],Object.getOwnPropertyDescriptor(gV.prototype,"connect"),gV.prototype),gw(gV.prototype,"receive",[GV],Object.getOwnPropertyDescriptor(gV.prototype,"receive"),gV.prototype),gw(gV.prototype,"mockReceive",[GV],Object.getOwnPropertyDescriptor(gV.prototype,"mockReceive"),gV.prototype),gw(gV.prototype,"stopReceiving",[GV],Object.getOwnPropertyDescriptor(gV.prototype,"stopReceiving"),gV.prototype),gw(gV.prototype,"restartICE",[GV],Object.getOwnPropertyDescriptor(gV.prototype,"restartICE"),gV.prototype),gw(gV.prototype,"close",[GV],Object.getOwnPropertyDescriptor(gV.prototype,"close"),gV.prototype),gw(gV.prototype,"updateEncoderConfig",[GV],Object.getOwnPropertyDescriptor(gV.prototype,"updateEncoderConfig"),gV.prototype),gw(gV.prototype,"updateSendParameters",[GV],Object.getOwnPropertyDescriptor(gV.prototype,"updateSendParameters"),gV.prototype),gw(gV.prototype,"replaceTrack",[GV],Object.getOwnPropertyDescriptor(gV.prototype,"replaceTrack"),gV.prototype),gw(gV.prototype,"muteLocal",[GV],Object.getOwnPropertyDescriptor(gV.prototype,"muteLocal"),gV.prototype),gw(gV.prototype,"unmuteLocal",[GV],Object.getOwnPropertyDescriptor(gV.prototype,"unmuteLocal"),gV.prototype),gV);function GV(L,k,M){const U=L[k];if("function"!=typeof U)throw new Error("Cannot use mutex on object property.");return M.value=async function(){const L=this.mutex,M=await L.lock("From P2PConnection.".concat(k));try{for(var x=arguments.length,V=new Array(x),F=0;F<x;F++)V[F]=arguments[F];return await U.apply(this,V)}finally{M()}},M}function WV(L,k){let M=document.createElement("video"),U=document.createElement("canvas");M.setAttribute("style","display:none"),U.setAttribute("style","display:none"),M.setAttribute("muted",""),M.muted=!0,M.setAttribute("autoplay",""),M.autoplay=!0,M.setAttribute("playsinline",""),U.width=JO(k.width),U.height=JO(k.height);const x=JO(k.framerate||15);document.body.append(M),document.body.append(U);let V=L._mediaStreamTrack;M.srcObject=new MediaStream([V]),M.play();const F=U.getContext("2d");if(!F)throw new Ib(iv.UNEXPECTED_ERROR,"can not get canvas context");const j=XP(),z=U.captureStream(j.supportRequestFrame?0:x).getVideoTracks()[0];z.canvas||(z.canvas=U),U.startCapture=()=>{if(!M)return U.stopCapture&&U.stopCapture();if(M.paused&&M.play(),M.videoHeight>2&&M.videoWidth>2){const L=M.videoWidth,k=M.videoHeight/L,x=U.width*k;Math.abs(x-U.height)>=2&&(Eb.debug("adjust low stream resolution","".concat(U.width,"x").concat(U.height," -> ").concat(U.width,"x").concat(x)),U.height=x)}F.drawImage(M,0,0,U.width,U.height),z.requestFrame&&z.requestFrame(),V!==L._mediaStreamTrack&&(V=L._mediaStreamTrack,M.srcObject=new MediaStream([V]))},U.stopCapture=JL((()=>U.startCapture&&U.startCapture()),x);const Q=z.stop;return z.stop=()=>{Q.call(z),M&&(M.remove(),M.srcObject=null,M=null),U&&(U.width=0,U.remove(),U.stopCapture&&U.stopCapture(),U.startCapture=void 0,U.stopCapture=void 0,U=null),Eb.debug("clean low stream renderer")},z}var RV=function(L){return L[L.HEIGHT=2033]="HEIGHT",L[L.FRAME_RATE=2034]="FRAME_RATE",L[L.WIDTH=2035]="WIDTH",L}(RV||{}),IV=function(L){return L[L.FRAME_RATE=2002]="FRAME_RATE",L[L.WIDTH=2003]="WIDTH",L[L.HEIGHT=2004]="HEIGHT",L[L.PACKAGE_LOST=2005]="PACKAGE_LOST",L[L.AVG_ENCODE=2007]="AVG_ENCODE",L[L.NACKS=2009]="NACKS",L[L.PLIS=2010]="PLIS",L[L.FIRS=2011]="FIRS",L[L.BITRATE=2012]="BITRATE",L[L.PACKAGE_RATE=2031]="PACKAGE_RATE",L[L.ADAPTATION=2032]="ADAPTATION",L[L.ACTUAL_ENCODED=2060]="ACTUAL_ENCODED",L[L.BANDWIDTH=2061]="BANDWIDTH",L[L.RETRANSMIT=2062]="RETRANSMIT",L[L.TARGET_ENCODED=2064]="TARGET_ENCODED",L[L.TRANSMIT=2066]="TRANSMIT",L[L.FREEZE=2082]="FREEZE",L[L.DISABLED=2095]="DISABLED",L[L.PLAYER_STATUS=2128]="PLAYER_STATUS",L[L.QP_SUM=2143]="QP_SUM",L}(IV||{}),CV=function(L){return L[L.BITRATE=2069]="BITRATE",L[L.PACKAGE_LOST=2070]="PACKAGE_LOST",L[L.PACKAGE_RATE=2071]="PACKAGE_RATE",L[L.HEIGHT=2073]="HEIGHT",L[L.FRAME_RATE=2075]="FRAME_RATE",L[L.WIDTH=2077]="WIDTH",L}(CV||{}),vV=function(L){return L[L.JITTER=-1]="JITTER",L[L.PACKAGE_LOST=2014]="PACKAGE_LOST",L[L.WIDTH=2018]="WIDTH",L[L.HEIGHT=2019]="HEIGHT",L[L.FRAME_RATE=2020]="FRAME_RATE",L[L.JITTER_BUFFER=2023]="JITTER_BUFFER",L[L.CURRENT_DELAY=2024]="CURRENT_DELAY",L[L.NACKS=2026]="NACKS",L[L.PLIS=2027]="PLIS",L[L.FIRS=2028]="FIRS",L[L.BITRATE=2029]="BITRATE",L[L.PACKAGE_RATE=2078]="PACKAGE_RATE",L[L.FREEZE=2084]="FREEZE",L[L.DISABLED=2101]="DISABLED",L[L.PLAYER_STATUS=2129]="PLAYER_STATUS",L[L.QP_SUM=2144]="QP_SUM",L[L.I_FRAME_DELAY=2149]="I_FRAME_DELAY",L}(vV||{}),UV=function(L){return L[L.FRAME_RATE_DECODE=2021]="FRAME_RATE_DECODE",L[L.FRAME_RATE_RENDER=2022]="FRAME_RATE_RENDER",L[L.FRAME_RATE_OUTPUT=2155]="FRAME_RATE_OUTPUT",L[L.FREEZE_TIME=2109]="FREEZE_TIME",L[L.FREEZE_TIME_RENDER=2147]="FREEZE_TIME_RENDER",L[L.FREEZE_DURATION=2156]="FREEZE_DURATION",L}(UV||{}),xV=function(L){return L[L.PCM_LEVEL=2104]="PCM_LEVEL",L}(xV||{}),VV=function(L){return L[L.PACKAGE_LOST=-1]="PACKAGE_LOST",L[L.LEVEL=2038]="LEVEL",L[L.BITRATE=2039]="BITRATE",L[L.PACKAGE_RATE=2040]="PACKAGE_RATE",L[L.AEC_RETURN_LOSS=2041]="AEC_RETURN_LOSS",L[L.AEC_RETURN_LOSS_ENH=2042]="AEC_RETURN_LOSS_ENH",L[L.FREEZE=2081]="FREEZE",L[L.DISABLED=2096]="DISABLED",L}(VV||{}),jV=function(L){return L[L.BITRATE=2044]="BITRATE",L[L.PACKAGE_LOST=2045]="PACKAGE_LOST",L[L.PACKAGE_RATE=2046]="PACKAGE_RATE",L[L.CURRENT_DELAY=2047]="CURRENT_DELAY",L[L.JITTER_BUFFER=2054]="JITTER_BUFFER",L[L.JITTER=2055]="JITTER",L[L.FREEZE=2083]="FREEZE",L[L.DISABLED=2102]="DISABLED",L[L.PCM_LEVEL=2105]="PCM_LEVEL",L[L.PLAYER_STATUS=2130]="PLAYER_STATUS",L[L.CONCEALED_SAMPLES=2148]="CONCEALED_SAMPLES",L}(jV||{}),HV=function(L){return L[L.FREEZE_TIME=-1]="FREEZE_TIME",L[L.LEVEL=2043]="LEVEL",L}(HV||{}),KV=function(L){return L[L.RTT=2006]="RTT",L[L.CONN_TYPE=801]="CONN_TYPE",L}(KV||{});const zV=1e3;function iF(L,k,M){null!=M&&Number.isFinite(M)&&(L[k]=Math.round(Math.max(0,M)))}function nF(L){const k={[KV.CONN_TYPE]:0,[KV.RTT]:L.rtt};switch(L.selectedCandidatePair.localCandidate.candidateType){case"relay":{const M=L.selectedCandidatePair.localCandidate.relayProtocol;"udp"===M&&(k[KV.CONN_TYPE]=1),"tcp"===M&&(k[KV.CONN_TYPE]=3),"tls"===M&&(k[KV.CONN_TYPE]=4);break}case"srflx":k[KV.CONN_TYPE]=2}return k}function rF(L){let k=0;switch(L){case"none":k=0;break;case"cpu":k=1;break;case"bandwidth":k=2;break;case"other":k=3}return k}class oF extends My{constructor(L){super(),xg(this,"store",void 0),xg(this,"uploadWRTCStatsTimer",void 0),xg(this,"uploadOutboundDenoiserStatsTimer",void 0),xg(this,"uploadExtStatsTimer",void 0),xg(this,"uploadExtUsageStatsTimer",void 0),xg(this,"uploadInboundExtStatsTimer",void 0),xg(this,"requestStats",void 0),xg(this,"requestTransportStats",void 0),xg(this,"requestLocalMedia",void 0),xg(this,"requestRemoteMedia",void 0),xg(this,"requestAllTracks",void 0),xg(this,"requestVideoIsReady",void 0),xg(this,"requestUploadStats",void 0),xg(this,"requestUpload",void 0),xg(this,"uploadOutboundStarted",!1),xg(this,"uploadInboundStarted",!1),xg(this,"uploadTransportStarted",!1),xg(this,"uploadExtensionUsageStarted",!1),xg(this,"lastRecvStats",void 0),xg(this,"lastSendStats",void 0),xg(this,"lastFullRecvStats",void 0),xg(this,"lastFullSendStats",void 0),xg(this,"needUploadRenderFreezeTime",!0),this.store=L}uploadWRTCStats(L){if(!this.requestStats||!this.requestUploadStats)return;let k,M;if(this.uploadTransportStarted&&(k=this.requestStats(),this.store.useP2P&&(M=this.requestStats(!0))),!k&&this.uploadOutboundStarted&&(k=this.requestStats()),!M&&this.uploadInboundStarted&&(M=this.requestStats(!0)),k||M){const U={};if(this.uploadTransportStarted&&k){const x=this.getTransportStats(k,M,L);x&&(U.misc=[x])}if(this.uploadOutboundStarted&&k){const M=this.getOutboundStats(k,L?this.lastSendStats:this.lastFullSendStats,L);M&&(U.outbound=[M])}if(this.uploadInboundStarted&&M){const k=this.getInboundStats(M,L?this.lastRecvStats:this.lastFullRecvStats,L);k&&(U.inbound=k)}this.requestUploadStats(U)}this.lastRecvStats=M,this.lastSendStats=k,L||(this.lastFullRecvStats=M,this.lastFullSendStats=k)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;let L=1;this.uploadWRTCStatsTimer=window.setInterval((()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted)return this.stopUploadWRTCStats();this.uploadWRTCStats(3!==L),4==++L&&(L=1)}),zV)}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0)}getTransportStats(L,k,M){if(!this.requestStats)return;if(M)return null==L.rtt?void 0:{addition:{[KV.RTT]:L.rtt,[KV.CONN_TYPE]:void 0}};const U=nF(L);if(this.store.useP2P){if(k){const L=nF(k);U[KV.CONN_TYPE]+=L[KV.CONN_TYPE]<<3}U[KV.CONN_TYPE]+=110}else U[KV.CONN_TYPE]+=100;return{addition:U}}getOutboundStats(L,k,M){if(!this.requestUploadStats||!this.requestLocalMedia)return;const U=this.requestLocalMedia();if(!U||0===U.length)return;let x,V,F;return U.forEach((U=>{let[j,{track:z,ssrcs:Q}]=U;switch(j){case cO.LocalVideoLowTrack:case cO.LocalVideoTrack:if(j===cO.LocalVideoTrack){const U=function(L,k,M,U,x){const V=k.videoSend.find((k=>k.ssrc===L));if(!V)return;const F={},{sentFrame:j,inputFrame:z}=V;if(z&&j){const L=z.frameRate,k=j.frameRate;F[IV.FREEZE]=function(L,k){let M=!0;return M=!(L<=5)&&(L<=10?k<3:L<=20?k<4:k<5),M}(L,k)?1:0}if(iF(F,IV.QP_SUM,V.qpSumPerFrame),x)return F;switch(j&&(iF(F,IV.HEIGHT,j.height),iF(F,IV.WIDTH,j.width),iF(F,IV.FRAME_RATE,j.frameRate)),F[IV.DISABLED]=U._originMediaStreamTrack&&!U._originMediaStreamTrack.enabled||U._mediaStreamTrack&&!U._mediaStreamTrack.enabled?1:0,V.adaptionChangeReason){case"none":F[IV.ADAPTATION]=0;break;case"cpu":F[IV.ADAPTATION]=1;break;case"bandwidth":F[IV.ADAPTATION]=2;break;case"other":F[IV.ADAPTATION]=3}let Q=0;V.adaptionChangeReason&&(Q+=rF(V.adaptionChangeReason)),k.qualityLimitationReason&&(Q+=rF(k.qualityLimitationReason)<<3),F[IV.ADAPTATION]=Q,F[IV.PLAYER_STATUS]=DL[U._player?U._player.videoElementStatus:"uninit"],iF(F,IV.NACKS,V.nacksCount),iF(F,IV.PLIS,V.plisCount),iF(F,IV.FIRS,V.firsCount),iF(F,IV.AVG_ENCODE,V.avgEncodeMs);const $=M&&M.videoSend.find((k=>k.ssrc===L));if($){let L=x?zV:3e3;$.timestamp&&V.timestamp&&(L=V.timestamp-$.timestamp),null!=$.packets&&null!=V.packets&&iF(F,IV.PACKAGE_RATE,1e3*(V.packets-$.packets)/L),null!=V.packetsLost&&null!=$.packetsLost&&iF(F,IV.PACKAGE_LOST,V.packetsLost-$.packetsLost),null!=$.bytes&&null!=V.bytes&&iF(F,IV.BITRATE,8*(V.bytes-$.bytes)/L)}return F}(Q[0].ssrcId,L,k,z,M),x=M?null:function(L,k,M){const U=k.videoSend.find((k=>k.ssrc===L));if(!U)return null;const x={},V=U.inputFrame,F=V&&V.height||M&&M.videoHeight||0,j=V&&V.width||M&&M.videoWidth||0,z=V&&V.frameRate||0;return iF(x,RV.HEIGHT,F),iF(x,RV.WIDTH,j),iF(x,RV.FRAME_RATE,z),x}(Q[0].ssrcId,L,z),F=M?null:function(L){const k={};return iF(k,IV.RETRANSMIT,L.bitrate.retransmit),iF(k,IV.TARGET_ENCODED,L.bitrate.targetEncoded),iF(k,IV.ACTUAL_ENCODED,L.bitrate.actualEncoded),iF(k,IV.TRANSMIT,L.bitrate.transmit),iF(k,IV.BANDWIDTH,L.sendBandwidth),k}(L);V=Object.assign({},U,x,F)}else F=M?void 0:function(L,k,M){const U=k.videoSend.find((k=>k.ssrc===L));if(!U)return;const x={},V=U.sentFrame;if(V&&(iF(x,CV.HEIGHT,V.height),iF(x,CV.WIDTH,V.width),iF(x,CV.FRAME_RATE,V.frameRate)),M){const k=M.videoSend.find((k=>k.ssrc===L));if(k){let L=3e3;k.timestamp&&U.timestamp&&(L=U.timestamp-k.timestamp),null!=k.packets&&null!=U.packets&&iF(x,CV.PACKAGE_RATE,1e3*(U.packets-k.packets)/L),null!=U.packetsLost&&null!=k.packetsLost&&iF(x,CV.PACKAGE_LOST,U.packetsLost-k.packetsLost),null!=k.bytes&&null!=U.bytes&&iF(x,CV.BITRATE,8*(U.bytes-k.bytes)/L)}}return x}(Q[0].ssrcId,L,k);break;case cO.LocalAudioTrack:x=M?void 0:function(L,k,M,U){const x=k.audioSend.find((k=>k.ssrc===L));if(!x)return;const V={};V[VV.DISABLED]=U._originMediaStreamTrack&&!U._originMediaStreamTrack.enabled||U._mediaStreamTrack&&!U._mediaStreamTrack.enabled?1:0;const F=100*U._source.getAccurateVolumeLevel(),j=x.inputLevel;if(null!=j){const L=Math.ceil(50*Math.log10(100*j+1));iF(V,VV.LEVEL,L)}else iF(V,VV.LEVEL,F);iF(V,xV.PCM_LEVEL,F),iF(V,VV.AEC_RETURN_LOSS,x.aecReturnLoss),iF(V,VV.AEC_RETURN_LOSS_ENH,x.aecReturnLossEnhancement),V[VV.FREEZE]=0;const z=M&&M.audioSend.find((k=>k.ssrc===L));if(z){let L=3e3;z.timestamp&&x.timestamp&&(L=x.timestamp-z.timestamp),null!=z.bytes&&null!=x.bytes&&iF(V,VV.BITRATE,8*(x.bytes-z.bytes)/L),null!=z.packets&&null!=x.packets&&iF(V,VV.PACKAGE_RATE,1e3*(x.packets-z.packets)/L)}return V}(Q[0].ssrcId,L,k,z)}})),{high:V,low:F,audio:x}}getInboundStats(L,k,M){if(!this.requestRemoteMedia)return;const U=this.requestRemoteMedia()||[],x=[];return U.forEach((U=>{let[V,F]=U;const j={peer:V.uid};if(F.has(nO.VIDEO)&&V.videoTrack){const U=V._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(V._videoSSRC)||!1,x=V.videoTrack?function(L,k,M,U,x,V,F){var j;const z=k.videoRecv.find((k=>k.ssrc===L));if(!z)return;const Q={},{receivedFrame:$,outputFrame:ee,decodeFrameRate:te}=z,ie=M&&M.videoRecv.find((k=>k.ssrc===L));if(Q[vV.FREEZE]=x&&OF.isRemoteVideoFreeze(U,z,ie)?1:0,iF(Q,UV.FRAME_RATE_DECODE,te),iF(Q,vV.QP_SUM,z.qpSumPerFrame),z.framesRateFirefox&&iF(Q,vV.FRAME_RATE,z.framesRateFirefox),$&&iF(Q,vV.FRAME_RATE,$.frameRate),ie){const L=k.timestamp-M.timestamp||(F?zV:3e3);null!=z.packetsLost&&null!=ie.packetsLost&&iF(Q,vV.PACKAGE_LOST,z.packetsLost-ie.packetsLost),null!=ie.bytes&&null!=z.bytes&&iF(Q,vV.BITRATE,8*(z.bytes-ie.bytes)/L),null!=ie.packets&&null!=z.packets&&iF(Q,vV.PACKAGE_RATE,1e3*(z.packets-ie.packets)/L)}if(F)return Q;$?(iF(Q,vV.HEIGHT,$.height),iF(Q,vV.WIDTH,$.width)):U&&(iF(Q,vV.HEIGHT,U._videoHeight||0),iF(Q,vV.WIDTH,U._videoWidth||0)),ee&&iF(Q,UV.FRAME_RATE_OUTPUT,ee.frameRate);const ne=null===(j=U._player)||void 0===j?void 0:j.rendFrameRate.toFixed(0);if(ne&&iF(Q,UV.FRAME_RATE_RENDER,+ne),iF(Q,vV.JITTER_BUFFER,z.jitterBufferMs),iF(Q,vV.CURRENT_DELAY,z.currentDelayMs),iF(Q,vV.FIRS,z.firsCount),iF(Q,vV.NACKS,z.nacksCount),iF(Q,vV.PLIS,z.plisCount),U){Q[vV.DISABLED]=U._originMediaStreamTrack.enabled&&U._mediaStreamTrack.enabled?0:1;const L=U._player;if(L){const{freezeTimeCounterList:k,renderFreezeAccTime:M,videoElementStatus:U}=L;if(k&&k.length>0&&iF(Q,UV.FREEZE_TIME,k.splice(0,1)[0]),V&&"visible"===mU.visibility&&U===OL.PLAYING&&XP().supportRequestVideoFrameCallback){const k=Math.min(6e3,M);L.renderFreezeAccTime=Math.max(0,M-k),iF(Q,UV.FREEZE_TIME_RENDER,k)}if("number"==typeof z.totalFreezesDuration){const L=ie&&ie.totalFreezesDuration?z.totalFreezesDuration-ie.totalFreezesDuration:z.totalFreezesDuration;iF(Q,UV.FREEZE_DURATION,1e3*L)}}}if(Q[vV.PLAYER_STATUS]=DL[U._player?U._player.videoElementStatus:"uninit"],ie&&void 0!==z.totalInterFrameDelay&&void 0!==z.totalSquaredInterFrameDelay&&void 0!==ie.totalInterFrameDelay&&void 0!==ie.totalSquaredInterFrameDelay){const L=z.totalInterFrameDelay-ie.totalInterFrameDelay,k=z.totalSquaredInterFrameDelay-ie.totalSquaredInterFrameDelay,M=z.framesDecodeCount-ie.framesDecodeCount,U=L/M*1e3,x=Math.round(1e3*Math.sqrt((k-Math.pow(L,2)/M)/M));!isNaN(x)&&U+x>Math.max(3*U,U+150)&&(Q[vV.I_FRAME_DELAY]=x)}return Q}(V._videoSSRC,L,k,V.videoTrack,!0===U,this.needUploadRenderFreezeTime,M):void 0;x&&(j.video=x)}if(F.has(nO.AUDIO)&&V.audioTrack){const U=V.audioTrack?function(L,k,M,U,x){const V=k.audioRecv.find((k=>k.ssrc===L));if(!V)return;const F={},j=M&&M.audioRecv.find((k=>k.ssrc===L)),{receivedFrames:z,droppedFrames:Q}=V;var $;if(iF(F,jV.JITTER,V.jitterMs),null!=z&&null!=Q&&(F[jV.FREEZE]=0===($=z)||100*Q/$>20?1:0),j){const L=k.timestamp-M.timestamp||(x?zV:3e3);null!=V.packets&&null!=j.packets&&iF(F,jV.PACKAGE_RATE,1e3*(V.packets-j.packets)/L),null!=j.bytes&&null!=V.bytes&&iF(F,jV.BITRATE,8*(V.bytes-j.bytes)/L),null!=V.packetsLost&&null!=j.packetsLost&&iF(F,jV.PACKAGE_LOST,V.packetsLost-j.packetsLost)}if(x)return F;const ee=100*U._source.getAccurateVolumeLevel(),te=V.outputLevel;if(null!=te){const L=Math.ceil(50*Math.log10(100*te+1));iF(F,HV.LEVEL,L)}if(iF(F,jV.PCM_LEVEL,ee),U&&(F[jV.DISABLED]=U._originMediaStreamTrack.enabled&&U._mediaStreamTrack.enabled?0:1),iF(F,jV.JITTER_BUFFER,V.jitterBufferMs),iF(F,jV.CURRENT_DELAY,V.jitterBufferMs),F[jV.PLAYER_STATUS]=DL[dk.getPlayerState(U.getTrackId())],j){const L=V.concealedSamples-j.concealedSamples;L>0&&iF(F,jV.CONCEALED_SAMPLES,L)}return F}(V._audioSSRC,L,k,V.audioTrack,M):void 0;U&&(j.audio=U)}(j.video||j.audio)&&x.push(j)})),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,x}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval((()=>{if(!this.requestAllTracks||!this.requestUpload)return;const L=(this.requestAllTracks()||[]).find((L=>L instanceof hM));if(L&&L._external.getDenoiserStats){const k=L._external.getDenoiserStats();k&&this.requestUpload(Ow.DENOISER_STATS,k)}}),2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval((()=>{this.requestAllTracks&&this.requestUpload&&this.requestAllTracks().forEach((L=>{L.getProcessorStats().forEach((L=>{this.requestUpload&&this.requestUpload(L.type,L.stats)}))}))}),2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval((()=>{this.requestUpload&&this.requestRemoteMedia&&(this.requestRemoteMedia()||[]).forEach((L=>{let[k,M]=L;M.has(nO.VIDEO)&&k.videoTrack&&k.videoTrack.getProcessorStats().forEach((L=>{this.requestUpload&&this.requestUpload(L.type,L.stats)})),M.has(nO.AUDIO)&&k.audioTrack&&k.audioTrack.getProcessorStats().forEach((L=>{this.requestUpload&&this.requestUpload(L.type,L.stats)}))}))}),2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0))}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);const L=new Map;this.uploadExtUsageStatsTimer=window.setInterval((async()=>{const k=Date.now(),M={connectionInterval:zA("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:k};let U=[];const x=this.requestAllTracks&&this.requestAllTracks()||[];for(const L of x)!L.muted&&L.enabled&&(U=U.concat(await L.getProcessorUsage()));const V=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(const[L,k]of V)k.has(nO.VIDEO)&&L.videoTrack&&(U=U.concat(await L.videoTrack.getProcessorUsage())),k.has(nO.AUDIO)&&L.audioTrack&&(U=U.concat(await L.audioTrack.getProcessorUsage()));if(0===U.length)return;M.details=function(L,k){const M={};for(const{id:F,value:j,level:z,direction:Q}of L){var U;const L=null!==(U=k.get(F))&&void 0!==U?U:0,$=2===j?L+zA("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:L;var x,V;k.set(F,$),M[F]?(2===j&&(M[F].value=j),z>M[F].level&&(M[F].level=z),"remote"===Q&&(M[F].remoteUidCount+=1),M[F].totalTs=null!==(x=k.get(F))&&void 0!==x?x:0):M[F]={value:j,level:z,remoteUidCount:"local"===Q?0:1,totalTs:null!==(V=k.get(F))&&void 0!==V?V:0}}return Object.keys(M).map((L=>{const{level:k,value:U,totalTs:x}=M[L];return{id:L,level:k,value:U,totalTs:x}}))}(U,L);const F=Date.now(),j=F>k?F:k+1;this.requestUpload&&this.requestUpload(Ow.EXTENSION_USAGE_STATS,{usageStats:M,sendTs:j})}),zA("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}}class sF{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(L,k){xg(this,"uid",void 0),xg(this,"_uintid",void 0),xg(this,"_trust_in_room_",!0),xg(this,"_trust_audio_enabled_state_",!0),xg(this,"_trust_video_enabled_state_",!0),xg(this,"_trust_audio_mute_state_",!0),xg(this,"_trust_video_mute_state_",!0),xg(this,"_audio_muted_",!1),xg(this,"_video_muted_",!1),xg(this,"_audio_enabled_",!0),xg(this,"_video_enabled_",!0),xg(this,"_audio_added_",!1),xg(this,"_video_added_",!1),xg(this,"_is_pre_created",!1),xg(this,"_video_pre_subscribed",!1),xg(this,"_audio_pre_subscribed",!1),xg(this,"_trust_video_stream_added_state_",!0),xg(this,"_trust_audio_stream_added_state_",!0),xg(this,"_audioTrack",void 0),xg(this,"_videoTrack",void 0),xg(this,"_dataChannels",[]),xg(this,"_audioSSRC",void 0),xg(this,"_videoSSRC",void 0),xg(this,"_audioOrtc",void 0),xg(this,"_videoOrtc",void 0),xg(this,"_cname",void 0),xg(this,"_rtxSsrcId",void 0),xg(this,"_videoMid",void 0),xg(this,"_audioMid",void 0),this.uid=L,this._uintid=k}}let YV=function(L){return L.SEND_ONLY="SEND_ONLY",L.RECEIVE_ONLY="RECEIVE_ONLY",L}({});function cF(L,k){var M;let U;switch(k){case cO.LocalAudioTrack:U=qw.Audio;break;case cO.LocalVideoTrack:U=Sr(M=L._hints).call(M,sL.SCREEN_TRACK)?qw.Screen:qw.High;break;case cO.LocalVideoLowTrack:U=qw.Low}return U}function dF(L){const k=XP();if(L.some((L=>L._bypassWebAudio)))throw new nv(iv.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");if(!k.webAudioMediaStreamDest)throw new nv(iv.NOT_SUPPORTED,"cannot publish multiple tracks because your browser does not support audio mixing")}function lF(L,k){dF(L);const M=k||new SM;return L.forEach((L=>M.addAudioTrack(L))),M}var qV,XV,JV,QV,ZV,$V,eF,tF,aF,uF,hF,pF;function IF(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function vF(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?IF(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):IF(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}let _F=(qV=AF(YV.SEND_ONLY),XV=AF(YV.SEND_ONLY),JV=AF(),QV=AF(YV.RECEIVE_ONLY),ZV=AF(YV.RECEIVE_ONLY),$V=AF(YV.RECEIVE_ONLY),eF=AF(YV.RECEIVE_ONLY),tF=AF(YV.RECEIVE_ONLY),aF=AF(YV.RECEIVE_ONLY),uF=AF(),hF=AF(YV.RECEIVE_ONLY),pF=class extends My{get state(){return this._state}set state(L){const k=this._state;this._state=L,this.emit(lO.StateChange,k,this._state)}constructor(L,k){super(),xg(this,"isPlanB",!1),xg(this,"store",void 0),xg(this,"statsUploader",void 0),xg(this,"sendConnection",void 0),xg(this,"recvConnection",void 0),xg(this,"localTrackMap",new Map),xg(this,"remoteUserMap",new Map),xg(this,"localDataChannels",[]),xg(this,"pendingLocalTracks",[]),xg(this,"pendingRemoteTracks",[]),xg(this,"statsCollector",void 0),xg(this,"dtlsFailedCount",0),xg(this,"sendMutex",new wv("P2PChannel2-send-mutex")),xg(this,"recvMutex",new wv("P2PChannel2-recv-mutex")),xg(this,"_state",dO.Disconnected),xg(this,"_restartStates",["disconnected","failed"]),xg(this,"reconnectInterval",void 0),xg(this,"uploadUnplinkStarted",!1),xg(this,"uploadDownlinkStarted",!1),xg(this,"uplinkStateUploadInterval",void 0),xg(this,"downlinkStatsUploadInterval",void 0),xg(this,"handleMuteLocalTrack",(async(L,k,M)=>{const U=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==dO.Connected)return void M(new nv(iv.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));const F=this.filterTobeMutedTracks(L);if(0===F.length)return void k();const j=F.find((L=>"videoLowTrack"===L[0]));j&&j[1].track._originMediaStreamTrack.stop(),await this.sendConnection.muteLocal(F.map((L=>{let[,{id:k}]=L;return k})));let z=!1;var x,V;z="video"===L.trackMediaType?!(null===(x=this.localTrackMap.get(cO.LocalAudioTrack))||void 0===x||!x.track._muted):void 0===(null===(V=this.localTrackMap.get(cO.LocalVideoTrack))||void 0===V?void 0:V.id);const Q=this.createMuteMessage(F);await Qy(this,lO.RequestMuteLocal,Q);const $="video"===L.trackMediaType?RO.MUTE_LOCAL_VIDEO:RO.MUTE_LOCAL_AUDIO;await Qy(this,lO.RequestP2PMuteLocal,{action:$,message:Q,isMuteAll:z}),k()}catch(L){M(L)}finally{U()}})),xg(this,"handleUnmuteLocalTrack",(async(L,k,M)=>{const U=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==dO.Connected)return void M(new nv(iv.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));const x=this.filterTobeUnmutedTracks(L);if(0===x.length)return void k();await this.sendConnection.unmuteLocal(x.map((L=>{let[,{id:k}]=L;return k})));const V=this.createUnmuteMessage(x),F="video"===L.trackMediaType?RO.UNMUTE_LOCAL_VIDEO:RO.UNMUTE_LOCAL_AUDIO;await Qy(this,lO.RequestP2PMuteLocal,{action:F,message:V}),k()}catch(L){M(L)}finally{U()}})),xg(this,"handleUpdateVideoEncoder",(async(L,k,M)=>{const U=await this.sendMutex.lock("Locking from P2PChannel2.handleSetVideoEncoder");try{const M=this.localTrackMap.get(cO.LocalVideoTrack);if(!this.sendConnection||!M||M.track!==L||this.state!==dO.Connected)return void k();const{id:x,track:V}=M;x&&(await this.sendConnection.updateSendParameters(x,V),await this.sendConnection.updateEncoderConfig(x,V),this.emit(lO.UpdateVideoEncoder,V)),k()}catch(L){M(L)}finally{U()}})),xg(this,"handleUpdateVideoSendParameters",(async(L,k,M)=>{const U=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoSendParameters");try{const M=this.localTrackMap.get(cO.LocalVideoTrack);if(!this.sendConnection||!M||M.track!==L||this.state!==dO.Connected)return void k();const{id:x,track:V}=M;x&&await this.sendConnection.updateSendParameters(x,V),k()}catch(L){M(L)}finally{U()}})),xg(this,"handleReplaceTrack",(async(L,k,M,U)=>{let x;Eb.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(L.getTrackId(),"]")),"boolean"==typeof U&&U||(x=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var V;const M=Array.from(this.localTrackMap.entries()).find((k=>{let[,{track:M}]=k;return L===M}));if(!this.sendConnection||!M||void 0===M[1].id||this.state!==dO.Connected)return void k();if(await(null===(V=this.sendConnection)||void 0===V?void 0:V.replaceTrack(L,M[1].id)),M[0]===cO.LocalVideoTrack&&XP().supportDualStreamEncoding){const k=this.localTrackMap.get(cO.LocalVideoLowTrack);if(k){const M=L._mediaStreamTrack.clone();k.track._originMediaStreamTrack.stop(),k.track._mediaStreamTrack=M,k.track._originMediaStreamTrack=M,await new Mp(((L,M)=>{this.handleReplaceTrack(k.track,L,M,!0)}))}}k()}catch(L){M(L)}finally{var F;null===(F=x)||void 0===F||F()}})),xg(this,"handleGetLocalVideoStats",(L=>{L(this.statsCollector.getLocalVideoTrackStats())})),xg(this,"handleGetLocalAudioStats",(L=>{L(this.statsCollector.getLocalAudioTrackStats())})),xg(this,"handleGetRemoteVideoStats",(L=>this.statsCollector.getRemoteVideoTrackStats(L.uid)[L.uid])),xg(this,"handleGetRemoteAudioStats",(L=>this.statsCollector.getRemoteAudioTrackStats(L.uid)[L.uid])),this.store=L,this.statsCollector=k,this.statsCollector.addP2PChannel(this),this.statsUploader=new oF(L),this.bindStatsUploaderEvents(),this.reconnectInterval=window.setInterval((()=>{[this.sendConnection,this.recvConnection].forEach((L=>{L&&("disconnected"!==L.iceConnectionState&&"failed"!==L.iceConnectionState||this.handleDisconnect(L.direction))}))}),zA("ICE_RESTART_INTERVAL"))}async startP2PConnection(L,k){throw new nv(iv.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(L){throw new nv(iv.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(L,k){let M;try{if(k){this.recvConnection&&(Eb.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),M=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new SV(L,this.store,Dw.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);const U=await this.recvConnection.establish(k);return{iceParameters:U.iceParameters,dtlsParameters:U.dtlsParameters,sdp:U.sdp}}{this.state=dO.New,this.sendConnection&&(Eb.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),M=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new SV(L,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);const k=await this.sendConnection.establish();return{iceParameters:k.iceParameters,dtlsParameters:k.dtlsParameters,sdp:k.sdp}}}finally{M&&M()}}async p2pConnect(L){if(!this.sendConnection)throw new nv(iv.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(L),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=dO.Connected}async addRemoteCandidate(L,k){if(k===Dw.RECEIVE_ONLY){if(!this.sendConnection)throw new nv(iv.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(L)}else{if(!this.recvConnection)throw new nv(iv.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(L)}}publish(L,k,M){var U=this;return HI((function*(){const x=yield KI(U.sendMutex.lock("From P2PChannel.publish"));try{if(!U.sendConnection||U.state!==dO.Connected){U.throwIfTrackTypeNotMatch(L);const k=L.filter((L=>-1===U.pendingLocalTracks.indexOf(L)));return void(U.pendingLocalTracks=U.pendingLocalTracks.concat(k))}U.store.pubId=U.store.pubId+1,Cx.markPublishStart(U.store.clientId,U.store.pubId);const V=U.filterTobePublishedTracks(L,k,M);if(0===V.length)return void(yield KI(U.tryToUnmuteAudio(L)));V.forEach((L=>{let{track:k,type:M}=L;const x=Date.now();U.store.publish(k.getTrackId(),M===cO.LocalAudioTrack?"audio":"video",x)})),U.bindLocalTrackEvents(V);const F=yield KI(U.sendConnection.send(V.map((L=>{let{track:k}=L;return k})),U.store.codec,U.store.audioCodec)),j=(yield KI(F.next())).value,z=U.createGatewayPublishMessage(V,j);try{yield z}catch(L){throw F.throw(L),(null==L?void 0:L.code)===iv.WS_ABORT&&V.forEach((L=>{let{track:k}=L;-1===U.pendingLocalTracks.indexOf(k)&&U.pendingLocalTracks.push(k)})),U.unbindLocalTrackEvents(V),L}yield KI(F.next()),V.forEach((L=>{let{type:k}=L;U.statsCollector.addLocalStats(k)})),U.statsUploader.startUploadOutboundStats(),U.assignLocalTracks(V,j),V.forEach((L=>{let{track:k,type:M}=L;const x=Date.now();U.store.publish(k.getTrackId(),M===cO.LocalAudioTrack?"audio":"video",void 0,x)})),U.startUploadUplinkState()}finally{x()}}))()}async unpublish(L){if(!this.sendConnection||this.state!==dO.Connected)return void(0===L.length?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter((k=>!Sr(L).call(L,k))));const k=this.filterTobeUnpublishedTracks(L);if(0===k.length)return;const M=k.find((L=>"videoLowTrack"===L[0]));M&&M[1].track.close();const U=this.createGatewayUnpublishMessage(k);if(await this.sendConnection.stopSending(k.map((L=>{let[,{id:k}]=L;return k}))),this.withdrawLocalTracks(k),this.unbindLocalTrackEvents(k.map((L=>{let[k,{track:M}]=L;return{type:k,track:M}}))),k.forEach((L=>{let[k]=L;this.statsCollector.removeLocalStats(k)})),0===this.localTrackMap.size&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===dO.Connected)return M&&M[1].track.close(),U;L.forEach((L=>{const k=this.pendingLocalTracks.indexOf(L);-1!==k&&this.pendingLocalTracks.splice(k,1)}))}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);const e=()=>{const L=[],k=[];Array.from(this.localTrackMap.entries()).forEach((M=>{let[U,{track:x,ssrcs:V}]=M;const F={stream_type:cF(x,U),ssrcs:V};x._muted||!x._enabled?L.push(F):k.push(F)})),L.length>0&&L.forEach((L=>{Qy(this,lO.RequestMuteLocal,[L])})),k.length>0&&k.forEach((L=>{Qy(this,lO.RequestUnmuteLocal,[L])}))};e(),this.uplinkStateUploadInterval=window.setInterval((()=>{e()}),3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(L){return HI((function*(){throw new nv(iv.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")}))()}async republish(){this.pendingLocalTracks.length>0&&(Eb.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await Xy(this,lO.RequestRePublish,this.pendingLocalTracks),this.emit(lO.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublishLowStream(){throw new nv(iv.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(L,k,M,U){var x;if(!this.recvConnection)throw new nv(iv.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if(null!==(x=this.remoteUserMap.get(L))&&void 0!==x&&x.has(k))return;const{track:V,mid:F,transceiver:j}=await this.recvConnection.receive(k,[{ssrcId:M}],String(L.uid),U);k===nO.AUDIO?(L._audioTrack?L._audioTrack._updateOriginMediaStreamTrack(V):(L._audioTrack=new fU(V,L.uid,L._uintid,this.store),Eb.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(L._audioTrack.getTrackId()))),j&&L._audioTrack._updateRtpTransceiver(j),this.bindRemoteTrackEvents(L,L._audioTrack)):(L._videoSSRC=M,L._videoTrack?L._videoTrack._updateOriginMediaStreamTrack(V):(L._videoTrack=new EU(V,L.uid,L._uintid,this.store),Eb.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(L._videoTrack.getTrackId()))),j&&L._videoTrack._updateRtpTransceiver(j),this.bindRemoteTrackEvents(L,L._videoTrack));const z=this.remoteUserMap.get(L);z?z.set(k,F):this.remoteUserMap.set(L,new Map([[k,F]])),this.statsCollector.addRemoteStats(L.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();const Q=this.pendingRemoteTracks.findIndex((M=>{let{user:U,kind:x}=M;return U.uid===L.uid&&k===x}));-1!==Q&&(this.pendingRemoteTracks.splice(Q,1),this.emit(lO.MediaReconnectEnd,L.uid))}async mockSubscribe(L,k,M,U){if(!this.recvConnection)throw new nv(iv.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(k,[{ssrcId:M}],String(L.uid),U)}async unsubscribe(L,k,M){const U=this.pendingRemoteTracks.filter((M=>{let{user:U,kind:x}=M;return void 0!==k?U.uid===L.uid&&k===x:U.uid===L.uid}));if(U.forEach((L=>{const k=this.pendingRemoteTracks.indexOf(L);this.pendingRemoteTracks.splice(k,1)})),this.recvConnection||M||U.forEach((k=>{let{kind:M}=k;var U;if(M===nO.AUDIO)null===(U=L._audioTrack)||void 0===U||U._destroy(),L._audioTrack=void 0;else if(M===nO.VIDEO){var x;null===(x=L._videoTrack)||void 0===x||x._destroy(),L._videoTrack=void 0}})),!this.recvConnection)return;const x=this.filterTobeUnSubscribedTracks(L,k);0!==x.length&&(await this.recvConnection.stopReceiving(x.map((L=>{let[,{id:k}]=L;return k}))),this.withdrawRemoteTracks(x),0===this.remoteUserMap.size&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),x.forEach((L=>{let[k,{kind:U}]=L;var x,V;if(U===nO.VIDEO&&k._videoSSRC&&(null===(x=this.recvConnection)||void 0===x||x.setStatsRemoteVideoIsReady(k._videoSSRC,!1)),U===nO.VIDEO)this.unbindRemoteTrackEvents(k._videoTrack),M||(null===(V=k._videoTrack)||void 0===V||V._destroy(),k._videoTrack=void 0);else if(U===nO.AUDIO){var F;this.unbindRemoteTrackEvents(k._audioTrack),M||(null===(F=k._audioTrack)||void 0===F||F._destroy(),k._audioTrack=void 0)}})),x.forEach((L=>{let[,{kind:k}]=L;Qy(this,lO.RequestP2PMuteRemote,k)})))}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);const e=()=>Array.from(this.remoteUserMap.entries()).forEach((L=>{let[,k]=L;[nO.VIDEO,nO.AUDIO].forEach((L=>{k.has(L)?Qy(this,lO.RequestP2PUnmuteRemote,L):Qy(this,lO.RequestP2PMuteRemote,L)}))}));e(),this.downlinkStatsUploadInterval=window.setInterval((()=>{e()}),3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}async massSubscribe(L){throw new nv(iv.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(L){throw new nv(iv.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(L){throw new nv(iv.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(L){throw new nv(iv.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(L,k){if(!this.recvConnection)return;const M=this.remoteUserMap.get(L);if(!M)return void Eb.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(L.uid,"."));if(!M.get(k))return void Eb.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(L.uid," media type ").concat(k,"."));const U=k===nO.VIDEO?L._videoSSRC:L._audioSSRC;void 0!==U&&this.recvConnection.setStatsRemoteVideoIsReady(U,!1)}async unmuteRemote(L,k){return this.unmuteRemoteNoLock(L,k)}async unmuteRemoteNoLock(L,k){if(!this.recvConnection)return;const M=this.remoteUserMap.get(L);M?M.get(k)||Eb.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(L.uid," media type ").concat(k,".")):Eb.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(L.uid,"."))}getAllTracks(L){const k=this.localTrackMap.get(cO.LocalAudioTrack);if((null==k?void 0:k.track)instanceof SM){const M=k.track;return Array.from(this.localTrackMap.entries()).filter((L=>{let[k]=L;return k!==cO.LocalAudioTrack})).filter((k=>{let[M]=k;return!(L&&M===cO.LocalVideoLowTrack)})).map((L=>{let[,{track:k}]=L;return k})).concat(M.trackList)}return Array.from(this.localTrackMap.entries()).filter((k=>{let[M]=k;return!(L&&M===cO.LocalVideoLowTrack)})).map((L=>{let[,{track:k}]=L;return k}))}reportPublishEvent(L,k,M,U,x){if(L){const M=this.localTrackMap.get(cO.LocalAudioTrack),V=U?this.localTrackMap.get(cO.LocalVideoLowTrack):this.localTrackMap.get(cO.LocalVideoTrack);Ab.publish(this.store.sessionId,{eventElapse:Cx.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:L,ec:k,audioName:null==M?void 0:M.track.getTrackLabel(),videoName:null==V?void 0:V.track.getTrackLabel(),screenshare:-1!==(null==V?void 0:V.track._hints.indexOf(sL.SCREEN_TRACK)),audio:!!M,video:!!V,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:x})}else{var V;M||(M=[]);const F=M.find((L=>L instanceof uM)),j=U?null===(V=this.localTrackMap.get(cO.LocalVideoTrack))||void 0===V?void 0:V.track:M.find((L=>L instanceof eU));Ab.publish(this.store.sessionId,{eventElapse:Cx.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:L,ec:k,audioName:null==F?void 0:F.getTrackLabel(),videoName:null==j?void 0:j.getTrackLabel(),screenshare:-1!==(null==j?void 0:j._hints.indexOf(sL.SCREEN_TRACK)),audio:!!F,video:!!j,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:x})}}reportSubscribeEvent(L,k,M,U){const x=U===nO.VIDEO?M._videoSSRC:M._audioSSRC;x&&Ab.subscribe(this.store.sessionId,{succ:L,ec:k,video:U===nO.VIDEO,audio:U===nO.AUDIO,peerid:M.uid,subscribeRequestid:U===nO.VIDEO?M._videoSSRC:M._audioSSRC,p2pid:this.store.p2pId,eventElapse:Cx.measureFromSubscribeStart(this.store.clientId,x)})}reset(){Eb.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new wv("P2PChannel2-send-mutex"),this.sendMutex=new wv("P2PChannel2-recv-mutex"),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const L=this.localTrackMap.get(cO.LocalAudioTrack);if((null==L?void 0:L.track)instanceof SM){if(L.track.trackList.length>0){const k=L.track;L.track.trackList.forEach((L=>{k.removeAudioTrack(L)}))}L.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=dO.Disconnected}getStats(L){var k,M;return L?null===(M=this.recvConnection)||void 0===M?void 0:M.getStats():null===(k=this.sendConnection)||void 0===k?void 0:k.getStats()}getRemoteVideoIsReady(L){var k;return(null===(k=this.recvConnection)||void 0===k?void 0:k.getRemoteVideoIsReady(L))||!1}getLocalAudioVolume(){const L=this.localTrackMap.get(cO.LocalAudioTrack);if(L)return L.track.getVolumeLevel()}getLocalVideoSize(){const L=this.localTrackMap.get(cO.LocalVideoTrack);if(L)return{width:L.track.videoWidth||0,height:L.track.videoHeight||0}}getEncoderConfig(L){const k=this.localTrackMap.get(L);return k&&k.track instanceof eU||k&&k.track instanceof uM?k.track._encoderConfig:void 0}getLocalMedia(L){return this.localTrackMap.get(L)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(L,k){if(!L)return this.remoteUserMap.size>0;const M=this.remoteUserMap.get(L);return!!M&&(!k||M.has(k))}async hasRemoteMediaWithLock(L,k){if(!L)return this.remoteUserMap.size>0;const M=this.remoteUserMap.get(L);return!!M&&(!k||M.has(k))}getRemoteMedia(L){var k;const M=Array.from(w_(k=this.remoteUserMap).call(k)).find((k=>k.uid===L));return M?{audioTrack:M.audioTrack,audioSSRC:M._audioSSRC,videoTrack:M.videoTrack,videoSSRC:M._videoSSRC}:{}}getAudioLevels(){let L=Array.from(this.remoteUserMap.entries()).map((L=>{let[k]=L;return{uid:k.uid,level:k.audioTrack?100*k.audioTrack._source.getAccurateVolumeLevel():0}}));const k=this.localTrackMap.get(cO.LocalAudioTrack);return k&&L.push({level:100*k.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),L=gE(L).call(L,((L,k)=>L.level-k.level)),L}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(Eb.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=dO.Reconnecting,zA("KEEP_LAST_FRAME")&&0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((L=>{let[k]=L;var M;k._videoTrack&&k._videoTrack._player&&(null===(M=k._videoTrack._player.getVideoElement())||void 0===M||M.pause(),k._videoTrack._player.isKeepLastFrame=!0,k._videoTrack._originMediaStreamTrack.stop())})),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,0!==this.localTrackMap.size&&(Array.from(this.localTrackMap.entries()).forEach((L=>{var k;let[M,{track:U}]=L;switch(M){case cO.LocalVideoTrack:Sr(k=U._hints).call(k,sL.LOW_STREAM)?U.close():this.pendingLocalTracks.push(U);break;case cO.LocalAudioTrack:U instanceof SM?this.pendingLocalTracks=this.pendingLocalTracks.concat(U.trackList):this.pendingLocalTracks.push(U);case cO.LocalVideoLowTrack:}})),this.emit(lO.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((L=>{let[k,M]=L;Array.from(w_(M).call(M)).forEach((L=>{this.setPendingRemoteMedia(k,L)})),this.emit(lO.MediaReconnectStart,k.uid)})),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),Eb.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(L,k){for(const M of this.pendingRemoteTracks){const{user:U,kind:x}=M;if((L instanceof sF?L.uid:L)===U.uid&&k===x)return!0}return!1}setPendingRemoteMedia(L,k){this.hasPendingRemoteMedia(L,k)||this.pendingRemoteTracks.push({user:L,kind:k})}async restartICE(L,k){let M,U;if(L===Dw.SEND_ONLY){if(!this.sendConnection)throw new nv(iv.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");M=await this.sendMutex.lock("From P2PChannel.restartICE"),U=this.sendConnection}else{if(!this.recvConnection)throw new nv(iv.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");M=await this.recvMutex.lock("From P2PChannel.restartICE"),U=this.recvConnection}try{if(k){const L=await U.restartICE(k);return U.isInRestartIce=!1,L}{const L=await U.restartICE();if(L){const k=await Xy(this,lO.RequestP2PRestartICE,{direction:Dw.RECEIVE_ONLY,iceParameter:L});await U.restartICE(k),U.isInRestartIce=!1}}}finally{M()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;const L=this.sendConnection.getStats(),k=this.localTrackMap.get(cO.LocalVideoTrack),M=this.localTrackMap.get(cO.LocalAudioTrack),U=L.videoSend.find((L=>{var M;return L.ssrc===(null==k||null===(M=k.ssrcs)||void 0===M?void 0:M[0].ssrcId)})),x=L.audioSend.find((L=>{var k;return L.ssrc===(null==M||null===(k=M.ssrcs)||void 0===k?void 0:k[0].ssrcId)}));if(!U||!x)return 1;const V=Zy(this,lO.NeedSignalRTT),F=U?U.rttMs:void 0,j=x?x.rttMs:void 0,z=F&&j?(F+j)/2:F||j,Q=(z&&V?(z+V)/2:z||V)||0,$=100*L.sendPacketLossRate*.7/50+.3*Q/1500,ee=$<.17?1:$<.36?2:$<.59?3:$<.1?4:5,te=null==k?void 0:k.track;if(te&&te._encoderConfig&&-1===te._hints.indexOf(sL.SCREEN_TRACK)){const k=te._encoderConfig.bitrateMax,M=L.bitrate.actualEncoded;if(k&&M){const L=(1e3*k-M)/(1e3*k);return vb[L<.15?0:L<.3?1:L<.45?2:L<.6?3:4][ee]}}return ee}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;const L=this.recvConnection.getStats();let k=0;return Array.from(this.remoteUserMap.entries()).forEach((M=>{let[U]=M;const x=U._audioSSRC,V=U._videoSSRC,F=L.audioRecv.find((L=>L.ssrc===x)),j=L.videoRecv.find((L=>L.ssrc===V));if(!F&&!j)return void(k+=1);const z=Zy(this,lO.NeedSignalRTT),Q=L.rtt,$=(Q&&z?(Q+z)/2:Q||z)||0,ee=F?F.jitterMs:void 0,te=L.recvPacketLossRate;let ie=.7*te*100/50+.3*$/1500;ee&&(ie=.6*te*100/50+.2*$/1500+.2*ee/400),k+=ie<.1?1:ie<.17?2:ie<.36?3:ie<.59?4:5})),this.remoteUserMap.size>0?Math.round(k/this.remoteUserMap.size):k}async muteLocalTrack(L){return new Mp(((k,M)=>{this.handleMuteLocalTrack(L,k,M)}))}filterTobePublishedTracks(L,k,M){const U=[],x=XP(),V=this.getAllTracks();L=iA(L=L.filter((L=>-1===V.indexOf(L))));let F=!1,j=!1;for(const V of L){if(V instanceof eU&&(this.localTrackMap.has(cO.LocalVideoTrack)||F?new nv(iv.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(U.push({track:V,type:cO.LocalVideoTrack}),F=!0),k)){const L=this.getLowVideoTrack(V,M);U.push({track:L,type:cO.LocalVideoLowTrack})}if(V instanceof uM){const L=this.localTrackMap.get(cO.LocalAudioTrack);if(L){if(!(L.track instanceof SM))throw new nv(iv.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(V._bypassWebAudio)throw new nv(iv.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");L.track.addAudioTrack(V),this.bindLocalAudioTrackEvents(V,!0)}else if(j){const L=U.find((L=>{let{type:k}=L;return k===cO.LocalAudioTrack}));if(!(L.track instanceof SM))throw new nv(iv.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(V._bypassWebAudio)throw new nv(iv.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");L.track.addAudioTrack(V)}else{if(!x.webAudioMediaStreamDest||V instanceof SM||V._bypassWebAudio)U.push({track:V,type:cO.LocalAudioTrack});else{const L=new SM;L.addAudioTrack(V),U.push({track:L,type:cO.LocalAudioTrack})}j=!0}}}return U}filterTobeUnpublishedTracks(L){const k=[],M=this.getAllTracks();L=iA(L=L.filter((L=>-1!==M.indexOf(L))));for(const M of L){if(M instanceof uM){const L=this.localTrackMap.get(cO.LocalAudioTrack);if(!L)continue;L.track instanceof SM?(L.track.removeAudioTrack(M),this.unbindLocalAudioTrackEvents(M),0===L.track.trackList.length&&(k.push([cO.LocalAudioTrack,L]),L.track.close())):k.push([cO.LocalAudioTrack,L])}if(M instanceof eU){const L=this.localTrackMap.get(cO.LocalVideoTrack);if(!L)continue;k.push([cO.LocalVideoTrack,L]);const M=this.localTrackMap.get(cO.LocalVideoLowTrack);M&&k.push([cO.LocalVideoLowTrack,M])}}return k}bindLocalTrackEvents(L){L.forEach((L=>{let{track:k,type:M}=L;switch(M){case cO.LocalVideoTrack:k.addListener(oL.GET_STATS,this.handleGetLocalVideoStats),k.addListener(oL.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),k.addListener(oL.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),k.addListener(oL.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),k.addListener(oL.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),k.addListener(oL.NEED_REPLACE_TRACK,this.handleReplaceTrack),k.addListener(oL.NEED_MUTE_TRACK,this.handleMuteLocalTrack),k.addListener(oL.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case cO.LocalAudioTrack:this.bindLocalAudioTrackEvents(k);case cO.LocalVideoLowTrack:}}))}bindLocalAudioTrackEvents(L,k){L instanceof SM?L.trackList.forEach((L=>{L.addListener(oL.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),L.addListener(oL.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),L.addListener(oL.GET_STATS,this.handleGetLocalAudioStats),L.addListener(oL.NEED_MUTE_TRACK,this.handleMuteLocalTrack),L.addListener(oL.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(L.addListener(oL.GET_STATS,this.handleGetLocalAudioStats),L.addListener(oL.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),L.addListener(oL.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),L.addListener(oL.NEED_MUTE_TRACK,this.handleMuteLocalTrack),L.addListener(oL.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),k||L.addListener(oL.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(L){L||(L=Array.from(this.localTrackMap.entries()).map((L=>{let[k,{track:M}]=L;return{track:M,type:k}}))),L.forEach((L=>{let{track:k,type:M}=L;switch(M){case cO.LocalVideoTrack:k.off(oL.GET_STATS,this.handleGetLocalVideoStats),k.off(oL.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),k.off(oL.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),k.off(oL.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),k.off(oL.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),k.off(oL.NEED_REPLACE_TRACK,this.handleReplaceTrack),k.off(oL.NEED_MUTE_TRACK,this.handleMuteLocalTrack),k.off(oL.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case cO.LocalAudioTrack:this.unbindLocalAudioTrackEvents(k);case cO.LocalVideoLowTrack:}}))}unbindLocalAudioTrackEvents(L){L instanceof SM?L.trackList.forEach((L=>{L.off(oL.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),L.off(oL.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),L.off(oL.GET_STATS,this.handleGetLocalAudioStats),L.off(oL.NEED_MUTE_TRACK,this.handleMuteLocalTrack),L.off(oL.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(L.off(oL.GET_STATS,this.handleGetLocalAudioStats),L.off(oL.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),L.off(oL.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),L.off(oL.NEED_REPLACE_TRACK,this.handleReplaceTrack),L.off(oL.NEED_MUTE_TRACK,this.handleMuteLocalTrack),L.off(oL.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(L,k){k instanceof EU&&k.addListener(oL.GET_STATS,(k=>{k(this.handleGetRemoteVideoStats(L))})),k instanceof fU&&k.addListener(oL.GET_STATS,(k=>{k(this.handleGetRemoteAudioStats(L))}))}unbindRemoteTrackEvents(L){L&&L.removeAllListeners(oL.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach((L=>{let[k,M]=L;M.has(nO.AUDIO)&&this.unbindRemoteTrackEvents(k._audioTrack),M.has(nO.VIDEO)&&this.unbindRemoteTrackEvents(k._videoTrack)}))}createGatewayPublishMessage(L,k){return L.map(((L,M)=>{var U;let x,{track:V,type:F}=L;switch(F){case cO.LocalAudioTrack:x=qw.Audio;break;case cO.LocalVideoTrack:x=Sr(U=V._hints).call(U,sL.SCREEN_TRACK)?qw.Screen:qw.High;break;case cO.LocalVideoLowTrack:x=qw.Low}return{kind:F===cO.LocalAudioTrack?nO.AUDIO:nO.VIDEO,stream_type:x,mid:k[M].id,ssrcs:k[M].localSSRC,isMuted:V.muted||!V.enabled}}))}createGatewayUnpublishMessage(L){return L.map((L=>{var k;let M,[U,{track:x,ssrcs:V,id:F}]=L;switch(U){case cO.LocalVideoTrack:M=Sr(k=x._hints).call(k,sL.SCREEN_TRACK)?qw.Screen:qw.High;break;case cO.LocalAudioTrack:M=qw.Audio;break;case cO.LocalVideoLowTrack:M=qw.Low}return{stream_type:M,ssrcs:V,mid:F}}))}assignLocalTracks(L,k){L.forEach(((L,M)=>{let{track:U,type:x}=L;this.localTrackMap.set(x,{track:U,id:k[M].id,ssrcs:k[M].localSSRC})}))}withdrawLocalTracks(L){L.forEach((L=>{let[k]=L;this.localTrackMap.delete(k)}))}bindConnectionEvents(L){L.onConnectionStateChange=async k=>{var M;Eb.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(L.name,".onConnectionStateChange(").concat(k,")")),this.emit(lO.PeerConnectionStateChange,k),"connected"!==k||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),"connected"===k&&(L.isInRestartIce=!1),Sr(M=this._restartStates).call(M,k)&&!L.isInRestartIce&&("disconnected"===k&&await EA(800),"disconnected"!==L.iceConnectionState&&"failed"!==L.iceConnectionState||this.handleDisconnect(L.direction))},L.onICEConnectionStateChange=L=>{"connected"!==L||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),Eb.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(L,")")),Ab.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:L,tag:lv.TRACER}).onSuccess(),this.emit(lO.IceConnectionStateChange,L)},L.onICETransportStateChange=L=>{Eb.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(L,")"))},L.onDTLSTransportStateChange=L=>{Eb.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(L,")"))},L.onDTLSTransportError=L=>{Eb.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(L,")"))},L.onFirstAudioDecoded=L=>{var k;const M=Array.from(w_(k=this.remoteUserMap).call(k)).find((k=>k._audioSSRC===L));var U;M&&(this.store.subscribe(M.uid,"audio",void 0,void 0,void 0,Date.now()),null===(U=M.audioTrack)||void 0===U||U.emit(mL.FIRST_FRAME_DECODED),Ab.firstRemoteFrame(this.store.sessionId,Tb.FIRST_AUDIO_DECODE,Sb.FIRST_AUDIO_DECODE,{peer:M._uintid,subscribeElapse:Cx.measureFromSubscribeStart(this.store.clientId,L),subscribeRequestid:L,p2pid:this.store.p2pId}))},L.onFirstAudioReceived=L=>{var k;const M=Array.from(w_(k=this.remoteUserMap).call(k)).find((k=>k._audioSSRC===L));M&&Ab.firstRemoteFrame(this.store.sessionId,Tb.FIRST_AUDIO_RECEIVED,Sb.FIRST_AUDIO_RECEIVED,{peer:M._uintid,subscribeElapse:Cx.measureFromSubscribeStart(this.store.clientId,L),subscribeRequestid:L,p2pid:this.store.p2pId})},L.onFirstVideoDecoded=(L,k,M)=>{this.reportVideoFirstFrameDecoded(L,k,M)},L.onFirstVideoReceived=L=>{var k;const M=Array.from(w_(k=this.remoteUserMap).call(k)).find((k=>k._videoSSRC===L));M&&Ab.firstRemoteFrame(this.store.sessionId,Tb.FIRST_VIDEO_RECEIVED,Sb.FIRST_VIDEO_RECEIVED,{peer:M._uintid,subscribeElapse:Cx.measureFromSubscribeStart(this.store.clientId,L),subscribeRequestid:L,p2pid:this.store.p2pId})},L.onSelectedLocalCandidateChanged=(L,k)=>{const M="relay"===L.candidateType,U="relay"===k.candidateType;"unknown"!==k.candidateType&&M===U||this.emit(lO.ConnectionTypeChange,M),Eb.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(tN(k))," -> ").concat(JSON.stringify(tN(L)),")"))},L.onSelectedRemoteCandidateChanged=(L,k)=>{Eb.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(tN(k))," -> ").concat(JSON.stringify(tN(L)),")"))},L.onFirstVideoDecodedTimeout=L=>{this.reportVideoFirstFrameDecoded(L,void 0,void 0,!0)},L.onLocalCandidate=k=>{this.emit(lO.LocalCandidate,{candidate:k,direction:L.direction})}}unbindConnectionEvents(L){L.onConnectionStateChange=void 0,L.onICEConnectionStateChange=void 0,L.onICETransportStateChange=void 0,L.onDTLSTransportStateChange=void 0,L.onDTLSTransportError=void 0,L.onFirstAudioDecoded=void 0,L.onFirstAudioReceived=void 0,L.onFirstVideoDecoded=void 0,L.onFirstVideoReceived=void 0,L.onSelectedLocalCandidateChanged=void 0,L.onSelectedRemoteCandidateChanged=void 0,L.onFirstVideoDecodedTimeout=void 0,L.onLocalCandidate=void 0}async handleDisconnect(L){const k=L===Dw.SEND_ONLY?this.sendConnection:this.recvConnection;k&&!k.isInRestartIce&&(k.isInRestartIce=!0,Eb.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(k.name,"] start use restartICE")),L===Dw.SEND_ONLY?this.restartICE(L):Xy(this,lO.RequestP2PRestartICE,{direction:Dw.SEND_ONLY}))}filterTobeMutedTracks(L){const k=[];if(-1===this.getAllTracks().indexOf(L))return k;const M=this.localTrackMap.get(cO.LocalAudioTrack);if(L instanceof uM&&(null==M?void 0:M.track)instanceof SM)return M.track.isActive||k.push([cO.LocalAudioTrack,M]),k;const U=Array.from(this.localTrackMap.entries()).find((k=>{let[,{track:M}]=k;return L===M}));if(U&&(k.push(U),U[0]===cO.LocalVideoTrack)){const L=this.localTrackMap.get(cO.LocalVideoLowTrack);L&&k.push([cO.LocalVideoLowTrack,L])}return k}filterTobeUnmutedTracks(L){const k=[],M=this.localTrackMap.get(cO.LocalAudioTrack);if(L instanceof uM&&(null==M?void 0:M.track)instanceof SM)return M.track.isActive&&k.push([cO.LocalAudioTrack,M]),k;const U=Array.from(this.localTrackMap.entries()).find((k=>{let[,{track:M}]=k;return L===M}));if(U)if(U[0]===cO.LocalVideoTrack){k.push(U);const L=this.localTrackMap.get(cO.LocalVideoLowTrack);L&&k.push([cO.LocalVideoLowTrack,L])}else k.push(U);return k}createMuteMessage(L){return L.map((L=>{var k;let M,[U,{track:x,ssrcs:V,id:F}]=L;switch(U){case cO.LocalAudioTrack:M=qw.Audio;break;case cO.LocalVideoTrack:M=Sr(k=x._hints).call(k,sL.SCREEN_TRACK)?qw.Screen:qw.High;break;case cO.LocalVideoLowTrack:M=qw.Low}return{stream_type:M,ssrcs:V,mid:F}}))}createUnmuteMessage(L){return L.map((L=>{var k;let M,[U,{track:x,ssrcs:V,id:F}]=L;switch(U){case cO.LocalAudioTrack:M=qw.Audio;break;case cO.LocalVideoTrack:M=Sr(k=x._hints).call(k,sL.SCREEN_TRACK)?qw.Screen:qw.High;break;case cO.LocalVideoLowTrack:M=qw.Low}return{stream_type:M,ssrcs:V,mid:F}}))}filterTobeUnSubscribedTracks(L,k){const M=[],U=this.remoteUserMap.get(L);if(!U)return M;if(k){const x=U.get(k);if(!x)return M;M.push([L,{kind:k,id:x}])}else Array.from(U.entries()).forEach((k=>{let[U,x]=k;M.push([L,{kind:U,id:x}])}));return M}createUnsubscribeMessage(L){const k=[];return L.forEach((L=>{let[M,{kind:U,id:x}]=L;switch(U){case nO.VIDEO:return void(M._videoSSRC&&k.push({stream_type:nO.VIDEO,ssrcId:M._videoSSRC}));case nO.AUDIO:return void(M._audioSSRC&&k.push({stream_type:nO.AUDIO,ssrcId:M._audioSSRC}))}})),k}withdrawRemoteTracks(L){L.forEach((L=>{let[k,{kind:M}]=L;const U=this.remoteUserMap.get(k);U&&(U.delete(M),0===Array.from(U.entries()).length&&this.remoteUserMap.delete(k))}))}async updateBitrateLimit(L){const k=this.localTrackMap.get(cO.LocalVideoTrack),M=this.localTrackMap.get(cO.LocalVideoLowTrack);k&&await k.track.setBitrateLimit(L.uplink),M&&L.low_stream_uplink&&await M.track.setBitrateLimit({max_bitrate:L.low_stream_uplink.bitrate,min_bitrate:L.low_stream_uplink.bitrate||0})}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){const L=this.sendConnection.peerConnectionState,k=this.recvConnection.peerConnectionState;return"connected"!==L&&"connected"!==k}return!0}async tryToUnmuteAudio(L){for(let k=0;k<L.length;k++)if(L[k]instanceof uM){const M=this.filterTobeUnmutedTracks(L[k]);if(0===M.length)continue;const U=this.createUnmuteMessage(M);return void await Qy(this,lO.RequestUnmuteLocal,U)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=L=>this.getStats(L),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter((L=>{let[,{ssrcs:k}]=L;return!!k})),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=L=>{var k;return!(null===(k=this.recvConnection)||void 0===k||!k.getRemoteVideoIsReady(L))},this.statsUploader.requestUpload=(L,k)=>this.emit(lO.RequestUpload,L,k),this.statsUploader.requestUploadStats=L=>this.emit(lO.RequestUploadStats,L),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await EA(DA(this.dtlsFailedCount,Ov)),this.emit(lO.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(cO.LocalVideoTrack)||this.pendingLocalTracks.some((L=>L instanceof eU))}throwIfTrackTypeNotMatch(L){if(L.filter((L=>L instanceof eU)).length>1)throw new nv(iv.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(L.filter((L=>L instanceof uM)).length>1&&(L.some((L=>L instanceof uM&&L._bypassWebAudio))||!XP().webAudioMediaStreamDest))throw new nv(iv.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const k of L){if(k instanceof eU&&this.pendingLocalTracks.some((L=>L instanceof eU)))throw new nv(iv.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(k instanceof uM&&this.pendingLocalTracks.some((L=>L instanceof uM))&&(!XP().webAudioMediaStreamDest||k._bypassWebAudio||this.pendingLocalTracks.some((L=>L instanceof uM&&L._bypassWebAudio))))throw new nv(iv.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(L,k){const M=!zA("DISABLE_DUAL_STREAM_USE_ENCODING")&&XP().supportDualStreamEncoding,U=vF(vF({},{width:160,height:120,framerate:15,bitrate:50}),k);let x;x=M?L._mediaStreamTrack.clone():WV(L,U);const V=fA(8,"track-low-"),F=new eU(x,vF(vF({},M&&{scaleResolutionDownBy:eN(U,L)}),{},{frameRate:U.framerate,bitrateMax:U.bitrate,bitrateMin:U.bitrate}),void 0,void 0,V);return F.on(EL.TRANSCEIVER_UPDATED,(k=>{L._updateRtpTransceiver(k,lL.LOW_STREAM)})),F._hints.push(sL.LOW_STREAM),L.addListener(oL.NEED_CLOSE,(()=>{F.close()})),F}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(L,k,M,U){var x;const V=Array.from(w_(x=this.remoteUserMap).call(x)).find((k=>k._videoSSRC===L));if(V){U||this.store.subscribe(V.uid,"video",void 0,void 0,void 0,void 0,Date.now());const x=this.store.keyMetrics,F=x.subscribe.find((L=>L.userId===V.uid&&"video"===L.type));Ab.firstRemoteVideoDecode(this.store.sessionId,Tb.FIRST_VIDEO_DECODE,Sb.FIRST_VIDEO_DECODE,{peer:V._uintid,videowidth:k,videoheight:M,subscribeElapse:Cx.measureFromSubscribeStart(this.store.clientId,L),subscribeRequestid:L,p2pid:this.store.p2pId,apEnd:x.requestAPEnd||0,apStart:x.requestAPStart||0,joinGwEnd:x.joinGatewayEnd||0,joinGwStart:x.joinGatewayStart||0,pcEnd:x.peerConnectionEnd||0,pcStart:x.peerConnectionStart||0,subscriberEnd:(null==F?void 0:F.subscribeEnd)||0,subscriberStart:(null==F?void 0:F.subscribeStart)||0,videoAddNotify:(null==F?void 0:F.streamAdded)||0,state:U?1:0})}}async remoteMediaSsrcChanged(L,k,M){if(!this.recvConnection)return!1;const U=this.remoteUserMap.get(L);if(!U)return!1;const x=U.get(k);if(!x)return!1;const V=await this.recvConnection.getRemoteSSRC(x);return void 0!==V&&V!==M}isPreSubScribe(L){return!1}async publishDataChannel(L){throw new nv(iv.NOT_SUPPORTED)}async unpublishDataChannel(L){throw new nv(iv.NOT_SUPPORTED)}async subscribeDataChannel(L,k){throw new nv(iv.NOT_SUPPORTED)}async unsubscribeDataChannel(L,k){throw new nv(iv.NOT_SUPPORTED)}hasPendingRemoteDataChannel(L,k){throw new nv(iv.NOT_SUPPORTED)}setPendingRemoteDataChannel(L,k){throw new nv(iv.NOT_SUPPORTED)}async preConnect(L){throw new nv(iv.NOT_SUPPORTED)}getEstablishParams(){throw new nv(iv.NOT_SUPPORTED)}async reSubscribe(L){throw new nv(iv.NOT_SUPPORTED)}async updateVideoStreamParameter(L,k){throw new nv(iv.NOT_SUPPORTED)}unbindRtpTransceiver(){0!==this.localTrackMap.size&&Array.from(this.localTrackMap.entries()).forEach((L=>{let[k,{track:M}]=L;k===cO.LocalVideoLowTrack?M._updateRtpTransceiver(void 0,lL.LOW_STREAM):M._updateRtpTransceiver(void 0)}))}},gw(pF.prototype,"p2pConnect",[qV],Object.getOwnPropertyDescriptor(pF.prototype,"p2pConnect"),pF.prototype),gw(pF.prototype,"unpublish",[XV],Object.getOwnPropertyDescriptor(pF.prototype,"unpublish"),pF.prototype),gw(pF.prototype,"unpublishLowStream",[JV],Object.getOwnPropertyDescriptor(pF.prototype,"unpublishLowStream"),pF.prototype),gw(pF.prototype,"subscribe",[QV],Object.getOwnPropertyDescriptor(pF.prototype,"subscribe"),pF.prototype),gw(pF.prototype,"mockSubscribe",[ZV],Object.getOwnPropertyDescriptor(pF.prototype,"mockSubscribe"),pF.prototype),gw(pF.prototype,"unsubscribe",[$V],Object.getOwnPropertyDescriptor(pF.prototype,"unsubscribe"),pF.prototype),gw(pF.prototype,"muteRemote",[eF],Object.getOwnPropertyDescriptor(pF.prototype,"muteRemote"),pF.prototype),gw(pF.prototype,"unmuteRemote",[tF],Object.getOwnPropertyDescriptor(pF.prototype,"unmuteRemote"),pF.prototype),gw(pF.prototype,"hasRemoteMediaWithLock",[aF],Object.getOwnPropertyDescriptor(pF.prototype,"hasRemoteMediaWithLock"),pF.prototype),gw(pF.prototype,"disconnectForReconnect",[uF],Object.getOwnPropertyDescriptor(pF.prototype,"disconnectForReconnect"),pF.prototype),gw(pF.prototype,"remoteMediaSsrcChanged",[hF],Object.getOwnPropertyDescriptor(pF.prototype,"remoteMediaSsrcChanged"),pF.prototype),pF);function AF(L){return function(k,M,U){const x=k[M];if("function"!=typeof x)throw new Error("Cannot use mutex on object property.");return U.value=async function(){for(var k=arguments.length,U=new Array(k),V=0;V<k;V++)U[V]=arguments[V];switch(L){case YV.SEND_ONLY:{const L=await this.sendMutex.lock("From P2PChannel2.".concat(M));try{return await x.apply(this,U)}finally{L()}}case YV.RECEIVE_ONLY:{const L=await this.recvMutex.lock("From P2PChannel2.".concat(M));try{return await x.apply(this,U)}finally{L()}}default:{const L=await this.sendMutex.lock("From P2PChannel2.".concat(M)),k=await this.recvMutex.lock("From P2PChannel2.".concat(M));try{return await x.apply(this,U)}finally{L(),k()}}}},U}}function bF(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function wF(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?bF(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):bF(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}class OF{constructor(L){xg(this,"store",void 0),xg(this,"onStatsException",void 0),xg(this,"onUploadPublishDuration",void 0),xg(this,"onStatsChanged",void 0),xg(this,"localStats",new Map),xg(this,"remoteStats",new Map),xg(this,"updateStatsInterval",void 0),xg(this,"trafficStats",void 0),xg(this,"trafficStatsPeerList",[]),xg(this,"uplinkStats",void 0),xg(this,"exceptionMonitor",void 0),xg(this,"p2pChannel",void 0),xg(this,"scalabilityMode",Tw.L1T1),xg(this,"updateStats",(()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))})),this.store=L,this.exceptionMonitor=new eV,this.exceptionMonitor.on("exception",((L,k,M)=>{this.onStatsException&&this.onStatsException(L,k,M)}))}startUpdateStats(){this.updateStatsInterval||(this.updateStatsInterval=window.setInterval(this.updateStats,1e3))}stopUpdateStats(){this.updateStatsInterval&&(window.clearInterval(this.updateStatsInterval),this.updateStatsInterval=void 0)}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(cO.LocalAudioTrack)||wF({},SL)}getLocalVideoTrackStats(){return this.localStats.get(cO.LocalVideoTrack)||wF({},RL)}getRemoteAudioTrackStats(L){const t=(L,k)=>{if(!this.trafficStats)return k;const M=this.trafficStats.peer_delay.find((k=>k.peer_uid===L));return M&&(k.publishDuration=M.B_ppad+(Date.now()-this.trafficStats.timestamp)),k},k={};if(L){var M;const U=null===(M=this.remoteStats.get(L))||void 0===M?void 0:M.audioStats;U&&(k[L]=t(L,U))}else Array.from(this.remoteStats.entries()).forEach((L=>{let[M,{audioStats:U}]=L;U&&(k[M]=t(M,U))}));return k}getRemoteNetworkQualityStats(L){const k={};if(L){var M;const U=null===(M=this.remoteStats.get(L))||void 0===M?void 0:M.networkStats;U&&(k[L]=U)}else Array.from(this.remoteStats.entries()).forEach((L=>{let[M,{networkStats:U}]=L;U&&(k[M]=U)}));return k}getRemoteVideoTrackStats(L){const t=(L,k)=>{if(!this.trafficStats)return k;const M=this.trafficStats.peer_delay.find((k=>k.peer_uid===L));return M&&(k.publishDuration=M.B_ppvd+(Date.now()-this.trafficStats.timestamp)),k},k={};if(L){var M;const U=null===(M=this.remoteStats.get(L))||void 0===M?void 0:M.videoStats;U&&(k[L]=t(L,U))}else Array.from(this.remoteStats.entries()).forEach((L=>{let[M,{videoStats:U}]=L;U&&(k[M]=t(M,U))}));return k}getRTCStats(){let L=0,k=0,M=0,U=0;const x=this.localStats.get(cO.LocalAudioTrack);x&&(L+=x.sendBytes,k+=x.sendBitrate);const V=this.localStats.get(cO.LocalVideoTrack);V&&(L+=V.sendBytes,k+=V.sendBitrate);const F=this.localStats.get(cO.LocalVideoLowTrack);F&&(L+=F.sendBytes,k+=F.sendBitrate),this.remoteStats.forEach((L=>{let{audioStats:k,videoStats:x}=L;k&&(M+=k.receiveBytes,U+=k.receiveBitrate),x&&(M+=x.receiveBytes,U+=x.receiveBitrate)}));let j=1;return this.trafficStats&&(j+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:j,SendBitrate:k,SendBytes:L,RecvBytes:M,RecvBitrate:U,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(L){this.localStats.set(L,void 0)}removeLocalStats(L){L?this.localStats.delete(L):this.localStats.clear()}addRemoteStats(L){this.remoteStats.set(L,{})}removeRemoteStats(L){L?this.remoteStats.delete(L):this.remoteStats.clear()}addP2PChannel(L){this.p2pChannel=L}updateTrafficStats(L){L.peer_delay=L.peer_delay.filter((L=>void 0!==L.B_ppad||void 0!==L.B_ppvd)),L.peer_delay.filter((L=>-1===this.trafficStatsPeerList.indexOf(L.peer_uid))).forEach((L=>{var k;const M=null===(k=this.p2pChannel)||void 0===k?void 0:k.getRemoteMedia(L.peer_uid),U=null!=M&&M.videoSSRC?Cx.measureFromSubscribeStart(this.store.clientId,M.videoSSRC):0,x=null!=M&&M.audioSSRC?Cx.measureFromSubscribeStart(this.store.clientId,M.audioSSRC):0;void 0!==L.B_ppad&&void 0!==L.B_ppvd&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(L.peer_uid,L.B_ppad,L.B_ppvd,U>x?U:x),this.trafficStatsPeerList.push(L.peer_uid))})),this.trafficStats=L}updateUplinkStats(L){this.uplinkStats&&this.uplinkStats.B_fir!==L.B_fir&&Eb.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(L.B_fir)),this.uplinkStats=L}static isRemoteVideoFreeze(L,k,M){if(!L)return!1;const U=!!M&&k.framesDecodeFreezeTime>M.framesDecodeFreezeTime,x=!M||k.framesDecodeCount>M.framesDecodeCount;return U||!x}static isRemoteAudioFreeze(L){return!!L&&L._isFreeze()}isLocalVideoFreeze(L){return!(!L.inputFrame||!L.sentFrame)&&L.inputFrame.frameRate>5&&L.sentFrame.frameRate<3}updateLocalStats(L){Array.from(this.localStats.entries()).forEach((k=>{let[M,U]=k;switch(M){case cO.LocalVideoTrack:case cO.LocalVideoLowTrack:{const k=U,V=wF({},RL),F=L.getStats(),j=L.getLocalMedia(M);if(F){const M=F.videoSend.find((L=>L.ssrc===(null==j?void 0:j.ssrcs[0].ssrcId)));if(M){const U=L.getLocalVideoSize(),x=L.getEncoderConfig(cO.LocalVideoTrack);"H264"!==M.codec&&"H265"!==M.codec&&"VP8"!==M.codec&&"VP9"!==M.codec&&"AV1X"!==M.codec&&"AV1"!==M.codec||(V.codecType=M.codec),V.sendBytes=M.bytes,V.sendBitrate=k?8*Math.max(0,V.sendBytes-k.sendBytes):0,M.inputFrame?(V.captureFrameRate=M.inputFrame.frameRate,V.captureResolutionHeight=M.inputFrame.height,V.captureResolutionWidth=M.inputFrame.width):U&&(V.captureResolutionWidth=U.width,V.captureResolutionHeight=U.height),M.sentFrame?(V.sendFrameRate=M.sentFrame.frameRate,V.sendResolutionHeight=M.sentFrame.height,V.sendResolutionWidth=M.sentFrame.width):U&&(V.sendResolutionWidth=U.width,V.sendResolutionHeight=U.height),M.avgEncodeMs&&(V.encodeDelay=M.avgEncodeMs),x&&x.bitrateMax&&(V.targetSendBitrate=1e3*x.bitrateMax),V.sendPackets=M.packets,V.sendPacketsLost=M.packetsLost,V.sendJitterMs=M.jitterMs,V.sendRttMs=M.rttMs,V.totalDuration=k?k.totalDuration+1:1,V.totalFreezeTime=k?k.totalFreezeTime:0,this.isLocalVideoFreeze(M)&&(V.totalFreezeTime+=1),M.scalabilityMode&&this.scalabilityMode!==M.scalabilityMode&&(Eb.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(M.scalabilityMode)),this.scalabilityMode=M.scalabilityMode)}this.trafficStats&&(V.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var x;this.localStats.set(M,V),((null==k?void 0:k.sendResolutionWidth)!==V.sendResolutionWidth||(null==k?void 0:k.sendResolutionHeight)!==V.sendResolutionHeight)&&(null===(x=this.onStatsChanged)||void 0===x||x.call(this,"resolution",{width:V.sendResolutionWidth,height:V.sendResolutionHeight})),V&&j&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,j.track,V);break}case cO.LocalAudioTrack:{const k=U,x=wF({},SL),V=L.getStats(),F=L.getLocalMedia(M);if(V){const M=V.audioSend.find((L=>L.ssrc===(null==F?void 0:F.ssrcs[0].ssrcId)));if(M){if("opus"!==M.codec&&"aac"!==M.codec&&"PCMU"!==M.codec&&"PCMA"!==M.codec&&"G722"!==M.codec||(x.codecType=M.codec),M.inputLevel)x.sendVolumeLevel=Math.round(32767*M.inputLevel);else{const k=L.getLocalAudioVolume();k&&(x.sendVolumeLevel=Math.round(32767*k))}x.sendBytes=M.bytes,x.sendPackets=M.packets,x.sendPacketsLost=M.packetsLost,x.sendJitterMs=M.jitterMs,x.sendRttMs=M.rttMs,x.sendBitrate=k?8*Math.max(0,x.sendBytes-k.sendBytes):0}}this.trafficStats&&(x.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(cO.LocalAudioTrack,x),x&&F&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,F.track,x);break}}}))}updateRemoteStats(L){Array.from(this.remoteStats.entries()).forEach((k=>{var M,U;let[x,{videoStats:V,audioStats:F,videoPcStats:j}]=k;const z=F,Q=V,$=j,ee=wF({},IL),te=wF({},AL),ie=wF({},yL),{audioTrack:ne,videoTrack:re,audioSSRC:oe,videoSSRC:ce}=L.getRemoteMedia(x);let de;de=L instanceof _F?L.getStats(!0):L.getStats();const le=null===(M=de)||void 0===M?void 0:M.audioRecv.find((L=>L.ssrc===oe)),ue=null===(U=de)||void 0===U?void 0:U.videoRecv.find((L=>L.ssrc===ce)),he=this.trafficStats&&this.trafficStats.peer_delay.find((L=>L.peer_uid===x));if(le&&("opus"!==le.codec&&"aac"!==le.codec&&"PCMU"!==le.codec&&"PCMA"!==le.codec&&"G722"!==le.codec||(ee.codecType=le.codec),le.outputLevel?ee.receiveLevel=Math.round(32767*le.outputLevel):ne&&(ee.receiveLevel=Math.round(32767*ne.getVolumeLevel())),ee.receiveBytes=le.bytes,ee.receivePackets=le.packets,ee.receivePacketsLost=le.packetsLost,ee.receivePacketsDiscarded=le.packetsDiscarded,ee.packetLossRate=ee.receivePacketsLost/(ee.receivePackets+ee.receivePacketsLost),ee.receiveBitrate=z?8*Math.max(0,ee.receiveBytes-z.receiveBytes):0,ee.totalDuration=z?z.totalDuration+1:1,ee.totalFreezeTime=z?z.totalFreezeTime:0,ee.freezeRate=ee.totalFreezeTime/ee.totalDuration,ee.receiveDelay=le.jitterBufferMs,ee.totalDuration>10&&OF.isRemoteAudioFreeze(ne)&&(ee.totalFreezeTime+=1)),ue){"H264"!==ue.codec&&"H265"!==ue.codec&&"VP8"!==ue.codec&&"VP9"!==ue.codec&&"AV1X"!==ue.codec&&"AV1"!==ue.codec||(te.codecType=ue.codec),te.receiveBytes=ue.bytes,te.receiveBitrate=Q?8*Math.max(0,te.receiveBytes-Q.receiveBytes):0,te.decodeFrameRate=ue.decodeFrameRate<0?0:ue.decodeFrameRate,te.renderFrameRate=ue.decodeFrameRate<0?0:ue.decodeFrameRate,ue.outputFrame&&(te.renderFrameRate=ue.outputFrame.frameRate),ue.receivedFrame?(te.receiveFrameRate=ue.receivedFrame.frameRate,te.receiveResolutionHeight=ue.receivedFrame.height,te.receiveResolutionWidth=ue.receivedFrame.width):re&&(te.receiveResolutionHeight=re._videoHeight||0,te.receiveResolutionWidth=re._videoWidth||0),void 0!==ue.framesRateFirefox&&(te.receiveFrameRate=Math.round(ue.framesRateFirefox)),te.receivePackets=ue.packets,te.receivePacketsLost=ue.packetsLost,te.packetLossRate=te.receivePacketsLost/(te.receivePackets+te.receivePacketsLost),te.totalDuration=Q?Q.totalDuration+1:1,te.totalFreezeTime=Q?Q.totalFreezeTime:0,te.receiveDelay=ue.jitterBufferMs||0;const k=!!ce&&L.getRemoteVideoIsReady(ce);re&&k&&OF.isRemoteVideoFreeze(re,ue,$)&&(te.totalFreezeTime+=1),te.freezeRate=te.totalFreezeTime/te.totalDuration}he&&(ee.end2EndDelay=he.B_ad,te.end2EndDelay=he.B_vd,ee.transportDelay=he.B_ed,te.transportDelay=he.B_ed,ee.currentPacketLossRate=he.B_ealr4/100,te.currentPacketLossRate=he.B_evlr4/100,ie.uplinkNetworkQuality=he.B_punq?he.B_punq:0,ie.downlinkNetworkQuality=he.B_pdnq?he.B_pdnq:0),this.remoteStats.set(x,{audioStats:ee,videoStats:te,videoPcStats:ue,networkStats:ie}),ne&&this.exceptionMonitor.setRemoteAudioStats(ne,ee),re&&this.exceptionMonitor.setRemoteVideoStats(re,te)}))}}class NF{constructor(){xg(this,"destChannelMediaInfos",new Map),xg(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(L){Kw(L),this.srcChannelMediaInfo=L}addDestChannelInfo(L){Kw(L),this.destChannelMediaInfos.set(L.channelName,L)}removeDestChannelInfo(L){Mw(L),this.destChannelMediaInfos.delete(L)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function DF(L){if(!(L instanceof NF))return new Ib(iv.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();const k=L.getSrcChannelMediaInfo(),M=L.getDestChannelMediaInfo();return k?0===M.size?new Ib(iv.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw():void 0:new Ib(iv.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw()}function PF(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function LF(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?PF(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):PF(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}var EF;function MF(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function UF(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?MF(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):MF(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}let fF=(EF=class e extends sO{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map((L=>L.rtpMap&&L.rtpMap.encodingName.toLowerCase()||"")).filter((L=>{var k;return Sr(k=Object.keys(ib)).call(k,L)})))]}constructor(L,k){super(L,k),xg(this,"store",void 0),xg(this,"peerConnection",void 0),xg(this,"remoteSDP",void 0),xg(this,"initialOffer",void 0),xg(this,"statsFilter",void 0),xg(this,"useRTX",!1),xg(this,"localCapabilities",void 0),xg(this,"localCandidateCount",0),xg(this,"allCandidatesReceived",!1),xg(this,"establishPromise",void 0),xg(this,"mutex",new wv("P2PConnection-mutex")),this.store=k,this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(L),{optional:[{googDscp:!0}]}),this.statsFilter=MV(this.peerConnection,zA("STATS_UPDATE_INTERVAL"),void 0,Xv()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{const L=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!L.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const k=GU(L.sdp),M=jU(L.sdp,{filterRTX:!this.useRTX,filterVideoFec:zA("FILTER_VIDEO_FEC"),filterAudioFec:zA("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=M,this.initialOffer=L,UF(UF({},k),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:M},offerSDP:L.sdp})}catch(L){throw new nv(iv.GET_LOCAL_CONNECTION_PARAMS_FAILED,L.toString())}}async updateRemoteConnect(){}async connect(L){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{constructor(L){xg(this,"sessionDesc",void 0),xg(this,"localCapabilities",void 0),xg(this,"rtpCapabilities",void 0),xg(this,"candidates",void 0),xg(this,"iceParameters",void 0),xg(this,"dtlsParameters",void 0),xg(this,"setup",void 0),xg(this,"currentMidIndex",void 0),xg(this,"cname",void 0),L=rA(L);const{iceParameters:k,dtlsParameters:M,candidates:U,rtpCapabilities:x,setup:V,localCapabilities:F,sdkCodec:j,cname:z}=L,Q=wU.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE audio video\na=msid-semantic: WMS\na=ice-lite\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendrecv\na=rtcp-mux\na=rtcp-rsize\na=mid:audio\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendrecv\na=rtcp-mux\na=rtcp-rsize\na=mid:video\n");this.rtpCapabilities=x,this.candidates=U,this.iceParameters=k,this.dtlsParameters=M,this.setup=V,this.localCapabilities=F,this.cname=z;for(let L=0;L<Q.mediaDescriptions.length;L++){const F=Q.mediaDescriptions[L];if(F.attributes.iceUfrag=k.iceUfrag,F.attributes.icePwd=k.icePwd,F.attributes.fingerprints=M.fingerprints,F.attributes.candidates=U,F.attributes.setup=V,"video"===F.media.mediaType){F.media.fmts=x.videoCodecs.map((L=>L.payloadType.toString(10)));let L=x.videoCodecs.filter((L=>{var k,M;return null===(k=L.rtpMap)||void 0===k?void 0:Sr(M=k.encodingName.toLowerCase()).call(M,j)}));0===L.length&&(L=x.videoCodecs),F.attributes.payloads=L,F.attributes.extmaps=x.videoExtensions}"audio"===F.media.mediaType&&(F.media.fmts=x.audioCodecs.map((L=>L.payloadType.toString(10))),F.attributes.payloads=x.audioCodecs,F.attributes.extmaps=x.audioExtensions),Q.mediaDescriptions[L]=this.mungMediaDesc(F)}this.sessionDesc=Q,this.currentMidIndex=Q.mediaDescriptions.length-1}toString(){return wU.print(this.sessionDesc)}send(L,k,M){const{ssrcs:U,ssrcGroups:x}=YU(k,this.cname),V=this.sessionDesc.mediaDescriptions.find((k=>L===nO.VIDEO?"video"===k.media.mediaType:"audio"===k.media.mediaType)),F=U[0].attributes.label,j=U[0].attributes.mslabel;return V.attributes.ssrcs=V.attributes.ssrcs.concat(U),V.attributes.ssrcGroups=V.attributes.ssrcGroups.concat(x),{id:F,mslabel:j}}batchSend(L){return L.map((L=>{let{kind:k,ssrcMsg:M}=L;return this.send(k,M,void 0)}))}stopSending(L){this.sessionDesc.mediaDescriptions.forEach((k=>{const M=[],U=[],x=[];k.attributes.ssrcs.forEach((k=>{Sr(L).call(L,k.attributes.label||"")?x.push(k):M.push(k)})),k.attributes.ssrcGroups.forEach((L=>{var k;Sr(k=x.map((L=>L.ssrcId))).call(k,L.ssrcIds[0])||U.push(L)})),k.attributes.ssrcs=M,k.attributes.ssrcGroups=U}))}mute(L){const k=this.sessionDesc.mediaDescriptions.find((k=>k.attributes.mid===L));if(!k)throw new Error("mediaDescription not found with ".concat(L," in remote SDP when calling RemoteSDP.mute."));k.attributes.direction="inactive"}unmute(L){const k=this.sessionDesc.mediaDescriptions.find((k=>k.attributes.mid===L));if(!k)throw new Error("mediaDescription not found with ".concat(L," in remote SDP when calling RemoteSDP.unmute."));k.attributes.direction="sendonly"}receive(L,k,M){L.forEach(((L,k)=>{const M=L._mediaStreamTrack,U=this.sessionDesc.mediaDescriptions.findIndex((L=>L.attributes.mid===M.kind)),x=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[U],L);this.sessionDesc.mediaDescriptions[U]=x}))}stopReceiving(L){}updateCandidates(L){L===rO.TCP?this.candidates.forEach((L=>{-1===this.candidates.findIndex((k=>"tcp"===k.transport&&k.connectionAddress===L.connectionAddress&&k.port===L.port))&&this.candidates.push(LF(LF({},L),{},{foundation:"tcpcandidate",priority:Number(L.priority)-1+"",transport:"tcp",port:Number(L.port)+90+""}))})):this.candidates=this.candidates.filter((L=>"tcp"!==L.transport));for(const L of this.sessionDesc.mediaDescriptions)L.attributes.candidates=this.candidates}restartICE(L){L=rA(L),this.iceParameters=L,this.sessionDesc.mediaDescriptions.forEach((k=>{k.attributes.iceUfrag=L.iceUfrag,k.attributes.icePwd=L.icePwd}))}predictReceivingMids(L){const k=[];for(let M=0;M<L;M++)k.push((this.currentMidIndex+M+1).toString(10));return k}mungRecvMediaDsec(L,k){const M=rA(L);return qU(M,k),JU(M,k),M}updateRecvMedia(L,k){const M=this.sessionDesc.mediaDescriptions.findIndex((k=>k.attributes.mid===L));if(-1!==M){const L=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[M],k);this.sessionDesc.mediaDescriptions[M]=L}}bumpMid(L){this.currentMidIndex+=L}updateTrackLabel(L,k,M){const U=this.sessionDesc.mediaDescriptions.find((k=>L===nO.VIDEO?"video"===k.attributes.mid:"audio"===k.attributes.mid));if(U){const L=U.attributes.ssrcs.find((L=>L.attributes.label===k));var x;L&&(L.attributes.label=M,null===(x=L.attributes.msid)||void 0===x||x.replace(k,M))}}mungMediaDesc(L){const k=rA(L);return zU(k),function(L){const k=L.attributes.extmaps.find((L=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===L.extensionName));k&&L.attributes.extmaps.splice(L.attributes.extmaps.indexOf(k),1),L.attributes.payloads.forEach((L=>{const k=L.rtcpFeedbacks.findIndex((L=>"transport-cc"===L.type));-1!==k&&L.rtcpFeedbacks.splice(k,1)}))}(k),k}getSSRC(L){for(const k of this.sessionDesc.mediaDescriptions)for(const M of k.attributes.ssrcs)if(M.attributes.label===L)return[M]}}(UF(UF({},L),{},{rtpCapabilities:L.rtpCapabilities.send,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec}));const k=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:k})}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(L.toString()))}}async updateRemoteRTPCapabilities(L,k){throw new nv(iv.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}getPreMedia(L){}send(L,k){var M=this;return HI((function*(){const U=yield KI(M.mutex.lock());try{if(!M.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const x=L.map((L=>M.peerConnection.addTrack(L._mediaStreamTrack))),V=yield KI(M.peerConnection.createOffer()),F=wU.parse(V.sdp),j=L.map((L=>{const k=L._mediaStreamTrack,U=F.mediaDescriptions.find((L=>L.attributes.mid===k.kind));if(!U)throw new Error("Cannot extract ssrc from mediaDescription.");return function(L,k,M){const U=L.attributes.ssrcs.filter((L=>L.attributes.label===k)),x=L.attributes.ssrcGroups;if(0===U.length)throw new Error("Cannot extract ssrc from plan-b SDP.");if(x&&U.length>1){const L=x.find((L=>-1!==L.ssrcIds.indexOf(U[0].ssrcId)));return L?[{ssrcId:L.ssrcIds[0],rtx:M?L.ssrcIds[1]:void 0}]:[{ssrcId:U[0].ssrcId}]}return[{ssrcId:U[0].ssrcId}]}(U,k.id,M.useRTX)}));let z;try{z=yield j}catch(L){throw x.forEach((L=>{zv()&&L.replaceTrack(null),M.peerConnection.removeTrack(L)})),L}const Q=M.mungSendOfferSDP(V.sdp,L);M.remoteSDP.receive(L,k,z);const $=M.remoteSDP.toString();return yield KI(M.peerConnection.setLocalDescription({type:"offer",sdp:Q})),yield KI(M.applySendEncodings(x,L)),yield KI(M.peerConnection.setRemoteDescription({type:"answer",sdp:$})),L.map(((L,k)=>{const M=L._mediaStreamTrack.id;return{localSSRC:j[k],id:M}}))}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(L.toString()))}finally{U()}}))()}async stopSending(L){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const k=this.peerConnection.getSenders().filter((k=>{var M;return-1!==L.indexOf((null===(M=k.track)||void 0===M?void 0:M.id)||"")}));if(k.length!==L.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");k.map((L=>{zv()&&L.replaceTrack(null),this.peerConnection.removeTrack(L)}));const M=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(M),this.remoteSDP.stopReceiving(L);const U=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:U})}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(L.toString()))}}async receive(L,k,M,U){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(L," before remoteSDP created."));const{id:M,mslabel:x}=this.remoteSDP.send(L,k,U),V=new Mp(((k,U)=>{const V=setTimeout((()=>{U(new Error("Cannot receive track, id: ".concat(M)))}),1e4),s=U=>{const F=Gv();if(("Safari"===F.name&&11===Number(F.version)||Qv())&&U.track.id!==M&&U.streams[0].id===x){var j;const x=U.streams[0].getTracks()[0];return null===(j=this.remoteSDP)||void 0===j||j.updateTrackLabel(L,M,U.track.id),this.peerConnection.removeEventListener("track",s),clearTimeout(V),void k(x)}if(U.track.id===M)return this.peerConnection.removeEventListener("track",s),clearTimeout(V),void k(U.track)};this.peerConnection.addEventListener("track",s)})),F=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:F});const j=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(j),{track:await V,id:M}}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(L.toString()))}}async stopReceiving(L){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(L);const k=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:k});const M=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(M)}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(L.toString()))}}async muteRemote(L){}async unmuteRemote(L){}async muteLocal(L){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const k=this.peerConnection.getSenders().filter((k=>{var M;return-1!==L.indexOf((null===(M=k.track)||void 0===M?void 0:M.id)||"")}));if(k.length!==L.length)throw new Error("sender' length doesn't match mids' length.");k.map((L=>{if(zv()&&L.track)L.track.enabled=!1;else{const k=L.getParameters();k.encodings.forEach((L=>L.active=!1)),L.setParameters(k)}}))}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(L.toString()))}}async unmuteLocal(L){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const k=this.peerConnection.getSenders().filter((k=>{var M;return-1!==L.indexOf((null===(M=k.track)||void 0===M?void 0:M.id)||"")}));if(k.length!==L.length)throw new Error("Senders' length doesn't match mids' length.");k.map((async L=>{if(zv()&&L.track)L.track.enabled=!0;else{const k=L.getParameters();k.encodings.forEach((L=>L.active=!0)),await L.setParameters(k)}}));const M=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(M);const U=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:U})}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(L.toString()))}}restartICE(L){var k=this;return HI((function*(){const M=yield KI(k.mutex.lock("From P2PConnection.restartICE"));try{if(!k.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(XP().supportPCSetConfiguration){const M=k.peerConnection.getConfiguration(),U=L===rO.RELAY?"relay":"all";M.iceTransportPolicy!==U&&(Eb.debug("[".concat(k.store.clientId,"] restartICE change iceTransportPolicy from [").concat(M.iceTransportPolicy,"] to [").concat(U,"]")),M.iceTransportPolicy=U,k.peerConnection.setConfiguration(M))}else if(L===rO.RELAY)return;L!==rO.RELAY&&k.remoteSDP.updateCandidates(L);const U=yield KI(k.peerConnection.createOffer({iceRestart:!0}));if(!U.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const x=GU(U.sdp),{remoteIceParameters:V}=yield x.iceParameters;k.remoteSDP.restartICE(V);const F=k.remoteSDP.toString();yield KI(k.peerConnection.setLocalDescription(U)),yield KI(k.peerConnection.setRemoteDescription({type:"answer",sdp:F}))}catch(L){Eb.warning("[".concat(k.store.clientId,"] restart ICE failed, abort operation"),L)}finally{M()}}))()}close(){var L;this.peerConnection.close(),null===(L=this.onConnectionStateChange)||void 0===L||L.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(L){return this.statsFilter.getVideoIsReady(L)}async updateEncoderConfig(L,k){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const L=await this.peerConnection.createOffer(),M=this.mungSendOfferSDP(L.sdp,[k]);this.remoteSDP.updateRecvMedia(k._mediaStreamTrack.kind,k);const U=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:M}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:U})}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,L.toString())}}async updateSendParameters(L,k){const M=this.peerConnection.getSenders().filter((k=>{var M;return(null===(M=k.track)||void 0===M?void 0:M.id)===L}));1===M.length&&await this.applySendEncodings(M,[k])}setStatsRemoteVideoIsReady(L,k){this.statsFilter.setVideoIsReady2(L,k)}async replaceTrack(L,k){const M=this.peerConnection.getSenders().find((L=>{var M;return(null===(M=L.track)||void 0===M?void 0:M.id)===k}));M&&await M.replaceTrack(L._mediaStreamTrack)}createDataChannels(L,k){throw new nv(iv.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(L){throw new nv(iv.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var L;null===(L=this.onICEConnectionStateChange)||void 0===L||L.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var L;null===(L=this.onConnectionStateChange)||void 0===L||L.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=L=>{L.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,Eb.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,Eb.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),zA("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(L){const k={iceServers:[],sdpSemantics:"plan-b"};return L.iceServers?k.iceServers=L.iceServers:L.turnServer&&"off"!==L.turnServer.mode&&(Wy(L.turnServer.servers)?k.iceServers=L.turnServer.servers:(k.iceServers&&k.iceServers.push(...e.turnServerConfigToIceServers(L.turnServer.servers)),zA("USE_TURN_SERVER_OF_GATEWAY")&&k.iceServers&&L.turnServer.serversFromGateway&&k.iceServers.push(...e.turnServerConfigToIceServers(L.turnServer.serversFromGateway)),L.turnServer.servers.concat(L.turnServer.serversFromGateway||[]).forEach((L=>{L.forceturn&&(k.iceTransportPolicy="relay")})))),k}static turnServerConfigToIceServers(L){const k=[];return L.forEach((L=>{L.security?L.tcpport&&k.push({username:L.username,credential:L.password,credentialType:"password",urls:"turns:".concat(L.turnServerURL,":").concat(L.tcpport,"?transport=tcp")}):(L.udpport&&k.push({username:L.username,credential:L.password,credentialType:"password",urls:"turn:".concat(L.turnServerURL,":").concat(L.udpport,"?transport=udp")}),L.tcpport&&k.push({username:L.username,credential:L.password,credentialType:"password",urls:"turn:".concat(L.turnServerURL,":").concat(L.tcpport,"?transport=tcp")}))})),k}async updateRtpSenderEncodings(L,k){var M;if(k||(k=this.peerConnection.getSenders().find((k=>{var M;return(null===(M=k.track)||void 0===M?void 0:M.id)===L._mediaStreamTrack.id}))),!k)return Eb.warn("[".concat(L.getTrackId(),"] no rtpSender found}"));if(!XP().supportSetRtpSenderParameters)return Eb.warn("Browser not support set rtp-sender parameters");const U={},x={};if(L instanceof eU)switch(L._optimizationMode){case"motion":U.degradationPreference="maintain-framerate";break;case"detail":U.degradationPreference="maintain-resolution";break;default:U.degradationPreference="balanced"}if(zA("DSCP_TYPE")&&py()){var V;const L=zA("DSCP_TYPE");Sr(V=["very-low","low","medium","high"]).call(V,L)&&(x.networkPriority=L)}const F=k.getParameters(),j=null===(M=F.encodings)||void 0===M?void 0:M[0];j&&Object.assign(j,x),Object.assign(F,U),Eb.debug("[".concat(L.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(F.encodings))),await k.setParameters(F)}async applySendEncodings(L,k){try{if(!XP().supportSetRtpSenderParameters)return;if(L.length!==k.length)return;for(let M=0;M<L.length;M++){const U=L[M],x=k[M];U&&x&&await this.updateRtpSenderEncodings(x,U)}}catch(L){Eb.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(L,k){const M=wU.parse(L);return k.forEach(((L,k)=>{const U=L._mediaStreamTrack,x=M.mediaDescriptions.find((L=>L.attributes.mid===U.kind));x&&qU(x,L)})),wU.print(M)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=L=>{var k;null===(k=this.onFirstAudioReceived)||void 0===k||k.call(this,L)},this.statsFilter.onFirstVideoReceived=L=>{var k;null===(k=this.onFirstVideoReceived)||void 0===k||k.call(this,L)},this.statsFilter.onFirstAudioDecoded=L=>{var k;null===(k=this.onFirstAudioDecoded)||void 0===k||k.call(this,L)},this.statsFilter.onFirstVideoDecoded=(L,k,M)=>{var U;null===(U=this.onFirstVideoDecoded)||void 0===U||U.call(this,L,k,M)},this.statsFilter.onSelectedLocalCandidateChanged=(L,k)=>{var M;null===(M=this.onSelectedLocalCandidateChanged)||void 0===M||M.call(this,L,k)},this.statsFilter.onSelectedRemoteCandidateChanged=(L,k)=>{var M;null===(M=this.onSelectedRemoteCandidateChanged)||void 0===M||M.call(this,L,k)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(L){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const k=this.remoteSDP.batchSend(L).map(((k,M)=>{let{id:U,mslabel:x}=k;const{kind:V}=L[M];return new Mp(((L,k)=>{const M=setTimeout((()=>{k(new Error("Cannot receive track, id: ".concat(U)))}),1e4),s=k=>{const F=Gv();if("Safari"===F.name&&11===Number(F.version)&&k.track.id!==U&&k.streams[0].id===x){var j;const x=k.streams[0].getTracks()[0];return null===(j=this.remoteSDP)||void 0===j||j.updateTrackLabel(V,U,k.track.id),this.peerConnection.removeEventListener("track",s),clearTimeout(M),void L({track:x,id:U})}if(k.track.id===U)return this.peerConnection.removeEventListener("track",s),clearTimeout(M),void L({track:k.track,id:U})};this.peerConnection.addEventListener("track",s)}))})),M=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:M});const U=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(U),await Mp.all(k)}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(L.toString()))}}async getRemoteSSRC(L){if(!this.remoteSDP)return;const k=this.remoteSDP.getSSRC(L);return null==k?void 0:k[0].ssrcId}setConfiguration(L){if(XP().supportPCSetConfiguration){const k=e.resolvePCConfiguration(L);this.peerConnection.setConfiguration(k)}}},gw(EF.prototype,"connect",[VF],Object.getOwnPropertyDescriptor(EF.prototype,"connect"),EF.prototype),gw(EF.prototype,"stopSending",[VF],Object.getOwnPropertyDescriptor(EF.prototype,"stopSending"),EF.prototype),gw(EF.prototype,"receive",[VF],Object.getOwnPropertyDescriptor(EF.prototype,"receive"),EF.prototype),gw(EF.prototype,"stopReceiving",[VF],Object.getOwnPropertyDescriptor(EF.prototype,"stopReceiving"),EF.prototype),gw(EF.prototype,"muteRemote",[VF],Object.getOwnPropertyDescriptor(EF.prototype,"muteRemote"),EF.prototype),gw(EF.prototype,"unmuteRemote",[VF],Object.getOwnPropertyDescriptor(EF.prototype,"unmuteRemote"),EF.prototype),gw(EF.prototype,"muteLocal",[VF],Object.getOwnPropertyDescriptor(EF.prototype,"muteLocal"),EF.prototype),gw(EF.prototype,"unmuteLocal",[VF],Object.getOwnPropertyDescriptor(EF.prototype,"unmuteLocal"),EF.prototype),gw(EF.prototype,"close",[VF],Object.getOwnPropertyDescriptor(EF.prototype,"close"),EF.prototype),gw(EF.prototype,"updateEncoderConfig",[VF],Object.getOwnPropertyDescriptor(EF.prototype,"updateEncoderConfig"),EF.prototype),gw(EF.prototype,"updateSendParameters",[VF],Object.getOwnPropertyDescriptor(EF.prototype,"updateSendParameters"),EF.prototype),gw(EF.prototype,"replaceTrack",[VF],Object.getOwnPropertyDescriptor(EF.prototype,"replaceTrack"),EF.prototype),gw(EF.prototype,"getRemoteSSRC",[VF],Object.getOwnPropertyDescriptor(EF.prototype,"getRemoteSSRC"),EF.prototype),EF);function VF(L,k,M){const U=L[k];if("function"!=typeof U)throw new Error("Cannot use mutex on object property.");return M.value=async function(){const L=this.mutex,M=await L.lock("Locking from P2PConnection.".concat(k));try{for(var x=arguments.length,V=new Array(x),F=0;F<x;F++)V[F]=arguments[F];return await U.apply(this,V)}finally{M()}},M}function FF(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function BF(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?FF(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):FF(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}const mF="9";class WF{get localCapabilities(){return rA(this._localCapabilities)}get rtpCapabilities(){return rA(this._rtpCapabilities)}get candidates(){return rA(this._candidates)}get iceParameters(){return rA(this._iceParameters)}get dtlsParameters(){return rA(this._dtlsParameters)}constructor(L){xg(this,"sessionDesc",void 0),xg(this,"_localCapabilities",void 0),xg(this,"_rtpCapabilities",void 0),xg(this,"_candidates",void 0),xg(this,"_iceParameters",void 0),xg(this,"_dtlsParameters",void 0),xg(this,"setup",void 0),xg(this,"currentMidIndex",void 0),xg(this,"cname",void 0),xg(this,"firefoxSsrcMidMap",new Map),L=rA(L);const{iceParameters:k,dtlsParameters:M,candidates:U,rtpCapabilities:x,setup:V,localCapabilities:F,cname:j}=L;this._rtpCapabilities=x,this._candidates=U,this._iceParameters=k,this._dtlsParameters=M,this._localCapabilities=F,this.setup=V,this.cname=j,this.sessionDesc=this.updateRemoteRTPCapabilities(x),this.currentMidIndex=this.sessionDesc.mediaDescriptions.length-1}preloadRemoteMedia(L){const k=this.candidates,M=this.dtlsParameters,U=this.iceParameters,x=this.rtpCapabilities.send;let V=this.sessionDesc.mediaDescriptions.length-1;for(let F=1;F<L;F++){const L=2*F+2e4,j=2*F+4e4,{ssrcs:z,ssrcGroups:Q}=YU([{ssrcId:L}],this.cname),{ssrcs:$,ssrcGroups:ee}=YU([{ssrcId:j,rtx:zA("USE_SUB_RTX")?j+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:mF,protos:["UDP","TLS","RTP","SAVPF"],fmts:x.videoCodecs.map((L=>L.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:U.iceUfrag,icePwd:U.icePwd,unrecognized:[],candidates:k,extmaps:x.videoExtensions,fingerprints:M.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:$,ssrcGroups:ee,rtcpFeedbackWildcards:[],payloads:x.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(++V)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:mF,protos:["UDP","TLS","RTP","SAVPF"],fmts:x.audioCodecs.map((L=>L.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:U.iceUfrag,icePwd:U.icePwd,unrecognized:[],candidates:k,extmaps:x.audioExtensions,fingerprints:M.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:z,ssrcGroups:Q,rtcpFeedbackWildcards:[],payloads:x.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(++V)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return wU.print(this.sessionDesc)}send(L,k,M,U){const{ssrcs:x,ssrcGroups:V}=YU(k,this.cname,zA("SYNC_GROUP")?M:void 0),F=this.findPreloadMediaDesc(x);if(F){if(Xv()&&this.firefoxSsrcMidMap.set(x[0].ssrcId,F.attributes.mid),U&&(U.twcc||U.remb)){const L=this.sessionDesc.mediaDescriptions.indexOf(F);return this.sessionDesc.mediaDescriptions[L]=this.mungSendMediaDesc(F,U),{mid:F.attributes.mid,needExchangeSDP:!0}}return{mid:F.attributes.mid,needExchangeSDP:!1}}{const k=this.findAvailableMediaIndex(L,x);let M;return-1===k||1===k&&(zv()||function(){const L=Gv();return!(L.name!==JC.CHROME||!L.osVersion)&&Number(L.version)<=90}())||0===k&&zA("USE_SUB_RTX")||oy()?(M=this.createOrRecycleSendMedia(L,x,V,"sendonly",U),this.updateBundleMids()):(M=rA(this.sessionDesc.mediaDescriptions[k]),M.attributes.direction="sendonly",M.attributes.ssrcs=x,M.attributes.ssrcGroups=V,this.sessionDesc.mediaDescriptions[k]=this.mungSendMediaDesc(M,U)),Xv()&&this.firefoxSsrcMidMap.set(x[0].ssrcId,M.attributes.mid),{mid:M.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){const{mediaDesc:L,needExchangeSDP:k}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:L.attributes.mid,needExchangeSDP:k}}batchSend(L){const k=L.map((L=>{let{kind:k,ssrcMsg:M,mslabel:U}=L;return this.send(k,M,U)})),M=[];let U=!1;return k.forEach((L=>{let{mid:k,needExchangeSDP:x}=L;x&&(U=!0),M.push(k)})),{mids:M,needExchangeSDP:U}}stopSending(L){const k=this.sessionDesc.mediaDescriptions.filter((k=>k.attributes.mid&&-1!==L.indexOf(k.attributes.mid)));if(k.length!==L.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");k.forEach((L=>{"0"===L.attributes.mid||Xv()||oy()?L.attributes.ssrcs=[]:(L.attributes.ssrcs=[],L.attributes.direction="inactive",L.media.port="0")})),this.updateBundleMids()}mute(L){const k=this.sessionDesc.mediaDescriptions.find((k=>k.attributes.mid===L));if(!k)throw new Error("mediaDescription not found with ".concat(L," in remote SDP when calling RemoteSDP.mute."));k.attributes.direction="inactive"}unmute(L){const k=this.sessionDesc.mediaDescriptions.find((k=>k.attributes.mid===L));if(!k)throw new Error("mediaDescription not found with ".concat(L," in remote SDP when calling RemoteSDP.unmute."));k.attributes.direction="sendonly"}muteRemote(L){const k=this.sessionDesc.mediaDescriptions.filter((k=>Sr(L).call(L,k.attributes.mid||"")));if(k.length!==L.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");k.forEach((L=>{L.attributes.direction="inactive"}))}unmuteRemote(L){const k=this.sessionDesc.mediaDescriptions.filter((k=>Sr(L).call(L,k.attributes.mid||"")));if(k.length!==L.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");k.forEach((L=>{L.attributes.direction="recvonly"}))}receive(L,k,M,U){L.forEach(((L,x)=>{this.createOrRecycleRecvMedia(L,[],"recvonly",k,M,U[x])})),this.updateBundleMids()}stopReceiving(L){const k=this.sessionDesc.mediaDescriptions.filter((k=>-1!==L.indexOf(k.attributes.mid)));if(k.length!==L.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");k.forEach((L=>{L.media.port="0",L.attributes.direction="inactive"})),this.updateBundleMids()}updateRemoteRTPCapabilities(L){const k=this.sessionDesc||wU.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=ice-lite\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n");this._rtpCapabilities=L;const M=this.rtpCapabilities.send,U=this.localCapabilities.send;for(const L of k.mediaDescriptions){if(L.attributes.iceUfrag=this._iceParameters.iceUfrag,L.attributes.icePwd=this._iceParameters.icePwd,L.attributes.fingerprints=this._dtlsParameters.fingerprints,L.attributes.candidates=this._candidates,L.attributes.setup=this.setup,"application"===L.media.mediaType&&(L.attributes.sctpPort="5000"),"video"===L.media.mediaType)if(0===M.videoCodecs.length){const k=U.videoCodecs.filter((L=>{var k,M;return null===(k=L.rtpMap)||void 0===k?void 0:Sr(M=k.encodingName.toLowerCase()).call(M,"vp8")}))||[U.videoCodecs[0]];L.media.fmts=k.map((L=>L.payloadType.toString(10))),L.attributes.payloads=k,L.attributes.extmaps=[]}else if(L.media.fmts=M.videoCodecs.map((L=>L.payloadType.toString(10))),L.attributes.payloads=M.videoCodecs,L.attributes.extmaps=M.videoExtensions,zA("PRELOAD_MEDIA_COUNT")>0){const{ssrcs:k,ssrcGroups:M}=YU([{ssrcId:4e4,rtx:zA("USE_SUB_RTX")?40001:void 0}],this.cname);L.attributes.ssrcs=k,L.attributes.ssrcGroups=M}if("audio"===L.media.mediaType)if(0===M.audioCodecs.length){const k=U.audioCodecs.filter((L=>{var k,M;return null===(k=L.rtpMap)||void 0===k?void 0:Sr(M=k.encodingName.toLowerCase()).call(M,"opus")}))||[U.audioCodecs[0]];L.media.fmts=k.map((L=>L.payloadType.toString(10))),L.attributes.payloads=k,L.attributes.extmaps=[]}else if(L.media.fmts=M.audioCodecs.map((L=>L.payloadType.toString(10))),L.attributes.payloads=M.audioCodecs,L.attributes.extmaps=M.audioExtensions,nx(L),zA("PRELOAD_MEDIA_COUNT")>0){const{ssrcs:k,ssrcGroups:M}=YU([{ssrcId:2e4}],this.cname);L.attributes.ssrcs=k,L.attributes.ssrcGroups=M}}return this.sessionDesc=k,this.currentMidIndex=k.mediaDescriptions.length-1,this.sessionDesc}updateCandidates(L){const k=this._candidates.filter((L=>"udp"===L.transport));if(L===rO.TCP){if(0===k.length)return;if(zA("TCP_CANDIDATE_ONLY")){const L=this._candidates.filter((L=>"tcp"===L.transport));k.forEach((k=>{-1===L.findIndex((L=>L.connectionAddress===k.connectionAddress))&&L.push(BF(BF({},k),{},{foundation:"tcpcandidate",priority:Number(k.priority)-1+"",transport:"tcp",port:Number(k.port)+90+""}))})),this._candidates=L}else{const L=[];k.forEach((k=>{L.push(BF(BF({},k),{},{foundation:"tcpcandidate",priority:Number(k.priority)-1+"",transport:"tcp",port:Number(k.port)+90+""}))})),this._candidates=[...k,...L]}}else if(L===rO.RELAY){if(0!==k.length)return;{const L=this._candidates.filter((L=>"tcp"===L.transport));L.forEach((L=>{k.push(BF(BF({},L),{},{foundation:"udpcandidate",priority:Number(L.priority)+1+"",transport:"udp",port:Number(L.port)-90+""}))})),this._candidates=[...k,...L]}}else 0===k.length?(this._candidates.filter((L=>"tcp"===L.transport)).forEach((L=>{k.push(BF(BF({},L),{},{foundation:"udpcandidate",priority:Number(L.priority)+1+"",transport:"udp",port:Number(L.port)-90+""}))})),this._candidates=k):this._candidates=this._candidates.filter((L=>"tcp"!==L.transport));for(const L of this.sessionDesc.mediaDescriptions)L.attributes.candidates=this.candidates}restartICE(L){L=rA(L),this._iceParameters=L,this.sessionDesc.mediaDescriptions.forEach((k=>{k.attributes.iceUfrag=L.iceUfrag,k.attributes.icePwd=L.icePwd}))}predictReceivingMids(L){const k=[];for(let M=0;M<L;M++)k.push((this.currentMidIndex+M+1).toString(10));return k}findAvailableMediaIndex(L,k){return this.sessionDesc.mediaDescriptions.findIndex((M=>{const U=M.media.mediaType===L&&"0"!==M.media.port&&("sendonly"===M.attributes.direction||"sendrecv"===M.attributes.direction)&&0===M.attributes.ssrcs.length;if(Xv()){if(U){const L=this.firefoxSsrcMidMap.get(k[0].ssrcId);return!(L||"0"!==M.attributes.mid&&"1"!==M.attributes.mid)||!(!L||L!==M.attributes.mid)}return!1}return U}))}createOrRecycleDataChannel(){for(const L of this.sessionDesc.mediaDescriptions)if("application"===L.media.mediaType)return{mediaDesc:L,needExchangeSDP:!1};this.currentMidIndex+=1;const L="".concat(this.currentMidIndex),k={media:{mediaType:"application",port:mF,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(L),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(k),{mediaDesc:k,needExchangeSDP:!0}}createOrRecycleRecvMedia(L,k,M,U,x,V){const F=L._mediaStreamTrack.kind,j=this.rtpCapabilities.recv,z=rx(F,j,this.localCapabilities.send,F===nO.VIDEO?U:x),Q=F===nO.VIDEO?j.videoExtensions:j.audioExtensions;this.currentMidIndex+=1;const $="".concat(this.currentMidIndex);let ee={media:{mediaType:F,port:mF,protos:["UDP","TLS","RTP","SAVPF"],fmts:z.map((L=>L.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:Q,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:k,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:z,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:M,rtcpMux:!0,rtcpRsize:!0,mid:"".concat($)}};ee=this.mungRecvMediaDsec(ee,L,V);const te=this.findFirstClosedMedia(F);if(te){const L=this.sessionDesc.mediaDescriptions.indexOf(te);this.sessionDesc.mediaDescriptions[L]=ee}else this.sessionDesc.mediaDescriptions.push(ee);return ee}updateRemoteCodec(L,k,M){const U=[...new Set(this._rtpCapabilities.recv.videoCodecs.map((L=>L.rtpMap&&L.rtpMap.encodingName.toLowerCase()||"")).filter((L=>{var k;return Sr(k=Object.keys(ib)).call(k,L)})))],x=new Set(k);if(U.every((L=>x.has(L))))return Eb.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(k)),!1;const V=this._rtpCapabilities.recv.videoCodecs.filter((L=>k.some((k=>{var M;return Sr(M=L.rtpMap&&L.rtpMap.encodingName.toLowerCase()||"").call(M,k)}))));if(0===V.length)return Eb.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(U," codecs: ").concat(k)),!1;const F=[...new Set(V.map((L=>L.rtpMap&&L.rtpMap.encodingName.toLowerCase()||"")))];let j;if(Eb.debug("updateRemoteCodec, from ".concat(U," to ").concat(F)),0===L.length)j=this.sessionDesc.mediaDescriptions.filter((L=>"video"===L.media.mediaType&&"recvonly"===L.attributes.direction));else if(j=this.sessionDesc.mediaDescriptions.filter((k=>k.attributes.mid&&Sr(L).call(L,k.attributes.mid)&&"recvonly"===k.attributes.direction)),j.length!==L.length)return Eb.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(L,", codecs: ").concat(k)),!1;if(zA("USE_PUB_RTX")||zA("USE_SUB_RTX")){const L=ox(V,this.rtpCapabilities.recv.videoCodecs);V.push(...L)}this._rtpCapabilities.recv.videoCodecs=V;const z=this.localCapabilities.send,Q=this.rtpCapabilities.recv,$=rx(nO.VIDEO,Q,z,M);return j.forEach((L=>{const k=$.map((L=>L.payloadType.toString(10)));Eb.debug("updateRemoteCodec mid: ".concat(L.attributes.mid,", from ").concat(L.attributes.payloads," to ").concat($)),L.attributes.payloads=$,L.media.fmts=k})),!0}createOrRecycleSendMedia(L,k,M,U,x){const V=this.rtpCapabilities.send,F=L===nO.VIDEO?V.videoCodecs:V.audioCodecs,j=L===nO.VIDEO?V.videoExtensions:V.audioExtensions;this.currentMidIndex+=1;const z="".concat(this.currentMidIndex);let Q={media:{mediaType:L,port:mF,protos:["UDP","TLS","RTP","SAVPF"],fmts:F.map((L=>L.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:j,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:k,ssrcGroups:M,rtcpFeedbackWildcards:[],payloads:F,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:U,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(z)}};Q=this.mungSendMediaDesc(Q,x);const $=this.findFirstClosedMedia(L);if($){const L=this.sessionDesc.mediaDescriptions.indexOf($);this.sessionDesc.mediaDescriptions[L]=Q}else this.sessionDesc.mediaDescriptions.push(Q);return Q}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((L=>"0"!==L.media.port)).map((L=>L.attributes.mid))}mungRecvMediaDsec(L,k,M){const U=rA(L);return zU(U),qU(U,k),JU(U,k),XU(U),QU(U,M,this.localCapabilities.send),U}mungSendMediaDesc(L,k){const M=rA(L);return QU(M,k,this.localCapabilities.recv),nx(M),M}updateRecvMedia(L,k){const M=this.sessionDesc.mediaDescriptions.findIndex((k=>k.attributes.mid===L));if(-1!==M){const L=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[M],k);this.sessionDesc.mediaDescriptions[M]=L}}bumpMid(L){this.currentMidIndex+=L}findFirstClosedMedia(L){return this.sessionDesc.mediaDescriptions.find((k=>Xv()?"0"===k.media.port&&k.media.mediaType===L:"0"===k.media.port))}findPreloadMediaDesc(L){return this.sessionDesc.mediaDescriptions.find((k=>{var M;return(null===(M=k.attributes)||void 0===M||null===(M=M.ssrcs[0])||void 0===M?void 0:M.ssrcId)===L[0].ssrcId}))}getSSRC(L){var k;return null===(k=this.sessionDesc.mediaDescriptions.find((k=>k.attributes.mid===L)))||void 0===k?void 0:k.attributes.ssrcs}}function HF(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function KF(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?HF(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):HF(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}let gF=function(L){return L.BANDWIDTH="bandwidth",L.CPU="cpu",L.NONE="none",L.OTHER="other",L}({});var TF=function(L){return L[L.DOWN=0]="DOWN",L[L.UP=1]="UP",L}(TF||{});const SF=new Map;function JF(L,k,M,U){let{scale:x}=L;if(0===x&&U===TF.UP||x>=k.length-1&&U===TF.DOWN)return L;let V=KF(KF({},L),{},{scale:U===TF.DOWN?++x:--x});switch(M){case"maintain-framerate":V=KF(KF({},V),k[x].motion);break;case"maintain-resolution":V=KF(KF({},V),k[x].detail);break;case"balanced":V=KF(KF({},V),k[x].balanced)}return V}function XF(L,k){if(k){const M={overUse:0,underUse:0,adaptationList:QF(k)};SF.set(L,M)}else SF.delete(L)}function QF(L){const k=KF({},L),{bitrateMax:M,frameRate:U,scaleResolutionDownBy:x,bitrateMin:V}=k,{MIN_FRAME_RATE:F,MAX_THRESHOLD_FRAMERATE:j,MAX_SCALE:z,BITRATE_MIN_THRESHOLD:Q,BITRATE_MAX_THRESHOLD:$,BWE_SCALE_UP_THRESHOLD:ee,BWE_SCALE_DOWN_THRESHOLD:te,PERF_SCALE_DOWN_THRESHOLD:ie,PERF_SCALE_UP_THRESHOLD:ne,BALANCE_BITRATE_FACTOR:re,BALANCE_FRAMERATE_FACTOR:oe,BALANCE_RESOLUTION_FACTOR:ce,MOTION_RESOLUTION_FACTOR:de,MOTION_BITRATE_FACTOR:le,DETAIL_FRAMERATE_FACTOR:ue,DETAIL_BITRATE_FACTOR:he}=Fv,pe=Math.min(k.frameRate,j),_e=[{scale:0,threshold:{bwe_down:Math.round(Math.pow(te,1)*M),bwe_up:M,fps_down:Math.round(Math.pow(ie,1)*pe),fps_up:U},balanced:{scaleResolutionDownBy:1,frameRate:U,bitrateMax:M,bitrateMin:V},motion:{scaleResolutionDownBy:1,frameRate:U,bitrateMax:M,bitrateMin:V},detail:{scaleResolutionDownBy:1,frameRate:U,bitrateMax:M,bitrateMin:V}}];for(let L=1;L<=z;L++){const k={bwe_up:Math.round(Math.pow(ee,L)*M),bwe_down:Math.round(Math.pow(te,L+1)*M),fps_up:Math.round(Math.pow(ne,L)*pe),fps_down:Math.round(Math.pow(ie,L+1)*pe)},j={scaleResolutionDownBy:x/Math.pow(ce,L),frameRate:Math.max(Math.round(Math.pow(oe,L)*U),F),bitrateMax:Math.max(Math.round(Math.pow(re,L)*M),$),bitrateMin:Math.max(Math.round(Math.pow(re,L)*V),Q)},z={scaleResolutionDownBy:x/Math.pow(de,L),frameRate:U,bitrateMax:Math.max(Math.round(Math.pow(le,L)*M),$),bitrateMin:Math.max(Math.round(Math.pow(le,L)*V),Q)},Ee={scaleResolutionDownBy:1,frameRate:Math.max(Math.round(Math.pow(ue,L)*U),F),bitrateMax:Math.max(Math.round(Math.pow(he,L)*M),$),bitrateMin:Math.max(Math.round(Math.pow(he,L)*V),Q)};_e.push({scale:L,threshold:k,balanced:j,motion:z,detail:Ee})}return _e}function $F(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function eB(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?$F(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):$F(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}const RF=new Map;function nB(L,k){const M=RF.get(L);if(M){const{timer:k}=M;window.clearTimeout(k),RF.delete(L)}k.qualityLimitationReason=gF.NONE,XF(L)}var yF;function oB(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function sB(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?oB(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):oB(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}let CF=(yF=class e extends sO{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var L,k;return null!==(L=null===(k=this.peerConnection.getReceivers()[0])||void 0===k||null===(k=k.transport)||void 0===k?void 0:k.state)&&void 0!==L?L:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map((L=>L.rtpMap&&L.rtpMap.encodingName.toLowerCase()||"")).filter((L=>{var k;return Sr(k=Object.keys(ib)).call(k,L)})))]}constructor(L,k){super(L,k),xg(this,"store",void 0),xg(this,"peerConnection",void 0),xg(this,"id",fA(5,"connection-")),xg(this,"remoteSDP",void 0),xg(this,"initialOffer",void 0),xg(this,"transportEventReceiver",void 0),xg(this,"statsFilter",void 0),xg(this,"extension",{useXR:zA("USE_XR")}),xg(this,"localCapabilities",void 0),xg(this,"remoteCodecs",void 0),xg(this,"localCandidateCount",0),xg(this,"allCandidatesReceived",!1),xg(this,"isPreallocation",!1),xg(this,"preSSRCMap",new Map),xg(this,"dataStreamChannelMap",new Map),xg(this,"establishPromise",void 0),xg(this,"recoveredDataChannelIds",[]),xg(this,"currentDataChannelId",1),xg(this,"mutex",new wv("P2PConnection-mutex")),xg(this,"qualityLimitationReason",gF.NONE),this.store=k,this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(L),{optional:[{googDscp:!0}]}),this.statsFilter=MV(this.peerConnection,zA("STATS_UPDATE_INTERVAL"),void 0,Xv()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}getPreMedia(L){const k=this.preSSRCMap.get(L);if(void 0!==k){const L=this.peerConnection.getTransceivers().find((L=>L.mid===k));if(L)return{transceiver:L,track:L.receiver.track,id:k}}}async updateRemoteRTPCapabilities(L,k){if(this.remoteCodecs=k,this.remoteSDP)if(this.remoteSDP.updateRemoteCodec(L,k,this.store.codec)){const L=await this.peerConnection.createOffer(),k=this.logSDPExchange(L.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(L);const M=this.remoteSDP.toString();null==k||k(M),await this.peerConnection.setRemoteDescription({type:"answer",sdp:M})}else Eb.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.");else Eb.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(k))}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const L=await this.peerConnection.createOffer();if(!L.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const k=GU(L.sdp),M=await $U({filterRTX:!zA("USE_PUB_RTX")&&!zA("USE_SUB_RTX"),filterVideoFec:zA("FILTER_VIDEO_FEC"),filterAudioFec:zA("FILTER_AUDIO_FEC"),filterVideoCodec:zA("FILTER_VIDEO_CODEC")},this.extension);return this.localCapabilities=ix(M),this.initialOffer=L,sB(sB({},k),{},{rtpCapabilities:M,offerSDP:L.sdp})}catch(L){throw new nv(iv.GET_LOCAL_CONNECTION_PARAMS_FAILED,L.toString())}}async connect(L){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new WF(sB(sB({},L),{},{localCapabilities:this.localCapabilities})),L.preallocation&&(this.isPreallocation=!0),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const k=this.remoteSDP.toString(),M=ax(this.initialOffer.sdp,this.extension),U=this.logSDPExchange(M||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:M}),null==U||U(k),await this.peerConnection.setRemoteDescription({type:"answer",sdp:k});const x=this.peerConnection.getTransceivers()[0];if(null!=x&&x.receiver&&this.tryBindTransportEvents(x.receiver),zA("PRELOAD_MEDIA_COUNT")>0){this.remoteSDP.preloadRemoteMedia(zA("PRELOAD_MEDIA_COUNT"));const L=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:L});const k=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(k)}const{preSSRCs:V}=L;if(Array.isArray(V)&&V.length>0){const{mids:L}=this.remoteSDP.batchSend(V.map((L=>({kind:L.kind,ssrcMsg:[{ssrcId:L.ssrcId,rtx:L.rtx}],mslabel:L.mslabel}))));L.forEach(((L,k)=>{this.preSSRCMap.set(V[k].ssrcId,L)})),await sx(this.peerConnection,this.remoteSDP,this.extension),Eb.debug("[".concat(this.store.clientId,"] [P2PConnection] pre-batchReceive exchange SDP."))}}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(L.toString()))}}async updateRemoteConnect(L){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateRemoteConnect before remote SDP created");const{rtpCapabilities:k}=L;this.remoteSDP.updateRemoteRTPCapabilities(k),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const{preSSRCs:M}=L;if(Array.isArray(M)&&M.length>0){const{mids:L}=this.remoteSDP.batchSend(M.map((L=>Object.assign({},{kind:L.kind,ssrcMsg:[{ssrcId:L.ssrcId,rtx:L.rtx}],mslabel:L.mslabel}))));L.forEach(((L,k)=>{this.preSSRCMap.set(M[k].ssrcId,L)}))}await sx(this.peerConnection,this.remoteSDP,this.extension),Eb.debug("[P2PConnection] updateRemoteRTPCapabilities by exchanging SDP.")}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection.updateRemoteConnect failed; ".concat(L.toString()))}}send(L,k,M){var U=this;return HI((function*(){const x=yield KI(U.mutex.lock("From P2PConnection.send"));try{if(!U.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const V=[];L.forEach((L=>{const k=U.peerConnection.addTransceiver(L._mediaStreamTrack,{direction:"sendonly"});V.push(k),L._updateRtpTransceiver(k)})),Xv()&&!0===zA("SIMULCAST")&&(yield KI(U.applySimulcastForFirefox(V,L)));const F=yield KI(U.peerConnection.createOffer()),j=U.remoteSDP.predictReceivingMids(L.length),z=U.mungSendOfferSDP(F.sdp,L,j),Q=wU.parse(z),$=j.map((L=>{const k=Q.mediaDescriptions.find((k=>k.attributes.mid===L));if(!k)throw new Error("Cannot extract ssrc from mediaDescription.");return WU(k,zA("USE_PUB_RTX"))}));let ee;try{ee=yield $}catch(x){ee=[],U.remoteSDP.receive(L,k,M,ee);const V=U.remoteSDP.toString();throw yield KI(U.peerConnection.setLocalDescription({type:"offer",sdp:z})),yield KI(U.peerConnection.setRemoteDescription({type:"answer",sdp:V})),yield KI(U.stopSending(j,!0)),x}U.remoteSDP.receive(L,k,M,ee);const te=U.remoteSDP.toString(),ie=U.logSDPExchange(z,"offer","local","send");return yield KI(U.peerConnection.setLocalDescription({type:"offer",sdp:z})),yield KI(U.applySimulcastEncodings(V,L)),yield KI(U.applySendEncodings(V,L)),null==ie||ie(te),yield KI(U.peerConnection.setRemoteDescription({type:"answer",sdp:te})),V.map(((L,k)=>{const M=j[k];return{localSSRC:$[k],id:M,transceiver:L}}))}catch(L){throw L instanceof nv?L:new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(L.toString()))}finally{x()}}))()}async createDataChannels(L,k){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let M=this.dataStreamChannelMap.get(L);if(M&&"open"===M.readyState)Eb.debug("[P2PConnection] Channels are already available and can be reused directly.");else{const k=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if("number"!=typeof k)throw new Error("create DataChannel error, because cannot get dc id");M=this.peerConnection.createDataChannel("datastream-channel",{id:k,negotiated:!0,ordered:!1,maxRetransmits:zA("DATASTREAM_MAX_RETRANSMITS")}),M.binaryType="arraybuffer",this.dataStreamChannelMap.set(L,M)}k.forEach((L=>{L._updateOriginDataChannel(M)}));const{needExchangeSDP:U}=this.remoteSDP.sendDataChannel();if(U){const L=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:L});const k=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(k),Eb.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else Eb.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(L){throw L instanceof nv?L:new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(L.toString()))}}async stopDataChannels(L){try{const k=this.dataStreamChannelMap.get(L);return k&&(k.id&&this.recoveredDataChannelIds.push(k.id),k.close()),void this.dataStreamChannelMap.delete(L)}catch(L){throw L instanceof nv?L:new nv(iv.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(L.toString()))}}async stopSending(L,k){const M=k?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const k=this.peerConnection.getTransceivers().filter((k=>-1!==L.indexOf(k.mid)));if(k.length!==L.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");k.map((L=>{var k;nB(this.id+L.mid,this),L.direction="inactive",null===(k=L.stop)||void 0===k||k.call(L)}));const U=await this.peerConnection.createOffer(),x=this.logSDPExchange(U.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(U),this.remoteSDP.stopReceiving(L);const V=this.remoteSDP.toString();null==x||x(V),await this.peerConnection.setRemoteDescription({type:"answer",sdp:V})}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(L.toString()))}finally{M&&M()}}async receive(L,k,M,U){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(L," before remoteSDP created."));const{mid:x,needExchangeSDP:V}=this.remoteSDP.send(L,k,M,U);V&&(await sx(this.peerConnection,this.remoteSDP,this.extension),Eb.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(L," by exchanging SDP.")));const F=this.peerConnection.getTransceivers().find((L=>L.mid===x));if(!F)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:F.receiver.track,id:x,transceiver:F}}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(L.toString()))}}async batchReceive(L){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:k,needExchangeSDP:M}=this.remoteSDP.batchSend(L);return M&&(await sx(this.peerConnection,this.remoteSDP,this.extension),Eb.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))),k.map((L=>{const k=this.peerConnection.getTransceivers().find((k=>k.mid===L));if(!k)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:k.receiver.track,id:L,transceiver:k}}))}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(L.toString()))}}async stopReceiving(L){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");L.forEach((L=>{Array.from(this.preSSRCMap.entries()).some((k=>{let[M,U]=k;if(U===L)return this.preSSRCMap.delete(M),!0}))})),this.remoteSDP.stopSending(L);const k=this.remoteSDP.toString(),M=this.logSDPExchange(k,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:k});const U=await this.peerConnection.createAnswer();null==M||M(U.sdp||""),await this.peerConnection.setLocalDescription(U)}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(L.toString()))}}async muteRemote(L){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(L," before remote SDP created."));this.remoteSDP.mute(L);const k=this.remoteSDP.toString(),M=this.logSDPExchange(k,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:k});const U=await this.peerConnection.createAnswer();null==M||M(U.sdp||""),await this.peerConnection.setLocalDescription(U)}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(L.toString()))}}async unmuteRemote(L){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(L," before remote SDP created."));this.remoteSDP.unmute(L);const k=this.remoteSDP.toString(),M=this.logSDPExchange(k,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:k});const U=await this.peerConnection.createAnswer();null==M||M(U.sdp||""),await this.peerConnection.setLocalDescription(U)}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(L.toString()))}}async muteLocal(L){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const k=this.peerConnection.getTransceivers().filter((k=>k.mid&&-1!==L.indexOf(k.mid)));if(k.length!==L.length)throw new Error("Transceivers' length doesn't match mids' length.");k.map((L=>{L.direction="inactive"}));const M=await this.peerConnection.createOffer(),U=this.logSDPExchange(M.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(M),this.remoteSDP.muteRemote(L);const x=this.remoteSDP.toString();null==U||U(x),await this.peerConnection.setRemoteDescription({type:"answer",sdp:x})}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(L.toString()))}}async unmuteLocal(L){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const k=this.peerConnection.getTransceivers().filter((k=>k.mid&&-1!==L.indexOf(k.mid)));if(k.length!==L.length)throw new Error("Transceivers' length doesn't match mids' length.");k.map((async(L,k)=>{L.direction="sendonly"}));const M=await this.peerConnection.createOffer(),U=this.logSDPExchange(M.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(M),this.remoteSDP.unmuteRemote(L);const x=this.remoteSDP.toString();null==U||U(x),await this.peerConnection.setRemoteDescription({type:"answer",sdp:x})}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(L.toString()))}}restartICE(L){var k=this;return HI((function*(){const M=yield KI(k.mutex.lock("From P2PConnection.restartICE"));try{if(!k.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(XP().supportPCSetConfiguration){const M=k.peerConnection.getConfiguration(),U=L===rO.RELAY?"relay":"all";M.iceTransportPolicy!==U&&(Eb.debug("[".concat(k.store.clientId,"] restartICE change iceTransportPolicy from [").concat(M.iceTransportPolicy,"] to [").concat(U,"]")),M.iceTransportPolicy=U,k.peerConnection.setConfiguration(M))}else if(L===rO.RELAY)return;k.remoteSDP.updateCandidates(L);const U=yield KI(k.peerConnection.createOffer({iceRestart:!0}));if(!U.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const x=GU(U.sdp),{remoteIceParameters:V}=yield x.iceParameters;k.remoteSDP.restartICE(V);const F=k.remoteSDP.toString(),j=k.logSDPExchange(U.sdp||"","offer","local","restartICE");k.store.descriptionStart(),yield KI(k.peerConnection.setLocalDescription(U)),null==j||j(F),yield KI(k.peerConnection.setRemoteDescription({type:"answer",sdp:F}))}catch(L){Eb.warning("[".concat(k.store.clientId,"] restart ICE failed, abort operation"),L)}finally{M()}}))()}close(){var L;this.peerConnection.getTransceivers().forEach((L=>{nB(this.id+L.mid,this)})),this.preSSRCMap.clear(),this.peerConnection.close(),null===(L=this.onConnectionStateChange)||void 0===L||L.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return sB(sB({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(L){return this.statsFilter.getVideoIsReady(L)}async updateEncoderConfig(L,k){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const M=await this.peerConnection.createOffer(),U=this.mungSendOfferSDP(M.sdp,[k],[L]);this.remoteSDP.updateRecvMedia(L,k);const x=this.remoteSDP.toString(),V=this.logSDPExchange(U,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:U}),null==V||V(x),await this.peerConnection.setRemoteDescription({type:"answer",sdp:x})}catch(L){throw new nv(iv.EXCHANGE_SDP_FAILED,L.toString())}}async updateSendParameters(L,k){const M=this.peerConnection.getTransceivers().filter((k=>k.mid===L));1===M.length&&(this.isVP8Simulcast(k)?Xv()||await this.applySimulcastEncodings(M,[k]):await this.applySendEncodings(M,[k]))}setStatsRemoteVideoIsReady(L,k){this.statsFilter.setVideoIsReady2(L,k)}async replaceTrack(L,k){const M=this.peerConnection.getTransceivers().find((L=>L.mid===k));M&&await M.sender.replaceTrack(L._mediaStreamTrack)}async getSelectedCandidatePair(){const L=this.peerConnection.getReceivers();if(L.length>0&&L[0].transport&&L[0].transport.iceTransport&&L[0].transport.iceTransport.getSelectedCandidatePair&&L[0].transport.iceTransport.getSelectedCandidatePair()){const k=L[0].transport.iceTransport,{local:M,remote:U}=k.getSelectedCandidatePair();return{local:sB(sB({},aV),{},{candidateType:M.type,protocol:M.protocol,address:M.address,port:M.port}),remote:sB(sB({},aV),{},{candidateType:U.type,protocol:U.protocol,address:U.address,port:U.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var L;null===(L=this.onICEConnectionStateChange)||void 0===L||L.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var L;null===(L=this.onConnectionStateChange)||void 0===L||L.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=L=>{L.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,Eb.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,Eb.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),zA("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(L){const k={iceServers:[]};return L.iceServers?k.iceServers=L.iceServers:L.turnServer&&"off"!==L.turnServer.mode&&(Wy(L.turnServer.servers)?k.iceServers=L.turnServer.servers:(k.iceServers&&k.iceServers.push(...e.turnServerConfigToIceServers(L.turnServer.servers)),zA("USE_TURN_SERVER_OF_GATEWAY")&&k.iceServers&&L.turnServer.serversFromGateway&&k.iceServers.push(...e.turnServerConfigToIceServers(L.turnServer.serversFromGateway)),zA("FORCE_TURN_TCP")?k.iceTransportPolicy="relay":L.turnServer.servers.concat(L.turnServer.serversFromGateway||[]).forEach((L=>{L.forceturn&&(k.iceTransportPolicy="relay")})))),zA("ENABLE_ENCODED_TRANSFORM")&&XP().supportWebRTCEncodedTransform&&(k.encodedInsertableStreams=!0),k}static turnServerConfigToIceServers(L){const k=[];return L.forEach((L=>{L.security?L.tcpport&&k.push({username:L.username,credential:L.password,credentialType:"password",urls:"turns:".concat(qO(L.turnServerURL),":").concat(L.tcpport,"?transport=tcp")}):(L.udpport&&!zA("FORCE_TURN_TCP")&&k.push({username:L.username,credential:L.password,credentialType:"password",urls:"turn:".concat(L.turnServerURL,":").concat(L.udpport,"?transport=udp")}),L.tcpport&&k.push({username:L.username,credential:L.password,credentialType:"password",urls:"turn:".concat(L.turnServerURL,":").concat(L.tcpport,"?transport=tcp")}))})),k}tryBindTransportEvents(L){const k=L.transport;if(k){this.transportEventReceiver=L,k.onstatechange=()=>{var L;null!=k&&k.state&&(null===(L=this.onDTLSTransportStateChange)||void 0===L||L.call(this,k.state))},k.onerror=L=>{var k;null===(k=this.onDTLSTransportError)||void 0===k||k.call(this,"error"in L?L.error:L)};const M=k.iceTransport;M&&(M.onstatechange=()=>{const L=null==k?void 0:k.iceTransport.state;var M;L&&(null===(M=this.onICETransportStateChange)||void 0===M||M.call(this,L))},M.getSelectedCandidatePair&&(M.onselectedcandidatepairchange=()=>{if(M.getSelectedCandidatePair()){const{local:L,remote:k}=M.getSelectedCandidatePair();Eb.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:L.type,protocol:L.protocol}),", remote ").concat(JSON.stringify({candidateType:k.type,protocol:k.protocol,address:k.address,port:k.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(L,k){var M,U;if(!k){const M=this.peerConnection.getSenders();k=M.find((k=>k.track===L._mediaStreamTrack))}if(!k)return Eb.warn("[".concat(L.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(L))return Eb.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!XP().supportSetRtpSenderParameters)return Eb.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const x={},V={};switch(L._optimizationMode){case"motion":x.degradationPreference="maintain-framerate";break;case"detail":x.degradationPreference="maintain-resolution";break;case"balanced":x.degradationPreference="balanced"}const F=function(L,k){return L.getTransceivers().find((L=>L.sender.track===k||L.receiver.track===k))}(this.peerConnection,L._mediaStreamTrack),j=(L=>{const k=L._encoderConfig;if(!k)return;const{frameRate:M,width:U,height:x}=L.getMediaStreamTrackSettings();let{frameRate:V=M,width:F=U,height:j=x}=k;if(!V||!F||!j)return;F=vA(F),j=vA(j),V=vA(V);const{max:z,min:Q}=function(L,k,M){const U=200*Math.pow(M/15,.6)*Math.pow(L*k/640/360,.75);return{min:Math.floor(U),max:Math.floor(4*U)}}(F,j,V),{bitrateMax:$,bitrateMin:ee}=k||{};$||Eb.debug("calculate bitrate: [w: ".concat(F,", h: ").concat(j,", fps: ").concat(V,"] => [brMax: ").concat($,", brMin: ").concat(ee,"]"));const{maxFramerate:te}=zA("ENCODER_CONFIG_LIMIT");return te&&"number"==typeof te&&(V=Math.min(V,te)),{frameRate:V,bitrateMax:$||z,bitrateMin:ee||Q,scaleResolutionDownBy:1,scale:0}})(L);if(function tB(L){var k;return!(!zA("ENABLE_AG_ADAPTATION")||!(L instanceof tU||Sr(k=L._hints).call(k,sL.CUSTOM_TRACK))||!zA("FORCE_SUPPORT_AG_ADAPTATION")&&!(function(L){const k=Gv();if(k.os!==XC.IOS||!k.osVersion)return!1;const M=k.osVersion.split(".");return Number(M[0])>=14}()&&iy(17,4,!0)||ty(14)&&ny(17,4,!0)))}(L)&&F&&k&&j&&this.getLocalVideoStats&&Sr(M=["vp8","vp9"]).call(M,this.store.codec)){var z;const M=x.degradationPreference||(Sr(z=L._hints).call(z,sL.CUSTOM_TRACK)?zA("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");!function(L,k,M,U,x,V){if(nB(L,M),x(k),"balanced"!==U&&"maintain-framerate"!==U&&"maintain-resolution"!==U)return;let F=-1;XF(L,k);const j=window.setInterval((()=>{const j=RF.get(L);if(!zA("ENABLE_AG_ADAPTATION")||!j)return nB(L,M),void x(k);const z=V();if(z.sendPackets>0&&z.OutgoingAvailableBandwidth>0){if(-1===F)return void(F=Date.now());if(Date.now()-F<1e3)return;const V=z.sendFrameRate,Q=z.OutgoingAvailableBandwidth,[$,ee]=function ZF(L,k,M,U,x,V){const F=SF.get(L)||{overUse:0,underUse:0,adaptationList:QF(x)},{adaptationList:j}=F;SF.set(L,F);const{OVERUSE_TIMES_THRESHOLD:z,UNDERUSE_TIMES_THRESHOLD:Q}=Fv,{scale:$}=U;let ee,te;return"number"==typeof k&&k>0&&function(L,k,M,U){if(k>=M.length)return!1;let{threshold:{fps_down:x}}=M[k];return zA("FORCE_AG_HIGH_FRAMERATE")&&"maintain-framerate"===U&&(x=M[0].threshold.fps_down),L<x}(k,$,j,V)&&(F.overUse++,te=gF.CPU,F.overUse>z)||"number"==typeof M&&M>0&&function(L,k,M){if(k>=M.length)return!1;const{threshold:{bwe_down:U}}=M[k];return L<U}(M,$,j)&&(F.overUse++,te=gF.BANDWIDTH,F.overUse>z)?(F.overUse=0,F.underUse=0,ee=JF(U,j,V,TF.DOWN),[ee,te]):("number"==typeof k&&k>0&&"number"==typeof M&&M>0&&function(L,k,M,U){if(0===k)return;let{threshold:{fps_up:x}}=M[k];return zA("FORCE_AG_HIGH_FRAMERATE")&&"maintain-framerate"===U&&(x=M[1].threshold.fps_up),L>x}(k,$,j,V)&&function(L,k,M){if(0===k)return;const{threshold:{bwe_up:U}}=M[k];return L>U}(M,$,j)&&(F.underUse++,F.underUse>Q&&(F.overUse=0,F.underUse=0,ee=JF(U,j,V,TF.UP),0===ee.scale&&(te=gF.NONE))),[ee,te])}(L,V,Q,j.adaptationConfig,k,U);ee&&(M.qualityLimitationReason=ee),$&&j.adaptationConfig.scale!==$.scale&&(Eb.debug("[".concat(L,"] applyAdaptation: ").concat(M.qualityLimitationReason,"\n           sendFps ").concat(V,", bwe ").concat(Q,", switch from ").concat(j.adaptationConfig.scale," to ").concat($.scale," ")),j.adaptationConfig=eB(eB({},j.adaptationConfig),$),x($))}}),zA("CHECK_LOCAL_STATS_INTERVAL")),z=eB({},k);RF.set(L,{timer:j,adaptationConfig:z,originConfig:k,adaptationFunc:x}),Eb.debug("[".concat(L,"] start adaptation, originConfig: ").concat(JSON.stringify(k),", degradationPreference: ").concat(U))}(this.id+F.mid,j,this,M,(L=>{k&&this.updateAdaptation(k,L)}),this.getLocalVideoStats.bind(this))}if(L._encoderConfig){var Q;const{bitrateMax:k,frameRate:M,scaleResolutionDownBy:U}=L._encoderConfig;k&&(V.maxBitrate=1e3*k),(Sr(Q=L._hints).call(Q,sL.LOW_STREAM)||L.isUseScaleResolutionDownBy)&&(M&&(V.maxFramerate=JO(M)),U&&U>=1&&(V.scaleResolutionDownBy=U))}const{maxFramerate:$}=zA("ENCODER_CONFIG_LIMIT");if($&&"number"==typeof $&&(V.maxFramerate=V.maxFramerate?Math.min(V.maxFramerate,$):$),zA("DSCP_TYPE")&&py()){var ee;const L=zA("DSCP_TYPE");Sr(ee=["very-low","low","medium","high"]).call(ee,L)&&(V.networkPriority=L)}const te=k.getParameters(),ie=null===(U=te.encodings)||void 0===U?void 0:U[0];Xv()&&!ie&&(x.encodings=[V]),ie&&Object.assign(ie,V),Object.assign(te,x),Eb.debug("[".concat(L.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(te.encodings))),await k.setParameters(te),await async function(L,k,M){try{var U;if(!XP().supportSetRtpSenderParameters)return;if(!function(L){return"vp9"===L}(L)||!zA("ENABLE_SVC"))return;const x={},V={},F=k.getParameters(),j=null===(U=F.encodings)||void 0===U?void 0:U[0];V.scalabilityMode=VU(M),j&&Object.assign(j,V),Object.assign(F,x),await k.setParameters(F),Eb.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode success: ".concat(JSON.stringify(F.encodings)))}catch(L){Eb.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode failed",L)}}(this.store.codec,k,zA("SVC_MODE"))}async updateAdaptation(L,k){var M,U;if(!L)return Eb.debug("[updateAdaptation] no rtpSender found");if(!XP().supportSetRtpSenderParameters)return Eb.debug("[updateAdaptation] Browser not support set rtp-sender parameters");const x={},{bitrateMax:V,frameRate:F,scaleResolutionDownBy:j}=k;V&&(x.maxBitrate=1e3*V),F&&(x.maxFramerate=JO(F)),j&&j>=1&&Sr(M=["vp8","vp9"]).call(M,this.store.codec)&&(x.scaleResolutionDownBy=j);const z=L.getParameters(),Q=null===(U=z.encodings)||void 0===U?void 0:U[0];Q&&Object.assign(Q,x),Object.assign(z,{});try{await L.setParameters(z),Eb.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(z.encodings)))}catch(k){!("transport"in L)||L.transport&&"connected"===L.transport.state?"connected"!==this.peerConnectionState?Eb.debug("[updateAdaptation] peerConnection not connected}"):Eb.debug("[updateAdaptation] updateRtpSenderEncodings failed",k):Eb.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(L,k){try{if(!XP().supportSetRtpSenderParameters)return;if(L.length!==k.length)return;for(let M=0;M<L.length;M++){const U=L[M],x=k[M];x instanceof eU&&!this.isVP8Simulcast(x)&&await this.updateRtpSenderEncodings(x,U.sender)}}catch(L){Eb.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(L,k,M){const U=wU.parse(L);return k.forEach(((L,k)=>{const x=M[k],V=U.mediaDescriptions.find((L=>L.attributes.mid===x));V&&(qU(V,L),ZU(V,L,this.store.codec))})),wU.print(U)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=L=>{var k;null===(k=this.onFirstAudioReceived)||void 0===k||k.call(this,L)},this.statsFilter.onFirstVideoReceived=L=>{var k;null===(k=this.onFirstVideoReceived)||void 0===k||k.call(this,L)},this.statsFilter.onFirstAudioDecoded=L=>{var k;null===(k=this.onFirstAudioDecoded)||void 0===k||k.call(this,L)},this.statsFilter.onFirstVideoDecoded=(L,k,M)=>{var U;null===(U=this.onFirstVideoDecoded)||void 0===U||U.call(this,L,k,M)},this.statsFilter.onSelectedLocalCandidateChanged=(L,k)=>{var M;null===(M=this.onSelectedLocalCandidateChanged)||void 0===M||M.call(this,L,k)},this.statsFilter.onSelectedRemoteCandidateChanged=(L,k)=>{var M;null===(M=this.onSelectedRemoteCandidateChanged)||void 0===M||M.call(this,L,k)},this.statsFilter.onFirstVideoDecodedTimeout=L=>{var k;null===(k=this.onFirstVideoDecodedTimeout)||void 0===k||k.call(this,L)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(L,k){if(L.length===k.length)for(let j=0;j<L.length;j++){var M,U,x,V,F;const z=L[j],Q=k[j];if(Q instanceof eU&&!Sr(M=Q._hints).call(M,sL.LOW_STREAM)&&null!==(U=Q._encoderConfig)&&void 0!==U&&U.bitrateMax&&(null===(x=Q._encoderConfig)||void 0===x?void 0:x.bitrateMax)>200&&null!==(V=Q._scalabilityMode)&&void 0!==V&&V.numSpatialLayers&&(null===(F=Q._scalabilityMode)||void 0===F?void 0:F.numSpatialLayers)>1&&"vp8"===this.store.codec){const L={},k={high:1e3*(Q._encoderConfig.bitrateMax-50),medium:5e4};L.encodings=[{rid:"m",active:!0,maxBitrate:k.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:k.high}];const M=z.sender.getParameters();await z.sender.setParameters(Object.assign(M,L))}}}async applySimulcastEncodings(L,k){if(!Xv()&&L.length===k.length)for(let M=0;M<L.length;M++){const U=k[M];if(U instanceof eU&&this.isVP8Simulcast(U)){const k=L[M],x={},V={high:1e3*(U._encoderConfig.bitrateMax-50),medium:5e4};x.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:V.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:V.medium,scaleResolutionDownBy:4}];const F=k.sender.getParameters();await k.sender.setParameters(Object.assign(F,x))}}}isVP8Simulcast(L){var k,M,U,x,V;return!!(L instanceof eU&&zA("SIMULCAST")&&"vp8"===this.store.codec&&!Sr(k=L._hints).call(k,sL.LOW_STREAM)&&null!==(M=L._encoderConfig)&&void 0!==M&&M.bitrateMax&&(null===(U=L._encoderConfig)||void 0===U?void 0:U.bitrateMax)>200&&null!==(x=L._scalabilityMode)&&void 0!==x&&x.numSpatialLayers&&(null===(V=L._scalabilityMode)||void 0===V?void 0:V.numSpatialLayers)>1)}logSDPExchange(L,k,M,U){if(zA("SDP_LOGGING"))return Eb.upload("[".concat(this.store.clientId,"] exchanging ").concat(M," ").concat(k," SDP during P2PConnection.").concat(U,"\n"),L),"offer"===k?L=>{this.logSDPExchange(L,"answer","local"===M?"remote":"local",U)}:void 0}async getRemoteSSRC(L){if(!this.remoteSDP)return;const k=this.remoteSDP.getSSRC(L);return k&&0!==k.length?k[0].ssrcId:void 0}setConfiguration(L){if(XP().supportPCSetConfiguration){const k=e.resolvePCConfiguration(L);this.peerConnection.setConfiguration(k)}}},gw(yF.prototype,"updateRemoteRTPCapabilities",[cB],Object.getOwnPropertyDescriptor(yF.prototype,"updateRemoteRTPCapabilities"),yF.prototype),gw(yF.prototype,"connect",[cB],Object.getOwnPropertyDescriptor(yF.prototype,"connect"),yF.prototype),gw(yF.prototype,"updateRemoteConnect",[cB],Object.getOwnPropertyDescriptor(yF.prototype,"updateRemoteConnect"),yF.prototype),gw(yF.prototype,"createDataChannels",[cB],Object.getOwnPropertyDescriptor(yF.prototype,"createDataChannels"),yF.prototype),gw(yF.prototype,"receive",[cB],Object.getOwnPropertyDescriptor(yF.prototype,"receive"),yF.prototype),gw(yF.prototype,"batchReceive",[cB],Object.getOwnPropertyDescriptor(yF.prototype,"batchReceive"),yF.prototype),gw(yF.prototype,"stopReceiving",[cB],Object.getOwnPropertyDescriptor(yF.prototype,"stopReceiving"),yF.prototype),gw(yF.prototype,"muteRemote",[cB],Object.getOwnPropertyDescriptor(yF.prototype,"muteRemote"),yF.prototype),gw(yF.prototype,"unmuteRemote",[cB],Object.getOwnPropertyDescriptor(yF.prototype,"unmuteRemote"),yF.prototype),gw(yF.prototype,"muteLocal",[cB],Object.getOwnPropertyDescriptor(yF.prototype,"muteLocal"),yF.prototype),gw(yF.prototype,"unmuteLocal",[cB],Object.getOwnPropertyDescriptor(yF.prototype,"unmuteLocal"),yF.prototype),gw(yF.prototype,"close",[cB],Object.getOwnPropertyDescriptor(yF.prototype,"close"),yF.prototype),gw(yF.prototype,"updateEncoderConfig",[cB],Object.getOwnPropertyDescriptor(yF.prototype,"updateEncoderConfig"),yF.prototype),gw(yF.prototype,"updateSendParameters",[cB],Object.getOwnPropertyDescriptor(yF.prototype,"updateSendParameters"),yF.prototype),gw(yF.prototype,"replaceTrack",[cB],Object.getOwnPropertyDescriptor(yF.prototype,"replaceTrack"),yF.prototype),gw(yF.prototype,"updateAdaptation",[cB],Object.getOwnPropertyDescriptor(yF.prototype,"updateAdaptation"),yF.prototype),gw(yF.prototype,"getRemoteSSRC",[cB],Object.getOwnPropertyDescriptor(yF.prototype,"getRemoteSSRC"),yF.prototype),yF);function cB(L,k,M){const U=L[k];if("function"!=typeof U)throw new Error("Cannot use mutex on object property.");return M.value=async function(){const L=this.mutex,M=await L.lock("From P2PConnection.".concat(k));try{for(var x=arguments.length,V=new Array(x),F=0;F<x;F++)V[F]=arguments[F];return await U.apply(this,V)}finally{M()}},M}var kF;function lB(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function uB(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?lB(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):lB(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}function hB(L){var k,M,U,x=2;for("undefined"!=typeof Symbol&&(M=RC,U=Symbol.iterator);x--;){if(M&&null!=(k=L[M]))return k.call(L);if(U&&null!=(k=L[U]))return new pB(k.call(L));M="@@asyncIterator",U="@@iterator"}throw new TypeError("Object is not async iterable")}function pB(L){function t(L){if(Object(L)!==L)return Mp.reject(new TypeError(L+" is not an object."));var k=L.done;return Mp.resolve(L.value).then((function(L){return{value:L,done:k}}))}return pB=function(L){this.s=L,this.n=L.next},pB.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(L){var k=this.s.return;return void 0===k?Mp.resolve({value:L,done:!0}):t(k.apply(this.s,arguments))},throw:function(L){var k=this.s.return;return void 0===k?Mp.reject(L):t(k.apply(this.s,arguments))}},new pB(L)}let xF=(kF=class extends My{get state(){return this._state}set state(L){const k=this._state;this._state=L,this.emit(lO.StateChange,k,this._state)}constructor(L,k){super(),xg(this,"isPlanB",void 0),xg(this,"store",void 0),xg(this,"statsUploader",void 0),xg(this,"connection",void 0),xg(this,"localTrackMap",new Map),xg(this,"remoteUserMap",new Map),xg(this,"localDataChannels",[]),xg(this,"remoteDataChannelMap",new Map),xg(this,"pendingLocalTracks",[]),xg(this,"pendingRemoteTracks",[]),xg(this,"pendingLocalDataChannels",[]),xg(this,"pendingRemoteDataChannels",[]),xg(this,"statsCollector",void 0),xg(this,"shouldForwardP2PCreation",void 0),xg(this,"iceFailedCount",0),xg(this,"dtlsFailedCount",0),xg(this,"mutex",new wv("P2PChannel-mutex")),xg(this,"_state",dO.Disconnected),xg(this,"_pcStatsUploadType",zA("NEW_ICE_RESTART")?aO.FIRST_CONNECTION:aO.OLD_FIRST_CONNECTION),xg(this,"_isInRestartIce",!1),xg(this,"_isStartRestartIce",!1),xg(this,"_restartStates",["disconnected","failed"]),xg(this,"_restartTimer",void 0),xg(this,"_isFirstConnected",!0),xg(this,"handleMuteLocalTrack",(async(L,k,M)=>{const U=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==dO.Connected)return void M(new nv(iv.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const x=this.filterTobeMutedTracks(L);if(0===x.length)return void k();const V=x.find((L=>"videoLowTrack"===L[0]));V&&V[1].track._originMediaStreamTrack.stop(),await this.connection.muteLocal(x.map((L=>{let[,{id:k}]=L;return k})));const F=this.createMuteMessage(x);await Qy(this,lO.RequestMuteLocal,F),k()}catch(L){M(L)}finally{U()}})),xg(this,"handleUnmuteLocalTrack",(async(L,k,M)=>{const U=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==dO.Connected)return void M(new nv(iv.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const x=this.filterTobeUnmutedTracks(L);if(0===x.length)return void k();const V=x.find((L=>"videoLowTrack"===L[0]));if(V){const k=V[1];if(k.track._originMediaStreamTrack.stop(),!zA("DISABLE_DUAL_STREAM_USE_ENCODING")&&XP().supportDualStreamEncoding){const M=L._mediaStreamTrack.clone();k.track._mediaStreamTrack=M,k.track._originMediaStreamTrack=M}else{const M=WV(L,$y(this,lO.RequestLowStreamParameter));k.track._mediaStreamTrack=M,k.track._originMediaStreamTrack=M}await new Mp(((L,M)=>{this.handleReplaceTrack(k.track,L,M,!0)}))}await this.connection.unmuteLocal(x.map((L=>{let[,{id:k}]=L;return k})));const F=this.createUnmuteMessage(x);await Qy(this,lO.RequestUnmuteLocal,F),k()}catch(L){M(L)}finally{U()}})),xg(this,"handleUpdateVideoEncoder",(async(L,k,M)=>{const U=await this.mutex.lock("Locking from P2PChannel.handleSetVideoEncoder");try{const M=this.localTrackMap.get(cO.LocalVideoTrack);if(!this.connection||!M||M.track!==L||this.state!==dO.Connected)return void k();const{id:x,track:V}=M;await this.connection.updateSendParameters(x,V),await this.connection.updateEncoderConfig(x,V),this.emit(lO.UpdateVideoEncoder,V),k()}catch(L){M(L)}finally{U()}})),xg(this,"handleUpdateVideoSendParameters",(async(L,k,M)=>{const U=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoSendParameters");try{const M=this.localTrackMap.get(cO.LocalVideoTrack);if(!this.connection||!M||M.track!==L||this.state!==dO.Connected)return void k();const{id:x,track:V}=M;await this.connection.updateSendParameters(x,V),k()}catch(L){M(L)}finally{U()}})),xg(this,"handleReplaceMixingTrack",(async(L,k,M,U)=>{if(!this.connection||this.state!==dO.Connected)return void k();const x=lF([L]);let V;Eb.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(x.getTrackId(),"]")),"boolean"==typeof U&&U||(V=await this.mutex.lock("From P2PChannel.handleReplaceMixingTrack"));try{await this.replaceTrack(L,x),k()}catch(L){M(L)}finally{var F;null===(F=V)||void 0===F||F()}})),xg(this,"handleReplaceTrack",(async(L,k,M,U)=>{let x;Eb.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(L.getTrackId(),"]")),"boolean"==typeof U&&U||(x=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var V;const M=Array.from(this.localTrackMap.entries()).find((k=>{let[,{track:M}]=k;return L===M}));if(!this.connection||!M||this.state!==dO.Connected)return void k();if(await(null===(V=this.connection)||void 0===V?void 0:V.replaceTrack(L,M[1].id)),this.isPlanB){const k=M[1];k.id=L._mediaStreamTrack.id,this.localTrackMap.set(M[0],k)}if(M[0]===cO.LocalVideoTrack&&!zA("DISABLE_DUAL_STREAM_USE_ENCODING")&&XP().supportDualStreamEncoding){const k=this.localTrackMap.get(cO.LocalVideoLowTrack);if(k){const M=L._mediaStreamTrack.clone();k.track._originMediaStreamTrack.stop(),k.track._mediaStreamTrack=M,k.track._originMediaStreamTrack=M,await new Mp(((L,M)=>{this.handleReplaceTrack(k.track,L,M,!0)}))}}k()}catch(L){M(L)}finally{var F;null===(F=x)||void 0===F||F()}})),xg(this,"handleGetRTCStats",(L=>{L(this.statsCollector.getRTCStats())})),xg(this,"handleGetLocalVideoStats",(L=>{L(this.statsCollector.getLocalVideoTrackStats())})),xg(this,"handleGetLocalAudioStats",(L=>{L(this.statsCollector.getLocalAudioTrackStats())})),xg(this,"handleGetRemoteVideoStats",(L=>this.statsCollector.getRemoteVideoTrackStats(L.uid)[L.uid])),xg(this,"handleGetRemoteAudioStats",(L=>this.statsCollector.getRemoteAudioTrackStats(L.uid)[L.uid])),this.store=L,this.statsCollector=k,this.statsCollector.addP2PChannel(this),this.statsUploader=new oF(this.store),this.bindStatsUploaderEvents(),this.isPlanB=!XP().supportUnifiedPlan||zA("CHROME_FORCE_PLAN_B")&&py(),this.shouldForwardP2PCreation=zA("FORWARD_P2P_CREATION")&&XP().supportPCSetConfiguration&&hy(),this.shouldForwardP2PCreation&&(this.connection=this.isPlanB?new fF({},this.store):new CF({},this.store),this.bindConnectionEvents(this.connection))}async startP2PConnection(L){var k;this.state=dO.New;const M=this.shouldForwardP2PCreation&&"closed"===(null===(k=this.connection)||void 0===k?void 0:k.peerConnectionState);if(this.shouldForwardP2PCreation&&!M||(M&&this.connection&&(Eb.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.connection.close(),this.unbindConnectionEvents(this.connection)),this.connection=this.isPlanB?new fF(L,this.store):new CF(L,this.store),this.bindConnectionEvents(this.connection)),!this.connection)throw new nv(iv.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=zA("NEW_ICE_RESTART")?aO.FIRST_CONNECTION:aO.OLD_FIRST_CONNECTION,this._isFirstConnected=!0,this._isInRestartIce=!1,this._isStartRestartIce=!1,this.connection.setConfiguration(L),this.connection.establishPromise}async connect(L){if(!this.connection)throw new nv(iv.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");zA("ENABLE_PREALLOC_PC")&&this.state===dO.Connected?await this.connection.updateRemoteConnect(L):(this.store.peerConnectionStart(),await this.connection.connect(L),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=dO.Connected)}updateRemoteRTPCapabilities(L){const k=Array.from(this.localTrackMap.entries()).filter((L=>{var k;let[M]=L;return Sr(k=[cO.LocalVideoLowTrack,cO.LocalVideoTrack]).call(k,M)})),M=k.map((L=>{let[,{id:k}]=L;return k})),U=k.map((L=>{let[k]=L;return k}));if(this.connection instanceof CF){if(Ab.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(U),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(L)}),!Sr(L).call(L,this.store.codec)){const k=["vp9","vp8","h264"].find((k=>Sr(L).call(L,k)));k&&(this.store.codec=k,Eb.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(k,".")))}this.connection.updateRemoteRTPCapabilities(M,L)}}async getEstablishParams(){var L;if(this.connection instanceof CF&&"closed"!==this.connection.peerConnectionState&&Sr(L=[dO.New,dO.Connected]).call(L,this.state))return this.connection.establishPromise}async publishDataChannel(L){if(!this.connection||this.state!==dO.Connected){if(this.state===dO.Disconnected)throw new nv(iv.UNEXPECTED_ERROR,"PeerConnection already disconnected.");return L.forEach((L=>{var k;Sr(k=this.pendingLocalDataChannels).call(k,L)||this.pendingLocalDataChannels.push(L)})),[]}const k=this.filterTobePublishedDataChannels(L);return 0===k.length?[]:(k.forEach((L=>{const k=Date.now();this.store.publish(L.id.toString(),"datachannel",k)})),await this.connection.createDataChannels(this.store.uid,k),k.forEach((L=>{this.localDataChannels.push(L);const k=Date.now();this.store.publish(L.id+"","datachannel",void 0,k)})),L.map((L=>({streamId:L.id,ordered:L.ordered,maxRetransmits:L.maxRetransmits,metadata:L.metadata,channelId:L._originDataChannelId}))))}publish(L,k,M){var U=this;return HI((function*(){const x=yield KI(U.mutex.lock("From P2PChannel.publish"));try{if(!U.connection||U.state!==dO.Connected){if(U.state===dO.Disconnected)throw new nv(iv.UNEXPECTED_ERROR,"PeerConnection already disconnected.");U.throwIfTrackTypeNotMatch(L);const k=L.filter((L=>-1===U.pendingLocalTracks.indexOf(L)));return void(U.pendingLocalTracks=U.pendingLocalTracks.concat(k))}U.store.pubId=U.store.pubId+1,Cx.markPublishStart(U.store.clientId,U.store.pubId);const V=U.filterTobePublishedTracks(L,k,M);if(0===V.length)return void(yield KI(U.tryToUnmuteAudio(L)));yield*YI(hB(U.doPublish(U.connection,V)))}finally{x()}}))()}doPublish(L,k){var M=this;return HI((function*(){k.forEach((L=>{let{track:k,type:U}=L;const x=Date.now();M.store.publish(k.getTrackId(),U===cO.LocalAudioTrack?"audio":"video",x)})),M.bindLocalTrackEvents(k);const U=k.map((L=>{let{track:k}=L;return k})),x=yield KI(L.send(U,M.store.codec,M.store.audioCodec)),V=(yield KI(x.next())).value,F=M.createGatewayPublishMessage(k,V);let j;try{j=yield F}catch(L){throw x.throw(L),(null==L?void 0:L.code)===iv.WS_ABORT&&k.forEach((L=>{let{track:k}=L;-1===M.pendingLocalTracks.indexOf(k)&&M.pendingLocalTracks.push(k)})),M.unbindLocalTrackEvents(k),L}const z=M.mapPubResToRemoteConfig(F,j,U),Q=(yield KI(x.next(z))).value,$=zA("ENABLE_VIDEO_SEI");U.forEach((async L=>{const k=L.getRTCRtpTransceiver();k&&$&&(L.trackMediaType===nO.VIDEO?await async function PU(L,k){if(!XP().supportWebRTCEncodedTransform)return void Eb.warning("browser not support video encoded transform");if(RU.has(L))return;if(!L.track)return;const M={track:L.track};if(qv()){if(!L.createEncodedStreams)return void Eb.warning("browser not support createEncodedStreams() API");let U=null;try{U=L.createEncodedStreams()}catch(L){return void Eb.error("create video-encoded-streams error",L&&L.message)}let x=[];k.on("sei-to-send",(L=>{x.push(L)}));const V=new TransformStream({transform(k,U){M.controller||(M.controller=U),L.track&&L.track.id!==M.track.id&&(Eb.debug("video track changed: ".concat(M.track.id," => ").concat(L.track.id)),M.track.removeEventListener("ended",n),M.track=L.track,M.track.addEventListener("ended",n));const V=x.shift();V&&(k.data=function(L,k){const M=function(L){const k=L.length;let M=[],U=0;for(;U<k;)U+2<k&&0===L[U]&&0===L[U+1]&&(0===L[U+2]||1===L[U+2]||2===L[U+2]||3===L[U+2])?(M.push(L[U],L[U+1],3,L[U+2]),U+=3):(M.push(L[U]),U++);return new Uint8Array(M)}(k),U=M.length,x=Math.floor(U/255),V=U%255,F=new Uint8Array(6+x+1+U+L.byteLength);F[0]=0,F[1]=0,F[2]=0,F[3]=1,F[4]=6,F[5]=101;let j=0;for(;j<x;)F[6+j]=255,j++;return F[6+j]=V,j++,F.set(M,6+j),F.set(new Uint8Array(L),6+j+U),F.buffer}(k.data,V)),U.enqueue(k)}});U.readable.pipeThrough(V).pipeTo(U.writable)}else{if(!zv())return;{if("undefined"==typeof RTCRtpScriptTransform)return void Eb.warning("browser not support RTCRtpScriptTransform");const U=bU(),x=new MessageChannel;await new Mp((L=>U.onmessage=k=>{"registered"===k.data&&L(void 0)}));const V=new RTCRtpScriptTransform(U,{name:"tx",port:x.port2},[x.port2]);L.transform=V,await new Mp((L=>U.onmessage=k=>{"started"===k.data&&L(void 0)})),k.on("sei-to-send",(L=>{x.port1.postMessage({sei:L})})),x.port1.onmessage=k=>{var U;k.data.transformed&&L.track&&(null===(U=L.track)||void 0===U?void 0:U.id)!==M.track.id&&(Eb.debug("video track changed: ".concat(M.track.id," => ").concat(L.track.id)),M.track.removeEventListener("ended",n),M.track=L.track,M.track.addEventListener("ended",n))},M.worker=U}}function n(){if(L.track){if(this.id!==L.track.id)return;L.track.removeEventListener("ended",n)}const k=RU.get(L);if(k){RU.delete(L);try{var M,U;null===(M=k.controller)||void 0===M||M.terminate(),null===(U=k.worker)||void 0===U||U.terminate()}catch(L){Eb.warning(L&&L.message)}}}RU.set(L,M),L.track.addEventListener("ended",n)}(k.sender,L):L.trackMediaType===nO.AUDIO&&await async function(L){if(!XP().supportWebRTCEncodedTransform)return void Eb.warning("browser not support audio encoded transform");if(TU.has(L))return;if(!L.track)return;const k={track:L.track};if(qv()){if(!L.createEncodedStreams)return void Eb.warning("browser not support createEncodedStreams() API");let M=null;try{M=L.createEncodedStreams()}catch(L){return void Eb.error("create audio-encoded-streams error",L&&L.message)}const U=new TransformStream({transform(M,U){k.controller||(k.controller=U),L.track&&L.track.id!==k.track.id&&(Eb.debug("audio track changed: ".concat(k.track.id," => ").concat(L.track.id)),k.track.removeEventListener("ended",i),k.track=L.track,k.track.addEventListener("ended",i)),U.enqueue(M)}});M.readable.pipeThrough(U).pipeTo(M.writable)}else if(zv()){if("undefined"==typeof RTCRtpScriptTransform)return void Eb.warning("browser not support RTCRtpScriptTransform");const M=bU(),U=new MessageChannel;await new Mp((L=>M.onmessage=k=>{"registered"===k.data&&L(void 0)}));const x=new RTCRtpScriptTransform(M,{name:"tx",port:U.port2},[U.port2]);L.transform=x,await new Mp((L=>M.onmessage=k=>{"started"===k.data&&L(void 0)})),U.port1.onmessage=M=>{var U;M.data.transformed&&L.track&&(null===(U=L.track)||void 0===U?void 0:U.id)!==k.track.id&&(Eb.debug("audio track changed: ".concat(k.track.id," => ").concat(L.track.id)),k.track.removeEventListener("ended",i),k.track=L.track,k.track.addEventListener("ended",i))},k.worker=M}function i(){if(L.track){if(this.id!==L.track.id)return;L.track.removeEventListener("ended",i)}const k=TU.get(L);if(k){TU.delete(L);try{var M,U;null===(M=k.controller)||void 0===M||M.terminate(),null===(U=k.worker)||void 0===U||U.terminate()}catch(L){Eb.warning(L&&L.message)}}}TU.set(L,k),L.track.addEventListener("ended",i)}(k.sender))})),k.forEach((L=>{let{type:k}=L;M.statsCollector.addLocalStats(k)})),M.assignLocalTracks(k,Q),M.statsUploader.startUploadOutboundStats(),k.forEach((L=>{let{track:k,type:U}=L;const x=Date.now();M.store.publish(k.getTrackId(),U===cO.LocalAudioTrack?"audio":"video",void 0,x)}))}))()}async updateVideoStreamParameter(L,k){const M=this.localTrackMap.get(k);if(!M)return;if(!(M.track instanceof eU))return Eb.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");if(!(this.connection instanceof CF||this.connection instanceof fF))return Eb.warn("[updateVideoStreamParameter]: connection is not P2PConnection or P2PConnectionPlanB");const{track:U}=M,x=function(L,k){const M={};return L.height&&L.width&&(M.scaleResolutionDownBy=eN(L,k)),M.maxFramerate=L.framerate?JO(L.framerate):void 0,M.maxBitrate=L.bitrate?1e3*L.bitrate:void 0,M}(L,U);if(U._encoderConfig||(U._encoderConfig={}),k!==cO.LocalVideoLowTrack||!zA("DISABLE_DUAL_STREAM_USE_ENCODING")&&XP().supportDualStreamEncoding)null!=x.scaleResolutionDownBy&&(U._encoderConfig.scaleResolutionDownBy=x.scaleResolutionDownBy);else{const k=U._originMediaStreamTrack;if(!k.canvas)return Eb.warn("[".concat(U.getTrackId(),"] no canvas on track"));!function(L,k){const M=L.canvas;k.width&&(M.width=JO(k.width)),k.height&&(M.height=JO(k.height)),k.framerate&&(M.stopCapture&&M.stopCapture(),M.stopCapture=JL((()=>{!M.startCapture&&M.stopCapture&&M.stopCapture(),M.startCapture&&M.startCapture()}),JO(k.framerate)))}(k,L)}null!=x.maxBitrate&&(U._encoderConfig.bitrateMax=x.maxBitrate/1e3),null!=x.maxFramerate&&(U._encoderConfig.frameRate&&"object"==typeof U._encoderConfig.frameRate?U._encoderConfig.frameRate.max=x.maxFramerate:U._encoderConfig.frameRate={max:x.maxFramerate}),Eb.debug("[".concat(U.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(U._encoderConfig))),await this.connection.updateRtpSenderEncodings(U)}publishLowStream(L){var k=this;return HI((function*(){if(!k.connection||k.state!==dO.Connected)return;const M=yield KI(k.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const x=k.localTrackMap.get(cO.LocalVideoTrack);if(!x)throw new nv(iv.UNEXPECTED_ERROR,"Could not find high stream");if(k.localTrackMap.has(cO.LocalVideoLowTrack))throw new nv(iv.UNEXPECTED_ERROR,"[".concat(k.store.clientId,"] Can't publish low stream when stream already publish"));const V=[{track:k.getLowVideoTrack(x.track,L),type:cO.LocalVideoLowTrack}];if(yield*YI(hB(k.doPublish(k.connection,V))),x.track.muted||!x.track.enabled){var U;const L=null===(U=k.localTrackMap.get(cO.LocalVideoLowTrack))||void 0===U?void 0:U.id;void 0!==L&&(yield KI(k.connection.muteLocal([L])))}}finally{M()}}))()}async republish(){this.pendingLocalTracks.length>0&&(Eb.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await Xy(this,lO.RequestRePublish,this.pendingLocalTracks),this.emit(lO.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(Eb.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await Xy(this,lO.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[])}async reSubscribe(L){for(let L=this.pendingRemoteTracks.length-1;L>=0;L--){const{user:k,kind:M}=this.pendingRemoteTracks[L];(M!==nO.AUDIO||k._audio_added_&&k._audioSSRC)&&(M!==nO.VIDEO||k._video_added_&&k._videoSSRC)||this.pendingRemoteTracks.splice(L,1)}if(L)await Xy(this,lO.RequestReSubscribe,this.pendingRemoteTracks);else for(const{user:L,kind:k}of this.pendingRemoteTracks)await this.subscribe(L,k,k===nO.VIDEO?L._videoSSRC:L._audioSSRC);this.pendingRemoteTracks.forEach((L=>{let{user:k}=L;this.emit(lO.MediaReconnectEnd,k.uid)})),this.pendingRemoteTracks=[]}async unpublish(L){if(!this.connection||this.state!==dO.Connected)return void L.forEach((L=>{const k=this.pendingLocalTracks.indexOf(L);-1!==k&&this.pendingLocalTracks.splice(k,1)}));const k=this.filterTobeUnpublishedTracks(L);if(0===k.length)return;const M=k.find((L=>"videoLowTrack"===L[0]));return M&&M[1].track.close(),this.doUnpublish(this.connection,k)}async unpublishDataChannel(L){if(!this.connection||this.state!==dO.Connected)return void L.forEach((L=>{const k=this.pendingLocalDataChannels.indexOf(L);-1!==k&&this.pendingLocalDataChannels.splice(k,1)}));const k=this.filterTobeUnpublishedDataChannels(L);return 0!==k.length?(k.forEach((L=>{const k=this.localDataChannels.indexOf(L);-1!==k&&this.localDataChannels.splice(k,1)})),0===this.localDataChannels.length&&await this.connection.stopDataChannels(this.store.uid),k.map((L=>L.id))):void 0}async unpublishLowStream(){if(!this.connection||this.state!==dO.Connected)return;const L=this.localTrackMap.get(cO.LocalVideoLowTrack);if(!L)return;L.track.close();const k=[[cO.LocalVideoLowTrack,L]];return this.doUnpublish(this.connection,k)}async doUnpublish(L,k){const M=this.createGatewayUnpublishMessage(k);return await L.stopSending(k.map((L=>{let[,{id:k}]=L;return k}))),this.withdrawLocalTracks(k),this.unbindLocalTrackEvents(k.map((L=>{let[k,{track:M}]=L;return{type:k,track:M}}))),k.forEach((L=>{let[k]=L;this.statsCollector.removeLocalStats(k)})),0===this.localTrackMap.size&&this.statsUploader.stopUploadOutboundStats(),M}async subscribeDataChannel(L,k){if(!this.connection||this.state!==dO.Connected)throw new nv(iv.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");const M=k.filter((k=>{var M;return!(null!==(M=this.remoteDataChannelMap.get(L))&&void 0!==M&&M.get(k.id))}));if(0!==M.length)return await this.connection.createDataChannels(L.uid,M),M.forEach((k=>{var M;this.remoteDataChannelMap.has(L)?null===(M=this.remoteDataChannelMap.get(L))||void 0===M||M.set(k.id,k):this.remoteDataChannelMap.set(L,new Map([[k.id,k]]));const U=this.pendingRemoteDataChannels.findIndex((M=>{let{user:U,id:x}=M;return U.uid===L.uid&&x===k.id}));-1!==U&&this.pendingRemoteDataChannels.splice(U,1)})),M.map((L=>L.id))}async subscribe(L,k,M,U,x){var V;if(!this.connection||this.state!==dO.Connected)throw new nv(iv.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if(null!==(V=this.remoteUserMap.get(L))&&void 0!==V&&V.has(k))return;let F,j,z;const Q=this.connection.getPreMedia(M);if(Q)Eb.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] preSSRCMap has ssrcId: ").concat(M,", no need to send sub to gateway.")),z=Q.transceiver,F=Q.track,j=Q.id;else if(x){const M=x.find((L=>{let{stream_type:M}=L;return M===k}));if(!M)throw new nv(iv.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(k," for user: ").concat(L.uid," because subscribe answer from gateway does not contain stream_type: ").concat(k,"."));const U=await this.connection.receive(k,M.ssrcs,String(L._uintid),M.attributes);this.connection instanceof CF&&(z=U.transceiver),F=U.track,j=U.id}else{const x=await this.connection.receive(k,[{ssrcId:M,rtx:U}],String(L._uintid),void 0);this.connection instanceof CF&&(z=x.transceiver),F=x.track,j=x.id}k===nO.AUDIO?(L._audioTrack?L._audioTrack._updateOriginMediaStreamTrack(F):(L._audioTrack=new fU(F,L.uid,L._uintid,this.store),Eb.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(L._audioTrack.getTrackId()))),z&&L._audioTrack._updateRtpTransceiver(z),this.bindRemoteTrackEvents(L,L._audioTrack)):(L._videoTrack?L._videoTrack._updateOriginMediaStreamTrack(F):(L._videoTrack=new EU(F,L.uid,L._uintid,this.store),Eb.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(L._videoTrack.getTrackId()))),z&&L._videoTrack._updateRtpTransceiver(z),this.bindRemoteTrackEvents(L,L._videoTrack)),zA("ENABLE_VIDEO_SEI")&&z&&(k==nO.VIDEO?await async function(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!XP().supportWebRTCEncodedTransform)return void Eb.warning("browser not support video encoded transform");if(!L.track)return;if(IU.has(L)){const M=IU.get(L);return void(M&&(M.onSei=k.onSei))}const M={track:L.track,onSei:k.onSei};if(qv()){if(!L.createEncodedStreams)return void Eb.warning("browser not support createEncodedStreams() API");let k=null;try{k=L.createEncodedStreams()}catch(L){return void Eb.error("create video-encoded-streams error",L&&L.message)}const U=new TransformStream({transform(k,U){M.controller||(M.controller=U),L.track&&L.track.id!==M.track.id&&(Eb.debug("video track changed: ".concat(M.track.id," => ").concat(L.track.id)),M.track.removeEventListener("ended",n),M.track=L.track,M.track.addEventListener("ended",n));const x=function(L){const k=new DataView(L.data);let M=0;for(;M+4<L.data.byteLength;){if(0===k.getUint8(M+0)&&0===k.getUint8(M+1)&&0===k.getUint8(M+2)&&1===k.getUint8(M+3)&&6===k.getUint8(M+4)){let U=M+6,x=0,V=0;for(;255===(V=k.getUint8(U++));)x+=255;x+=V;const F=NU(L.data,U,x);return new Uint8Array(F)}M++}return null}(k);x&&M.onSei&&M.onSei(x),U.enqueue(k)}});k.readable.pipeThrough(U).pipeTo(k.writable)}else if(zv()){if("undefined"==typeof RTCRtpScriptTransform)return void Eb.warning("browser not support RTCRtpScriptTransform");const k=bU(),U=new MessageChannel;await new Mp((L=>k.onmessage=k=>{"registered"===k.data&&L(void 0)}));const x=new RTCRtpScriptTransform(k,{name:"rx",port:U.port2},[U.port2]);L.transform=x,await new Mp((L=>k.onmessage=k=>{"started"===k.data&&L(void 0)})),U.port1.onmessage=k=>{var U;k.data.transformed&&L.track&&(null===(U=L.track)||void 0===U?void 0:U.id)!==M.track.id?(Eb.debug("video track changed: ".concat(M.track.id," => ").concat(L.track.id)),M.track.removeEventListener("ended",n),M.track=L.track,M.track.addEventListener("ended",n)):k.data.sei&&M.onSei&&M.onSei(k.data.sei)},M.worker=k}function n(){if(L.track){if(this.id!==L.track.id)return;L.track.removeEventListener("ended",n)}!function(L){const k=IU.get(L);if(k){IU.delete(L);try{var M,U;null===(M=k.controller)||void 0===M||M.terminate(),null===(U=k.worker)||void 0===U||U.terminate()}catch(L){Eb.warning(L&&L.message)}}}(L)}IU.set(L,M),L.track.addEventListener("ended",n)}(z.receiver,{onSei:k=>{var M;null===(M=L._videoTrack)||void 0===M||M._onSei(k)}}):k==nO.AUDIO&&await async function(L){if(!XP().supportWebRTCEncodedTransform)return void Eb.warning("browser not support audio encoded transform");if(SU.has(L))return;const k={track:L.track};if(qv()){if(!L.createEncodedStreams)return void Eb.warning("browser not support createEncodedStreams() API");let M=null;try{M=L.createEncodedStreams()}catch(L){return void Eb.error("create audio-encoded-streams error",L&&L.message)}const U=new TransformStream({transform(M,U){k.controller||(k.controller=U),L.track&&L.track.id!==k.track.id&&(Eb.debug("audio track changed: ".concat(k.track.id," => ").concat(L.track.id)),k.track.removeEventListener("ended",i),k.track=L.track,k.track.addEventListener("ended",i)),U.enqueue(M)}});M.readable.pipeThrough(U).pipeTo(M.writable)}else if(zv()){if("undefined"==typeof RTCRtpScriptTransform)return void Eb.warning("browser not support RTCRtpScriptTransform");const M=bU(),U=new MessageChannel;await new Mp((L=>M.onmessage=k=>{"registered"===k.data&&L(void 0)}));const x=new RTCRtpScriptTransform(M,{name:"rx",port:U.port2},[U.port2]);L.transform=x,await new Mp((L=>M.onmessage=k=>{"started"===k.data&&L(void 0)})),U.port1.onmessage=M=>{var U;M.data.transformed&&L.track&&(null===(U=L.track)||void 0===U?void 0:U.id)!==k.track.id&&(Eb.debug("audio track changed: ".concat(k.track.id," => ").concat(L.track.id)),k.track.removeEventListener("ended",i),k.track=L.track,k.track.addEventListener("ended",i))},k.worker=M}function i(){L.track.removeEventListener("ended",i),function(L){const k=SU.get(L);if(k){SU.delete(L);try{var M,U;null===(M=k.controller)||void 0===M||M.terminate(),null===(U=k.worker)||void 0===U||U.terminate()}catch(L){Eb.warning(L&&L.message)}}}(L)}SU.set(L,k),L.track.addEventListener("ended",i)}(z.receiver));const $=this.remoteUserMap.get(L);$?$.set(k,j):this.remoteUserMap.set(L,new Map([[k,j]])),this.statsCollector.addRemoteStats(L.uid),this.statsUploader.startUploadInboundStats();const ee=this.pendingRemoteTracks.findIndex((M=>{let{user:U,kind:x}=M;return U.uid===L.uid&&k===x}));-1!==ee&&(this.pendingRemoteTracks.splice(ee,1),this.emit(lO.MediaReconnectEnd,L.uid))}async massSubscribe(L){return this.massSubscribeNoLock(L)}async massSubscribeNoLock(L){if(!this.connection||this.state!==dO.Connected)throw new nv(iv.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");L=L.filter((L=>{var k;let{user:M,mediaType:U}=L;return!(null!==(k=this.remoteUserMap.get(M))&&void 0!==k&&k.has(U))}));const k=[],M=new Map;L.forEach((L=>{if(!this.connection)return;const U=this.connection.getPreMedia(L.ssrcId);U?M.set(L.ssrcId,U):k.push(L)}));const U=await this.connection.batchReceive(k.map((L=>{let{user:k,mediaType:M,ssrcId:U,rtxSsrcId:x}=L;return{kind:M,ssrcMsg:[{ssrcId:U,rtx:x}],mslabel:String(k._uintid)}})));k.forEach(((L,k)=>{M.set(L.ssrcId,U[k])})),L.forEach((L=>{let{user:k,mediaType:U,ssrcId:x}=L;const V=M.get(x);if(!V)return void Eb.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] cannot find ").concat(k.uid," subscribe data,").concat(U,", ").concat(x));const{track:F,id:j,transceiver:z}=V;U===nO.AUDIO?(k._audioTrack?k._audioTrack._updateOriginMediaStreamTrack(F):(k._audioTrack=new fU(F,k.uid,k._uintid,this.store),Eb.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(k._audioTrack.getTrackId()))),z&&k._audioTrack._updateRtpTransceiver(z),this.bindRemoteTrackEvents(k,k._audioTrack)):(k._videoTrack?k._videoTrack._updateOriginMediaStreamTrack(F):(k._videoTrack=new EU(F,k.uid,k._uintid,this.store),Eb.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(k._videoTrack.getTrackId()))),z&&k._videoTrack._updateRtpTransceiver(z),this.bindRemoteTrackEvents(k,k._videoTrack));const Q=this.remoteUserMap.get(k);Q?Q.set(U,j):this.remoteUserMap.set(k,new Map([[U,j]])),this.statsCollector.addRemoteStats(k.uid),this.statsUploader.startUploadInboundStats();const $=this.pendingRemoteTracks.findIndex((L=>{let{user:M,kind:x}=L;return M.uid===k.uid&&U===x}));-1!==$&&(this.pendingRemoteTracks.splice($,1),this.emit(lO.MediaReconnectEnd,k.uid))}))}async unsubscribe(L,k,M){const U=this.pendingRemoteTracks.filter((M=>{let{user:U,kind:x}=M;return void 0!==k?U.uid===L.uid&&k===x:U.uid===L.uid}));if(U.forEach((L=>{const k=this.pendingRemoteTracks.indexOf(L);this.pendingRemoteTracks.splice(k,1)})),this.connection&&this.state===dO.Connected||M||U.forEach((k=>{let{kind:M}=k;var U;if(M===nO.AUDIO)null===(U=L._audioTrack)||void 0===U||U._destroy(),L._audioTrack=void 0;else if(M===nO.VIDEO){var x;null===(x=L._videoTrack)||void 0===x||x._destroy(),L._videoTrack=void 0}})),!this.connection||this.state!==dO.Connected)return;const x=this.filterTobeUnSubscribedTracks(L,k);if(0===x.length)return;await this.connection.stopReceiving(x.map((L=>{let[,{id:k}]=L;return k})));const V=this.createUnsubscribeMessage(x);return this.withdrawRemoteTracks(x),0===this.remoteUserMap.size&&this.statsUploader.stopUploadInboundStats(),x.forEach((L=>{let[k,{kind:U}]=L;var x,V;if(U===nO.VIDEO&&k._videoSSRC&&(null===(x=this.connection)||void 0===x||x.setStatsRemoteVideoIsReady(k._videoSSRC,!1)),U===nO.VIDEO)this.unbindRemoteTrackEvents(k._videoTrack),M||(null===(V=k._videoTrack)||void 0===V||V._destroy(),k._videoTrack=void 0);else if(U===nO.AUDIO){var F;this.unbindRemoteTrackEvents(k._audioTrack),M||(null===(F=k._audioTrack)||void 0===F||F._destroy(),k._audioTrack=void 0)}})),V}async unsubscribeDataChannel(L,k){if(k.forEach((L=>{const k=this.pendingRemoteDataChannels.findIndex((k=>k.id===L.id));-1!==k&&this.pendingRemoteDataChannels.splice(k,1)})),!this.connection)return;const M=this.filterTobeUnSubscribedDataChannels(L,k);if(0===M.length)return;k.forEach((L=>{L._close()}));const U=this.remoteDataChannelMap.get(L);return M.forEach((L=>{U&&U.delete(L.id)})),U&&0===U.size&&(this.remoteDataChannelMap.delete(L),await this.connection.stopDataChannels(L.uid)),M.map((L=>L.id))}async massUnsubscribe(L){return this.massUnsubscribeNoLock(L)}async massUnsubscribeNoLock(L){let k=[];for(const{user:M,mediaType:U}of L){const L=this.pendingRemoteTracks.filter((L=>{let{user:k,kind:x}=L;return void 0!==U?k.uid===M.uid&&U===x:k.uid===M.uid}));L.forEach((L=>{const k=this.pendingRemoteTracks.indexOf(L);this.pendingRemoteTracks.splice(k,1)})),k=k.concat(L)}if(!this.connection||this.state!==dO.Connected)return void k.forEach((L=>{let{user:k,kind:M}=L;var U;if(M===nO.AUDIO)null===(U=k._audioTrack)||void 0===U||U._destroy(),k._audioTrack=void 0;else if(M===nO.VIDEO){var x;null===(x=k._videoTrack)||void 0===x||x._destroy(),k._videoTrack=void 0}}));const M=kr(L).call(L,((L,k)=>{let{user:M,mediaType:U}=k;const x=this.filterTobeUnSubscribedTracks(M,U);return L.concat(x)}),[]);if(0===M.length)return;await this.connection.stopReceiving(M.map((L=>{let[,{id:k}]=L;return k})));const U=this.createUnsubscribeAllMessage(M);return this.withdrawRemoteTracks(M),0===this.remoteUserMap.size&&this.statsUploader.stopUploadInboundStats(),M.forEach((L=>{let[k,{kind:M}]=L;var U,x;if(M===nO.VIDEO&&k._videoSSRC&&(null===(U=this.connection)||void 0===U||U.setStatsRemoteVideoIsReady(k._videoSSRC,!1)),M===nO.VIDEO)this.unbindRemoteTrackEvents(k._videoTrack),null===(x=k._videoTrack)||void 0===x||x._destroy(),k._videoTrack=void 0;else if(M===nO.AUDIO){var V;this.unbindRemoteTrackEvents(k._audioTrack),null===(V=k._audioTrack)||void 0===V||V._destroy(),k._audioTrack=void 0}})),U}isPreSubScribe(L){return!(!this.connection||this.state!==dO.Connected)&&!!this.connection.getPreMedia(L)}async muteRemote(L,k){if(!this.connection)return;const M=this.remoteUserMap.get(L);if(!M)return void Eb.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(L.uid,"."));if(!M.get(k))return void Eb.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(L.uid," media type ").concat(k,"."));const U=k===nO.VIDEO?L._videoSSRC:L._audioSSRC;void 0!==U&&this.connection.setStatsRemoteVideoIsReady(U,!1)}async unmuteRemote(L,k){return this.unmuteRemoteNoLock(L,k)}async unmuteRemoteNoLock(L,k){if(!this.connection)return;const M=this.remoteUserMap.get(L);M?M.get(k)||Eb.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(L.uid," media type ").concat(k,".")):Eb.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(L.uid,"."))}getAllTracks(L){const k=this.localTrackMap.get(cO.LocalAudioTrack);if((null==k?void 0:k.track)instanceof SM){const M=k.track;return Array.from(this.localTrackMap.entries()).filter((L=>{let[k]=L;return k!==cO.LocalAudioTrack})).filter((k=>{let[M]=k;return!(L&&M===cO.LocalVideoLowTrack)})).map((L=>{let[,{track:k}]=L;return k})).concat(M.trackList)}return Array.from(this.localTrackMap.entries()).filter((k=>{let[M]=k;return!(L&&M===cO.LocalVideoLowTrack)})).map((L=>{let[,{track:k}]=L;return k}))}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(L,k,M,U,x){if(L){const M=this.localTrackMap.get(cO.LocalAudioTrack),V=U?this.localTrackMap.get(cO.LocalVideoLowTrack):this.localTrackMap.get(cO.LocalVideoTrack);Ab.publish(this.store.sessionId,{eventElapse:Cx.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:L,ec:k,audioName:null==M?void 0:M.track.getTrackLabel(),videoName:null==V?void 0:V.track.getTrackLabel(),screenshare:-1!==(null==V?void 0:V.track._hints.indexOf(sL.SCREEN_TRACK)),audio:!!M,video:!!V,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:x})}else{var V;M||(M=[]);const F=M.find((L=>L instanceof uM)),j=U?null===(V=this.localTrackMap.get(cO.LocalVideoTrack))||void 0===V?void 0:V.track:M.find((L=>L instanceof eU));Ab.publish(this.store.sessionId,{eventElapse:Cx.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:L,ec:k,audioName:null==F?void 0:F.getTrackLabel(),videoName:null==j?void 0:j.getTrackLabel(),screenshare:-1!==(null==j?void 0:j._hints.indexOf(sL.SCREEN_TRACK)),audio:!!F,video:!!j,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:x})}}reportSubscribeEvent(L,k,M,U){const x=U===nO.VIDEO?M._videoSSRC:M._audioSSRC;x&&Ab.subscribe(this.store.sessionId,{succ:L,ec:k,video:U===nO.VIDEO,audio:U===nO.AUDIO,peerid:M.uid,subscribeRequestid:x,p2pid:this.store.p2pId,eventElapse:Cx.measureFromSubscribeStart(this.store.clientId,x),preSsrc:this.isPreSubScribe(x)})}reset(){Eb.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new wv("P2PChannel-mutex"),this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=this.isPlanB?new fF({},this.store):new CF({},this.store),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const L=this.localTrackMap.get(cO.LocalAudioTrack);if((null==L?void 0:L.track)instanceof SM){if(L.track.trackList.length>0){const k=L.track;L.track.trackList.forEach((L=>{k.removeAudioTrack(L)}))}L.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=dO.Disconnected}getStats(){var L;return null===(L=this.connection)||void 0===L?void 0:L.getStats()}getRemoteVideoIsReady(L){var k;return(null===(k=this.connection)||void 0===k?void 0:k.getRemoteVideoIsReady(L))||!1}getLocalAudioVolume(){const L=this.localTrackMap.get(cO.LocalAudioTrack);if(L)return L.track.getVolumeLevel()}getLocalVideoSize(){const L=this.localTrackMap.get(cO.LocalVideoTrack);if(L)return{width:L.track.videoWidth||0,height:L.track.videoHeight||0}}getEncoderConfig(L){const k=this.localTrackMap.get(L);return k&&k.track instanceof eU||k&&k.track instanceof uM?k.track._encoderConfig:void 0}getLocalMedia(L){return this.localTrackMap.get(L)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(L,k){if(!L)return this.remoteUserMap.size>0;const M=this.remoteUserMap.get(L);return!!M&&(!k||M.has(k))}async hasRemoteMediaWithLock(L,k){if(!L)return this.remoteUserMap.size>0;const M=this.remoteUserMap.get(L);return!!M&&(!k||M.has(k))}getRemoteMedia(L){var k;const M=Array.from(w_(k=this.remoteUserMap).call(k)).find((k=>k.uid===L));return M?{audioTrack:M.audioTrack,audioSSRC:M._audioSSRC,videoTrack:M.videoTrack,videoSSRC:M._videoSSRC}:{}}getAudioLevels(){let L=Array.from(this.remoteUserMap.entries()).map((L=>{let[k]=L;return{uid:k.uid,level:k.audioTrack?100*k.audioTrack._source.getAccurateVolumeLevel():0}}));const k=this.localTrackMap.get(cO.LocalAudioTrack);return k&&L.push({level:100*k.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),L=gE(L).call(L,((L,k)=>L.level-k.level)),L}async disconnectForReconnect(){this.connection&&(Eb.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=dO.Reconnecting,zA("KEEP_LAST_FRAME")&&0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((L=>{let[k]=L;var M;k._videoTrack&&k._videoTrack._player&&(null===(M=k._videoTrack._player.getVideoElement())||void 0===M||M.pause(),k._videoTrack._player.isKeepLastFrame=!0,k._videoTrack._originMediaStreamTrack.stop())})),this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=this.isPlanB?new fF({},this.store):new CF({},this.store),this.bindConnectionEvents(this.connection)),0!==this.localTrackMap.size&&(Array.from(this.localTrackMap.entries()).forEach((L=>{var k;let[M,{track:U}]=L;switch(M){case cO.LocalVideoTrack:Sr(k=U._hints).call(k,sL.LOW_STREAM)?U.close():this.pendingLocalTracks.push(U);break;case cO.LocalAudioTrack:U instanceof SM?this.pendingLocalTracks=this.pendingLocalTracks.concat(U.trackList):this.pendingLocalTracks.push(U);case cO.LocalVideoLowTrack:}})),this.emit(lO.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((L=>{let[k,M]=L;Array.from(w_(M).call(M)).forEach((L=>{this.setPendingRemoteMedia(k,L)})),this.emit(lO.MediaReconnectStart,k.uid)})),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),0!==this.localDataChannels.length&&(this.localDataChannels.forEach((L=>{this.pendingLocalDataChannels.push(L)})),this.localDataChannels.length=0),0!==this.remoteDataChannelMap.size&&(Array.from(this.remoteDataChannelMap.entries()).forEach((L=>{let[k,M]=L;Array.from(w_(M).call(M)).forEach((L=>{this.setPendingRemoteDataChannel(k,L)}))})),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),Eb.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(L,k){for(const M of this.pendingRemoteDataChannels){const{user:U,id:x}=M;if((L instanceof sF?L.uid:L)===U.uid&&x===k)return!0}return!1}setPendingRemoteDataChannel(L,k){this.hasPendingRemoteDataChannel(L,k)||this.pendingRemoteDataChannels.push({user:L,id:k})}hasPendingRemoteMedia(L,k){for(const M of this.pendingRemoteTracks){const{user:U,kind:x}=M;if((L instanceof sF?L.uid:L)===U.uid&&k===x)return!0}return!1}setPendingRemoteMedia(L,k){this.hasPendingRemoteMedia(L,k)||this.pendingRemoteTracks.push({user:L,kind:k})}restartICE(L){var k=this;return HI((function*(){if(!k.connection||k.state!==dO.Connected)return;const M=yield KI(k.mutex.lock("From P2PChannel.restartICE"));let U;try{U=yield KI(k.connection.restartICE(L));const x=yield KI(U.next());if(x.done)return;const V=x.value,F=yield V;switch(k.reportPCDisconnectedOrFailed(L),L){case rO.TCP:k._pcStatsUploadType=aO.TCP_RESTART;break;case rO.RELAY:k._pcStatsUploadType=aO.RELAY_RESTART;break;default:k._pcStatsUploadType=aO.OLD_RESTART}k._isInRestartIce=!0,U.next(F)}catch(L){var x;null===(x=U)||void 0===x||x.throw(L)}finally{M()}}))()}getUplinkNetworkQuality(){if(!this.connection)return 0;const L=this.connection.getStats(),k=this.localTrackMap.get(cO.LocalVideoTrack),M=this.localTrackMap.get(cO.LocalAudioTrack),U=L.videoSend.find((L=>L.ssrc===(null==k?void 0:k.ssrcs[0].ssrcId))),x=L.audioSend.find((L=>L.ssrc===(null==M?void 0:M.ssrcs[0].ssrcId)));if(!U||!x)return 1;const V=Zy(this,lO.NeedSignalRTT),F=U?U.rttMs:void 0,j=x?x.rttMs:void 0,z=F&&j?(F+j)/2:F||j,Q=(z&&V?(z+V)/2:z||V)||0,$=100*L.sendPacketLossRate*.7/50+.3*Q/1500,ee=$<.17?1:$<.36?2:$<.59?3:$<.1?4:5,te=null==k?void 0:k.track;if(te&&te._encoderConfig&&-1===te._hints.indexOf(sL.SCREEN_TRACK)){const k=te._encoderConfig.bitrateMax,M=L.bitrate.actualEncoded;if(k&&M){const L=(1e3*k-M)/(1e3*k);return vb[L<.15?0:L<.3?1:L<.45?2:L<.6?3:4][ee]}}return ee}getDownlinkNetworkQuality(){if(!this.connection)return 0;const L=this.connection.getStats();let k=0;return Array.from(this.remoteUserMap.entries()).forEach((M=>{let[U]=M;const x=U._audioSSRC,V=U._videoSSRC,F=L.audioRecv.find((L=>L.ssrc===x)),j=L.videoRecv.find((L=>L.ssrc===V));if(!F&&!j)return void(k+=1);const z=Zy(this,lO.NeedSignalRTT),Q=L.rtt,$=(Q&&z?(Q+z)/2:Q||z)||0,ee=F?F.jitterMs:void 0,te=L.recvPacketLossRate;let ie=.7*te*100/50+.3*$/1500;ee&&(ie=.6*te*100/50+.2*$/1500+.2*ee/400),k+=ie<.1?1:ie<.17?2:ie<.36?3:ie<.59?4:5})),this.remoteUserMap.size>0?Math.round(k/this.remoteUserMap.size):k}async muteLocalTrack(L){return new Mp(((k,M)=>{this.handleMuteLocalTrack(L,k,M)}))}async replaceTrack(L,k){var M;if(Eb.debug("[".concat(this.store.clientId,"] P2PChannel replaceTrack from [").concat(L.getTrackId(),"] to [").concat(k.getTrackId(),"]")),!this.connection||this.state!==dO.Connected)return;const U=Array.from(this.localTrackMap.entries()).find((k=>{let[,{track:M}]=k;return L===M}));if(!U)return;const x=U[0];if(L!==k&&(this.unbindLocalTrackEvents([{track:L,type:x}]),this.bindLocalTrackEvents([{track:k,type:x}]),U[1].track=k),await(null===(M=this.connection)||void 0===M?void 0:M.replaceTrack(k,U[1].id)),this.isPlanB){const L=U[1];L.id=k._mediaStreamTrack.id,this.localTrackMap.set(x,L)}if(x===cO.LocalVideoTrack&&!zA("DISABLE_DUAL_STREAM_USE_ENCODING")&&XP().supportDualStreamEncoding){const k=this.localTrackMap.get(cO.LocalVideoLowTrack);if(k){const M=L._mediaStreamTrack.clone();k.track._originMediaStreamTrack.stop(),k.track._mediaStreamTrack=M,k.track._originMediaStreamTrack=M,await new Mp(((L,M)=>{this.handleReplaceTrack(k.track,L,M,!0)}))}}}filterTobePublishedTracks(L,k,M){const U=[],x=this.getAllTracks();L=iA(L=L.filter((L=>-1===x.indexOf(L))));let V,F=!1;const j=this.localTrackMap.get(cO.LocalAudioTrack);for(const x of L){if(x instanceof eU&&(this.localTrackMap.has(cO.LocalVideoTrack)||F?new nv(iv.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(U.push({track:x,type:cO.LocalVideoTrack}),F=!0),k)){const L=this.getLowVideoTrack(x,M);U.push({track:L,type:cO.LocalVideoLowTrack})}if(x instanceof uM)if(j){const L=j.track;if(L instanceof SM)dF([x]),L.addAudioTrack(x),this.bindLocalAudioTrackEvents(x,!0);else{const k=lF([L,x]);Eb.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(k.getTrackId(),"]")),this.replaceTrack(L,k)}}else V instanceof SM?(dF([x]),V.addAudioTrack(x)):V=V||!x._useAudioElement&&XP().webAudioMediaStreamDest&&!x._bypassWebAudio?lF(V?[x,V]:[x]):x}return V&&(Eb.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will send audioTrack [").concat(V.getTrackId(),"]")),U.push({track:V,type:cO.LocalAudioTrack})),U}filterTobeUnpublishedTracks(L){const k=[],M=this.getAllTracks();L=iA(L=L.filter((L=>-1!==M.indexOf(L))));for(const M of L){if(M instanceof uM){const L=this.localTrackMap.get(cO.LocalAudioTrack);if(!L)continue;L.track instanceof SM?(L.track.removeAudioTrack(M),this.unbindLocalAudioTrackEvents(M),0===L.track.trackList.length&&(k.push([cO.LocalAudioTrack,L]),L.track.close())):k.push([cO.LocalAudioTrack,L])}if(M instanceof eU){const L=this.localTrackMap.get(cO.LocalVideoTrack);if(!L)continue;k.push([cO.LocalVideoTrack,L]);const M=this.localTrackMap.get(cO.LocalVideoLowTrack);M&&k.push([cO.LocalVideoLowTrack,M])}}return k}filterTobePublishedDataChannels(L){return(L=iA(L)).filter((L=>-1===this.localDataChannels.findIndex((k=>k.id===L.id))))}filterTobeUnpublishedDataChannels(L){return(L=(L=iA(L)).filter((L=>-1!==this.localDataChannels.indexOf(L)))).filter((L=>L._originDataChannel))}bindLocalTrackEvents(L){L.forEach((L=>{let{track:k,type:M}=L;switch(M){case cO.LocalVideoTrack:k.addListener(oL.GET_STATS,this.handleGetLocalVideoStats),k.addListener(oL.GET_RTC_STATS,this.handleGetRTCStats),k.addListener(oL.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),k.addListener(oL.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),k.addListener(oL.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),k.addListener(oL.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),k.addListener(oL.NEED_REPLACE_TRACK,this.handleReplaceTrack),k.addListener(oL.NEED_MUTE_TRACK,this.handleMuteLocalTrack),k.addListener(oL.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case cO.LocalAudioTrack:this.bindLocalAudioTrackEvents(k);case cO.LocalVideoLowTrack:}}))}bindLocalAudioTrackEvents(L,k){L instanceof SM?L.trackList.forEach((L=>{L.addListener(oL.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),L.addListener(oL.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),L.addListener(oL.GET_STATS,this.handleGetLocalAudioStats),L.addListener(oL.NEED_MUTE_TRACK,this.handleMuteLocalTrack),L.addListener(oL.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(L.addListener(oL.GET_STATS,this.handleGetLocalAudioStats),L.addListener(oL.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),L.addListener(oL.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),L.addListener(oL.NEED_MUTE_TRACK,this.handleMuteLocalTrack),L.addListener(oL.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),k||(L.addListener(oL.NEED_REPLACE_TRACK,this.handleReplaceTrack),L.addListener(oL.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack)))}unbindLocalTrackEvents(L){L||(L=Array.from(this.localTrackMap.entries()).map((L=>{let[k,{track:M}]=L;return{track:M,type:k}}))),L.forEach((L=>{let{track:k,type:M}=L;switch(M){case cO.LocalVideoTrack:k.off(oL.GET_STATS,this.handleGetLocalVideoStats),k.off(oL.GET_RTC_STATS,this.handleGetRTCStats),k.off(oL.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),k.off(oL.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),k.off(oL.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),k.off(oL.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),k.off(oL.NEED_REPLACE_TRACK,this.handleReplaceTrack),k.off(oL.NEED_MUTE_TRACK,this.handleMuteLocalTrack),k.off(oL.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case cO.LocalAudioTrack:this.unbindLocalAudioTrackEvents(k);case cO.LocalVideoLowTrack:}}))}unbindLocalAudioTrackEvents(L){L instanceof SM?L.trackList.forEach((L=>{L.off(oL.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),L.off(oL.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),L.off(oL.GET_STATS,this.handleGetLocalAudioStats),L.off(oL.NEED_MUTE_TRACK,this.handleMuteLocalTrack),L.off(oL.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(L.off(oL.GET_STATS,this.handleGetLocalAudioStats),L.off(oL.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),L.off(oL.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),L.off(oL.NEED_REPLACE_TRACK,this.handleReplaceTrack),L.off(oL.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack),L.off(oL.NEED_MUTE_TRACK,this.handleMuteLocalTrack),L.off(oL.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(L,k){k instanceof EU&&k.addListener(oL.GET_STATS,(k=>{k(this.handleGetRemoteVideoStats(L))})),k instanceof fU&&k.addListener(oL.GET_STATS,(k=>{k(this.handleGetRemoteAudioStats(L))}))}unbindRemoteTrackEvents(L){L&&L.removeAllListeners(oL.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach((L=>{let[k,M]=L;M.has(nO.AUDIO)&&this.unbindRemoteTrackEvents(k._audioTrack),M.has(nO.VIDEO)&&this.unbindRemoteTrackEvents(k._videoTrack)}))}createGatewayPublishMessage(L,k){return L.map(((L,M)=>{var U;let x,V,{track:F,type:j}=L;switch(j){case cO.LocalAudioTrack:x=qw.Audio,V={dtx:F instanceof hM&&F._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case cO.LocalVideoTrack:x=Sr(U=F._hints).call(U,sL.SCREEN_TRACK)?qw.Screen:qw.High,V=uB(uB({},XO(F)),{},{codec:this.store.codec,svc_mode:VU()});break;case cO.LocalVideoLowTrack:x=qw.Low,V=uB(uB({},XO(F)),{},{codec:this.store.codec,svc_mode:VU()})}return{stream_type:x,attributes:V,ssrcs:k[M]}}))}createGatewayUnpublishMessage(L){return L.map((L=>{var k;let M,[U,{track:x,ssrcs:V,id:F}]=L;switch(U){case cO.LocalVideoTrack:M=Sr(k=x._hints).call(k,sL.SCREEN_TRACK)?qw.Screen:qw.High;break;case cO.LocalAudioTrack:M=qw.Audio;break;case cO.LocalVideoLowTrack:M=qw.Low}return{stream_type:M,ssrcs:V,mid:F}}))}assignLocalTracks(L,k){L.forEach(((L,M)=>{let{track:U,type:x}=L;this.localTrackMap.set(x,{track:U,id:k[M].id,ssrcs:k[M].localSSRC})}))}withdrawLocalTracks(L){L.forEach((L=>{let[k]=L;this.localTrackMap.delete(k)}))}bindConnectionEvents(L){L.onConnectionStateChange=async k=>{if(Eb.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(k,")")),this.emit(lO.PeerConnectionStateChange,k),"connected"!==k||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),"connected"===k&&(this._restartTimer&&(clearTimeout(this._restartTimer),this._restartTimer=void 0),(this._isFirstConnected||this._isInRestartIce)&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isInRestartIce=!1,this._isFirstConnected=!1,this._isStartRestartIce=!1),zA("NEW_ICE_RESTART")){var M;if(Sr(M=this._restartStates).call(M,k)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;const t=k=>{"disconnected"!==L.iceConnectionState&&"checking"!==L.iceConnectionState&&"failed"!==L.iceConnectionState||(Eb.debug("[".concat(this.store.clientId,"] [P2PChannel] start use restartICE, type is ").concat(k)),"CONNECTED"===Zy(this,lO.QueryClientConnectionState)&&this.emit(lO.RequestRestartICE,k))},i=()=>{"disconnected"!==L.iceConnectionState&&"checking"!==L.iceConnectionState&&"failed"!==L.iceConnectionState||(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),Eb.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout((()=>this.emit(lO.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())},k=zA("ICE_RESTART_INTERVAL");return void(this._restartTimer=window.setTimeout((()=>{if(zA("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&XP().supportPCSetConfiguration)t(rO.RELAY),this._restartTimer=window.setTimeout(i,k);else if(Xv())t(rO.UDP),this._restartTimer=window.setTimeout(i,4e3);else{if(t(rO.TCP),XP().supportPCSetConfiguration)return void(this._restartTimer=window.setTimeout((()=>{t(rO.RELAY),this._restartTimer=window.setTimeout(i,k)}),k));this._restartTimer=window.setTimeout(i,k)}}),800))}}else{if("disconnected"===k&&"disconnected"===L.iceConnectionState)return setTimeout((()=>{"disconnected"===L.iceConnectionState&&zA("ICE_RESTART")&&"CONNECTED"===Zy(this,lO.QueryClientConnectionState)&&this.emit(lO.RequestRestartICE)}),800),void setTimeout((()=>{"disconnected"===L.peerConnectionState&&(Eb.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isInRestartIce=!1,setTimeout((()=>this.emit(lO.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())}),4e3);"failed"===k&&(Eb.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCDisconnectedOrFailed(),setTimeout((()=>this.emit(lO.P2PLost)),0),this.iceFailedCount+=1,await this.requestReconnect())}},L.onICEConnectionStateChange=L=>{"connected"!==L||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),Eb.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(L,")")),Ab.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:L,tag:lv.TRACER}).onSuccess(),this.emit(lO.IceConnectionStateChange,L)},L.onICETransportStateChange=L=>{Eb.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(L,")"))},L.onDTLSTransportStateChange=L=>{Eb.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(L,")"))},L.onDTLSTransportError=L=>{Eb.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(L,")"))},L.onFirstAudioDecoded=L=>{var k;const M=Array.from(w_(k=this.remoteUserMap).call(k)).find((k=>k._audioSSRC===L));var U;M&&(this.store.subscribe(M.uid,"audio",void 0,void 0,void 0,Date.now()),null===(U=M.audioTrack)||void 0===U||U.emit(mL.FIRST_FRAME_DECODED),Ab.firstRemoteFrame(this.store.sessionId,Tb.FIRST_AUDIO_DECODE,Sb.FIRST_AUDIO_DECODE,{peer:M._uintid,subscribeElapse:Cx.measureFromSubscribeStart(this.store.clientId,L),subscribeRequestid:L,p2pid:this.store.p2pId}))},L.onFirstAudioReceived=L=>{var k;const M=Array.from(w_(k=this.remoteUserMap).call(k)).find((k=>k._audioSSRC===L));M&&Ab.firstRemoteFrame(this.store.sessionId,Tb.FIRST_AUDIO_RECEIVED,Sb.FIRST_AUDIO_RECEIVED,{peer:M._uintid,subscribeElapse:Cx.measureFromSubscribeStart(this.store.clientId,L),subscribeRequestid:L,p2pid:this.store.p2pId})},L.onFirstVideoDecoded=(L,k,M)=>{this.reportVideoFirstFrameDecoded(L,k,M)},L.onFirstVideoReceived=L=>{var k;const M=Array.from(w_(k=this.remoteUserMap).call(k)).find((k=>k._videoSSRC===L));M&&Ab.firstRemoteFrame(this.store.sessionId,Tb.FIRST_VIDEO_RECEIVED,Sb.FIRST_VIDEO_RECEIVED,{peer:M._uintid,subscribeElapse:Cx.measureFromSubscribeStart(this.store.clientId,L),subscribeRequestid:L,p2pid:this.store.p2pId})},L.onSelectedLocalCandidateChanged=(L,k)=>{const M="relay"===L.candidateType,U="relay"===k.candidateType;"unknown"!==k.candidateType&&M===U||this.emit(lO.ConnectionTypeChange,M),Eb.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(tN(k))," -> ").concat(JSON.stringify(tN(L)),")"))},L.onSelectedRemoteCandidateChanged=(L,k)=>{Eb.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(tN(k))," -> ").concat(JSON.stringify(tN(L)),")"))},L.onFirstVideoDecodedTimeout=L=>{this.reportVideoFirstFrameDecoded(L,void 0,void 0,!0)},L.getLocalVideoStats=()=>{const L=this.statsCollector.getLocalVideoTrackStats(),k=this.statsCollector.getRTCStats();return uB(uB({},L),k)}}unbindConnectionEvents(L){L.onConnectionStateChange=void 0,L.onICEConnectionStateChange=void 0,L.onICETransportStateChange=void 0,L.onDTLSTransportStateChange=void 0,L.onDTLSTransportError=void 0,L.onFirstAudioDecoded=void 0,L.onFirstAudioReceived=void 0,L.onFirstVideoDecoded=void 0,L.onFirstVideoReceived=void 0,L.onSelectedLocalCandidateChanged=void 0,L.onSelectedRemoteCandidateChanged=void 0,L.onFirstVideoDecodedTimeout=void 0,L.getLocalVideoStats=void 0}filterTobeMutedTracks(L){const k=[];if(-1===this.getAllTracks().indexOf(L))return k;const M=this.localTrackMap.get(cO.LocalAudioTrack);if(L instanceof uM&&(null==M?void 0:M.track)instanceof SM)return M.track.isActive||k.push([cO.LocalAudioTrack,M]),k;const U=Array.from(this.localTrackMap.entries()).find((k=>{let[,{track:M}]=k;return L===M}));if(U&&(k.push(U),U[0]===cO.LocalVideoTrack)){const L=this.localTrackMap.get(cO.LocalVideoLowTrack);L&&k.push([cO.LocalVideoLowTrack,L])}return k}filterTobeUnmutedTracks(L){const k=[],M=this.localTrackMap.get(cO.LocalAudioTrack);if(L instanceof uM&&(null==M?void 0:M.track)instanceof SM)return M.track.isActive&&k.push([cO.LocalAudioTrack,M]),k;const U=Array.from(this.localTrackMap.entries()).find((k=>{let[,{track:M}]=k;return L===M}));if(U)if(U[0]===cO.LocalVideoTrack){k.push(U);const L=this.localTrackMap.get(cO.LocalVideoLowTrack);L&&k.push([cO.LocalVideoLowTrack,L])}else k.push(U);return k}createMuteMessage(L){return L.map((L=>{var k;let M,[U,{track:x,ssrcs:V,id:F}]=L;switch(U){case cO.LocalAudioTrack:M=qw.Audio;break;case cO.LocalVideoTrack:M=Sr(k=x._hints).call(k,sL.SCREEN_TRACK)?qw.Screen:qw.High;break;case cO.LocalVideoLowTrack:M=qw.Low}return{stream_type:M,ssrcs:V,mid:F}}))}createUnmuteMessage(L){return L.map((L=>{var k;let M,[U,{track:x,ssrcs:V,id:F}]=L;switch(U){case cO.LocalAudioTrack:M=qw.Audio;break;case cO.LocalVideoTrack:M=Sr(k=x._hints).call(k,sL.SCREEN_TRACK)?qw.Screen:qw.High;break;case cO.LocalVideoLowTrack:M=qw.Low}return{stream_type:M,ssrcs:V,mid:F}}))}filterTobeUnSubscribedTracks(L,k){const M=[],U=this.remoteUserMap.get(L);if(!U)return M;if(k){const x=U.get(k);if(!x)return M;M.push([L,{kind:k,id:x}])}else Array.from(U.entries()).forEach((k=>{let[U,x]=k;M.push([L,{kind:U,id:x}])}));return M}filterTobeUnSubscribedDataChannels(L,k){const M=[];return k.forEach((k=>{var U;null!==(U=this.remoteDataChannelMap.get(L))&&void 0!==U&&U.has(k.id)&&M.push(k)})),M}createUnsubscribeMessage(L){const k=[];return L.forEach((L=>{let[M,{kind:U,id:x}]=L;switch(U){case nO.VIDEO:return void(M._videoSSRC&&k.push({stream_type:nO.VIDEO,ssrcId:M._videoSSRC}));case nO.AUDIO:return void(M._audioSSRC&&k.push({stream_type:nO.AUDIO,ssrcId:M._audioSSRC}))}})),k}createUnsubscribeAllMessage(L){const k=new Map;return L.forEach((L=>{let[M,{kind:U}]=L;if(k.has(M)){let L=k.get(M);U===nO.VIDEO?L|=Qw.Video:L|=Qw.Audio,k.set(M,L)}else U===nO.VIDEO?k.set(M,Qw.Video):k.set(M,Qw.Audio)})),{users:Array.from(k.entries()).map((L=>{let[k,M]=L;return{stream_id:k.uid,stream_type:M}}))}}withdrawRemoteTracks(L){L.forEach((L=>{let[k,{kind:M}]=L;const U=this.remoteUserMap.get(k);U&&(U.delete(M),0===Array.from(U.entries()).length&&this.remoteUserMap.delete(k))}))}async updateBitrateLimit(L){const k=this.localTrackMap.get(cO.LocalVideoTrack),M=this.localTrackMap.get(cO.LocalVideoLowTrack);k&&await k.track.setBitrateLimit(L.uplink),M&&L.low_stream_uplink&&await M.track.setBitrateLimit({max_bitrate:L.low_stream_uplink.bitrate,min_bitrate:L.low_stream_uplink.bitrate||0})}isP2PDisconnected(){return!this.connection||"connected"!==this.connection.peerConnectionState}mapPubResToRemoteConfig(L,k,M){return L.map(((L,U)=>{var x;let{stream_type:V}=L;const F=null===(x=k.find((L=>{let{stream_type:k}=L;return V===k})))||void 0===x?void 0:x.attributes;if(F&&zA("DISABLE_SCREEN_SHARE_REMB")){const L=M[U]._hints;(Sr(L).call(L,sL.SCREEN_TRACK)||Sr(L).call(L,sL.SCREEN_LOW_TRACK))&&(F.remb=!1,Eb.debug("disable remb for screen share, hints:",L))}return F}))}async tryToUnmuteAudio(L){for(let M=0;M<L.length;M++)if(L[M]instanceof uM){var k;const U=this.filterTobeUnmutedTracks(L[M]);if(0===U.length)continue;await(null===(k=this.connection)||void 0===k?void 0:k.unmuteLocal(U.map((L=>{let[,{id:k}]=L;return k}))));const x=this.createUnmuteMessage(U);return void await Qy(this,lO.RequestUnmuteLocal,x)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=L=>{var k;return!(null===(k=this.connection)||void 0===k||!k.getRemoteVideoIsReady(L))},this.statsUploader.requestUpload=(L,k)=>this.emit(lO.RequestUpload,L,k),this.statsUploader.requestUploadStats=L=>this.emit(lO.RequestUploadStats,L),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await EA(DA(this.dtlsFailedCount,Ov)),this.emit(lO.RequestReconnect)}async reconnectP2P(){const L=Array.from(this.localTrackMap.entries()),k=this.createGatewayUnpublishMessage(L);Array.from(this.remoteUserMap.entries()),k.length>0&&await Xy(this,lO.RequestUnpublishForReconnectPC,k),this.disconnectForReconnect(),this.emit(lO.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(cO.LocalVideoTrack)||this.pendingLocalTracks.some((L=>L instanceof eU))}throwIfTrackTypeNotMatch(L){if(L.filter((L=>L instanceof eU)).length>1)throw new nv(iv.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(L.filter((L=>L instanceof uM)).length>1&&(L.some((L=>L instanceof uM&&L._bypassWebAudio))||!XP().webAudioMediaStreamDest))throw new nv(iv.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const k of L){if(k instanceof eU&&this.pendingLocalTracks.some((L=>L instanceof eU)))throw new nv(iv.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(k instanceof uM&&this.pendingLocalTracks.some((L=>L instanceof uM))&&(!XP().webAudioMediaStreamDest||k._bypassWebAudio||this.pendingLocalTracks.some((L=>L instanceof uM&&L._bypassWebAudio))))throw new nv(iv.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(L,k){var M;const U=!zA("DISABLE_DUAL_STREAM_USE_ENCODING")&&XP().supportDualStreamEncoding,x=uB(uB({},{width:160,height:120,framerate:15,bitrate:50}),k);let V;V=U?L._mediaStreamTrack.clone():WV(L,x);const F=fA(8,"track-low-"),j=new eU(V,uB(uB({},U&&{scaleResolutionDownBy:eN(x,L)}),{},{frameRate:x.framerate,bitrateMax:x.bitrate,bitrateMin:x.bitrate}),void 0,void 0,F);return j.on(EL.TRANSCEIVER_UPDATED,(k=>{L._updateRtpTransceiver(k,lL.LOW_STREAM)})),j._hints.push(sL.LOW_STREAM),Sr(M=L._hints).call(M,sL.SCREEN_TRACK)&&j._hints.push(sL.SCREEN_LOW_TRACK),L.on("sei-to-send",(L=>{j.emit("sei-to-send",L)})),L.addListener(oL.NEED_CLOSE,(()=>{j.close()})),j}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(L,k,M){let U=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(this.connection&&this.connection instanceof CF){var x,V,F,j;const z=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:Q,dtlsTransportState:$,peerConnectionState:ee}=this.connection,{local:te,remote:ie}=await this.connection.getSelectedCandidatePair();Ab.pcStats(this.store.sessionId,{startTime:z,eventElapse:L-z||0,iceconnectionsate:Q,dtlsstate:$,connectionstate:ee,intSucc:k?1:2,error:U,selectedLocalCandidateProtocol:null!==(x=null==te?void 0:te.protocol)&&void 0!==x?x:"",selectedLocalCandidateType:null!==(V=te.candidateType)&&void 0!==V?V:"",selectedLocalCandidateAddress:"".concat(te.address,":").concat(te.port),selectedRemoteCandidateProtocol:null!==(F=ie.protocol)&&void 0!==F?F:"",selectedRemoteCandidateType:null!==(j=ie.candidateType)&&void 0!==j?j:"",selectedRemoteCandidateAddress:"".concat(ie.address,":").concat(ie.port),restartCnt:M,preallocation:this.connection.isPreallocation})}}reportVideoFirstFrameDecoded(L,k,M,U){var x;const V=Array.from(w_(x=this.remoteUserMap).call(x)).find((k=>k._videoSSRC===L));if(V){U||this.store.subscribe(V.uid,"video",void 0,void 0,void 0,void 0,Date.now());const x=this.store.keyMetrics,F=x.subscribe.find((L=>L.userId===V.uid&&"video"===L.type));Ab.firstRemoteVideoDecode(this.store.sessionId,Tb.FIRST_VIDEO_DECODE,Sb.FIRST_VIDEO_DECODE,{peer:V._uintid,videowidth:k,videoheight:M,subscribeElapse:Cx.measureFromSubscribeStart(this.store.clientId,L),subscribeRequestid:L,p2pid:this.store.p2pId,apEnd:x.requestAPEnd||0,apStart:x.requestAPStart||0,joinGwEnd:x.joinGatewayEnd||0,joinGwStart:x.joinGatewayStart||0,pcEnd:x.peerConnectionEnd||0,pcStart:x.peerConnectionStart||0,subscriberEnd:(null==F?void 0:F.subscribeEnd)||0,subscriberStart:(null==F?void 0:F.subscribeStart)||0,videoAddNotify:(null==F?void 0:F.streamAdded)||0,state:U?1:0,firstFrame:(null==F?void 0:F.firstFrame)||0})}}async remoteMediaSsrcChanged(L,k,M){if(!this.connection)return!1;const U=this.remoteUserMap.get(L);if(!U)return!1;const x=U.get(k);if(!x)return!1;const V=await this.connection.getRemoteSSRC(x);return void 0!==V&&V!==M}unbindRtpTransceiver(){0!==this.localTrackMap.size&&Array.from(this.localTrackMap.entries()).forEach((L=>{let[k,{track:M}]=L;k===cO.LocalVideoLowTrack?M._updateRtpTransceiver(void 0,lL.LOW_STREAM):M._updateRtpTransceiver(void 0)}))}reportPCDisconnectedOrFailed(L){this.connection&&this.connection instanceof CF&&("disconnected"!==this.connection.iceConnectionState&&"checking"!==this.connection.iceConnectionState&&"failed"!==this.connection.iceConnectionState||(this._isFirstConnected?(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isFirstConnected=!1):this._pcStatsUploadType===aO.TCP_RESTART&&L===rO.RELAY?this.reportPCStats(Date.now(),!1,this._pcStatsUploadType):this.reportPCStats(Date.now(),!1,aO.DISCONNECTED_OR_FAILED)))}},gw(kF.prototype,"startP2PConnection",[EB],Object.getOwnPropertyDescriptor(kF.prototype,"startP2PConnection"),kF.prototype),gw(kF.prototype,"connect",[EB],Object.getOwnPropertyDescriptor(kF.prototype,"connect"),kF.prototype),gw(kF.prototype,"updateRemoteRTPCapabilities",[EB],Object.getOwnPropertyDescriptor(kF.prototype,"updateRemoteRTPCapabilities"),kF.prototype),gw(kF.prototype,"publishDataChannel",[EB],Object.getOwnPropertyDescriptor(kF.prototype,"publishDataChannel"),kF.prototype),gw(kF.prototype,"unpublish",[EB],Object.getOwnPropertyDescriptor(kF.prototype,"unpublish"),kF.prototype),gw(kF.prototype,"unpublishDataChannel",[EB],Object.getOwnPropertyDescriptor(kF.prototype,"unpublishDataChannel"),kF.prototype),gw(kF.prototype,"unpublishLowStream",[EB],Object.getOwnPropertyDescriptor(kF.prototype,"unpublishLowStream"),kF.prototype),gw(kF.prototype,"subscribeDataChannel",[EB],Object.getOwnPropertyDescriptor(kF.prototype,"subscribeDataChannel"),kF.prototype),gw(kF.prototype,"subscribe",[EB],Object.getOwnPropertyDescriptor(kF.prototype,"subscribe"),kF.prototype),gw(kF.prototype,"massSubscribe",[EB],Object.getOwnPropertyDescriptor(kF.prototype,"massSubscribe"),kF.prototype),gw(kF.prototype,"unsubscribe",[EB],Object.getOwnPropertyDescriptor(kF.prototype,"unsubscribe"),kF.prototype),gw(kF.prototype,"unsubscribeDataChannel",[EB],Object.getOwnPropertyDescriptor(kF.prototype,"unsubscribeDataChannel"),kF.prototype),gw(kF.prototype,"massUnsubscribe",[EB],Object.getOwnPropertyDescriptor(kF.prototype,"massUnsubscribe"),kF.prototype),gw(kF.prototype,"muteRemote",[EB],Object.getOwnPropertyDescriptor(kF.prototype,"muteRemote"),kF.prototype),gw(kF.prototype,"unmuteRemote",[EB],Object.getOwnPropertyDescriptor(kF.prototype,"unmuteRemote"),kF.prototype),gw(kF.prototype,"hasRemoteMediaWithLock",[EB],Object.getOwnPropertyDescriptor(kF.prototype,"hasRemoteMediaWithLock"),kF.prototype),gw(kF.prototype,"disconnectForReconnect",[EB],Object.getOwnPropertyDescriptor(kF.prototype,"disconnectForReconnect"),kF.prototype),gw(kF.prototype,"updateBitrateLimit",[EB],Object.getOwnPropertyDescriptor(kF.prototype,"updateBitrateLimit"),kF.prototype),gw(kF.prototype,"remoteMediaSsrcChanged",[EB],Object.getOwnPropertyDescriptor(kF.prototype,"remoteMediaSsrcChanged"),kF.prototype),kF);function EB(L,k,M){const U=L[k];if("function"!=typeof U)throw new Error("Cannot use mutex on object property.");return M.value=async function(){const L=this.mutex,M=await L.lock("From P2PChannel.".concat(k));try{for(var x=arguments.length,V=new Array(x),F=0;F<x;F++)V[F]=arguments[F];return await U.apply(this,V)}finally{M()}},M}const jF={};function mB(L){(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&Eb.debug("install service ".concat(L.name)),jF[L.name]=L}function TB(L){const k=jF[L];if(!k)throw new nv(iv.INVALID_OPERATION,"".concat(L," not found, please use AgoraRTC.use(").concat(L,"Service) to load it first"));return k}function SB(L,k){return TB("DataStream").create(L,k)}function gB(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function RB(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?gB(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):gB(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}const GF=Date.now(),zF=new Map,YF=new Map;async function AB(L){const k=zF.get(L),M=Array.isArray(k)&&k[k.length-1],U=YF.get(L);if(!M)return void(U.isSyncing=!1);const x={uid:M.uid,payload:M.payload};0===U.firstRecvTs&&(U.firstRecvTs=M.recvTs,U.firstSendTs=M.sendTs);const V=M.sendTs-U.firstSendTs,F=V-(Date.now()-U.firstRecvTs);F>0&&(U.firstRecvTs=Date.now()-V);let j=M.mediaDelay+F;j<=0?(k.pop(),bB(M.context,x),j=0):j=Math.min(j,20),setTimeout((()=>k.length&&AB(L)),j)}function bB(L,k){L.safeEmit(pv.STREAM_MESSAGE,k.uid,k.payload),L.onStreamMessage&&L.onStreamMessage(k)}const qF=Gv().name;function NB(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function DB(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?NB(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):NB(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}const iB="websdk_ng_cache_parameter",rB=zA("MAX_PRELOAD_ASYNC_LENGTH"),aB=new Map,dB=[];let _B=null,fB=0,IB=0;const yB=new Map,CB=function(L,k){const M=[];let U=0;const r=async()=>{const L=M.shift();L&&await L(),M.length>0&&U<k?r():U--};return async function(){for(var x=arguments.length,V=new Array(x),F=0;F<x;F++)V[F]=arguments[F];return new Mp((async(x,F)=>{M.push((async()=>{try{const k=await L(...V);x(k)}catch(L){F(L)}})),U<k&&(U++,r())}))}}(WB,rB),vB=KC.CancelToken.source();async function WB(L,k,M,U,x,V){try{if(!zA("ENABLE_PRELOAD"))return;if(!XP().supportWebCrypto)return void aA((()=>{Eb.warn("Your browser does not support preloading, this feature  be run in a secure environment")}),"preload_webcrypto_not_supported");if(!M&&null!==M)throw new nv(iv.INVALID_PARAMS,"Invalid token: ".concat(M,". If you don not use token, set it to null"));M&&yy(M,"token",1,2047),yy(L,"appid",1,2047),Mw(k),U&&Uw(U);const F=mA();Eb.debug("preload channel ".concat(k,", uid is ").concat(U));const j={appId:L,cname:k,token:M||L,uid:"string"!=typeof U?U:null,sid:F,proxyServer:x};let z,Q;"string"==typeof U?(j.stringUid=U,[Q,z]=await Mp.all([Kx(U,{sid:F,appId:L},vB.token),qx(DB(DB({},j),{},{token:M||L,uid:0}),vB.token)]),j.uid=Q.uid,z.gatewayInfo.uid=j.uid,z.gatewayInfo.res.uid=j.uid):(V&&(j.stringUid=V),z=await qx(j,vB.token));const $={sid:F,appId:L,cname:k,token:M||L,uid:j.stringUid||U,intUid:j.uid||z.gatewayInfo.uid,stringUid:j.stringUid,ts:Date.now(),sua:Q,ap:z};await async function(L){let k;try{L.uid&&KB({appId:L.appId,cname:L.cname,token:L.token,uid:L.uid,stringUid:L.stringUid});const M=QB(L),U=await async function(L,k){try{const M=await window.crypto.subtle.importKey("raw",lA(k),"AES-GCM",!1,["encrypt"]),U=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:new Uint8Array(1)},M,cA(window.btoa(JSON.stringify(L))));return dA(new Uint8Array(U))}catch(L){return}}(L,L.token||L.appId);if(!U)return;k=JB(iB);const x=k?JSON.parse(k):[];x.push({[M]:U}),x.length>zA("AP_CACHE_NUM")&&x.shift(),XB(iB,JSON.stringify(x))}catch(L){Eb.warn("Error caching server parameters:",L.message),XB(iB,"")}}($),fB++}catch(L){throw IB++,function(L){_B||(_B=window.setTimeout((()=>{let k="";yB.forEach(((L,M)=>{k+="".concat(M,": ").concat(L," ;")})),Ab.reportApiInvoke(null,{name:dv.PRELOAD,options:{success:fB,failed:IB,err:k}}).onError(L),fB=0,IB=0,yB.clear(),_B=null}),1e4));const k=yB.get(L.code)||0;yB.set(L.code,k+1)}(L),L}}async function HB(L){try{if(zA("AP_REQUEST_DETAIL"))return;const k=KB(L);if(!k||"disabled"!==L.cloudProxyServer)return;const M=await async function(L,k){try{const M=await window.crypto.subtle.importKey("raw",lA(k),"AES-GCM",!1,["decrypt"]),U=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(1)},M,cA(L));return JSON.parse(window.atob(dA(new Uint8Array(U))))}catch(L){return}}(k,L.token||L.appId);if(!M)return;if(!function(L,k){return!(L.cname!==k.cname||L.appId!==k.appId||L.token!==k.token)&&(k.stringUid?L.stringUid===k.stringUid:"number"==typeof k.uid?L.uid===k.uid:L.uid==k.uid)}(M,L))return;if(M&&Date.now()-M.ts<zA("AP_CACHE_LIFETIME"))return M}catch(L){Eb.warn("Error get preloadInfo",L.message)}}function KB(L){let k;try{if(k=JB(iB),!k)return;const M=JSON.parse(k),U=QB(L),x=function(L,k){for(let M=L.length-1;M>=0;M--)if(k(L[M]))return M;return-1}(M,(L=>U in L));if(-1===x)return;const V=M.splice(x,1)[0];return XB(iB,JSON.stringify(M)),V[U]}catch(L){Eb.warn("Error delete preload info: ".concat(k),L.message),XB(iB,"")}}function YB(L){if(L){let k=aB.get(L);k&&(window.clearTimeout(k),k=null,aB.delete(L)),Sr(dB).call(dB,L)||"disabled"!==L.cloudProxyServer||dB.push(L)}if(aB.size<zA("AP_CACHE_NUM")&&dB.length>0){const L=dB.shift();aB.set(L,window.setTimeout((async()=>{const{appId:k,cname:M,token:U,stringUid:x,uid:V,proxyServer:F}=L;try{await CB(k,M,U,V,F,x),aB.has(L)&&YB(L)}catch(k){Eb.warn("update preload failed",k.message),qB(L)}}),zA("AP_UPDATE_INTERVAL")))}}function qB(L){const k=dB.indexOf(L);-1!==k&&dB.splice(k,1);let M=aB.get(L);M&&(window.clearTimeout(M),M=null,aB.delete(L),YB())}function zB(L,k){const M=L.sua,U=L.ap;k&&M&&Ab.reqUserAccount(L.sid,{lts:M.requestTime,elapse:M.elapse,success:!0,serverAddr:M.url,stringUid:k,uid:L.intUid,errorCode:null,extend:M.req}),Ab.reportResourceTiming(L.ap.url,L.sid),Ab.joinWebProxyAP(L.sid,{lts:U.requestTime,elapse:U.elapse,sucess:1,apServerAddr:U.url,turnServerAddrList:U.proxyInfo.addresses.map((L=>L.ip)).join(","),eventType:"disabled",unilbsServerIds:[UO.CHOOSE_SERVER,UO.CLOUD_PROXY_FALLBACK].toString()}),Ab.joinChooseServer(L.sid,{lts:U.requestTime,elapse:U.elapse,succ:!0,csAddr:U.url,opid:U.opid,serverList:U.gatewayInfo.gatewayAddrs.map((L=>L.address)),ec:null,cid:U.gatewayInfo.cid.toString(),uid:U.gatewayInfo.uid.toString(),csIp:U.gatewayInfo.csIp,unilbsServerIds:[UO.CHOOSE_SERVER].toString(),isHttp3:U.isHttp3})}function JB(L){return window.atob(window.localStorage.getItem(L)||"")}function XB(L,k){window.localStorage.setItem(L,window.btoa(k))}function QB(L){let k="".concat(L.appId,"_").concat(L.cname);return"string"==typeof L.uid&&(k+="_s_".concat(L.uid)),"number"==typeof L.uid&&(k+="_".concat(L.uid)),L.token&&(k+="_".concat(L.token)),yA(k)}function ej(L,k){switch(k){case 0:for(;128&lj(L););break;case 2:nj(L,hj(L));break;case 5:nj(L,4);break;case 1:nj(L,8);break;default:throw new Error("Unimplemented type: "+k)}}function tj(L){return{low:L|=0,high:L>>31,unsigned:L>=0}}let OB=[];function nj(L,k){if(L.offset+k>L.limit)throw new Error("Skip past limit");L.offset+=k}function rj(L){return L.offset>=L.limit}function oj(L,k){let M=L.bytes,U=L.offset,x=L.limit,V=U+k;if(V>M.length){let k=new Uint8Array(2*V);k.set(M),L.bytes=k}return L.offset=V,V>x&&(L.limit=V),U}function sj(L,k){let M=L.offset;if(M+k>L.limit)throw new Error("Read past limit");return L.offset+=k,M}function aj(L,k){let M=oj(L,k.length);L.bytes.set(k,M)}function cj(L,k){let M=sj(L,k),U=String.fromCharCode,x=L.bytes,V="ï¿½",F="";for(let L=0;L<k;L++){let j,z,Q,$,ee=x[L+M];0==(128&ee)?F+=U(ee):192==(224&ee)?L+1>=k?F+=V:(j=x[L+M+1],128!=(192&j)?F+=V:($=(31&ee)<<6|63&j,$<128?F+=V:(F+=U($),L++))):224==(240&ee)?L+2>=k?F+=V:(j=x[L+M+1],z=x[L+M+2],32896!=(49344&(j|z<<8))?F+=V:($=(15&ee)<<12|(63&j)<<6|63&z,$<2048||$>=55296&&$<=57343?F+=V:(F+=U($),L+=2))):240==(248&ee)?L+3>=k?F+=V:(j=x[L+M+1],z=x[L+M+2],Q=x[L+M+3],8421504!=(12632256&(j|z<<8|Q<<16))?F+=V:($=(7&ee)<<18|(63&j)<<12|(63&z)<<6|63&Q,$<65536||$>1114111?F+=V:($-=65536,F+=U(55296+($>>10),56320+(1023&$)),L+=3))):F+=V}return F}function dj(L,k){let M=k.length,U=0;for(let L=0;L<M;L++){let x=k.charCodeAt(L);x>=55296&&x<=56319&&L+1<M&&(x=(x<<10)+k.charCodeAt(++L)-56613888),U+=x<128?1:x<2048?2:x<65536?3:4}pj(L,U);let x=oj(L,U),V=L.bytes;for(let L=0;L<M;L++){let U=k.charCodeAt(L);U>=55296&&U<=56319&&L+1<M&&(U=(U<<10)+k.charCodeAt(++L)-56613888),U<128?V[x++]=U:(U<2048?V[x++]=U>>6&31|192:(U<65536?V[x++]=U>>12&15|224:(V[x++]=U>>18&7|240,V[x++]=U>>12&63|128),V[x++]=U>>6&63|128),V[x++]=63&U|128)}}function lj(L){return L.bytes[sj(L,1)]}function uj(L,k){let M=oj(L,1);L.bytes[M]=k}function hj(L){let k,M=0,U=0;do{k=lj(L),M<32&&(U|=(127&k)<<M),M+=7}while(128&k);return U}function pj(L,k){for(k>>>=0;k>=128;)uj(L,127&k|128),k>>>=7;uj(L,k)}function _j(L,k){let M,U=0,x=0,V=0;return M=lj(L),U=127&M,128&M&&(M=lj(L),U|=(127&M)<<7,128&M&&(M=lj(L),U|=(127&M)<<14,128&M&&(M=lj(L),U|=(127&M)<<21,128&M&&(M=lj(L),x=127&M,128&M&&(M=lj(L),x|=(127&M)<<7,128&M&&(M=lj(L),x|=(127&M)<<14,128&M&&(M=lj(L),x|=(127&M)<<21,128&M&&(M=lj(L),V=127&M,128&M&&(M=lj(L),V|=(127&M)<<7))))))))),{low:U|x<<28,high:x>>>4|V<<24,unsigned:k}}function Ej(L,k){let M=k.low>>>0,U=(k.low>>>28|k.high<<4)>>>0,x=k.high>>>24,V=0===x?0===U?M<16384?M<128?1:2:M<1<<21?3:4:U<16384?U<128?5:6:U<1<<21?7:8:x<128?9:10,F=oj(L,V),j=L.bytes;switch(V){case 10:j[F+9]=x>>>7&1;case 9:j[F+8]=9!==V?128|x:127&x;case 8:j[F+7]=8!==V?U>>>21|128:U>>>21&127;case 7:j[F+6]=7!==V?U>>>14|128:U>>>14&127;case 6:j[F+5]=6!==V?U>>>7|128:U>>>7&127;case 5:j[F+4]=5!==V?128|U:127&U;case 4:j[F+3]=4!==V?M>>>21|128:M>>>21&127;case 3:j[F+2]=3!==V?M>>>14|128:M>>>14&127;case 2:j[F+1]=2!==V?M>>>7|128:M>>>7&127;case 1:j[F]=1!==V?128|M:127&M}}const PB={},LB={},kB=4294967296,MB=kB*kB,UB=MB/2,xB=Aj(0,!0),VB=Aj(0),FB=bj(0,-2147483648,!1),BB=bj(-1,2147483647,!1),jB=bj(-1,-1,!0);function Aj(L,k){let M,U,x;return k?(x=0<=(L>>>=0)&&L<256)&&(U=LB[L],U)?U:(M=bj(L,0,!0),x&&(LB[L]=M),M):(x=-128<=(L|=0)&&L<128)&&(U=PB[L],U)?U:(M=bj(L,L<0?-1:0,!1),x&&(PB[L]=M),M)}function bj(L,k,M){return{low:0|L,high:0|k,unsigned:!!M}}function wj(L,k){if(isNaN(L))return k?xB:VB;if(k){if(L<0)return xB;if(L>=MB)return jB}else{if(L<=-UB)return FB;if(L+1>=UB)return BB}return L<0?k?xB:VB:bj(L%kB|0,L/kB|0,k)}function Oj(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}class Nj extends My{get connectionState(){return this._connectionState}set connectionState(L){if(this._connectionState===L)return;const k=this._connectionState;this._connectionState=L,this.emit(mO.CONNECTION_STATE_CHANGE,L,k)}get quality(){return this._quality}set quality(L){this._quality=L>1?1:L<.1?.1:L,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout((()=>{this.quality=this._quality/this._qualityRatio}),6e4))}constructor(L){var k;super(),xg(this,"name","AgoraRTCImageModeration"),xg(this,"_connectionState",fO.CONNECTING),xg(this,"_sequence",0),xg(this,"_moderationStartTime",void 0),xg(this,"_workerConnection",void 0),xg(this,"_workerMessageLengthLimit",void 0),xg(this,"_qualityRatio",void 0),xg(this,"_connectInfo",void 0),xg(this,"_cancelTokenSource",KC.CancelToken.source()),xg(this,"_retryConfig",void 0),xg(this,"_moderationInterval",void 0),xg(this,"_moderationTimer",null),xg(this,"_moderationMode",1),xg(this,"_quality",1),xg(this,"_qualityTimer",null),xg(this,"_ticket",void 0),xg(this,"_moderationIntervalMinimum",void 0),xg(this,"_uploadFailedNum",0),xg(this,"_uploadNum",0),xg(this,"_uploadTimer",null),xg(this,"_extraInfo",void 0),xg(this,"_vendor",""),xg(this,"_encoder",new TextEncoder),xg(this,"_moderationId",void 0),xg(this,"inspectImage",(()=>{if(this.connectionState!==fO.CONNECTED)throw new Ib(iv.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval((()=>{this.connectionState===fO.CONNECTED?this.requestToInspectImage():Eb.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)}),this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()})),this._moderationId=fA(5,"image-moderation-"),this._workerMessageLengthLimit=zA("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=zA("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=null!==(k=L.interval)&&void 0!==k?k:1e3,L.extraInfo&&(this._extraInfo=this._encoder.encode(L.extraInfo)),L.vendor&&(this._vendor=L.vendor),this._qualityRatio=zA("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new GO("worker-"+this._moderationId,Ov),this.on(mO.STATE_CHANGE,((L,k)=>{Eb.debug("[".concat(this._moderationId,"] Moderation operation :").concat(gO[L]," ").concat(k||""))})),this.handleWorkerEvents()}async init(L,k){this.emit(mO.STATE_CHANGE,gO.CONNECT_AP),this._connectInfo=L;const M=this._cancelTokenSource.token;return this._retryConfig=k,new Mp(((U,x)=>{this.on(mO.CONNECTION_STATE_CHANGE,((L,k)=>{L===fO.CONNECTED&&U()})),this.requestAP(L,M,k).then((L=>{this.connectWorker(L)})).catch((L=>{x(L)}))}))}updateConfig(L){var k;this._moderationInterval=null!==(k=L.interval)&&void 0!==k?k:1e3,L.extraInfo&&(this._extraInfo=this._encoder.encode(L.extraInfo)),L.vendor&&(this._vendor=L.vendor),Eb.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(L))),this.connectionState===fO.CONNECTED&&this.inspectImage()}async requestAP(L,k,M){const U=zA("WEBCS_DOMAIN").map((L=>"https://".concat(L,"/api/v1"))),x=await function(L,k,M,U){let{appId:x,areaCode:V,cname:F,sid:j,token:z,uid:Q}=k;gx++;const $="moderation_plugin",ee={service_name:$,json_body:JSON.stringify({appId:x,areaCode:V,cname:F,command:"allocateEdge",requestId:gx,seq:gx,sid:j,appToken:z,ts:Date.now(),uid:Q+""})};let te,ie,ne=L[0];return PA((async()=>{te=Date.now();const L=await fx(ne,{data:ee,cancelToken:M,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(ie=Date.now()-te,0!==L.code){const k=new Ib(iv.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+L.code,{retry:!0,responseTime:ie});throw Eb.error(k.toString()),k}const k=JSON.parse(L.json_body);if(200!==k.code){const L=new Ib(iv.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(k.code,", reason: ").concat(k.reason),{code:k.code,responseTime:ie});throw Eb.error(L.toString()),L}if(!k.servers||!Array.isArray(k.servers)||0===k.servers.length){const L=new Ib(iv.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:k.code,responseTime:ie});throw Eb.error(L.toString()),L}if(!k.servers.some((L=>!!L.wss))){const L=new Ib(iv.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:k.code,responseTime:ie});throw Eb.error(L.toString()),L}const U=zA("IMAGE_MODERATION_WORKER_HOST");return{addressList:k.servers.map((L=>{let{address:k,wss:M}=L;if(k&&M)return"wss://".concat(k.replace(/\./g,"-"),".").concat(U,":").concat(M,"/moderation")})).filter((L=>!!L)),workerToken:k.workerToken,vid:k.vid,ticket:k.appTicket,responseTime:ie}}),((k,M)=>(Ab.apworkerEvent(j,{success:!0,sc:200,serviceName:$,responseDetail:JSON.stringify(k.addressList),firstSuccess:0===M,responseTime:ie,serverIp:L[M%L.length]}),!1)),((k,M)=>(Ab.apworkerEvent(j,{success:!1,sc:k.data&&k.data.code||200,serviceName:$,responseTime:ie,serverIp:L[M%L.length]}),!!(k.code!==iv.OPERATION_ABORTED&&k.code!==iv.UNEXPECTED_RESPONSE||k.data&&k.data.retry)&&(ne=L[(M+1)%L.length],!0))),U)}(U,L,k,M);this.emit(mO.STATE_CHANGE,gO.AP_CONNECTED);const{addressList:V,ticket:F}=x;return this._ticket=F,V}async connectWorker(L){this.emit(mO.STATE_CHANGE,gO.CONNECT_WORKER),await this._workerConnection.init(L,1e4)}handleWorkerEvents(){this._workerConnection.on(Pw.CONNECTED,(async()=>{this.emit(mO.STATE_CHANGE,gO.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=fO.CONNECTED})),this._workerConnection.on(Pw.CLOSED,(()=>{this.connectionState=fO.CLOSED})),this._workerConnection.on(Pw.FAILED,(()=>{this.connectionState=fO.CLOSED})),this._workerConnection.on(Pw.RECONNECTING,(()=>{this.connectionState=this.connectionState===fO.CONNECTED?fO.RECONNECTING:fO.CONNECTING})),this._workerConnection.on(Pw.ON_MESSAGE,(async L=>{if(L.data instanceof ArrayBuffer){const k=function $B(L){return function(L){let k={};e:for(;!rj(L);){let M=hj(L);switch(M>>>3){case 0:break e;case 1:k.code=hj(L);break;case 2:k.msg=cj(L,hj(L));break;case 3:k.requestId=cj(L,hj(L));break;case 4:k.timestamp=_j(L,!1);break;default:ej(L,7&M)}}return k}({bytes:k=L,offset:0,limit:k.length});var k}(new Uint8Array(L.data));zA("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&Eb.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(k)),this._uploadNum++,void 0===k.code||0===k.code||(this._uploadFailedNum++,Eb.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(k.code,", msg is ").concat(k.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout((()=>{Ab.reportApiInvoke(this._connectInfo.sid||null,{name:dv.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,k.code],tag:lv.TRACER}).onError(new Ib(iv.IMAGE_MODERATION_UPLOAD_FAILED,k.msg)),this._uploadTimer=null}),zA("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else Eb.error("[".concat(this._moderationId,"] Unexpected message type from worker"))})),this._workerConnection.on(Pw.WILL_RECONNECT,((L,k,M)=>{"recover"===L&&M(L),M("tryNext")})),this._workerConnection.on(Pw.REQUEST_NEW_URLS,((L,k)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(L).catch(k)}))}static intToLong(L){return{low:L|=0,high:L>>31,unsigned:L>=0}}async requestToInspectImage(){const L=Zy(this,mO.CLIENT_LOCAL_VIDEO_TRACK),k={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(L){if(!L.isPlaying)return void(zA("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&Eb.debug("Only the track being played can be inspected"));this._sequence++;const M=await this.generateRequestData(L,k);this._workerConnection.sendMessage(M,!0,!0)}else zA("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&Eb.debug("Only the track being published can be inspected")}async generateRequestData(L,k){let{appId:M,cname:U,cid:x,vid:V,sid:F,uid:j}=k;const z=Date.now(),Q=await L.getCurrentFrameImage("image/jpeg",this.quality),$=await bk(Q,M,U),ee=this._sequence+"-"+x+"-"+j+"-"+z+"-"+fA(12,""),te={appId:M,cid:x,cname:U,deviceId:"",elapse:Nj.intToLong(Number(z-this._moderationStartTime)),fileSize:Q.buffer.byteLength,height:Q.height,width:Q.width,jpg:$,networkType:6,osType:7,requestId:ee,sdkVersion:"4.22.1",sequence:this._sequence,sid:F,timestamp:wj(z),uid:j,vid:V,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};void 0===this._extraInfo&&delete te.callbackData;const ie=function ZB(L){let k=function(){const L=OB.pop();return L?(L.offset=L.limit=0,L):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(L,k){let M=L.appId;void 0!==M&&(pj(k,10),dj(k,M));let U=L.cid;void 0!==U&&(pj(k,16),pj(k,U));let x=L.cname;void 0!==x&&(pj(k,26),dj(k,x));let V=L.deviceId;void 0!==V&&(pj(k,34),dj(k,V));let F=L.elapse;void 0!==F&&(pj(k,40),Ej(k,F));let j=L.fileSize;void 0!==j&&(pj(k,48),Ej(k,tj(j)));let z=L.height;void 0!==z&&(pj(k,56),Ej(k,tj(z)));let Q=L.jpg;void 0!==Q&&(pj(k,66),pj(k,Q.length),aj(k,Q));let $=L.networkType;void 0!==$&&(pj(k,72),Ej(k,tj($)));let ee=L.osType;void 0!==ee&&(pj(k,80),Ej(k,tj(ee)));let te=L.requestId;void 0!==te&&(pj(k,90),dj(k,te));let ie=L.sdkVersion;void 0!==ie&&(pj(k,98),dj(k,ie));let ne=L.sequence;void 0!==ne&&(pj(k,104),Ej(k,tj(ne)));let re=L.sid;void 0!==re&&(pj(k,114),dj(k,re));let oe=L.timestamp;void 0!==oe&&(pj(k,120),Ej(k,oe));let ce=L.uid;void 0!==ce&&(pj(k,128),pj(k,ce));let de=L.vid;void 0!==de&&(pj(k,136),pj(k,de));let le=L.width;void 0!==le&&(pj(k,144),Ej(k,tj(le)));let ue=L.service;void 0!==ue&&(pj(k,152),pj(k,ue));let he=L.callbackData;void 0!==he&&(pj(k,162),pj(k,he.length),aj(k,he));let pe=L.ticket;void 0!==pe&&(pj(k,170),dj(k,pe));let _e=L.vendorConfigs;void 0!==_e&&(pj(k,178),dj(k,_e))}(L,k),function(L){let k=L.bytes,M=L.limit;return k.length===M?k:k.subarray(0,M)}(k)}(te);if(ie.byteLength<this._workerMessageLengthLimit){if(zA("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){const L=function(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?Oj(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):Oj(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}({},te);delete L.jpg,Eb.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(L))}return ie}{const k=this.quality*this._qualityRatio;return this.quality=k,await this.generateRequestData(L,{appId:M,cname:U,cid:x,vid:V,sid:F,uid:j})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=KC.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=fO.CLOSED,this.emit(mO.STATE_CHANGE,gO.CLOSED)}}function Dj(L){if(Iy(L.interval,"interval",1e3,1/0),L&&L.extraInfo&&L.extraInfo.length>1024)throw new Ib(iv.INVALID_PARAMS,"config.extraInfo length cannot exceed 1024 bytes");if(L&&L.vendor&&L.vendor.length>1024)throw new Ib(iv.INVALID_PARAMS,"config.vendor length cannot exceed 1024 bytes")}const GB={name:"ImageModeration",create:function(L){let{config:k}=L;return Dj(k),new Nj(k)}};var ij,fj,mj,gj,Tj,Sj,Rj,Ij,yj,Cj,vj,Pj,Lj,kj,Mj,Uj,xj,Vj,Fj,Bj,jj,Gj,Wj,Hj,Kj,zj,Yj,qj,Xj,Jj,Qj,Zj,$j,eG,tG,iG,nG,rG,oG,sG,aG;function gG(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function RG(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?gG(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):gG(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}wv.setLogger(Eb);let cG=(ij=Rb(),fj=Rb({argsMap:(L,k)=>{if(!Array.isArray(k)){if(!(k instanceof GL))return[k];k=[k]}return k.map((L=>L?Object(L).toString():"null"))}}),mj=Rb({argsMap:(L,k)=>(k||(k=[]),Array.isArray(k)||k.trackMediaType!==gL.DATA?(Array.isArray(k)||(k=[k]),k.map((L=>L.getTrackId()))):[k.getChannelId()])}),gj=Rb({argsMap:(L,k,M,U)=>["object"==typeof k?k.uid:k,M,U]}),Tj=Rb({argsMap:(L,k,M)=>[k,M]}),Sj=Rb({argsMap:(L,k)=>k.map((L=>{let{user:k,mediaType:M}=L;return[null==k?void 0:k.uid,M]}))}),Rj=Rb({argsMap:(L,k,M,U)=>["object"==typeof k?k.uid:k,M,U]}),Ij=Rb({argsMap:(L,k)=>k.map((L=>{let{user:k,mediaType:M}=L;return{uid:null==k?void 0:k.uid,mediaType:M}}))}),yj=Rb(),Cj=Rb(),vj=Rb(),Pj=Rb(),Lj=Rb(),kj=Rb(),Mj=Rb(),Uj=Rb(),xj=Rb(),Vj=Rb(),Fj=Rb(),Bj=Rb(),jj=Rb(),Gj=Rb(),Wj=Rb({argsMap:(L,k)=>[k]}),Hj=Rb(),Kj=Rb(),zj=Rb(),Yj=Rb(),qj=Rb(),Xj=Rb(),Jj=Rb(),Qj=Rb(),Zj=Rb({argsMap:(L,k)=>(Array.isArray(k)||(k=[k]),[JSON.stringify(k)])}),$j=Rb(),eG=Rb(),tG=Rb(),iG=Rb(),nG=Rb(),rG=Rb(),oG=Rb({reportResult:!0}),sG=Rb(),aG=class extends My{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var L;return(null===(L=this._config)||void 0===L?void 0:L.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(L){let k;if(super(),xg(this,"store",void 0),xg(this,"_uid",void 0),xg(this,"_channelName",void 0),xg(this,"_uintUid",void 0),xg(this,"_users",[]),xg(this,"_config",void 0),xg(this,"_clientId",void 0),xg(this,"_appId",void 0),xg(this,"_sessionId",null),xg(this,"_key",void 0),xg(this,"_rtmConfig",{}),xg(this,"_joinInfo",void 0),xg(this,"_gateway",void 0),xg(this,"_statsCollector",void 0),xg(this,"_configDistribute",void 0),xg(this,"_leaveMutex",new wv("client-leave")),xg(this,"_publishMutex",new wv("client-publish")),xg(this,"_renewTokenMutex",new wv("client-renewtoken")),xg(this,"_subscribeMutex",new wv("client-subscribe")),xg(this,"_encryptionMode","none"),xg(this,"_encryptionSecret",null),xg(this,"_encryptionSalt",null),xg(this,"_encryptDataStream",!1),xg(this,"_encryptDataStreamKey",null),xg(this,"_encryptDataStreamIv",null),xg(this,"_proxyServer",void 0),xg(this,"_turnServer",{servers:[],mode:"auto"}),xg(this,"_cloudProxyServerMode","disabled"),xg(this,"_isDualStreamEnabled",!1),xg(this,"_defaultStreamFallbackType",void 0),xg(this,"_lowStreamParameter",void 0),xg(this,"_streamFallbackTypeCacheMap",new Map),xg(this,"_remoteStreamTypeCacheMap",new Map),xg(this,"_axiosCancelSource",KC.CancelToken.source()),xg(this,"_audioVolumeIndicationInterval",void 0),xg(this,"_networkQualityInterval",void 0),xg(this,"_userOfflineTimeout",void 0),xg(this,"_streamRemovedTimeout",void 0),xg(this,"_liveTranscodeStreamingClient",void 0),xg(this,"_liveRawStreamingClient",void 0),xg(this,"_channelMediaRelayClient",void 0),xg(this,"_networkQualitySensitivity","normal"),xg(this,"_p2pChannel",void 0),xg(this,"_useLocalAccessPoint",!1),xg(this,"_setLocalAPVersion",void 0),xg(this,"_joinAndNotLeaveYet",!1),xg(this,"_numberOfJoinCount",0),xg(this,"_remoteDefaultVideoStreamType",void 0),xg(this,"_inspect",void 0),xg(this,"_moderation",void 0),xg(this,"_license",void 0),xg(this,"_pendingPublishedUsers",[]),xg(this,"ntpAlignErrorCount",0),xg(this,"remoteInboundOffset",0),xg(this,"_handleLocalTrackEnable",((L,k,M)=>{this.publish(L,!1).then(k).catch(M)})),xg(this,"_handleLocalTrackDisable",((L,k,M)=>{this.unpublish(L).then(k).catch(M)})),xg(this,"_handleUserOnline",(L=>{if(zA("BLOCK_LOCAL_CLIENT")&&bb(L.uid,this.channelName))return void Eb.debug("[".concat(L.uid,"] will be ignored in local"));this.isStringUID&&"string"!=typeof L.uid&&Eb.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const k=this._users.find((k=>k.uid===L.uid));if(k)k._trust_in_room_=!0,k._is_pre_created&&(k._is_pre_created=!1,this.safeEmit(pv.USER_JOINED,k));else{const k=new sF(L.uid,L.uint_id||L.uid);this._users.push(k),Eb.debug("[".concat(this._clientId,"] user online"),L.uid),this.safeEmit(pv.USER_JOINED,k)}})),xg(this,"_handleUserOffline",(L=>{if(zA("BLOCK_LOCAL_CLIENT")&&bb(L.uid,this.channelName))return;const k=this._users.find((k=>k.uid===L.uid));k&&(this._handleRemoveStream(L),this._handleRemoveDataChannels(L),k._audio_pre_subscribed||k._video_pre_subscribed?k._is_pre_created=!0:tA(this._users,k),this._remoteStreamTypeCacheMap.delete(k.uid),this._streamFallbackTypeCacheMap.delete(k.uid),Eb.debug("[".concat(this._clientId,"] user offline"),L.uid,"reason:",L.reason),this.safeEmit(pv.USER_LEAVED,k,L.reason))})),xg(this,"_handleAddAudioOrVideoStream",((L,k,M,U,x,V,F)=>{if(zA("BLOCK_LOCAL_CLIENT")&&bb(k,this.channelName))return;const j=this._users.find((L=>L.uid===k));if(!j)return void Eb.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));Eb.debug("[".concat(this._clientId,"] stream added with uid ").concat(k,", type ").concat(L)),this.store.subscribe(j.uid,L,void 0,void 0,void 0,Date.now());const z="audio"===L?j.hasAudio:j.hasVideo;j._uintid||(j._uintid=x||k),"audio"===L?j._trust_audio_stream_added_state_=!0:j._trust_video_stream_added_state_=!0,"audio"===L?(j._audio_added_=!0,void 0!==M&&(j._audioSSRC=M),void 0!==U&&(j._cname=U),V&&(j._audioOrtc=V)):(j._video_added_=!0,void 0!==M&&(j._videoSSRC=M),void 0!==U&&(j._cname=U),void 0!==F&&(j._rtxSsrcId=F),V&&(j._videoOrtc=V)),("audio"===L?j.hasAudio:j.hasVideo)&&!z&&(Eb.info("[".concat(this._clientId,"] remote user ").concat(j.uid," published ").concat(L)),this.safeEmit(pv.USER_PUBLISHED,j,L)),"video"===L?Ab.onGatewayStream(this._sessionId,Tb.ON_ADD_VIDEO_STREAM,Sb.ON_ADD_VIDEO_STREAM,{peer:x||k,ssrc:j._videoSSRC}):Ab.onGatewayStream(this._sessionId,Tb.ON_ADD_AUDIO_STREAM,Sb.ON_ADD_AUDIO_STREAM,{peer:x||k,ssrc:j._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(j,L,M).then((k=>{if(k&&(Eb.debug("[".concat(this._clientId,"] resubscribe ").concat(L," for user ").concat(j.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof xF))return this._p2pChannel.unsubscribe(j,L,!0).then((()=>this._subscribe(j,L,!0).catch((L=>{Eb.error("[".concat(this._clientId,"] resubscribe error"),L.toString())}))))})),this._p2pChannel.hasPendingRemoteMedia(j,L)&&(Eb.debug("[".concat(this._clientId,"] resubscribe ").concat(L," for user ").concat(j.uid," after reconnect.")),this._subscribe(j,L,!0).catch((L=>{Eb.error("[".concat(this._clientId,"] resubscribe error"),L.toString())})))})),xg(this,"_handleRemoveStream",(L=>{if(zA("BLOCK_LOCAL_CLIENT")&&bb(L.uid,this.channelName))return;const k=this._users.find((k=>k.uid===L.uid));if(!k)return void Eb.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));Eb.debug("[".concat(this._clientId,"] stream removed with uid ").concat(L.uid));let i=()=>{};k.hasAudio&&k.hasVideo?i=()=>{Eb.info("[".concat(this._clientId,"] remote user ").concat(k.uid," unpublished audio track")),this.safeEmit(pv.USER_UNPUBLISHED,k,"audio"),Eb.info("[".concat(this._clientId,"] remote user ").concat(k.uid," unpublished video track")),this.safeEmit(pv.USER_UNPUBLISHED,k,"video")}:k.hasVideo?i=()=>{Eb.info("[".concat(this._clientId,"] remote user ").concat(k.uid," unpublished video track")),this.safeEmit(pv.USER_UNPUBLISHED,k,"video")}:k.hasAudio&&(i=()=>{Eb.info("[".concat(this._clientId,"] remote user ").concat(k.uid," unpublished audio track")),this.safeEmit(pv.USER_UNPUBLISHED,k,"audio")}),k._video_pre_subscribed||k._audio_pre_subscribed||(k._trust_audio_stream_added_state_=!0,k._trust_video_stream_added_state_=!0,k._audio_added_=!1,k._video_added_=!1,this._p2pChannel instanceof xF&&this._p2pChannel.unsubscribe(k).then((L=>{if(L)return this._gateway.unsubscribe(L,k.uid)})),k._audioSSRC=void 0,k._videoSSRC=void 0,k._audioOrtc=void 0,k._videoOrtc=void 0,k._rtxSsrcId=void 0),Ab.onGatewayStream(this._sessionId,Tb.ON_REMOVE_STREAM,Sb.ON_REMOVE_STREAM,{peer:L.uint_id||L.uid}),i()})),xg(this,"_handleSetStreamLocalEnable",((L,k,M)=>{if(zA("BLOCK_LOCAL_CLIENT")&&bb(k,this.channelName))return;const U=this._users.find((L=>L.uid===k));if(!U)return void Eb.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));Eb.debug("[".concat(this._clientId,"] local ").concat(L," ").concat(M?"enabled":"disabled"," with uid ").concat(k));const x="audio"===L?U.hasAudio:U.hasVideo;if("audio"===L){U._trust_audio_enabled_state_=!0;const L=U._audio_enabled_;if(U._audio_enabled_=M,U._audio_enabled_===L)return;{const L=U._audio_enabled_?"enable-local-audio":"disable-local-audio";Eb.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(k,", msg: ").concat(L)),this.safeEmit(pv.USER_INFO_UPDATED,k,L)}}else{U._trust_video_enabled_state_=!0;const L=U._video_enabled_;if(U._video_enabled_=M,U._video_enabled_===L)return;{const L=U._video_enabled_?"enable-local-video":"disable-local-video";Eb.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(k,", msg: ").concat(L)),this.safeEmit(pv.USER_INFO_UPDATED,k,L)}}const V="audio"===L?U.hasAudio:U.hasVideo;return x!==V?!x&&V?(Eb.info("[".concat(this._clientId,"] remote user ").concat(k," published ").concat(L)),void this.safeEmit(pv.USER_PUBLISHED,U,L)):("video"===L&&U._videoTrack&&U._videoTrack._destroy(),"audio"===L&&U._audioTrack,this._p2pChannel.muteRemote(U,L),Eb.info("[".concat(this._clientId,"] remote user ").concat(k," unpublished ").concat(L)),void this.safeEmit(pv.USER_UNPUBLISHED,U,L)):void 0})),xg(this,"_handleMuteStream",((L,k,M)=>{if(zA("BLOCK_LOCAL_CLIENT")&&bb(L,this.channelName))return;Eb.debug("[".concat(this._clientId,"] receive mute message"),L,k,M);const U=this._users.find((k=>k.uid===L));if(!U)return void Eb.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(L));const x="audio"===k?U.hasAudio:U.hasVideo;if("audio"===k){U._trust_audio_mute_state_=!0;const k=U._audio_muted_;if(U._audio_muted_=M,U._audio_muted_===k)return;{const k=U._audio_muted_?"mute-audio":"unmute-audio";Eb.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(L,", msg: ").concat(k)),this.safeEmit(pv.USER_INFO_UPDATED,L,k)}}else{U._trust_video_mute_state_=!0;const k=U._video_muted_;if(U._video_muted_=M,U._video_muted_===k)return;{const k=U._video_muted_?"mute-video":"unmute-video";Eb.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(L,", msg: ").concat(k)),this.safeEmit(pv.USER_INFO_UPDATED,L,k)}}const V="audio"===k?U.hasAudio:U.hasVideo;if(x!==V){if(!x&&V)return("audio"===k?U._audioSSRC:U._videoSSRC)?(Eb.info("[".concat(this._clientId,"] remote user ").concat(L," published ").concat(k)),void this.safeEmit(pv.USER_PUBLISHED,U,k)):void Eb.warning("[".concat(this._clientId,"] remote user ").concat(L," receive ").concat(k," unmute message  before add stream message, ").concat(k," SSRC doesn't exist yet."));"video"===k&&U._videoTrack&&!U._video_pre_subscribed&&U._videoTrack._destroy(),"audio"===k&&U._audioTrack,this._p2pChannel.muteRemote(U,k),Eb.info("[".concat(this._clientId,"] remote user ").concat(L," unpublished ").concat(k)),this.safeEmit(pv.USER_UNPUBLISHED,U,k)}})),xg(this,"_handleP2PLost",(async L=>{Eb.debug("[".concat(this._clientId,"] receive p2p lost"),L),parseInt(L.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():Eb.warning("[".concat(this._clientId,"] P2PLost stream not found"),L)})),xg(this,"_handleTokenWillExpire",(()=>{Eb.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(pv.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)})),xg(this,"_handleBeforeUnload",(L=>{"beforeunload"===L.type&&void 0!==L.returnValue&&""!==L.returnValue||(this.leave(),Eb.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))})),xg(this,"_handleUpdateNetworkQuality",(()=>{if("normal"===this._networkQualitySensitivity)return;if(navigator&&void 0!==navigator.onLine&&!navigator.onLine)return void this.safeEmit(pv.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const L={downlinkNetworkQuality:0,uplinkNetworkQuality:0};L.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),L.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(pv.NETWORK_QUALITY,L)})),xg(this,"_handleP2PAddAudioOrVideoStream",((L,k,M,U)=>{const x=this._users.find((L=>L.uid===k));if(!x)return void Eb.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));Eb.debug("[".concat(this._clientId,"] stream added with uid ").concat(k,", type ").concat(L)),this.store.subscribe(x.uid,L,void 0,void 0,void 0,Date.now());const V="audio"===L?x.hasAudio:x.hasVideo;"audio"===L?x._trust_audio_stream_added_state_=!0:x._trust_video_stream_added_state_=!0,"audio"===L?(x._audio_added_=!0,void 0!==M&&(x._audioSSRC=M),void 0!==U&&(x._audioMid=U)):(x._video_added_=!0,void 0!==M&&(x._videoSSRC=M),void 0!==U&&(x._videoMid=U)),("audio"===L?x.hasAudio:x.hasVideo)&&!V&&(Eb.info("[".concat(this._clientId,"] remote user ").concat(x.uid," published ").concat(L)),this.safeEmit(pv.USER_PUBLISHED,x,L)),this._p2pChannel.hasPendingRemoteMedia(x,L)&&(Eb.debug("[".concat(this._clientId,"] resubscribe ").concat(L," for user ").concat(x.uid," after reconnect.")),this._subscribe(x,L,!0).catch((L=>{Eb.error("[".concat(this._clientId,"] resubscribe error"),L.toString())})))})),this._config=L,this._clientId=fA(5,"client-"),this.store=new QA(L.codec,L.audioCodec,L.mode,this._clientId),this.store.clientCreated(),L.proxyServer&&this.setProxyServer(L.proxyServer,!0),L.turnServer&&this.setTurnServer(L.turnServer,!0),Eb.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(Mv," build: ").concat(Bv,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),L.clientRoleOptions)try{Ky(L.clientRoleOptions),k=Object.assign({},L.clientRoleOptions)}catch(L){Eb.warning("[".concat(this._clientId,"] ").concat(L.toString()))}this._statsCollector=new OF(this.store),this._statsCollector.onStatsException=(L,k,M)=>{Eb.debug("[".concat(this._clientId,"] receive exception msg, code: ").concat(L,", msg: ").concat(k,", uid: ").concat(M)),this.safeEmit(pv.EXCEPTION,{code:L,msg:k,uid:M})},this._statsCollector.onUploadPublishDuration=(L,k,M,U)=>{const x=this._users.find((k=>k.uid===L));x&&Ab.peerPublishStatus(this._sessionId,{subscribeElapse:U,audioPublishDuration:k,videoPublishDuration:M,peer:x._uintid})},this.store.useP2P="p2p"===L.mode,this._gateway=new px(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:L.websocketRetryConfig||Ov,httpRetryConfig:L.httpRetryConfig||Ov,forceWaitGatewayResponse:void 0===L.forceWaitGatewayResponse||L.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:L.role,clientRoleOptions:k}),this._configDistribute=new $x,this.store.useP2P?(this._p2pChannel=new _F(this.store,this._statsCollector),this._handleP2PEvents()):this._p2pChannel=new xF(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(L,k,M,U,x){let V=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],F=arguments.length>6&&void 0!==arguments[6]&&arguments[6];qA("JOIN_GATEWAY_USE_443PORT_ONLY",V),qA("JOIN_GATEWAY_USE_DUAL_DOMAIN",F);const j=this._gateway.signal.websocket;return j instanceof jO&&(j.use443PortOnly=V,j.tryDoubleDomain=F),async function(L,k,M){zC.get(L)||zC.set(L,[]),YC.get(L)||YC.set(L,k),qC.get(L)||qC.set(L,0);const U=zC.get(L),x=YC.get(L);if(!U||!x)throw new Error("concurrent: deferQueue or maxConcurrency is null");if(qC.get(L)===x){const L=Lv();U.push(L),await L.promise}qC.set(L,qC.get(L)+1);for(var V=arguments.length,F=new Array(V>3?V-3:0),j=3;j<V;j++)F[j-3]=arguments[j];const z=await M(...F);return qC.set(L,qC.get(L)-1),qC.get(L)===x-1&&U.length>0&&(U[0].resolve(),U.shift()),0===qC.get(L)&&(zC.set(L,[]),YC.set(L,0),qC.set(L,0)),z}("client.join",zA("JOIN_MAX_CONCURRENCY"),this.join.bind(this),L,k,M,U,x)}async join(L,k,M,U,x){const V=++this._numberOfJoinCount;this.store.joinStart(),U&&(this.store.uid=U);const F="HTTPS"===(Nv||Nv||(Nv=(window.location.protocol.split(":")[0]||"").toUpperCase(),Nv)),j=FA()?window.isSecureContext:"Browser Not Support";if(!FA()&&!F||!window.isSecureContext){const L="The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser";Eb.warning(L)}"DISCONNECTED"===this.connectionState&&(this.store.avoidJoinStart=Math.round(Date.now()),Eb.debug("[".concat(this._clientId,"] set avoidJoinStart to ").concat(this.store.avoidJoinStart))),Ab.setAppId(L);try{if(!M&&null!==M)throw new Ib(iv.INVALID_PARAMS,"Invalid token: ".concat(M,". If you don not use token, set it to null"));M&&yy(M,"token",1,2047),yy(L,"appid",1,2047),Mw(k),U&&Uw(U),x&&yy(x,"optionalInfo",1,2047)}catch(x){throw Ab.reportApiInvoke(mA(),{name:dv.JOIN,options:[L,k,M,U],states:{isHttps:F,isSecureContext:j},tag:lv.TRACER}).onError(x),x}if(this._leaveMutex.isLocked&&(Eb.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),Eb.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,"DISCONNECTED"!==this.connectionState){const x=new Ib(iv.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw Ab.reportApiInvoke(mA(),{name:dv.JOIN,options:[L,k,M,U],states:{isHttps:F,isSecureContext:j},tag:lv.TRACER}).onError(x),x}this._gateway.state="CONNECTING";const z=await HB({appId:L,cname:k,uid:U,stringUid:"string"==typeof U?U:void 0,token:M||L,cloudProxyServer:this._cloudProxyServerMode});if(!this._joinAndNotLeaveYet)throw new Ib(iv.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));const Q=(null==z?void 0:z.sid)||mA();Eb.info("[".concat(this._clientId,"] start join channel ").concat(k,", join number: ").concat(V)),this._sessionId||(this._sessionId=Q,this.store.sessionId=this._sessionId);const $=Ab.reportApiInvoke(Q,{name:dv.JOIN,options:[L,k,M,U],states:{isHttps:F,isSecureContext:j},tag:lv.TRACER}),ee=RG(RG(RG({},this._rtmConfig),{},{clientId:this._clientId,appId:L,sid:this._sessionId,cname:k,uid:"string"!=typeof U?U:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:M||L,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:x,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint,preload:!!z},void 0!==this._remoteDefaultVideoStreamType&&{defaultVideoStream:this._remoteDefaultVideoStreamType}),{},{apRequestDetail:zA("AP_REQUEST_DETAIL")||void 0});if(this._useLocalAccessPoint&&(ee.setLocalAPVersion=this._setLocalAPVersion),"string"==typeof U&&(ee.stringUid=U,this._uintUid?(ee.uid=this._uintUid,this._uintUid=void 0):ee.uid=0),"none"!==this._encryptionMode&&this._encryptionSecret){if(ee.aesmode=this._encryptionMode,ee.aespassword=await(async L=>{const k=function(L){const k=window.atob("MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu\nSTM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+\nHvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy\nxQiYDz3vqa6bP29adwIDAQAB"),M=new Uint8Array(new ArrayBuffer(k.length));for(let L=0;L<k.length;L+=1)M[L]=k.charCodeAt(L);return M}(),M=await window.crypto.subtle.importKey("spki",k,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),U=Py(L),x=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},M,U);return function(L){let k="";for(let M=0;M<L.length;M+=1)k+=String.fromCharCode(L[M]);return window.btoa(k)}(new Uint8Array(x))})(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new Ib(iv.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(ee.aessalt=this._encryptionSalt)}if(this._encryptDataStream&&("aes-128-gcm2"===this._encryptionMode||"aes-256-gcm2"===this._encryptionMode))if(this._encryptionSalt&&this._encryptionSecret)if(window.crypto.subtle){const L=new TextEncoder,k=zA("USE_PURE_ENCRYPTION_MASTER_KEY")?L.encode(ee.appId+this._encryptionSecret+this._encryptionSecret):L.encode(ee.appId+ee.cname+this._encryptionSecret);this._encryptDataStreamIv=await async function(L,k,M){const U=await window.crypto.subtle.importKey("raw",k,"PBKDF2",!1,["deriveBits","deriveKey"]),x="aes-128-gcm2"===L?128:256,V=await window.crypto.subtle.deriveBits({name:"PBKDF2",iterations:1e3,hash:"SHA-256",salt:M},U,x+96);return new Uint8Array(V).subarray(x/8)}(this._encryptionMode,k,cA(this._encryptionSalt)),this._encryptDataStreamKey=await async function(L,k,M){const U=await window.crypto.subtle.importKey("raw",k,"PBKDF2",!1,["deriveBits","deriveKey"]),x="aes-128-gcm2"===L?128:256;return await window.crypto.subtle.deriveKey({name:"PBKDF2",iterations:1e3,hash:"SHA-256",salt:M},U,{name:"AES-GCM",length:x},!0,["encrypt","decrypt"])}(this._encryptionMode,k,cA(this._encryptionSalt))}else j?Eb.warning("[".concat(this._clientId,"] encrypt datastream must be running in a secure context, fallback to plain data stream")):Eb.warning("[".concat(this._clientId,"] current browser do not support WebCrypto ,fallback to plain data stream")),this._encryptDataStream=!1;else this._encryptDataStream=!1,Eb.debug("[".concat(this._clientId,"] no salt / secret, cannot support encrypt data stream, fallback to plain data stream"));this._startSession(this._sessionId,{channel:k,appId:L,stringUid:ee.stringUid});const te=this._sessionId;setTimeout((()=>{"CONNECTING"===this.connectionState&&te===this._sessionId&&Ab.joinChannelTimeout(this._sessionId,5)}),5e3);try{var ie;let U;const x=ee.cloudProxyServer;if(Sr(ie=["proxy3","proxy4","proxy5"]).call(ie,x)){const L=zA("PROXY_SERVER_TYPE3");Array.isArray(L)?ee.proxyServer=L[0]:ee.proxyServer=L}if(Ab.setProxyServer(ee.proxyServer),Eb.setProxyServer(ee.proxyServer),this.store.requestAPStart(),z){if(Eb.debug("[".concat(this._clientId,"] get serverInfo Success from Preload Cache ").concat(ee.stringUid?", ".concat(ee.stringUid," => ").concat(z.intUid):""," ")),ee.stringUid&&!ee.uid&&(ee.uid=z.intUid),U={gatewayInfo:z.ap.gatewayInfo},zA("JOIN_WITH_FALLBACK_MEDIA_PROXY")&&"auto"===ee.turnServer.mode)if(0===z.ap.proxyInfo.addresses.length)Eb.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers");else{const L=(await $O(z.ap.proxyInfo,z.ap.gatewayInfo.uid)).map((L=>({turnServerURL:L.address,tcpport:L.tcpport||Vv.tcpport,udpport:L.udpport||Vv.udpport,username:L.username||Vv.username,password:L.password||Vv.password,forceturn:!1,security:!0})));ee.turnServer={mode:"manual",servers:L}}zB(z,ee.stringUid)}else{if(ee.stringUid&&!ee.uid){let L;[L,U]=await Mp.all([Hx(ee.stringUid,ee,this._axiosCancelSource.token,this._config.httpRetryConfig||Ov,this.store),Wx(ee,this._axiosCancelSource.token,this._config.httpRetryConfig||Ov,!0,this.store)]),Eb.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(ee.stringUid," => ").concat(L)),ee.uid=L,U.gatewayInfo.uid=L,U.gatewayInfo.res.uid=L}else U=await Wx(ee,this._axiosCancelSource.token,this._config.httpRetryConfig||Ov,!0,this.store);if(!this._joinAndNotLeaveYet)throw new Ib(iv.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"))}this.store.requestAPEnd(),setTimeout((()=>{this._configDistribute.startGetConfigDistribute(ee,this._axiosCancelSource.token),this._configDistribute.on(iO.UPDATE_BITRATE_LIMIT,(L=>{this._p2pChannel.updateBitrateLimit(L)}))}),0),this._key=M||L;const V=U.gatewayInfo,F=ee.uid?ee.uid:V.uid;this._joinInfo=RG(RG({},ee),{},{cid:V.cid,uid:F,vid:V.vid,apResponse:V.res,apGatewayAddress:V.apGatewayAddress,uni_lbs_ip:V.uni_lbs_ip,gatewayAddrs:V.gatewayAddrs}),this.store.intUid=F;const j=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new Ib(iv.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));$.onSuccess(j),this._appId=L,this._channelName=ee.cname,this._uid=j,this.store.uid=j,setTimeout((()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),window.addEventListener(zv()?"beforeunload":"pagehide",this._handleBeforeUnload),this._statsCollector.startUpdateStats()}),0);const Q=ee.stringUid?"string uid: ".concat(ee.stringUid,",uid: ").concat(ee.uid):"uid: ".concat(this._uid);return Eb.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(k,",").concat(Q)),setTimeout((()=>{Eb.startUpload()}),5e3),this.store.joinEnd(),this,Sr(wb).call(wb,this)||wb.push(this),"disabled"===this._cloudProxyServerMode&&XP().supportWebCrypto&&zA("ENABLE_PRELOAD")&&YB(this._joinInfo),j}catch(L){const k=Array.isArray(L)?L[0]:L;throw k&&k.code===iv.OPERATION_ABORTED?Eb.warning("[".concat(this._clientId,"] join number: ").concat(V,", Joining channel failed, rollback"),k):Eb.error("[".concat(this._clientId,"] join number: ").concat(V,", Joining channel failed, rollback"),k),k.code!==iv.OPERATION_ABORTED&&this._numberOfJoinCount===V&&(this._gateway.state="DISCONNECTED",this._reset()),$.onError(k),k}}_joinGateway(){if(!this._joinInfo||!this._key)throw new Ib(iv.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!("disabled"!==this._joinInfo.cloudProxyServer||this._joinInfo.proxyServer||!zA("JOIN_WITH_FALLBACK_SIGNAL_PROXY")))}async leave(){Eb.info("[".concat(this._clientId,"] Leaving channel")),window.removeEventListener(zv()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(L){const k=wb.indexOf(L);-1!==k&&wb.splice(k,1)}(this),this._statsCollector.stopUpdateStats();const L=await this._leaveMutex.lock();if("DISCONNECTED"===this.connectionState)return Eb.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void L();await this._gateway.leave("CONNECTED"!==this.connectionState),Eb.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),L()}async publish(L){let k=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!Array.isArray(L)){if(!(L instanceof GL))return this._publishDataChannel(L);L=[L]}if(0===L.length)throw new Ib(iv.INVALID_PARAMS,"param list is empty");const M=L;if("audience"===this._gateway.role)throw new Ib(iv.INVALID_OPERATION,"audience can not publish stream");for(const L of M){if(!(L instanceof GL))throw new Ib(iv.INVALID_PARAMS,"parameter is not local track");if(!L._enabled&&k)throw new Ib(iv.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(L.getTrackId()))}Eb.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(M.map((L=>"".concat(L.getTrackId()," ")))));const U=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),k&&M.forEach((L=>{const k=this._configDistribute.getBitrateLimit();L instanceof eU&&k&&L.setBitrateLimit(k.uplink)}));try{await this._publishHighStream(M),Eb.info("[".concat(this._clientId,"] Publish success, id ").concat(M.map((L=>"".concat(L.getTrackId()," ")))))}catch(L){throw Eb.error("[".concat(this._clientId,"] publish error"),L.toString()),L}finally{U()}}async _publishDataChannel(L){Iy(L.id,"id",0,65535,!0),Ry(L.ordered,"ordered"),yy(L.metadata,"metadata",0,512),Eb.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(L.id));const k=await this._publishMutex.lock();try{if(-1!==this._p2pChannel.getAllDataChannels().findIndex((k=>k.id===L.id)))throw new Ib(iv.INVALID_PARAMS,"Invalid id: ".concat(L.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||void 0===this._uid)throw new Ib(iv.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Ib(iv.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if("auto"===this._turnServer.mode&&zA("FORCE_TURN")&&!zA("TURN_ENABLE_TCP")&&!zA("TURN_ENABLE_UDP"))throw new Ib(iv.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");const M=function(L){return SB(L,!1)}(L),U=await this._p2pChannel.publishDataChannel([M]);if(U.length>0){if("number"!=typeof M._originDataChannelId)throw Eb.error("[".concat(this._clientId,"] can not publish with mediaType datachannel, cannot get RTCDatachannel id")),new Ib(iv.CREATE_DATACHANNEL_ERROR);try{await Mp.all(U.map((L=>this._uid&&this._gateway.publishDataChannel(this._uid,L,!0)))),await M._waitTillOpen()}catch(L){if(L.code!==iv.DISCONNECT_P2P)throw L}}return Eb.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(M.id)),M}catch(L){throw Eb.error("[".concat(this._clientId,"] publish datachannels error"),L.toString()),L}finally{k()}}async unpublish(L){if(!this._joinInfo||void 0===this._uid)throw new Ib(iv.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let k=[];if(L)if(Array.isArray(L))k=L;else{if(!(L instanceof GL))return this._unpublishDataChannel([L]);k=[L]}else this.store.useP2P||await this._unpublishDataChannel(),k=this._p2pChannel.getAllTracks(!0);Eb.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(k.map((L=>"".concat(L.getTrackId()," ")))," "));const M=await this._publishMutex.lock();try{if(this._p2pChannel instanceof _F){const L=await this._p2pChannel.unpublish(k);L&&await this._gateway.sendExtensionMessage(TO.UNPUBLISH,{unpubMsg:L},!0)}else{const L=await this._p2pChannel.unpublish(k);L&&await this._gateway.unpublish(L,this._uid),Eb.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(k.map((L=>"".concat(L.getTrackId())))))}}catch(L){throw Eb.error("[".concat(this._clientId,"] unpublish error"),L.toString()),L}finally{M&&M()}}async _unpublishDataChannel(L){void 0!==L&&0!==L.length||(L=this._p2pChannel.getAllDataChannels()),Eb.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(L.map((L=>"".concat(L.id," ")))," "));const k=await this._publishMutex.lock();try{const M=await this._p2pChannel.unpublishDataChannel(L);M&&await this._gateway.unpublishDataChannel(M),Eb.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(L.map((L=>"".concat(L.id)))))}catch(L){throw Eb.error("[".concat(this._clientId,"] unpublish dataChannel error"),L.toString()),L}finally{k&&k()}}async subscribe(L,k,M){if(!(L instanceof sF)){const k=this.remoteUsers.find((k=>k.uid===L));if(!k)throw new Ib(iv.INVALID_REMOTE_USER,"user is not in the channel");L=k}return"datachannel"===k?this._subscribeDataChannel(L,M):this._subscribe(L,k)}async presubscribe(L,k){if(Cy(k,"mediaType",["audio","video"]),this._p2pChannel instanceof _F)throw new Ib(iv.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new Ib(iv.INVALID_OPERATION,"can't presub when not join");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Ib(iv.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));const M=k===nO.AUDIO,U=k===nO.VIDEO,x=await this._subscribeMutex.lock();try{const{ssrcId:V,ortc:F,rtxSsrcId:j,cname:z,uint_id:Q}=await this._gateway.presubscribe(L,k,!0);if(null==V)throw new Ib(iv.UNEXPECTED_RESPONSE,"no ssrc id");let $=this._users.find((k=>k.uid===L));$||($=new sF(L,Q||L),$._is_pre_created=!0,this._users.push($)),z&&($._cname=z),$._uintid||($._uintid=Q||L),M&&($._audioSSRC=V,$._audio_pre_subscribed=!0,F&&($._audioOrtc=F)),U&&($._videoSSRC=V,$._video_pre_subscribed=!0,F&&($._videoOrtc=F),null!=j&&($._rtxSsrcId=j)),Eb.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(V)),await this._p2pChannel.subscribe($,k,V,j,F);const ee=M?$._audioTrack:$._videoTrack;if(!ee)throw new Ib(iv.UNEXPECTED_ERROR,"can not find remote track in user");return M&&($._trust_audio_stream_added_state_=!0,$._audio_added_=!0),U&&($._trust_video_stream_added_state_=!0,$._video_added_=!0),ee}catch(k){throw Eb.error("[".concat(this._clientId,"] presub user ").concat(L," error"),k),k}finally{x()}}async _subscribeDataChannel(L,k){var M;if(Iy(k,"channelId",0,65535,!0),!this._joinInfo)throw new Ib(iv.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Ib(iv.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));const U=this._users.find((k=>k===L));if(!U)throw Eb.error("[".concat(this._clientId,"] can not subscribe ").concat(L.uid,", this user is not in the channel")),new Ib(iv.INVALID_REMOTE_USER,"user is not in the channel");if(!L.hasAudio&&!L.hasVideo&&0===L._dataChannels.length)throw Eb.error("[".concat(this._clientId,"] can not subscribe ").concat(L.uid,", user is not published")),new Ib(iv.INVALID_REMOTE_USER,"user is not published");const x=null===(M=L._dataChannels)||void 0===M?void 0:M.find((L=>L.id===k));if(!x)throw Eb.error("[".concat(this._clientId,"] can not subscribe ").concat(L.uid," with mediaType datachannel, remote datachannel is not published")),new Ib(iv.REMOTE_USER_IS_NOT_PUBLISHED);const V=await this._subscribeMutex.lock();Eb.info("[".concat(this._clientId,"] subscribe user ").concat(L.uid,", mediaType: datachannel"));try{const M=await this._p2pChannel.subscribeDataChannel(L,[x]);if(M&&Sr(M).call(M,x.id))try{var F;if("number"!=typeof x._originDataChannelId)throw Eb.error("[".concat(this._clientId,"] can not subscribe ").concat(L.uid," with mediaType datachannel, cannot get RTCDatachannel")),new Ib(iv.CREATE_DATACHANNEL_ERROR);const k={id:x.id,datachannelId:x._originDataChannelId,ordered:x.ordered,maxRetransmits:x.maxRetransmits,metadata:null!==(F=x.metadata)&&void 0!==F?F:""};await this._gateway.subscribeDataChannel(L.uid,k,!0),await x._waitTillOpen()}catch(k){if((null==k?void 0:k.code)!==iv.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(L,[x]),k;await this._p2pChannel.unsubscribeDataChannel(L,[x]),this._p2pChannel.setPendingRemoteDataChannel(L,x.id)}return Eb.info("[".concat(this._clientId,"] subscribe success user ").concat(L.uid,", mediaType: datachannel")),x}finally{V()}}async _p2pSubscribe(L,k,M){if(Cy(k,"mediaType",["audio","video"]),!this._joinInfo)throw new Ib(iv.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Ib(iv.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const U=this._users.find((k=>k===L));if(!U){const k=new Ib(iv.INVALID_REMOTE_USER,"user is not in the channel");throw Eb.error("[".concat(this._clientId,"] can not subscribe ").concat(L.uid,", this user is not in the channel")),k}if(!L.hasAudio&&!L.hasVideo){const k=new Ib(iv.INVALID_REMOTE_USER,"user is not published");throw Eb.error("[".concat(this._clientId,"] can not subscribe ").concat(L.uid,", user is not published")),k}if(!M&&("audio"===k&&!L.hasAudio||"video"===k&&!L.hasVideo)){const M=new Ib(iv.REMOTE_USER_IS_NOT_PUBLISHED);throw Eb.error("[".concat(this._clientId,"] can not subscribe ").concat(L.uid," with mediaType ").concat(k,", remote track is not published")),M}const x=await this._subscribeMutex.lock();Eb.info("[".concat(this._clientId,"] subscribe user ").concat(L.uid,", mediaType: ").concat(k));try{if(await this._p2pChannel.hasRemoteMediaWithLock(L,k))await this._p2pChannel.unmuteRemote(L,k);else try{const M="audio"===k?L._audioSSRC:L._videoSSRC,U="audio"===k?L._audioMid:L._videoMid;this.store.subscribe(L.uid,k,Date.now()),this._p2pChannel instanceof _F&&await this._p2pChannel.subscribe(L,k,M,U)}catch(L){throw L}Eb.info("[".concat(this._clientId,"] subscribe success user ").concat(L.uid,", mediaType: ").concat(k)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(L.uid,this._defaultStreamFallbackType).catch((L=>{Eb.warning("[".concat(this._clientId,"] auto set fallback failed"),L)}));const M="audio"===k?L._audioTrack:L._videoTrack;if(!M)throw new Ib(iv.UNEXPECTED_ERROR,"can not find remote track in user object");return M}catch(k){throw Eb.error("[".concat(this._clientId,"] subscribe user ").concat(L.uid," error"),k),k}finally{x()}}async _subscribe(L,k,M){if(this._p2pChannel instanceof _F)return this._p2pSubscribe(L,k);if(Cy(k,"mediaType",["audio","video"]),!this._joinInfo)throw new Ib(iv.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Ib(iv.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const U=this._users.find((k=>k===L));if(!U){const k=new Ib(iv.INVALID_REMOTE_USER,"user is not in the channel");throw Eb.error("[".concat(this._clientId,"] can not subscribe ").concat(L.uid,", this user is not in the channel")),k}if(!L.hasAudio&&!L.hasVideo){const k=new Ib(iv.INVALID_REMOTE_USER,"user is not published");throw Eb.error("[".concat(this._clientId,"] can not subscribe ").concat(L.uid,", user is not published")),k}if(!(M||("audio"!==k||L.hasAudio&&void 0!==L._audioSSRC)&&("video"!==k||L.hasVideo&&void 0!==L._videoSSRC))){const M=new Ib(iv.REMOTE_USER_IS_NOT_PUBLISHED);throw Eb.error("[".concat(this._clientId,"] can not subscribe ").concat(L.uid," with mediaType ").concat(k,", remote track is not published")),M}let x="audio"===k?L._audioSSRC:L._videoSSRC,V="audio"===k?L._audioOrtc:L._videoOrtc,F="video"===k?L._rtxSsrcId:void 0,j={stream_type:"audio"===k?nO.AUDIO:nO.VIDEO,ssrcId:x};const z=await this._subscribeMutex.lock();Eb.info("[".concat(this._clientId,"] subscribe user ").concat(L.uid,", mediaType: ").concat(k));try{if(await this._p2pChannel.hasRemoteMediaWithLock(L,k))await this._p2pChannel.unmuteRemote(L,k);else try{const U="audio"===k?L._audioSSRC:L._videoSSRC;void 0!==U&&U!==x&&(x=U,V="audio"===k?L._audioOrtc:L._videoOrtc,F="video"===k?L._rtxSsrcId:void 0,j={stream_type:"audio"===k?nO.AUDIO:nO.VIDEO,ssrcId:x}),Cx.markSubscribeStart(this.store.clientId,x),this.store.subscribe(L.uid,k,Date.now()),await this._p2pChannel.subscribe(L,k,x,F,V);try{this._p2pChannel.isPreSubScribe(x)||await this._gateway.subscribe(L.uid,j,!0)}catch(M){if((null==M?void 0:M.code)!==iv.WS_ABORT)throw await this._p2pChannel.unsubscribe(L,k),M;await this._p2pChannel.unsubscribe(L,k,!0),this._p2pChannel.setPendingRemoteMedia(L,k)}this.store.subscribe(L.uid,k,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,L,k)}catch(M){throw this._p2pChannel.reportSubscribeEvent(!1,null==M?void 0:M.code,L,k),M}Eb.info("[".concat(this._clientId,"] subscribe success user ").concat(L.uid,", mediaType: ").concat(k)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(L.uid,this._defaultStreamFallbackType).catch((L=>{Eb.warning("[".concat(this._clientId,"] auto set fallback failed"),L)}));const U="audio"===k?L._audioTrack:L._videoTrack;if(!U)throw new Ib(iv.UNEXPECTED_ERROR,"can not find remote track in user object");return U}catch(k){throw Eb.error("[".concat(this._clientId,"] subscribe user ").concat(L.uid," error"),k),k}finally{z()}}async massSubscribe(L){if(Ay(L,"subscribeList"),!this._joinInfo)throw new Ib(iv.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Ib(iv.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const k=Date.now(),M=new Map,U=await this._subscribeMutex.lock();Eb.info("[".concat(this._clientId,"]start massSubscribe user ").concat(L.map((L=>{let{user:k,mediaType:M}=L;return"user: ".concat(null==k?void 0:k.uid,", mediaType: ").concat(M)})).join("; ")));const x=(L=[...L]).map((L=>{let{user:k,mediaType:M}=L;return{user:k,mediaType:M}})),V=await this._p2pChannel.globalLock();try{var F;for(let k=L.length-1;k>=0;k--){const U=L[k],{user:V,mediaType:F}=U;if(Cy(F,"mediaType",["audio","video"]),!V){const L=new Ib(iv.INVALID_PARAMS,"user property does not exist in subscribeList item");throw Eb.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),L}const j=this._users.find((L=>L===V));if(!j){const M=new Ib(iv.INVALID_REMOTE_USER,"user is not in the channel");Eb.error("[".concat(this._clientId,"] can not massSubscribe ").concat(V.uid,", this user is not in the channel")),x[k].error=M,L.splice(k,1);continue}if("audio"===F&&(!V.hasAudio||void 0===V._audioSSRC)||"video"===F&&(!V.hasVideo||void 0===V._videoSSRC)){const M=new Ib(iv.REMOTE_USER_IS_NOT_PUBLISHED);Eb.error("[".concat(this._clientId,"] can not subscribe ").concat(V.uid," with mediaType ").concat(F,", remote user is not published")),x[k].error=M,L.splice(k,1);continue}const z=Qw.Video|Qw.LwoVideo,Q=M.get(V);if(Q){if("video"===F?Q&z:Q&Qw.Audio){L.splice(k,1),Eb.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(V.uid,", mediaType:").concat(F," twice"));continue}M.set(V,Q|("video"===F?z:Qw.Audio))}else M.set(V,"video"===F?z:Qw.Audio)}for(let k=L.length-1;k>=0;k--){const U=L[k],{user:x,mediaType:V}=U,F=Qw.Video|Qw.LwoVideo;if(this._p2pChannel.hasRemoteMedia(x,V)){await this._p2pChannel.unmuteRemoteNoLock(x,V);const U=M.get(x);M.set(x,"video"===V?U^F:U^Qw.Audio),L.splice(k,1)}}this.store.massSubscribe(L.map((L=>({userId:L.user.uid,type:L.mediaType}))),k);let j=kr(F=Array.from(M.entries())).call(F,((L,k)=>{let[M,U]=k;if(0===U)return L;const x={stream_id:M.uid,stream_type:U};return U&Qw.Audio&&(x.audio_ssrc=M._audioSSRC),U&Qw.Video&&(x.video_ssrc=M._videoSSRC),L.push(x),L}),[]);try{L.length>0&&await this._p2pChannel.massSubscribeNoLock(L.map((L=>{let{user:k,mediaType:M}=L;return{user:k,mediaType:M,ssrcId:M===nO.VIDEO?k._videoSSRC:k._audioSSRC,rtxSsrcId:M===nO.VIDEO?k._rtxSsrcId:void 0}})));const M=new Map;if(j=j.filter((L=>L.video_ssrc&&!this._p2pChannel.isPreSubScribe(L.video_ssrc)||L.audio_ssrc&&!this._p2pChannel.isPreSubScribe(L.audio_ssrc)||!L.video_ssrc&&!L.audio_ssrc)),j.length>0){const L=await this._gateway.subscribeAll(j,!0);((null==L?void 0:L.users)||[]).forEach((L=>{let{stream_id:k,video_error_code:U,audio_error_code:x,error_code:V}=L;(U||x||V)&&M.set(k,{video_error_code:U,audio_error_code:x,error_code:V})}))}if(Array.from(M.entries()).length>0){const L=[];Array.from(M.entries()).forEach((k=>{let[M,U]=k;const x=this.remoteUsers.find((L=>L.uid===M));if(x){let k;U.error_code||U.video_error_code&&U.audio_error_code?k=void 0:U.video_error_code?k=nO.VIDEO:U.audio_error_code&&(k=nO.AUDIO),L.push({user:x,mediaType:k})}})),L.length>0&&await this._p2pChannel.massUnsubscribeNoLock(L)}for(const L of x){const k=M.get(L.user.uid);if(k){const M=k.error_code||"audio"===L.mediaType&&k.audio_error_code||"video"===L.mediaType&&k.video_error_code;if(M){const k=wO(M);Eb.error("user:".concat(L.user.uid," mediaType:").concat(L.mediaType," has massSubscribe error ").concat(k.desc)),L.error=new Ib(iv.SUBSCRIBE_FAILED,"code ".concat(M,": ").concat(k.desc))}}L.error||("video"===L.mediaType?L.track=L.user.videoTrack:L.track=L.user.audioTrack)}return this.store.massSubscribe(x.filter((L=>!L.error)).map((L=>({userId:L.user.uid,type:L.mediaType}))),void 0,Date.now()),x.forEach((L=>{var M;Ab.subscribe(this.store.sessionId,{succ:!!L.error,ec:(null===(M=L.error)||void 0===M?void 0:M.code)||null,video:L.mediaType===nO.VIDEO,audio:L.mediaType===nO.AUDIO,peerid:L.user.uid,subscribeRequestid:L.mediaType===nO.VIDEO?L.user._videoSSRC:L.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-k),preSsrc:this._p2pChannel.isPreSubScribe(L.user._videoSSRC)},!0)})),Eb.info("[".concat(this._clientId,"] massSubscribe success ").concat(L.map((L=>{let{user:k,mediaType:M}=L;return"user: ".concat(null==k?void 0:k.uid,", mediaType: ").concat(M)})).join("; "))),x}catch(k){throw await this._p2pChannel.massUnsubscribeNoLock(L),k}}finally{V(),U()}}async unsubscribe(L,k,M){if(!(L instanceof sF)){const k=this.remoteUsers.find((k=>k.uid===L));if(!k)throw new Ib(iv.INVALID_REMOTE_USER,"user is not in the channel");L=k}if(k||this.store.useP2P){if("datachannel"===k)return this._unsubscribeDataChannel(L,M)}else await this._unsubscribeDataChannel(L,M);if(k&&Cy(k,"mediaType",["audio","video"]),!this._joinInfo)throw new Ib(iv.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");const U=this._users.find((k=>k===L));if(!U){const k=new Ib(iv.INVALID_REMOTE_USER,"user is not in the channel");throw Eb.error("[".concat(this._clientId,"] can not unsubscribe ").concat(L.uid,", user is not in the channel")),k}Eb.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(L.uid,", mediaType: ").concat(k));const x=await this._subscribeMutex.lock();try{if(this._p2pChannel instanceof _F)await this._p2pChannel.unsubscribe(L,k);else{const M=await this._p2pChannel.unsubscribe(L,k);M&&await this._gateway.unsubscribe(M,L.uid),k&&"audio"!==k||(L._audio_pre_subscribed=!1),k&&"video"!==k||(L._video_pre_subscribed=!1),L._is_pre_created&&tA(this._users,L),Eb.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(L.uid,", mediaType: ").concat(k))}}catch(k){if(k.code===iv.DISCONNECT_P2P)return void Eb.warning("disconnecting p2p, abort unsubscribe request.");throw Eb.error("[".concat(this._clientId,"] unsubscribe user ").concat(L.uid," error"),k.toString()),k}finally{x()}}async _unsubscribeDataChannel(L,k){if(k&&Iy(k,"id",0,65535,!0),!this._joinInfo)throw new Ib(iv.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");const M=this._users.find((k=>k===L));if(!M){const k=new Ib(iv.INVALID_REMOTE_USER,"user is not in the channel");throw Eb.error("[".concat(this._clientId,"] can not unsubscribe ").concat(L.uid,", user is not in the channel")),k}let U;if("number"==typeof k){const M=L._dataChannels.find((L=>L.id===k));M&&(U=[M])}else U=L._dataChannels;if(void 0===U){const M=new Ib(iv.REMOTE_USER_IS_NOT_PUBLISHED);throw Eb.error("[".concat(this._clientId,"] can not unsubscribe ").concat(L.uid," with channelId ").concat(k,", remote datachannel is not published")),M}Eb.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(L.uid,", mediaType: datachannel, ids: ").concat(U.map((L=>L.id))));try{const k=await this._p2pChannel.unsubscribeDataChannel(L,U);k&&await this._gateway.unsubscribeDataChannel(k,L.uid),Eb.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(L.uid,", mediaType: datachannel, ids: ").concat(k))}catch(k){if(k.code===iv.DISCONNECT_P2P)return void Eb.warning("disconnecting p2p, abort unsubscribe request.");throw Eb.error("[".concat(this._clientId,"] unsubscribe user ").concat(L.uid," error"),k.toString()),k}}async massUnsubscribe(L){if(Ay(L,"unsubscribeList"),!this._joinInfo)throw new Ib(iv.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");Eb.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(L.map((L=>{let{user:k,mediaType:M}=L;return"user: ".concat(null==k?void 0:k.uid,", mediaType: ").concat(M,";")})).join())),L=[...L];const k=new Map;for(let M=L.length-1;M>=0;M--){const{user:U,mediaType:x}=L[M];if(!U){const L=new Ib(iv.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw Eb.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),L}Cy(x,"mediaType",["video","audio",void 0]);const V=this._users.find((L=>L===U));if(!V){Eb.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(U.uid,", user is not in the channel")),L.splice(M,1);continue}const F=Qw.Video|Qw.LwoVideo;if(k.has(U)){const V=k.get(U);let j;switch(x){case"video":j=V&F;break;case"audio":j=V&Qw.Audio;break;default:j=V&(Qw.Audio|F)}if(j){Eb.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(U.uid,",mediaType:").concat(x," twice.")),L.splice(M,1);continue}x?"audio"===x?k.set(U,V|Qw.Audio):"video"===x&&k.set(U,V|F):k.set(U,V|Qw.Audio|F)}else x?"audio"===x?k.set(U,Qw.Audio):"video"===x&&k.set(U,F):k.set(U,Qw.Audio|F)}try{const k=await this._p2pChannel.massUnsubscribe(L);k&&await this._gateway.massUnsubscribe(k),Eb.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(L.map((L=>{let{user:k,mediaType:M}=L;return"user: ".concat(null==k?void 0:k.uid,", mediaType: ").concat(M,";")})).join()))}catch(L){if(L.code===iv.DISCONNECT_P2P)return void Eb.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw Eb.error("[".concat(this._clientId,"] massUnsubscribe error"),L.toString()),L}}async setLowStreamParameter(L){!function(L){if(!L)throw new nv(iv.INVALID_PARAMS);by(L.width)||vy(L.width,"streamParameter.width"),by(L.height)||vy(L.height,"streamParameter.height"),by(L.framerate)||vy(L.framerate,"streamParameter.framerate"),by(L.bitrate)||Iy(L.bitrate,"streamParameter.bitrate")}(L),(!L.width&&L.height||L.width&&!L.height)&&Eb.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),Eb.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(L));const k=this._configDistribute.getLowStreamConfigDistribute();if(k&&k.bitrate&&L.bitrate&&k.bitrate<L.bitrate&&(L.bitrate=k.bitrate),this._lowStreamParameter=L,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(L,cO.LocalVideoLowTrack)}async enableDualStream(){if(!XP().supportDualStream)throw Ab.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new Ib(iv.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new Ib(iv.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(L){throw Ab.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),L}this._isDualStreamEnabled=!0,Ab.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),Eb.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)throw new Ib(iv.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this._p2pChannel.getLocalMedia(cO.LocalVideoLowTrack))try{const L=await this._p2pChannel.unpublishLowStream();L&&await this._gateway.unpublish(L,this._joinInfo.stringUid||this._joinInfo.uid)}catch(L){throw Ab.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),L}this._isDualStreamEnabled=!1,Ab.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),Eb.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(L,k){if(function(L){Cy(L,"role",["audience","host"])}(L),k&&Ky(k),"rtc"===this.mode||"p2p"===this.mode)throw Eb.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new Ib(iv.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(k&&k.level&&"host"===L)throw new Ib(iv.INVALID_OPERATION,"host mode can not set audience latency level");if("audience"===L&&this._p2pChannel.hasLocalMedia())throw new Ib(iv.INVALID_OPERATION,"can not set client role to audience when publishing stream");await this._gateway.setClientRole(L,k),this._config.role=L,Eb.info("[".concat(this._clientId,"] set client role to ").concat(L,", level: ").concat(k&&k.level))}getRemoteInboundOffset(){var L;const k=null===(L=this._p2pChannel.getStats())||void 0===L?void 0:L.audioSend[0];if(!k||!k.timestamp)return 0;const M=k.timestamp-Date.now();return Math.abs(M)>1e3+k.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?M:0}getNtpWallTimeInMs(){return"visible"===document.visibilityState&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(L,k){if(yy(L,"proxyServer"),!k){if("DISCONNECTED"!==this.connectionState)throw new Ib(iv.INVALID_OPERATION,"Set proxy server before join channel");if("disabled"!==this._cloudProxyServerMode||this._useLocalAccessPoint)throw new Ib(iv.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=L,Ab.setProxyServer(this._proxyServer),Eb.setProxyServer(this._proxyServer),Eb.info("[".concat(this._clientId,"] Set proxy server ").concat(k?"by initialize call":""," success."))}setTurnServer(L,k){if(Array.isArray(L)||(L=[L]),!k){if("DISCONNECTED"!==this.connectionState)throw new Ib(iv.INVALID_OPERATION,"Set turn server before join channel");if("disabled"!==this._cloudProxyServerMode||this._useLocalAccessPoint)throw new Ib(iv.INVALID_OPERATION,"You have already set the proxy")}if(Wy(L))return this._turnServer={servers:L,mode:"original-manual"},void Eb.info("[".concat(this._clientId,"] Set original turnserver ").concat(k?"by initialize call":""," success: ").concat(L.map((L=>L.urls)).join(","),"."));L.forEach((L=>Hy(L))),this._turnServer={servers:L,mode:"manual"},Eb.info("[".concat(this._clientId,"] Set turnserver ").concat(k?"by initialize call":""," success."))}setLicense(L){if("DISCONNECTED"!==this.connectionState)throw new Ib(iv.INVALID_OPERATION,"you should set license before join channel");if(yy(L,"license",32,32),!/^[A-Za-z\d]+$/.test(L))throw new Ib(iv.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=L,Eb.info("[".concat(this._clientId,"] set license success"),L)}startProxyServer(L){if("DISCONNECTED"!==this.connectionState)throw new Ib(iv.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||"manual"===this._turnServer.mode||this._useLocalAccessPoint)throw new Ib(iv.INVALID_OPERATION,"You have already set the proxy");const k=[3,4,5];let M;switch(void 0===L&&(L=3),L){case 1:case 2:throw new Ib(iv.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:M="proxy3";break;case 4:M="proxy4";break;case 5:M="proxy5";break;default:throw new Ib(iv.INVALID_PARAMS,"proxy server mode must be ".concat(k.join("|")))}this._cloudProxyServerMode=M,this.store.cloudProxyServerMode=M,Eb.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if("DISCONNECTED"!==this.connectionState)throw new Ib(iv.INVALID_OPERATION,"Stop proxy server after leave channel");Ab.setProxyServer(),Eb.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",Eb.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(L){if(!L.accessPoints)throw new Ib(iv.INVALID_PARAMS,"accessPoints is required.");Ay(L.accessPoints.serverList,"accessPoints.serverList"),yy(L.accessPoints.domain,"accessPoints.domain");const t=(L,k)=>{Iy(L,k,0,65535,!0)};let k=443;if(L.accessPoints.port&&(t(L.accessPoints.port,"accessPoints.port"),k=L.accessPoints.port),this._proxyServer||"disabled"!==this._cloudProxyServerMode)throw new Ib(iv.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");zA("CLOSE_AFB_FOR_LOCAL_AP")&&(qA("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),qA("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const M=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,U=L.accessPoints.domain,x=L.accessPoints.serverList.map((L=>M.test(L)?"".concat(L.replace(/\./g,"-"),".").concat(U):L)),V=x.map((L=>"".concat(L,":").concat(k)));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,qA("WEBCS_DOMAIN",V),qA("WEBCS_DOMAIN_BACKUP_LIST",V),qA("GATEWAY_DOMAINS",[U]),L.report&&L.report.hostname&&Array.isArray(L.report.hostname)&&L.report.hostname.length?(Ay(L.report.hostname,"report.hostname"),qA("EVENT_REPORT_DOMAIN",L.report.hostname[0]),qA("EVENT_REPORT_BACKUP_DOMAIN",L.report.hostname[1]||L.report.hostname[0])):(qA("EVENT_REPORT_DOMAIN",x[0]),qA("EVENT_REPORT_BACKUP_DOMAIN",x[1]||x[0]));let F=6443;L.report&&L.report.port&&(t(L.report.port,"report.port"),F=L.report.port),qA("STATS_COLLECTOR_PORT",F),L.report?qA("ENABLE_EVENT_REPORT",!0):qA("ENABLE_EVENT_REPORT",!1);let j="";L.log&&L.log.hostname&&Array.isArray(L.log.hostname)&&L.log.hostname.length?(Ay(L.log.hostname,"log.hostname"),j=L.log.hostname[0]):j=x[0];let z=6444;L.log&&L.log.port&&(t(L.log.port,"log.port"),z=L.log.port),qA("LOG_UPLOAD_SERVER","".concat(j,":").concat(z));let Q=[];L.cds&&L.cds.hostname&&Array.isArray(L.cds.hostname)&&L.cds.hostname.length?(Ay(L.cds.hostname,"cds.hostname"),Q=L.cds.hostname):Q=x;let $=443;L.cds&&L.cds.port&&(t(L.cds.port,"cds.port"),$=L.cds.port),qA("CDS_AP",Q.map((L=>"".concat(L,":").concat($)))),L.cds?qA("ENABLE_CONFIG_DISTRIBUTE",!0):qA("ENABLE_CONFIG_DISTRIBUTE",!1),Eb.info("set local access point v2 success")}setLocalAccessPoints(L,k){if(Ay(L,"serverList"),yy(k,"domain"),this._proxyServer||"disabled"!==this._cloudProxyServerMode)throw new Ib(iv.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const M=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;L=L.map((L=>M.test(L)?"".concat(L.replace(/\./g,"-"),".").concat(k):L)),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,qA("WEBCS_DOMAIN",L),qA("WEBCS_DOMAIN_BACKUP_LIST",L),qA("GATEWAY_DOMAINS",[k]),qA("EVENT_REPORT_DOMAIN",L[0]),qA("EVENT_REPORT_BACKUP_DOMAIN",L[1]||L[0]),qA("LOG_UPLOAD_SERVER","".concat(L[0],":6444")),Eb.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(L){if(Cy(L,"streamType",[0,1,4,5,6,7,8,9]),this._remoteDefaultVideoStreamType=L,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(L),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(L){throw Eb.error("[".concat(this._clientId,"] set default remote video stream type error"),L.toString()),L}else Eb.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(L))}async setRemoteVideoStreamType(L,k){Cy(k,"streamType",[0,1,4,5,6,7,8,9]);try{await this._gateway.setRemoteVideoStreamType(L,k),setTimeout((()=>{const k=this._users.find((k=>k.uid===L));k&&k.videoTrack&&k.videoTrack.updateMediaStreamTrackResolution()}),2e3)}catch(L){throw Eb.error("[".concat(this._clientId,"] set remote video stream type error"),L.toString()),L}Eb.info("[".concat(this._clientId,"] set remote ").concat(L," video stream type to ").concat(k)),this._remoteStreamTypeCacheMap.set(L,k)}async setStreamFallbackOption(L,k){Cy(k,"fallbackType",[0,1,2,3,4,5,6,7,8]);try{await this._gateway.setStreamFallbackOption(L,k)}catch(L){throw Eb.error("[".concat(this._clientId,"] set stream fallback option"),L.toString()),L}Eb.info("[".concat(this._clientId,"] set remote ").concat(L," stream fallback type to ").concat(k)),this._streamFallbackTypeCacheMap.set(L,k)}setEncryptionConfig(L,k,M,U){!function(L){Cy(L,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"])}(L),yy(k,"secret");const x=["aes-128-gcm2","aes-256-gcm2"];if(Sr(x).call(x,L)){if(!M||!(M instanceof Uint8Array&&32===M.length))throw new Ib(iv.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(M)throw new Ib(iv.INVALID_PARAMS,"current encrypt mode does not need salt");if(U){if(Ry(U,"encryptDataStream"),!Sr(x).call(x,L))throw new Ib(iv.INVALID_PARAMS,"current encrypt mode does not support data stream");this._encryptDataStream=!0}new RegExp("^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'\"|{}\\[\\]])(?=.{8,})").test(k)||Eb.warning("The secret is not strong:\n      The secret must contain at least 1 lowercase alphabetical character,\n      The secret must contain at least 1 uppercase alphabetical character,\n      The secret must contain at least 1 numeric character,\n      The secret must contain at least one special character,\n      The secret must be eight characters or longer.\n      "),this._encryptionMode=L,this._encryptionSecret=k,M&&(this._encryptionSalt=dA(M))}async renewToken(L){if(yy(L,"token",1,2047),!this._key||!this._joinInfo)throw new Ib(iv.INVALID_OPERATION,"renewToken should not be called before user join");const k=this._key;this._key=L,this._joinInfo&&(this._joinInfo.token=L);const M=await this._renewTokenMutex.lock();try{if(zA("USE_NEW_TOKEN")){Eb.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));const k=await Xx(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Ov);Eb.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:L,ticket:k})}else Eb.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:L});Eb.debug("[".concat(this._clientId,"] renewToken success"))}catch(L){throw this._key=k,this._joinInfo.token=k,Eb.error("[".concat(this._clientId,"] renewToken failed"),L.toString()),L}finally{M()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?Eb.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval((()=>{const L=this._p2pChannel.getAudioLevels();this.safeEmit(pv.VOLUME_INDICATOR,L)}),zA("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const L=this._statsCollector.getRTCStats(),k=this._gateway.getInChannelInfo();return L.Duration=Math.round(k.duration/1e3),L}async startLiveStreaming(L,k){if(!k){if("h264"!==this.codec)throw new Ib(iv.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new Ib(iv.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(L)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(L))throw new Ib(iv.LIVE_STREAMING_TASK_CONFLICT);const M=k?Lw.TRANSCODE:Lw.RAW;return this._createLiveStreamingClient(M).startLiveStreamingTask(L,M)}setLiveTranscoding(L){return this._createLiveStreamingClient(Lw.TRANSCODE).setTranscodingConfig(L)}async stopLiveStreaming(L){const k=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter((k=>k&&k.hasUrl(L)));if(!k.length)throw new Ib(iv.INVALID_PARAMS,"can not find live streaming url to stop");await Mp.all(k.map((k=>k&&k.stopLiveStreamingTask(L))))}async startChannelMediaRelay(L){DF(L);const k=this._createChannelMediaRelayClient();await k.startChannelMediaRelay(L)}async updateChannelMediaRelay(L){DF(L);const k=this._createChannelMediaRelayClient();await k.updateChannelMediaRelay(L)}async stopChannelMediaRelay(){const L=this._createChannelMediaRelayClient();await L.stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}async sendStreamMessage(L){var k;let M=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!this._joinInfo)throw new Ib(iv.INVALID_OPERATION,"can not send data stream, not joined");if(("string"==typeof L||L instanceof Uint8Array)&&(L={payload:L}),"string"==typeof L.payload){const k=new TextEncoder;L.payload=k.encode(L.payload)}let U=!1;if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&Sr(k=["aes-128-gcm2","aes-256-gcm2"]).call(k,this._encryptionMode)&&(U=!0,L.payload=await async function(L,k,M){var U;const x=kr(U=Array.from(M)).call(U,((L,k)=>L+k),0),V={serverTs:0,seq:ab++,length:M.length,checkSum:x},F=new Uint8Array(IA(x,2)),j=new ArrayBuffer(nb),z=new DataView(j);z.setUint32(0,V.serverTs),z.setUint16(4,V.seq),z.setUint16(6,V.length),z.setUint16(8,V.checkSum);const Q=16-M.length%16;M=uA(M,new Uint8Array(Q));const $=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:L,tagLength:128,additionalData:F},k,M);return uA(new Uint8Array(j),new Uint8Array($))}(this._encryptDataStreamIv,this._encryptDataStreamKey,L.payload)),new Blob([L.payload]).size>1024)throw new Ib(iv.INVALID_PARAMS,U?"encrypted stream message out of range.":"stream message out of range.");return this._gateway.signal.request(ww.DATA_STREAM,{payload:dA(L.payload),syncWithAudio:L.syncWithAudio,sendTs:Date.now()-GF},!M)}sendMetadata(L){if(!this._joinInfo)throw new Ib(iv.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([L]).size>1024)throw new Ib(iv.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(ww.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:dA(L)})}async sendCustomReportMessage(L){if(Array.isArray(L)||(L=[L]),L.forEach(fb),!this._joinInfo)throw new Ib(iv.INVALID_OPERATION,"can not send custom report, not joined");await Ab.sendCustomReportMessage(this._joinInfo.sid,L)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){return this._statsCollector.getRemoteNetworkQualityStats()}async pickSVCLayer(L,k){Cy(k.spatialLayer,"spatialLayer",[0,1,2,3]),Cy(k.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(L,k)}catch(L){throw Eb.error("[".concat(this._clientId,"] pick SVC layer failed"),L.toString()),L}}async setRTMConfig(L){const{apRTM:k=!1,rtmFlag:M}=L;if(Ry(k,"apRTM"),Iy(M,"rtmFlag",0),this._rtmConfig.apRTM=k,this._rtmConfig.rtmFlag=M,Eb.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(L)," in ").concat(this.connectionState," state")),("CONNECTED"===this.connectionState||"RECONNECTING"===this.connectionState)&&this._joinInfo)return this._joinInfo.apRTM=k,this._joinInfo.rtmFlag=M,this._gateway.setRTM2Flag(M)}_reset(){if(Eb.debug("[".concat(this._clientId,"] reset client")),this._axiosCancelSource.cancel(),this._axiosCancelSource=KC.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo&&qB(this._joinInfo),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId&&Ab.removeSid(this._sessionId),this._sessionId=null,this.store.sessionId=null,this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._pendingPublishedUsers=[],this._users.forEach((L=>{L._audioTrack&&L._audioTrack._destroy(),L._videoTrack&&L._videoTrack._destroy(),L._dataChannels&&(L._dataChannels.forEach((L=>L._close())),L._dataChannels.length=0)})),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),"fallback"===this._cloudProxyServerMode&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new wv("client-publish"),this._subscribeMutex=new wv("client-subscribe"),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch(L){}if(this._moderation)try{this.setImageModeration(!1)}catch(L){}}_startSession(L,k){var M;const U=L||mA();L?Eb.debug("[".concat(this._clientId,"] new Session ").concat(U)):Eb.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(U));const x=L?"":this._sessionId||"";this._sessionId=U,this.store.sessionId=U,Ab.addSid(U);const V={lts:(new Date).getTime(),mode:this.mode,buildFormat:1,stringUid:(null==k?void 0:k.stringUid)||(null===(M=this._joinInfo)||void 0===M?void 0:M.stringUid),channelProfile:"live"===this.mode?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:x,clientRole:"audience"===this.role?2:1};Ab.sessionInit(this._sessionId,RG({cname:k.channel,appid:k.appId},V)),this._joinInfo&&(this._joinInfo.sid=U),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=U)}async _publishHighStream(L){if(!this._joinInfo||void 0===this._uid)throw new Ib(iv.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Ib(iv.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if("auto"===this._turnServer.mode&&zA("FORCE_TURN")&&!zA("TURN_ENABLE_TCP")&&!zA("TURN_ENABLE_UDP"))throw new Ib(iv.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");Eb.debug("[".concat(this._clientId,"] publish high stream"));try{const M=await this._p2pChannel.publish(L,this._isDualStreamEnabled,this._lowStreamParameter);if(this._p2pChannel instanceof _F){const k=(await M.next()).value;if(k){try{await this._gateway.sendExtensionMessage(TO.PUBLISH,k,!0)}catch(L){throw M.throw(L),L}await M.next()}this._p2pChannel.reportPublishEvent(!0,null)}else{const U=(await M.next()).value;if(U){var k;let x;try{x=await this._gateway.publish(this._uid,U,!0)}catch(L){if(L.code!==iv.DISCONNECT_P2P)throw M.throw(L),L}await M.next((null===(k=x)||void 0===k?void 0:k.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(const k of L)k instanceof eU&&k._encoderConfig&&this._gateway.setVideoProfile(k._encoderConfig),!k.muted&&k.enabled||await this._p2pChannel.muteLocalTrack(k)}}catch(k){if(this._p2pChannel.reportPublishEvent(!1,null==k?void 0:k.code,L),(null==k?void 0:k.code)===iv.WS_ABORT)return;throw k}}async _publishLowStream(){if(!this._joinInfo||void 0===this._uid)throw new Ib(iv.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Ib(iv.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));Eb.debug("[".concat(this._clientId,"] publish low stream"));const L=this._configDistribute.getLowStreamConfigDistribute();L&&L.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&L.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=L.bitrate));try{const L=await this._p2pChannel.publishLowStream(this._lowStreamParameter),M=(await L.next()).value;if(M){var k;let U;try{U=await this._gateway.publish(this._uid,M,!0)}catch(k){if(k.code!==iv.DISCONNECT_P2P)throw L.throw(k),k}L.next((null===(k=U)||void 0===k?void 0:k.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(L){if(this._p2pChannel.reportPublishEvent(!1,null==L?void 0:L.code,void 0,!0),(null==L?void 0:L.code)===iv.WS_ABORT)return;throw L}}_createLiveStreamingClient(L){const t=()=>{if(!this._joinInfo||!this._appId)return new Ib(iv.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();const L=(k={joinInfo:this._joinInfo,appId:this._appId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig},TB("LiveStreaming").create(k));var k;return L.onLiveStreamError=(L,k)=>{Ab.reportApiInvoke(this._sessionId,{name:dv.ON_LIVE_STREAM_ERROR,options:[L,k],tag:lv.TRACER}).onSuccess(),this.safeEmit(pv.LIVE_STREAMING_ERROR,L,k)},L.onLiveStreamWarning=(L,k)=>{Ab.reportApiInvoke(this._sessionId,{name:dv.ON_LIVE_STREAM_WARNING,options:[L,k],tag:lv.TRACER}).onSuccess(),this.safeEmit(pv.LIVE_STREAMING_WARNING,L,k)},L.on(jw.REQUEST_WORKER_MANAGER_LIST,((L,k,M)=>{if(!this._joinInfo)return M(new Ib(iv.INVALID_OPERATION,"can not find join info to get worker manager"));(async function(L,k,M,U){const x=zA("UAP_AP").slice(0,zA("AJAX_REQUEST_CONCURRENT")).map((L=>k.proxyServer?"https://".concat(k.proxyServer,"/ap/?url=").concat(L+"/api/v1?action=uap"):"https://".concat(L,"/api/v1?action=uap")));return await function Ox(L,k,M,U,x){_x+=1;const V={sid:M.sid,command:"convergeAllocateEdge",uid:"666",appId:M.appId,ts:Math.floor(Date.now()/1e3),seq:_x,requestId:_x,version:Mv,cname:M.cname},F={service_name:k,json_body:JSON.stringify(V)};let j,z,Q=L[0];return PA((async()=>{j=Date.now();const L=await fx(Q,{data:F,cancelToken:U,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(z=Date.now()-j,0!==L.code){const k=new Ib(iv.UNEXPECTED_RESPONSE,"live streaming ap error, code"+L.code,{retry:!0,responseTime:z});throw Eb.error(k.toString()),k}const M=JSON.parse(L.json_body);if(200!==M.code){const L=new Ib(iv.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(M.code,", reason: ").concat(M.reason),{code:M.code,responseTime:z});throw Eb.error(L.toString()),L}if(!M.servers||0===M.servers.length){const L=new Ib(iv.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:M.code,responseTime:z});throw Eb.error(L.toString()),L}const x=function(L,k){return{addressList:L.servers.map((L=>"wss://".concat(L.address.replace(/\./g,"-"),".").concat(zA("WORKER_DOMAIN"),":").concat(L.wss,"?serviceName=").concat(encodeURIComponent(k)))),workerToken:L.workerToken,vid:L.vid}}(M,k);return zA("LIVE_STREAMING_ADDRESS")&&(x.addressList=zA("LIVE_STREAMING_ADDRESS")instanceof Array?zA("LIVE_STREAMING_ADDRESS"):[zA("LIVE_STREAMING_ADDRESS")]),bx(bx({},x),{},{responseTime:z})}),((U,x)=>(Ab.apworkerEvent(M.sid,{success:!0,sc:200,serviceName:k,responseDetail:JSON.stringify(U.addressList),firstSuccess:0===x,responseTime:z,serverIp:L[x%L.length]}),!1)),((U,x)=>(Ab.apworkerEvent(M.sid,{success:!1,sc:U.data&&U.data.code||200,serviceName:k,responseTime:z,serverIp:L[x%L.length]}),!!(U.code!==iv.OPERATION_ABORTED&&U.code!==iv.UNEXPECTED_RESPONSE||U.data&&U.data.retry)&&(Q=L[(x+1)%L.length],!0))),x)}(x,L,k,M,U)})(L,this._joinInfo,this._axiosCancelSource.token,Ov).then(k).catch(M)})),L};return L===Lw.RAW?(this._liveRawStreamingClient=this._liveRawStreamingClient||t(),this._liveRawStreamingClient):(this._liveTranscodeStreamingClient=this._liveTranscodeStreamingClient||t(),this._liveTranscodeStreamingClient)}_createChannelMediaRelayClient(){if(!this._joinInfo)return new Ib(iv.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){const{sendResolutionWidth:k,sendResolutionHeight:M}=this.getLocalVideoStats(),U=(L={joinInfo:this._joinInfo,clientId:this._clientId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig,resolution:{width:k,height:M}},TB("ChannelMediaRelay").create(L));U.on("state",(L=>{L===zw.RELAY_STATE_FAILURE&&U&&U.dispose(),this.safeEmit(pv.CHANNEL_MEDIA_RELAY_STATE,L)})),U.on("event",(L=>{this.safeEmit(pv.CHANNEL_MEDIA_RELAY_EVENT,L)})),this._channelMediaRelayClient=U,this._statsCollector.onStatsChanged=(L,k)=>{var M;"resolution"===L&&(null===(M=this._channelMediaRelayClient)||void 0===M||M.setVideoProfile(k))}}var L;return this._channelMediaRelayClient}_handleUpdateDataChannel(L,k){const{added:M,deleted:U}=L,x=[];if(k){const L=[];this._users.forEach((k=>{k._dataChannels.forEach((U=>{M.every((L=>L.uid!==k._uintid||L.stream_id!==U.id))&&L.push({uid:k._uintid,stream_id:U.id,ordered:U.ordered,max_retrans_times:U.maxRetransmits,metadata:U.metadata})}))})),L.length>0&&this._handleUpdateDataChannel({added:[],deleted:L})}Array.isArray(M)&&M.length>0&&M.forEach((L=>{const{uid:M,stream_id:U,ordered:V,max_retrans_times:F,metadata:j}=L,z=this._users.find((L=>L._uintid===M));if(z){if(Eb.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(M)),Sr(x).call(x,z)||x.push(z),z._uintid||(z._uintid=M),-1===z._dataChannels.findIndex((k=>k.id===L.stream_id))){const L={id:U,ordered:!!V,maxRetransmits:F,metadata:j},M=function(L){return SB(L,!0)}(L);z._dataChannels.push(M),Eb.info("[".concat(this._clientId,"] remote user ").concat(z.uid," published datachannel")),k||this.safeEmit(pv.USER_PUBLISHED,z,"datachannel",L)}this._p2pChannel.hasPendingRemoteDataChannel(z,L.stream_id)&&(Eb.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(z.uid," after reconnect.")),this._subscribeDataChannel(z,L.stream_id).catch((L=>{Eb.error("[".concat(this._clientId,"] resubscribe datachannel error"),L.toString())})))}else Eb.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"))})),k&&(this.safeEmit(pv.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(U)&&U.length>0&&U.forEach((L=>{const{uid:k,stream_id:M}=L,U=this._users.find((L=>L._uintid===k));if(!U)return void Eb.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));const x=U._dataChannels.find((k=>k.id===L.stream_id));x&&(Eb.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(k)),this._p2pChannel.unsubscribeDataChannel(U,[x]).then((L=>{if(U._dataChannels=U._dataChannels.filter((L=>L!==x)),L)return this._gateway.unsubscribeDataChannel(L,U.uid)})),Eb.info("[".concat(this._clientId,"] remote user ").concat(k," unpublished datachannel ,id:").concat(x.id)),this.safeEmit(pv.USER_UNPUBLISHED,U,"datachannel",x._config))}))}_handleRemoveDataChannels(L){const k=this._users.find((k=>k.uid===L.uid));if(k){if(void 0!==k._dataChannels&&k._dataChannels.length>0){Eb.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(L.uid));const i=()=>{Eb.info("[".concat(this._clientId,"] remote user ").concat(k.uid," unpublished datachannel")),k._dataChannels.forEach((L=>{this.safeEmit(pv.USER_UNPUBLISHED,k,"datachannel",L._config)}))};this._p2pChannel.unsubscribeDataChannel(k,k._dataChannels).then((L=>{if(L)return this._gateway.unsubscribeDataChannel(L,k.uid)})),i()}}else Eb.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(Xw.DISCONNECT_P2P,(async()=>{await this._p2pChannel.disconnectForReconnect()})),this._gateway.on(Xw.CONNECTION_STATE_CHANGE,((L,k,M)=>{var U;if(M===hv.FALLBACK)return;const r=()=>{this.safeEmit(pv.CONNECTION_STATE_CHANGE,L,k,M)};if(Ab.reportApiInvoke(this._sessionId||(null===(U=this._gateway.joinInfo)||void 0===U?void 0:U.sid)||null,{name:dv.CONNECTION_STATE_CHANGE,options:[L,k,M],tag:lv.TRACER}).onSuccess(JSON.stringify({cur:L,prev:k,reason:M})),Eb.info("[".concat(this._clientId,"] connection state change: ").concat(k," -> ").concat(L)),"DISCONNECTED"===L)return this._reset(),void r();if("RECONNECTING"===L)this._users.forEach((L=>{L._trust_in_room_=!1,L._trust_audio_enabled_state_=!1,L._trust_video_enabled_state_=!1,L._trust_audio_mute_state_=!1,L._trust_video_mute_state_=!1,L._trust_audio_stream_added_state_=!1,L._trust_video_stream_added_state_=!1,L._is_pre_created||(L._audio_pre_subscribed||(L._audioSSRC=void 0,L._audioOrtc=void 0),L._video_pre_subscribed||(L._videoSSRC=void 0,L._videoOrtc=void 0,L._rtxSsrcId=void 0),L._cname=void 0)})),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if("CONNECTED"===L){var x;this._streamFallbackTypeCacheMap.forEach(((L,k)=>{this._gateway.setStreamFallbackOption(k,L).catch((L=>{Eb.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),L)}))})),this._remoteStreamTypeCacheMap.forEach(((L,k)=>{this._gateway.setRemoteVideoStreamType(k,L).catch((L=>{Eb.warning("[".concat(this._clientId,"] auto set remote stream type failed"),L)}))})),void 0!==this._remoteDefaultVideoStreamType&&void 0===(null===(x=this._joinInfo)||void 0===x?void 0:x.defaultVideoStream)&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then((()=>{Eb.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))})).catch((L=>{Eb.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(L))})),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout((()=>{"CONNECTED"===this.connectionState&&(this._userOfflineTimeout=void 0,this._users.filter((L=>!L._trust_in_room_)).forEach((L=>{Eb.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(L.uid)),this._handleUserOffline({uid:L.uid})})))}),3e3),this._streamRemovedTimeout=window.setTimeout((()=>{"CONNECTED"===this.connectionState&&(this._streamRemovedTimeout=void 0,this._users.forEach((L=>{L._trust_audio_mute_state_||(Eb.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(L.uid)),this._handleMuteStream(L.uid,nO.AUDIO,!1)),L._trust_video_mute_state_||(Eb.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(L.uid)),this._handleMuteStream(L.uid,nO.VIDEO,!1)),L._trust_audio_enabled_state_||(Eb.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(L.uid)),this._handleSetStreamLocalEnable("audio",L.uid,!0)),L._trust_video_enabled_state_||(Eb.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(L.uid)),this._handleSetStreamLocalEnable("video",L.uid,!0)),L._trust_video_stream_added_state_||(Eb.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(L.uid)),this._handleResetAddStream(L,"video")),L._trust_audio_stream_added_state_||(Eb.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(L.uid)),this._handleResetAddStream(L,"audio")),L._video_added_||L._audio_added_||(Eb.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(L.uid)),this._handleRemoveStream({uid:L.uid,uint_id:L._uintid}))})))}),1e3))}r()})),this._gateway.on(Xw.REQUEST_NEW_GATEWAY_LIST,(async(L,k)=>{if(!this._joinInfo)return k(new Ib(iv.UNEXPECTED_ERROR,"can not recover, no join info"));try{let k;const M=await HB(RG(RG({},this._joinInfo),{},{uid:this._joinInfo.uid,stringUid:void 0}));M?(k=M.ap,zB(M),this._joinInfo.preload=!0):(k=await Gx(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Ov,this.store),this._joinInfo.preload=!1),this._joinInfo&&(this._joinInfo.apResponse=k.gatewayInfo.res,this._joinInfo.gatewayAddrs=k.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=k.gatewayInfo.uni_lbs_ip);const U=[];k.gatewayInfo.gatewayAddrs.forEach((L=>{let{address:k}=L;const[M,x]=k.split(":");this._joinInfo&&this._joinInfo.proxyServer?U.push({proxy:this._joinInfo.proxyServer,host:M,port:x}):U.push({host:M,port:x})})),L(U)}catch(L){k(L)}})),this._gateway.on(Xw.NETWORK_QUALITY,(L=>{"normal"===this._networkQualitySensitivity&&this.safeEmit(pv.NETWORK_QUALITY,L)})),this._gateway.on(Xw.STREAM_TYPE_CHANGE,((L,k)=>{this.safeEmit(pv.STREAM_TYPE_CHANGED,L,k),Ab.reportApiInvoke(this._sessionId,{name:dv.STREAM_TYPE_CHANGE,options:[L,k],tag:lv.TRACER}).onSuccess(JSON.stringify({uid:L,streamType:k}))})),this._gateway.on(Xw.IS_P2P_DISCONNECTED,(L=>{this._p2pChannel.isP2PDisconnected()?L(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?L(!1):L(!0)})),this._gateway.on(Xw.REQUEST_P2P_CONNECTION_PARAMS,(async(L,k,M)=>{try{let M=await this._p2pChannel.getEstablishParams();zA("ENABLE_PREALLOC_PC")&&M||(M=await this._p2pChannel.startP2PConnection(L)),k(M)}catch(L){M(L)}})),this._gateway.on(Xw.JOIN_RESPONSE,((L,k)=>{if(this.store.useP2P)return;const M=HU(L.ortc,k,L.attributes.userAttributes.preSubSsrcs);this._p2pChannel.connect(M)})),this._gateway.on(Xw.PRE_CONNECT_PC,(async L=>{const{candidates:k,fingerprint:M}=L;if(this._joinInfo&&k.length>0&&!this._p2pChannel.isPlanB){var U;await this._p2pChannel.startP2PConnection({turnServer:this._joinInfo.turnServer});const{cert:L,cid:x}=this._joinInfo.apResponse;await this._p2pChannel.connect({iceParameters:{iceUfrag:"".concat(x,"_").concat(L),icePwd:"".concat(x,"_").concat(L)},dtlsParameters:{fingerprints:[{hashFunction:"sha-256",fingerprint:null!==(U=zA("FINGERPRINT"))&&void 0!==U?U:M}]},candidates:k,rtpCapabilities:{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},setup:"active",cname:"o/i14u9pJrxRKAsu",preallocation:!0})}}))}_handleGatewaySignalEvents(){this._gateway.signal.on(Nw.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(Nw.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(Nw.ON_ADD_AUDIO_STREAM,(L=>this._handleAddAudioOrVideoStream("audio",L.uid,L.ssrcId,L.cname,L.uint_id,L.ortc))),this._gateway.signal.on(Nw.ON_ADD_VIDEO_STREAM,(L=>this._handleAddAudioOrVideoStream("video",L.uid,L.ssrcId,L.cname,L.uint_id,L.ortc,L.rtxSsrcId))),this._gateway.signal.on(Nw.ON_REMOTE_DATASTREAM_UPDATE,(L=>{this._handleUpdateDataChannel(L)})),this._gateway.signal.on(Nw.ON_REMOTE_FULL_DATASTREAM_INFO,(L=>{this._handleUpdateDataChannel({added:L.datastreams||[],deleted:[]},!0)})),this._gateway.signal.on(Nw.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(Nw.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(Nw.MUTE_AUDIO,(L=>this._handleMuteStream(L.uid,nO.AUDIO,!0))),this._gateway.signal.on(Nw.UNMUTE_AUDIO,(L=>this._handleMuteStream(L.uid,nO.AUDIO,!1))),this._gateway.signal.on(Nw.MUTE_VIDEO,(L=>this._handleMuteStream(L.uid,nO.VIDEO,!0))),this._gateway.signal.on(Nw.UNMUTE_VIDEO,(L=>this._handleMuteStream(L.uid,nO.VIDEO,!1))),this._gateway.signal.on(Nw.RECEIVE_METADATA,(L=>{const k=cA(L.metadata);this.safeEmit(pv.RECEIVE_METADATA,L.uid,k)})),this._gateway.signal.on(Nw.ON_DATA_STREAM,(async L=>{var k;if(!L)return;let M=cA(L.payload);if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&Sr(k=["aes-128-gcm2","aes-256-gcm2"]).call(k,this._encryptionMode)){if(L.payload.length<nb)throw new Ib(iv.UNEXPECTED_RESPONSE,"payload length ".concat(L.payload.length," is less than header length ").concat(nb));const k=await async function(L,k,M){const U=M.subarray(0,nb),x=U.slice(8,nb),V=(x[0]<<8)+x[1],F=(U[6]<<8)+U[7],j=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:L,tagLength:128,additionalData:new Uint8Array(IA(V,2))},k,M.subarray(nb));return new Uint8Array(j).subarray(0,F)}(this._encryptDataStreamIv,this._encryptDataStreamKey,M);M=k}let U=0;if(L.ordered||L.syncWithAudio){const k=this._p2pChannel.getStats(),M=this.remoteUsers.find((k=>k.uid===L.uid)),x=null==k?void 0:k.audioRecv.find((L=>L.ssrc===(null==M?void 0:M._audioSSRC)));U=null==x?void 0:x.jitterBufferMs}null==U&&(U=0),function wB(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,M=arguments.length>2?arguments[2]:void 0;if(!L.syncWithAudio)return bB(M,{uid:L.uid,payload:L.payload});const U="".concat(M.id,"-").concat(L.uid),x=zF.get(U)||[],V=x.findIndex((k=>L.sendTs>=k.sendTs)),F=RB(RB({},L),{},{context:M,mediaDelay:k,recvTs:Date.now()});-1===V?x.push(F):x.splice(V,0,F),zF.set(U,x);let j=!1;var z;YF.has(U)?j=!(null===(z=YF.get(U))||void 0===z||!z.isSyncing):YF.set(U,{isSyncing:j,firstRecvTs:0,firstSendTs:0}),j||AB(U)}(RG(RG({},L),{},{payload:M}),U,{id:this._clientId,onStreamMessage:"function"==typeof this.onStreamMessage?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})})),this._gateway.signal.on(Nw.ON_CRYPT_ERROR,(()=>{aA((()=>{Eb.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(pv.CRYPT_ERROR)}),this._sessionId)})),this._gateway.signal.on(Nw.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(Nw.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{Eb.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,hv.TOKEN_EXPIRE),this.safeEmit(pv.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()})),this._gateway.signal.on(Nw.ON_STREAM_FALLBACK_UPDATE,(L=>{Eb.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(L.stream_id,", attr: ").concat(L.stream_type)),this.safeEmit(pv.STREAM_FALLBACK,L.stream_id,1===L.stream_type?"fallback":"recover")})),this._gateway.signal.on(Nw.ON_PUBLISH_STREAM,(L=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:L.proxy})),Eb.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(L))))})),this._gateway.signal.on(Nw.ENABLE_LOCAL_VIDEO,(L=>{this._handleSetStreamLocalEnable("video",L.uid,!0)})),this._gateway.signal.on(Nw.DISABLE_LOCAL_VIDEO,(L=>{this._handleSetStreamLocalEnable("video",L.uid,!1)})),this._gateway.signal.on(bw.REQUEST_TIMEOUT,((L,k)=>{if(this._joinInfo)switch(L){case ww.PUBLISH:{if(!k)return;const L=k.ortc;if(L){var M,U;const x=L.some((L=>{let{stream_type:k}=L;return k===qw.Audio})),V=L.some((L=>{let{stream_type:k}=L;return k!==qw.Audio})),F=L.some((L=>{let{stream_type:k}=L;return k===qw.Screen||k===qw.ScreenLow}));"offer"===k.state&&Ab.publish(this._joinInfo.sid,{eventElapse:Cx.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:iv.TIMEOUT,audio:x,video:V,p2pid:k.p2p_id,publishRequestid:this.store.pubId,screenshare:F,audioName:x?null===(M=L.find((L=>{let{stream_type:k}=L;return k===qw.Audio})))||void 0===M||null===(M=M.ssrcs[0])||void 0===M?void 0:M.ssrcId.toString():void 0,videoName:V?null===(U=L.find((L=>{let{stream_type:k}=L;return k!==qw.Audio})))||void 0===U||null===(U=U.ssrcs[0])||void 0===U?void 0:U.ssrcId.toString():void 0})}break}case ww.SUBSCRIBE:k&&Ab.subscribe(this._joinInfo.sid,{succ:!1,ec:iv.TIMEOUT,audio:k.stream_type===nO.AUDIO,video:k.stream_type===nO.VIDEO,peerid:k.stream_id,subscribeRequestid:k.ssrcId,p2pid:this.store.p2pId,eventElapse:Cx.measureFromSubscribeStart(this.store.clientId,k.ssrcId),preSsrc:this._p2pChannel.isPreSubScribe(k.ssrcId)})}})),this._gateway.signal.on(Nw.ON_P2P_OK,(L=>{this.uid,this._uid})),this._gateway.signal.on(Nw.ON_PUBLISHED_USER_LIST,(L=>{if(null==L||!L.users)return;zA("BLOCK_LOCAL_CLIENT")&&(L.users=L.users.filter((L=>!bb(L.string_id||L.stream_id,this.channelName))));const k=[],M=[];for(const U of L.users){let L=this._users.find((L=>L._uintid===U.stream_id));L?L._trust_in_room_=!0:(L=new sF(U.string_id||U.stream_id,U.stream_id),this._users.push(L),0===this.getListeners(pv.PUBLISHED_USER_LIST).length&&(Eb.debug("[".concat(this._clientId,"] user online"),U.stream_id),this.safeEmit(pv.USER_JOINED,L)));const x=Qw.Audio&U.stream_type,V=(Qw.Video|Qw.LwoVideo)&U.stream_type,F=0!=(65280&U.stream_type),j=x&&L.hasAudio,z=V&&L.hasVideo;V&&(L._trust_video_stream_added_state_=!0,L._video_added_=!0,L._videoSSRC=U.video_ssrc,L._rtxSsrcId=U.video_rtx),x&&(L._trust_audio_stream_added_state_=!0,L._audio_added_=!0,L._audioSSRC=U.audio_ssrc),x&&!j&&0===this.getListeners(pv.PUBLISHED_USER_LIST).length&&(Eb.info("[".concat(this._clientId,"] remote user ").concat(L.uid," published audio")),this.safeEmit(pv.USER_PUBLISHED,L,"audio")),V&&!z&&0===this.getListeners(pv.PUBLISHED_USER_LIST).length&&(Eb.info("[".concat(this._clientId,"] remote user ").concat(L.uid," published video")),this.safeEmit(pv.USER_PUBLISHED,L,"video")),(x&&!j||V&&!z||F)&&k.push(L),V&&this._p2pChannel.hasPendingRemoteMedia(L,"video")&&M.push({user:L,mediaType:"video"}),x&&this._p2pChannel.hasPendingRemoteMedia(L,"audio")&&M.push({user:L,mediaType:"audio"})}M.length>0&&(Eb.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(M.map((L=>"user: ".concat(L.user.uid,", mediaType: ").concat(L.mediaType))).join("; ")," ")),this.massSubscribe(M).catch((L=>{Eb.error("[".concat(this._clientId,"] mass resubscribe error"),L.toString())}))),this.getListeners(pv.PUBLISHED_USER_LIST).length>0?zA("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=k:(Eb.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(k.map((L=>L.uid)).join(", "))),this.safeEmit(pv.PUBLISHED_USER_LIST,k)):Eb.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(k.map((L=>L.uid)).join(", ")))})),this._gateway.signal.on(Nw.ON_RTP_CAPABILITY_CHANGE,(L=>{const{video_codec:k}=L;this._p2pChannel instanceof xF&&this._p2pChannel.updateRemoteRTPCapabilities(k.map((L=>L.toLowerCase())).filter((L=>{var k;return Sr(k=Object.keys(ib)).call(k,L)})))}))}_handleP2PEvents(){this._gateway.signal.on(Nw.ON_USER_OFFLINE,(()=>{this._p2pChannel.disconnectForReconnect()})),this._gateway.signal.on(TO.PUBLISH,((L,k,M)=>{const{uid:U}=L;L.forEach((L=>{const{kind:x,ssrcs:V,mid:F,isMuted:j}=L;this._handleP2PAddAudioOrVideoStream(x,U,V[0].ssrcId,F);const z=this._users.find((L=>L.uid===U));return z&&this._p2pChannel instanceof _F?this._p2pChannel.mockSubscribe(z,x,V[0].ssrcId,F).then((()=>{k()})).catch(M):k(),this._handleMuteStream(U,x,!!j)}))})),this._gateway.signal.on(TO.CALL,(async(L,k,M)=>{if(this._p2pChannel instanceof _F)try{var U;k(await this._p2pChannel.startP2P({turnServer:null===(U=this._joinInfo)||void 0===U?void 0:U.turnServer},L))}catch(L){M(L)}})),this._gateway.signal.on(bw.P2P_CONNECTION,(async L=>{this._p2pChannel instanceof _F&&await this._p2pChannel.p2pConnect(L)})),this._gateway.signal.on(TO.UNPUBLISH,(async(L,k,M)=>{if(this._p2pChannel instanceof _F){const{unpubMsg:U,uid:x}=L,V=this._users.find((L=>L.uid===x));if(!V)return Eb.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(x)),void k();try{U.forEach((async L=>{let{stream_type:k}=L;const M=k===qw.Audio?nO.AUDIO:nO.VIDEO;await this._p2pChannel.unsubscribe(V,M),this._handleMuteStream(x,M,!0)})),k()}catch(L){M(L)}}})),this._gateway.signal.on(TO.CONTROL,(async(L,k)=>{const{action:M}=L;switch(M){case RO.MUTE_LOCAL_VIDEO:this._handleMuteStream(k,nO.VIDEO,!0);break;case RO.MUTE_LOCAL_AUDIO:this._handleMuteStream(k,nO.AUDIO,!0);break;case RO.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",k),this._handleMuteStream(k,nO.VIDEO,!1);break;case RO.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",k),this._handleMuteStream(k,nO.AUDIO,!1)}})),this._gateway.signal.on(TO.RESTART_ICE,(async(L,k,M)=>{if(this._p2pChannel instanceof _F)try{const{direction:M,iceParameter:U}=L;M!==Dw.SEND_ONLY||U?k(await this._p2pChannel.restartICE(M,U)):(this._p2pChannel.handleDisconnect(M),k())}catch(L){M(L)}})),this._gateway.signal.on(TO.CANDIDATE,(L=>{if(this._p2pChannel instanceof _F){const{candidate:k,direction:M}=L;this._p2pChannel.addRemoteCandidate(k,M)}})),this._p2pChannel.on(lO.RequestP2PRestartICE,(async(L,k,M)=>{try{const{direction:M}=L;k(await this._gateway.sendExtensionMessage(TO.RESTART_ICE,L,M===Dw.SEND_ONLY))}catch(L){M(L)}})),this._p2pChannel.on(lO.LocalCandidate,(L=>{this._gateway.sendExtensionMessage(TO.CANDIDATE,JSON.stringify(L),!0)})),this._p2pChannel.on(lO.RequestP2PMuteLocal,(async(L,k,M)=>{try{await this._gateway.sendExtensionMessage(TO.CONTROL,L,!0),k()}catch(L){M(L)}})),this._p2pChannel.on(lO.RequestP2PUnmuteRemote,(async(L,k,M)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(L,this._joinInfo.stringUid||this._joinInfo.uid),k()}catch(L){L.code===iv.DISCONNECT_P2P?k():M(L)}else k()})),this._p2pChannel.on(lO.RequestP2PMuteRemote,(async(L,k,M)=>{if(this._joinInfo)try{await this._gateway.muteRemote(L,this._joinInfo.stringUid||this._joinInfo.uid),k()}catch(L){L.code===iv.DISCONNECT_P2P?k():M(L)}else k()})),this._p2pChannel.on(lO.StateChange,((L,k)=>{k===dO.Connected&&this._p2pChannel.republish()}))}_handleP2PChannelEvents(){this._p2pChannel.on(lO.RequestMuteLocal,(async(L,k,M)=>{if(this._joinInfo)try{await this._gateway.muteLocal(L,this._joinInfo.stringUid||this._joinInfo.uid),k()}catch(L){L.code===iv.DISCONNECT_P2P?k():M(L)}else k()})),this._p2pChannel.on(lO.RequestUnmuteLocal,(async(L,k,M)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(L,this._joinInfo.stringUid||this._joinInfo.uid),k()}catch(L){L.code===iv.DISCONNECT_P2P?k():M(L)}else k()})),this._p2pChannel.on(lO.RequestRePublish,((L,k,M)=>{this.publish(L,!1).then(k).catch(M)})),this._p2pChannel.on(lO.RequestRePublishDataChannel,((L,k,M)=>{Mp.all(L.map((async L=>{const k=await this._p2pChannel.publishDataChannel([L]);try{k.forEach((L=>{this._uid&&this._gateway.publishDataChannel(this._uid,L,!0)}))}catch(L){if(L.code!==iv.DISCONNECT_P2P)throw L}}))).then(k).catch(M)})),this._p2pChannel.on(lO.RequestReSubscribe,(async(L,k,M)=>{try{for(const{user:k,kind:M}of L)M===nO.VIDEO?await this.subscribe(k,"video"):await this.subscribe(k,"audio");k()}catch(L){M(L)}})),this._p2pChannel.on(lO.RequestUpload,((L,k)=>{this._gateway.upload(L,k)})),this._p2pChannel.on(lO.RequestUploadStats,(L=>{this._gateway.uploadWRTCStats(L)})),this._p2pChannel.on(lO.MediaReconnectStart,(L=>{this.safeEmit(pv.MEDIA_RECONNECT_START,L)})),this._p2pChannel.on(lO.MediaReconnectEnd,(L=>{this.safeEmit(pv.MEDIA_RECONNECT_END,L)})),this._p2pChannel.on(lO.NeedSignalRTT,(L=>{L(this._gateway.getSignalRTT())})),this._p2pChannel.on(lO.RequestRestartICE,(async L=>{if(this._p2pChannel instanceof _F)return;const k=await this._p2pChannel.restartICE(L),M=await k.next();if(M.done)return;const U=M.value;let x;try{x=await this._gateway.restartICE({iceParameters:U})}catch(L){return void k.throw(L)}const{iceParameters:V}=function(L){const k=L.iceParameters;return{iceParameters:{iceUfrag:k.iceUfrag,icePwd:k.icePwd}}}(x);await k.next({remoteIceParameters:V})})),this._p2pChannel.on(lO.RequestReconnect,(async()=>{this._gateway.reconnect()})),this._p2pChannel.on(lO.RequestReconnectPC,(async()=>{var L;const{iceParameters:k,dtlsParameters:M,rtpCapabilities:U}=await this._p2pChannel.startP2PConnection({turnServer:null===(L=this._joinInfo)||void 0===L?void 0:L.turnServer}),{gatewayEstablishParams:x,gatewayAddress:V}=await this._gateway.reconnectPC({iceParameters:k,dtlsParameters:M,rtpCapabilities:U}),F=HU(x,V);await this._p2pChannel.connect(F),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()})),this._p2pChannel.on(lO.RequestUnpublishForReconnectPC,(async(L,k,M)=>{this._joinInfo&&void 0!==this._uid?(await this._gateway.unpublish(L,this._uid),k()):M()})),this._p2pChannel.on(lO.P2PLost,(()=>{this.safeEmit(pv.P2P_LOST,this.store.uid)})),this._p2pChannel.on(lO.UpdateVideoEncoder,(L=>{L._encoderConfig&&this._gateway.setVideoProfile(L._encoderConfig)})),this._p2pChannel.on(lO.ConnectionTypeChange,(L=>{this.safeEmit(pv.IS_USING_CLOUD_PROXY,L)})),this._p2pChannel.on(lO.RequestLowStreamParameter,(L=>{L(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})})),this._p2pChannel.on(lO.QueryClientConnectionState,(L=>{L(this.connectionState)}))}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(L){if(!this._joinInfo||"CONNECTED"!==this.connectionState)throw new Ib(iv.INVALID_OPERATION,"[".concat(this._clientId,"] can not create content inspect, please join channel first"));if(this._inspect)throw new Ib(iv.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));try{const M=(k={config:L},TB("ContentInspect").create(k));this._inspect=M,this.handleVideoInspectEvents(M);const{appId:U,cname:x,sid:V,token:F,uid:j,cid:z,vid:Q}=this._joinInfo;await M.init({appId:U,areaCode:"",cname:x,sid:V,token:F,uid:j,cid:z,vid:Q?Number(Q):0},Ov)}catch(L){throw Array.isArray(L)?L[0]:L}var k}handleVideoInspectEvents(L){L.on(pO.CONNECTION_STATE_CHANGE,((k,M)=>{if(this.safeEmit(pv.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,k,M),M===uO.CONNECTED){if("CONNECTED"!==this.connectionState)return void this.safeEmit(pv.CONTENT_INSPECT_ERROR,new Ib(iv.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));L.inspectImage()}})),L.on(pO.INSPECT_RESULT,((L,k)=>{var M;if((null==k?void 0:k.code)===iv.INVALID_OPERATION&&"DISCONNECTED"===this.connectionState)return Eb.debug("Stop inspect content because that has left channel"),null==this||null===(M=this._inspect)||void 0===M||M.close(),void(this._inspect=void 0);this.safeEmit(pv.CONTENT_INSPECT_RESULT,L,k)})),L.on(pO.CLIENT_LOCAL_VIDEO_TRACK,(L=>{L(this.localTracks.filter((L=>"video"===L.trackMediaType))[0])}))}async disableContentInspect(){if(!this._inspect)throw new Ib(iv.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(L){throw Array.isArray(L)?L[0]:L}}async setImageModeration(L,k){if(Ry(L,"enabled"),L){if(!k)throw new Ib(iv.INVALID_PARAMS,"config is required");if(Dj(k),!this._joinInfo)throw new Ib(iv.INVALID_OPERATION,"can not create image moderation, please join channel first");try{if(this._moderation)this._moderation.updateConfig(k);else{const L=(M={config:k},TB("ImageModeration").create(M));this._moderation=L,this.handleImageModerationEvents(L);const{appId:U,cname:x,sid:V,token:F,uid:j,cid:z,vid:Q}=this._joinInfo;await L.init({appId:U,areaCode:"",cname:x,sid:V,token:F,uid:j,cid:z,vid:Q?Number(Q):0},Ov)}}catch(L){throw Array.isArray(L)?L[0]:L}}else{var M;if(!this._moderation)throw new Ib(iv.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(L){throw Array.isArray(L)?L[0]:L}}}handleImageModerationEvents(L){L.on(mO.CONNECTION_STATE_CHANGE,((k,M)=>{if(this.safeEmit(pv.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,k,M),k===fO.CONNECTED){if("CONNECTED"!==this.connectionState)throw this.setImageModeration(!1),new Ib(iv.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");L.inspectImage()}})),L.on(mO.CLIENT_LOCAL_VIDEO_TRACK,(L=>{L(this.localTracks.filter((L=>"video"===L.trackMediaType))[0])}))}setP2PTransport(L){if(function(L){Cy(L,"transport",["default","auto","relay","sd-rtn"])}(L),"p2p"!==this.mode)throw new Ib(iv.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=L,Eb.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(L))}getJoinChannelServiceRecords(){return Eb.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(L){Ry(L,"enabled"),qA("ENABLE_PUBLISH_AUDIO_FILTER",L),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(L)}_handleResetAddStream(L,k){switch(k){case"audio":L._audio_added_=!1,L._trust_audio_stream_added_state_=!0;break;case"video":L._video_added_=!1,L._trust_video_stream_added_state_=!0}}},gw(aG.prototype,"leave",[ij],Object.getOwnPropertyDescriptor(aG.prototype,"leave"),aG.prototype),gw(aG.prototype,"publish",[fj],Object.getOwnPropertyDescriptor(aG.prototype,"publish"),aG.prototype),gw(aG.prototype,"unpublish",[mj],Object.getOwnPropertyDescriptor(aG.prototype,"unpublish"),aG.prototype),gw(aG.prototype,"subscribe",[gj],Object.getOwnPropertyDescriptor(aG.prototype,"subscribe"),aG.prototype),gw(aG.prototype,"presubscribe",[Tj],Object.getOwnPropertyDescriptor(aG.prototype,"presubscribe"),aG.prototype),gw(aG.prototype,"massSubscribe",[Sj],Object.getOwnPropertyDescriptor(aG.prototype,"massSubscribe"),aG.prototype),gw(aG.prototype,"unsubscribe",[Rj],Object.getOwnPropertyDescriptor(aG.prototype,"unsubscribe"),aG.prototype),gw(aG.prototype,"massUnsubscribe",[Ij],Object.getOwnPropertyDescriptor(aG.prototype,"massUnsubscribe"),aG.prototype),gw(aG.prototype,"setLowStreamParameter",[yj],Object.getOwnPropertyDescriptor(aG.prototype,"setLowStreamParameter"),aG.prototype),gw(aG.prototype,"enableDualStream",[Cj],Object.getOwnPropertyDescriptor(aG.prototype,"enableDualStream"),aG.prototype),gw(aG.prototype,"disableDualStream",[vj],Object.getOwnPropertyDescriptor(aG.prototype,"disableDualStream"),aG.prototype),gw(aG.prototype,"setClientRole",[Pj],Object.getOwnPropertyDescriptor(aG.prototype,"setClientRole"),aG.prototype),gw(aG.prototype,"setProxyServer",[Lj],Object.getOwnPropertyDescriptor(aG.prototype,"setProxyServer"),aG.prototype),gw(aG.prototype,"setTurnServer",[kj],Object.getOwnPropertyDescriptor(aG.prototype,"setTurnServer"),aG.prototype),gw(aG.prototype,"setLicense",[Mj],Object.getOwnPropertyDescriptor(aG.prototype,"setLicense"),aG.prototype),gw(aG.prototype,"startProxyServer",[Uj],Object.getOwnPropertyDescriptor(aG.prototype,"startProxyServer"),aG.prototype),gw(aG.prototype,"stopProxyServer",[xj],Object.getOwnPropertyDescriptor(aG.prototype,"stopProxyServer"),aG.prototype),gw(aG.prototype,"setLocalAccessPointsV2",[Vj],Object.getOwnPropertyDescriptor(aG.prototype,"setLocalAccessPointsV2"),aG.prototype),gw(aG.prototype,"setLocalAccessPoints",[Fj],Object.getOwnPropertyDescriptor(aG.prototype,"setLocalAccessPoints"),aG.prototype),gw(aG.prototype,"setRemoteDefaultVideoStreamType",[Bj],Object.getOwnPropertyDescriptor(aG.prototype,"setRemoteDefaultVideoStreamType"),aG.prototype),gw(aG.prototype,"setRemoteVideoStreamType",[jj],Object.getOwnPropertyDescriptor(aG.prototype,"setRemoteVideoStreamType"),aG.prototype),gw(aG.prototype,"setStreamFallbackOption",[Gj],Object.getOwnPropertyDescriptor(aG.prototype,"setStreamFallbackOption"),aG.prototype),gw(aG.prototype,"setEncryptionConfig",[Wj],Object.getOwnPropertyDescriptor(aG.prototype,"setEncryptionConfig"),aG.prototype),gw(aG.prototype,"renewToken",[Hj],Object.getOwnPropertyDescriptor(aG.prototype,"renewToken"),aG.prototype),gw(aG.prototype,"enableAudioVolumeIndicator",[Kj],Object.getOwnPropertyDescriptor(aG.prototype,"enableAudioVolumeIndicator"),aG.prototype),gw(aG.prototype,"startLiveStreaming",[zj],Object.getOwnPropertyDescriptor(aG.prototype,"startLiveStreaming"),aG.prototype),gw(aG.prototype,"setLiveTranscoding",[Yj],Object.getOwnPropertyDescriptor(aG.prototype,"setLiveTranscoding"),aG.prototype),gw(aG.prototype,"stopLiveStreaming",[qj],Object.getOwnPropertyDescriptor(aG.prototype,"stopLiveStreaming"),aG.prototype),gw(aG.prototype,"startChannelMediaRelay",[Xj],Object.getOwnPropertyDescriptor(aG.prototype,"startChannelMediaRelay"),aG.prototype),gw(aG.prototype,"updateChannelMediaRelay",[Jj],Object.getOwnPropertyDescriptor(aG.prototype,"updateChannelMediaRelay"),aG.prototype),gw(aG.prototype,"stopChannelMediaRelay",[Qj],Object.getOwnPropertyDescriptor(aG.prototype,"stopChannelMediaRelay"),aG.prototype),gw(aG.prototype,"sendCustomReportMessage",[Zj],Object.getOwnPropertyDescriptor(aG.prototype,"sendCustomReportMessage"),aG.prototype),gw(aG.prototype,"pickSVCLayer",[$j],Object.getOwnPropertyDescriptor(aG.prototype,"pickSVCLayer"),aG.prototype),gw(aG.prototype,"setRTMConfig",[eG],Object.getOwnPropertyDescriptor(aG.prototype,"setRTMConfig"),aG.prototype),gw(aG.prototype,"enableContentInspect",[tG],Object.getOwnPropertyDescriptor(aG.prototype,"enableContentInspect"),aG.prototype),gw(aG.prototype,"disableContentInspect",[iG],Object.getOwnPropertyDescriptor(aG.prototype,"disableContentInspect"),aG.prototype),gw(aG.prototype,"setImageModeration",[nG],Object.getOwnPropertyDescriptor(aG.prototype,"setImageModeration"),aG.prototype),gw(aG.prototype,"setP2PTransport",[rG],Object.getOwnPropertyDescriptor(aG.prototype,"setP2PTransport"),aG.prototype),gw(aG.prototype,"getJoinChannelServiceRecords",[oG],Object.getOwnPropertyDescriptor(aG.prototype,"getJoinChannelServiceRecords"),aG.prototype),gw(aG.prototype,"setPublishAudioFilterEnabled",[sG],Object.getOwnPropertyDescriptor(aG.prototype,"setPublishAudioFilterEnabled"),aG.prototype),aG);class IG{constructor(L,k){xg(this,"id",0),xg(this,"element",void 0),xg(this,"peerPair",void 0),xg(this,"context",void 0),xg(this,"audioPlayerElement",void 0),xg(this,"audioTrack",void 0),IG.count+=1,this.id=IG.count,this.element=L,this.context=k}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=L=>{const k=document.createElement("audio");k.srcObject=new MediaStream([L.track]),k.play(),this.audioPlayerElement=k}}async switchSdp(){if(!this.peerPair)return;const e=async(L,k)=>{const M="offer"===k?await L.createOffer():await L.createAnswer();return await L.setLocalDescription(M),"complete"===L.iceGatheringState?L.localDescription:new Mp((k=>{L.onicegatheringstatechange=()=>{"complete"===L.iceGatheringState&&k(L.localDescription)}}))},t=async(L,k)=>await L.setRemoteDescription(k);try{const L=await e(this.peerPair[0],"offer");await t(this.peerPair[1],L);const k=await e(this.peerPair[1],"answer");await t(this.peerPair[0],k)}catch(e){throw new Ib(iv.LOCAL_AEC_ERROR,e.toString()).print()}}async getTracksFromMediaElement(L){if(this.audioTrack)return this.audioTrack;let k;try{L instanceof HTMLVideoElement&&(L.captureStream?L.captureStream():L.mozCaptureStream()),k=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(L).connect(k)}catch(L){throw new Ib(iv.LOCAL_AEC_ERROR,L.toString()).print()}if(!k)throw new Ib(iv.LOCAL_AEC_ERROR,"no dest node when local aec").print();const M=k.stream.getAudioTracks()[0];return this.audioTrack=M,M}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();const L=this.element,k=await this.getTracksFromMediaElement(L);this.peerPair&&this.peerPair[0].addTrack(k),await this.switchSdp()}close(){Eb.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach((L=>{L.close()})),this.peerPair=void 0,this.audioPlayerElement=void 0}}var dG,lG;xg(IG,"count",0);const uG=window.AudioContext||window.webkitAudioContext,hG=new(dG=Rb({report:Ab}),gw((lG=class{constructor(){xg(this,"units",[]),xg(this,"context",void 0)}processExternalMediaAEC(L){if(!this._doesEnvironmentNeedAEC())return Eb.debug("the system does not need to process local aec"),-1;this.context||(this.context=new uG);let k=this.units.find((k=>k&&k.getElement()===L));return k||(k=new IG(L,this.context),this.units.push(k)),k.startEchoCancellation(),Eb.debug("start processing local audio echo cancellation, id is",k.id),k.id}_doesEnvironmentNeedAEC(){return Gv().name!==JC.SAFARI}}).prototype,"processExternalMediaAEC",[dG],Object.getOwnPropertyDescriptor(lG.prototype,"processExternalMediaAEC"),lG.prototype),lG);function wG(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function OG(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?wG(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):wG(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}const pG=window||document;function DG(L){let k=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!pG)return;const M=FK._cspEventHandlerPointer;if(M&&k)return void console.error(M,k);const n=L=>{if(!(L&&L.blockedURI&&(FK.onSecurityPolicyViolation||FK.getListeners(EO.SECURITY_POLICY_VIOLATION).length>0)))return;const k=L.blockedURI;zA("CSP_DETECTED_HOSTNAME_LIST").some((L=>Sr(k).call(k,L)))&&(FK.onSecurityPolicyViolation&&"function"==typeof FK.onSecurityPolicyViolation&&FK.onSecurityPolicyViolation(L),FK.getListeners(EO.SECURITY_POLICY_VIOLATION).length>0&&FK.safeEmit(EO.SECURITY_POLICY_VIOLATION,L))};M&&pG.removeEventListener("securitypolicyviolation",M),(k||L&&"function"==typeof L||FK.getListeners(EO.SECURITY_POLICY_VIOLATION).length>0)&&pG.addEventListener("securitypolicyviolation",n),FK._cspEventHandlerPointer=n}var _G=j,EG=SC,fG=RegExp.prototype,mG=i((function(L){return L===fG||_G(fG,L)?EG(L):L.flags}));function xG(L){let k=L.length;for(;--k>=0;)L[k]=0}const TG=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),SG=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),yG=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),AG=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),CG=new Array(576);xG(CG);const vG=new Array(60);xG(vG);const bG=new Array(512);xG(bG);const NG=new Array(256);xG(NG);const PG=new Array(29);xG(PG);const LG=new Array(30);function ZG(L,k,M,U,x){this.static_tree=L,this.extra_bits=k,this.extra_base=M,this.elems=U,this.max_length=x,this.has_stree=L&&L.length}let kG,MG,UG;function iW(L,k){this.dyn_tree=L,this.max_code=0,this.stat_desc=k}xG(LG);const nW=L=>L<256?bG[L]:bG[256+(L>>>7)],rW=(L,k)=>{L.pending_buf[L.pending++]=255&k,L.pending_buf[L.pending++]=k>>>8&255},oW=(L,k,M)=>{L.bi_valid>16-M?(L.bi_buf|=k<<L.bi_valid&65535,rW(L,L.bi_buf),L.bi_buf=k>>16-L.bi_valid,L.bi_valid+=M-16):(L.bi_buf|=k<<L.bi_valid&65535,L.bi_valid+=M)},sW=(L,k,M)=>{oW(L,M[2*k],M[2*k+1])},aW=(L,k)=>{let M=0;do{M|=1&L,L>>>=1,M<<=1}while(--k>0);return M>>>1},cW=(L,k,M)=>{const U=new Array(16);let x,V,F=0;for(x=1;x<=15;x++)F=F+M[x-1]<<1,U[x]=F;for(V=0;V<=k;V++){let k=L[2*V+1];0!==k&&(L[2*V]=aW(U[k]++,k))}},dW=L=>{let k;for(k=0;k<286;k++)L.dyn_ltree[2*k]=0;for(k=0;k<30;k++)L.dyn_dtree[2*k]=0;for(k=0;k<19;k++)L.bl_tree[2*k]=0;L.dyn_ltree[512]=1,L.opt_len=L.static_len=0,L.sym_next=L.matches=0},lW=L=>{L.bi_valid>8?rW(L,L.bi_buf):L.bi_valid>0&&(L.pending_buf[L.pending++]=L.bi_buf),L.bi_buf=0,L.bi_valid=0},uW=(L,k,M,U)=>{const x=2*k,V=2*M;return L[x]<L[V]||L[x]===L[V]&&U[k]<=U[M]},hW=(L,k,M)=>{const U=L.heap[M];let x=M<<1;for(;x<=L.heap_len&&(x<L.heap_len&&uW(k,L.heap[x+1],L.heap[x],L.depth)&&x++,!uW(k,U,L.heap[x],L.depth));)L.heap[M]=L.heap[x],M=x,x<<=1;L.heap[M]=U},pW=(L,k,M)=>{let U,x,V,F,j=0;if(0!==L.sym_next)do{U=255&L.pending_buf[L.sym_buf+j++],U+=(255&L.pending_buf[L.sym_buf+j++])<<8,x=L.pending_buf[L.sym_buf+j++],0===U?sW(L,x,k):(V=NG[x],sW(L,V+256+1,k),F=TG[V],0!==F&&(x-=PG[V],oW(L,x,F)),U--,V=nW(U),sW(L,V,M),F=SG[V],0!==F&&(U-=LG[V],oW(L,U,F)))}while(j<L.sym_next);sW(L,256,k)},_W=(L,k)=>{const M=k.dyn_tree,U=k.stat_desc.static_tree,x=k.stat_desc.has_stree,V=k.stat_desc.elems;let F,j,z,Q=-1;for(L.heap_len=0,L.heap_max=573,F=0;F<V;F++)0!==M[2*F]?(L.heap[++L.heap_len]=Q=F,L.depth[F]=0):M[2*F+1]=0;for(;L.heap_len<2;)z=L.heap[++L.heap_len]=Q<2?++Q:0,M[2*z]=1,L.depth[z]=0,L.opt_len--,x&&(L.static_len-=U[2*z+1]);for(k.max_code=Q,F=L.heap_len>>1;F>=1;F--)hW(L,M,F);z=V;do{F=L.heap[1],L.heap[1]=L.heap[L.heap_len--],hW(L,M,1),j=L.heap[1],L.heap[--L.heap_max]=F,L.heap[--L.heap_max]=j,M[2*z]=M[2*F]+M[2*j],L.depth[z]=(L.depth[F]>=L.depth[j]?L.depth[F]:L.depth[j])+1,M[2*F+1]=M[2*j+1]=z,L.heap[1]=z++,hW(L,M,1)}while(L.heap_len>=2);L.heap[--L.heap_max]=L.heap[1],((L,k)=>{const M=k.dyn_tree,U=k.max_code,x=k.stat_desc.static_tree,V=k.stat_desc.has_stree,F=k.stat_desc.extra_bits,j=k.stat_desc.extra_base,z=k.stat_desc.max_length;let Q,$,ee,te,ie,ne,re=0;for(te=0;te<=15;te++)L.bl_count[te]=0;for(M[2*L.heap[L.heap_max]+1]=0,Q=L.heap_max+1;Q<573;Q++)$=L.heap[Q],te=M[2*M[2*$+1]+1]+1,te>z&&(te=z,re++),M[2*$+1]=te,$>U||(L.bl_count[te]++,ie=0,$>=j&&(ie=F[$-j]),ne=M[2*$],L.opt_len+=ne*(te+ie),V&&(L.static_len+=ne*(x[2*$+1]+ie)));if(0!==re){do{for(te=z-1;0===L.bl_count[te];)te--;L.bl_count[te]--,L.bl_count[te+1]+=2,L.bl_count[z]--,re-=2}while(re>0);for(te=z;0!==te;te--)for($=L.bl_count[te];0!==$;)ee=L.heap[--Q],ee>U||(M[2*ee+1]!==te&&(L.opt_len+=(te-M[2*ee+1])*M[2*ee],M[2*ee+1]=te),$--)}})(L,k),cW(M,Q,L.bl_count)},EW=(L,k,M)=>{let U,x,V=-1,F=k[1],j=0,z=7,Q=4;for(0===F&&(z=138,Q=3),k[2*(M+1)+1]=65535,U=0;U<=M;U++)x=F,F=k[2*(U+1)+1],++j<z&&x===F||(j<Q?L.bl_tree[2*x]+=j:0!==x?(x!==V&&L.bl_tree[2*x]++,L.bl_tree[32]++):j<=10?L.bl_tree[34]++:L.bl_tree[36]++,j=0,V=x,0===F?(z=138,Q=3):x===F?(z=6,Q=3):(z=7,Q=4))},fW=(L,k,M)=>{let U,x,V=-1,F=k[1],j=0,z=7,Q=4;for(0===F&&(z=138,Q=3),U=0;U<=M;U++)if(x=F,F=k[2*(U+1)+1],!(++j<z&&x===F)){if(j<Q)do{sW(L,x,L.bl_tree)}while(0!=--j);else 0!==x?(x!==V&&(sW(L,x,L.bl_tree),j--),sW(L,16,L.bl_tree),oW(L,j-3,2)):j<=10?(sW(L,17,L.bl_tree),oW(L,j-3,3)):(sW(L,18,L.bl_tree),oW(L,j-11,7));j=0,V=x,0===F?(z=138,Q=3):x===F?(z=6,Q=3):(z=7,Q=4)}};let VG=!1;const TW=(L,k,M,U)=>{oW(L,0+(U?1:0),3),lW(L),rW(L,M),rW(L,~M),M&&L.pending_buf.set(L.window.subarray(k,k+M),L.pending),L.pending+=M};var FG={_tr_init:L=>{VG||((()=>{let L,k,M,U,x;const V=new Array(16);for(M=0,U=0;U<28;U++)for(PG[U]=M,L=0;L<1<<TG[U];L++)NG[M++]=U;for(NG[M-1]=U,x=0,U=0;U<16;U++)for(LG[U]=x,L=0;L<1<<SG[U];L++)bG[x++]=U;for(x>>=7;U<30;U++)for(LG[U]=x<<7,L=0;L<1<<SG[U]-7;L++)bG[256+x++]=U;for(k=0;k<=15;k++)V[k]=0;for(L=0;L<=143;)CG[2*L+1]=8,L++,V[8]++;for(;L<=255;)CG[2*L+1]=9,L++,V[9]++;for(;L<=279;)CG[2*L+1]=7,L++,V[7]++;for(;L<=287;)CG[2*L+1]=8,L++,V[8]++;for(cW(CG,287,V),L=0;L<30;L++)vG[2*L+1]=5,vG[2*L]=aW(L,5);kG=new ZG(CG,TG,257,286,15),MG=new ZG(vG,SG,0,30,15),UG=new ZG(new Array(0),yG,0,19,7)})(),VG=!0),L.l_desc=new iW(L.dyn_ltree,kG),L.d_desc=new iW(L.dyn_dtree,MG),L.bl_desc=new iW(L.bl_tree,UG),L.bi_buf=0,L.bi_valid=0,dW(L)},_tr_stored_block:TW,_tr_flush_block:(L,k,M,U)=>{let x,V,F=0;L.level>0?(2===L.strm.data_type&&(L.strm.data_type=(L=>{let k,M=4093624447;for(k=0;k<=31;k++,M>>>=1)if(1&M&&0!==L.dyn_ltree[2*k])return 0;if(0!==L.dyn_ltree[18]||0!==L.dyn_ltree[20]||0!==L.dyn_ltree[26])return 1;for(k=32;k<256;k++)if(0!==L.dyn_ltree[2*k])return 1;return 0})(L)),_W(L,L.l_desc),_W(L,L.d_desc),F=(L=>{let k;for(EW(L,L.dyn_ltree,L.l_desc.max_code),EW(L,L.dyn_dtree,L.d_desc.max_code),_W(L,L.bl_desc),k=18;k>=3&&0===L.bl_tree[2*AG[k]+1];k--);return L.opt_len+=3*(k+1)+5+5+4,k})(L),x=L.opt_len+3+7>>>3,V=L.static_len+3+7>>>3,V<=x&&(x=V)):x=V=M+5,M+4<=x&&-1!==k?TW(L,k,M,U):4===L.strategy||V===x?(oW(L,2+(U?1:0),3),pW(L,CG,vG)):(oW(L,4+(U?1:0),3),((L,k,M,U)=>{let x;for(oW(L,k-257,5),oW(L,M-1,5),oW(L,U-4,4),x=0;x<U;x++)oW(L,L.bl_tree[2*AG[x]+1],3);fW(L,L.dyn_ltree,k-1),fW(L,L.dyn_dtree,M-1)})(L,L.l_desc.max_code+1,L.d_desc.max_code+1,F+1),pW(L,L.dyn_ltree,L.dyn_dtree)),dW(L),U&&lW(L)},_tr_tally:(L,k,M)=>(L.pending_buf[L.sym_buf+L.sym_next++]=k,L.pending_buf[L.sym_buf+L.sym_next++]=k>>8,L.pending_buf[L.sym_buf+L.sym_next++]=M,0===k?L.dyn_ltree[2*M]++:(L.matches++,k--,L.dyn_ltree[2*(NG[M]+256+1)]++,L.dyn_dtree[2*nW(k)]++),L.sym_next===L.sym_end),_tr_align:L=>{oW(L,2,3),sW(L,256,CG),(L=>{16===L.bi_valid?(rW(L,L.bi_buf),L.bi_buf=0,L.bi_valid=0):L.bi_valid>=8&&(L.pending_buf[L.pending++]=255&L.bi_buf,L.bi_buf>>=8,L.bi_valid-=8)})(L)}},vW=(L,k,M,U)=>{let x=65535&L|0,V=L>>>16&65535|0,F=0;for(;0!==M;){F=M>2e3?2e3:M,M-=F;do{x=x+k[U++]|0,V=V+x|0}while(--F);x%=65521,V%=65521}return x|V<<16|0};const BG=new Uint32Array((()=>{let L,k=[];for(var M=0;M<256;M++){L=M;for(var U=0;U<8;U++)L=1&L?3988292384^L>>>1:L>>>1;k[M]=L}return k})());var AW=(L,k,M,U)=>{const x=BG,V=U+M;L^=-1;for(let M=U;M<V;M++)L=L>>>8^x[255&(L^k[M])];return-1^L},jG={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},GG={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:WG,_tr_stored_block:HG,_tr_flush_block:KG,_tr_tally:zG,_tr_align:YG}=FG,{Z_NO_FLUSH:qG,Z_PARTIAL_FLUSH:XG,Z_FULL_FLUSH:JG,Z_FINISH:QG,Z_BLOCK:$G,Z_OK:eW,Z_STREAM_END:tW,Z_STREAM_ERROR:mW,Z_DATA_ERROR:gW,Z_BUF_ERROR:SW,Z_DEFAULT_COMPRESSION:RW,Z_FILTERED:IW,Z_HUFFMAN_ONLY:yW,Z_RLE:CW,Z_FIXED:bW,Z_DEFAULT_STRATEGY:wW,Z_UNKNOWN:OW,Z_DEFLATED:NW}=GG,DW=258,PW=262,LW=42,kW=113,MW=666,cH=(L,k)=>(L.msg=jG[k],k),dH=L=>2*L-(L>4?9:0),lH=L=>{let k=L.length;for(;--k>=0;)L[k]=0},uH=L=>{let k,M,U,x=L.w_size;k=L.hash_size,U=k;do{M=L.head[--U],L.head[U]=M>=x?M-x:0}while(--k);k=x,U=k;do{M=L.prev[--U],L.prev[U]=M>=x?M-x:0}while(--k)};let hH=(L,k,M)=>(k<<L.hash_shift^M)&L.hash_mask;const pH=L=>{const k=L.state;let M=k.pending;M>L.avail_out&&(M=L.avail_out),0!==M&&(L.output.set(k.pending_buf.subarray(k.pending_out,k.pending_out+M),L.next_out),L.next_out+=M,k.pending_out+=M,L.total_out+=M,L.avail_out-=M,k.pending-=M,0===k.pending&&(k.pending_out=0))},_H=(L,k)=>{KG(L,L.block_start>=0?L.block_start:-1,L.strstart-L.block_start,k),L.block_start=L.strstart,pH(L.strm)},EH=(L,k)=>{L.pending_buf[L.pending++]=k},fH=(L,k)=>{L.pending_buf[L.pending++]=k>>>8&255,L.pending_buf[L.pending++]=255&k},mH=(L,k,M,U)=>{let x=L.avail_in;return x>U&&(x=U),0===x?0:(L.avail_in-=x,k.set(L.input.subarray(L.next_in,L.next_in+x),M),1===L.state.wrap?L.adler=vW(L.adler,k,x,M):2===L.state.wrap&&(L.adler=AW(L.adler,k,x,M)),L.next_in+=x,L.total_in+=x,x)},TH=(L,k)=>{let M,U,x=L.max_chain_length,V=L.strstart,F=L.prev_length,j=L.nice_match;const z=L.strstart>L.w_size-PW?L.strstart-(L.w_size-PW):0,Q=L.window,$=L.w_mask,ee=L.prev,te=L.strstart+DW;let ie=Q[V+F-1],ne=Q[V+F];L.prev_length>=L.good_match&&(x>>=2),j>L.lookahead&&(j=L.lookahead);do{if(M=k,Q[M+F]===ne&&Q[M+F-1]===ie&&Q[M]===Q[V]&&Q[++M]===Q[V+1]){V+=2,M++;do{}while(Q[++V]===Q[++M]&&Q[++V]===Q[++M]&&Q[++V]===Q[++M]&&Q[++V]===Q[++M]&&Q[++V]===Q[++M]&&Q[++V]===Q[++M]&&Q[++V]===Q[++M]&&Q[++V]===Q[++M]&&V<te);if(U=DW-(te-V),V=te-DW,U>F){if(L.match_start=k,F=U,U>=j)break;ie=Q[V+F-1],ne=Q[V+F]}}}while((k=ee[k&$])>z&&0!=--x);return F<=L.lookahead?F:L.lookahead},SH=L=>{const k=L.w_size;let M,U,x;do{if(U=L.window_size-L.lookahead-L.strstart,L.strstart>=k+(k-PW)&&(L.window.set(L.window.subarray(k,k+k-U),0),L.match_start-=k,L.strstart-=k,L.block_start-=k,L.insert>L.strstart&&(L.insert=L.strstart),uH(L),U+=k),0===L.strm.avail_in)break;if(M=mH(L.strm,L.window,L.strstart+L.lookahead,U),L.lookahead+=M,L.lookahead+L.insert>=3)for(x=L.strstart-L.insert,L.ins_h=L.window[x],L.ins_h=hH(L,L.ins_h,L.window[x+1]);L.insert&&(L.ins_h=hH(L,L.ins_h,L.window[x+3-1]),L.prev[x&L.w_mask]=L.head[L.ins_h],L.head[L.ins_h]=x,x++,L.insert--,!(L.lookahead+L.insert<3)););}while(L.lookahead<PW&&0!==L.strm.avail_in)},gH=(L,k)=>{let M,U,x,V=L.pending_buf_size-5>L.w_size?L.w_size:L.pending_buf_size-5,F=0,j=L.strm.avail_in;do{if(M=65535,x=L.bi_valid+42>>3,L.strm.avail_out<x)break;if(x=L.strm.avail_out-x,U=L.strstart-L.block_start,M>U+L.strm.avail_in&&(M=U+L.strm.avail_in),M>x&&(M=x),M<V&&(0===M&&k!==QG||k===qG||M!==U+L.strm.avail_in))break;F=k===QG&&M===U+L.strm.avail_in?1:0,HG(L,0,0,F),L.pending_buf[L.pending-4]=M,L.pending_buf[L.pending-3]=M>>8,L.pending_buf[L.pending-2]=~M,L.pending_buf[L.pending-1]=~M>>8,pH(L.strm),U&&(U>M&&(U=M),L.strm.output.set(L.window.subarray(L.block_start,L.block_start+U),L.strm.next_out),L.strm.next_out+=U,L.strm.avail_out-=U,L.strm.total_out+=U,L.block_start+=U,M-=U),M&&(mH(L.strm,L.strm.output,L.strm.next_out,M),L.strm.next_out+=M,L.strm.avail_out-=M,L.strm.total_out+=M)}while(0===F);return j-=L.strm.avail_in,j&&(j>=L.w_size?(L.matches=2,L.window.set(L.strm.input.subarray(L.strm.next_in-L.w_size,L.strm.next_in),0),L.strstart=L.w_size,L.insert=L.strstart):(L.window_size-L.strstart<=j&&(L.strstart-=L.w_size,L.window.set(L.window.subarray(L.w_size,L.w_size+L.strstart),0),L.matches<2&&L.matches++,L.insert>L.strstart&&(L.insert=L.strstart)),L.window.set(L.strm.input.subarray(L.strm.next_in-j,L.strm.next_in),L.strstart),L.strstart+=j,L.insert+=j>L.w_size-L.insert?L.w_size-L.insert:j),L.block_start=L.strstart),L.high_water<L.strstart&&(L.high_water=L.strstart),F?4:k!==qG&&k!==QG&&0===L.strm.avail_in&&L.strstart===L.block_start?2:(x=L.window_size-L.strstart,L.strm.avail_in>x&&L.block_start>=L.w_size&&(L.block_start-=L.w_size,L.strstart-=L.w_size,L.window.set(L.window.subarray(L.w_size,L.w_size+L.strstart),0),L.matches<2&&L.matches++,x+=L.w_size,L.insert>L.strstart&&(L.insert=L.strstart)),x>L.strm.avail_in&&(x=L.strm.avail_in),x&&(mH(L.strm,L.window,L.strstart,x),L.strstart+=x,L.insert+=x>L.w_size-L.insert?L.w_size-L.insert:x),L.high_water<L.strstart&&(L.high_water=L.strstart),x=L.bi_valid+42>>3,x=L.pending_buf_size-x>65535?65535:L.pending_buf_size-x,V=x>L.w_size?L.w_size:x,U=L.strstart-L.block_start,(U>=V||(U||k===QG)&&k!==qG&&0===L.strm.avail_in&&U<=x)&&(M=U>x?x:U,F=k===QG&&0===L.strm.avail_in&&M===U?1:0,HG(L,L.block_start,M,F),L.block_start+=M,pH(L.strm)),F?3:1)},RH=(L,k)=>{let M,U;for(;;){if(L.lookahead<PW){if(SH(L),L.lookahead<PW&&k===qG)return 1;if(0===L.lookahead)break}if(M=0,L.lookahead>=3&&(L.ins_h=hH(L,L.ins_h,L.window[L.strstart+3-1]),M=L.prev[L.strstart&L.w_mask]=L.head[L.ins_h],L.head[L.ins_h]=L.strstart),0!==M&&L.strstart-M<=L.w_size-PW&&(L.match_length=TH(L,M)),L.match_length>=3)if(U=zG(L,L.strstart-L.match_start,L.match_length-3),L.lookahead-=L.match_length,L.match_length<=L.max_lazy_match&&L.lookahead>=3){L.match_length--;do{L.strstart++,L.ins_h=hH(L,L.ins_h,L.window[L.strstart+3-1]),M=L.prev[L.strstart&L.w_mask]=L.head[L.ins_h],L.head[L.ins_h]=L.strstart}while(0!=--L.match_length);L.strstart++}else L.strstart+=L.match_length,L.match_length=0,L.ins_h=L.window[L.strstart],L.ins_h=hH(L,L.ins_h,L.window[L.strstart+1]);else U=zG(L,0,L.window[L.strstart]),L.lookahead--,L.strstart++;if(U&&(_H(L,!1),0===L.strm.avail_out))return 1}return L.insert=L.strstart<2?L.strstart:2,k===QG?(_H(L,!0),0===L.strm.avail_out?3:4):L.sym_next&&(_H(L,!1),0===L.strm.avail_out)?1:2},CH=(L,k)=>{let M,U,x;for(;;){if(L.lookahead<PW){if(SH(L),L.lookahead<PW&&k===qG)return 1;if(0===L.lookahead)break}if(M=0,L.lookahead>=3&&(L.ins_h=hH(L,L.ins_h,L.window[L.strstart+3-1]),M=L.prev[L.strstart&L.w_mask]=L.head[L.ins_h],L.head[L.ins_h]=L.strstart),L.prev_length=L.match_length,L.prev_match=L.match_start,L.match_length=2,0!==M&&L.prev_length<L.max_lazy_match&&L.strstart-M<=L.w_size-PW&&(L.match_length=TH(L,M),L.match_length<=5&&(L.strategy===IW||3===L.match_length&&L.strstart-L.match_start>4096)&&(L.match_length=2)),L.prev_length>=3&&L.match_length<=L.prev_length){x=L.strstart+L.lookahead-3,U=zG(L,L.strstart-1-L.prev_match,L.prev_length-3),L.lookahead-=L.prev_length-1,L.prev_length-=2;do{++L.strstart<=x&&(L.ins_h=hH(L,L.ins_h,L.window[L.strstart+3-1]),M=L.prev[L.strstart&L.w_mask]=L.head[L.ins_h],L.head[L.ins_h]=L.strstart)}while(0!=--L.prev_length);if(L.match_available=0,L.match_length=2,L.strstart++,U&&(_H(L,!1),0===L.strm.avail_out))return 1}else if(L.match_available){if(U=zG(L,0,L.window[L.strstart-1]),U&&_H(L,!1),L.strstart++,L.lookahead--,0===L.strm.avail_out)return 1}else L.match_available=1,L.strstart++,L.lookahead--}return L.match_available&&(U=zG(L,0,L.window[L.strstart-1]),L.match_available=0),L.insert=L.strstart<2?L.strstart:2,k===QG?(_H(L,!0),0===L.strm.avail_out?3:4):L.sym_next&&(_H(L,!1),0===L.strm.avail_out)?1:2};function IH(L,k,M,U,x){this.good_length=L,this.max_lazy=k,this.nice_length=M,this.max_chain=U,this.func=x}const UW=[new IH(0,0,0,0,gH),new IH(4,4,8,4,RH),new IH(4,5,16,8,RH),new IH(4,6,32,32,RH),new IH(4,4,16,16,CH),new IH(8,16,32,32,CH),new IH(8,16,128,128,CH),new IH(8,32,128,256,CH),new IH(32,128,258,1024,CH),new IH(32,258,258,4096,CH)];function yH(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=NW,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(1146),this.dyn_dtree=new Uint16Array(122),this.bl_tree=new Uint16Array(78),lH(this.dyn_ltree),lH(this.dyn_dtree),lH(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(16),this.heap=new Uint16Array(573),lH(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(573),lH(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const AH=L=>{if(!L)return 1;const k=L.state;return!k||k.strm!==L||k.status!==LW&&57!==k.status&&69!==k.status&&73!==k.status&&91!==k.status&&103!==k.status&&k.status!==kW&&k.status!==MW?1:0},bH=L=>{if(AH(L))return cH(L,mW);L.total_in=L.total_out=0,L.data_type=OW;const k=L.state;return k.pending=0,k.pending_out=0,k.wrap<0&&(k.wrap=-k.wrap),k.status=2===k.wrap?57:k.wrap?LW:kW,L.adler=2===k.wrap?0:1,k.last_flush=-2,WG(k),eW},wH=L=>{const k=bH(L);return k===eW&&(L=>{L.window_size=2*L.w_size,lH(L.head),L.max_lazy_match=UW[L.level].max_lazy,L.good_match=UW[L.level].good_length,L.nice_match=UW[L.level].nice_length,L.max_chain_length=UW[L.level].max_chain,L.strstart=0,L.block_start=0,L.lookahead=0,L.insert=0,L.match_length=L.prev_length=2,L.match_available=0,L.ins_h=0})(L.state),k},OH=(L,k,M,U,x,V)=>{if(!L)return mW;let F=1;if(k===RW&&(k=6),U<0?(F=0,U=-U):U>15&&(F=2,U-=16),x<1||x>9||M!==NW||U<8||U>15||k<0||k>9||V<0||V>bW||8===U&&1!==F)return cH(L,mW);8===U&&(U=9);const j=new yH;return L.state=j,j.strm=L,j.status=LW,j.wrap=F,j.gzhead=null,j.w_bits=U,j.w_size=1<<j.w_bits,j.w_mask=j.w_size-1,j.hash_bits=x+7,j.hash_size=1<<j.hash_bits,j.hash_mask=j.hash_size-1,j.hash_shift=~~((j.hash_bits+3-1)/3),j.window=new Uint8Array(2*j.w_size),j.head=new Uint16Array(j.hash_size),j.prev=new Uint16Array(j.w_size),j.lit_bufsize=1<<x+6,j.pending_buf_size=4*j.lit_bufsize,j.pending_buf=new Uint8Array(j.pending_buf_size),j.sym_buf=j.lit_bufsize,j.sym_end=3*(j.lit_bufsize-1),j.level=k,j.strategy=V,j.method=M,wH(L)};var xW=OH,PH_deflateSetHeader=(L,k)=>AH(L)||2!==L.state.wrap?mW:(L.state.gzhead=k,eW),PH_deflate=(L,k)=>{if(AH(L)||k>$G||k<0)return L?cH(L,mW):mW;const M=L.state;if(!L.output||0!==L.avail_in&&!L.input||M.status===MW&&k!==QG)return cH(L,0===L.avail_out?SW:mW);const U=M.last_flush;if(M.last_flush=k,0!==M.pending){if(pH(L),0===L.avail_out)return M.last_flush=-1,eW}else if(0===L.avail_in&&dH(k)<=dH(U)&&k!==QG)return cH(L,SW);if(M.status===MW&&0!==L.avail_in)return cH(L,SW);if(M.status===LW&&0===M.wrap&&(M.status=kW),M.status===LW){let k=NW+(M.w_bits-8<<4)<<8,U=-1;if(U=M.strategy>=yW||M.level<2?0:M.level<6?1:6===M.level?2:3,k|=U<<6,0!==M.strstart&&(k|=32),k+=31-k%31,fH(M,k),0!==M.strstart&&(fH(M,L.adler>>>16),fH(M,65535&L.adler)),L.adler=1,M.status=kW,pH(L),0!==M.pending)return M.last_flush=-1,eW}if(57===M.status)if(L.adler=0,EH(M,31),EH(M,139),EH(M,8),M.gzhead)EH(M,(M.gzhead.text?1:0)+(M.gzhead.hcrc?2:0)+(M.gzhead.extra?4:0)+(M.gzhead.name?8:0)+(M.gzhead.comment?16:0)),EH(M,255&M.gzhead.time),EH(M,M.gzhead.time>>8&255),EH(M,M.gzhead.time>>16&255),EH(M,M.gzhead.time>>24&255),EH(M,9===M.level?2:M.strategy>=yW||M.level<2?4:0),EH(M,255&M.gzhead.os),M.gzhead.extra&&M.gzhead.extra.length&&(EH(M,255&M.gzhead.extra.length),EH(M,M.gzhead.extra.length>>8&255)),M.gzhead.hcrc&&(L.adler=AW(L.adler,M.pending_buf,M.pending,0)),M.gzindex=0,M.status=69;else if(EH(M,0),EH(M,0),EH(M,0),EH(M,0),EH(M,0),EH(M,9===M.level?2:M.strategy>=yW||M.level<2?4:0),EH(M,3),M.status=kW,pH(L),0!==M.pending)return M.last_flush=-1,eW;if(69===M.status){if(M.gzhead.extra){let k=M.pending,U=(65535&M.gzhead.extra.length)-M.gzindex;for(;M.pending+U>M.pending_buf_size;){let x=M.pending_buf_size-M.pending;if(M.pending_buf.set(M.gzhead.extra.subarray(M.gzindex,M.gzindex+x),M.pending),M.pending=M.pending_buf_size,M.gzhead.hcrc&&M.pending>k&&(L.adler=AW(L.adler,M.pending_buf,M.pending-k,k)),M.gzindex+=x,pH(L),0!==M.pending)return M.last_flush=-1,eW;k=0,U-=x}let x=new Uint8Array(M.gzhead.extra);M.pending_buf.set(x.subarray(M.gzindex,M.gzindex+U),M.pending),M.pending+=U,M.gzhead.hcrc&&M.pending>k&&(L.adler=AW(L.adler,M.pending_buf,M.pending-k,k)),M.gzindex=0}M.status=73}if(73===M.status){if(M.gzhead.name){let k,U=M.pending;do{if(M.pending===M.pending_buf_size){if(M.gzhead.hcrc&&M.pending>U&&(L.adler=AW(L.adler,M.pending_buf,M.pending-U,U)),pH(L),0!==M.pending)return M.last_flush=-1,eW;U=0}k=M.gzindex<M.gzhead.name.length?255&M.gzhead.name.charCodeAt(M.gzindex++):0,EH(M,k)}while(0!==k);M.gzhead.hcrc&&M.pending>U&&(L.adler=AW(L.adler,M.pending_buf,M.pending-U,U)),M.gzindex=0}M.status=91}if(91===M.status){if(M.gzhead.comment){let k,U=M.pending;do{if(M.pending===M.pending_buf_size){if(M.gzhead.hcrc&&M.pending>U&&(L.adler=AW(L.adler,M.pending_buf,M.pending-U,U)),pH(L),0!==M.pending)return M.last_flush=-1,eW;U=0}k=M.gzindex<M.gzhead.comment.length?255&M.gzhead.comment.charCodeAt(M.gzindex++):0,EH(M,k)}while(0!==k);M.gzhead.hcrc&&M.pending>U&&(L.adler=AW(L.adler,M.pending_buf,M.pending-U,U))}M.status=103}if(103===M.status){if(M.gzhead.hcrc){if(M.pending+2>M.pending_buf_size&&(pH(L),0!==M.pending))return M.last_flush=-1,eW;EH(M,255&L.adler),EH(M,L.adler>>8&255),L.adler=0}if(M.status=kW,pH(L),0!==M.pending)return M.last_flush=-1,eW}if(0!==L.avail_in||0!==M.lookahead||k!==qG&&M.status!==MW){let U=0===M.level?gH(M,k):M.strategy===yW?((L,k)=>{let M;for(;;){if(0===L.lookahead&&(SH(L),0===L.lookahead)){if(k===qG)return 1;break}if(L.match_length=0,M=zG(L,0,L.window[L.strstart]),L.lookahead--,L.strstart++,M&&(_H(L,!1),0===L.strm.avail_out))return 1}return L.insert=0,k===QG?(_H(L,!0),0===L.strm.avail_out?3:4):L.sym_next&&(_H(L,!1),0===L.strm.avail_out)?1:2})(M,k):M.strategy===CW?((L,k)=>{let M,U,x,V;const F=L.window;for(;;){if(L.lookahead<=DW){if(SH(L),L.lookahead<=DW&&k===qG)return 1;if(0===L.lookahead)break}if(L.match_length=0,L.lookahead>=3&&L.strstart>0&&(x=L.strstart-1,U=F[x],U===F[++x]&&U===F[++x]&&U===F[++x])){V=L.strstart+DW;do{}while(U===F[++x]&&U===F[++x]&&U===F[++x]&&U===F[++x]&&U===F[++x]&&U===F[++x]&&U===F[++x]&&U===F[++x]&&x<V);L.match_length=DW-(V-x),L.match_length>L.lookahead&&(L.match_length=L.lookahead)}if(L.match_length>=3?(M=zG(L,1,L.match_length-3),L.lookahead-=L.match_length,L.strstart+=L.match_length,L.match_length=0):(M=zG(L,0,L.window[L.strstart]),L.lookahead--,L.strstart++),M&&(_H(L,!1),0===L.strm.avail_out))return 1}return L.insert=0,k===QG?(_H(L,!0),0===L.strm.avail_out?3:4):L.sym_next&&(_H(L,!1),0===L.strm.avail_out)?1:2})(M,k):UW[M.level].func(M,k);if(3!==U&&4!==U||(M.status=MW),1===U||3===U)return 0===L.avail_out&&(M.last_flush=-1),eW;if(2===U&&(k===XG?YG(M):k!==$G&&(HG(M,0,0,!1),k===JG&&(lH(M.head),0===M.lookahead&&(M.strstart=0,M.block_start=0,M.insert=0))),pH(L),0===L.avail_out))return M.last_flush=-1,eW}return k!==QG?eW:M.wrap<=0?tW:(2===M.wrap?(EH(M,255&L.adler),EH(M,L.adler>>8&255),EH(M,L.adler>>16&255),EH(M,L.adler>>24&255),EH(M,255&L.total_in),EH(M,L.total_in>>8&255),EH(M,L.total_in>>16&255),EH(M,L.total_in>>24&255)):(fH(M,L.adler>>>16),fH(M,65535&L.adler)),pH(L),M.wrap>0&&(M.wrap=-M.wrap),0!==M.pending?eW:tW)},PH_deflateEnd=L=>{if(AH(L))return mW;const k=L.state.status;return L.state=null,k===kW?cH(L,gW):eW},PH_deflateSetDictionary=(L,k)=>{let M=k.length;if(AH(L))return mW;const U=L.state,x=U.wrap;if(2===x||1===x&&U.status!==LW||U.lookahead)return mW;if(1===x&&(L.adler=vW(L.adler,k,M,0)),U.wrap=0,M>=U.w_size){0===x&&(lH(U.head),U.strstart=0,U.block_start=0,U.insert=0);let L=new Uint8Array(U.w_size);L.set(k.subarray(M-U.w_size,M),0),k=L,M=U.w_size}const V=L.avail_in,F=L.next_in,j=L.input;for(L.avail_in=M,L.next_in=0,L.input=k,SH(U);U.lookahead>=3;){let L=U.strstart,k=U.lookahead-2;do{U.ins_h=hH(U,U.ins_h,U.window[L+3-1]),U.prev[L&U.w_mask]=U.head[U.ins_h],U.head[U.ins_h]=L,L++}while(--k);U.strstart=L,U.lookahead=2,SH(U)}return U.strstart+=U.lookahead,U.block_start=U.strstart,U.insert=U.lookahead,U.lookahead=0,U.match_length=U.prev_length=2,U.match_available=0,L.next_in=F,L.input=j,L.avail_in=V,U.wrap=x,eW};const LH=(L,k)=>Object.prototype.hasOwnProperty.call(L,k);var kH_assign=function(L){const k=Array.prototype.slice.call(arguments,1);for(;k.length;){const M=k.shift();if(M){if("object"!=typeof M)throw new TypeError(M+"must be non-object");for(const k in M)LH(M,k)&&(L[k]=M[k])}}return L},kH_flattenChunks=L=>{let k=0;for(let M=0,U=L.length;M<U;M++)k+=L[M].length;const M=new Uint8Array(k);for(let k=0,U=0,x=L.length;k<x;k++){let x=L[k];M.set(x,U),U+=x.length}return M};let VW=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){VW=!1}const FW=new Uint8Array(256);for(let L=0;L<256;L++)FW[L]=L>=252?6:L>=248?5:L>=240?4:L>=224?3:L>=192?2:1;FW[254]=FW[254]=1;var xH_string2buf=L=>{if("function"==typeof TextEncoder&&TextEncoder.prototype.encode)return(new TextEncoder).encode(L);let k,M,U,x,V,F=L.length,j=0;for(x=0;x<F;x++)M=L.charCodeAt(x),55296==(64512&M)&&x+1<F&&(U=L.charCodeAt(x+1),56320==(64512&U)&&(M=65536+(M-55296<<10)+(U-56320),x++)),j+=M<128?1:M<2048?2:M<65536?3:4;for(k=new Uint8Array(j),V=0,x=0;V<j;x++)M=L.charCodeAt(x),55296==(64512&M)&&x+1<F&&(U=L.charCodeAt(x+1),56320==(64512&U)&&(M=65536+(M-55296<<10)+(U-56320),x++)),M<128?k[V++]=M:M<2048?(k[V++]=192|M>>>6,k[V++]=128|63&M):M<65536?(k[V++]=224|M>>>12,k[V++]=128|M>>>6&63,k[V++]=128|63&M):(k[V++]=240|M>>>18,k[V++]=128|M>>>12&63,k[V++]=128|M>>>6&63,k[V++]=128|63&M);return k},xH_buf2string=(L,k)=>{const M=k||L.length;if("function"==typeof TextDecoder&&TextDecoder.prototype.decode)return(new TextDecoder).decode(L.subarray(0,k));let U,x;const V=new Array(2*M);for(x=0,U=0;U<M;){let k=L[U++];if(k<128){V[x++]=k;continue}let F=FW[k];if(F>4)V[x++]=65533,U+=F-1;else{for(k&=2===F?31:3===F?15:7;F>1&&U<M;)k=k<<6|63&L[U++],F--;F>1?V[x++]=65533:k<65536?V[x++]=k:(k-=65536,V[x++]=55296|k>>10&1023,V[x++]=56320|1023&k)}}return((L,k)=>{if(k<65534&&L.subarray&&VW)return String.fromCharCode.apply(null,L.length===k?L:L.subarray(0,k));let M="";for(let U=0;U<k;U++)M+=String.fromCharCode(L[U]);return M})(V,x)},xH_utf8border=(L,k)=>{(k=k||L.length)>L.length&&(k=L.length);let M=k-1;for(;M>=0&&128==(192&L[M]);)M--;return M<0||0===M?k:M+FW[L[M]]>k?M:k},VH=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const BW=Object.prototype.toString,{Z_NO_FLUSH:jW,Z_SYNC_FLUSH:GW,Z_FULL_FLUSH:WW,Z_FINISH:HW,Z_OK:KW,Z_STREAM_END:zW,Z_DEFAULT_COMPRESSION:YW,Z_DEFAULT_STRATEGY:qW,Z_DEFLATED:XW}=GG;function JH(L){this.options=kH_assign({level:YW,method:XW,chunkSize:16384,windowBits:15,memLevel:8,strategy:qW},L||{});let k=this.options;k.raw&&k.windowBits>0?k.windowBits=-k.windowBits:k.gzip&&k.windowBits>0&&k.windowBits<16&&(k.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new VH,this.strm.avail_out=0;let M=xW(this.strm,k.level,k.method,k.windowBits,k.memLevel,k.strategy);if(M!==KW)throw new Error(jG[M]);if(k.header&&PH_deflateSetHeader(this.strm,k.header),k.dictionary){let L;if(L="string"==typeof k.dictionary?xH_string2buf(k.dictionary):"[object ArrayBuffer]"===BW.call(k.dictionary)?new Uint8Array(k.dictionary):k.dictionary,M=PH_deflateSetDictionary(this.strm,L),M!==KW)throw new Error(jG[M]);this._dict_set=!0}}function XH(L,k){const M=new JH(k);if(M.push(L,!0),M.err)throw M.msg||jG[M.err];return M.result}JH.prototype.push=function(L,k){const M=this.strm,U=this.options.chunkSize;let x,V;if(this.ended)return!1;for(V=k===~~k?k:!0===k?HW:jW,"string"==typeof L?M.input=xH_string2buf(L):"[object ArrayBuffer]"===BW.call(L)?M.input=new Uint8Array(L):M.input=L,M.next_in=0,M.avail_in=M.input.length;;)if(0===M.avail_out&&(M.output=new Uint8Array(U),M.next_out=0,M.avail_out=U),(V===GW||V===WW)&&M.avail_out<=6)this.onData(M.output.subarray(0,M.next_out)),M.avail_out=0;else{if(x=PH_deflate(M,V),x===zW)return M.next_out>0&&this.onData(M.output.subarray(0,M.next_out)),x=PH_deflateEnd(this.strm),this.onEnd(x),this.ended=!0,x===KW;if(0!==M.avail_out){if(V>0&&M.next_out>0)this.onData(M.output.subarray(0,M.next_out)),M.avail_out=0;else if(0===M.avail_in)break}else this.onData(M.output)}return!0},JH.prototype.onData=function(L){this.chunks.push(L)},JH.prototype.onEnd=function(L){L===KW&&(this.result=kH_flattenChunks(this.chunks)),this.chunks=[],this.err=L,this.msg=this.strm.msg};var JW={Deflate:JH,deflate:XH,deflateRaw:function(L,k){return(k=k||{}).raw=!0,XH(L,k)},gzip:function(L,k){return(k=k||{}).gzip=!0,XH(L,k)},constants:GG};const QW=16209;var $H=function(L,k){let M,U,x,V,F,j,z,Q,$,ee,te,ie,ne,re,oe,ce,de,le,ue,he,pe,_e,Ee,fe;const me=L.state;M=L.next_in,Ee=L.input,U=M+(L.avail_in-5),x=L.next_out,fe=L.output,V=x-(k-L.avail_out),F=x+(L.avail_out-257),j=me.dmax,z=me.wsize,Q=me.whave,$=me.wnext,ee=me.window,te=me.hold,ie=me.bits,ne=me.lencode,re=me.distcode,oe=(1<<me.lenbits)-1,ce=(1<<me.distbits)-1;e:do{ie<15&&(te+=Ee[M++]<<ie,ie+=8,te+=Ee[M++]<<ie,ie+=8),de=ne[te&oe];t:for(;;){if(le=de>>>24,te>>>=le,ie-=le,le=de>>>16&255,0===le)fe[x++]=65535&de;else{if(!(16&le)){if(0==(64&le)){de=ne[(65535&de)+(te&(1<<le)-1)];continue t}if(32&le){me.mode=16191;break e}L.msg="invalid literal/length code",me.mode=QW;break e}ue=65535&de,le&=15,le&&(ie<le&&(te+=Ee[M++]<<ie,ie+=8),ue+=te&(1<<le)-1,te>>>=le,ie-=le),ie<15&&(te+=Ee[M++]<<ie,ie+=8,te+=Ee[M++]<<ie,ie+=8),de=re[te&ce];i:for(;;){if(le=de>>>24,te>>>=le,ie-=le,le=de>>>16&255,!(16&le)){if(0==(64&le)){de=re[(65535&de)+(te&(1<<le)-1)];continue i}L.msg="invalid distance code",me.mode=QW;break e}if(he=65535&de,le&=15,ie<le&&(te+=Ee[M++]<<ie,ie+=8,ie<le&&(te+=Ee[M++]<<ie,ie+=8)),he+=te&(1<<le)-1,he>j){L.msg="invalid distance too far back",me.mode=QW;break e}if(te>>>=le,ie-=le,le=x-V,he>le){if(le=he-le,le>Q&&me.sane){L.msg="invalid distance too far back",me.mode=QW;break e}if(pe=0,_e=ee,0===$){if(pe+=z-le,le<ue){ue-=le;do{fe[x++]=ee[pe++]}while(--le);pe=x-he,_e=fe}}else if($<le){if(pe+=z+$-le,le-=$,le<ue){ue-=le;do{fe[x++]=ee[pe++]}while(--le);if(pe=0,$<ue){le=$,ue-=le;do{fe[x++]=ee[pe++]}while(--le);pe=x-he,_e=fe}}}else if(pe+=$-le,le<ue){ue-=le;do{fe[x++]=ee[pe++]}while(--le);pe=x-he,_e=fe}for(;ue>2;)fe[x++]=_e[pe++],fe[x++]=_e[pe++],fe[x++]=_e[pe++],ue-=3;ue&&(fe[x++]=_e[pe++],ue>1&&(fe[x++]=_e[pe++]))}else{pe=x-he;do{fe[x++]=fe[pe++],fe[x++]=fe[pe++],fe[x++]=fe[pe++],ue-=3}while(ue>2);ue&&(fe[x++]=fe[pe++],ue>1&&(fe[x++]=fe[pe++]))}break}}break}}while(M<U&&x<F);ue=ie>>3,M-=ue,ie-=ue<<3,te&=(1<<ie)-1,L.next_in=M,L.next_out=x,L.avail_in=M<U?U-M+5:5-(M-U),L.avail_out=x<F?F-x+257:257-(x-F),me.hold=te,me.bits=ie};const ZW=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),$W=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),eH=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),tH=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var oK=(L,k,M,U,x,V,F,j)=>{const z=j.bits;let Q,$,ee,te,ie,ne,re=0,oe=0,ce=0,de=0,le=0,ue=0,he=0,pe=0,_e=0,Ee=0,fe=null;const me=new Uint16Array(16),ge=new Uint16Array(16);let Te,Se,Re,Ie=null;for(re=0;re<=15;re++)me[re]=0;for(oe=0;oe<U;oe++)me[k[M+oe]]++;for(le=z,de=15;de>=1&&0===me[de];de--);if(le>de&&(le=de),0===de)return x[V++]=20971520,x[V++]=20971520,j.bits=1,0;for(ce=1;ce<de&&0===me[ce];ce++);for(le<ce&&(le=ce),pe=1,re=1;re<=15;re++)if(pe<<=1,pe-=me[re],pe<0)return-1;if(pe>0&&(0===L||1!==de))return-1;for(ge[1]=0,re=1;re<15;re++)ge[re+1]=ge[re]+me[re];for(oe=0;oe<U;oe++)0!==k[M+oe]&&(F[ge[k[M+oe]]++]=oe);if(0===L?(fe=Ie=F,ne=20):1===L?(fe=ZW,Ie=$W,ne=257):(fe=eH,Ie=tH,ne=0),Ee=0,oe=0,re=ce,ie=V,ue=le,he=0,ee=-1,_e=1<<le,te=_e-1,1===L&&_e>852||2===L&&_e>592)return 1;for(;;){Te=re-he,F[oe]+1<ne?(Se=0,Re=F[oe]):F[oe]>=ne?(Se=Ie[F[oe]-ne],Re=fe[F[oe]-ne]):(Se=96,Re=0),Q=1<<re-he,$=1<<ue,ce=$;do{$-=Q,x[ie+(Ee>>he)+$]=Te<<24|Se<<16|Re|0}while(0!==$);for(Q=1<<re-1;Ee&Q;)Q>>=1;if(0!==Q?(Ee&=Q-1,Ee+=Q):Ee=0,oe++,0==--me[re]){if(re===de)break;re=k[M+F[oe]]}if(re>le&&(Ee&te)!==ee){for(0===he&&(he=le),ie+=ce,ue=re-he,pe=1<<ue;ue+he<de&&(pe-=me[ue+he],!(pe<=0));)ue++,pe<<=1;if(_e+=1<<ue,1===L&&_e>852||2===L&&_e>592)return 1;ee=Ee&te,x[ee]=le<<24|ue<<16|ie-V|0}}return 0!==Ee&&(x[ie+Ee]=re-he<<24|64<<16|0),j.bits=le,0};const{Z_FINISH:iH,Z_BLOCK:nH,Z_TREES:rH,Z_OK:oH,Z_STREAM_END:sH,Z_NEED_DICT:aH,Z_STREAM_ERROR:vH,Z_DATA_ERROR:NH,Z_MEM_ERROR:DH,Z_BUF_ERROR:PH,Z_DEFLATED:kH}=GG,MH=16180,UH=16190,xH=16191,FH=16192,BH=16194,jH=16199,GH=16200,WH=16206,HH=16209,AK=L=>(L>>>24&255)+(L>>>8&65280)+((65280&L)<<8)+((255&L)<<24);function bK(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const wK=L=>{if(!L)return 1;const k=L.state;return!k||k.strm!==L||k.mode<MH||k.mode>16211?1:0},OK=L=>{if(wK(L))return vH;const k=L.state;return L.total_in=L.total_out=k.total=0,L.msg="",k.wrap&&(L.adler=1&k.wrap),k.mode=MH,k.last=0,k.havedict=0,k.flags=-1,k.dmax=32768,k.head=null,k.hold=0,k.bits=0,k.lencode=k.lendyn=new Int32Array(852),k.distcode=k.distdyn=new Int32Array(592),k.sane=1,k.back=-1,oH},NK=L=>{if(wK(L))return vH;const k=L.state;return k.wsize=0,k.whave=0,k.wnext=0,OK(L)},DK=(L,k)=>{let M;if(wK(L))return vH;const U=L.state;return k<0?(M=0,k=-k):(M=5+(k>>4),k<48&&(k&=15)),k&&(k<8||k>15)?vH:(null!==U.window&&U.wbits!==k&&(U.window=null),U.wrap=M,U.wbits=k,NK(L))},PK=(L,k)=>{if(!L)return vH;const M=new bK;L.state=M,M.strm=L,M.window=null,M.mode=MH;const U=DK(L,k);return U!==oH&&(L.state=null),U};let KH,zH,YH=!0;const UK=L=>{if(YH){KH=new Int32Array(512),zH=new Int32Array(32);let k=0;for(;k<144;)L.lens[k++]=8;for(;k<256;)L.lens[k++]=9;for(;k<280;)L.lens[k++]=7;for(;k<288;)L.lens[k++]=8;for(oK(1,L.lens,0,288,KH,0,L.work,{bits:9}),k=0;k<32;)L.lens[k++]=5;oK(2,L.lens,0,32,zH,0,L.work,{bits:5}),YH=!1}L.lencode=KH,L.lenbits=9,L.distcode=zH,L.distbits=5},xK=(L,k,M,U)=>{let x;const V=L.state;return null===V.window&&(V.wsize=1<<V.wbits,V.wnext=0,V.whave=0,V.window=new Uint8Array(V.wsize)),U>=V.wsize?(V.window.set(k.subarray(M-V.wsize,M),0),V.wnext=0,V.whave=V.wsize):(x=V.wsize-V.wnext,x>U&&(x=U),V.window.set(k.subarray(M-U,M-U+x),V.wnext),(U-=x)?(V.window.set(k.subarray(M-U,M),0),V.wnext=U,V.whave=V.wsize):(V.wnext+=x,V.wnext===V.wsize&&(V.wnext=0),V.whave<V.wsize&&(V.whave+=x))),0};var qH=NK,QH=PK,FK_inflate=(L,k)=>{let M,U,x,V,F,j,z,Q,$,ee,te,ie,ne,re,oe,ce,de,le,ue,he,pe,_e,Ee=0;const fe=new Uint8Array(4);let me,ge;const Te=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(wK(L)||!L.output||!L.input&&0!==L.avail_in)return vH;M=L.state,M.mode===xH&&(M.mode=FH),F=L.next_out,x=L.output,z=L.avail_out,V=L.next_in,U=L.input,j=L.avail_in,Q=M.hold,$=M.bits,ee=j,te=z,_e=oH;e:for(;;)switch(M.mode){case MH:if(0===M.wrap){M.mode=FH;break}for(;$<16;){if(0===j)break e;j--,Q+=U[V++]<<$,$+=8}if(2&M.wrap&&35615===Q){0===M.wbits&&(M.wbits=15),M.check=0,fe[0]=255&Q,fe[1]=Q>>>8&255,M.check=AW(M.check,fe,2,0),Q=0,$=0,M.mode=16181;break}if(M.head&&(M.head.done=!1),!(1&M.wrap)||(((255&Q)<<8)+(Q>>8))%31){L.msg="incorrect header check",M.mode=HH;break}if((15&Q)!==kH){L.msg="unknown compression method",M.mode=HH;break}if(Q>>>=4,$-=4,pe=8+(15&Q),0===M.wbits&&(M.wbits=pe),pe>15||pe>M.wbits){L.msg="invalid window size",M.mode=HH;break}M.dmax=1<<M.wbits,M.flags=0,L.adler=M.check=1,M.mode=512&Q?16189:xH,Q=0,$=0;break;case 16181:for(;$<16;){if(0===j)break e;j--,Q+=U[V++]<<$,$+=8}if(M.flags=Q,(255&mG(M))!==kH){L.msg="unknown compression method",M.mode=HH;break}if(57344&mG(M)){L.msg="unknown header flags set",M.mode=HH;break}M.head&&(M.head.text=Q>>8&1),512&mG(M)&&4&M.wrap&&(fe[0]=255&Q,fe[1]=Q>>>8&255,M.check=AW(M.check,fe,2,0)),Q=0,$=0,M.mode=16182;case 16182:for(;$<32;){if(0===j)break e;j--,Q+=U[V++]<<$,$+=8}M.head&&(M.head.time=Q),512&mG(M)&&4&M.wrap&&(fe[0]=255&Q,fe[1]=Q>>>8&255,fe[2]=Q>>>16&255,fe[3]=Q>>>24&255,M.check=AW(M.check,fe,4,0)),Q=0,$=0,M.mode=16183;case 16183:for(;$<16;){if(0===j)break e;j--,Q+=U[V++]<<$,$+=8}M.head&&(M.head.xflags=255&Q,M.head.os=Q>>8),512&mG(M)&&4&M.wrap&&(fe[0]=255&Q,fe[1]=Q>>>8&255,M.check=AW(M.check,fe,2,0)),Q=0,$=0,M.mode=16184;case 16184:if(1024&mG(M)){for(;$<16;){if(0===j)break e;j--,Q+=U[V++]<<$,$+=8}M.length=Q,M.head&&(M.head.extra_len=Q),512&mG(M)&&4&M.wrap&&(fe[0]=255&Q,fe[1]=Q>>>8&255,M.check=AW(M.check,fe,2,0)),Q=0,$=0}else M.head&&(M.head.extra=null);M.mode=16185;case 16185:if(1024&mG(M)&&(ie=M.length,ie>j&&(ie=j),ie&&(M.head&&(pe=M.head.extra_len-M.length,M.head.extra||(M.head.extra=new Uint8Array(M.head.extra_len)),M.head.extra.set(U.subarray(V,V+ie),pe)),512&mG(M)&&4&M.wrap&&(M.check=AW(M.check,U,ie,V)),j-=ie,V+=ie,M.length-=ie),M.length))break e;M.length=0,M.mode=16186;case 16186:if(2048&mG(M)){if(0===j)break e;ie=0;do{pe=U[V+ie++],M.head&&pe&&M.length<65536&&(M.head.name+=String.fromCharCode(pe))}while(pe&&ie<j);if(512&mG(M)&&4&M.wrap&&(M.check=AW(M.check,U,ie,V)),j-=ie,V+=ie,pe)break e}else M.head&&(M.head.name=null);M.length=0,M.mode=16187;case 16187:if(4096&mG(M)){if(0===j)break e;ie=0;do{pe=U[V+ie++],M.head&&pe&&M.length<65536&&(M.head.comment+=String.fromCharCode(pe))}while(pe&&ie<j);if(512&mG(M)&&4&M.wrap&&(M.check=AW(M.check,U,ie,V)),j-=ie,V+=ie,pe)break e}else M.head&&(M.head.comment=null);M.mode=16188;case 16188:if(512&mG(M)){for(;$<16;){if(0===j)break e;j--,Q+=U[V++]<<$,$+=8}if(4&M.wrap&&Q!==(65535&M.check)){L.msg="header crc mismatch",M.mode=HH;break}Q=0,$=0}M.head&&(M.head.hcrc=mG(M)>>9&1,M.head.done=!0),L.adler=M.check=0,M.mode=xH;break;case 16189:for(;$<32;){if(0===j)break e;j--,Q+=U[V++]<<$,$+=8}L.adler=M.check=AK(Q),Q=0,$=0,M.mode=UH;case UH:if(0===M.havedict)return L.next_out=F,L.avail_out=z,L.next_in=V,L.avail_in=j,M.hold=Q,M.bits=$,aH;L.adler=M.check=1,M.mode=xH;case xH:if(k===nH||k===rH)break e;case FH:if(M.last){Q>>>=7&$,$-=7&$,M.mode=WH;break}for(;$<3;){if(0===j)break e;j--,Q+=U[V++]<<$,$+=8}switch(M.last=1&Q,Q>>>=1,$-=1,3&Q){case 0:M.mode=16193;break;case 1:if(UK(M),M.mode=jH,k===rH){Q>>>=2,$-=2;break e}break;case 2:M.mode=16196;break;case 3:L.msg="invalid block type",M.mode=HH}Q>>>=2,$-=2;break;case 16193:for(Q>>>=7&$,$-=7&$;$<32;){if(0===j)break e;j--,Q+=U[V++]<<$,$+=8}if((65535&Q)!=(Q>>>16^65535)){L.msg="invalid stored block lengths",M.mode=HH;break}if(M.length=65535&Q,Q=0,$=0,M.mode=BH,k===rH)break e;case BH:M.mode=16195;case 16195:if(ie=M.length,ie){if(ie>j&&(ie=j),ie>z&&(ie=z),0===ie)break e;x.set(U.subarray(V,V+ie),F),j-=ie,V+=ie,z-=ie,F+=ie,M.length-=ie;break}M.mode=xH;break;case 16196:for(;$<14;){if(0===j)break e;j--,Q+=U[V++]<<$,$+=8}if(M.nlen=257+(31&Q),Q>>>=5,$-=5,M.ndist=1+(31&Q),Q>>>=5,$-=5,M.ncode=4+(15&Q),Q>>>=4,$-=4,M.nlen>286||M.ndist>30){L.msg="too many length or distance symbols",M.mode=HH;break}M.have=0,M.mode=16197;case 16197:for(;M.have<M.ncode;){for(;$<3;){if(0===j)break e;j--,Q+=U[V++]<<$,$+=8}M.lens[Te[M.have++]]=7&Q,Q>>>=3,$-=3}for(;M.have<19;)M.lens[Te[M.have++]]=0;if(M.lencode=M.lendyn,M.lenbits=7,me={bits:M.lenbits},_e=oK(0,M.lens,0,19,M.lencode,0,M.work,me),M.lenbits=me.bits,_e){L.msg="invalid code lengths set",M.mode=HH;break}M.have=0,M.mode=16198;case 16198:for(;M.have<M.nlen+M.ndist;){for(;Ee=M.lencode[Q&(1<<M.lenbits)-1],oe=Ee>>>24,ce=Ee>>>16&255,de=65535&Ee,!(oe<=$);){if(0===j)break e;j--,Q+=U[V++]<<$,$+=8}if(de<16)Q>>>=oe,$-=oe,M.lens[M.have++]=de;else{if(16===de){for(ge=oe+2;$<ge;){if(0===j)break e;j--,Q+=U[V++]<<$,$+=8}if(Q>>>=oe,$-=oe,0===M.have){L.msg="invalid bit length repeat",M.mode=HH;break}pe=M.lens[M.have-1],ie=3+(3&Q),Q>>>=2,$-=2}else if(17===de){for(ge=oe+3;$<ge;){if(0===j)break e;j--,Q+=U[V++]<<$,$+=8}Q>>>=oe,$-=oe,pe=0,ie=3+(7&Q),Q>>>=3,$-=3}else{for(ge=oe+7;$<ge;){if(0===j)break e;j--,Q+=U[V++]<<$,$+=8}Q>>>=oe,$-=oe,pe=0,ie=11+(127&Q),Q>>>=7,$-=7}if(M.have+ie>M.nlen+M.ndist){L.msg="invalid bit length repeat",M.mode=HH;break}for(;ie--;)M.lens[M.have++]=pe}}if(M.mode===HH)break;if(0===M.lens[256]){L.msg="invalid code -- missing end-of-block",M.mode=HH;break}if(M.lenbits=9,me={bits:M.lenbits},_e=oK(1,M.lens,0,M.nlen,M.lencode,0,M.work,me),M.lenbits=me.bits,_e){L.msg="invalid literal/lengths set",M.mode=HH;break}if(M.distbits=6,M.distcode=M.distdyn,me={bits:M.distbits},_e=oK(2,M.lens,M.nlen,M.ndist,M.distcode,0,M.work,me),M.distbits=me.bits,_e){L.msg="invalid distances set",M.mode=HH;break}if(M.mode=jH,k===rH)break e;case jH:M.mode=GH;case GH:if(j>=6&&z>=258){L.next_out=F,L.avail_out=z,L.next_in=V,L.avail_in=j,M.hold=Q,M.bits=$,$H(L,te),F=L.next_out,x=L.output,z=L.avail_out,V=L.next_in,U=L.input,j=L.avail_in,Q=M.hold,$=M.bits,M.mode===xH&&(M.back=-1);break}for(M.back=0;Ee=M.lencode[Q&(1<<M.lenbits)-1],oe=Ee>>>24,ce=Ee>>>16&255,de=65535&Ee,!(oe<=$);){if(0===j)break e;j--,Q+=U[V++]<<$,$+=8}if(ce&&0==(240&ce)){for(le=oe,ue=ce,he=de;Ee=M.lencode[he+((Q&(1<<le+ue)-1)>>le)],oe=Ee>>>24,ce=Ee>>>16&255,de=65535&Ee,!(le+oe<=$);){if(0===j)break e;j--,Q+=U[V++]<<$,$+=8}Q>>>=le,$-=le,M.back+=le}if(Q>>>=oe,$-=oe,M.back+=oe,M.length=de,0===ce){M.mode=16205;break}if(32&ce){M.back=-1,M.mode=xH;break}if(64&ce){L.msg="invalid literal/length code",M.mode=HH;break}M.extra=15&ce,M.mode=16201;case 16201:if(M.extra){for(ge=M.extra;$<ge;){if(0===j)break e;j--,Q+=U[V++]<<$,$+=8}M.length+=Q&(1<<M.extra)-1,Q>>>=M.extra,$-=M.extra,M.back+=M.extra}M.was=M.length,M.mode=16202;case 16202:for(;Ee=M.distcode[Q&(1<<M.distbits)-1],oe=Ee>>>24,ce=Ee>>>16&255,de=65535&Ee,!(oe<=$);){if(0===j)break e;j--,Q+=U[V++]<<$,$+=8}if(0==(240&ce)){for(le=oe,ue=ce,he=de;Ee=M.distcode[he+((Q&(1<<le+ue)-1)>>le)],oe=Ee>>>24,ce=Ee>>>16&255,de=65535&Ee,!(le+oe<=$);){if(0===j)break e;j--,Q+=U[V++]<<$,$+=8}Q>>>=le,$-=le,M.back+=le}if(Q>>>=oe,$-=oe,M.back+=oe,64&ce){L.msg="invalid distance code",M.mode=HH;break}M.offset=de,M.extra=15&ce,M.mode=16203;case 16203:if(M.extra){for(ge=M.extra;$<ge;){if(0===j)break e;j--,Q+=U[V++]<<$,$+=8}M.offset+=Q&(1<<M.extra)-1,Q>>>=M.extra,$-=M.extra,M.back+=M.extra}if(M.offset>M.dmax){L.msg="invalid distance too far back",M.mode=HH;break}M.mode=16204;case 16204:if(0===z)break e;if(ie=te-z,M.offset>ie){if(ie=M.offset-ie,ie>M.whave&&M.sane){L.msg="invalid distance too far back",M.mode=HH;break}ie>M.wnext?(ie-=M.wnext,ne=M.wsize-ie):ne=M.wnext-ie,ie>M.length&&(ie=M.length),re=M.window}else re=x,ne=F-M.offset,ie=M.length;ie>z&&(ie=z),z-=ie,M.length-=ie;do{x[F++]=re[ne++]}while(--ie);0===M.length&&(M.mode=GH);break;case 16205:if(0===z)break e;x[F++]=M.length,z--,M.mode=GH;break;case WH:if(M.wrap){for(;$<32;){if(0===j)break e;j--,Q|=U[V++]<<$,$+=8}if(te-=z,L.total_out+=te,M.total+=te,4&M.wrap&&te&&(L.adler=M.check=mG(M)?AW(M.check,x,te,F-te):vW(M.check,x,te,F-te)),te=z,4&M.wrap&&(mG(M)?Q:AK(Q))!==M.check){L.msg="incorrect data check",M.mode=HH;break}Q=0,$=0}M.mode=16207;case 16207:if(M.wrap&&mG(M)){for(;$<32;){if(0===j)break e;j--,Q+=U[V++]<<$,$+=8}if(4&M.wrap&&Q!==(4294967295&M.total)){L.msg="incorrect length check",M.mode=HH;break}Q=0,$=0}M.mode=16208;case 16208:_e=sH;break e;case HH:_e=NH;break e;case 16210:return DH;default:return vH}return L.next_out=F,L.avail_out=z,L.next_in=V,L.avail_in=j,M.hold=Q,M.bits=$,(M.wsize||te!==L.avail_out&&M.mode<HH&&(M.mode<WH||k!==iH))&&xK(L,L.output,L.next_out,te-L.avail_out),ee-=L.avail_in,te-=L.avail_out,L.total_in+=ee,L.total_out+=te,M.total+=te,4&M.wrap&&te&&(L.adler=M.check=mG(M)?AW(M.check,x,te,L.next_out-te):vW(M.check,x,te,L.next_out-te)),L.data_type=M.bits+(M.last?64:0)+(M.mode===xH?128:0)+(M.mode===jH||M.mode===BH?256:0),(0===ee&&0===te||k===iH)&&_e===oH&&(_e=PH),_e},FK_inflateEnd=L=>{if(wK(L))return vH;let k=L.state;return k.window&&(k.window=null),L.state=null,oH},FK_inflateGetHeader=(L,k)=>{if(wK(L))return vH;const M=L.state;return 0==(2&M.wrap)?vH:(M.head=k,k.done=!1,oH)},FK_inflateSetDictionary=(L,k)=>{const M=k.length;let U,x,V;return wK(L)?vH:(U=L.state,0!==U.wrap&&U.mode!==UH?vH:U.mode===UH&&(x=1,x=vW(x,k,M,0),x!==U.check)?NH:(V=xK(L,k,M,M),V?(U.mode=16210,DH):(U.havedict=1,oH)))},BK=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const ZH=Object.prototype.toString,{Z_NO_FLUSH:eK,Z_FINISH:tK,Z_OK:iK,Z_STREAM_END:nK,Z_NEED_DICT:rK,Z_STREAM_ERROR:sK,Z_DATA_ERROR:aK,Z_MEM_ERROR:cK}=GG;function XK(L){this.options=kH_assign({chunkSize:65536,windowBits:15,to:""},L||{});const k=this.options;k.raw&&k.windowBits>=0&&k.windowBits<16&&(k.windowBits=-k.windowBits,0===k.windowBits&&(k.windowBits=-15)),!(k.windowBits>=0&&k.windowBits<16)||L&&L.windowBits||(k.windowBits+=32),k.windowBits>15&&k.windowBits<48&&0==(15&k.windowBits)&&(k.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new VH,this.strm.avail_out=0;let M=QH(this.strm,k.windowBits);if(M!==iK)throw new Error(jG[M]);if(this.header=new BK,FK_inflateGetHeader(this.strm,this.header),k.dictionary&&("string"==typeof k.dictionary?k.dictionary=xH_string2buf(k.dictionary):"[object ArrayBuffer]"===ZH.call(k.dictionary)&&(k.dictionary=new Uint8Array(k.dictionary)),k.raw&&(M=FK_inflateSetDictionary(this.strm,k.dictionary),M!==iK)))throw new Error(jG[M])}function QK(L,k){const M=new XK(k);if(M.push(L),M.err)throw M.msg||jG[M.err];return M.result}XK.prototype.push=function(L,k){const M=this.strm,U=this.options.chunkSize,x=this.options.dictionary;let V,F,j;if(this.ended)return!1;for(F=k===~~k?k:!0===k?tK:eK,"[object ArrayBuffer]"===ZH.call(L)?M.input=new Uint8Array(L):M.input=L,M.next_in=0,M.avail_in=M.input.length;;){for(0===M.avail_out&&(M.output=new Uint8Array(U),M.next_out=0,M.avail_out=U),V=FK_inflate(M,F),V===rK&&x&&(V=FK_inflateSetDictionary(M,x),V===iK?V=FK_inflate(M,F):V===aK&&(V=rK));M.avail_in>0&&V===nK&&M.state.wrap>0&&0!==L[M.next_in];)qH(M),V=FK_inflate(M,F);switch(V){case sK:case aK:case rK:case cK:return this.onEnd(V),this.ended=!0,!1}if(j=M.avail_out,M.next_out&&(0===M.avail_out||V===nK))if("string"===this.options.to){let L=xH_utf8border(M.output,M.next_out),k=M.next_out-L,x=xH_buf2string(M.output,L);M.next_out=k,M.avail_out=U-k,k&&M.output.set(M.output.subarray(L,L+k),0),this.onData(x)}else this.onData(M.output.length===M.next_out?M.output:M.output.subarray(0,M.next_out));if(V!==iK||0!==j){if(V===nK)return V=FK_inflateEnd(this.strm),this.onEnd(V),this.ended=!0,!0;if(0===M.avail_in)break}}return!0},XK.prototype.onData=function(L){this.chunks.push(L)},XK.prototype.onEnd=function(L){L===iK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=kH_flattenChunks(this.chunks)),this.chunks=[],this.err=L,this.msg=this.strm.msg};var dK={Inflate:XK,inflate:QK,inflateRaw:function(L,k){return(k=k||{}).raw=!0,QK(L,k)},ungzip:QK,constants:GG};const{Deflate:lK,deflate:uK,deflateRaw:hK,gzip:pK}=JW,{Inflate:_K,inflate:EK,inflateRaw:fK,ungzip:mK}=dK;var gK=uK,TK=EK,SK=function(L){return L[L.ONE_BYTE=0]="ONE_BYTE",L[L.TWO_BYTE=1]="TWO_BYTE",L}(SK||{});class lY{constructor(){xg(this,"_sequence",0),xg(this,"_startTime",Date.now()),xg(this,"isUseOneByte",!0)}get startTime(){const L=Date.now()-this._startTime;return L<Math.pow(2,16)?L:(this._startTime+=Math.pow(2,16),this.startTime)}get sequence(){return this._sequence<Math.pow(2,32)?this._sequence++:(this._sequence-=Math.pow(2,32),this.sequence)}serialize(L){const k={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:L};if(L.byteLength>128){const M=new Uint8Array(4);M.set([1,0,0,0]);const U={id:0,length:4,data:M.buffer},x={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[U]};k.commonPacketHeader.extension=1,k.extension=x,k.payload=this.compress(L),k.commonPacketHeader.length=8+(k.extension.length+2)+k.payload.byteLength}else k.commonPacketHeader.length=8+k.payload.byteLength;zA("SHOW_DATASTREAM2_LOG")&&Eb.debug("send data header: ".concat(JSON.stringify(k.commonPacketHeader)));const M=new ArrayBuffer(k.commonPacketHeader.length),U=new Uint8Array(M),x=new DataView(M);let V=0;if(x.setUint16(V,k.commonPacketHeader.extension<<15|k.commonPacketHeader.reserved<<14|k.commonPacketHeader.length,!0),V+=2,x.setUint32(V,k.commonPacketHeader.sequence,!0),V+=4,x.setUint16(V,k.commonStreamHeader,!0),V+=2,k.extension){const L=this.serializeExtension(k.extension);U.set(new Uint8Array(L),V),V+=L.byteLength}if(U.set(new Uint8Array(k.payload),V),V+=k.payload.byteLength,V!==k.commonPacketHeader.length)throw Error("serialize error!");return M}deserialize(L){if(L.byteLength<4)return new ArrayBuffer(0);const k=new DataView(L);let M=0;const U=k.getUint16(M,!0);M+=2;const x={length:16383&U,reserved:(16384&U)>>14,extension:(32768&U)>>15,sequence:k.getUint16(M+2,!0)<<16|k.getUint16(M,!0)};let V,F;if(M+=4,zA("SHOW_DATASTREAM2_LOG")&&Eb.debug("receive data header: ".concat(JSON.stringify(x))),k.getUint16(M,!0),M+=2,x.extension){F=this.deserializeExtension(L.slice(M)),M+=2+F.length,V=L.slice(M);let k=!1;if(F.datas.length>0){const L=F.datas.find((L=>0===L.id));L&&(k=1==(1&new DataView(L.data).getUint32(0,!0)))}V=k?this.decompress(V):V}else V=L.slice(8);return V}serializeExtension(L){const{profile:k,length:M,datas:U}=L,x=new ArrayBuffer(M+2),V=new Uint8Array(x),F=new DataView(x);let j=0;if(F.setUint8(j++,k),F.setUint8(j++,M),U.forEach((L=>{k?(F.setUint8(j++,L.id),F.setUint8(j++,L.length),V.set(new Uint8Array(L.data),j),j+=L.data.byteLength):(F.setUint8(j++,L.id|L.length<<4),V.set(new Uint8Array(L.data),j),j+=L.data.byteLength)})),j!==M+2)throw Error("serialize extension error, is ".concat(j,"!==").concat(M+2));return x}deserializeExtension(L){const k=new DataView(L);let M=0;const U=k.getUint8(M);M++;const x=k.getUint8(M);M++;const V=U===SK.TWO_BYTE,F=[],j=new DataView(L,2);let z=0;for(;z<x;){let L=0,k=0,M=new ArrayBuffer(0);V?(L=j.getUint8(z),z++,k=j.getUint8(z),z++):(L=15&j.getUint8(z),k=j.getUint8(z)>>4,z++),k>0&&(M=j.buffer.slice(z+2,z+2+k),z+=M.byteLength),F.push({id:L,length:k,data:M})}if(z!==x)throw Error("parse error");return{profile:U,length:x,datas:F}}decompress(L){return TK(new Uint8Array(L))}compress(L){return gK(new Uint8Array(L))}}const RK={name:"DataStream",create:(L,k)=>{const M=k?new yU(L):new AU(L);return M.useDataStream(new lY),M}};class hY extends My{constructor(L,k,M){super(),xg(this,"ws",void 0),xg(this,"requestId",1),xg(this,"heartBeatTimer",void 0),xg(this,"joinInfo",void 0),xg(this,"clientId",void 0),xg(this,"onOpen",(()=>{this.emit("open"),this.startHeartBeatCheck()})),xg(this,"onClose",(L=>{this.emit("close"),this.dispose()})),xg(this,"onMessage",(L=>{const k=JSON.parse(L.data);if(!k||"serverResponse"!==k.command||!k.requestId)return k&&"serverStatus"===k.command&&k.serverStatus&&k.serverStatus.command?(this.emit("status",k.serverStatus),void this.emit(k.serverStatus.command,k.serverStatus)):void 0;this.emit("req_".concat(k.requestId),k)})),this.joinInfo=L,this.clientId=k,this.ws=new GO("cross-channel-".concat(this.clientId),M),this.ws.on(Pw.RECONNECTING,(()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")})),this.ws.on(Pw.CONNECTED,this.onOpen),this.ws.on(Pw.ON_MESSAGE,this.onMessage),this.ws.on(Pw.CLOSED,this.onClose)}isConnect(){return"connected"===this.ws.state}sendMessage(L){const k=this.requestId++;return L.requestId=k,L.seq=k,this.ws.sendMessage(L),k}waitStatus(L){return new Mp(((k,M)=>{const U=window.setTimeout((()=>{M(new Ib(iv.TIMEOUT,"wait status timeout, status: ".concat(L)))}),5e3);this.once(L,(x=>{window.clearTimeout(U),x.state&&0!==x.state?M(new Ib(iv.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(L))):k(void 0)})),this.once("dispose",(()=>{window.clearTimeout(U),M(new Ib(iv.WS_ABORT))}))}))}async request(L){if("closed"===this.ws.state)throw new Ib(iv.WS_DISCONNECT);"connected"!==this.ws.state&&await(()=>new Mp(((L,k)=>{this.ws.once(Pw.CLOSED,(()=>k(new Ib(iv.WS_ABORT)))),this.ws.once(Pw.CONNECTED,L)})))();const k=this.sendMessage(L),M=new Mp(((L,M)=>{const n=()=>{M(new Ib(iv.WS_ABORT))};this.ws.once(Pw.RECONNECTING,n),this.ws.once(Pw.CLOSED,n),this.once("req_".concat(k),L),EA(3e3).then((()=>{this.removeAllListeners("req_".concat(k)),this.ws.off(Pw.RECONNECTING,n),this.ws.off(Pw.CLOSED,n),M(new Ib(iv.TIMEOUT,"cross channel ws request timeout"))}))})),U=await M;if(!U||200!==U.code)throw new Ib(iv.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(U)));return U}async connect(L){this.ws.removeAllListeners(Pw.REQUEST_NEW_URLS),this.ws.on(Pw.REQUEST_NEW_URLS,(k=>{k(L)})),await this.ws.init(L)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(L){const k=this.requestId++;return L.requestId=k,this.ws.sendMessage(L),k}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval((()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})}),3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class pY extends My{set state(L){L!==this._state&&(L!==zw.RELAY_STATE_FAILURE&&(this.errorCode=Yw.RELAY_OK),this.emit("state",L,this.errorCode),this._state=L)}get state(){return this._state}constructor(L,k,M,U,x){super(),xg(this,"joinInfo",void 0),xg(this,"sid",void 0),xg(this,"clientId",void 0),xg(this,"cancelToken",KC.CancelToken.source()),xg(this,"workerToken",void 0),xg(this,"requestId",0),xg(this,"signal",void 0),xg(this,"prevChannelMediaConfig",void 0),xg(this,"httpRetryConfig",void 0),xg(this,"_resolution",void 0),xg(this,"_state",zw.RELAY_STATE_IDLE),xg(this,"errorCode",Yw.RELAY_OK),xg(this,"onStatus",(L=>{Eb.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(L))),L&&L.command&&("onAudioPacketReceived"===L.command&&this.emit("event",Hw.PACKET_RECEIVED_AUDIO_FROM_SRC),"onVideoPacketReceived"===L.command&&this.emit("event",Hw.PACKET_RECEIVED_VIDEO_FROM_SRC),"onSrcTokenPrivilegeDidExpire"===L.command&&(this.errorCode=Yw.SRC_TOKEN_EXPIRED,this.state=zw.RELAY_STATE_FAILURE),"onDestTokenPrivilegeDidExpire"===L.command&&(this.errorCode=Yw.DEST_TOKEN_EXPIRED,this.state=zw.RELAY_STATE_FAILURE))})),xg(this,"onReconnect",(async()=>{Eb.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",Hw.NETWORK_DISCONNECTED),this.state=zw.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch((L=>{this.state!==zw.RELAY_STATE_IDLE&&(Eb.error("auto restart channel media relay failed",L.toString()),this.errorCode=Yw.SERVER_CONNECTION_LOST,this.state=zw.RELAY_STATE_FAILURE)}))})),this.joinInfo=L,this.clientId=k,this.sid=mA(),this.signal=new hY(this.joinInfo,this.clientId,M),this.httpRetryConfig=U,this._resolution=x}async startChannelMediaRelay(L){if(this.state!==zw.RELAY_STATE_IDLE)throw new Ib(iv.INVALID_OPERATION);this.state=zw.RELAY_STATE_CONNECTING,await this.connect(),Eb.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(L)}catch(L){if(L.data&&L.data.serverResponse&&"SetSourceChannel"===L.data.serverResponse.command)throw new Ib(iv.CROSS_CHANNEL_FAILED_JOIN_SRC);if(L.data&&L.data.serverResponse&&"SetDestChannelStatus"===L.serverResponse.command)throw new Ib(iv.CROSS_CHANNEL_FAILED_JOIN_DEST);if(L.data&&L.data.serverResponse&&"StartPacketTransfer"===L.serverResponse.command)throw new Ib(iv.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST);throw L}this.prevChannelMediaConfig=L}async updateChannelMediaRelay(L){if(this.state!==zw.RELAY_STATE_RUNNING)throw new Ib(iv.INVALID_OPERATION);await this.sendUpdateMessage(L),this.prevChannelMediaConfig=L}async setVideoProfile(L){if(this._resolution=L,this.state!==zw.RELAY_STATE_RUNNING)throw new Ib(iv.INVALID_OPERATION);const k=this.genMessage(Ww.SetVideoProfile);await this.signal.request(k),Eb.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),Eb.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=zw.RELAY_STATE_IDLE,this.dispose()}dispose(){Eb.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=KC.CancelToken.source(),this.state=zw.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){const L=await async function Jx(L,k,M){const U=zA("UAP_AP").slice(0,zA("AJAX_REQUEST_CONCURRENT")).map((k=>L.proxyServer?"https://".concat(L.proxyServer,"/ap/?url=").concat(k+"/api/v1?action=uap"):"https://".concat(k,"/api/v1?action=uap"))),x=U.map((U=>function(L,k,M,U){const x={command:"convergeAllocateEdge",sid:k.sid,appId:k.appId,token:k.token,ts:Date.now(),version:Mv,cname:k.cname,uid:k.uid.toString(),requestId:Ex,seq:Ex};Ex+=1;const V={service_name:"tele_channel",json_body:JSON.stringify(x)};return PA((async()=>{const k=await fx(L,{data:V,cancelToken:M,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(0!==k.code){const L=new Ib(iv.UNEXPECTED_RESPONSE,"cross channel ap error, code"+k.code,{retry:!0});throw Eb.error(L.toString()),L}const U=JSON.parse(k.json_body);if(200!==U.code){const L=new Ib(iv.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(U.code,", reason: ").concat(U.reason));throw Eb.error(L.toString()),L}if(!U.servers||0===U.servers.length){const L=new Ib(iv.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw Eb.error(L.toString()),L}return{vid:U.vid,workerToken:U.workerToken,addressList:(zA("CHANNEL_MEDIA_RELAY_SERVERS")||U.servers).map((L=>"wss://".concat(L.address.replace(/\./g,"-"),".").concat(zA("WORKER_DOMAIN"),":").concat(L.wss)))}}),void 0,(L=>!!(L.code!==iv.OPERATION_ABORTED&&L.code!==iv.UNEXPECTED_RESPONSE||L.data&&L.data.retry)),U)}(U,L,k,M)));try{const L=await Fx(x);return x.forEach((L=>L.cancel())),L}catch(L){throw L[0]}}(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=L.workerToken,await this.signal.connect(L.addressList),this.emit("event",Hw.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(L){const k=this.genMessage(Ww.StopPacketTransfer);await this.signal.request(k),await this.signal.waitStatus("Normal Quit"),Eb.debug("[".concat(this.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));const M=this.genMessage(Ww.SetSdkProfile,L);await this.signal.request(M),Eb.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const U=this.genMessage(Ww.SetSourceChannel,L);await this.signal.request(U),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",Hw.PACKET_JOINED_SRC_CHANNEL),Eb.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const x=this.genMessage(Ww.SetSourceUserId,L);await this.signal.request(x),Eb.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const V=this.genMessage(Ww.SetDestChannel,L);await this.signal.request(V),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",Hw.PACKET_JOINED_DEST_CHANNEL),Eb.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));const F=this.genMessage(Ww.StartPacketTransfer,L);await this.signal.request(F),this.emit("event",Hw.PACKET_SENT_TO_DEST_CHANNEL),this.state=zw.RELAY_STATE_RUNNING,Eb.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(L){const k=this.genMessage(Ww.UpdateDestChannel,L);await this.signal.request(k),this.emit("event",Hw.PACKET_UPDATE_DEST_CHANNEL),Eb.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){const L=this.genMessage(Ww.StopPacketTransfer);await this.signal.request(L),Eb.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(L,k){const M=[],U=[],x=[];this.requestId+=1;const V={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:Mv,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};"4.22.1"===V.sdkVersion&&(V.sdkVersion="0.0.1");let F=null,j=null;switch(L){case Ww.SetSdkProfile:return V.clientRequest={command:"SetSdkProfile",type:"multi_channel"},V;case Ww.SetSourceChannel:if(j=k&&k.getSrcChannelMediaInfo(),!j)throw new Ib(iv.UNEXPECTED_ERROR,"can not find source config");return V.clientRequest={command:"SetSourceChannel",uid:"0",channelName:j.channelName,token:j.token||this.joinInfo.appId},V;case Ww.SetSourceUserId:if(j=k&&k.getSrcChannelMediaInfo(),!j)throw new Ib(iv.UNEXPECTED_ERROR,"can not find source config");return V.clientRequest={command:"SetSourceUserId",uid:j.uid+""},V;case Ww.SetDestChannel:if(F=k&&k.getDestChannelMediaInfo(),!F)throw new Ib(iv.UNEXPECTED_ERROR,"can not find dest config");return F.forEach((L=>{M.push(L.channelName),U.push(L.uid+""),x.push(L.token||this.joinInfo.appId)})),V.clientRequest={command:"SetDestChannel",channelName:M,uid:U,token:x},V;case Ww.StartPacketTransfer:return V.clientRequest={command:"StartPacketTransfer"},V;case Ww.Reconnect:return V.clientRequest={command:"Reconnect"},V;case Ww.StopPacketTransfer:return V.clientRequest={command:"StopPacketTransfer"},V;case Ww.UpdateDestChannel:if(F=k&&k.getDestChannelMediaInfo(),!F)throw new Ib(iv.UNEXPECTED_ERROR,"can not find dest config");return F.forEach((L=>{M.push(L.channelName),U.push(L.uid+""),x.push(L.token||this.joinInfo.appId)})),V.clientRequest={command:"UpdateDestChannel",channelName:M,uid:U,token:x},V;case Ww.SetVideoProfile:V.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return V}}const IK={name:"ChannelMediaRelay",create:function(L){return new pY(L.joinInfo,L.clientId,L.websocketRetryConfig||Ov,L.httpRetryConfig||Ov,L.resolution)}};function EY(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function fY(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?EY(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):EY(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}class mY extends My{constructor(L,k,M,U){super(),xg(this,"spec",void 0),xg(this,"token",void 0),xg(this,"websocket",void 0),xg(this,"pingpongTimer",void 0),xg(this,"reconnectMode","retry"),xg(this,"serviceMode",void 0),xg(this,"reqId",0),xg(this,"commandReqId",0),xg(this,"handleWebSocketOpen",(()=>{this.reconnectMode="retry",this.startPingPong()})),xg(this,"handleWebSocketMessage",(L=>{if(!L.data)return;const k=JSON.parse(L.data);k.requestId?this.emit("@".concat(k.requestId,"-").concat(k.sid),k):(Ab.workerEvent(this.spec.sid,{actionType:"status",serverCode:k.code,workerType:this.serviceMode===Lw.TRANSCODE?1:2}),this.emit(Fw.PUBLISH_STREAM_STATUS,k))})),this.spec=k,this.token=L,this.serviceMode=U,this.websocket=new GO("live-streaming",M),this.websocket.on(Pw.CONNECTED,this.handleWebSocketOpen),this.websocket.on(Pw.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(Pw.REQUEST_NEW_URLS,((L,k)=>{Xy(this,Fw.REQUEST_NEW_ADDRESS).then(L).catch(k)})),this.websocket.on(Pw.RECONNECTING,(()=>{this.websocket.reconnectMode=this.reconnectMode}))}init(L){return this.websocket.init(L)}async request(L,k,M,U){this.reqId+=1,"request"===L&&(this.commandReqId+=1);const x=this.commandReqId,V=this.reqId;if(!V||!this.websocket)throw new Ib(iv.UNEXPECTED_ERROR);const F=fY({command:L,sdkVersion:"4.22.1"===Mv?"0.0.1":Mv,seq:V,requestId:V,allocate:M,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},k);if("closed"===this.websocket.state)throw new Ib(iv.WS_DISCONNECT);const a=()=>new Mp(((L,k)=>{this.websocket.once(Pw.CLOSED,(()=>k(new Ib(iv.WS_ABORT)))),this.websocket.once(Pw.CONNECTED,L)}));"connected"!==this.websocket.state&&await a(),F.clientRequest&&(F.clientRequest.workerToken=this.token);const j=new Mp(((L,k)=>{const i=()=>{k(new Ib(iv.WS_ABORT))};this.websocket.once(Pw.RECONNECTING,i),this.websocket.once(Pw.CLOSED,i),this.once("@".concat(V,"-").concat(this.spec.sid),(k=>{L(k)}))}));U&&Ab.workerEvent(this.spec.sid,fY(fY({},U),{},{requestId:x,actionType:"request",payload:JSON.stringify(k.clientRequest),serverCode:0,code:0}));const z=Date.now();this.websocket.sendMessage(F);let Q=null;try{Q=await j}catch(U){if("closed"===this.websocket.state)throw U;return await a(),await this.request(L,k,M)}return U&&Ab.workerEvent(this.spec.sid,fY(fY({},U),{},{requestId:x,actionType:"response",payload:JSON.stringify(Q.serverResponse),serverCode:Q.code,success:200===Q.code,responseTime:Date.now()-z})),200!==Q.code&&this.handleResponseError(Q),Q}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){const L="4.22.1"===Mv?"0.0.1":Mv;this.reqId+=1,"connected"===this.websocket.state?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:L,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(L){switch(L.code){case Gw.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void Eb.warning("live stream response already exists stream");case Gw.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case Gw.LIVE_STREAM_RESPONSE_BAD_STREAM:case Gw.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new Ib(iv.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:L.code}).throw();case Gw.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if("UnpublishStream"===L.serverResponse.command)return;throw new Ib(iv.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case Gw.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new Ib(iv.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:L.code}).throw();case Gw.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const k=new Ib(iv.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(Fw.WARNING,k,L.serverResponse.url)}case Gw.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{const k=new Ib(iv.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(Fw.WARNING,k,L.serverResponse.url)}case Gw.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new Ib(iv.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case Gw.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new Ib(iv.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:L.code}).throw();case Gw.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{const k=new Ib(iv.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(Fw.WARNING,k,L.serverResponse.url)}case Gw.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new Ib(iv.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:L.code}).throw();case Gw.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new Ib(iv.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case Gw.LIVE_STREAM_RESPONSE_WORKER_LOST:case Gw.LIVE_STREAM_RESPONSE_WORKER_QUIT:if("UnpublishStream"===L.serverResponse.command)return;throw new Ib(iv.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case Gw.ERROR_FAIL_SEND_MESSAGE:if("UnpublishStream"===L.serverResponse.command)return;if("UpdateTranscoding"===L.serverResponse.command||"ControlStream"===L.serverResponse.command)return new Ib(iv.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:L.code}).throw();throw new Ib(iv.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case Gw.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case Gw.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case Gw.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case Gw.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new Ib(iv.LIVE_STREAMING_CDN_ERROR,"",{code:L.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval((()=>{"connected"===this.websocket.state&&this.request("ping",{}).catch(TA)}),6e3)}}function TY(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}function SY(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?TY(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):TY(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}class gY extends My{constructor(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ov,M=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ov;super(),xg(this,"onLiveStreamWarning",void 0),xg(this,"onLiveStreamError",void 0),xg(this,"spec",void 0),xg(this,"retryTimeout",1e4),xg(this,"connection",void 0),xg(this,"httpRetryConfig",void 0),xg(this,"wsRetryConfig",void 0),xg(this,"streamingTasks",new Map),xg(this,"isStartingStreamingTask",!1),xg(this,"taskMutex",new wv("live-streaming")),xg(this,"cancelToken",KC.CancelToken.source()),xg(this,"transcodingConfig",void 0),xg(this,"uapResponse",void 0),xg(this,"lastTaskId",1),xg(this,"statusError",new Map),this.spec=L,this.httpRetryConfig=M,this.wsRetryConfig=k}async setTranscodingConfig(L){const k=SY(SY({},Vw),L);66!==k.videoCodecProfile&&77!==k.videoCodecProfile&&100!==k.videoCodecProfile&&(Eb.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(k.videoCodecProfile," -> 100")),k.videoCodecProfile=100),k.transcodingUsers||(k.transcodingUsers=k.userConfigs),k.transcodingUsers&&(k.transcodingUsers=k.transcodingUsers.map((L=>SY(SY(SY({},kw),L),{},{zOrder:L.zOrder?L.zOrder+1:1})))),function(L){by(L.width)||Iy(L.width,"config.width",0,1e4),by(L.height)||Iy(L.height,"config.height",0,1e4),by(L.videoBitrate)||Iy(L.videoBitrate,"config.videoBitrate",1,1e6),by(L.videoFrameRate)||Iy(L.videoFrameRate,"config.videoFrameRate"),by(L.lowLatency)||Ry(L.lowLatency,"config.lowLatency"),by(L.audioSampleRate)||Cy(L.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),by(L.audioBitrate)||Iy(L.audioBitrate,"config.audioBitrate",1,128),by(L.audioChannels)||Cy(L.audioChannels,"config.audioChannels",[1,2,3,4,5]),by(L.videoGop)||Iy(L.videoGop,"config.videoGop"),by(L.videoCodecProfile)||Cy(L.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),by(L.userCount)||Iy(L.userCount,"config.userCount",0,17),by(L.backgroundColor)||Iy(L.backgroundColor,"config.backgroundColor",0,16777215),by(L.userConfigExtraInfo)||yy(L.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),L.transcodingUsers&&!by(L.transcodingUsers)&&(Ay(L.transcodingUsers,"config.transcodingUsers"),L.transcodingUsers.forEach(((L,k)=>{Uw(L.uid),by(L.x)||Iy(L.x,"transcodingUser[".concat(k,"].x"),0,1e4),by(L.y)||Iy(L.y,"transcodingUser[".concat(k,"].y"),0,1e4),by(L.width)||Iy(L.width,"transcodingUser[".concat(k,"].width"),0,1e4),by(L.height)||Iy(L.height,"transcodingUser[".concat(k,"].height"),0,1e4),by(L.zOrder)||Iy(L.zOrder-1,"transcodingUser[".concat(k,"].zOrder"),0,100),by(L.alpha)||Iy(L.alpha,"transcodingUser[".concat(k,"].alpha"),0,1,!1)}))),by(L.watermark)||Bw(L.watermark,"watermark"),by(L.backgroundImage)||Bw(L.backgroundImage,"backgroundImage"),L.images&&!by(L.images)&&(Ay(L.images,"config.images"),L.images.forEach(((L,k)=>{Bw(L,"images[".concat(k,"]"))})))}(k);const M=[];k.images&&M.push(...k.images.map((L=>SY(SY(SY({},xw),L),{},{zOrder:255})))),k.backgroundImage&&(M.push(SY(SY(SY({},xw),k.backgroundImage),{},{zOrder:0})),delete k.backgroundImage),k.watermark&&(M.push(SY(SY(SY({},xw),k.watermark),{},{zOrder:255})),delete k.watermark),k.images=M,k.transcodingUsers&&(k.userConfigs=k.transcodingUsers.map((L=>SY({},L))),k.userCount=k.transcodingUsers.length,delete k.transcodingUsers);const U=(k.userConfigs||[]).map((L=>"number"==typeof L.uid?Mp.resolve(L.uid):Hx(L.uid,this.spec,this.cancelToken.token,this.httpRetryConfig)));if((await Mp.all(U)).forEach(((L,M)=>{k.userConfigs&&k.userConfigs[M]&&(k.userConfigs[M].uid=L)})),this.transcodingConfig=k,this.connection)try{var x;const L=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(dN(x=this.streamingTasks).call(x)).map((L=>L.taskId)).join("#")});Eb.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(L.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(L){if(!L.data||!L.data.retry)throw L;L.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach((k=>{Eb.warning("[".concat(this.spec.clientId,"] live streaming receive error"),L.toString(),"try to republish",k.url),this.startLiveStreamingTask(k.url,k.mode,L).then((()=>{Eb.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(k.url," success"))})).catch((L=>{Eb.error("[".concat(this.spec.clientId,"] live streaming republish failed"),k.url,L.toString()),this.onLiveStreamError&&this.onLiveStreamError(k.url,L)}))}))}}async startLiveStreamingTask(L,k,M){if(!this.transcodingConfig&&k===Lw.TRANSCODE)throw new Ib(iv.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");const U={command:"PublishStream",ts:Date.now(),url:L,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};Eb.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(L,", mode: ").concat(k));const x=await this.taskMutex.lock();if(!this.connection&&M)return void x();if(this.streamingTasks.get(L)&&!M)return x(),new Ib(iv.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(k))}catch(L){throw x(),L}switch(k){case Lw.TRANSCODE:U.transcodingConfig=SY({},this.transcodingConfig);case Lw.RAW:}this.uapResponse&&this.uapResponse.vid&&(U.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;const V=this.lastTaskId++;try{const F=new Mp(((k,U)=>{EA(this.retryTimeout).then((()=>{if(M)return U(M);const k=this.statusError.get(L);return k?(this.statusError.delete(L),U(k)):void 0}))})),j=await Mp.race([this.connection.request("request",{clientRequest:U},!0,{url:L,command:"PublishStream",workerType:k===Lw.TRANSCODE?1:2,requestByUser:!M,tid:V.toString()}),F]);this.isStartingStreamingTask=!1,Eb.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(j.code)),this.streamingTasks.set(L,{clientRequest:U,mode:k,url:L,taskId:V}),x()}catch(U){if(x(),this.isStartingStreamingTask=!1,!U.data||!U.data.retry||M)throw U;return U.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(L,k,U)):await this.startLiveStreamingTask(L,k,U)}}stopLiveStreamingTask(L){return new Mp(((k,M)=>{const U=this.streamingTasks.get(L);if(!U||!this.connection)return new Ib(iv.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();const x=U.mode;U.abortTask=()=>{Eb.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(L),k()},this.connection.request("request",{clientRequest:{command:"UnpublishStream",url:U.url}},!1,{url:L,command:"UnPublishStream",workerType:x===Lw.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then((M=>{Eb.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(M.code)),this.streamingTasks.delete(L),0===this.streamingTasks.size&&(this.connection&&this.connection.close(),this.connection=void 0),k()})).catch(M)}))}resetAllTask(){var L;const k=Array.from(dN(L=this.streamingTasks).call(L));this.terminate();for(const L of k)this.startLiveStreamingTask(L.url,L.mode).catch((k=>{this.onLiveStreamError&&this.onLiveStreamError(L.url,k)}))}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=KC.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(L){if(this.connection)throw new Ib(iv.UNEXPECTED_ERROR,"live streaming connection has already connected");const k=await Xy(this,jw.REQUEST_WORKER_MANAGER_LIST,L);return this.uapResponse=k,this.connection=new mY(k.workerToken,this.spec,this.wsRetryConfig,L),this.connection.on(Fw.WARNING,((L,k)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(k,L))),this.connection.on(Fw.PUBLISH_STREAM_STATUS,(L=>this.handlePublishStreamServer(L))),this.connection.on(Fw.REQUEST_NEW_ADDRESS,((k,M)=>{if(!this.connection)return M(new Ib(iv.UNEXPECTED_ERROR,"can not get new live streaming address list"));Xy(this,jw.REQUEST_WORKER_MANAGER_LIST,L).then((L=>{this.uapResponse=L,k(L.addressList)})).catch(M)})),await this.connection.init(k.addressList),this.connection}handlePublishStreamServer(L){const k=L.serverStatus&&L.serverStatus.url||"empty_url",M=this.streamingTasks.get(k),U=L.reason;switch(L.code){case Gw.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case Gw.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case Gw.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case Gw.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{const U=new Ib(iv.LIVE_STREAMING_CDN_ERROR,"",{code:L.code});if(M)return Eb.error(U.toString()),this.onLiveStreamError&&this.onLiveStreamError(k,U);if(!this.isStartingStreamingTask)return;this.statusError.set(k,U)}case Gw.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const L=new Ib(iv.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,U);return this.onLiveStreamWarning&&this.onLiveStreamWarning(k,L)}case Gw.LIVE_STREAM_RESPONSE_WORKER_LOST:case Gw.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var x;if(!this.connection)return;this.connection.tryNextAddress();const k=Array.from(dN(x=this.streamingTasks).call(x));for(const M of k)M.abortTask?M.abortTask():(Eb.warning("[".concat(this.spec.clientId,"] publish stream status code"),L.code,"try to republish",M.url),this.startLiveStreamingTask(M.url,M.mode,new Ib(iv.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:L.code})).then((()=>{Eb.debug("[".concat(this.spec.clientId,"] republish live stream success"),M.url)})).catch((L=>{Eb.error(L.toString()),this.onLiveStreamError&&this.onLiveStreamError(M.url,L)})));return}}}hasUrl(L){return this.streamingTasks.has(L)}}const yK={name:"LiveStreaming",create:function(L){return new gY(L.joinInfo,L.websocketRetryConfig||Ov,L.httpRetryConfig||Ov)}};function vY(L){let k={};e:for(;!UY(L);){let M=YY(L);switch(M>>>3){case 0:break e;case 1:k.requestId=FY(L,YY(L));break;case 2:k.requestType=YY(L)>>>0;break;case 3:k.scorePorn=HY(L);break;case 4:k.scoreSexy=HY(L);break;case 5:k.scoreNeutral=HY(L);break;case 6:k.requestScene=YY(L)>>>0;break;case 7:k.scene=YY(L)>>>0;break;default:bY(L,7&M)}}return k}function yY(L,k){let M=L.service;void 0!==M&&(qY(k,8),qY(k,M));let U=L.vendor;void 0!==U&&(qY(k,16),qY(k,U));let x=L.token;void 0!==x&&(qY(k,26),BY(k,x));let V=L.callbackUrl;void 0!==V&&(qY(k,34),BY(k,V))}function AY(L){let k=YY(L),M=L.limit;return L.limit=L.offset+k,M}function bY(L,k){switch(k){case 0:for(;128&GY(L););break;case 2:MY(L,YY(L));break;case 5:MY(L,4);break;case 1:MY(L,8);break;default:throw new Error("Unimplemented type: "+k)}}let CK=new Float32Array(1);new Uint8Array(CK.buffer);let vK=new Float64Array(1),LK=new Uint8Array(vK.buffer);function DY(L){return{low:L|=0,high:L>>31,unsigned:L>=0}}let kK=[];function LY(){const L=kK.pop();return L?(L.offset=L.limit=0,L):{bytes:new Uint8Array(64),offset:0,limit:0}}function kY(L){kK.push(L)}function MY(L,k){if(L.offset+k>L.limit)throw new Error("Skip past limit");L.offset+=k}function UY(L){return L.offset>=L.limit}function xY(L,k){let M=L.bytes,U=L.offset,x=L.limit,V=U+k;if(V>M.length){let k=new Uint8Array(2*V);k.set(M),L.bytes=k}return L.offset=V,V>x&&(L.limit=V),U}function VY(L,k){let M=L.offset;if(M+k>L.limit)throw new Error("Read past limit");return L.offset+=k,M}function FY(L,k){let M=VY(L,k),U=String.fromCharCode,x=L.bytes,V="ï¿½",F="";for(let L=0;L<k;L++){let j,z,Q,$,ee=x[L+M];0==(128&ee)?F+=U(ee):192==(224&ee)?L+1>=k?F+=V:(j=x[L+M+1],128!=(192&j)?F+=V:($=(31&ee)<<6|63&j,$<128?F+=V:(F+=U($),L++))):224==(240&ee)?L+2>=k?F+=V:(j=x[L+M+1],z=x[L+M+2],32896!=(49344&(j|z<<8))?F+=V:($=(15&ee)<<12|(63&j)<<6|63&z,$<2048||$>=55296&&$<=57343?F+=V:(F+=U($),L+=2))):240==(248&ee)?L+3>=k?F+=V:(j=x[L+M+1],z=x[L+M+2],Q=x[L+M+3],8421504!=(12632256&(j|z<<8|Q<<16))?F+=V:($=(7&ee)<<18|(63&j)<<12|(63&z)<<6|63&Q,$<65536||$>1114111?F+=V:($-=65536,F+=U(55296+($>>10),56320+(1023&$)),L+=3))):F+=V}return F}function BY(L,k){let M=k.length,U=0;for(let L=0;L<M;L++){let x=k.charCodeAt(L);x>=55296&&x<=56319&&L+1<M&&(x=(x<<10)+k.charCodeAt(++L)-56613888),U+=x<128?1:x<2048?2:x<65536?3:4}qY(L,U);let x=xY(L,U),V=L.bytes;for(let L=0;L<M;L++){let U=k.charCodeAt(L);U>=55296&&U<=56319&&L+1<M&&(U=(U<<10)+k.charCodeAt(++L)-56613888),U<128?V[x++]=U:(U<2048?V[x++]=U>>6&31|192:(U<65536?V[x++]=U>>12&15|224:(V[x++]=U>>18&7|240,V[x++]=U>>12&63|128),V[x++]=U>>6&63|128),V[x++]=63&U|128)}}function jY(L,k){let M=xY(L,k.limit),U=L.bytes,x=k.bytes;for(let L=0,V=k.limit;L<V;L++)U[L+M]=x[L]}function GY(L){return L.bytes[VY(L,1)]}function WY(L,k){let M=xY(L,1);L.bytes[M]=k}function HY(L){let k=VY(L,8),M=L.bytes;return LK[0]=M[k++],LK[1]=M[k++],LK[2]=M[k++],LK[3]=M[k++],LK[4]=M[k++],LK[5]=M[k++],LK[6]=M[k++],LK[7]=M[k++],vK[0]}function KY(L,k){let M=xY(L,8),U=L.bytes;vK[0]=k,U[M++]=LK[0],U[M++]=LK[1],U[M++]=LK[2],U[M++]=LK[3],U[M++]=LK[4],U[M++]=LK[5],U[M++]=LK[6],U[M++]=LK[7]}function YY(L){let k,M=0,U=0;do{k=GY(L),M<32&&(U|=(127&k)<<M),M+=7}while(128&k);return U}function qY(L,k){for(k>>>=0;k>=128;)WY(L,127&k|128),k>>>=7;WY(L,k)}function zY(L,k){let M=k.low>>>0,U=(k.low>>>28|k.high<<4)>>>0,x=k.high>>>24,V=0===x?0===U?M<16384?M<128?1:2:M<1<<21?3:4:U<16384?U<128?5:6:U<1<<21?7:8:x<128?9:10,F=xY(L,V),j=L.bytes;switch(V){case 10:j[F+9]=x>>>7&1;case 9:j[F+8]=9!==V?128|x:127&x;case 8:j[F+7]=8!==V?U>>>21|128:U>>>21&127;case 7:j[F+6]=7!==V?U>>>14|128:U>>>14&127;case 6:j[F+5]=6!==V?U>>>7|128:U>>>7&127;case 5:j[F+4]=5!==V?128|U:127&U;case 4:j[F+3]=4!==V?M>>>21|128:M>>>21&127;case 3:j[F+2]=3!==V?M>>>14|128:M>>>14&127;case 2:j[F+1]=2!==V?M>>>7|128:M>>>7&127;case 1:j[F]=1!==V?128|M:127&M}}function JY(L,k){var M=Object.keys(L);if(Object.getOwnPropertySymbols){var U=Object.getOwnPropertySymbols(L);k&&(U=U.filter((function(k){return Object.getOwnPropertyDescriptor(L,k).enumerable}))),M.push.apply(M,U)}return M}const MK=new Map([["moderation",1],["supervise",2]]);function QY(L){return{low:L|=0,high:L>>31,unsigned:L>=0}}class ZY extends My{get connectionState(){return this._connectionState}set connectionState(L){if(this._connectionState===L)return;const k=this._connectionState;this._connectionState=L,this.emit(pO.CONNECTION_STATE_CHANGE,k,L)}get inspectType(){return this._inspectType}set inspectType(L){var k;this._inspectMode=kr(k=L.map((L=>MK.get(L)||0))).call(k,((L,k)=>L+k)),this._inspectType=L}get quality(){return this._quality}set quality(L){this._quality=L>1?1:L<.1?.1:L,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout((()=>{this.quality=this._quality/this.qualityRatio}),6e4))}constructor(L){super(),xg(this,"name","AgoraRTCVideoContentInspect"),xg(this,"_connectionState",uO.CONNECTING),xg(this,"_innerConnectionState",void 0),xg(this,"sequence",0),xg(this,"inspectStartTime",void 0),xg(this,"workerManagerConnection",void 0),xg(this,"workerConnection",void 0),xg(this,"workerMessageLengthLimit",void 0),xg(this,"inspectIntervalMinimum",void 0),xg(this,"qualityRatio",void 0),xg(this,"_connectInfo",void 0),xg(this,"_cancelTokenSource",KC.CancelToken.source()),xg(this,"_retryConfig",void 0),xg(this,"wmSequence",0),xg(this,"inspectInterval",void 0),xg(this,"inspectTimer",null),xg(this,"ossFilePrefix",void 0),xg(this,"extraInfo",void 0),xg(this,"_inspectType",void 0),xg(this,"_inspectMode",void 0),xg(this,"_quality",1),xg(this,"qualityTimer",null),xg(this,"_inspectId",void 0),xg(this,"_needWorkUrlOnly",!1),xg(this,"inspectImage",(()=>{if(this.connectionState!==uO.CONNECTED)throw new Ib(iv.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval((()=>{this.connectionState===uO.CONNECTED?this.requestToInspectImage():Eb.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)}),this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()})),this._inspectId=fA(5,"inspect-"),this.workerMessageLengthLimit=zA("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=zA("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=zA("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=L.interval,this.ossFilePrefix=L.ossFilePrefix,this.extraInfo=L.extraInfo,this.inspectType=L.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new GO("worker-manager-"+this._inspectId,Ov),this.on(pO.STATE_CHANGE,((L,k)=>{this._innerConnectionState=L,Eb.debug("[".concat(this._inspectId,"] Inspect operation :").concat(hO[L]," ").concat(k||""))})),this.handleWorkerManagerEvents(),this.workerConnection=new GO("worker-"+this._inspectId,Ov),this.handleWorkerEvents()}async init(L,k){this.emit(pO.STATE_CHANGE,hO.CONNECT_AP),this._connectInfo=L;const M=this._cancelTokenSource.token;return this._retryConfig=k,new Mp(((U,x)=>{this.on(pO.CONNECTION_STATE_CHANGE,((L,k)=>{k===uO.CONNECTED&&U()})),this.requestAP(L,M,k).then((L=>{this.connectWorkerManager(L)})).catch((L=>{x(L)}))}))}async requestAP(L,k,M){const U=zA("WEBCS_DOMAIN").map((L=>"https://".concat(L,"/api/v1"))),x=await function(L,k,M,U){let{appId:x,areaCode:V,cname:F,sid:j,token:z,uid:Q}=k;gx++;const $="image_moderation_api",ee={service_name:$,json_body:JSON.stringify({appId:x,areaCode:V,cname:F,command:"allocateEdge",requestId:gx,seq:gx,sid:j,token:z,ts:Date.now(),uid:Q+""})};let te,ie,ne=L[0];return PA((async()=>{te=Date.now();const L=await fx(ne,{data:ee,cancelToken:M,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(ie=Date.now()-te,0!==L.code){const k=new Ib(iv.UNEXPECTED_RESPONSE,"image inspect ap error, code"+L.code,{retry:!0,responseTime:ie});throw Eb.error(k.toString()),k}const k=JSON.parse(L.json_body);if(200!==k.code){const L=new Ib(iv.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(k.code,", reason: ").concat(k.reason),{code:k.code,responseTime:ie});throw Eb.error(L.toString()),L}if(!k.servers||!Array.isArray(k.servers)||0===k.servers.length){const L=new Ib(iv.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:k.code,responseTime:ie});throw Eb.error(L.toString()),L}const U=zA("VIDEO_INSPECT_WORKER_MANAGER_HOST"),x=zA("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:k.servers.map((L=>{let{address:k,wss:M}=L;if(k&&M)return"wss://".concat(k.replace(/\./g,"-"),".").concat(U,":").concat(x||M)})).filter((L=>!!L)),workerToken:k.workerToken,vid:k.vid,responseTime:ie}}),((k,M)=>(Ab.apworkerEvent(j,{success:!0,sc:200,serviceName:$,responseDetail:JSON.stringify(k.addressList),firstSuccess:0===M,responseTime:ie,serverIp:L[M%L.length]}),!1)),((k,M)=>(Ab.apworkerEvent(j,{success:!1,sc:k.data&&k.data.code||200,serviceName:$,responseTime:ie,serverIp:L[M%L.length]}),!!(k.code!==iv.OPERATION_ABORTED&&k.code!==iv.UNEXPECTED_RESPONSE||k.data&&k.data.retry)&&(ne=L[(M+1)%L.length],!0))),U)}(U,L,k,M);this.emit(pO.STATE_CHANGE,hO.AP_CONNECTED);const{addressList:V}=x;return this.wmSequence++,V}async connectWorkerManager(L){let k=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._needWorkUrlOnly=k,this.emit(pO.STATE_CHANGE,hO.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(L,1e4)}async connectWorker(L){await this.workerConnection.init([L])}handleWorkerManagerEvents(){this.workerManagerConnection.on(Pw.CONNECTED,(async()=>{this.emit(pO.STATE_CHANGE,hO.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.22.1",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)})),this.workerManagerConnection.on(Pw.CLOSED,(()=>{this._innerConnectionState<hO.GET_WORKER_MANAGER_RESPONSE&&Eb.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))})),this.workerManagerConnection.on(Pw.FAILED,(()=>{this._innerConnectionState<hO.GET_WORKER_MANAGER_RESPONSE&&Eb.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))})),this.workerManagerConnection.on(Pw.RECONNECTING,(()=>{this._innerConnectionState<hO.GET_WORKER_MANAGER_RESPONSE&&Eb.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))})),this.workerManagerConnection.on(Pw.ON_MESSAGE,(async L=>{this.emit(pO.STATE_CHANGE,hO.GET_WORKER_MANAGER_RESPONSE);const k=this.workerManagerConnection.url;this.workerManagerConnection.close();const M=JSON.parse(L.data);if(200!==M.code)throw Eb.error("[".concat(this._inspectId,"] Unexpected code ").concat(M.code," from worker manager")),new Ib(iv.UNEXPECTED_RESPONSE,"response code of worker is unexpected",M);if(!(M.serverResponse&&M.serverResponse.portWss&&k))throw Eb.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(M))),new Ib(iv.UNEXPECTED_RESPONSE,"response content of worker is unexpected",M);{const L=zA("VIDEO_INSPECT_WORKER_PORT")||M.serverResponse.portWss,U=k.replace(/:\d+\/?$/,":".concat(L));this.emit(pO.STATE_CHANGE,hO.CONNECT_WORKER,U),this._needWorkUrlOnly?this.emit(pO.REQUEST_NEW_WORKER_URL,U):await this.connectWorker(U)}})),this.workerManagerConnection.on(Pw.WILL_RECONNECT,((L,k,M)=>{M(L)})),this.workerManagerConnection.on(Pw.REQUEST_NEW_URLS,((L,k)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(L).catch(k)}))}handleWorkerEvents(){this.workerConnection.on(Pw.CONNECTED,(async()=>{this.emit(pO.STATE_CHANGE,hO.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=uO.CONNECTED})),this.workerConnection.on(Pw.ON_MESSAGE,(async L=>{if(L.data instanceof ArrayBuffer){const M=function IY(L){return function(L){let k={};e:for(;!UY(L);){let M=YY(L);switch(M>>>3){case 0:break e;case 1:k.code=YY(L);break;case 2:k.msg=FY(L,YY(L));break;case 3:{let M=AY(L);k.data=vY(L),L.limit=M;break}default:bY(L,7&M)}}return k}({bytes:k=L,offset:0,limit:k.length});var k}(new Uint8Array(L.data));if(zA("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&Eb.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(M)),200===M.code){if(Array.isArray(this.inspectType)&&1===this.inspectType.length&&"supervise"===this.inspectType[0])return void this.emit(pO.INSPECT_RESULT,void 0,void 0);if(M.data&&M.data.scorePorn&&M.data.scoreSexy&&M.data.scoreNeutral){var k;const L={porn:M.data.scorePorn,sexy:M.data.scoreSexy,neutral:M.data.scoreNeutral},U=kr(k=Object.keys(L)).call(k,((k,M)=>L[k]>L[M]?k:M),"porn"),x=Object.keys(L).find((L=>L===U));this.emit(pO.INSPECT_RESULT,x)}else this.emit(pO.INSPECT_RESULT,void 0,new Ib(iv.UNEXPECTED_RESPONSE,M.code+"","There is an unexpected data on message"))}else this.emit(pO.INSPECT_RESULT,void 0,new Ib(iv.UNEXPECTED_RESPONSE,M.code+"",M.msg))}else Eb.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(pO.INSPECT_RESULT,void 0,new Ib(iv.UNEXPECTED_RESPONSE,"invalid worker message type"))})),this.workerConnection.on(Pw.CLOSED,(()=>{this.connectionState=uO.CLOSED})),this.workerConnection.on(Pw.FAILED,(()=>{this.connectionState=uO.CLOSED})),this.workerConnection.on(Pw.RECONNECTING,(()=>{this.connectionState=this.connectionState===uO.CONNECTED?uO.RECONNECTING:uO.CONNECTING})),this.workerConnection.on(Pw.WILL_RECONNECT,((L,k,M)=>{"recover"===L&&M(L),M("tryNext")})),this.workerConnection.on(Pw.REQUEST_NEW_URLS,((L,k)=>{this.workerManagerConnection.close(),this.once(pO.REQUEST_NEW_WORKER_URL,(k=>{L([k])})),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then((L=>{this.connectWorkerManager(L,!0)})).catch((L=>{k(L)}))}))}async requestToInspectImage(){this.sequence++;const L=Zy(this,pO.CLIENT_LOCAL_VIDEO_TRACK),k={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(L){if(!L.isPlaying)return void this.emit(pO.INSPECT_RESULT,void 0,new Ib(iv.INVALID_OPERATION,"Only the track being played can be inspected"));const M=await this.generateRequestData(L,k);this.workerConnection.sendMessage(M,!0,!0)}else this.emit(pO.INSPECT_RESULT,void 0,new Ib(iv.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(L,k){let{appId:M,cname:U,cid:x,vid:V,sid:F,uid:j}=k;const z=Date.now(),Q=await L.getCurrentFrameImage("image/jpeg",this.quality),$=await bk(Q,M,U),ee=this.sequence+"-"+x+"-"+j+"-"+z+"-"+fA(12,""),te={appId:M,cid:x,cname:U,deviceId:"",elapse:QY(Number(z-this.inspectStartTime)),fileSize:$.byteLength,jpgEncryption:2,height:Q.height,width:Q.width,jpg:$,networkType:6,osType:7,requestId:ee,sdkVersion:"4.22.1",sequence:this.sequence,sid:F,timestamp:QY(z),uid:j,vid:V,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};void 0===this.extraInfo&&delete te.callbackData,void 0===this.ossFilePrefix&&delete te.ossFilePrefix;const ie=function CY(L){let k=LY();return function(L,k){let M=L.appId;void 0!==M&&(qY(k,10),BY(k,M));let U=L.cid;void 0!==U&&(qY(k,16),qY(k,U));let x=L.cname;void 0!==x&&(qY(k,26),BY(k,x));let V=L.deviceId;void 0!==V&&(qY(k,34),BY(k,V));let F=L.elapse;void 0!==F&&(qY(k,40),zY(k,F));let j=L.fileSize;void 0!==j&&(qY(k,48),zY(k,DY(j)));let z=L.height;void 0!==z&&(qY(k,56),zY(k,DY(z)));let Q=L.jpg;void 0!==Q&&(qY(k,66),qY(k,Q.length),function(L,k){let M=xY(L,k.length);L.bytes.set(k,M)}(k,Q));let $=L.networkType;void 0!==$&&(qY(k,72),zY(k,DY($)));let ee=L.osType;void 0!==ee&&(qY(k,80),zY(k,DY(ee)));let te=L.requestId;void 0!==te&&(qY(k,90),BY(k,te));let ie=L.sdkVersion;void 0!==ie&&(qY(k,98),BY(k,ie));let ne=L.sequence;void 0!==ne&&(qY(k,104),zY(k,DY(ne)));let re=L.sid;void 0!==re&&(qY(k,114),BY(k,re));let oe=L.timestamp;void 0!==oe&&(qY(k,120),zY(k,oe));let ce=L.uid;void 0!==ce&&(qY(k,128),qY(k,ce));let de=L.vid;void 0!==de&&(qY(k,136),qY(k,de));let le=L.width;void 0!==le&&(qY(k,144),zY(k,DY(le)));let ue=L.service;void 0!==ue&&(qY(k,152),qY(k,ue));let he=L.callbackData;void 0!==he&&(qY(k,162),BY(k,he));let pe=L.jpgEncryption;void 0!==pe&&(qY(k,168),qY(k,pe));let _e=L.requestType;void 0!==_e&&(qY(k,176),qY(k,_e));let Ee=L.scorePorn;void 0!==Ee&&(qY(k,185),KY(k,Ee));let fe=L.scoreSexy;void 0!==fe&&(qY(k,193),KY(k,fe));let me=L.scoreNeutral;void 0!==me&&(qY(k,201),KY(k,me));let ge=L.scene;void 0!==ge&&(qY(k,208),qY(k,ge));let Te=L.ossFilePrefix;void 0!==Te&&(qY(k,218),BY(k,Te));let Se=L.serviceVendor;if(void 0!==Se)for(let L of Se){qY(k,226);let M=LY();yY(L,M),qY(k,M.limit),jY(k,M),kY(M)}}(L,k),function(L){let k=L.bytes,M=L.limit;return k.length===M?k:k.subarray(0,M)}(k)}(te);if(ie.byteLength<this.workerMessageLengthLimit){if(zA("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){const L=function(L){for(var k=1;k<arguments.length;k++){var M=null!=arguments[k]?arguments[k]:{};k%2?JY(Object(M),!0).forEach((function(k){xg(L,k,M[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(M)):JY(Object(M)).forEach((function(k){Object.defineProperty(L,k,Object.getOwnPropertyDescriptor(M,k))}))}return L}({},te);delete L.jpg,Eb.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(L))}return ie}{const k=this.quality*this.qualityRatio;return this.quality=k,await this.generateRequestData(L,{appId:M,cname:U,cid:x,vid:V,sid:F,uid:j})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=KC.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=uO.CLOSED,this.emit(pO.STATE_CHANGE,hO.CLOSED)}}const VK={name:"ContentInspect",create:function(L){let{config:k}=L;return function(L){if(!L)throw new Ib(iv.INVALID_PARAMS,"inspectConfig is necessary.");if(!L.inspectType||!Array.isArray(L.inspectType))throw new Ib(iv.INVALID_PARAMS,"inspectConfig.inspectType is necessary and is an instance of Array.");{const k=[...new Set(L.inspectType)];k.forEach((L=>{var k;if(!Sr(k=["supervise","moderation"]).call(k,L))throw new Ib(iv.INVALID_PARAMS,"".concat(L," is not a valid inspect type."))})),L.inspectType=k}if(L&&L.extraInfo&&L.extraInfo.length>1024)throw new Ib(iv.INVALID_PARAMS,"inspectConfig.extraInfo length cannot exceed 1024 bytes")}(k),new ZY(k)}};qA("PROCESS_ID","process-".concat(fA(8,""),"-").concat(fA(4,""),"-").concat(fA(4,""),"-").concat(fA(4,""),"-").concat(fA(12,""))),function(){let L;try{L=window.localStorage.getItem("websdk_ng_global_parameter")}catch(L){return void Eb.error("Error loading sdk config",L.message)}if(L)try{const k=JSON.parse(window.atob(L)),M=Date.now();Eb.debug("Loading global parameters from cache",k),Object.keys(k).forEach((L=>{if(Object.prototype.hasOwnProperty.call(jv,L)){const{value:U,expires:x}=k[L];if(x&&x<=M)return;eb[L]=U,jv[L]=U}}))}catch(k){Eb.error("Error loading mutableParamsCache: ".concat(L),k.message)}}(),Array.isArray(eb.AREAS)&&eb.AREAS.length>0&&yx(eb.AREAS,!0);const eq=(L,k,M)=>{Eb.debug("setParameter key:".concat(L,", value:").concat(JSON.stringify(k))),qA(L,k,M)};mB(IK,!1),mB(yK,!1),mB(GB,!1),mB(VK,!1),mB(RK,!1);const FK=function(L){const k=new My,M=L,U={getListeners:k.getListeners.bind(k),on:(L,M)=>(function(L,k){L===EO.SECURITY_POLICY_VIOLATION&&DG(k,!0)}(L,M),k.on.bind(k)(L,M)),addListener:k.addListener.bind(k),once:k.once.bind(k),off:k.off.bind(k),removeAllListeners:k.removeAllListeners.bind(k),emit:k.emit.bind(k),safeEmit:k.safeEmit.bind(k)};return OG(OG({},M),U)}({__TRACK_LIST__:rL,VERSION:Mv,BUILD:Bv,ESM_BUNDLER:!1,ESM:!1,UMD:!0,DEV:!1,setParameter:eq,getParameter:zA,getSupportedCodec:async function(){let L={audio:[],video:[]};try{let k=new RTCPeerConnection;const M=await async function(L){let k;return XP().supportUnifiedPlan?(L.addTransceiver("video",{direction:"recvonly"}),L.addTransceiver("audio",{direction:"recvonly"}),k=(await L.createOffer()).sdp):k=(await L.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0})).sdp,k}(k);if(!M)return L;k.close(),k=null,L=function(L){const k={video:[],audio:[]};return L.match(/ VP8/i)&&k.video.push("VP8"),L.match(/ VP9/i)&&k.video.push("VP9"),L.match(/ AV1/i)&&k.video.push("AV1"),L.match(/ H264/i)&&k.video.push("H264"),L.match(/ H265/i)&&k.video.push("H265"),L.match(/ opus/i)&&k.audio.push("OPUS"),L.match(/ PCMU/i)&&k.audio.push("PCMU"),L.match(/ PCMA/i)&&k.audio.push("PCMA"),L.match(/ G722/i)&&k.audio.push("G722"),k}(M)}catch(L){throw new Ib(iv.CREATE_OFFER_FAILED,L.toString&&L.toString()).print()}return L},checkSystemRequirements:function(){const L=Ab.reportApiInvoke(null,{name:dv.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:lv.TRACER});let k=!1;try{const L=window.RTCPeerConnection,M=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,U=window.WebSocket;k=!!(L&&M&&U),k&&hy()&&$v(75)&&(new L).close()}catch(L){return Eb.error("check system requirement failed: ",L),!1}let M=!1;const U=Gv();U.name===JC.CHROME&&Number(U.version)>=58&&("WebKit"!==ZC.engine.name||function(){const L=Gv();if(Yv()){if(L.os===XC.MAC_OS)return!0;if(L.os===XC.IOS){const L=ZC.os.version&&ZC.os.version.split(".");if(L&&14===Number(L[0])&&L[1]&&Number(L[1])>=3)return!0;if(L&&Number(L[0])>14)return!0}}return!1}())&&(M=!0),(U.name===JC.FIREFOX&&Number(U.version)>=56||U.name===JC.OPERA&&Number(U.version)>=45||U.name===JC.SAFARI&&Number(U.version)>=11||"WebKit"===U.name&&(Qv()||dy())&&U.osVersion&&Number(U.osVersion.split(".")[0])>=11||ly()||Gv().name===JC.QQ)&&(M=!0),Eb.debug("checkSystemRequirements, api:",k,"browser",M);const x=k&&M;return L.onSuccess(x),x},getDevices:function(L){return zL.enumerateDevices(!0,!0,L)},getMicrophones:function(L){return zL.getRecordingDevices(L)},getCameras:function(L){return zL.getCamerasDevices(L)},getElectronScreenSources:tk,getPlaybackDevices:function(L){return zL.getSpeakers(L)},createClient:function(){var L;let k=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const M=Ab.reportApiInvoke(null,{name:dv.CREATE_CLIENT,options:[k],tag:lv.TRACER});try{!function(L){Cy(L.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),Cy(L.mode,"config.mode",["rtc","live","p2p"]),void 0!==L.audioCodec&&Cy(L.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),void 0!==L.proxyServer&&yy(L.proxyServer,"config.proxyServer",1,1e4),void 0!==L.turnServer&&Hy(L.turnServer),void 0!==L.httpRetryConfig&&By(L.httpRetryConfig),void 0!==L.websocketRetryConfig&&By(L.websocketRetryConfig)}(k)}catch(L){throw M.onError(L),L}return(iy(16,0,!0)||ny(16,0,!0))&&("vp9"===k.codec&&(k.codec="vp8",Eb.debug("browser not support vp9, force use vp8")),qA("UNSUPPORTED_VIDEO_CODEC",["vp9"])),void 0===k.audioCodec&&(k.audioCodec="opus"),M.onSuccess(),new cG(RG(RG({forceWaitGatewayResponse:!0},k),{},{role:Sr(L=["rtc","p2p"]).call(L,k.mode)?"host":k.role||"audience"}))},createCameraVideoTrack:async function(){let L=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const k=zA("CAMERA_CAPTURE_CONFIG"),M=Ab.reportApiInvoke(null,{tag:lv.TRACER,name:dv.CREATE_CAM_VIDEO_TRACK,options:[BL({},L),k]});k&&(L.encoderConfig=k);const U=vk(L),x=fA(8,"track-cam-");let V=null;Eb.info("start create camera video track with config",JSON.stringify(L),"trackId",x);try{V=(await ok({video:U},x)).getVideoTracks()[0]||null}catch(L){throw M.onError(L),L}if(!V){const L=new nv(iv.UNEXPECTED_ERROR,"can not find track in media stream");return M.onError(L),L.throw(Eb)}L.optimizationMode&&aU(x,V,L,aL(L.encoderConfig));const F=new tU(V,L,U,L.scalabiltyMode?dL(L.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},L.optimizationMode,x);return M.onSuccess(F.getTrackId()),Eb.info("create camera video success, trackId:",x),F},createCustomVideoTrack:function(L){const k=Ab.reportApiInvoke(null,{tag:lv.TRACER,name:dv.CREATE_CUSTOM_VIDEO_TRACK,options:[L]}),M=new eU(L.mediaStreamTrack,{width:L.width,height:L.height,frameRate:L.frameRate,bitrateMax:L.bitrateMax,bitrateMin:L.bitrateMin},L.scalabiltyMode?dL(L.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},L.optimizationMode,fA(8,"track-cus-"),[sL.CUSTOM_TRACK]);return k.onSuccess(M.getTrackId()),Eb.info("create custom video track success with config",L,"trackId",M.getTrackId()),M},createScreenVideoTrack:async function(){let L=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"disable";const M=Ab.reportApiInvoke(null,{tag:lv.TRACER,name:dv.CREATE_SCREEN_VIDEO_TRACK,options:[BL({},L),k]});L.encoderConfig?"string"==typeof L.encoderConfig||L.encoderConfig.width&&L.encoderConfig.height||(L.encoderConfig.width={max:1920},L.encoderConfig.height={max:1080}):L.encoderConfig="1080p_2";const U=function(L){const k={};L.screenSourceType&&(k.mediaSource=L.screenSourceType),L.extensionId&&qv()&&(k.extensionId=L.extensionId);const{displaySurface:M,selfBrowserSurface:U,surfaceSwitching:x,systemAudio:V}=L;(Zv(107)||ey(107)||ry(93))&&(M&&(Cy(M,"displaySurface",["browser","window","monitor"]),k.displaySurface=M),U?(Cy(U,"selfBrowserSurface",["exclude","include"]),k.selfBrowserSurface=U):k.selfBrowserSurface="include",x&&(Cy(x,"surfaceSwitching",["exclude","include"]),k.surfaceSwitching=x)),(Zv(105)||ey(105)||ry(91))&&V&&(Cy(V,"systemAudio",["exclude","include"]),k.systemAudio=V),L.electronScreenSourceId&&(k.sourceId=L.electronScreenSourceId);const F=L.encoderConfig?cL(L.encoderConfig):null;return k.mandatory={chromeMediaSource:"desktop",maxWidth:F?F.width:void 0,maxHeight:F?F.height:void 0},F&&(F.frameRate&&("number"==typeof F.frameRate?(k.mandatory.maxFrameRate=F.frameRate,k.mandatory.minFrameRate=F.frameRate):(k.mandatory.maxFrameRate=F.frameRate.max||F.frameRate.ideal||F.frameRate.exact||void 0,k.mandatory.minFrameRate=F.frameRate.min||F.frameRate.ideal||F.frameRate.exact||void 0),k.frameRate=F.frameRate),F.width&&(k.width=F.width),F.height&&(k.height=F.height)),k}(L),x=fA(8,"track-scr-v-");let V=null,F=null;const j=XP();if(!j.supportShareAudio&&"enable"===k){const L=new nv(iv.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return M.onError(L),L.throw(Eb)}Eb.info("start create screen video track with config",L,"withAudio",k,"trackId",x);try{const L=await ok({screen:U,screenAudio:"auto"===k?j.supportShareAudio:"enable"===k},x);V=L.getVideoTracks()[0]||null,F=L.getAudioTracks()[0]||null}catch(L){throw M.onError(L),L}if(!V){const L=new nv(iv.UNEXPECTED_ERROR,"can not find track in media stream");return M.onError(L),L.throw(Eb)}if(!F&&"enable"===k){V&&V.stop();const L=new nv(iv.SHARE_AUDIO_NOT_ALLOWED);return M.onError(L),L.throw(Eb)}L.optimizationMode||(L.optimizationMode="detail"),L.optimizationMode&&(aU(x,V,L,L.encoderConfig&&cL(L.encoderConfig)||void 0),L.encoderConfig&&"string"!=typeof L.encoderConfig&&(L.encoderConfig.bitrateMin=L.encoderConfig.bitrateMax));const z=new eU(V,L.encoderConfig?cL(L.encoderConfig):{},L.scalabiltyMode?dL(L.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},L.optimizationMode,x,[sL.SCREEN_TRACK]);if(!F)return M.onSuccess(z.getTrackId()),Eb.info("create screen video track success","video:",z.getTrackId()),z;const Q=new uM(F,void 0,fA(8,"track-scr-a-"),!1);return M.onSuccess([z.getTrackId(),Q.getTrackId()]),Eb.info("create screen video track success","video:",z.getTrackId(),"audio:",Q.getTrackId()),[z,Q]},createMicrophoneAndCameraTracks:async function(){let L=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const M=zA("CAMERA_CAPTURE_CONFIG"),U=Ab.reportApiInvoke(null,{tag:lv.TRACER,name:dv.CREATE_MIC_AND_CAM_TRACKS,options:[L,k,M]});M&&(k.encoderConfig=M);const x=vk(k),V=yk(L),F=fA(8,"track-mic-"),j=fA(8,"track-cam-");let z=null,Q=null;Eb.info("start create camera video track(".concat(j,") and microphone audio track(").concat(F,") with config, audio: ").concat(JSON.stringify(L),", video: ").concat(JSON.stringify(k)));try{const L=await ok({audio:V,video:x},"".concat(F,"-").concat(j));z=L.getAudioTracks()[0],Q=L.getVideoTracks()[0]}catch(L){throw U.onError(L),L}if(!z||!Q){const L=new nv(iv.UNEXPECTED_ERROR,"can not find tracks in media stream");return U.onError(L),L.throw(Eb)}k.optimizationMode&&aU(j,Q,k,aL(k.encoderConfig));const $=new hM(z,L,V,F),ee=new tU(Q,k,x,k.scalabiltyMode?dL(k.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},k.optimizationMode,j);return U.onSuccess([$.getTrackId(),ee.getTrackId()]),Eb.info("create camera video track(".concat(j,") and microphone audio track(").concat(F,") success")),[$,ee]},createMicrophoneAudioTrack:async function(){let L=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const k=Ab.reportApiInvoke(null,{tag:lv.TRACER,name:dv.CREATE_MIC_AUDIO_TRACK,options:[L]}),M=yk(L),U=fA(8,"track-mic-");let x=null;Eb.info("start create microphone audio track with config",JSON.stringify(L),"trackId",U);try{x=(await ok({audio:M},U)).getAudioTracks()[0]||null}catch(L){throw k.onError(L),L}if(!x){const L=new nv(iv.UNEXPECTED_ERROR,"can not find track in media stream");return k.onError(L),L.throw(Eb)}const V=new hM(x,L,M,U);return k.onSuccess(V.getTrackId()),Eb.info("create microphone audio track success, trackId:",U),V},createCustomAudioTrack:function(L){const k=Ab.reportApiInvoke(null,{tag:lv.TRACER,name:dv.CREATE_CUSTOM_AUDIO_TRACK,options:[L]}),M=new uM(L.mediaStreamTrack,L.encoderConfig?uL(L.encoderConfig):{},fA(8,"track-cus-"),!1);return Eb.info("create custom audio track success with config",L,"trackId",M.getTrackId()),k.onSuccess(M.getTrackId()),M},createBufferSourceAudioTrack:async function(L){var k;const{cacheOnlineFile:M,encoderConfig:U}=L;let{source:x}=L;const V={source:x instanceof AudioBuffer?"AudioBuffer":x instanceof File?null!==(k=File.name)&&void 0!==k?k:"File":x,cacheOnlineFile:M,encoderConfig:U},F=Ab.reportApiInvoke(null,{tag:lv.TRACER,name:dv.CREATE_BUFFER_AUDIO_TRACK,options:[V]});if(zA("DISABLE_WEBAUDIO"))throw new nv(iv.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");const j=fA(8,"track-buf-");Eb.info("start create buffer source audio track with config",JSON.stringify(V),"trackId",j);const z=x;if(!(x instanceof AudioBuffer))try{x=await async function(L,k){let M=null;if("string"==typeof L){const k=_M.get(L);if(k)return Eb.debug("use cached audio resource: ",L),k;try{M=(await PA((()=>KC.get(L,{responseType:"arraybuffer"})),void 0,void 0,{maxRetryCount:3})).data}catch(L){throw new nv(iv.FETCH_AUDIO_FILE_FAILED,L.toString())}}else{const k=new Mp(((k,M)=>{const U=new FileReader;U.onload=L=>{L.target?k(L.target.result):M(new nv(iv.READ_LOCAL_AUDIO_FILE_ERROR))},U.onerror=()=>{M(new nv(iv.READ_LOCAL_AUDIO_FILE_ERROR))},U.readAsArrayBuffer(L)}));M=await k}const U=await function(L){const k=YL();return new Mp(((M,U)=>{k.decodeAudioData(L,(L=>{M(L)}),(L=>{U(new nv(iv.DECODE_AUDIO_FILE_FAILED,L.toString()))}))}))}(M);return"string"==typeof L&&k&&_M.set(L,U),U}(x,M)}catch(L){return F.onError(L),L.throw(Eb)}const Q=new gM(x),$=new pM(z,Q,U?uL(U):{},j);return Eb.info("create buffer source audio track success, trackId:",j),F.onSuccess($.getTrackId()),$},setAppType:function(L){if(Eb.debug("setAppType: ".concat(L)),!(Number.isInteger(L)&&L>=0))throw Eb.debug("Invalid appType"),new Ib(iv.INVALID_PARAMS,"invalid app type",L);qA("APP_TYPE",Math.floor(L))},setLogLevel:function(L){Eb.setLogLevel(L)},enableLogUpload:function(){zA("USE_NEW_LOG")?qA("UPLOAD_LOG",!0):Eb.enableLogUpload()},disableLogUpload:function(){zA("USE_NEW_LOG")?qA("UPLOAD_LOG",!1):Eb.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new NF},checkAudioTrackIsActive:async function(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const M=Ab.reportApiInvoke(null,{tag:lv.TRACER,name:dv.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[k]});if(!(L instanceof uM||L instanceof fU)){const L=new Ib(iv.INVALID_TRACK,"the parameter is not a audio track");return M.onError(L),L.throw()}k&&k<1e3&&(k=1e3);const U=L instanceof uM?L.getTrackLabel():"remote_track",x=L.getVolumeLevel();let V=x,F=x;const j=Date.now();return new Mp((x=>{const z=setInterval((()=>{const Q=L.getVolumeLevel();V=Q>V?Q:V,F=Q<F?Q:F;const $=V-F>1e-4,ee=Date.now()-j;if($||ee>k){clearInterval(z);const k=$,F={duration:ee,deviceLabel:U,maxVolumeLevel:V,result:k};Eb.info("[track-".concat(L.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(F))),M.onSuccess(F),x(k)}}),200)}))},checkVideoTrackIsActive:async function(L){let k=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const M=Ab.reportApiInvoke(null,{tag:lv.TRACER,name:dv.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[k]});if(!(L instanceof eU||L instanceof EU)){const L=new Ib(iv.INVALID_TRACK,"the parameter is not a video track");return M.onError(L),L.throw()}k&&k<1e3&&(k=1e3);const U=L instanceof eU?L.getTrackLabel():"remote_track",x=L.getMediaStreamTrack(!0),V=document.createElement("video");V.style.width="1px",V.style.height="1px",V.setAttribute("muted",""),V.muted=!0,V.setAttribute("playsinline",""),V.controls=!1,(zv()||Yv())&&(V.style.opacity="0.01",V.style.position="fixed",V.style.left="0",V.style.top="0",document.body.appendChild(V)),V.srcObject=new MediaStream([x]),V.play();const F=document.createElement("canvas");F.width=160,F.height=120;let j=0,z=0;try{const L=Date.now();j=await function(L,k,M,U){let x,V=0,F=null;return new Mp(((U,j)=>{setTimeout((()=>{x&&(x(),U(V))}),k),x=JL((()=>{!function d(){V>4&&x&&(x(),U(V));const k=M.getContext("2d");if(!k){const L=new Ib(iv.UNEXPECTED_ERROR,"can not get canvas 2d context.");return Eb.error(L.toString()),void j(L)}k.drawImage(L,0,0,160,120);const z=k.getImageData(0,0,M.width,M.height),Q=Math.floor(z.data.length/3);if(F){for(let L=0;L<Q;L+=3)if(z.data[L]!==F[L])return V+=1,void(F=z.data);F=z.data}else F=z.data}()}),30)}))}(V,k,F),z=Date.now()-L}catch(L){throw M.onError(L),L}qF===JC.SAFARI&&(V.pause(),V.remove()),V.srcObject=null;const Q=j>4,$={duration:z,changedPicNum:j,deviceLabel:U,result:Q};return Eb.info("[track-".concat(L.getTrackId(),"] check video track active completed. ").concat(JSON.stringify($))),M.onSuccess($),Q},setArea:yx,audioElementPlayCenter:dk,resumeAudioContext:function(){dk.autoResumeAfterInterruption(!0)},processExternalMediaAEC:function(L){hG.processExternalMediaAEC(L)},registerExtensions:function(L){const k=zA("PLUGIN_INFO")||[];L.forEach((L=>{"name"in L&&!Sr(k).call(k,L.name)&&k.push(L.name);const M=L;M.__registered__=!0,M.logger.hookLog=Eb.extLog,M.reporter.hookApiInvoke=Ab.extApiInvoke,M.parameters&&Object.keys(M.parameters).forEach((L=>{M.parameters[L]=zA(L)}))})),eq("PLUGIN_INFO",k)},ChannelMediaRelayError:Yw,ChannelMediaRelayEvent:Hw,ChannelMediaRelayState:zw,RemoteStreamFallbackType:_L,RemoteStreamType:hL,ConnectionDisconnectedReason:hv,AudienceLatencyLevelType:uv,AREAS:Zw,preload:async function(L,k,M,U){return WB(L,k,M,U)}});return Object.defineProperties(FK,{onAudioAutoplayFailed:{get:()=>nk.onAudioAutoplayFailed,set:L=>{nk.onAudioAutoplayFailed=L}},onAutoplayFailed:{get:()=>nk.onAutoplayFailed,set:L=>{nk.onAutoplayFailed=L}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>FK._onSecurityPolicyViolation,set(L){FK._onSecurityPolicyViolation=L,DG(L)}},__CLIENT_LIST__:{get:()=>zA("SHOW_GLOBAL_CLIENT_LIST")?wb:[]}}),zL.on(wL.CAMERA_DEVICE_CHANGED,(L=>{Eb.info("camera device changed",JSON.stringify(L)),FK.onCameraChanged&&FK.onCameraChanged(L),FK.safeEmit(EO.CAMERA_CHANGED,L)})),zL.on(wL.RECORDING_DEVICE_CHANGED,(L=>{Eb.info("microphone device changed",JSON.stringify(L)),FK.onMicrophoneChanged&&FK.onMicrophoneChanged(L),FK.safeEmit(EO.MICROPHONE_CHANGED,L)})),zL.on(wL.PLAYOUT_DEVICE_CHANGED,(L=>{Eb.debug("playout device changed",JSON.stringify(L)),FK.onPlaybackDeviceChanged&&FK.onPlaybackDeviceChanged(L),FK.safeEmit(EO.PLAYBACK_DEVICE_CHANGED,L)})),dk.onAutoplayFailed=()=>{Eb.info("detect audio element autoplay failed"),nk.onAudioAutoplayFailed&&nk.onAudioAutoplayFailed()},ML.on("autoplay-failed",(()=>{Eb.info("detect webaudio autoplay failed"),nk.onAudioAutoplayFailed&&nk.onAudioAutoplayFailed(),FK.safeEmit(EO.AUTOPLAY_FAILED)})),ML.on(zP.STATE_CHANGE,((L,k)=>{Eb.info("audio context state changed: ".concat(k," => ").concat(L)),FK.onAudioContextStateChanged&&FK.onAudioContextStateChanged(L,k),FK.safeEmit(EO.AUDIO_CONTEXT_STATE_CHANGED,L,k)})),Rv.on(Sv.NETWORK_STATE_CHANGE,((L,k)=>{Eb.info("[network-indicator] network state changed, ".concat(k," => ").concat(L))})),window&&(window.__ARTC__=FK),FK}));